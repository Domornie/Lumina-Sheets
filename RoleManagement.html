<!-- RoleManagement.html -->
<?!= include("layout", {
    baseUrl: baseUrl,
    scriptUrl: scriptUrl,
    user: user,
    currentPage: currentPage,
    pageTitle: 'Role Manager',
    pageDescription: 'Define permissions and access across LuminaHQ with precision and control.'
}) ?>

<style>
    :root {
        /* Enhanced color system */
        --primary: #4f46e5;
        --primary-dark: #3730a3;
        --primary-light: #a5b4fc;
        --secondary: #64748b;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #06b6d4;
        
        /* Surface colors */
        --surface: #ffffff;
        --surface-variant: #f8fafc;
        --surface-elevated: #ffffff;
        --background: #f1f5f9;
        
        /* Text colors */
        --on-surface: #0f172a;
        --on-surface-variant: #475569;
        --muted: #64748b;
        
        /* Border and outline */
        --outline: #e2e8f0;
        --outline-variant: #cbd5e1;
        
        /* Shadow system */
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        
        /* Layout */
        --card-radius: 16px;
        --button-radius: 12px;
        --input-radius: 10px;
        
        /* Z-index system */
        --z-dropdown: 1000;
        --z-sticky: 1020;
        --z-fixed: 1030;
        --z-modal-backdrop: 1040;
        --z-modal: 1050;
        --z-popover: 1060;
        --z-tooltip: 1070;
        --z-toast: 9999;
        
        /* Modal z-index overrides */
        --bs-backdrop-zindex: var(--z-modal-backdrop);
        --bs-modal-zindex: var(--z-modal);
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        :root {
            --surface: #1e293b;
            --surface-variant: #334155;
            --surface-elevated: #475569;
            --background: #0f172a;
            --on-surface: #f8fafc;
            --on-surface-variant: #cbd5e1;
            --outline: #475569;
            --outline-variant: #64748b;
        }
    }

    /* Animation system */
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes scaleIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Utility classes */
    .animate-in {
        animation: slideUp 0.6s ease-out;
    }

    .fade-in {
        animation: fadeIn 0.4s ease-out;
    }

    .scale-in {
        animation: scaleIn 0.3s ease-out;
    }

    /* Modal stacking */
    .modal-backdrop {
        z-index: var(--bs-backdrop-zindex) !important;
    }

    .modal {
        z-index: var(--bs-modal-zindex) !important;
    }

    /* Accessibility improvements */
    .btn:focus-visible,
    .form-control:focus-visible,
    .form-select:focus-visible {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
    }

    /* Reduced motion for accessibility */
    @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }

    .norm-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        border-radius: 999px;
        background: var(--surface-variant);
        padding: 0.25rem 0.65rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--on-surface-variant);
    }

    .scope-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        border-radius: 999px;
        padding: 0.3rem 0.7rem;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .scope-badge.border {
        border: 1px solid var(--outline);
    }

    .desc-cell {
        max-width: 320px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--on-surface-variant);
        font-size: 0.85rem;
    }
</style>

<div class="card data-card comfy scale-in" id="rolesCard">
    <!-- Enhanced Toolbar -->
    <div class="table-toolbar">
        <div class="toolbar-left">
            <div class="search-wrap">
                <i class="fas fa-search"></i>
                <input id="searchBox" type="search" class="form-control" placeholder="Search roles and permissions…"/>
            </div>
            <span class="text-muted fw-medium" id="resultCount"></span>
        </div>
        <div class="toolbar-right">
            <div class="btn-group density-toggle" role="group" aria-label="Density">
                <button class="btn btn-outline-secondary active" id="densityComfy" type="button">
                    <i class="fas fa-expand-alt me-1"></i>Comfortable
                </button>
                <button class="btn btn-outline-secondary" id="densityDense" type="button">
                    <i class="fas fa-compress-alt me-1"></i>Compact
                </button>
            </div>

            <!-- Rows/page selector -->
            <div class="d-flex align-items-center gap-2">
                <label for="pageSizeSelect" class="text-muted small d-none d-md-inline fw-medium">Rows</label>
                <select id="pageSizeSelect" class="form-select form-select-sm" style="width:auto">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>

            <button class="btn btn-primary" id="btnNewRole">
                <i class="fas fa-plus-circle me-2"></i> New Role
            </button>
        </div>
    </div>

    <div class="card-body pt-0">
        <div class="table-responsive">
            <table class="table table-modern table-hover align-middle" id="rolesTable">
                <thead>
                <tr>
                    <th class="sortable" data-sort="name">Name <i class="fas fa-sort sort-ind"></i></th>
                    <th class="sortable" data-sort="scope">Scope <i class="fas fa-sort sort-ind"></i></th>
                    <th>Normalized</th>
                    <th>Description</th>
                    <th class="sortable" data-sort="createdAt">Created <i class="fas fa-sort sort-ind"></i></th>
                    <th class="sortable" data-sort="updatedAt">Updated <i class="fas fa-sort sort-ind"></i></th>
                    <th class="text-end">Actions</th>
                </tr>
                </thead>
                <tbody id="rolesTableBody">
                <!-- Enhanced skeleton loader -->
                <tr>
                    <td colspan="7">
                        <div class="row g-3">
                            <div class="col-2">
                                <div class="skeleton" style="height: 20px;"></div>
                            </div>
                            <div class="col-2">
                                <div class="skeleton" style="height: 20px;"></div>
                            </div>
                            <div class="col-2">
                                <div class="skeleton" style="height: 20px;"></div>
                            </div>
                            <div class="col-3">
                                <div class="skeleton" style="height: 20px;"></div>
                            </div>
                            <div class="col-3">
                                <div class="skeleton" style="height: 20px;"></div>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="7">
                        <div class="row g-3">
                            <div class="col-3">
                                <div class="skeleton" style="height: 18px;"></div>
                            </div>
                            <div class="col-2">
                                <div class="skeleton" style="height: 18px;"></div>
                            </div>
                            <div class="col-2">
                                <div class="skeleton" style="height: 18px;"></div>
                            </div>
                            <div class="col-3">
                                <div class="skeleton" style="height: 18px;"></div>
                            </div>
                            <div class="col-2">
                                <div class="skeleton" style="height: 18px;"></div>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Enhanced Pager -->
        <div class="table-pager">
            <small class="text-muted fw-medium" id="pagerInfo">—</small>
            <nav aria-label="Roles pages">
                <ul class="pagination pagination-sm mb-0" id="pager"></ul>
            </nav>
        </div>
    </div>

    <div class="px-3 pb-3 d-flex justify-content-between align-items-center">
        <small class="text-muted fw-medium" id="footerMeta">—</small>
        <div id="notifCount" class="badge">0</div>
    </div>
</div>

<!-- Enhanced Add Role Modal -->
<div class="modal fade" id="addRoleModal" tabindex="-1" aria-labelledby="addRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form id="addRoleForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRoleModalLabel">
                    <i class="fas fa-plus-circle"></i>Create New Role
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newRoleName" class="form-label">Role Name</label>
                    <input type="text" id="newRoleName" class="form-control" placeholder="e.g., Content Manager, System Admin" required>
                    <div class="form-text">Choose a descriptive name. The normalized identifier will be generated automatically.</div>
                </div>
                <div class="mb-3">
                    <label for="newRoleScope" class="form-label">Scope</label>
                    <input type="text" id="newRoleScope" class="form-control" placeholder="e.g., Global, Campaign, Department">
                    <div class="form-text">Use scope to indicate where this role applies. Leave blank for global access.</div>
                </div>
                <div class="mb-3">
                    <label for="newRoleDescription" class="form-label">Description</label>
                    <textarea id="newRoleDescription" class="form-control" rows="3" placeholder="Summarize responsibilities and permissions"></textarea>
                    <div class="form-text">Provide context to help admins understand this role's purpose.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm me-2 d-none" id="addSpin" role="status"
                          aria-hidden="true"></span>
                    <i class="fas fa-check me-1"></i>Create Role
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Enhanced Edit Role Modal -->
<div class="modal fade" id="editRoleModal" tabindex="-1" aria-labelledby="editRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form id="editRoleForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRoleModalLabel">
                    <i class="fas fa-pen-to-square"></i>Edit Role
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editRoleId">
                <div class="mb-3">
                    <label for="editRoleName" class="form-label">Role Name</label>
                    <input type="text" id="editRoleName" class="form-control" placeholder="e.g., Content Manager" required>
                    <div class="form-text">Update the role name. The normalized identifier will be updated automatically.</div>
                </div>
                <div class="mb-3">
                    <label for="editRoleScope" class="form-label">Scope</label>
                    <input type="text" id="editRoleScope" class="form-control" placeholder="e.g., Global, Campaign, Department">
                    <div class="form-text">Refine where this role applies within LuminaHQ.</div>
                </div>
                <div class="mb-3">
                    <label for="editRoleDescription" class="form-label">Description</label>
                    <textarea id="editRoleDescription" class="form-control" rows="3" placeholder="Describe responsibilities and permissions"></textarea>
                    <div class="form-text">Clarify what this role enables so future admins can manage it confidently.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="submit" id="editRoleSaveBtn" class="btn btn-primary">
                    <span class="spinner-border spinner-border-sm me-2 d-none" id="editRoleSpin" role="status"
                          aria-hidden="true"></span>
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // NOTE: Bootstrap 5.3.x is loaded by the header include.

    const JAM_TZ = 'America/Jamaica';

    // ---------------- Notif badge ----------------
    function refreshNotifBadge() {
        if (!(google && google.script && google.script.run)) return;
        google.script.run
            .withSuccessHandler(count => {
                const el = document.getElementById('notifCount');
                if (!el) return;
                el.textContent = count;
                el.style.display = count > 0 ? 'inline-block' : 'none';
            })
            .getTaskNotifications();
    }

    document.addEventListener('DOMContentLoaded', refreshNotifBadge);
    setInterval(refreshNotifBadge, 10 * 60 * 1000);

    // ---------------- Modal stacking: move modals to <body> on show ----------------
    document.addEventListener('DOMContentLoaded', () => {
        ['addRoleModal', 'editRoleModal'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('show.bs.modal', (e) => {
                if (e.target.parentElement !== document.body) {
                    document.body.appendChild(e.target);
                }
            });
        });
    });

    // ---------------- Date/time helpers ----------------
    function toDate(value) {
        if (!value && value !== 0) return null;
        try {
            return (value instanceof Date) ? value : (typeof value === 'number' ? new Date(value) : new Date(value));
        } catch {
            return null;
        }
    }

    function fmtAbsolute(dt) {
        return dt.toLocaleString(undefined, {
            timeZone: JAM_TZ,
            year: 'numeric',
            month: 'short',
            day: '2-digit',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });
    }

    function fmtAbsoluteLong(dt) {
        return dt.toLocaleString(undefined, {
            timeZone: JAM_TZ,
            weekday: 'short',
            year: 'numeric',
            month: 'long',
            day: '2-digit',
            hour: 'numeric',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
    }

    const rtf = new Intl.RelativeTimeFormat(undefined, {numeric: 'auto'});

    function fmtRelative(dt) {
        const nowJam = new Date(new Date().toLocaleString('en-US', {timeZone: JAM_TZ}));
        const ms = dt - nowJam, abs = Math.abs(ms);
        const units = [['year', 31536000000], ['month', 2592000000], ['week', 604800000], ['day', 86400000], ['hour', 3600000], ['minute', 60000], ['second', 1000]];
        for (const [u, size] of units) {
            if (abs >= size || u === 'second') return rtf.format(Math.round(ms / size), u);
        }
    }

    function renderDateCell(value) {
        const d = toDate(value);
        if (!d || isNaN(d.getTime())) return '<span class="text-muted">—</span>';
        const abs = fmtAbsolute(d), tip = fmtAbsoluteLong(d), rel = fmtRelative(d);
        return `<div class="dt-cell" data-bs-toggle="tooltip" title="${escapeHtml(tip)}">
      <span class="dt-main"><i class="fa-regular fa-clock"></i> ${escapeHtml(abs)}</span>
      <span class="dt-sub">${escapeHtml(rel)}</span>
    </div>`;
    }

    // ---------------- State ----------------
    let rolesCache = [];
    let sortState = {key: 'name', dir: 'asc'};

    // Pagination
    let page = 1;
    let pageSize = Number(localStorage.getItem('rolesPageSize') || 10);

    // ---------------- Load + render ----------------
    document.addEventListener('DOMContentLoaded', () => {
        initializeGlobalBanner({
            title: 'Role Manager',
            description: 'Define permissions and access across LuminaHQ with precision and control.',
            actions: [
                {
                    id: 'roleBannerAdd',
                    label: 'New Role',
                    icon: 'fas fa-plus-circle',
                    variant: 'primary'
                }
            ]
        });

        const bannerAddBtn = document.getElementById('roleBannerAdd');
        if (bannerAddBtn) {
            bannerAddBtn.addEventListener('click', () => {
                const trigger = document.getElementById('btnNewRole');
                if (trigger) {
                    trigger.click();
                }
            });
        }

        wireToolbar();
        wireAddModal();
        wireEditModal();
        loadRoles();
    });

    function loadRoles() {
        setFooter('Loading roles…');
        google.script.run
            .withSuccessHandler(roles => {
                rolesCache = Array.isArray(roles) ? roles : [];
                page = 1; // start fresh
                renderTable();
                setFooter(`${rolesCache.length} role${rolesCache.length === 1 ? '' : 's'}`);
            })
            .withFailureHandler(err => {
                rolesCache = [];
                renderTable();
                setFooter('Failed to load roles');
                showToast('Could not load roles.', 'danger');
                console.error(err);
            })
            .getAllRoles();
    }

    function renderTable() {
        const tbody = document.getElementById('rolesTableBody');
        if (!tbody) return;
        tbody.innerHTML = '';

        // 1) Filter
        const q = (document.getElementById('searchBox')?.value || '').trim().toLowerCase();
        let list = rolesCache.slice();
        if (q) {
            list = list.filter(r =>
                (r.name || '').toLowerCase().includes(q) ||
                (r.normalizedName || '').toLowerCase().includes(q) ||
                (r.scope || '').toLowerCase().includes(q) ||
                (r.description || '').toLowerCase().includes(q)
            );
        }

        // 2) Sort
        list.sort((a, b) => {
            const k = sortState.key;
            if (k === 'createdAt' || k === 'updatedAt') {
                const cmp = (new Date(a?.[k] ?? 0) - new Date(b?.[k] ?? 0));
                return sortState.dir === 'asc' ? cmp : -cmp;
            }
            const cmp = String(a?.[k] ?? '').localeCompare(String(b?.[k] ?? ''), undefined, {sensitivity: 'base'});
            return sortState.dir === 'asc' ? cmp : -cmp;
        });

        // 3) Paginate
        const total = list.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (page > totalPages) page = totalPages;
        if (page < 1) page = 1;
        const start = (page - 1) * pageSize;
        const end = Math.min(total, start + pageSize);
        const pageSlice = list.slice(start, end);

        // 4) Render rows
        for (const r of pageSlice) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
        <td class="fw-bold">${escapeHtml(r.name || '')}</td>
        <td>${renderScopeCell(r.scope)}</td>
        <td><span class="norm-chip"><i class="fa-solid fa-code"></i>${escapeHtml((r.normalizedName || '').toUpperCase())}</span></td>
        <td>${renderDescriptionCell(r.description)}</td>
        <td>${renderDateCell(r.createdAt)}</td>
        <td>${renderDateCell(r.updatedAt)}</td>
        <td class="text-end">
          <button class="btn btn-light btn-icon me-2 btn-edit-role"
                  type="button"
                  data-bs-toggle="tooltip" title="Edit role">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-light btn-icon btn-delete-role" type="button"
                  data-bs-toggle="tooltip" title="Delete role">
            <i class="fas fa-trash text-danger"></i>
          </button>
        </td>
      `;
            tbody.appendChild(tr);

            const editBtn = tr.querySelector('.btn-edit-role');
            if (editBtn) {
                editBtn.addEventListener('click', () => openEditRoleModal(r));
            }
            const deleteBtn = tr.querySelector('.btn-delete-role');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => deleteRole(r.id || r.ID));
            }
        }

        // 5) Result counter (range)
        const rc = document.getElementById('resultCount');
        rc.textContent = total
            ? `${start + 1}–${end} of ${total}${q ? ' (filtered)' : ''}`
            : (q ? '0 results' : '');

        // 6) Build pager UI
        buildPager(totalPages);

        // 7) Tooltips + sort headers
        if (window.bootstrap && bootstrap.Tooltip) {
            document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
        }
        refreshSortHeaders();

        // 8) Empty state
        if (!total) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="7" class="empty-state">
        <i class="fas fa-shield-alt"></i>
        <h3>No roles found</h3>
        <p>${q ? 'Try adjusting your search terms' : 'Create your first role to get started'}</p>
      </td>`;
            tbody.appendChild(tr);
        }

        // Pager info
        const pi = document.getElementById('pagerInfo');
        if (pi) pi.textContent = total ? `${start + 1}–${end} of ${total}` : '—';
    }

    // Pager UI
    function buildPager(totalPages) {
        const ul = document.getElementById('pager');
        if (!ul) return;
        ul.innerHTML = '';

        const makeLi = (label, targetPage, disabled = false, active = false, aria = '') => {
            const li = document.createElement('li');
            li.className = `page-item${disabled ? ' disabled' : ''}${active ? ' active' : ''}`;
            li.innerHTML = `<button class="page-link" ${aria ? `aria-label="${aria}"` : ''}>${label}</button>`;
            if (!disabled && !active) {
                li.querySelector('.page-link').addEventListener('click', () => {
                    page = targetPage;
                    renderTable();
                });
            }
            return li;
        };

        // Prev
        ul.appendChild(makeLi('&laquo;', page - 1, page <= 1, false, 'Previous'));

        // numeric range with ellipsis
        for (const token of pageRange(totalPages, page)) {
            if (token === '...') {
                const li = document.createElement('li');
                li.className = 'page-item disabled';
                li.innerHTML = `<span class="page-link">…</span>`;
                ul.appendChild(li);
            } else {
                ul.appendChild(makeLi(String(token), token, false, token === page, `Page ${token}`));
            }
        }

        // Next
        ul.appendChild(makeLi('&raquo;', page + 1, page >= totalPages, false, 'Next'));
    }

    // Returns an array like: [1, '…', 5,6,7, '…', total]
    function pageRange(total, current) {
        const delta = 1; // neighbor pages
        const range = [];
        const left = Math.max(2, current - delta);
        const right = Math.min(total - 1, current + delta);

        range.push(1);
        if (left > 2) range.push('...');
        for (let i = left; i <= right; i++) range.push(i);
        if (right < total - 1) range.push('...');
        if (total > 1) range.push(total);

        const uniq = [];
        for (const v of range) {
            if (uniq[uniq.length - 1] !== v) uniq.push(v);
        }
        return uniq;
    }

    // ---------------- Toolbar wiring ----------------
    function wireToolbar() {
        const card = document.getElementById('rolesCard');

        // Density
        document.getElementById('densityComfy').addEventListener('click', () => {
            card.classList.add('comfy');
            card.classList.remove('dense');
            document.getElementById('densityComfy').classList.add('active');
            document.getElementById('densityDense').classList.remove('active');
        });
        document.getElementById('densityDense').addEventListener('click', () => {
            card.classList.add('dense');
            card.classList.remove('comfy');
            document.getElementById('densityDense').classList.add('active');
            document.getElementById('densityComfy').classList.remove('active');
        });

        // Search (debounced) — reset to page 1 when searching
        const sb = document.getElementById('searchBox');
        let t;
        sb.addEventListener('input', () => {
            clearTimeout(t);
            t = setTimeout(() => {
                page = 1;
                renderTable();
            }, 180);
        });

        // Sortable headers — reset to page 1 on sort change
        document.querySelectorAll('#rolesTable thead th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.getAttribute('data-sort');
                if (sortState.key === key) {
                    sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
                } else {
                    sortState.key = key;
                    sortState.dir = 'asc';
                }
                page = 1;
                renderTable();
            });
        });

        // New role
        document.getElementById('btnNewRole').addEventListener('click', () => {
            document.getElementById('newRoleName').value = '';
            (new bootstrap.Modal('#addRoleModal', {backdrop: 'static'})).show();
        });

        // Page size selector
        const ps = document.getElementById('pageSizeSelect');
        if (ps) {
            ps.value = String(pageSize);
            ps.addEventListener('change', () => {
                pageSize = Number(ps.value) || 10;
                localStorage.setItem('rolesPageSize', String(pageSize));
                page = 1;
                renderTable();
            });
        }
    }

    function refreshSortHeaders() {
        document.querySelectorAll('#rolesTable thead th.sortable').forEach(th => {
            const key = th.getAttribute('data-sort');
            th.classList.toggle('active', key === sortState.key);
            const ind = th.querySelector('.sort-ind');
            if (ind) {
                ind.className = `fas ${key === sortState.key ? (sortState.dir === 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'} sort-ind`;
            }
        });
    }

    // ---------------- Add Role modal ----------------
    function wireAddModal() {
        const form = document.getElementById('addRoleForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const btnSpin = document.getElementById('addSpin');
            btnSpin.classList.remove('d-none');

            const name = document.getElementById('newRoleName').value.trim();
            const scope = document.getElementById('newRoleScope').value.trim();
            const description = document.getElementById('newRoleDescription').value.trim();
            if (!name) {
                btnSpin.classList.add('d-none');
                return;
            }

            google.script.run
                .withSuccessHandler(() => {
                    btnSpin.classList.add('d-none');
                    bootstrap.Modal.getInstance(document.getElementById('addRoleModal'))?.hide();
                    showToast('Role created successfully.', 'success');
                    loadRoles();
                })
                .withFailureHandler(err => {
                    btnSpin.classList.add('d-none');
                    showToast('Failed to create role. ' + (err?.message || ''), 'danger');
                })
                .addRole(name, scope, description);
        });

        document.getElementById('addRoleModal').addEventListener('hidden.bs.modal', () => {
            form.reset();
            document.getElementById('addSpin').classList.add('d-none');
        });
    }

    // ---------------- Edit Role modal ----------------
    let editRoleModal;

    function openEditRoleModal(roleOrId, currentName, currentScope, currentDescription) {
        const modalEl = document.getElementById('editRoleModal');
        if (!editRoleModal) editRoleModal = new bootstrap.Modal(modalEl, {backdrop: 'static'});

        const role = (roleOrId && typeof roleOrId === 'object' && !Array.isArray(roleOrId))
            ? roleOrId
            : {
                id: roleOrId,
                name: currentName,
                scope: currentScope,
                description: currentDescription
            };

        document.getElementById('editRoleId').value = role?.id || role?.ID || '';
        document.getElementById('editRoleName').value = role?.name || role?.Name || '';
        document.getElementById('editRoleScope').value = role?.scope || role?.Scope || '';
        document.getElementById('editRoleDescription').value = role?.description || role?.Description || '';

        setEditSaving(false);
        editRoleModal.show();
        modalEl.addEventListener('shown.bs.modal', () => document.getElementById('editRoleName').focus(), {once: true});
    }

    function wireEditModal() {
        const form = document.getElementById('editRoleForm');
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const id = document.getElementById('editRoleId').value.trim();
            const name = document.getElementById('editRoleName').value.trim();
            const scope = document.getElementById('editRoleScope').value.trim();
            const description = document.getElementById('editRoleDescription').value.trim();
            if (!id || !name) return;

            setEditSaving(true);
            google.script.run
                .withSuccessHandler(() => {
                    setEditSaving(false);
                    editRoleModal?.hide();
                    showToast('Role updated successfully.', 'success');
                    loadRoles();
                })
                .withFailureHandler(err => {
                    setEditSaving(false);
                    showToast('Failed to update role. ' + (err?.message || ''), 'danger');
                })
                .updateRole(id, name, scope, description);
        });

        document.getElementById('editRoleModal').addEventListener('hidden.bs.modal', () => {
            form.reset();
            setEditSaving(false);
        });
    }

    function setEditSaving(isSaving) {
        const btn = document.getElementById('editRoleSaveBtn');
        const spin = document.getElementById('editRoleSpin');
        if (btn) btn.disabled = !!isSaving;
        if (spin) spin.classList.toggle('d-none', !isSaving);
    }

    // ---------------- Delete ----------------
    function deleteRole(id) {
        if (!confirm('Are you sure you want to delete this role? This action cannot be undone.')) return;
        google.script.run
            .withSuccessHandler(() => {
                showToast('Role deleted successfully.', 'warning');
                loadRoles();
            })
            .withFailureHandler(err => {
                showToast('Failed to delete role. ' + (err?.message || ''), 'danger');
            })
            .deleteRole(id);
    }

    window.deleteRole = deleteRole;
    window.openEditRoleModal = openEditRoleModal;

    // ---------------- Helpers ----------------
    function setFooter(text) {
        const el = document.getElementById('footerMeta');
        if (el) el.textContent = text;
    }

    function showToast(msg, type) {
        if (window.showLuminaToast) {
            window.showLuminaToast(msg, type);
            return;
        }

        const tone = String(type || 'info').toUpperCase();
        window.alert(`[${tone}] ${msg}`);
    }

    function renderScopeCell(scope) {
        const value = (scope || '').trim();
        const label = value || 'Global';
        const tone = value ? 'bg-info text-white' : 'bg-light text-muted border';
        const icon = value ? 'fa-diagram-project' : 'fa-globe-americas';
        return `<span class="badge scope-badge ${tone}"><i class="fas ${icon} me-1"></i>${escapeHtml(label)}</span>`;
    }

    function renderDescriptionCell(desc) {
        const value = (desc || '').trim();
        if (!value) return '<span class="text-muted">—</span>';
        const short = value.length > 140 ? value.slice(0, 137) + '…' : value;
        return `<div class="desc-cell" title="${escapeHtml(value)}">${escapeHtml(short)}</div>`;
    }

    function escapeHtml(s = '') {
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }
</script>
</body>
</html>