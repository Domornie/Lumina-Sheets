<?!= includeOnce('ResponsiveStyles') ?>
<section class="container py-5" id="luminaAdminMessages">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1"><i class="fas fa-bell me-2 text-warning"></i>Lumina Admin Messages Center</h1>
      <p class="text-muted mb-0">Review, acknowledge, and resolve autonomous alerts issued by the Lumina Admin system owner.</p>
    </div>
    <div>
      <button class="btn btn-outline-primary" id="refreshMessagesBtn"><i class="fas fa-rotate me-2"></i>Refresh</button>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="messagesTable">
          <thead class="table-light">
            <tr>
              <th scope="col">Severity</th>
              <th scope="col">Title</th>
              <th scope="col">Status</th>
              <th scope="col">Created</th>
              <th scope="col" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody id="messagesTableBody">
            <tr>
              <td colspan="5" class="text-center py-4 text-muted"><i class="fas fa-circle-notch fa-spin me-2"></i>Loading messagesâ€¦</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<script>
  (function() {
    const tableBody = document.getElementById('messagesTableBody');
    const refreshBtn = document.getElementById('refreshMessagesBtn');

    function renderRows(messages) {
      if (!messages || !messages.length) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No messages found.</td></tr>';
        return;
      }
      tableBody.innerHTML = messages.map(renderRow).join('');
    }

    function renderRow(message) {
      const severityBadge = buildSeverityBadge(message.Severity);
      const created = new Date(message.CreatedAt || Date.now());
      const actions = buildActions(message);
      return `
        <tr data-message-id="${message.MessageId}">
          <td>${severityBadge}</td>
          <td>
            <div class="fw-semibold">${escapeHtml(message.Title)}</div>
            <div class="small text-muted">${escapeHtml(message.Body)}</div>
          </td>
          <td><span class="badge rounded-pill bg-secondary-subtle text-secondary">${escapeHtml(message.Status)}</span></td>
          <td>${created.toLocaleString()}</td>
          <td class="text-end">${actions}</td>
        </tr>`;
    }

    function buildSeverityBadge(severity) {
      const normalized = String(severity || 'INFO').toUpperCase();
      const classes = {
        CRITICAL: 'bg-danger',
        WARNING: 'bg-warning text-dark',
        NOTICE: 'bg-info text-dark',
        INFO: 'bg-primary'
      };
      const badgeClass = classes[normalized] || 'bg-secondary';
      return `<span class="badge ${badgeClass}"><i class="fas fa-exclamation-triangle me-1"></i>${normalized}</span>`;
    }

    function buildActions(message) {
      const actions = [];
      if (message.Status !== 'Resolved') {
        actions.push(`<button class="btn btn-sm btn-outline-success" data-action="resolve">Resolve</button>`);
      }
      if (message.Status === 'Open') {
        actions.push(`<button class="btn btn-sm btn-outline-secondary ms-2" data-action="ack">Acknowledge</button>`);
      }
      return actions.join('');
    }

    function escapeHtml(text) {
      return String(text || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function fetchMessages() {
      refreshBtn.disabled = true;
      google.script.run.withSuccessHandler(function(result) {
        refreshBtn.disabled = false;
        renderRows(result || []);
      }).withFailureHandler(function(error) {
        refreshBtn.disabled = false;
        tableBody.innerHTML = `<tr><td colspan="5" class="text-danger text-center py-4">${escapeHtml(error.message || error)}</td></tr>`;
      }).LuminaAdminClient_getMessages();
    }

    function updateMessageStatus(messageId, status) {
      google.script.run.withSuccessHandler(function() {
        fetchMessages();
      }).withFailureHandler(function(error) {
        alert('Failed to update message: ' + (error.message || error));
      }).LuminaAdminClient_updateMessageStatus(messageId, status);
    }

    tableBody.addEventListener('click', function(event) {
      const button = event.target.closest('button[data-action]');
      if (!button) return;
      const row = button.closest('tr[data-message-id]');
      if (!row) return;
      const messageId = row.getAttribute('data-message-id');
      const action = button.getAttribute('data-action');
      if (action === 'ack') {
        updateMessageStatus(messageId, 'Acknowledged');
      } else if (action === 'resolve') {
        updateMessageStatus(messageId, 'Resolved');
      }
    });

    refreshBtn.addEventListener('click', fetchMessages);
    fetchMessages();
  })();
</script>
