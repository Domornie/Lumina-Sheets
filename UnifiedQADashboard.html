    <?!= includeOnce('ResponsiveStyles') ?>
<!-- UnifiedQADashboard.html - Updated for Independence QA with Campaign Filtering -->
<?!= include("layout", {
  rawToken: rawToken,
  baseUrl: baseUrl,
  scriptUrl: scriptUrl,
  user: user,
  currentPage: currentPage || 'unifiedqadashboard'
}) ?>

<style>
    :root {
        /* Brand Color Palette */
        --navy-primary: #003177;
        --cyan-accent: #00BFFF;
        --gold-highlight: #FFB800;
        --fire-red: #FF4000;
        
        /* Modern UI Colors */
        --primary-gradient: linear-gradient(135deg, var(--navy-primary) 0%, #004ba0 100%);
        --info-gradient: linear-gradient(135deg, var(--cyan-accent) 0%, #0099cc 100%);
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --warning-gradient: linear-gradient(135deg, var(--gold-highlight) 0%, #d97706 100%);
        --danger-gradient: linear-gradient(135deg, var(--fire-red) 0%, #dc2626 100%);
        --surface-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        
        --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
        --card-shadow-hover: 0 20px 60px rgba(0,0,0,0.15);
        --glass-bg: rgba(255,255,255,0.25);
        --glass-border: rgba(255,255,255,0.18);
        --backdrop-blur: blur(10px);
        --border-radius-lg: 16px;
        --border-radius-xl: 24px;
        --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background: var(--surface-gradient);
        font-family: "Google Sans", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
        color: var(--navy-primary);
        line-height: 1.6;
    }

    /* Modern Page Header */
    .modern-page-header {
        background: var(--primary-gradient);
        border-radius: var(--border-radius-xl);
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .modern-page-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        transform: translate(50%, -50%);
    }

    .modern-page-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        position: relative;
        z-index: 2;
    }

    .modern-page-header p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0.5rem 0 0 0;
        position: relative;
        z-index: 2;
    }

    .modern-page-header .header-grid {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 2rem;
        flex-wrap: wrap;
    }

    .header-title p {
        max-width: 520px;
    }

    .headline-metric {
        background: rgba(255, 255, 255, 0.15);
        padding: 1.25rem 1.5rem;
        border-radius: 16px;
        text-align: right;
        min-width: 200px;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
    }

    .headline-metric span {
        display: block;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        opacity: 0.8;
    }

    .headline-metric strong {
        font-size: 2.5rem;
        display: block;
        margin-top: 0.35rem;
    }

    .headline-change {
        font-size: 0.85rem;
        margin-top: 0.75rem;
        font-weight: 600;
    }

    .headline-change.positive {
        color: #10b981;
    }

    .headline-change.negative {
        color: var(--fire-red);
    }

    .header-subgrid {
        margin-top: 2rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
    }

    .headline-stat {
        background: rgba(255, 255, 255, 0.12);
        padding: 1rem 1.25rem;
        border-radius: 14px;
        backdrop-filter: blur(6px);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.15);
    }

    .headline-stat span {
        display: block;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        opacity: 0.75;
    }

    .headline-stat strong {
        font-size: 1.4rem;
        margin-top: 0.35rem;
        display: block;
    }

    .top-agent-banner {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: white;
        border-radius: var(--border-radius-lg);
        padding: 1.25rem 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(0,0,0,0.04);
    }

    .banner-icon {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.4rem;
    }

    .banner-title {
        font-size: 0.95rem;
        font-weight: 700;
        margin: 0;
        color: var(--navy-primary);
    }

    .banner-body {
        font-size: 0.85rem;
        color: #334155;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.35rem;
    }

    .banner-body .agent-pill {
        background: rgba(0,49,119,0.08);
        color: var(--navy-primary);
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }

    /* Campaign Switcher */
    .campaign-switcher {
        background: white;
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }

    .switcher-container {
        display: flex;
        background: #f8fafc;
        border-radius: 12px;
        padding: 0.5rem;
        position: relative;
    }

    .switcher-option {
        padding: 1rem 2rem;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition-smooth);
        font-weight: 600;
        position: relative;
        z-index: 2;
        color: var(--navy-primary);
    }

    .switcher-option.active {
        background: var(--primary-gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .switcher-option:not(.active):hover {
        background: rgba(0, 49, 119, 0.1);
    }

    /* Modern Controls */
    .modern-controls {
        background: white;
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255,255,255,0.2);
    }

    /* Make native inputs match your selects */
    input.form-select {
      border: 2px solid var(--navy-primary);
      border-radius: 12px;
      padding: 0.6rem 0.9rem;
      font-size: 0.9rem;
      color: var(--navy-primary);
    }
    input.form-select:focus {
      border-color: var(--cyan-accent);
      box-shadow: 0 0 0 3px rgba(0,191,255,.1);
      outline: none;
    }

    .control-section {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .control-group label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--navy-primary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .control-group select {
        border: 2px solid var(--navy-primary);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
        transition: var(--transition-smooth);
        background: white;
        min-width: 140px;
        color: var(--navy-primary);
    }

    .control-group select:focus {
        border-color: var(--cyan-accent);
        box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.1);
        outline: none;
    }

    /* Action Buttons */
    .modern-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 2rem;
    }

    .modern-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.875rem 1.5rem;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .modern-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .modern-btn:hover::before {
        left: 100%;
    }

    .modern-btn-primary {
        background: var(--primary-gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(0, 49, 119, 0.3);
    }

    .modern-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 49, 119, 0.4);
        color: white;
    }

    .modern-btn-info {
        background: var(--info-gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3);
    }

    .modern-btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 191, 255, 0.4);
        color: white;
    }

    .modern-btn-warning {
        background: var(--warning-gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(255, 184, 0, 0.3);
    }

    .modern-btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(255, 184, 0, 0.4);
        color: white;
    }

    /* KPI Cards */
    .modern-kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .modern-kpi-card {
        background: white;
        border-radius: var(--border-radius-lg);
        padding: 2rem;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255,255,255,0.2);
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
    }

    .modern-kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .modern-kpi-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--card-shadow-hover);
    }

    .modern-kpi-card:hover::before {
        transform: scaleX(1);
    }

    .kpi-icon {
        width: 60px;
        height: 60px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1.5rem;
        color: white;
        font-size: 1.5rem;
    }

    .kpi-icon.independence {
        background: var(--info-gradient);
    }

    .kpi-icon.credit-suite {
        background: var(--warning-gradient);
    }

    .kpi-icon.unified {
        background: var(--primary-gradient);
    }

    .kpi-value {
        font-size: 2.5rem;
        font-weight: 800;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0;
        line-height: 1;
    }

    .kpi-label {
        font-size: 0.9rem;
        color: var(--navy-primary);
        font-weight: 600;
        margin-top: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .kpi-trend {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .kpi-trend.positive {
        color: #10b981;
    }

    .kpi-trend.negative {
        color: var(--fire-red);
    }

    /* Chart Cards */
    .modern-chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .modern-chart-card {
        background: white;
        border-radius: var(--border-radius-lg);
        padding: 2rem;
        box-shadow: var(--card-shadow);
        border: 1px solid rgba(255,255,255,0.2);
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
    }

    .modern-chart-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--card-shadow-hover);
    }

    .modern-chart-card h6 {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--navy-primary);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modern-chart-card h6::before {
        content: '';
        width: 4px;
        height: 20px;
        background: var(--primary-gradient);
        border-radius: 2px;
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-bottom: 1rem;
    }

    .chart-container.tall {
        height: 420px;
    }

    .chart-container.gauge {
        height: 260px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .gauge-wrapper {
        position: relative;
        width: 220px;
        height: 220px;
    }

    .gauge-wrapper canvas {
        width: 100% !important;
        height: 100% !important;
    }

    .gauge-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        font-weight: 700;
        color: var(--navy-primary);
    }

    .gauge-meta {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        margin-top: 1.5rem;
        font-size: 0.85rem;
        font-weight: 600;
        color: #475569;
    }

    .gauge-meta span {
        display: block;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.75rem;
        color: #94a3b8;
    }

    .quality-intelligence-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .quality-column {
        display: grid;
        gap: 2rem;
        align-content: start;
    }

    .top-agents-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .top-agent-item {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 1rem;
        align-items: center;
        padding: 0.85rem 1rem;
        border-radius: 12px;
        background: rgba(0, 49, 119, 0.05);
    }

    .rank-badge {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.95rem;
    }

    .top-agent-meta {
        display: grid;
        grid-template-columns: repeat(4, auto);
        gap: 1rem;
        align-items: center;
        font-size: 0.85rem;
    }

    .top-agent-meta .name {
        font-weight: 700;
        color: var(--navy-primary);
    }

    .top-agent-meta .score {
        font-weight: 700;
        color: #0f172a;
    }

    .top-agent-meta .change {
        font-weight: 600;
    }

    .top-agent-meta .change.positive {
        color: #10b981;
    }

    .top-agent-meta .change.negative {
        color: var(--fire-red);
    }

    .top-agent-meta .count {
        color: #64748b;
    }

    .ai-insights-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
    }

    .ai-insights-list li {
        display: flex;
        gap: 0.75rem;
        font-size: 0.9rem;
        color: #1e293b;
        align-items: flex-start;
        line-height: 1.4;
    }

    .ai-insights-list li i {
        color: var(--cyan-accent);
        margin-top: 0.15rem;
    }

    .category-row {
        margin-bottom: 1rem;
    }

    .category-row:last-child {
        margin-bottom: 0;
    }

    .category-row-header {
        display: flex;
        justify-content: space-between;
        font-weight: 600;
        color: #0f172a;
        font-size: 0.85rem;
        margin-bottom: 0.35rem;
    }

    .category-progress {
        width: 100%;
        height: 8px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.25);
        overflow: hidden;
    }

    .category-progress-bar {
        height: 100%;
        background: var(--primary-gradient);
        border-radius: 999px;
    }

    .quality-secondary-grid,
    .quality-agent-grid {
        margin-top: 2rem;
    }

    .empty-state {
        color: #94a3b8;
        font-size: 0.85rem;
        margin: 0;
    }

    .chart-container canvas {
        max-height: 100% !important;
        max-width: 100% !important;
    }

    /* Campaign Indicator */
    .campaign-indicator {
        position: absolute;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .campaign-indicator.independence {
        background: rgba(0, 191, 255, 0.1);
        color: var(--cyan-accent);
        border: 1px solid rgba(0, 191, 255, 0.2);
    }

    .campaign-indicator.credit-suite {
        background: rgba(255, 184, 0, 0.1);
        color: var(--gold-highlight);
        border: 1px solid rgba(255, 184, 0, 0.2);
    }

    /* Loading States */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .modern-page-header {
            padding: 1.5rem;
            text-align: center;
        }

        .modern-page-header h1 {
            font-size: 2rem;
        }

        .modern-page-header .header-grid {
            justify-content: center;
        }

        .headline-metric {
            text-align: center;
        }

        .campaign-switcher {
            flex-direction: column;
        }

        .control-section {
            flex-direction: column;
            align-items: stretch;
        }

        .top-agent-banner {
            flex-direction: column;
            align-items: flex-start;
        }

        .modern-chart-grid {
            grid-template-columns: 1fr;
        }

        .modern-kpi-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .quality-intelligence-grid {
            grid-template-columns: 1fr;
        }

        .top-agent-meta {
            grid-template-columns: repeat(2, auto);
            row-gap: 0.4rem;
        }

        .gauge-wrapper {
            width: 180px;
            height: 180px;
        }
    }

    /* Animation Enhancements */
    .fade-in {
        animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .stagger-animation > * {
        opacity: 0;
        animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .stagger-animation > *:nth-child(1) { animation-delay: 0.1s; }
    .stagger-animation > *:nth-child(2) { animation-delay: 0.2s; }
    .stagger-animation > *:nth-child(3) { animation-delay: 0.3s; }
    .stagger-animation > *:nth-child(4) { animation-delay: 0.4s; }
    .stagger-animation > *:nth-child(5) { animation-delay: 0.5s; }
    .stagger-animation > *:nth-child(6) { animation-delay: 0.6s; }
    </style>

<div class="modern-page-header fade-in">
    <div class="header-grid">
        <div class="header-title">
            <h1>Quality Intelligence Dashboard</h1>
            <p>Visualize agent performance, quality trends, and opportunities for targeted coaching.</p>
        </div>
        <div class="headline-metric">
            <span>Current Average</span>
            <strong id="headlineAvgScore">0%</strong>
            <div class="headline-change" id="headlineAvgChange">0% vs last period</div>
        </div>
    </div>
    <div class="header-subgrid">
        <div class="headline-stat">
            <span>Pass Rate</span>
            <strong id="headlinePassRate">0%</strong>
        </div>
        <div class="headline-stat">
            <span>Evaluations</span>
            <strong id="headlineEvaluations">0</strong>
        </div>
        <div class="headline-stat">
            <span>Agents Covered</span>
            <strong id="headlineAgents">0</strong>
        </div>
    </div>
</div>

<div class="top-agent-banner fade-in" id="topAgentsBanner">
    <div class="banner-icon">
        <i class="fas fa-trophy"></i>
    </div>
    <div>
        <p class="banner-title">Top Performing Agents</p>
        <div class="banner-body" id="topAgentsBannerList">Insights will appear once data is loaded.</div>
    </div>
</div>

<!-- Campaign Switcher -->
<div class="campaign-switcher fade-in">
    <div class="switcher-container">
        <div class="switcher-option active" data-campaign="independence">
            <i class="fas fa-phone-alt me-2"></i>Independence Insurance
        </div>
        <div class="switcher-option" data-campaign="credit-suite">
            <i class="fas fa-credit-card me-2"></i>Credit Suite
        </div>
    </div>
</div>

<!-- Modern Control Panel (REPLACED) -->
<div class="modern-controls fade-in" id="controls">
  <div class="row">
    <div class="col-md-12">
      <div class="control-section">
        <!-- Granularity -->
        <div class="control-group">
          <label>Time Period</label>
          <select class="form-select" id="granularitySelect">
            <option value="Week" selected>Week</option>
            <option value="Month">Month</option>
            <option value="Quarter">Quarter</option>
            <option value="Year">Year</option>
          </select>
        </div>

        <!-- Agent -->
        <div class="control-group">
          <label>Agent Filter</label>
          <select class="form-select" id="agentSelect">
            <option value="">All Agents</option>
          </select>
        </div>

        <!-- Call Type -->
        <div class="control-group">
          <label>Call Type</label>
          <select class="form-select" id="callTypeSelect">
            <option value="">All Call Types</option>
          </select>
        </div>

        <!-- NEW: Period pickers (shown/hidden by granularity) -->
        <div class="control-group" id="weekPickerGroup">
          <label>Week</label>
          <input class="form-select" type="week" id="weekInput">
        </div>

        <div class="control-group" id="monthPickerGroup" style="display:none">
          <label>Month</label>
          <input class="form-select" type="month" id="monthInput">
        </div>

        <div class="control-group" id="quarterPickerGroup" style="display:none">
          <label>Quarter</label>
          <div style="display:flex;gap:.5rem;align-items:center">
            <select class="form-select" id="quarterInput">
              <option value="1">Q1</option>
              <option value="2">Q2</option>
              <option value="3">Q3</option>
              <option value="4">Q4</option>
            </select>
            <input class="form-select" type="number" id="quarterYearInput" min="2000" max="2100" step="1" placeholder="Year">
          </div>
        </div>

        <div class="control-group" id="yearPickerGroup" style="display:none">
          <label>Year</label>
          <input class="form-select" type="number" id="yearInput" min="2000" max="2100" step="1">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modern Action Buttons -->
<div class="modern-actions fade-in">
    <a href="#" class="modern-btn modern-btn-primary" id="newQABtn">
        <i class="fas fa-clipboard-check"></i> New Quality Assessment
    </a>
    <a href="#" class="modern-btn modern-btn-info" id="qaListBtn">
        <i class="fas fa-list"></i> View All Assessments
    </a>
    <button id="exportBtn" class="modern-btn modern-btn-warning">
        <i class="fas fa-file-csv"></i> Export Data
    </button>
    <button id="refreshBtn" class="modern-btn modern-btn-info">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
</div>

<!-- Modern KPI Cards -->
<div class="modern-kpi-grid stagger-animation">
    <div class="modern-kpi-card">
        <div class="campaign-indicator" id="avgScoreIndicator">Independence</div>
        <div class="kpi-icon unified">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="kpi-value" id="kpiAvgScore">0%</div>
        <div class="kpi-label">Average Score</div>
        <div class="kpi-trend positive" id="kpiAvgScoreTrend">
            <i class="fas fa-arrow-up"></i>
            <span>0% vs last period</span>
        </div>
    </div>

    <div class="modern-kpi-card">
        <div class="campaign-indicator" id="passRateIndicator">Independence</div>
        <div class="kpi-icon unified">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="kpi-value" id="kpiPassRate">0%</div>
        <div class="kpi-label">Pass Rate</div>
        <div class="kpi-trend positive" id="kpiPassRateTrend">
            <i class="fas fa-arrow-up"></i>
            <span>0% vs last period</span>
        </div>
    </div>

    <div class="modern-kpi-card">
        <div class="campaign-indicator" id="evaluationsIndicator">Independence</div>
        <div class="kpi-icon unified">
            <i class="fas fa-clipboard-list"></i>
        </div>
        <div class="kpi-value" id="kpiEvaluations">0</div>
        <div class="kpi-label">Total Evaluations</div>
        <div class="kpi-trend positive" id="kpiEvaluationsTrend">
            <i class="fas fa-arrow-up"></i>
            <span>+0 this period</span>
        </div>
    </div>

    <div class="modern-kpi-card">
        <div class="campaign-indicator" id="agentsIndicator">Independence</div>
        <div class="kpi-icon unified">
            <i class="fas fa-users"></i>
        </div>
        <div class="kpi-value" id="kpiAgents">0</div>
        <div class="kpi-label">Agents Evaluated</div>
        <div class="kpi-trend positive" id="kpiAgentsTrend">
            <i class="fas fa-arrow-up"></i>
            <span>0% coverage</span>
        </div>
    </div>
</div>

<!-- Modern Charts -->
<div class="quality-intelligence-grid">
    <div class="quality-column">
        <div class="modern-chart-card fade-in">
            <div class="campaign-indicator" id="gaugeIndicator">Independence</div>
            <h6><i class="fas fa-tachometer-alt me-2"></i>Quality Score Gauge</h6>
            <div class="chart-container gauge">
                <div class="gauge-wrapper">
                    <canvas id="scoreGaugeChart"></canvas>
                    <div class="gauge-value" id="scoreGaugeValue">0%</div>
                </div>
            </div>
            <div class="gauge-meta">
                <div>
                    <span>Pass Rate</span>
                    <strong id="gaugePassRate">0%</strong>
                </div>
                <div>
                    <span>Target</span>
                    <strong>85%</strong>
                </div>
            </div>
        </div>

        <div class="modern-chart-card fade-in">
            <div class="campaign-indicator" id="topAgentsIndicator">Independence</div>
            <h6><i class="fas fa-star me-2"></i>Top Agents Spotlight</h6>
            <div class="top-agents-list" id="topAgentsList">
                <p class="empty-state">Top agents will appear once data is loaded.</p>
            </div>
        </div>

        <div class="modern-chart-card fade-in ai-card">
            <h6><i class="fas fa-robot me-2"></i>AI Recommendations &amp; Insights</h6>
            <ul class="ai-insights-list" id="aiInsightsList">
                <li><i class="fas fa-lightbulb"></i><span>Load data to unlock contextual recommendations for your team.</span></li>
            </ul>
        </div>

        <div class="modern-chart-card fade-in category-summary-card">
            <h6><i class="fas fa-layer-group me-2"></i>Category Breakdown</h6>
            <div id="categoryBreakdown">
                <p class="empty-state">Category performance details will populate here.</p>
            </div>
        </div>
    </div>

    <div class="quality-column">
        <div class="modern-chart-card fade-in">
            <div class="campaign-indicator" id="trendsIndicator">Independence</div>
            <h6><i class="fas fa-calendar-day me-2"></i>Score Trends</h6>
            <div class="chart-container">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>

        <div class="modern-chart-card fade-in">
            <div class="campaign-indicator" id="passTrendIndicator">Independence</div>
            <h6><i class="fas fa-wave-square me-2"></i>Pass Rate Trend</h6>
            <div class="chart-container">
                <canvas id="passTrendChart"></canvas>
            </div>
        </div>

        <div class="modern-chart-card fade-in">
            <div class="campaign-indicator" id="volumeIndicator">Independence</div>
            <h6><i class="fas fa-chart-bar me-2"></i>Evaluation Volume</h6>
            <div class="chart-container">
                <canvas id="volumeChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="modern-chart-grid quality-secondary-grid">
    <div class="modern-chart-card fade-in">
        <div class="campaign-indicator" id="categoryIndicator">Independence</div>
        <h6><i class="fas fa-bullseye me-2"></i>Category Performance</h6>
        <div class="chart-container">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>
    <div class="modern-chart-card fade-in">
        <div class="campaign-indicator" id="distributionIndicator">Independence</div>
        <h6><i class="fas fa-chart-area me-2"></i>Score Distribution</h6>
        <div class="chart-container">
            <canvas id="distributionChart"></canvas>
        </div>
    </div>
    <div class="modern-chart-card fade-in">
        <div class="campaign-indicator" id="callTypeIndicator">Independence</div>
        <h6><i class="fas fa-headset me-2"></i>Call Type Quality</h6>
        <div class="chart-container">
            <canvas id="callTypeChart"></canvas>
        </div>
    </div>
</div>

<div class="modern-chart-card fade-in">
    <div class="campaign-indicator" id="comparisonIndicator">Independence</div>
    <h6><i class="fas fa-balance-scale me-2"></i>Agent Performance Comparison</h6>
    <div class="chart-container tall">
        <canvas id="comparisonChart"></canvas>
    </div>
</div>

<div class="modern-chart-grid quality-agent-grid">
    <div class="modern-chart-card fade-in">
        <div class="campaign-indicator" id="momentumIndicator">Independence</div>
        <h6><i class="fas fa-bolt me-2"></i>Agent Momentum</h6>
        <div class="chart-container">
            <canvas id="momentumChart"></canvas>
        </div>
    </div>
    <div class="modern-chart-card fade-in">
        <div class="campaign-indicator" id="impactIndicator">Independence</div>
        <h6><i class="fas fa-bullseye me-2"></i>Agent Impact Bubble</h6>
        <div class="chart-container">
            <canvas id="impactChart"></canvas>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let currentCampaign = 'independence';
    let currentGranularity = 'Week';
    let currentAgent = '';
    let currentCallType = '';
    let currentPeriodKey = ''; 
       
    // Campaign-specific agents storage
    let independenceAgents = [];
    let creditSuiteAgents = [];
    
    // Chart instances
    let trendsChart, categoryChart, comparisonChart, scoreGaugeChart, passTrendChart, volumeChart, distributionChart, callTypeChart, momentumChart, impactChart;
    
    // Fixed baseUrl construction - get it from the template variables
    const scriptUrl = '<?= scriptUrl ?>';
    const rawToken = '<?= rawToken ?>';
    const campaignId = '<?= campaignId || "" ?>';
    
    // Construct proper baseUrl
    function getBaseUrl() {
        return `${scriptUrl}?token=${encodeURIComponent(rawToken)}`;
    }

    // Helpers
    function pad(n){ return String(n).padStart(2,'0'); }
    function quarterOf(d){ return Math.floor(d.getMonth()/3)+1; }

    function cloneChartConfig() {
        return JSON.parse(JSON.stringify(chartConfig));
    }

    function formatPercent(value, decimals = 1) {
        const num = Number(value);
        if (isNaN(num)) return '0%';
        return `${num.toFixed(decimals)}%`;
    }

    function formatNumber(value) {
        const num = Number(value);
        if (isNaN(num)) return '0';
        return num.toLocaleString();
    }

    function formatChange(value, decimals = 1, suffix = '%') {
        const num = Number(value);
        if (isNaN(num) || num === 0) {
            return `0${suffix}`;
        }
        const sign = num > 0 ? '+' : '';
        return `${sign}${num.toFixed(decimals)}${suffix}`;
    }

    function sanitizeSeries(series, options = {}) {
        const safeLabels = Array.isArray(series?.labels) ? series.labels : [];
        const safeValues = Array.isArray(series?.values) ? series.values : [];
        const sanitized = { labels: safeLabels, values: safeValues };
        if (options.includeCounts) {
            sanitized.counts = Array.isArray(series?.counts) ? series.counts : [];
        }
        if (options.includeAverages) {
            sanitized.averages = Array.isArray(series?.averages) ? series.averages : [];
        }
        if (options.includeBaselines) {
            sanitized.baselines = Array.isArray(series?.baselines) ? series.baselines : [];
        }
        return sanitized;
    }

    function getLatestChange(values) {
        if (!Array.isArray(values) || values.length < 2) return 0;
        const last = Number(values[values.length - 1]);
        const prev = Number(values[values.length - 2]);
        if (isNaN(last) || isNaN(prev)) return 0;
        return last - prev;
    }

    function getLastValue(values) {
        if (!Array.isArray(values) || !values.length) return 0;
        const val = Number(values[values.length - 1]);
        return isNaN(val) ? 0 : val;
    }

    // Set defaults for all pickers
    function setDefaultPickerValues(){
      const now = new Date();

      // Use your existing getISOWeek helper if present
      let weekString;
      try { weekString = getISOWeek(now); } catch(e) {
        // fallback compute ISO week: 2025-W34
        const d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const week = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        weekString = `${d.getUTCFullYear()}-W${pad(week)}`;
      }

      const weekInput = document.getElementById('weekInput');
      const monthInput = document.getElementById('monthInput');
      const quarterInput = document.getElementById('quarterInput');
      const quarterYearInput = document.getElementById('quarterYearInput');
      const yearInput = document.getElementById('yearInput');

      if (weekInput && !weekInput.value) weekInput.value = weekString;                                   // "YYYY-W##"
      if (monthInput && !monthInput.value) monthInput.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}`;
      if (quarterInput && !quarterInput.value) quarterInput.value = String(quarterOf(now));
      if (quarterYearInput && !quarterYearInput.value) quarterYearInput.value = String(now.getFullYear());
      if (yearInput && !yearInput.value) yearInput.value = String(now.getFullYear());
    }

    // Show only the picker that matches the current granularity
    function togglePickers(){
      const g = currentGranularity;
      const show = id => { const el = document.getElementById(id); if (el) el.style.display='block'; };
      const hide = id => { const el = document.getElementById(id); if (el) el.style.display='none'; };
      hide('weekPickerGroup'); hide('monthPickerGroup'); hide('quarterPickerGroup'); hide('yearPickerGroup');

      if (g==='Week') show('weekPickerGroup');
      else if (g==='Month') show('monthPickerGroup');
      else if (g==='Quarter') show('quarterPickerGroup');
      else show('yearPickerGroup');
    }

    // REPLACE your existing getCurrentPeriod with this version
    function getCurrentPeriod(){
      if (currentGranularity==='Week'){
        const v = document.getElementById('weekInput')?.value;      // "YYYY-W##"
        if (v) return v;
      }
      if (currentGranularity==='Month'){
        const v = document.getElementById('monthInput')?.value;     // "YYYY-MM"
        if (v) return v;
      }
      if (currentGranularity==='Quarter'){
        const q = document.getElementById('quarterInput')?.value;
        const y = document.getElementById('quarterYearInput')?.value;
        if (q && y) return `Q${q}-${y}`;
      }
      // Year
      const y = document.getElementById('yearInput')?.value;
      if (y) return String(y);

      // Fallback to now if inputs missing
      const now = new Date();
      if (currentGranularity==='Week'){
        try { return getISOWeek(now); } catch(e){ return 'W' + now.getFullYear(); }
      } else if (currentGranularity==='Month'){
        return `${now.getFullYear()}-${pad(now.getMonth()+1)}`;
      } else if (currentGranularity==='Quarter'){
        return `Q${quarterOf(now)}-${now.getFullYear()}`;
      } else {
        return String(now.getFullYear());
      }
    }

    // Chart configuration
    const chartConfig = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    usePointStyle: true,
                    padding: 20,
                    font: {
                        family: "'Google Sans', sans-serif",
                        size: 12,
                        weight: '500'
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#003177',
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0,0,0,.05)'
                },
                ticks: {
                    font: {
                        family: "'Google Sans', sans-serif"
                    }
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    font: {
                        family: "'Google Sans', sans-serif"
                    }
                }
            }
        },
        layout: {
            padding: {
                top: 10,
                bottom: 10
            }
        }
    };

    // Campaign colors
    const campaignColors = {
        independence: {
            primary: '#00BFFF',
            gradient: 'rgba(0, 191, 255, 0.15)',
            border: '#00BFFF',
            background: 'rgba(0, 191, 255, 0.08)'
        },
        'credit-suite': {
            primary: '#FFB800',
            gradient: 'rgba(255, 184, 0, 0.15)',
            border: '#FFB800',
            background: 'rgba(255, 184, 0, 0.08)'
        }
    };

    const accentPalette = ['#00BFFF', '#2563eb', '#22d3ee', '#14b8a6', '#a855f7', '#f97316', '#ef4444'];

    function getPaletteColor(index) {
        return accentPalette[index % accentPalette.length];
    }

    function withAlpha(hex, alpha) {
        if (!hex) return `rgba(0,0,0,${alpha})`;
        let value = hex.replace('#', '');
        if (value.length === 3) {
            value = value.split('').map(ch => ch + ch).join('');
        }
        const intVal = parseInt(value, 16);
        const r = (intVal >> 16) & 255;
        const g = (intVal >> 8) & 255;
        const b = intVal & 255;
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        const isDashboard = document.querySelector('.modern-kpi-grid') || document.getElementById('trendsChart');
        if (!isDashboard) return; // prevents errors when this script is loaded on other pages
        
        // Check if Google Apps Script environment is available
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
            console.warn('Google Apps Script environment not detected');
            showMessage('Dashboard is running in offline mode. Some features may be limited.', 'warning');
        }        

        initializeCampaignSwitcher();
        initializeControls();
        initializeCharts();
        loadCampaignUsers();
        loadDashboardData();

        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                loadDashboardData();
            });
        }

        // Initialize animations
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        });

        document.querySelectorAll('.fade-in, .stagger-animation > *').forEach(el => {
            observer.observe(el);
        });
    });

    function initializeCampaignSwitcher() {
        const switchers = document.querySelectorAll('.switcher-option');
        switchers.forEach(switcher => {
            switcher.addEventListener('click', function() {
                // Remove active class from all
                switchers.forEach(s => s.classList.remove('active'));
                // Add active class to clicked
                this.classList.add('active');
                
                // Update current campaign
                currentCampaign = this.dataset.campaign;
                
                // Update campaign indicators
                updateCampaignIndicators();
                
                // Update action buttons
                updateActionButtons();
                
                // Update agent filters for the new campaign
                updateAgentFilter();
                
                // Update call type filter
                updateCallTypeFilter();
                
                // Reload data
                loadDashboardData();
            });
        });
    }

    const GRANULARITY_OPTIONS = ['Week','Month','Quarter','Year'];

    function pick(...ids){ return ids.map(id=>document.getElementById(id)).find(Boolean); }

    function ensureGranularityOptions(selectEl){
      if(!selectEl) return;
      const existing = Array.from(selectEl.options).map(o=>o.value);
      const missing = GRANULARITY_OPTIONS.filter(v=>!existing.includes(v));
      if (existing.length !== GRANULARITY_OPTIONS.length || missing.length){
        selectEl.innerHTML = GRANULARITY_OPTIONS
          .map(v => `<option value="${v}" ${v===currentGranularity?'selected':''}>${v}</option>`)
          .join('');
      }
    }

    function initializeControls(){
      const granSel = document.getElementById('granularitySelect');
      const agentSel = document.getElementById('agentSelect');
      const callTypeSel = document.getElementById('callTypeSelect');

      const missing = [];
      if (!granSel) missing.push('granularitySelect');
      if (!agentSel) missing.push('agentSelect');
      if (!callTypeSel) missing.push('callTypeSelect');
      if (missing.length){
        console.warn('Dashboard controls missing, skipping init for:\n', missing);
      }

      // Granularity
      if (granSel){
        granSel.addEventListener('change', () => {
          currentGranularity = granSel.value;
          togglePickers();
          setDefaultPickerValues();
          loadDashboardData();
        });
      }

      // Agent & call type
      if (agentSel) agentSel.addEventListener('change', () => { currentAgent = agentSel.value; loadDashboardData(); });
      if (callTypeSel) callTypeSel.addEventListener('change', () => { currentCallType = callTypeSel.value; loadDashboardData(); });

      // Period pickers -> refresh on change
      ['weekInput','monthInput','quarterInput','quarterYearInput','yearInput'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', () => loadDashboardData());
      });

      // First paint
      togglePickers();
      setDefaultPickerValues();
    }

    function loadCampaignUsers() {
        // Load Independence Insurance users
        google.script.run
            .withSuccessHandler(function(users) {
                console.log('Independence users loaded:', users);
                independenceAgents = users;
                if (currentCampaign === 'independence') {
                    updateAgentFilter();
                }
            })
            .withFailureHandler(function(error) {
                console.error('Error loading Independence users:', error);
                independenceAgents = [];
            })
            .clientGetIndependenceUsers();
            
        // Load Credit Suite users (when implemented)
        try {
            google.script.run
                .withSuccessHandler(function(users) {
                    console.log('Credit Suite users loaded:', users);
                    creditSuiteAgents = users;
                    if (currentCampaign === 'credit-suite') {
                        updateAgentFilter();
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading Credit Suite users:', error);
                    creditSuiteAgents = [];
                })
                .clientGetCreditSuiteUsers();
        } catch (error) {
            console.log('Credit Suite user loading not available yet');
            creditSuiteAgents = [];
        }
    }

    function updateAgentFilter() {
        const agentSelect = document.getElementById('agentSelect');
        const currentAgents = currentCampaign === 'independence' ? independenceAgents : creditSuiteAgents;
        
        // Clear existing options except the first one
        while (agentSelect.children.length > 1) {
            agentSelect.removeChild(agentSelect.lastChild);
        }

        // Add campaign-specific agents
        currentAgents.forEach(user => {
            const option = document.createElement('option');
            option.value = user.name;
            option.textContent = user.name;
            agentSelect.appendChild(option);
        });
        
        // Reset selection
        agentSelect.value = '';
        currentAgent = '';
    }

    function updateCallTypeFilter() {
        const callTypeSelect = document.getElementById('callTypeSelect');
        
        // Clear existing options except the first one
        while (callTypeSelect.children.length > 1) {
            callTypeSelect.removeChild(callTypeSelect.lastChild);
        }

        // Add call types based on campaign
        if (currentCampaign === 'independence') {
            const independenceCallTypes = ['New Venture', 'Renewal'];
            independenceCallTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                callTypeSelect.appendChild(option);
            });
        } else {
            // Credit Suite call types (when implemented)
            const creditSuiteCallTypes = ['Inbound', 'Outbound', 'Follow-up'];
            creditSuiteCallTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                callTypeSelect.appendChild(option);
            });
        }
        
        // Reset selection
        callTypeSelect.value = '';
        currentCallType = '';
    }

    function updateCampaignIndicators() {
        const campaignName = currentCampaign === 'independence' ? 'Independence' : 'Credit Suite';
        const campaignClass = currentCampaign;
        
        const indicators = [
            'avgScoreIndicator', 'passRateIndicator', 'evaluationsIndicator',
            'agentsIndicator', 'trendsIndicator', 'categoryIndicator', 'comparisonIndicator',
            'gaugeIndicator', 'topAgentsIndicator', 'passTrendIndicator', 'volumeIndicator',
            'distributionIndicator', 'callTypeIndicator', 'momentumIndicator', 'impactIndicator'
        ];
        
        indicators.forEach(id => {
            const indicator = document.getElementById(id);
            if (indicator) {
                indicator.textContent = campaignName;
                indicator.className = `campaign-indicator ${campaignClass}`;
            }
        });
    }

    function updateActionButtons() {
        const newQABtn = document.getElementById('newQABtn');
        const qaListBtn = document.getElementById('qaListBtn');
        const baseUrl = getBaseUrl();
        
        if (currentCampaign === 'independence') {
            // Use the correct page names for Independence Insurance
            newQABtn.href = `${baseUrl}&page=independencequality`;
            qaListBtn.href = `${baseUrl}&page=qalist`;
        } else {
            // Use the correct page names for Credit Suite
            newQABtn.href = `${baseUrl}&creditsuiteqa`;
            qaListBtn.href = `${baseUrl}&page=qalist`;
        }
        
        console.log('Updated button URLs:', {
            newQAUrl: newQABtn.href,
            qaListUrl: qaListBtn.href
        });
    }

    function initializeCharts() {
        const colors = campaignColors[currentCampaign];

        const gaugeCtx = document.getElementById('scoreGaugeChart');
        if (gaugeCtx) {
            scoreGaugeChart = new Chart(gaugeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Achieved', 'Remaining'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: [colors.primary, 'rgba(148, 163, 184, 0.25)'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '70%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }

        const trendsCtx = document.getElementById('trendsChart');
        if (trendsCtx) {
            const options = cloneChartConfig();
            options.plugins.legend.display = false;
            options.scales.y.suggestedMax = 100;
            trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Score',
                        data: [],
                        borderColor: colors.primary,
                        backgroundColor: colors.gradient,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff'
                    }]
                },
                options
            });
        }

        const passCtx = document.getElementById('passTrendChart');
        if (passCtx) {
            const options = cloneChartConfig();
            options.plugins.legend.display = false;
            options.scales.y.suggestedMax = 100;
            options.scales.y.title = { display: true, text: 'Pass Rate %' };
            passTrendChart = new Chart(passCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Pass Rate',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.15)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: '#fff'
                    }]
                },
                options
            });
        }

        const volumeCtx = document.getElementById('volumeChart');
        if (volumeCtx) {
            const options = cloneChartConfig();
            options.plugins.legend.display = false;
            options.scales.y.title = { display: true, text: 'Evaluations' };
            volumeChart = new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Evaluations',
                        data: [],
                        backgroundColor: colors.background,
                        borderColor: colors.primary,
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options
            });
        }

        const categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
            categoryChart = new Chart(categoryCtx, {
                type: 'radar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Category Score',
                        data: [],
                        backgroundColor: colors.gradient,
                        borderColor: colors.primary,
                        borderWidth: 2,
                        pointBackgroundColor: colors.primary
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        r: {
                            suggestedMin: 0,
                            suggestedMax: 100,
                            angleLines: { color: 'rgba(148,163,184,0.2)' },
                            grid: { color: 'rgba(148,163,184,0.2)' },
                            ticks: { display: false },
                            pointLabels: {
                                font: { family: "'Google Sans', sans-serif", size: 12 }
                            }
                        }
                    }
                }
            });
        }

        const distributionCtx = document.getElementById('distributionChart');
        if (distributionCtx) {
            const options = cloneChartConfig();
            options.plugins.legend.display = false;
            options.indexAxis = 'y';
            options.scales.x.title = { display: true, text: 'Evaluations' };
            distributionChart = new Chart(distributionCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Evaluations',
                        data: [],
                        backgroundColor: colors.gradient,
                        borderColor: colors.border,
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options
            });
        }

        const callTypeCtx = document.getElementById('callTypeChart');
        if (callTypeCtx) {
            callTypeChart = new Chart(callTypeCtx, {
                type: 'polarArea',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Score',
                        data: [],
                        backgroundColor: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        r: {
                            suggestedMin: 0,
                            suggestedMax: 100,
                            grid: { color: 'rgba(148,163,184,0.2)' }
                        }
                    }
                }
            });
        }

        const comparisonCtx = document.getElementById('comparisonChart');
        if (comparisonCtx) {
            const options = cloneChartConfig();
            options.indexAxis = 'y';
            options.plugins.legend.display = false;
            options.scales.x.suggestedMax = 100;
            comparisonChart = new Chart(comparisonCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Score',
                        data: [],
                        backgroundColor: colors.gradient,
                        borderColor: colors.border,
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options
            });
        }

        const momentumCtx = document.getElementById('momentumChart');
        if (momentumCtx) {
            const options = cloneChartConfig();
            options.indexAxis = 'y';
            options.plugins.legend.display = false;
            options.scales.x.title = { display: true, text: 'Score Change' };
            momentumChart = new Chart(momentumCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Change vs Last Period',
                        data: [],
                        backgroundColor: [],
                        borderWidth: 0,
                        borderRadius: 6
                    }]
                },
                options
            });
        }

        const impactCtx = document.getElementById('impactChart');
        if (impactCtx) {
            impactChart = new Chart(impactCtx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Agent Impact',
                        data: [],
                        backgroundColor: withAlpha(colors.primary, 0.25),
                        borderColor: colors.border,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Evaluations' },
                            beginAtZero: true
                        },
                        y: {
                            title: { display: true, text: 'Average Score' },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    }
                }
            });
        }
    }

    /**
     * MAIN ANALYTICS ENDPOINT for Independence Insurance
     * @param {'Week'|'Month'|'Quarter'|'Year'} granularity
     * @param {string} period - e.g. '2025-W03', '2025-01', 'Q1-2025', '2025'
     * @param {string} agentFilter - exact AgentName or ''
     * @param {string} callTypeFilter - exact CallType or ''
     */
    function clientGetIndependenceQAAnalytics(granularity, period, agentFilter, callTypeFilter) {
      try {
        const sh = SpreadsheetApp.openById(INDEPENDENCE_SHEET_ID).getSheetByName(INDEPENDENCE_QA_SHEET);
        if (!sh || sh.getLastRow() < 2) return getEmptyAnalyticsPayload();

        // Pull all data
        const headers = INDEPENDENCE_QA_HEADERS;
        const data = sh.getRange(2, 1, sh.getLastRow() - 1, headers.length).getValues();

        // Index helpers
        const idx = (name) => headers.indexOf(name);
        const iAudit = idx('AuditDate');
        const iScore = idx('PercentageScore');
        const iStatus = idx('PassStatus');
        const iAgent = idx('AgentName');
        const iCall  = idx('CallType');
        const iTs    = idx('Timestamp');

        // Map question -> category using config
        const questionToCategory = {};
        if (INDEPENDENCE_QA_CONFIG?.categories) {
          Object.entries(INDEPENDENCE_QA_CONFIG.categories).forEach(([catName, cat]) => {
            (cat.questions || []).forEach(q => { questionToCategory[q.id] = catName; });
          });
        }

        // Build records (lightweight)
        const records = [];
        for (const row of data) {
          // Parse date (AuditDate preferred, then Timestamp)
          const d = parseDateCell(row[iAudit]) || parseDateCell(row[iTs]);
          if (!d) continue;

          const rec = {
            date: d,
            periodKey: getPeriodKey(d, granularity),
            score: toNumber(row[iScore]),
            status: String(row[iStatus] || ''),
            agent: String(row[iAgent] || ''),
            callType: String(row[iCall] || ''),
            row // keep the raw row for category math
          };
          records.push(rec);
        }

        // Current + previous periods
        const currentPeriod = period || getPeriodKey(new Date(), granularity);
        const previousPeriod = getPreviousPeriodKey(currentPeriod, granularity);

        // Apply static filters builder
        const rowMatchesFilters = (rec, periodKey) =>
          rec.periodKey === periodKey &&
          (!agentFilter || rec.agent === agentFilter) &&
          (!callTypeFilter || rec.callType === callTypeFilter);

        // Current subset
        const currentSet = records.filter(r => rowMatchesFilters(r, currentPeriod));
        // Previous subset
        const prevSet = records.filter(r => rowMatchesFilters(r, previousPeriod));

        // KPIs
        const avgScore = average(currentSet.map(r => r.score));
        const passRate = calcPassRate(currentSet);
        const totalEvaluations = currentSet.length;
        const agentsEvaluated = unique(currentSet.map(r => r.agent)).length;

        const prevAvgScore = average(prevSet.map(r => r.score));
        const prevPassRate = calcPassRate(prevSet);
        const prevTotalEvaluations = prevSet.length;
        const prevAgentsEvaluated = unique(prevSet.map(r => r.agent)).length;

        // Changes vs last period (percentage points for rates/averages; absolute for counts)
        const avgScoreChange = prevAvgScore === 0 ? (avgScore ? 100 : 0) : ((avgScore - prevAvgScore));
        const passRateChange = prevPassRate === 0 ? (passRate ? 100 : 0) : ((passRate - prevPassRate));
        const evaluationsChange = totalEvaluations - prevTotalEvaluations;
        const agentsChange = agentsEvaluated - prevAgentsEvaluated;

        // Trends (last N periods up to current)
        const trendPeriods = getLastNPeriods(8, currentPeriod, granularity); // array oldest -> newest
        const trendStats = trendPeriods.map(p => {
          const subset = records.filter(r =>
            r.periodKey === p &&
            (!agentFilter || r.agent === agentFilter) &&
            (!callTypeFilter || r.callType === callTypeFilter)
          );
          if (!subset.length) {
            return { period: p, average: 0, passRate: 0, volume: 0 };
          }
          return {
            period: p,
            average: round2(average(subset.map(s => s.score))),
            passRate: round2(calcPassRate(subset)),
            volume: subset.length
          };
        });
        const trendLabels = trendPeriods;
        const trendValues = trendStats.map(s => s.average);
        const passTrendValues = trendStats.map(s => s.passRate);
        const volumeTrendValues = trendStats.map(s => s.volume);

        // Category performance (for current period)
        const categorySummary = computeCategoryPerformance(currentSet, headers, questionToCategory);

        // Agent comparison and advanced stats (for current period)
        const byAgentMap = new Map();
        currentSet.forEach(r => {
          const key = r.agent || 'Unknown';
          if (!byAgentMap.has(key)) byAgentMap.set(key, []);
          byAgentMap.get(key).push(r);
        });

        const prevByAgentMap = new Map();
        prevSet.forEach(r => {
          const key = r.agent || 'Unknown';
          if (!prevByAgentMap.has(key)) prevByAgentMap.set(key, []);
          prevByAgentMap.get(key).push(r);
        });

        const prevAverageMap = new Map();
        prevByAgentMap.forEach((agentRecords, agent) => {
          prevAverageMap.set(agent, average(agentRecords.map(rec => rec.score)));
        });

        const agentStats = Array.from(byAgentMap.entries())
          .map(([agent, recs]) => ({
            agent: agent || 'Unknown',
            score: round2(average(recs.map(s => s.score))),
            evaluations: recs.length,
            passRate: round2(calcPassRate(recs))
          }))
          .sort((a,b) => b.score - a.score);

        const topAgentStats = agentStats.slice(0, 20);
        const topAgentsDetailed = agentStats.slice(0, 3).map(stat => {
          const previousAverage = prevAverageMap.has(stat.agent) ? prevAverageMap.get(stat.agent) : stat.score;
          return {
            agent: stat.agent,
            score: stat.score,
            change: round2(stat.score - previousAverage),
            evaluations: stat.evaluations,
            passRate: stat.passRate
          };
        });

        const agentMomentum = agentStats
          .map(stat => {
            const previousAverage = prevAverageMap.has(stat.agent) ? prevAverageMap.get(stat.agent) : stat.score;
            return {
              agent: stat.agent,
              change: round2(stat.score - previousAverage),
              baseline: stat.score
            };
          })
          .sort((a,b) => b.change - a.change)
          .slice(0, 6);

        const agentImpact = agentStats.slice(0, 8).map(stat => ({
          agent: stat.agent,
          average: stat.score,
          evaluations: stat.evaluations,
          passRate: stat.passRate
        }));

        const callTypeMap = new Map();
        currentSet.forEach(r => {
          const key = r.callType || 'Unspecified';
          if (!callTypeMap.has(key)) callTypeMap.set(key, []);
          callTypeMap.get(key).push(r);
        });
        const callTypeLabels = Array.from(callTypeMap.keys());
        const callTypeValues = callTypeLabels.map(label => round2(average(callTypeMap.get(label).map(rec => rec.score))));
        const callTypeCounts = callTypeLabels.map(label => callTypeMap.get(label).length);

        const distributionBuckets = [
          { label: '0-59%', min: 0, max: 59.999 },
          { label: '60-69%', min: 60, max: 69.999 },
          { label: '70-79%', min: 70, max: 79.999 },
          { label: '80-89%', min: 80, max: 89.999 },
          { label: '90-100%', min: 90, max: 1000 }
        ];
        const distributionValues = distributionBuckets.map(bucket =>
          currentSet.filter(rec => rec.score >= bucket.min && rec.score <= bucket.max).length
        );

        return {
          avgScore: round2(avgScore),
          passRate: round2(passRate),
          totalEvaluations,
          agentsEvaluated,
          avgScoreChange: round2(avgScoreChange),
          passRateChange: round2(passRateChange),
          evaluationsChange,
          agentsChange,
          trends: {
            labels: trendLabels,
            values: trendValues
          },
          passTrend: {
            labels: trendLabels,
            values: passTrendValues
          },
          volumeTrend: {
            labels: trendLabels,
            values: volumeTrendValues
          },
          categories: {
            labels: categorySummary.labels,
            values: categorySummary.values
          },
          agents: {
            labels: topAgentStats.map(a => a.agent || 'Unknown'),
            values: topAgentStats.map(a => a.score)
          },
          callTypes: {
            labels: callTypeLabels,
            values: callTypeValues,
            counts: callTypeCounts
          },
          distribution: {
            labels: distributionBuckets.map(b => b.label),
            values: distributionValues
          },
          topAgents: topAgentsDetailed,
          momentum: {
            labels: agentMomentum.map(a => a.agent),
            values: agentMomentum.map(a => a.change),
            baselines: agentMomentum.map(a => a.baseline)
          },
          agentImpact
        };
      } catch (err) {
        safeWriteError('clientGetIndependenceQAAnalytics', err);
        return getEmptyAnalyticsPayload();
      }
    }

    function loadDashboardData(){
      const functionName = (currentCampaign === 'independence')
        ? 'clientGetIndependenceQAAnalytics'
        : 'clientGetCreditSuiteQAAnalytics';

      setLoadingState(true);
      const period = getCurrentPeriod(); // <-- key part

      google.script.run
        .withSuccessHandler(data => { setLoadingState(false); updateDashboard(data); })
        .withFailureHandler(error => { setLoadingState(false); handleError(error); updateDashboard(getEmptyAnalytics()); })
        [functionName](currentGranularity, period, currentAgent, currentCallType);
    }

    /************************************************************
     * UnifiedQADashboard Server Endpoints (Independence + stubs)
     ************************************************************/

    /**
     * EXPORT endpoint for Independence Insurance
     * Returns row objects ready to csv on client
     */
    function exportIndependenceQAData(granularity, period, agentFilter, callTypeFilter) {
      try {
        const sh = SpreadsheetApp.openById(INDEPENDENCE_SHEET_ID).getSheetByName(INDEPENDENCE_QA_SHEET);
        if (!sh || sh.getLastRow() < 2) return [];

        const headers = INDEPENDENCE_QA_HEADERS;
        const data = sh.getRange(2, 1, sh.getLastRow() - 1, headers.length).getValues();

        const idx = (name) => headers.indexOf(name);
        const iAudit = idx('AuditDate');
        const iScore = idx('PercentageScore');
        const iStatus = idx('PassStatus');
        const iAgent = idx('AgentName');
        const iEmail = idx('AgentEmail');
        const iCall  = idx('CallType');
        const iId    = idx('ID');
        const iCaller= idx('CallerName');
        const iCallDate = idx('CallDate');
        const iTs    = idx('Timestamp');

        const currentPeriod = period || getPeriodKey(new Date(), granularity);

        const out = [];
        for (const row of data) {
          const d = parseDateCell(row[iAudit]) || parseDateCell(row[iTs]);
          if (!d) continue;

          const periodKey = getPeriodKey(d, granularity);
          const agent = String(row[iAgent] || '');
          const callType = String(row[iCall] || '');

          if (periodKey !== currentPeriod) continue;
          if (agentFilter && agent !== agentFilter) continue;
          if (callTypeFilter && callType !== callTypeFilter) continue;

          out.push({
            ID: row[iId],
            AuditDate: formatYMD(d),
            CallDate: String(row[iCallDate] || ''),
            AgentName: agent,
            AgentEmail: String(row[iEmail] || ''),
            CallerName: String(row[iCaller] || ''),
            CallType: callType,
            PercentageScore: toNumber(row[iScore]),
            PassStatus: String(row[iStatus] || '')
          });
        }
        return out;
      } catch (err) {
        safeWriteError('exportIndependenceQAData', err);
        return [];
      }
    }

    /* ---------- Optional Credit Suite stubs so UI never errors ---------- */

    function clientGetCreditSuiteQAAnalytics(granularity, period, agentFilter, callTypeFilter) {
      // Replace with real implementation when Credit Suite is wired
      return getEmptyAnalyticsPayload();
    }

    function exportCreditSuiteQAData(granularity, period, agentFilter, callTypeFilter) {
      // Replace with real implementation when Credit Suite is wired
      return [];
    }

    function clientGetCreditSuiteUsers() {
      // Replace with real user retrieval for Credit Suite
      return [];
    }

    /* =========================
      Analytics Helpers
      ========================= */

    function getEmptyAnalyticsPayload() {
      return {
        avgScore: 0,
        passRate: 0,
        totalEvaluations: 0,
        agentsEvaluated: 0,
        avgScoreChange: 0,
        passRateChange: 0,
        evaluationsChange: 0,
        agentsChange: 0,
        trends: { labels: ['No Data'], values: [0] },
        categories: { labels: ['No Data'], values: [0] },
        agents: { labels: ['No Data'], values: [0] },
        passTrend: { labels: ['No Data'], values: [0] },
        volumeTrend: { labels: ['No Data'], values: [0] },
        callTypes: { labels: ['No Data'], values: [0], counts: [0] },
        distribution: { labels: ['No Data'], values: [0] },
        topAgents: [],
        momentum: { labels: [], values: [], baselines: [] },
        agentImpact: []
      };
    }

    function parseDateCell(val) {
      if (!val) return null;
      if (val instanceof Date && !isNaN(val)) return val;
      const s = String(val).trim();
      if (!s) return null;
      // Try yyyy-MM-dd first
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
      const d = new Date(s);
      return isNaN(d) ? null : d;
    }

    function formatYMD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function toNumber(v) {
      const n = Number(v);
      return isNaN(n) ? 0 : n;
    }

    function average(arr) {
      const nums = arr.filter(x => typeof x === 'number' && !isNaN(x));
      if (!nums.length) return 0;
      return nums.reduce((a,b)=>a+b,0)/nums.length;
    }

    function round2(n) {
      return Math.round((n + Number.EPSILON) * 100) / 100;
    }

    function unique(arr) {
      return Array.from(new Set(arr.filter(Boolean)));
    }

    function calcPassRate(recs) {
      if (!recs.length) return 0;
      const passTh = INDEPENDENCE_QA_CONFIG?.scoring?.passThreshold ?? 85;
      const passed = recs.filter(r => (r.score >= passTh) && !/Critical Failure/i.test(r.status)).length;
      return (passed / recs.length) * 100;
    }

    /* Period handling */
    function getPeriodKey(date, granularity) {
      const y = date.getFullYear();
      const m = date.getMonth(); // 0-11
      if (granularity === 'Year') return String(y);
      if (granularity === 'Month') return `${y}-${String(m+1).padStart(2,'0')}`;
      if (granularity === 'Quarter') {
        const q = Math.floor(m/3)+1;
        return `Q${q}-${y}`;
      }
      return getISOWeekKey(date); // Week
    }

    function getISOWeekKey(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
    }

    function getPreviousPeriodKey(currentKey, granularity) {
      if (granularity === 'Year') return String(Number(currentKey) - 1);

      if (granularity === 'Month') {
        const [y, m] = currentKey.split('-').map(Number);
        const d = new Date(y, m - 1, 1);
        d.setMonth(d.getMonth() - 1);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      }

      if (granularity === 'Quarter') {
        const m = currentKey.match(/^Q([1-4])-(\d{4})$/);
        if (!m) return currentKey;
        let q = Number(m[1]), y = Number(m[2]);
        q -= 1; if (q < 1) { q = 4; y -= 1; }
        return `Q${q}-${y}`;
      }

      const wm = currentKey.match(/^(\d{4})-W(\d{2})$/);
      if (!wm) return currentKey;
      const y = Number(wm[1]), w = Number(wm[2]);
      const monday = isoWeekToDate(y, w);
      monday.setDate(monday.getDate() - 7);
      return getISOWeekKey(monday);
    }

    function getLastNPeriods(n, endKey, granularity) {
      const arr = [];
      let key = endKey;
      for (let i = 0; i < n; i++) {
        arr.unshift(key);
        key = getPreviousPeriodKey(key, granularity);
      }
      return arr;
    }

    function isoWeekToDate(isoYear, isoWeek, isoWeekday = 1) {
      const simple = new Date(Date.UTC(isoYear, 0, 1 + (isoWeek - 1) * 7));
      const dow = simple.getUTCDay();
      const ISOweekStart = new Date(simple);
      if (dow <= 4) ISOweekStart.setUTCDate(simple.getUTCDate() - simple.getUTCDay() + 1);
      else ISOweekStart.setUTCDate(simple.getUTCDate() + 8 - simple.getUTCDay());
      ISOweekStart.setUTCDate(ISOweekStart.getUTCDate() + (isoWeekday - 1));
      return new Date(ISOweekStart);
    }

    function getLastNPeriods(n, endKey, granularity) {
      const arr = [];
      let key = endKey;
      for (let i = 0; i < n; i++) {
        arr.unshift(key);
        key = getPreviousPeriodKey(key, granularity);
      }
      return arr;
    }

    /* Category performance over current set */
    function computeCategoryPerformance(currentSet, headers, questionToCategory) {
      if (!currentSet.length) return { labels: getCategoryLabels(), values: getCategoryLabels().map(() => 0) };

      // Prepare per-category totals
      const catTotals = {};
      getCategoryLabels().forEach(c => catTotals[c] = { earned: 0, possible: 0 });

      // Precompute indices for question and max columns we need
      const qCols = {};
      Object.keys(questionToCategory).forEach(qid => {
        const ansIdx = headers.indexOf(qid);
        const maxIdx = headers.indexOf(qid + '_MaxPoints');
        if (ansIdx >= 0 && maxIdx >= 0) qCols[qid] = { ansIdx, maxIdx };
      });

      for (const rec of currentSet) {
        const row = rec.row;
        for (const [qid, cat] of Object.entries(questionToCategory)) {
          const cols = qCols[qid];
          if (!cols) continue;
          const ans = String(row[cols.ansIdx] || 'NA');
          const max = toNumber(row[cols.maxIdx] || 0);

          if (ans === 'NA' || ans === '') continue; // does not count toward possible
          const earned = (ans === 'Yes') ? max : 0;

          catTotals[cat] = catTotals[cat] || { earned: 0, possible: 0 };
          catTotals[cat].earned += earned;
          catTotals[cat].possible += max;
        }
      }

      const labels = getCategoryLabels();
      const values = labels.map(cat => {
        const t = catTotals[cat] || { earned: 0, possible: 0 };
        return t.possible > 0 ? round2((t.earned / t.possible) * 100) : 0;
      });

      return { labels, values };
    }

    function getCategoryLabels() {
      return INDEPENDENCE_QA_CONFIG && INDEPENDENCE_QA_CONFIG.categories
        ? Object.keys(INDEPENDENCE_QA_CONFIG.categories)
        : ['Call Opening','Needs Discovery & Qualification','Appointment Setting','End of Call Procedure','Soft Skills & Compliance'];
    }

    function getCurrentPeriod() {
        // Implementation to get current period based on granularity
        const now = new Date();
        switch(currentGranularity) {
            case 'Week':
                return getISOWeek(now);
            case 'Month':
                return now.toISOString().slice(0, 7);
            case 'Quarter':
                return `Q${Math.ceil((now.getMonth() + 1) / 3)}-${now.getFullYear()}`;
            case 'Year':
                return now.getFullYear().toString();
            default:
                return getISOWeek(now);
        }
    }

    function getISOWeek(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return `${d.getUTCFullYear()}-W${Math.ceil((((d - yearStart) / 86400000) + 1) / 7).toString().padStart(2, '0')}`;
    }

    function buildPeriodSelect() {
      const periodSelect = document.getElementById('periodSelect');
      if (!periodSelect) return;

      // Determine how many periods to show for each granularity
      const now = new Date();
      const currentKey = getPeriodKey(now, currentGranularity);
      currentPeriodKey = currentKey;

      const count = (currentGranularity === 'Year') ? 5
                  : (currentGranularity === 'Quarter') ? 8
                  : (currentGranularity === 'Month') ? 12
                  : 8; // Week

      // Build the period list (oldest -> newest)
      const keys = getLastNPeriods(count, currentKey, currentGranularity);

      // Clear and rebuild options
      while (periodSelect.firstChild) periodSelect.removeChild(periodSelect.firstChild);
      keys.forEach(k => {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = k;
        if (k === currentKey) opt.selected = true;
        periodSelect.appendChild(opt);
      });

      // Ensure change handler is wired (idempotent)
      periodSelect.onchange = function() {
        currentPeriodKey = this.value;
        loadDashboardData();
      };
    }

    function getEmptyAnalytics() {
        // Return empty analytics structure when no data is available
        return {
            avgScore: 0,
            passRate: 0,
            totalEvaluations: 0,
            agentsEvaluated: 0,
            avgScoreChange: 0,
            passRateChange: 0,
            evaluationsChange: 0,
            agentsChange: 0,
            trends: {
                labels: ['No Data'],
                values: [0]
            },
            categories: {
                labels: ['No Data'],
                values: [0]
            },
            agents: {
                labels: ['No Data'],
                values: [0]
            },
            passTrend: { labels: ['No Data'], values: [0] },
            volumeTrend: { labels: ['No Data'], values: [0] },
            callTypes: { labels: ['No Data'], values: [0], counts: [0] },
            distribution: { labels: ['No Data'], values: [0] },
            topAgents: [],
            momentum: { labels: [], values: [], baselines: [] },
            agentImpact: []
        };
    }

    function setLoadingState(isLoading) {
        const elements = ['kpiAvgScore', 'kpiPassRate', 'kpiEvaluations', 'kpiAgents'];
        elements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                if (isLoading) {
                    element.textContent = '...';
                    element.style.opacity = '0.6';
                }
            }
        });

        // Show loading on charts
        const chartCards = document.querySelectorAll('.modern-chart-card');
        chartCards.forEach(card => {
            if (isLoading) {
                card.classList.add('loading');
            } else {
                card.classList.remove('loading');
                // Restore opacity for KPIs
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.opacity = '1';
                    }
                });
            }
        });
    }

    function showMessage(message, type = 'info') {
        const alertClass = type === 'error' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' : 
                          type === 'success' ? 'alert-success' : 'alert-info';
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert ${alertClass}`;
        messageDiv.style.cssText = `
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 9999; 
            padding: 1rem; 
            border-radius: 8px;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        messageDiv.textContent = message;
        
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 5000);
    }

    function updateDashboard(data) {
        if (!data || typeof data !== 'object') {
            console.warn('Invalid data received:', data);
            data = getEmptyAnalytics();
        }

        const validatedData = {
            avgScore: Number(data.avgScore) || 0,
            passRate: Number(data.passRate) || 0,
            totalEvaluations: Number(data.totalEvaluations) || 0,
            agentsEvaluated: Number(data.agentsEvaluated) || 0,
            avgScoreChange: Number(data.avgScoreChange) || 0,
            passRateChange: Number(data.passRateChange) || 0,
            evaluationsChange: Number(data.evaluationsChange) || 0,
            agentsChange: Number(data.agentsChange) || 0,
            trends: sanitizeSeries(data.trends),
            categories: sanitizeSeries(data.categories),
            agents: sanitizeSeries(data.agents),
            passTrend: sanitizeSeries(data.passTrend),
            volumeTrend: sanitizeSeries(data.volumeTrend),
            callTypes: sanitizeSeries(data.callTypes, { includeCounts: true, includeAverages: true }),
            distribution: sanitizeSeries(data.distribution),
            topAgents: Array.isArray(data.topAgents) ? data.topAgents : [],
            momentum: sanitizeSeries(data.momentum, { includeBaselines: true }),
            agentImpact: Array.isArray(data.agentImpact) ? data.agentImpact : []
        };

        updateKPIs(validatedData);
        updateCharts(validatedData);
        renderTopAgents(validatedData);
        renderCategoryBreakdown(validatedData.categories);
        renderAIInsights(validatedData);
    }

    function updateKPIs(data) {
        // Update KPI values with animation
        const kpis = [
            { id: 'kpiAvgScore', value: data.avgScore || 0, suffix: '%' },
            { id: 'kpiPassRate', value: data.passRate || 0, suffix: '%' },
            { id: 'kpiEvaluations', value: data.totalEvaluations || 0, suffix: '' },
            { id: 'kpiAgents', value: data.agentsEvaluated || 0, suffix: '' }
        ];

        kpis.forEach(kpi => {
            const element = document.getElementById(kpi.id);
            if (element) {
                element.style.transform = 'scale(1.1)';
                element.textContent = kpi.value + kpi.suffix;
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 200);
            }
        });

        const gaugePass = document.getElementById('gaugePassRate');
        if (gaugePass) {
            gaugePass.textContent = formatPercent(data.passRate);
        }

        updateHeadline(data);

        // Update trends
        updateTrends(data);
    }

    function updateHeadline(data) {
        const avgScoreEl = document.getElementById('headlineAvgScore');
        if (avgScoreEl) {
            avgScoreEl.textContent = formatPercent(data.avgScore);
        }

        const avgChangeEl = document.getElementById('headlineAvgChange');
        if (avgChangeEl) {
            avgChangeEl.textContent = `${formatChange(data.avgScoreChange)} vs last period`;
            avgChangeEl.classList.remove('positive', 'negative');
            if (data.avgScoreChange > 0) {
                avgChangeEl.classList.add('positive');
            } else if (data.avgScoreChange < 0) {
                avgChangeEl.classList.add('negative');
            }
        }

        const passRateEl = document.getElementById('headlinePassRate');
        if (passRateEl) {
            passRateEl.textContent = formatPercent(data.passRate);
        }

        const evalsEl = document.getElementById('headlineEvaluations');
        if (evalsEl) {
            evalsEl.textContent = formatNumber(data.totalEvaluations);
        }

        const agentsEl = document.getElementById('headlineAgents');
        if (agentsEl) {
            agentsEl.textContent = formatNumber(data.agentsEvaluated);
        }
    }

    function updateTrends(data) {
        const trends = [
            { id: 'kpiAvgScoreTrend', change: data.avgScoreChange || 0 },
            { id: 'kpiPassRateTrend', change: data.passRateChange || 0 },
            { id: 'kpiEvaluationsTrend', change: data.evaluationsChange || 0 },
            { id: 'kpiAgentsTrend', change: data.agentsChange || 0 }
        ];

        trends.forEach(trend => {
            const element = document.getElementById(trend.id);
            if (element) {
                const isPositive = trend.change >= 0;
                const icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
                const className = isPositive ? 'kpi-trend positive' : 'kpi-trend negative';
                const text = Math.abs(trend.change).toFixed(1) + '% vs last period';
                
                element.className = className;
                element.innerHTML = `<i class="fas ${icon}"></i><span>${text}</span>`;
            }
        });
    }

    function updateCharts(data) {
        const colors = campaignColors[currentCampaign];

        try {
            if (scoreGaugeChart) {
                const score = Math.max(0, Math.min(100, Number(data.avgScore) || 0));
                scoreGaugeChart.data.datasets[0].data = [score, Math.max(0, 100 - score)];
                scoreGaugeChart.data.datasets[0].backgroundColor[0] = colors.primary;
                scoreGaugeChart.update('none');

                const gaugeValue = document.getElementById('scoreGaugeValue');
                if (gaugeValue) {
                    gaugeValue.textContent = formatPercent(score);
                }
            }

            if (trendsChart) {
                const labels = data.trends.labels;
                const values = data.trends.values.map(v => Number(v) || 0);
                trendsChart.data.labels = labels;
                trendsChart.data.datasets[0].data = values;
                trendsChart.data.datasets[0].borderColor = colors.primary;
                trendsChart.data.datasets[0].backgroundColor = colors.gradient;
                trendsChart.update('none');
            }

            if (passTrendChart) {
                passTrendChart.data.labels = data.passTrend.labels;
                passTrendChart.data.datasets[0].data = data.passTrend.values.map(v => Number(v) || 0);
                passTrendChart.update('none');
            }

            if (volumeChart) {
                volumeChart.data.labels = data.volumeTrend.labels;
                volumeChart.data.datasets[0].data = data.volumeTrend.values.map(v => Number(v) || 0);
                volumeChart.data.datasets[0].backgroundColor = colors.background;
                volumeChart.data.datasets[0].borderColor = colors.primary;
                volumeChart.update('none');
            }

            if (categoryChart) {
                categoryChart.data.labels = data.categories.labels;
                categoryChart.data.datasets[0].data = data.categories.values.map(v => Number(v) || 0);
                categoryChart.data.datasets[0].backgroundColor = colors.gradient;
                categoryChart.data.datasets[0].borderColor = colors.primary;
                categoryChart.update('none');
            }

            if (distributionChart) {
                distributionChart.data.labels = data.distribution.labels;
                distributionChart.data.datasets[0].data = data.distribution.values.map(v => Number(v) || 0);
                distributionChart.data.datasets[0].backgroundColor = data.distribution.labels.map((_, idx) => getPaletteColor(idx));
                distributionChart.update('none');
            }

            if (callTypeChart) {
                callTypeChart.data.labels = data.callTypes.labels;
                const callTypeDataRaw = (data.callTypes.averages && data.callTypes.averages.length)
                    ? data.callTypes.averages
                    : data.callTypes.values;
                const callTypeData = Array.isArray(callTypeDataRaw) ? callTypeDataRaw : [];
                callTypeChart.data.datasets[0].data = callTypeData.map(v => Number(v) || 0);
                callTypeChart.data.datasets[0].backgroundColor = data.callTypes.labels.map((_, idx) => getPaletteColor(idx));
                callTypeChart.update('none');
            }

            if (comparisonChart) {
                comparisonChart.data.labels = data.agents.labels;
                comparisonChart.data.datasets[0].data = data.agents.values.map(v => Number(v) || 0);
                comparisonChart.data.datasets[0].backgroundColor = data.agents.labels.map((_, idx) => getPaletteColor(idx));
                comparisonChart.data.datasets[0].borderColor = colors.border;
                comparisonChart.update('none');
            }

            if (momentumChart) {
                momentumChart.data.labels = data.momentum.labels;
                momentumChart.data.datasets[0].data = data.momentum.values.map(v => Number(v) || 0);
                momentumChart.data.datasets[0].backgroundColor = data.momentum.values.map(v => (v >= 0 ? colors.primary : 'rgba(239, 68, 68, 0.4)'));
                momentumChart.update('none');
            }

            if (impactChart) {
                const points = data.agentImpact.map(item => ({
                    x: Number(item.evaluations) || 0,
                    y: Number(item.average) || 0,
                    r: Math.max(6, Math.min(24, (Number(item.passRate) || 0) / 4))
                }));
                impactChart.data.datasets[0].data = points;
                impactChart.data.datasets[0].backgroundColor = points.map(() => withAlpha(colors.primary, 0.25));
                impactChart.data.datasets[0].borderColor = colors.border;
                const maxEval = Math.max(10, ...points.map(p => p.x));
                impactChart.options.scales.x.max = maxEval * 1.1;
                impactChart.update('none');
            }
        } catch (error) {
            console.error('Error updating charts:', error);
            showMessage('Charts could not be updated', 'warning');
        }
    }

    function renderTopAgents(data) {
        const list = document.getElementById('topAgentsList');
        const banner = document.getElementById('topAgentsBannerList');
        if (!list || !banner) return;

        const detailedAgents = Array.isArray(data.topAgents) && data.topAgents.length
            ? data.topAgents
            : (data.agents.labels || []).slice(0, 3).map((name, idx) => ({
                agent: name,
                score: Number(data.agents.values?.[idx]) || 0,
                change: 0,
                evaluations: (data.agentImpact || []).find(item => item.agent === name)?.evaluations || 0
            }));

        const topAgents = detailedAgents.filter(agent => agent && agent.agent);

        if (!topAgents.length) {
            list.innerHTML = '<p class="empty-state">No agent data available for this period.</p>';
            banner.textContent = 'No agent insights available for the selected filters.';
            return;
        }

        list.innerHTML = topAgents.map((agent, index) => {
            const changeValue = Number(agent.change) || 0;
            const changeClass = changeValue > 0 ? 'positive' : changeValue < 0 ? 'negative' : '';
            const changeText = formatChange(changeValue);
            const evals = typeof agent.evaluations === 'number' ? `${formatNumber(agent.evaluations)} evals` : '';
            return `
                <div class="top-agent-item">
                    <div class="rank-badge">#${index + 1}</div>
                    <div class="top-agent-meta">
                        <span class="name">${agent.agent || 'Unknown'}</span>
                        <span class="score">${formatPercent(agent.score)}</span>
                        <span class="change ${changeClass}">${changeText}</span>
                        <span class="count">${evals}</span>
                    </div>
                </div>
            `;
        }).join('');

        banner.innerHTML = topAgents.map(agent => `<span class="agent-pill">${agent.agent || 'Unknown'} <strong>${formatPercent(agent.score)}</strong></span>`).join('');
    }

    function renderCategoryBreakdown(categories) {
        const container = document.getElementById('categoryBreakdown');
        if (!container) return;

        if (!categories.labels.length) {
            container.innerHTML = '<p class="empty-state">Category performance details will populate here.</p>';
            return;
        }

        container.innerHTML = categories.labels.map((label, idx) => {
            const value = Number(categories.values[idx]) || 0;
            return `
                <div class="category-row">
                    <div class="category-row-header">
                        <span>${label}</span>
                        <span>${formatPercent(value)}</span>
                    </div>
                    <div class="category-progress">
                        <div class="category-progress-bar" style="width: ${Math.max(0, Math.min(100, value))}%;"></div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderAIInsights(data) {
        const container = document.getElementById('aiInsightsList');
        if (!container) return;

        const insights = [];

        const avgChange = Number(data.avgScoreChange) || 0;
        if (avgChange !== 0) {
            insights.push(avgChange > 0
                ? `Average quality improved by ${formatChange(avgChange)}. Keep reinforcing the behaviors that are working.`
                : `Average quality dipped by ${formatChange(avgChange)}. Investigate recent coaching or process changes.`);
        }

        const passChange = Number(data.passRateChange) || 0;
        if (passChange !== 0) {
            insights.push(passChange > 0
                ? `Pass rate increased by ${formatChange(passChange)} indicating stronger compliance.`
                : `Pass rate fell by ${formatChange(passChange)}. Review common miss categories to recover.`);
        }

        const trendShift = getLatestChange(data.trends.values);
        if (trendShift !== 0) {
            insights.push(trendShift > 0
                ? `Scores rose ${formatChange(trendShift)} vs the previous period. Capture and share wins from this uplift.`
                : `Scores declined ${formatChange(trendShift)} period-over-period. Consider targeted coaching to stabilize performance.`);
        }

        if (data.momentum.labels.length) {
            const leader = {
                name: data.momentum.labels[0],
                change: Number(data.momentum.values[0]) || 0,
                baseline: Number(data.momentum.baselines?.[0]) || 0
            };
            if (leader.change !== 0) {
                insights.push(leader.change > 0
                    ? `${leader.name} gained ${formatChange(leader.change)} this period and is now averaging ${formatPercent(leader.baseline)}.`
                    : `${leader.name} slipped ${formatChange(leader.change)} and now averages ${formatPercent(leader.baseline)}. Offer fast feedback.`);
            }
        }

        if (data.categories.labels.length) {
            let weakestIdx = 0;
            data.categories.values.forEach((val, idx) => {
                if ((Number(val) || 0) < (Number(data.categories.values[weakestIdx]) || 0)) {
                    weakestIdx = idx;
                }
            });
            const weakestScore = Number(data.categories.values[weakestIdx]) || 0;
            if (weakestScore > 0) {
                insights.push(`Focus on ${data.categories.labels[weakestIdx]} (${formatPercent(weakestScore)}) to lift overall quality.`);
            }
        }

        if (data.callTypes.labels.length && data.callTypes.counts?.length) {
            let busiestIdx = 0;
            data.callTypes.counts.forEach((count, idx) => {
                if ((Number(count) || 0) > (Number(data.callTypes.counts[busiestIdx]) || 0)) {
                    busiestIdx = idx;
                }
            });
            const busiestAvg = Number(data.callTypes.values?.[busiestIdx] ?? data.callTypes.averages?.[busiestIdx]) || 0;
            insights.push(`${data.callTypes.labels[busiestIdx]} calls dominate volume at ${formatNumber(data.callTypes.counts[busiestIdx])} evaluations with an average of ${formatPercent(busiestAvg)}.`);
        }

        if (!insights.length) {
            insights.push('Load more data or adjust filters to generate AI-powered quality recommendations.');
        }

        container.innerHTML = insights.slice(0, 4).map(text => `<li><i class="fas fa-lightbulb"></i><span>${text}</span></li>`).join('');
    }

    /**
     * EXPORT endpoint for Independence Insurance
     * Returns row objects ready to csv on client
     */
    function exportIndependenceQAData(granularity, period, agentFilter, callTypeFilter) {
      try {
        const sh = SpreadsheetApp.openById(INDEPENDENCE_SHEET_ID).getSheetByName(INDEPENDENCE_QA_SHEET);
        if (!sh || sh.getLastRow() < 2) return [];

        const headers = INDEPENDENCE_QA_HEADERS;
        const data = sh.getRange(2, 1, sh.getLastRow() - 1, headers.length).getValues();

        const idx = (name) => headers.indexOf(name);
        const iAudit = idx('AuditDate');
        const iScore = idx('PercentageScore');
        const iStatus = idx('PassStatus');
        const iAgent = idx('AgentName');
        const iEmail = idx('AgentEmail');
        const iCall  = idx('CallType');
        const iId    = idx('ID');
        const iCaller= idx('CallerName');
        const iCallDate = idx('CallDate');
        const iTs    = idx('Timestamp');

        const currentPeriod = period || getPeriodKey(new Date(), granularity);

        const out = [];
        for (const row of data) {
          const d = parseDateCell(row[iAudit]) || parseDateCell(row[iTs]);
          if (!d) continue;

          const periodKey = getPeriodKey(d, granularity);
          const agent = String(row[iAgent] || '');
          const callType = String(row[iCall] || '');

          if (periodKey !== currentPeriod) continue;
          if (agentFilter && agent !== agentFilter) continue;
          if (callTypeFilter && callType !== callTypeFilter) continue;

          out.push({
            ID: row[iId],
            AuditDate: formatYMD(d),
            CallDate: String(row[iCallDate] || ''),
            AgentName: agent,
            AgentEmail: String(row[iEmail] || ''),
            CallerName: String(row[iCaller] || ''),
            CallType: callType,
            PercentageScore: toNumber(row[iScore]),
            PassStatus: String(row[iStatus] || '')
          });
        }
        return out;
      } catch (err) {
        safeWriteError('exportIndependenceQAData', err);
        return [];
      }
    }

    function exportData() {
        const functionName = currentCampaign === 'independence' 
            ? 'exportIndependenceQAData' 
            : 'exportCreditSuiteQAData';
            
        // Show loading state on export button
        const exportBtn = document.getElementById('exportBtn');
        const originalContent = exportBtn.innerHTML;
        exportBtn.innerHTML = '<div class="spinner"></div> Exporting...';
        exportBtn.disabled = true;
        
        google.script.run
            .withSuccessHandler(function(data) {
                exportBtn.innerHTML = originalContent;
                exportBtn.disabled = false;
                if (data && data.length > 0) {
                    handleExport(data);
                } else {
                    showMessage('No data available for export', 'warning');
                }
            })
            .withFailureHandler(function(error) {
                exportBtn.innerHTML = originalContent;
                exportBtn.disabled = false;
                console.error('Export error:', error);
                showMessage('Export failed. Please try again.', 'error');
            })
            [functionName](currentGranularity, getCurrentPeriod(), currentAgent, currentCallType);
    }

    function handleExport(data) {
        // Create and download CSV
        const csv = convertToCSV(data);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentCampaign}-qa-data-${getCurrentPeriod()}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function convertToCSV(data) {
        if (!data || !Array.isArray(data) || data.length === 0) return '';
        
        const headers = Object.keys(data[0]);
        const rows = data.map(row => 
            headers.map(header => {
                const value = row[header];
                return typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value;
            }).join(',')
        );
        
        return [headers.join(','), ...rows].join('\n');
    }

    function handleError(error) {
        console.error('Dashboard error:', error);
        
        // Determine error message based on error type
        let message = 'Error loading dashboard data. Please try again.';
        
        if (error && typeof error === 'string') {
            if (error.includes('not found') || error.includes('404')) {
                message = 'QA data service not found. Please contact administrator.';
            } else if (error.includes('permission') || error.includes('403')) {
                message = 'You do not have permission to access this data.';
            } else if (error.includes('timeout')) {
                message = 'Request timed out. Please try again.';
            }
        }
        
        showMessage(message, 'error');
        
        // Update dashboard with empty state to show user that something went wrong
        updateDashboard(getEmptyAnalytics());
    }

    // Initialize with current campaign
    updateCampaignIndicators();
    updateActionButtons();
</script>

</body>
</html>