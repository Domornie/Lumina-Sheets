<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base target="_top">

  <!-- jQuery (single include) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Modern CSS Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Notify.js (jQuery plugin) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.min.js"></script>

  <?
    function __layoutSlugify(value) {
      if (!value) {
        return '';
      }

      var source = String(value);
      source = source.replace(/["'`]+/g, '');

      try {
        if (source.normalize) {
          source = source.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
        }
      } catch (slugErr) {
        // Ignore normalization issues and continue with original value
      }

      return source
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/-{2,}/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(0, 80);
    }

    var __layoutPageSlugInput = (typeof pageSlug !== 'undefined' && pageSlug) ? pageSlug : '';
    var __layoutCurrentPageName = (typeof currentPage !== 'undefined' && currentPage) ? currentPage : '';
    var __layoutPageTitleText = (typeof pageTitle !== 'undefined' && pageTitle) ? pageTitle : '';
    var __layoutPageDescriptionText = (typeof pageDescription !== 'undefined' && pageDescription) ? pageDescription : '';

    var __layoutSlugCandidate = __layoutSlugify(__layoutPageSlugInput) ||
      __layoutSlugify(__layoutCurrentPageName) ||
      __layoutSlugify(__layoutPageTitleText);

    var __layoutSlugSources = [
      __layoutPageSlugInput,
      __layoutCurrentPageName,
      __layoutPageTitleText,
      __layoutSlugCandidate
    ];

    if (__layoutSlugCandidate) {
      var __layoutCollapsedSlugCandidate = __layoutSlugCandidate.replace(/-/g, '');
      if (__layoutCollapsedSlugCandidate && __layoutCollapsedSlugCandidate !== __layoutSlugCandidate) {
        __layoutSlugSources.push(__layoutCollapsedSlugCandidate);
      }
    }

    var __layoutPageDescriptionEntries = {
      'ackform': 'Send coaching acknowledgement links and capture agent sign-off confirmations.',
      'admin-dashboard': 'Reference security tools, governance policies, and documentation for LuminaHQ administrators.',
      'agent-experience': 'Personalized workspace that surfaces coaching, quality, and productivity insights for agents.',
      'attendancereports': 'Analyze attendance trends, compliance health, and time-off insights across the workforce.',
      'bookmarks': 'Organize quick-access bookmarks to critical LuminaHQ dashboards and tools.',
      'calendar': 'Visualize schedules, coverage, and operational events in a shared calendar view.',
      'callreports': 'Review call performance analytics, AI insights, and exportable call summaries.',
      'chat': 'Collaborate with teams in real-time chat rooms and announcement channels.',
      'coachingdashboard': 'Monitor coaching programs, completion metrics, and follow-up priorities.',
      'coachinglist': 'Track scheduled coaching sessions, ownership, and completion status.',
      'coachingsheet': 'Document coaching conversations, commitments, and agreed action plans.',
      'coachingview': 'Review coaching session details, notes, and acknowledgement history.',
      'collaboration-reporting': 'Unify reporting for quality, attendance, and executive workflows in one hub.',
      'creditsuiteqa': 'Evaluate Credit Suite cases with standardized QA scoring and compliance checks.',
      'dashboard': 'View OKR performance, goal progress, and campaign-level analytics.',
      'eodreport': 'Compile end-of-day summaries, escalations, and operational highlights.',
      'escalations': 'Manage customer escalations, ownership, and resolution progress.',
      'goalsetting': 'Set, track, and update operational goals with transparent accountability.',
      'groundingqaform': 'Capture grounding QA results with agent feedback and compliance scoring.',
      'home': 'Navigate primary LuminaHQ destinations and quick links.',
      'importattendance': 'Upload attendance source files to refresh LuminaHQ workforce data.',
      'import-call-report': 'Import call report CSV files to enrich analytics and dashboards.',
      'independencequality': 'Complete independence QA evaluations with policy-aligned scoring.',
      'managecampaign': 'Manage campaign records, navigation pages, and assignment permissions.',
      'manager-executive-experience': 'Executive dashboards for cross-campaign coaching, quality, and outcomes.',
      'manageroles': 'Administer roles, permissions, and access policies across LuminaHQ.',
      'manageuser': 'Manage LuminaHQ users, profile access, and client assignments.',
      'notifications': 'Configure and review LuminaHQ notification settings and alerts.',
      'privacy-policy': 'Review how LuminaHQ protects workforce and client data.',
      'qacollablist': 'Monitor collaborative QA submissions and workflow statuses.',
      'qacollabview': 'Review collaborative QA details, commentary, and resolution steps.',
      'qadashboard': 'Track quality assurance KPIs, agent performance, and review cadence.',
      'qalist': 'Browse quality evaluations with filters, tags, and analyst insights.',
      'qualitycollabform': 'Launch collaborative QA evaluations with shared reviewer inputs.',
      'qualityform': 'Submit new quality assessments with rubric-driven scoring.',
      'qualityview': 'Inspect detailed QA evaluation results, scoring, and trend history.',
      'schedulemanagement': 'Coordinate schedules, shift swaps, and staffing coverage in LuminaHQ.',
      'search': 'Search Lumina knowledge, dashboards, and operational resources.',
      'shift-slot-management': 'Manage shift slots, staffing requests, and capacity planning.',
      'taskboard': 'Plan and track operational work across kanban-style boards.',
      'taskform': 'Create or edit LuminaHQ tasks with assignments and due dates.',
      'tasklist': 'Review prioritized task lists and workflow statuses.',
      'terms-of-service': 'Understand LuminaHQ platform terms and user responsibilities.',
      'unifiedqadashboard': 'Blend QA insights across programs with unified analytics.',
      'user-profile': 'Review and update your LuminaHQ profile, roles, and equipment.'
    };

    var __layoutPageDescriptionLookup = {};
    for (var __layoutDescriptionKey in __layoutPageDescriptionEntries) {
      if (!Object.prototype.hasOwnProperty.call(__layoutPageDescriptionEntries, __layoutDescriptionKey)) {
        continue;
      }

      var __layoutDescriptionValue = __layoutPageDescriptionEntries[__layoutDescriptionKey];
      if (!__layoutDescriptionValue) {
        continue;
      }

      __layoutPageDescriptionLookup[__layoutDescriptionKey] = __layoutDescriptionValue;

      var __layoutCollapsedKey = __layoutDescriptionKey.replace(/-/g, '');
      if (
        __layoutCollapsedKey &&
        __layoutCollapsedKey !== __layoutDescriptionKey &&
        !Object.prototype.hasOwnProperty.call(__layoutPageDescriptionEntries, __layoutCollapsedKey) &&
        !Object.prototype.hasOwnProperty.call(__layoutPageDescriptionLookup, __layoutCollapsedKey)
      ) {
        __layoutPageDescriptionLookup[__layoutCollapsedKey] = __layoutDescriptionValue;
      }
    }

    var __layoutPageDescriptionSource = '';
    var __layoutResolvedDescriptionSlug = '';
    var __layoutResolvedSlugCandidates = [];
    var __layoutFallbackDescription = 'LuminaHQ operations workspace overview.';

    function __layoutResolvePageDescription() {
      if (__layoutPageDescriptionText) {
        __layoutPageDescriptionSource = 'inline';
        return __layoutPageDescriptionText;
      }

      for (var i = 0; i < __layoutSlugSources.length; i++) {
        var candidateSlug = __layoutSlugify(__layoutSlugSources[i]);
        if (!candidateSlug) {
          continue;
        }

        __layoutResolvedSlugCandidates.push(candidateSlug);

        if (Object.prototype.hasOwnProperty.call(__layoutPageDescriptionLookup, candidateSlug)) {
          __layoutResolvedDescriptionSlug = candidateSlug;
          __layoutPageDescriptionSource = 'lookup';
          return __layoutPageDescriptionLookup[candidateSlug];
        }
      }

      __layoutPageDescriptionSource = 'fallback';

      if (typeof console !== 'undefined' && console && typeof console.warn === 'function') {
        try {
          console.warn(
            'Lumina banner description fallback in use for page candidates:',
            __layoutResolvedSlugCandidates
          );
        } catch (loggingError) {
          // Swallow logging issues to avoid breaking rendering.
        }
      }

      return __layoutFallbackDescription;
    }

    __layoutPageDescriptionText = __layoutResolvePageDescription();
    if ((typeof pageDescription === 'undefined' || !pageDescription) && __layoutPageDescriptionText) {
      pageDescription = __layoutPageDescriptionText;
    }

    var __layoutRawReturnUrl = (typeof returnUrl !== 'undefined' && returnUrl) ? returnUrl : '';

    var __layoutInvalidPanelPattern = /usercodeapppanel/i;

    function __layoutNormalizeUrlValue(value) {
      if (value === null || typeof value === 'undefined') {
        return '';
      }

      var trimmed = String(value).trim();
      if (!trimmed || trimmed.toLowerCase() === 'undefined') {
        return '';
      }

      // Strip any accidental HTML tags or encoded fragments to avoid
      // injecting markup into navigation URLs.
      var withoutTags = trimmed.replace(/<[^>]*>/g, '').trim();
      if (!withoutTags) {
        return '';
      }

      // Some malformed payloads append additional tokens after the URL –
      // keep only the first whitespace-delimited segment to avoid
      // propagating the corruption.
      var firstToken = withoutTags.split(/\s+/)[0];
      return firstToken;
    }

    function __layoutIsValidNavigationUrl(url) {
      if (!url) {
        return false;
      }

      // Accept https/http script endpoints only.
      return /^https?:\/\/[A-Za-z0-9._~:/?#\[\]@!$&'()*+,;=-]+$/.test(url);
    }

    function __layoutFixPanelUrl(value) {
      var normalized = __layoutNormalizeUrlValue(value);
      if (!normalized) {
        return '';
      }

      if (!__layoutInvalidPanelPattern.test(normalized)) {
        return normalized;
      }

      return normalized.replace(/\/userCodeAppPanel.*$/i, '/exec');
    }

    function __layoutSanitizeNavigationUrl(url, fallback) {
      var primary = __layoutFixPanelUrl(url);
      if (__layoutIsValidNavigationUrl(primary)) {
        return primary;
      }

      var alt = __layoutFixPanelUrl(fallback);
      if (__layoutIsValidNavigationUrl(alt)) {
        return alt;
      }

      return '';
    }

    var __layoutRawBaseUrl = (typeof baseUrl !== 'undefined') ? baseUrl : '';
    var __layoutRawScriptUrl = (typeof scriptUrl !== 'undefined') ? scriptUrl : __layoutRawBaseUrl;

    var __layoutSanitizedBaseUrl = __layoutSanitizeNavigationUrl(__layoutRawBaseUrl, __layoutRawScriptUrl);
    var __layoutSanitizedScriptUrl = __layoutSanitizeNavigationUrl(__layoutRawScriptUrl, __layoutRawBaseUrl);

    baseUrl = __layoutSanitizedBaseUrl || __layoutSanitizedScriptUrl || baseUrl;

    if (typeof scriptUrl !== 'undefined') {
      scriptUrl = __layoutSanitizedScriptUrl || __layoutSanitizedBaseUrl || scriptUrl;
    }
  ?>

  <?!= includeOnce('CookieHandler') ?>
  <?!= includeOnce('layoutAlerts') ?>
  <?!= includeOnce('ResponsiveStyles') ?>

  <script>
    if (typeof window !== 'undefined') {
      window.__LUMINA_PAGE_SLUG = <?!= JSON.stringify(__layoutSlugCandidate || '') ?>;
      window.__LUMINA_PAGE_DESCRIPTION = <?!= JSON.stringify(__layoutPageDescriptionText || '') ?>;
      window.__LUMINA_PAGE_DESCRIPTION_SOURCE = <?!= JSON.stringify(__layoutPageDescriptionSource || '') ?>;
      window.__LUMINA_PAGE_DESCRIPTION_LOOKUP = <?!= JSON.stringify(__layoutPageDescriptionLookup) ?>;
      window.__LUMINA_PAGE_DESCRIPTION_DEBUG = <?!= JSON.stringify({
        candidates: __layoutResolvedSlugCandidates,
        resolvedSlug: __layoutResolvedDescriptionSlug,
        fallbackDescription: __layoutFallbackDescription
      }) ?>;
    }

    (function initializeLuminaTheme() {
      const STORAGE_KEY = 'lumina-theme';
      const docEl = document.documentElement;

      const readStoredTheme = () => {
        try {
          return window.localStorage.getItem(STORAGE_KEY);
        } catch (err) {
          console.warn('Lumina theme: unable to read stored theme', err);
          return null;
        }
      };

      const writeStoredTheme = (theme) => {
        try {
          window.localStorage.setItem(STORAGE_KEY, theme);
        } catch (err) {
          console.warn('Lumina theme: unable to persist theme', err);
        }
      };

      const applyTheme = (theme) => {
        const next = theme === 'dark' ? 'dark' : 'light';
        docEl.setAttribute('data-theme', next);
        if (document.body) {
          document.body.setAttribute('data-theme', next);
        }
        return next;
      };

      const ensureBodySync = () => {
        if (document.body) {
          document.body.setAttribute('data-theme', docEl.getAttribute('data-theme') || 'light');
        }
      };

      const stored = readStoredTheme();
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initial = stored || (prefersDark ? 'dark' : 'light');
      applyTheme(initial);

      if (document.readyState !== 'loading') {
        ensureBodySync();
      } else {
        document.addEventListener('DOMContentLoaded', ensureBodySync, { once: true });
      }

      const notify = (theme, meta) => {
        try {
          const detail = Object.assign({ theme }, meta || {});
          window.dispatchEvent(new CustomEvent('lumina:theme-changed', { detail }));
        } catch (err) {
          console.warn('Lumina theme: unable to dispatch theme change', err);
        }
      };

      const setTheme = (theme, meta) => {
        const options = Object.assign({}, meta || {});
        const next = applyTheme(theme);
        if (options.persist === false) {
          // Respect caller request to skip persistence (used for system preference follow).
        } else {
          writeStoredTheme(next);
        }
        notify(next, options);
        return next;
      };

      const themeApi = {
        get() {
          return docEl.getAttribute('data-theme') || 'light';
        },
        set(theme, meta) {
          const options = Object.assign({ source: 'manual' }, meta || {});
          return setTheme(theme, options);
        },
        toggle() {
          const current = themeApi.get();
          const next = current === 'dark' ? 'light' : 'dark';
          return setTheme(next, { source: 'toggle' });
        },
        apply: applyTheme
      };

      window.__luminaTheme = themeApi;

      const mediaQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
      if (mediaQuery && typeof mediaQuery.addEventListener === 'function') {
        mediaQuery.addEventListener('change', (event) => {
          if (readStoredTheme()) {
            return;
          }
          setTheme(event.matches ? 'dark' : 'light', { source: 'system', persist: false });
        });
      }

      const updateToggleButtons = () => {
        const isDark = themeApi.get() === 'dark';
        const title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
        const state = isDark ? 'dark' : 'light';
        document.querySelectorAll('[data-action="toggle-theme"]').forEach((button) => {
          button.setAttribute('aria-pressed', String(isDark));
          button.setAttribute('title', title);
          button.setAttribute('aria-label', title);
          button.setAttribute('data-theme-state', state);
          button.setAttribute('data-bs-original-title', title);
          const icon = button.querySelector('i');
          if (icon) {
            icon.classList.toggle('fa-moon', !isDark);
            icon.classList.toggle('fa-sun', isDark);
          }
          if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
            const tooltip = bootstrap.Tooltip.getInstance(button);
            if (tooltip && typeof tooltip.setContent === 'function') {
              tooltip.setContent({ '.tooltip-inner': title });
            }
          }
        });
      };

      document.addEventListener('DOMContentLoaded', () => {
        updateToggleButtons();
        document.querySelectorAll('[data-action="toggle-theme"]').forEach((button) => {
          button.addEventListener('click', (event) => {
            event.preventDefault();
            themeApi.toggle();
          });
        });
      });

      window.addEventListener('lumina:theme-changed', updateToggleButtons);
    })();
  </script>

  <script>
    // Base URLs for navigation
    let BASE_URL = '<?= baseUrl ?>';
    let SCRIPT_URL = '<?= scriptUrl || baseUrl ?>';

    const __PAGE_SLUG_SOURCES = <?!= JSON.stringify(__layoutSlugSources) ?>;
    const __RAW_RETURN_URL = <?!= JSON.stringify(__layoutRawReturnUrl) ?>;
    const __LAYOUT_CAMPAIGN_ID = <?!= JSON.stringify(__layoutCampaignId || '') ?>;
    const __LAYOUT_CAMPAIGN_NAME = <?!= JSON.stringify(__layoutCampaignName || '') ?>;
    const __LAYOUT_CLIENT_NAME = <?!= JSON.stringify(__layoutClientName || '') ?>;

    if (typeof window !== 'undefined') {
      window.__LAYOUT_CAMPAIGN_ID = __LAYOUT_CAMPAIGN_ID;
      window.__LAYOUT_CAMPAIGN_NAME = __LAYOUT_CAMPAIGN_NAME;
    }

    if (typeof document !== 'undefined' && document.documentElement) {
      const root = document.documentElement;
      if (__LAYOUT_CAMPAIGN_ID) {
        root.setAttribute('data-campaign-id', __LAYOUT_CAMPAIGN_ID);
      } else {
        root.removeAttribute('data-campaign-id');
      }

      if (__LAYOUT_CAMPAIGN_NAME) {
        root.setAttribute('data-campaign-name', __LAYOUT_CAMPAIGN_NAME);
      } else {
        root.removeAttribute('data-campaign-name');
      }

      const applyBodyCampaignAttributes = () => {
        if (!document.body) {
          return;
        }

        if (__LAYOUT_CAMPAIGN_ID) {
          document.body.setAttribute('data-campaign-id', __LAYOUT_CAMPAIGN_ID);
        } else {
          document.body.removeAttribute('data-campaign-id');
        }

        if (__LAYOUT_CAMPAIGN_NAME) {
          document.body.setAttribute('data-campaign-name', __LAYOUT_CAMPAIGN_NAME);
        } else {
          document.body.removeAttribute('data-campaign-name');
        }
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyBodyCampaignAttributes, { once: true });
      } else {
        applyBodyCampaignAttributes();
      }
    }

    const __invalidPanelPattern = /usercodeapppanel/i;

    function sanitizeNavigationUrl(url, fallback) {
      const normalize = value => {
        if (value === null || typeof value === 'undefined') return '';
        const trimmed = String(value).trim();
        if (!trimmed || trimmed.toLowerCase() === 'undefined') return '';
        return trimmed;
      };

      const fixPanel = value => {
        if (!value) return '';
        if (!__invalidPanelPattern.test(value)) {
          return value;
        }
        return value.replace(/\/userCodeAppPanel.*$/i, '/exec');
      };

      const primary = fixPanel(normalize(url));
      if (primary) {
        return primary;
      }

      return fixPanel(normalize(fallback));
    }

    const __BASE_URL = sanitizeNavigationUrl(BASE_URL, SCRIPT_URL);
    const __SCRIPT_URL = sanitizeNavigationUrl(SCRIPT_URL, BASE_URL);

    BASE_URL = __BASE_URL || __SCRIPT_URL || BASE_URL;
    SCRIPT_URL = __SCRIPT_URL || __BASE_URL || SCRIPT_URL;

    function __appendLoginQuery(candidate) {
      if (!candidate) {
        return '';
      }

      try {
        const url = new URL(candidate);
        url.searchParams.set('page', 'login');
        url.hash = '';
        return url.toString();
      } catch (err) {
        const sanitized = String(candidate).replace(/#.*$/, '');
        if (!sanitized) {
          return '';
        }
        if (/[?&]page=/i.test(sanitized)) {
          return sanitized.replace(/([?&]page=)([^&]*)/i, '$1login');
        }
        const separator = sanitized.indexOf('?') === -1 ? '?' : '&';
        return sanitized + separator + 'page=login';
      }
    }

    const LOGIN_URL = (function computeLoginUrl() {
      const candidates = [];
      if (typeof __RAW_RETURN_URL !== 'undefined' && __RAW_RETURN_URL) {
        candidates.push(__RAW_RETURN_URL);
      }
      if (__BASE_URL) {
        candidates.push(__BASE_URL);
      }
      if (__SCRIPT_URL && __SCRIPT_URL !== __BASE_URL) {
        candidates.push(__SCRIPT_URL);
      }
      try {
        if (window && window.location && window.location.href) {
          candidates.push(window.location.href);
        }
      } catch (err) {
        console.warn('Unable to derive login URL from location', err);
      }

      for (let i = 0; i < candidates.length; i += 1) {
        const candidate = candidates[i];
        if (!candidate) {
          continue;
        }
        const sanitized = sanitizeNavigationUrl(candidate, '') || candidate;
        const loginCandidate = __appendLoginQuery(sanitized);
        if (loginCandidate) {
          return loginCandidate;
        }
      }

      return __appendLoginQuery(__SCRIPT_URL || __BASE_URL || '');
    })();

    window.__LUMINA_LOGIN_URL = LOGIN_URL;

    function createSlug(value, fallback) {
      const queue = [];

      const enqueue = (input) => {
        if (typeof input === 'undefined' || input === null) {
          return;
        }

        if (Array.isArray(input)) {
          input.forEach(enqueue);
          return;
        }

        queue.push(String(input));
      };

      enqueue(value);
      enqueue(fallback);

      while (queue.length) {
        let candidate = queue.shift().trim();
        if (!candidate) {
          continue;
        }

        try {
          if (candidate.normalize) {
            candidate = candidate.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
          }
        } catch (err) {
          console.warn('Slug normalization failed:', err);
        }

        const slug = candidate
          .replace(/["'`]+/g, '')
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/-{2,}/g, '-')
          .replace(/^-+|-+$/g, '')
          .slice(0, 80);

        if (slug) {
          return slug;
        }
      }

      return '';
    }

    const PAGE_SLUG = createSlug(__PAGE_SLUG_SOURCES);

    function stripUrlToNavigationBase(candidate) {
      if (!candidate) {
        return '';
      }

      try {
        const base = (typeof window !== 'undefined' && window.location && window.location.href)
          ? window.location.href
          : undefined;
        const parsed = new URL(candidate, base);
        parsed.search = '';
        parsed.hash = '';
        return parsed.toString();
      } catch (err) {
        const sanitized = String(candidate).replace(/[?#].*$/, '').trim();
        if (sanitized) {
          return sanitized;
        }
      }

      return '';
    }

    const NAVIGATION_BASE_URL = (function deriveNavigationBase() {
      const primary = stripUrlToNavigationBase(BASE_URL || SCRIPT_URL);
      if (primary) {
        return primary;
      }

      if (BASE_URL) {
        return BASE_URL;
      }

      if (SCRIPT_URL) {
        return SCRIPT_URL;
      }

      return '';
    })();

    // Session token persistence helpers
    const LOGOUT_REASON_STORAGE_KEY = 'lumina.lastLogoutReason';
    var SESSION_TOKEN_QUERY_PARAM = (typeof SESSION_TOKEN_QUERY_PARAM === 'string'
      && SESSION_TOKEN_QUERY_PARAM.trim())
      ? SESSION_TOKEN_QUERY_PARAM.trim()
      : 'token';
    var SESSION_TOKEN_STORAGE_KEYS = (typeof SESSION_TOKEN_STORAGE_KEYS !== 'undefined'
      && Array.isArray(SESSION_TOKEN_STORAGE_KEYS)
      && SESSION_TOKEN_STORAGE_KEYS.length)
      ? SESSION_TOKEN_STORAGE_KEYS.slice()
      : [
        'lumina.session.token',
        'lumina.auth.sessionToken',
        'lumina.auth.fallbackToken'
      ];

    if (typeof window !== 'undefined') {
      if (Array.isArray(window.SESSION_TOKEN_STORAGE_KEYS) && window.SESSION_TOKEN_STORAGE_KEYS.length) {
        SESSION_TOKEN_STORAGE_KEYS = window.SESSION_TOKEN_STORAGE_KEYS.slice();
      } else {
        window.SESSION_TOKEN_STORAGE_KEYS = SESSION_TOKEN_STORAGE_KEYS.slice();
      }

      if (typeof window.SESSION_TOKEN_QUERY_PARAM === 'string' && window.SESSION_TOKEN_QUERY_PARAM.trim()) {
        SESSION_TOKEN_QUERY_PARAM = window.SESSION_TOKEN_QUERY_PARAM.trim();
      } else {
        window.SESSION_TOKEN_QUERY_PARAM = SESSION_TOKEN_QUERY_PARAM;
      }
    }

    function persistClientSessionToken(token, options = {}) {
      const normalizedToken = typeof token === 'string' ? token.trim() : '';
      if (!normalizedToken) {
        return '';
      }

      try {
        if (typeof window !== 'undefined') {
          window.__LUMINA_SESSION_TOKEN__ = normalizedToken;
        }
      } catch (assignError) {
        console.warn('persistClientSessionToken: unable to assign global token reference', assignError);
      }

      try {
        if (typeof window !== 'undefined'
          && window.CookieHandler
          && typeof window.CookieHandler.persistAuthToken === 'function') {
          window.CookieHandler.persistAuthToken(normalizedToken, options);
        }
      } catch (cookieError) {
        console.warn('persistClientSessionToken: unable to persist auth cookie', cookieError);
      }

      const storageKeys = Array.isArray(SESSION_TOKEN_STORAGE_KEYS) ? SESSION_TOKEN_STORAGE_KEYS : [];

      storageKeys.forEach(key => {
        try {
          if (typeof window !== 'undefined' && window.localStorage) {
            window.localStorage.setItem(key, normalizedToken);
          }
        } catch (localError) {
          console.warn('persistClientSessionToken: unable to persist token in localStorage', { key, error: localError });
        }

        try {
          if (typeof window !== 'undefined' && window.sessionStorage) {
            window.sessionStorage.setItem(key, normalizedToken);
          }
        } catch (sessionError) {
          console.warn('persistClientSessionToken: unable to persist token in sessionStorage', { key, error: sessionError });
        }
      });

      try {
        broadcastSessionTokenChange(normalizedToken);
      } catch (broadcastError) {
        console.warn('persistClientSessionToken: unable to broadcast token update', broadcastError);
      }

      return normalizedToken;
    }

    function captureSessionTokenFromUrl() {
      if (typeof window === 'undefined' || !window.location) {
        return '';
      }

      try {
        const currentUrl = new URL(window.location.href);
        const tokenFromQuery = (currentUrl.searchParams.get(SESSION_TOKEN_QUERY_PARAM) || '').trim();

        if (!tokenFromQuery) {
          return '';
        }

        const persistedToken = persistClientSessionToken(tokenFromQuery);

        const params = new URLSearchParams(currentUrl.search);
        params.delete(SESSION_TOKEN_QUERY_PARAM);
        ['sessionTtlSeconds', 'sessionExpiresAt', 'idleTimeoutMinutes', 'rememberMe'].forEach(param => {
          if (params.has(param)) {
            params.delete(param);
          }
        });

        const sanitizedSearch = params.toString();
        const cleanedUrl = `${currentUrl.pathname}${sanitizedSearch ? `?${sanitizedSearch}` : ''}${currentUrl.hash || ''}`;

        if (window.history && typeof window.history.replaceState === 'function') {
          window.history.replaceState({}, document.title, cleanedUrl);
        }

        console.log('🔐 Session token persisted from URL parameter');

        return persistedToken;
      } catch (err) {
        console.warn('captureSessionTokenFromUrl: unable to process session token from URL', err);
        return '';
      }
    }

    const INITIAL_URL_SESSION_TOKEN = captureSessionTokenFromUrl();

    function setLogoutReason(reason) {
      try {
        if (!window.sessionStorage) {
          return;
        }
        if (!reason) {
          window.sessionStorage.removeItem(LOGOUT_REASON_STORAGE_KEY);
        } else {
          window.sessionStorage.setItem(LOGOUT_REASON_STORAGE_KEY, String(reason));
        }
      } catch (err) {
        console.warn('setLogoutReason: unable to persist logout reason', err);
      }
    }

    function getLogoutReason() {
      try {
        if (window.sessionStorage) {
          return window.sessionStorage.getItem(LOGOUT_REASON_STORAGE_KEY) || '';
        }
      } catch (err) {
        console.warn('getLogoutReason: unable to read logout reason', err);
      }
      return '';
    }

    function clearLogoutReason() {
      setLogoutReason('');
    }

    /**
     * Generate URLs for navigation
     */
    function resolveNavigationBaseUrl() {
      const directBase = NAVIGATION_BASE_URL || BASE_URL || SCRIPT_URL;
      if (directBase) {
        return directBase;
      }

      if (typeof window !== 'undefined' && window.location) {
        try {
          const { origin, pathname, href } = window.location;
          if (origin && pathname) {
            return origin + pathname;
          }
          if (href) {
            const parsed = new URL(href);
            parsed.search = '';
            parsed.hash = '';
            return parsed.toString();
          }
        } catch (resolveErr) {
          console.warn('Unable to derive navigation base URL from window.location', resolveErr);
        }
      }

      return '';
    }

    function generateUrl(page, _campaign = null, additionalParams = {}) {
      // _campaign is kept for backward compatibility but intentionally unused to avoid exposing it in URLs
      let url = resolveNavigationBaseUrl();
      const params = new URLSearchParams();

      if (page) {
        params.set('page', page);
      }

      // Add any additional parameters
      Object.entries(additionalParams).forEach(([key, value]) => {
        if (value !== null && value !== undefined) {
          params.set(key, value);
        }
      });
      
      const queryString = params.toString();

      if (!url) {
        const relativeUrl = queryString ? `?${queryString}` : '';
        return appendSessionTokenToUrl(relativeUrl);
      }

      const separator = url.includes('?') ? (/[?&]$/.test(url) ? '' : '&') : '?';
      const builtUrl = queryString ? `${url}${separator}${queryString}` : url;
      return appendSessionTokenToUrl(builtUrl);
    }

    /**
     * Navigate to a page
     */
    function navigateToPage(page, _campaign = null, additionalParams = {}) {
      const url = generateUrl(page, _campaign, additionalParams);
      window.location.href = url;
    }

    function deriveReturnUrl(rawUrl, slug) {
      const sanitizedRaw = sanitizeNavigationUrl(rawUrl, '');
      if (sanitizedRaw) {
        return sanitizedRaw;
      }

      if (slug) {
        return generateUrl(slug);
      }

      return BASE_URL || SCRIPT_URL || '';
    }

    const RETURN_URL = deriveReturnUrl(__RAW_RETURN_URL, PAGE_SLUG);

    function buildReturnUrl(extraParams = {}, rawUrl = RETURN_URL) {
      const base = deriveReturnUrl(rawUrl, PAGE_SLUG);
      if (!extraParams || typeof extraParams !== 'object' || Array.isArray(extraParams)) {
        return base;
      }

      try {
        const url = new URL(base, window.location.origin);
        const params = new URLSearchParams(url.search);

        Object.entries(extraParams).forEach(([key, value]) => {
          if (value === null || typeof value === 'undefined') {
            params.delete(key);
            return;
          }

          params.set(key, value);
        });

        url.search = params.toString();
        return url.toString();
      } catch (err) {
        console.warn('Failed to build return URL, falling back to base value:', err);
        return base;
      }
    }

    const __applySlugMetadata = () => {
      if (typeof document === 'undefined' || !document.body) {
        return;
      }

      try {
        document.body.dataset.pageSlug = PAGE_SLUG || '';
        if (RETURN_URL) {
          document.body.dataset.returnUrl = RETURN_URL;
        } else {
          delete document.body.dataset.returnUrl;
        }
      } catch (err) {
        console.warn('Unable to apply slug/return data attributes:', err);
      }
    };

    if (typeof document !== 'undefined') {
      const handleDomReady = () => {
        __applySlugMetadata();
        applySessionTokenToLinks();
      };

      if (document.body) {
        handleDomReady();
      } else {
        try {
          document.addEventListener('DOMContentLoaded', handleDomReady, { once: true });
        } catch (err) {
          document.addEventListener('DOMContentLoaded', handleDomReady, false);
        }
      }
    }

    if (typeof window !== 'undefined' && typeof window.addEventListener === 'function') {
      window.addEventListener('lumina:session-token', function(event) {
        const detailToken = event && event.detail ? event.detail.token : '';
        applySessionTokenToLinks(detailToken);
      });
    }

    // Make utilities available globally
    window.generateUrl = generateUrl;
    window.navigateToPage = navigateToPage;
    window.createSlug = createSlug;
    window.pageSlug = PAGE_SLUG;
    window.returnUrl = RETURN_URL;
    window.deriveReturnUrl = (rawUrl, slug = PAGE_SLUG) => deriveReturnUrl(rawUrl, slug);
    window.buildReturnUrl = buildReturnUrl;
    window.getReturnUrl = buildReturnUrl;

    function resolveClientSessionToken(providedToken) {
      const normalizedProvided = typeof providedToken === 'string' ? providedToken.trim() : '';
      if (normalizedProvided) {
        return normalizedProvided;
      }

      try {
        if (typeof window !== 'undefined' && window.__LUMINA_SESSION_TOKEN__) {
          const globalToken = String(window.__LUMINA_SESSION_TOKEN__).trim();
          if (globalToken) {
            return globalToken;
          }
        }
      } catch (_) {
        // Ignore global token resolution errors
      }

      try {
        if (typeof window !== 'undefined'
          && window.CookieHandler
          && typeof window.CookieHandler.readAuthToken === 'function') {
          const cookieToken = window.CookieHandler.readAuthToken();
          if (cookieToken) {
            return cookieToken;
          }
        }
      } catch (_) {
        // Ignore cookie resolution errors
      }

      const storageKeys = Array.isArray(SESSION_TOKEN_STORAGE_KEYS) ? SESSION_TOKEN_STORAGE_KEYS : [];

      for (let i = 0; i < storageKeys.length; i += 1) {
        try {
          if (typeof window !== 'undefined' && window.localStorage) {
            const value = window.localStorage.getItem(storageKeys[i]);
            if (value) {
              return value;
            }
          }
        } catch (_) {
          // Ignore localStorage errors
        }
      }

      for (let i = 0; i < storageKeys.length; i += 1) {
        try {
          if (typeof window !== 'undefined' && window.sessionStorage) {
            const value = window.sessionStorage.getItem(storageKeys[i]);
            if (value) {
              return value;
            }
          }
        } catch (_) {
          // Ignore sessionStorage errors
        }
      }

      return '';
    }

    function broadcastSessionTokenChange(token) {
      try {
        if (typeof window === 'undefined') {
          return;
        }

        window.__LUMINA_SESSION_TOKEN__ = token || '';

        if (typeof window.dispatchEvent !== 'function') {
          return;
        }

        const detail = { token: token || '' };
        let event = null;

        if (typeof CustomEvent === 'function') {
          event = new CustomEvent('lumina:session-token', { detail });
        } else if (window.document && typeof window.document.createEvent === 'function') {
          event = window.document.createEvent('CustomEvent');
          event.initCustomEvent('lumina:session-token', false, false, detail);
        }

        if (event) {
          window.dispatchEvent(event);
        }
      } catch (err) {
        console.warn('broadcastSessionTokenChange: unable to notify listeners', err);
      }
    }

    function appendSessionTokenToUrl(url, providedToken, options = {}) {
      if (!url) {
        return url;
      }

      const raw = String(url).trim();
      if (!raw || raw.startsWith('#') || /^(mailto:|tel:|javascript:)/i.test(raw)) {
        return url;
      }

      const token = resolveClientSessionToken(providedToken);
      if (!token) {
        return url;
      }

      try {
        const base = (typeof window !== 'undefined' && window.location) ? window.location.href : undefined;
        const parsed = new URL(raw, base);

        if (options.sameOriginOnly !== false) {
          const currentOrigin = (typeof window !== 'undefined' && window.location) ? window.location.origin : '';
          if (currentOrigin && parsed.origin && parsed.origin !== currentOrigin) {
            return url;
          }
        }

        if (parsed.searchParams.get(SESSION_TOKEN_QUERY_PARAM) !== token) {
          parsed.searchParams.set(SESSION_TOKEN_QUERY_PARAM, token);
        }

        if (raw.startsWith('?')) {
          return (parsed.search || '') + (parsed.hash || '');
        }

        if (!/^[a-z][a-z0-9+.-]*:/i.test(raw) && !raw.startsWith('//')) {
          return parsed.pathname + (parsed.search || '') + (parsed.hash || '');
        }

        return parsed.toString();
      } catch (error) {
        console.warn('appendSessionTokenToUrl: unable to append token', { url, error });
        return url;
      }
    }

    function applySessionTokenToLinks(explicitToken) {
      if (typeof document === 'undefined') {
        return;
      }

      const token = resolveClientSessionToken(explicitToken);
      if (!token) {
        return;
      }

      const anchors = document.querySelectorAll('a[href]');
      anchors.forEach(anchor => {
        const href = anchor.getAttribute('href');
        if (!href) {
          return;
        }

        const updated = appendSessionTokenToUrl(href, token, { sameOriginOnly: true });
        if (updated && updated !== href) {
          anchor.setAttribute('href', updated);
        }
      });
    }

    function buildLoginUrl(options = {}) {
      const baseTarget = window.__LUMINA_LOGIN_URL || LOGIN_URL || BASE_URL || SCRIPT_URL || '/';
      const includeReturn = options.includeReturn === true;
      const reason = (options.reason && String(options.reason)) || getLogoutReason();

      if (!includeReturn || (reason && reason.toLowerCase() === 'manual')) {
        return baseTarget;
      }

      let candidate = options.returnUrl || '';
      if (!candidate && typeof window !== 'undefined' && window.location && window.location.href) {
        candidate = window.location.href;
      }
      if (!candidate && RETURN_URL) {
        candidate = RETURN_URL;
      }

      let sanitized = '';
      try {
        sanitized = buildReturnUrl({}, candidate);
      } catch (err) {
        console.warn('buildLoginUrl: unable to build return URL', err);
      }

      if (!sanitized || /page=login/i.test(sanitized)) {
        sanitized = '';
      }

      if (!sanitized) {
        return baseTarget;
      }

      try {
        const loginUrl = new URL(baseTarget, window.location && window.location.href ? window.location.href : undefined);
        loginUrl.searchParams.set('page', 'login');
        loginUrl.searchParams.set('returnUrl', sanitized);
        loginUrl.hash = '';
        return loginUrl.toString();
      } catch (err) {
        console.warn('buildLoginUrl: falling back to manual concatenation', err);
        const separator = baseTarget.indexOf('?') === -1
          ? '?'
          : (/[?&]$/.test(baseTarget) ? '' : '&');
        return `${baseTarget}${separator}returnUrl=${encodeURIComponent(sanitized)}`;
      }
    }

    window.buildLoginUrl = buildLoginUrl;
    window.setLogoutReason = setLogoutReason;
    window.getLogoutReason = getLogoutReason;
    window.clearLogoutReason = clearLogoutReason;
  </script>

  <style>
    :root {
      /* Enhanced Modern Color Palette */
      --sidebar-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      --sidebar-text: #f8fafc;
      --sidebar-text-muted: #cbd5e1;
      --sidebar-hover: rgba(255, 255, 255, 0.1);
      --sidebar-active: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      --primary: #0ea5e9;
      --primary-dark: #0284c7;
      --primary-light: #38bdf8;
      --accent: #22d3ee;
      --warning: #f59e0b;
      --danger: #ef4444;
      --success: #10b981;
      --info: #3b82f6;
      --light: #f8fafc;
      --dark: #0f172a;
      --surface: #ffffff;
      --surface-variant: #f1f5f9;
      --outline: #e2e8f0;
      --shadow: rgba(15, 23, 42, 0.1);
      --shadow-hover: rgba(15, 23, 42, 0.2);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --body-background: linear-gradient(135deg, var(--surface-variant) 0%, #ffffff 100%);
      --body-text-color: #1e293b;
      --topbar-bg: rgba(255, 255, 255, 0.95);
      --topbar-border: var(--outline);
      --topbar-icon-color: #64748b;
      --topbar-icon-bg: rgba(248, 250, 252, 0.8);
      --topbar-icon-border: rgba(226, 232, 240, 0.5);
      --topbar-icon-hover-bg: rgba(14, 165, 233, 0.1);
      --topbar-icon-hover-color: var(--primary);
      --topbar-icon-hover-border: rgba(14, 165, 233, 0.3);
      --topbar-text-muted: #64748b;
      --topbar-text-strong: #1e293b;

      --z-dropdown: 1000;
      --z-sticky: 1020;
      --z-fixed: 1030;
      --z-modal-backdrop: 1040;
      --z-modal: 1050;
      --z-popover: 1060;
      --z-tooltip: 1070;
      --z-toast: 9999;

      --bs-backdrop-zindex: var(--z-modal-backdrop);
      --bs-modal-zindex: var(--z-modal);

      --sidebar-width: 320px;
      --sidebar-collapsed: 80px;
      --topbar-height: 72px;
      --border-radius: 20px;
      --border-radius-sm: 12px;
      --border-radius-xs: 8px;
      --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }

    :root[data-theme="dark"] {
      --surface: #111827;
      --surface-variant: #0b1120;
      --outline: rgba(148, 163, 184, 0.25);
      --shadow: rgba(2, 6, 23, 0.45);
      --shadow-hover: rgba(2, 6, 23, 0.6);
      --glass-bg: rgba(15, 23, 42, 0.55);
      --glass-border: rgba(148, 163, 184, 0.35);
      --body-background: linear-gradient(135deg, #0f172a 0%, #111827 100%);
      --body-text-color: #e2e8f0;
      --topbar-bg: rgba(15, 23, 42, 0.92);
      --topbar-border: rgba(148, 163, 184, 0.25);
      --topbar-icon-color: #e2e8f0;
      --topbar-icon-bg: rgba(30, 41, 59, 0.85);
      --topbar-icon-border: rgba(71, 85, 105, 0.6);
      --topbar-icon-hover-bg: rgba(14, 165, 233, 0.22);
      --topbar-icon-hover-color: #38bdf8;
      --topbar-icon-hover-border: rgba(56, 189, 248, 0.45);
      --topbar-text-muted: #94a3b8;
      --topbar-text-strong: #f8fafc;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', "Google Sans", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--body-background);
      color: var(--body-text-color);
      overflow-x: hidden;
      font-size: 14px;
      line-height: 1.6;
      font-weight: 400;
    }

    .modal-backdrop {
      z-index: var(--bs-backdrop-zindex, 1040) !important;
    }

    .modal {
      z-index: var(--bs-modal-zindex, 1050) !important;
    }

    /* Enhanced Sidebar with Glassmorphism */
    #sidebar {
      width: var(--sidebar-width);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background: var(--sidebar-bg);
      backdrop-filter: blur(20px);
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      transition: var(--transition-smooth);
      box-shadow: 8px 0 32px rgba(15, 23, 42, 0.2);
      overflow: hidden;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateX(0);
    }

    #sidebar::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="0.5" fill="rgba(255,255,255,0.02)"/><circle cx="25" cy="25" r="0.3" fill="rgba(255,255,255,0.01)"/><circle cx="75" cy="75" r="0.4" fill="rgba(255,255,255,0.015)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      pointer-events: none;
      opacity: 0.6;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
    }

    .header .container {
      position: relative;
      z-index: 1;
    }

    #sidebar.collapsed {
      width: var(--sidebar-collapsed);
    }

    .mobile-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(4px);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.25s ease, visibility 0.25s ease;
      z-index: 998;
      pointer-events: none;
    }

    .mobile-overlay.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    body.sidebar-open {
      overflow: hidden;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
      position: relative;
      z-index: 2;
    }

    #sidebar .sidebar-content {
      overflow-y: auto !important;
    }

    .sidebar-content::-webkit-scrollbar {
      width: 8px;
    }

    .sidebar-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.4));
      border-radius: 4px;
      transition: var(--transition-fast);
    }

    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.5));
    }

    #sidebar.collapsed .sidebar-content::-webkit-scrollbar {
      width: 0px;
    }

    #sidebar.collapsed .sidebar-content {
      scrollbar-width: none;
    }

    /* Enhanced Logo Section */
    .sidebar-logo {
      display: flex;
      align-items: center;
      padding: 1.5rem 1.25rem;
      cursor: pointer;
      position: relative;
      transition: var(--transition-smooth);
      min-height: 80px;
      z-index: 3;
      backdrop-filter: blur(10px);
    }

    .sidebar-logo::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.05), transparent);
      opacity: 0;
      transition: var(--transition-smooth);
    }

    .sidebar-logo:hover::before {
      opacity: 1;
    }

    .sidebar-logo:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-1px);
    }

    .logo-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--border-radius-xs);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      object-fit: contain;
      padding: 6px;
      transition: var(--transition-smooth);
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
    }

    .sidebar-logo:hover .logo-icon {
      transform: scale(1.05) rotate(2deg);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }

    .logo-text-container {
      margin-left: 1rem;
      overflow: hidden;
      transition: var(--transition-smooth);
      flex: 1;
      display: flex;
      align-items: center;
    }

    .logo-text {
      height: 42px;
      width: auto;
      max-width: 220px;
      object-fit: contain;
      transition: var(--transition-smooth);
      font-weight: 800;
      filter: brightness(1.1);
    }

    .logo-text-fallback {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--sidebar-text);
      letter-spacing: -0.5px;
      line-height: 1.2;
      display: none;
      background: linear-gradient(135deg, #ffffff, #e2e8f0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .logo-text-fallback .brand-accent {
      color: var(--primary-light);
      font-weight: 900;
      text-shadow: 0 0 20px rgba(56, 189, 248, 0.5);
    }

    #sidebar.collapsed .logo-text-container {
      opacity: 0;
      visibility: hidden;
      width: 0;
      margin-left: 0;
      overflow: hidden;
    }

    #sidebar.collapsed .sidebar-logo {
      justify-content: center;
      padding: 1rem;
    }

    #sidebar.collapsed .logo-icon {
      margin: 0;
    }

    /* Enhanced Campaign Header */
    .campaign-header-sidebar {
      transition: var(--transition-smooth);
      position: relative;
      z-index: 3;
    }

    .campaign-badge-sidebar {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1.5rem 1rem 1.25rem;
      border-radius: 0;
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-align: center;
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.3);
      transition: var(--transition-smooth);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      height: 4.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 1.5rem;
    }

    .campaign-badge-sidebar::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
      transform: translateX(-100%);
      transition: transform 0.6s ease;
    }

    .campaign-badge-sidebar:hover::before {
      transform: translateX(100%);
    }

    .campaign-badge-sidebar i {
      margin-right: 0.75rem;
      font-size: 1rem;
      opacity: 0.9;
    }

    #sidebar.collapsed .campaign-header-sidebar {
      opacity: 0;
      visibility: hidden;
      height: 0;
      padding: 0;
      margin: 0;
      overflow: hidden;
    }

    /* Enhanced Category Sections */
    .sidebar-category {
      margin-bottom: 2rem;
      position: relative;
      z-index: 2;
    }

    .category-header {
      padding: 1rem 1.5rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--sidebar-text-muted);
      letter-spacing: 1px;
      position: relative;
      transition: var(--transition-smooth);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: rgba(255, 255, 255, 0.02);
      margin-bottom: 0.25rem;
    }

    .category-header i {
      font-size: 1rem;
      opacity: 0.8;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .category-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 1rem;
      right: 1rem;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: var(--transition-smooth);
    }

    #sidebar.collapsed .category-header {
      opacity: 0;
      visibility: hidden;
      height: 0;
      padding: 0;
      margin: 0;
      overflow: hidden;
    }

    #sidebar.collapsed .category-header::after {
      display: none;
    }

    .sidebar-group {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
      padding: 0 1rem;
      transition: var(--transition-smooth);
    }

    #sidebar.collapsed .sidebar-group {
      padding: 0 0.75rem;
    }

    .sidebar-group a {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.25rem;
      color: var(--sidebar-text);
      border-radius: var(--border-radius-sm);
      transition: var(--transition-smooth);
      text-decoration: none;
      white-space: nowrap;
      position: relative;
      font-weight: 500;
      font-size: 0.875rem;
      overflow: hidden;
      border: 1px solid transparent;
    }

    .sidebar-group a::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      transform: scaleY(0);
      transition: transform 0.3s ease;
      border-radius: 0 2px 2px 0;
    }

    .sidebar-group a::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), transparent);
      opacity: 0;
      transition: var(--transition-smooth);
    }

    .sidebar-group a:hover {
      background: var(--sidebar-hover);
      color: var(--sidebar-text);
      transform: translateX(6px);
      border-color: rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .sidebar-group a:hover::after {
      opacity: 1;
    }

    .sidebar-group a:hover::before {
      transform: scaleY(1);
    }

    .sidebar-group a.active {
      background: var(--sidebar-active);
      color: white;
      box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
      transform: translateX(6px);
      border-color: rgba(255, 255, 255, 0.2);
      font-weight: 600;
    }

    .sidebar-group a.active::before {
      transform: scaleY(1);
      background: rgba(255, 255, 255, 0.8);
    }

    .sidebar-group a i {
      width: 1.75rem;
      text-align: center;
      margin-right: 1rem;
      font-size: 1.125rem;
      transition: var(--transition-smooth);
      flex-shrink: 0;
      opacity: 0.9;
    }

    .sidebar-group a:hover i {
      transform: scale(1.1);
      opacity: 1;
    }

    .sidebar-group a.active i {
      opacity: 1;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .sidebar-group a span {
      transition: var(--transition-smooth);
      overflow: hidden;
      font-weight: 500;
    }

    #sidebar.collapsed .sidebar-group a {
      justify-content: center;
      padding: 1rem;
      margin: 0.25rem 0;
      transform: none;
    }

    #sidebar.collapsed .sidebar-group a:hover {
      transform: none;
    }

    #sidebar.collapsed .sidebar-group a.active {
      transform: none;
    }

    #sidebar.collapsed .sidebar-group a span {
      opacity: 0;
      visibility: hidden;
      width: 0;
      margin: 0;
      padding: 0;
    }

    #sidebar.collapsed .sidebar-group a i {
      margin-right: 0;
      font-size: 1.25rem;
    }

    /* Enhanced Global Pages Section */
    .global-section {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: auto;
      padding-top: 1.5rem;
      position: relative;
      z-index: 2;
    }

    .global-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 1rem;
      right: 1rem;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    }

    /* Enhanced User Panel with Employment Info and Role Display */
    .user-panel {
      margin-top: auto;
      padding: 1.5rem calc(1rem + 1.25rem);
      display: flex;
      align-items: center;
      gap: 1rem;
      width: 100%;
      text-align: left;
      cursor: default;
      color: inherit;
      font: inherit;
      border: none;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(15px);
      transition: var(--transition-smooth);
      position: relative;
      z-index: 3;
    }

    .user-panel:focus-visible {
      outline: 2px solid var(--sidebar-active);
      outline-offset: 3px;
    }

    .user-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: calc(1rem + 1.25rem);
      right: calc(1rem + 1.25rem);
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    }

    .user-avatar-side {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--sidebar-active);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1.25rem;
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.4);
      flex-shrink: 0;
      border: 2px solid rgba(255, 255, 255, 0.2);
      transition: var(--transition-smooth);
    }

    .user-panel:hover .user-avatar-side {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(14, 165, 233, 0.5);
    }

    .user-info {
      line-height: 1.4;
      overflow: hidden;
      flex: 1;
      min-width: 0;
      transition: var(--transition-smooth);
    }

    .user-info .names {
      font-size: 1rem;
      color: var(--sidebar-text);
      font-weight: 700;
      margin-bottom: 0.25rem;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .user-name-trigger {
      border: none;
      background: transparent;
      color: inherit;
      font: inherit;
      padding: 0;
      margin: 0;
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.35rem;
      width: 100%;
      min-width: 0;
      cursor: pointer;
    }

    .user-name-trigger:hover i,
    .user-name-trigger:focus i {
      opacity: 0.9;
    }

    .user-name-trigger:focus-visible {
      outline: 2px solid var(--sidebar-active);
      outline-offset: 3px;
      border-radius: 6px;
    }

    .user-name-trigger i {
      font-size: 0.85rem;
      opacity: 0.6;
      flex-shrink: 0;
    }

    .user-name-trigger span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-info .role {
      font-size: 0.8rem;
      color: var(--sidebar-text-muted);
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      margin-bottom: 0.375rem;
      font-weight: 500;
    }

    .user-info .employment-status {
      font-size: 0.75rem;
      color: var(--sidebar-text-muted);
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-weight: 500;
    }

    .user-info .employment-status i {
      font-size: 0.7rem;
      opacity: 0.9;
      margin-right: 0.25rem;
    }

    .user-panel-menu {
      position: absolute;
      bottom: calc(100% - 0.5rem);
      right: calc(1rem + 1.25rem);
      display: none;
      flex-direction: column;
      gap: 0.25rem;
      padding: 0.6rem;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.45);
      min-width: 180px;
      z-index: 5;
    }

    .user-panel.menu-open .user-panel-menu {
      display: flex;
    }

    .user-panel-menu[hidden] {
      display: none !important;
    }

    .user-panel-menu__item {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.9);
      font: inherit;
      font-weight: 600;
      padding: 0.55rem 0.7rem;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition-smooth);
    }

    .user-panel-menu__item i {
      font-size: 0.9rem;
    }

    .user-panel-menu__item:hover,
    .user-panel-menu__item:focus {
      background: rgba(99, 102, 241, 0.18);
      color: #fff;
    }

    /* Enhanced Employment Status Colors */
    .user-info .employment-status .status-active {
      color: #4ade80;
      text-shadow: 0 0 8px rgba(74, 222, 128, 0.3);
    }

    .user-info .employment-status .status-inactive {
      color: #f87171;
      text-shadow: 0 0 8px rgba(248, 113, 113, 0.3);
    }

    .user-info .employment-status .status-contract {
      color: #60a5fa;
      text-shadow: 0 0 8px rgba(96, 165, 250, 0.3);
    }

    .user-info .employment-status .status-probation {
      color: #fbbf24;
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.3);
    }

    .user-info .employment-status .status-leave {
      color: #a78bfa;
      text-shadow: 0 0 8px rgba(167, 139, 250, 0.3);
    }

    .user-info .employment-status .status-terminated {
      color: #ef4444;
      text-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
    }

    .user-info .employment-status .status-suspended {
      color: #6b7280;
      text-shadow: 0 0 8px rgba(107, 114, 128, 0.3);
    }

    .user-info .employment-status .status-part-time {
      color: #34d399;
      text-shadow: 0 0 8px rgba(52, 211, 153, 0.3);
    }

    .user-info .employment-status .status-full-time {
      color: #10b981;
      text-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
    }

    #sidebar.collapsed .user-panel {
      padding: 1.25rem;
      justify-content: center;
    }

    #sidebar.collapsed .user-info {
      opacity: 0;
      visibility: hidden;
      width: 0;
      margin: 0;
    }

    /* Enhanced Topbar */
    #topbar {
      position: fixed;
      top: 0;
      left: var(--sidebar-width);
      right: 0;
      height: var(--topbar-height);
      background: var(--topbar-bg);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--topbar-border);
      z-index: 999;
      display: flex;
      align-items: center;
      padding: 0 2rem;
      transition: var(--transition-smooth);
      box-shadow: 0 1px 3px var(--shadow);
    }

    #sidebar.collapsed~#topbar {
      left: var(--sidebar-collapsed);
    }

    .topbar-toggle {
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--topbar-icon-color);
      padding: 0.75rem;
      border-radius: 50%;
      transition: var(--transition-smooth);
      margin-right: 1.5rem;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .topbar-toggle:hover {
      background: var(--topbar-icon-hover-bg);
      color: var(--topbar-icon-hover-color);
      transform: scale(1.05);
    }

    .breadcrumb-nav {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--topbar-text-muted);
      font-size: 0.95rem;
      font-weight: 500;
    }

    .breadcrumb-nav .current-page {
      color: var(--topbar-text-strong);
      font-weight: 700;
      font-size: 1.125rem;
    }

    .breadcrumb-nav i {
      opacity: 0.6;
      font-size: 0.875rem;
    }

    .top-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .notification-btn {
      position: relative;
      background: none;
      border: none;
      font-size: 1.25rem;
      color: var(--topbar-icon-color);
      padding: 0.75rem;
      border-radius: 50%;
      transition: var(--transition-smooth);
      text-decoration: none;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--topbar-icon-bg);
      backdrop-filter: blur(8px);
      border: 1px solid var(--topbar-icon-border);
    }

    .notification-btn:hover {
      background: var(--topbar-icon-hover-bg);
      color: var(--topbar-icon-hover-color);
      text-decoration: none;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
      border-color: var(--topbar-icon-hover-border);
    }

    .theme-toggle-btn .fa-sun {
      color: #facc15;
      transition: color 0.3s ease;
    }

    :root[data-theme="dark"] .theme-toggle-btn .fa-sun {
      color: #fde68a;
    }

    .notification-badge {
      position: absolute;
      top: 0.375rem;
      right: 0.375rem;
      width: 10px;
      height: 10px;
      background: linear-gradient(135deg, var(--danger), #dc2626);
      border-radius: 50%;
      border: 2px solid var(--topbar-icon-bg);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

    /* Enhanced Topbar Logout Button */
    .logout-btn-topbar {
      position: relative;
      background: var(--topbar-icon-bg);
      backdrop-filter: blur(8px);
      border: 1px solid var(--topbar-icon-border);
      font-size: 1.25rem;
      color: var(--topbar-icon-color);
      padding: 0.75rem;
      border-radius: 50%;
      transition: var(--transition-smooth);
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .logout-btn-topbar:hover {
      background: rgba(239, 68, 68, 0.12);
      color: var(--danger);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.3);
    }

    .logout-btn-topbar:active {
      transform: translateY(-1px);
    }

    .logout-btn-topbar:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .logout-btn-topbar .loading-spinner-head {
      animation: spin 1s linear infinite;
    }

    @media (max-width: 1440px) {
      :root {
        --sidebar-width: clamp(260px, 20vw, 300px);
      }
    }

    @media (max-width: 1100px) {
      :root {
        --sidebar-width: clamp(240px, 26vw, 280px);
        --topbar-height: 64px;
      }
    }

    @media (max-width: 1024px) {
      #sidebar {
        transform: translateX(-100%);
        width: min(320px, 86vw);
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.35);
      }

      #sidebar.mobile-open {
        transform: translateX(0);
      }

      #sidebar.collapsed,
      #sidebar.collapsed.mobile-open {
        width: min(320px, 86vw);
      }

      #topbar {
        left: 0;
        padding: 0 1.5rem;
      }

      #sidebar.collapsed~#topbar {
        left: 0;
      }

      #maincontent {
        margin: calc(var(--topbar-height) + 0.25rem)
          clamp(0.25rem, 1.8vw, 0.6rem)
          0.55rem;
      }

      #sidebar.collapsed~#maincontent {
        margin-left: clamp(0.35rem, 2vw, 0.75rem);
      }

      body.sidebar-open #maincontent {
        pointer-events: none;
        filter: blur(1px);
      }
    }

    /* Mobile responsiveness for top actions */
    @media (max-width: 768px) {
      .top-actions {
        gap: 0.5rem;
        margin-left: auto;
      }

      .notification-btn,
      .logout-btn-topbar {
        width: 44px;
        height: 44px;
        font-size: 1.125rem;
      }

      #topbar {
        padding: 0 1rem;
      }

      #maincontent {
        margin: calc(var(--topbar-height) + 0.25rem)
          clamp(0.25rem, 3vw, 0.7rem)
          0.55rem;
      }

      .breadcrumb-nav {
        width: 100%;
        margin-bottom: 0.5rem;
      }
    }

    @media (max-width: 576px) {
      #topbar {
        flex-wrap: wrap;
        gap: 0.75rem;
        padding: 0.75rem clamp(0.75rem, 5vw, 1rem);
      }

      #maincontent {
        margin: calc(var(--topbar-height) + 0.2rem)
          clamp(0.2rem, 4vw, 0.6rem)
          0.5rem;
      }

      .topbar-toggle {
        margin-right: 0.75rem;
      }
    }

    @media (max-width: 480px) {
      .top-actions .notification-btn:not(.logout-btn-topbar):first-child {
        display: none;
      }
    }

    #maincontent {
      margin-left: calc(var(--sidebar-width) + 0.3rem);
      margin-top: calc(var(--topbar-height) + 0.2rem);
      margin-right: 0.35rem;
      margin-bottom: 0.55rem;
      transition: var(--transition-smooth);
      min-height: calc(100vh - var(--topbar-height) - 0.75rem);
    }

    #sidebar.collapsed~#maincontent {
      margin-left: calc(var(--sidebar-collapsed) + 0.3rem);
    }

    /* Unified global page banner */
    .lumina-banner {
      position: relative;
      background:
        radial-gradient(135% 120% at -15% 15%, rgba(56, 189, 248, 0.32) 0%, rgba(56, 189, 248, 0) 60%),
        radial-gradient(150% 150% at 110% 5%, rgba(4, 120, 211, 0.35) 0%, rgba(4, 120, 211, 0) 65%),
        conic-gradient(from 210deg at 70% 78%, rgba(3, 87, 153, 0.28) 0deg, rgba(11, 27, 63, 0) 165deg),
        linear-gradient(160deg, rgba(11, 27, 63, 0.96) 0%, rgba(16, 48, 96, 0.95) 45%, rgba(3, 87, 153, 0.92) 100%);
      border: 1px solid rgba(56, 189, 248, 0.22);
      border-radius: 34px;
      padding: clamp(1.9rem, 3.5vw, 3.1rem);
      margin-bottom: 2.5rem;
      box-shadow: 0 42px 90px -48px rgba(8, 23, 53, 0.9), 0 24px 55px -40px rgba(4, 120, 211, 0.4);
      color: #e2e8f0;
      overflow: hidden;
      backdrop-filter: blur(9px);
      isolation: isolate;
    }

    .lumina-banner::before {
      content: '';
      position: absolute;
      inset: -12% -8% -20% -8%;
      background:
        radial-gradient(48% 55% at 16% 26%, rgba(148, 197, 255, 0.5) 0%, rgba(148, 197, 255, 0) 65%),
        radial-gradient(58% 62% at 82% 15%, rgba(56, 189, 248, 0.4) 0%, rgba(56, 189, 248, 0) 72%),
        conic-gradient(from 135deg at 78% 64%, rgba(4, 120, 211, 0.55) 0deg, rgba(3, 105, 161, 0.08) 150deg, rgba(4, 120, 211, 0.45) 320deg, rgba(4, 120, 211, 0) 360deg),
        linear-gradient(112deg, rgba(3, 87, 153, 0.25) 0%, rgba(56, 189, 248, 0.08) 40%);
      mix-blend-mode: screen;
      pointer-events: none;
      opacity: 0.92;
      filter: blur(0.5px);
    }

    .lumina-banner::after {
      content: '';
      position: absolute;
      inset: 1px;
      border-radius: 32px;
      border: 1px solid rgba(148, 197, 255, 0.22);
      background:
        radial-gradient(120% 180% at 105% 105%, rgba(4, 120, 211, 0.18) 0%, rgba(4, 120, 211, 0) 60%),
        linear-gradient(158deg, rgba(148, 197, 255, 0.12) 0%, rgba(11, 27, 63, 0.1) 55%, rgba(3, 87, 153, 0) 100%);
      pointer-events: none;
    }

    .lumina-banner__content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: clamp(1.5rem, 3vw, 3.25rem);
    }

    .lumina-banner__main {
      flex: 1 1 360px;
      min-width: 260px;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .lumina-banner__eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      font-weight: 700;
      color: rgba(226, 240, 254, 0.9);
      background: linear-gradient(125deg, rgba(4, 120, 211, 0.7) 0%, rgba(56, 189, 248, 0.6) 100%);
      padding: 0.45rem 0.95rem;
      border-radius: 999px;
      box-shadow: inset 0 0 0 1px rgba(148, 197, 255, 0.55), 0 10px 18px -15px rgba(4, 120, 211, 0.65);
    }

    .lumina-banner__eyebrow i {
      color: #38bdf8;
    }

    .lumina-banner__title-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .lumina-banner__title {
      font-size: clamp(2rem, 4vw, 2.85rem);
      font-weight: 700;
      margin: 0;
      color: #f8fafc;
      letter-spacing: -0.01em;
    }

    .lumina-banner__description {
      margin: 0;
      font-size: 1.05rem;
      line-height: 1.65;
      color: rgba(226, 240, 254, 0.86);
      max-width: 70ch;
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }

    .lumina-banner__description[data-empty="true"] {
      display: none;
    }

    .lumina-banner__description-text {
      display: block;
    }

    .lumina-banner__description-text:not(:last-child) {
      margin-bottom: 0.25rem;
    }

    .lumina-banner__rich-block {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      width: 100%;
    }

    .lumina-banner__rich-block > * {
      margin: 0;
      color: inherit;
    }

    .lumina-banner__rich-block .header-stats,
    .lumina-banner__rich-block .stats-grid,
    .lumina-banner__rich-block .quick-stats,
    .lumina-banner__rich-block .summary-grid,
    .lumina-banner__rich-block .info-grid,
    .lumina-banner__rich-block .agent-info {
      width: 100%;
    }

    .lumina-banner__actions {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .lumina-banner__actions:empty {
      display: none;
    }

    .lumina-banner__action {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      border-radius: 999px;
      padding: 0.65rem 1.5rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      text-decoration: none;
      border: 1px solid transparent;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border 0.2s ease;
      box-shadow: 0 18px 34px -25px rgba(14, 165, 233, 0.85);
    }

    .lumina-banner__action span,
    .lumina-banner__action i {
      color: inherit;
    }

    .lumina-banner__action i {
      font-size: 0.95rem;
    }

    .lumina-banner__action--force-light,
    .lumina-banner__action--force-light span,
    .lumina-banner__action--force-light i {
      color: #f8fafc !important;
    }

    .lumina-banner__action--primary {
      background: linear-gradient(135deg, #1d4ed8 0%, #0891b2 35%, #22d3ee 100%);
      color: #f8fafc;
      border-color: rgba(94, 234, 212, 0.55);
      box-shadow: 0 22px 48px -20px rgba(6, 182, 212, 0.85);
    }

    .lumina-banner__action--primary:hover,
    .lumina-banner__action--primary:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 26px 58px -18px rgba(6, 182, 212, 0.9);
    }

    .lumina-banner__action--secondary {
      background: rgba(148, 197, 255, 0.16);
      border-color: rgba(125, 211, 252, 0.38);
      color: rgba(226, 240, 254, 0.9);
    }

    .lumina-banner__action--secondary:hover,
    .lumina-banner__action--secondary:focus-visible {
      background: rgba(148, 197, 255, 0.24);
      transform: translateY(-1px);
    }

    .lumina-banner__action:focus-visible {
      outline: 2px solid rgba(148, 163, 184, 0.55);
      outline-offset: 2px;
    }

    .lumina-banner__meta {
      flex: 0 0 280px;
      min-width: 240px;
      display: grid;
      gap: 1.1rem;
      background:
        radial-gradient(120% 90% at 0% 0%, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0) 65%),
        linear-gradient(160deg, rgba(15, 23, 42, 0.75) 0%, rgba(8, 47, 73, 0.85) 55%, rgba(15, 118, 110, 0.6) 100%);
      border-radius: 28px;
      padding: 1.5rem 1.7rem;
      box-shadow: inset 0 0 0 1px rgba(165, 243, 252, 0.25), 0 18px 26px -28px rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(12px);
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .lumina-banner__meta::before {
      content: '';
      position: absolute;
      inset: -35% -25% auto -25%;
      height: 160%;
      background: radial-gradient(55% 55% at 20% 20%, rgba(94, 234, 212, 0.3) 0%, rgba(94, 234, 212, 0) 70%),
        linear-gradient(135deg, rgba(14, 165, 233, 0.12) 0%, rgba(148, 197, 255, 0) 60%);
      mix-blend-mode: screen;
      pointer-events: none;
      opacity: 0.9;
      z-index: 0;
    }

    .lumina-banner__meta-item {
      display: grid;
      gap: 0.45rem;
      position: relative;
      z-index: 1;
    }

    .lumina-banner__meta-label {
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(191, 219, 254, 0.75);
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .lumina-banner__meta-value {
      font-size: 1.05rem;
      font-weight: 600;
      color: #f8fafc;
      line-height: 1.55;
    }

    .lumina-banner__meta-value[data-dst-active="true"] {
      color: #34d399;
    }

    .lumina-banner__meta-value[data-dst-active="false"] {
      color: #facc15;
    }

    @media (max-width: 1200px) {
      .lumina-banner__meta {
        flex: 1 1 100%;
        width: 100%;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
    }

    @media (max-width: 900px) {
      .lumina-banner {
        padding: 1.75rem;
        border-radius: 26px;
      }

      .lumina-banner__title-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .lumina-banner__actions {
        width: 100%;
      }

      .lumina-banner__actions .lumina-banner__action {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 640px) {
      .lumina-banner__meta {
        padding: 1.1rem 1.25rem;
      }

      .lumina-banner__title {
        font-size: clamp(1.75rem, 6vw, 2.35rem);
      }
    }

    @media (max-width: 520px) {
      .lumina-banner__meta-label {
        font-size: 0.68rem;
      }

      .lumina-banner__meta-value {
        font-size: 0.95rem;
      }
    }

    /* Loading spinner */
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }
  </style>
  <?!= includeOnce('layoutLoader') ?>
  <?!= include('EntityLoader') ?>
</head>

<body
  data-theme="light"
  data-page-slug="<?!= __layoutSlugCandidate ?>"
  data-return-url="<?!= __layoutRawReturnUrl ?>"
>
  <?
    // Shared layout context so navigation components can stay in sync
    var __layoutUser = (typeof safeUser !== 'undefined' && safeUser) ? safeUser : (typeof user !== 'undefined' ? user : {});

    if (__layoutUser && __layoutUser.ID && typeof createSafeUserObject === 'function') {
      try {
        __layoutUser = createSafeUserObject(__layoutUser);
      } catch (err) {
        console.error('Error creating safe user object:', err);
        if (!__layoutUser.roleNames || !__layoutUser.roleNames.length) {
          try {
            if (typeof getUserRolesSafe === 'function') {
              var __layoutResolvedRoles = getUserRolesSafe(__layoutUser.ID);
              __layoutUser.roleNames = (__layoutResolvedRoles || []).map(function(role) {
                return role && role.name ? role.name : '';
              }).filter(function(name) { return Boolean(name); });
            }
          } catch (innerErr) {
            console.error('Manual role resolution failed:', innerErr);
            __layoutUser.roleNames = [];
          }
        }
      }
    }

    var __layoutIsAdmin = (
      __layoutUser && (
        __layoutUser.IsAdmin === true ||
        String(__layoutUser.IsAdmin).toUpperCase() === 'TRUE' ||
        __layoutUser.isAdminBool === true
      )
    );

    var __layoutCampaignId = (__layoutUser && __layoutUser.CampaignID) ? __layoutUser.CampaignID : '';
    var __layoutCampaignName = (__layoutUser && (__layoutUser.campaignName || __layoutUser.CampaignName)) ?
      (__layoutUser.campaignName || __layoutUser.CampaignName) : '';

    function __layoutResolveClientName(user) {
      if (!user) {
        return '';
      }

      var candidates = [
        user.clientName,
        user.ClientName,
        user.client,
        user.Client,
        user.accountName,
        user.AccountName,
        user.companyName,
        user.CompanyName,
        user.organization,
        user.Organization
      ];

      for (var i = 0; i < candidates.length; i++) {
        var value = candidates[i];
        if (!value) {
          continue;
        }

        var text = String(value).trim();
        if (text) {
          return text;
        }
      }

      return '';
    }

    var __layoutClientName = __layoutResolveClientName(__layoutUser);

    var __layoutRoleNames = [];
    if (Array.isArray(__layoutUser && __layoutUser.roleNames) && __layoutUser.roleNames.length) {
      __layoutRoleNames = __layoutUser.roleNames;
    } else if (__layoutUser && __layoutUser.ID && typeof getUserRolesSafe === 'function') {
      try {
        var __layoutResolvedRoles = getUserRolesSafe(__layoutUser.ID) || [];
        __layoutRoleNames = __layoutResolvedRoles
          .map(function (role) { return role && role.name ? role.name : ''; })
          .filter(function (name) { return Boolean(name); });
      } catch (resolveRolesErr) {
        console.error('layout: failed to resolve roles from database', resolveRolesErr);
        __layoutRoleNames = [];
      }
    } else if (__layoutIsAdmin) {
      __layoutRoleNames = ['System Administrator'];
    }

    function __layoutFormatEmployment(status) {
      if (!status) {
        return { status: '', cls: '', icon: 'fas fa-briefcase' };
      }
      var normalized = String(status).toLowerCase();
      var mapping = {
        'active': ['status-active', 'fas fa-check-circle'],
        'full time': ['status-active', 'fas fa-check-circle'],
        'full-time': ['status-active', 'fas fa-check-circle'],
        'inactive': ['status-inactive', 'fas fa-times-circle'],
        'terminated': ['status-inactive', 'fas fa-times-circle'],
        'contract': ['status-contract', 'fas fa-file-contract'],
        'probation': ['status-probation', 'fas fa-hourglass-half'],
        'on leave': ['status-leave', 'fas fa-pause-circle'],
        'part time': ['status-part-time', 'fas fa-clock'],
        'part-time': ['status-part-time', 'fas fa-clock'],
        'suspended': ['status-suspended', 'fas fa-ban']
      };
      var resolved = mapping[normalized] || null;
      return {
        status: status,
        cls: resolved ? resolved[0] : '',
        icon: resolved ? resolved[1] : 'fas fa-briefcase'
      };
    }

    var __layoutEmploymentMeta = __layoutFormatEmployment(__layoutUser ? __layoutUser.EmploymentStatus : '');

    var __layoutNavigation = { categories: [], uncategorizedPages: [] };
    if (__layoutCampaignId) {
      try {
        if (typeof clientGetCampaignNavigation === 'function') {
          __layoutNavigation = clientGetCampaignNavigation(__layoutCampaignId) || __layoutNavigation;
        } else if (__layoutUser && __layoutUser.campaignNavigation) {
          __layoutNavigation = __layoutUser.campaignNavigation;
        }
      } catch (navErr) {
        console.error('Error getting campaign navigation:', navErr);
      }
    }
  ?>

  <div class="mobile-overlay" id="mobileOverlay"></div>

  <?!= include('navigationSidebar', {
        baseUrl: (typeof baseUrl !== 'undefined') ? baseUrl : '',
        scriptUrl: (typeof scriptUrl !== 'undefined') ? scriptUrl : ((typeof baseUrl !== 'undefined') ? baseUrl : ''),
        currentPage: typeof currentPage !== 'undefined' ? currentPage : '',
        user: __layoutUser || {},
        isAdmin: __layoutIsAdmin,
        campaignId: __layoutCampaignId,
        campaignName: __layoutCampaignName,
        roleNames: __layoutRoleNames,
        navigation: __layoutNavigation,
        employmentMeta: __layoutEmploymentMeta
      }) ?>

  <?!= include('navigationTopbar', {
        baseUrl: (typeof baseUrl !== 'undefined') ? baseUrl : '',
        scriptUrl: (typeof scriptUrl !== 'undefined') ? scriptUrl : ((typeof baseUrl !== 'undefined') ? baseUrl : ''),
        currentPage: typeof currentPage !== 'undefined' ? currentPage : '',
        campaignName: __layoutCampaignName,
        isAdmin: __layoutIsAdmin
      }) ?>

  
  <div id="maincontent" class="animate-in main-content">

    <section class="lumina-banner" id="luminaBanner" aria-label="Page overview">
      <div class="lumina-banner__content">
        <div class="lumina-banner__main">
          <div class="lumina-banner__eyebrow" id="luminaBannerEyebrow">
            <i class="fa-solid fa-sun"></i>
            <span id="luminaBannerEyebrowText">Lumina Sheets</span>
          </div>
          <div class="lumina-banner__title-row">
            <h1 class="lumina-banner__title" id="luminaBannerTitle">LuminaHQ</h1>
            <div class="lumina-banner__actions" id="luminaBannerActions" aria-label="Banner actions"></div>
          </div>
          <div class="lumina-banner__description" id="luminaBannerDescription"></div>
        </div>
        <div class="lumina-banner__meta">
          <div class="lumina-banner__meta-item" id="luminaBannerMetaDate">
            <div class="lumina-banner__meta-label"><i class="fa-regular fa-calendar"></i> Today</div>
            <div class="lumina-banner__meta-value" id="luminaBannerDate" aria-live="polite">—</div>
          </div>
          <div class="lumina-banner__meta-item" id="luminaBannerMetaDst">
            <div class="lumina-banner__meta-label"><i class="fa-regular fa-clock"></i> Daylight Saving</div>
            <div class="lumina-banner__meta-value" id="luminaBannerDst" aria-live="polite" data-dst-active="false">—</div>
          </div>
          <div class="lumina-banner__meta-item" id="luminaBannerMetaCampaign" data-empty="true">
            <div class="lumina-banner__meta-label"><i class="fa-solid fa-bullseye"></i> Campaign</div>
            <div class="lumina-banner__meta-value" id="luminaBannerCampaign" aria-live="polite">—</div>
          </div>
          <div class="lumina-banner__meta-item" id="luminaBannerMetaClient" data-empty="true">
            <div class="lumina-banner__meta-label"><i class="fa-solid fa-building"></i> Client</div>
            <div class="lumina-banner__meta-value" id="luminaBannerClient" aria-live="polite">—</div>
          </div>
        </div>
      </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function formatBannerDateTime(date) {
            try {
                const dateFormatter = new Intl.DateTimeFormat(undefined, {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });
                const timeFormatter = new Intl.DateTimeFormat(undefined, {
                    hour: 'numeric',
                    minute: '2-digit'
                });
                const tzFormatter = new Intl.DateTimeFormat(undefined, { timeZoneName: 'short' });
                const tzPart = tzFormatter.formatToParts(date).find(part => part.type === 'timeZoneName');
                const tzLabel = tzPart ? ` (${tzPart.value})` : '';
                return `${dateFormatter.format(date)} • ${timeFormatter.format(date)}${tzLabel}`;
            } catch (err) {
                console.warn('Unable to format banner date/time', err);
                return date.toLocaleString();
            }
        }

        function computeBannerDst(date) {
            try {
                const options = Intl.DateTimeFormat().resolvedOptions();
                const january = new Date(date.getFullYear(), 0, 1);
                const july = new Date(date.getFullYear(), 6, 1);
                const standardOffset = Math.max(january.getTimezoneOffset(), july.getTimezoneOffset());
                const isDst = date.getTimezoneOffset() < standardOffset;
                const timeZone = options.timeZone || '';
                const statusText = isDst ? 'Daylight Saving Time is active' : 'Daylight Saving Time is not active';
                return {
                    isDst,
                    timeZone,
                    message: `${statusText}${timeZone ? ` (${timeZone})` : ''}`
                };
            } catch (err) {
                console.warn('Unable to compute DST status', err);
                return {
                    isDst: false,
                    timeZone: '',
                    message: 'Daylight Saving Time status unavailable'
                };
            }
        }

        const REMOVABLE_BANNER_BUTTON_CLASSES = [
            'btn',
            'btn-sm',
            'btn-lg',
            'btn-primary',
            'btn-secondary',
            'btn-success',
            'btn-danger',
            'btn-outline-primary',
            'btn-outline-secondary',
            'btn-outline-light',
            'btn-outline-dark',
            'btn-modern',
            'btn-modern-primary',
            'btn-modern-secondary',
            'btn-light',
            'btn-dark',
            'shadow-sm',
            'shadow',
            'text-uppercase'
        ];

        const LIGHT_TEXT_LUMINANCE_THRESHOLD = 165;

        function ensureBannerActionContrast(element) {
            if (!element || !(element instanceof HTMLElement)) {
                return;
            }

            const applyLightText = () => {
                element.classList.add('lumina-banner__action--force-light');
            };

            const evaluate = () => {
                try {
                    const computed = window.getComputedStyle ? window.getComputedStyle(element) : null;
                    if (!computed) {
                        applyLightText();
                        return;
                    }

                    const color = computed.color || '';
                    const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
                    if (!match) {
                        applyLightText();
                        return;
                    }

                    const r = parseInt(match[1], 10);
                    const g = parseInt(match[2], 10);
                    const b = parseInt(match[3], 10);
                    if (Number.isNaN(r) || Number.isNaN(g) || Number.isNaN(b)) {
                        applyLightText();
                        return;
                    }

                    const luminance = (0.299 * r) + (0.587 * g) + (0.114 * b);
                    if (luminance < LIGHT_TEXT_LUMINANCE_THRESHOLD) {
                        applyLightText();
                    } else {
                        element.classList.remove('lumina-banner__action--force-light');
                    }
                } catch (contrastErr) {
                    console.warn('Banner action contrast fallback triggered', contrastErr);
                    applyLightText();
                }
            };

            const schedule = () => {
                if (typeof window !== 'undefined' && typeof window.requestAnimationFrame === 'function') {
                    window.requestAnimationFrame(evaluate);
                } else {
                    setTimeout(evaluate, 0);
                }
            };

            schedule();
            if (typeof window !== 'undefined') {
                window.setTimeout(schedule, 150);
            }
        }

        function absorbLocalBanners() {
            const selectorList = [
                '.page-header',
                '.modern-page-header',
                '.dashboard-header',
                '.content-header',
                '.schedule-header',
                '.app-header',
                '.task-header',
                '.ack-header',
                '.coaching-header',
                '.security-header',
                '.eod-header',
                '.global-page-header',
                '.hero-header',
                '.page-hero',
                '.tos-hero',
                '.policy-header',
                '[data-banner-source]'
            ];

            const selectors = Array.from(new Set(selectorList));

            const bannerData = {
                titleText: '',
                titleFragments: [],
                descriptionText: '',
                descriptionElements: [],
                eyebrowText: '',
                actions: [],
                clientName: '',
                campaignName: ''
            };

            const processedHeaders = new Set();
            const processedButtons = new Set();
            const actionContainerClassHints = [
                'actions',
                'toolbar',
                'buttons',
                'cta',
                'header-actions',
                'page-actions',
                'button-group',
                'btn-group',
                'control-bar',
                'filter-actions',
                'top-actions',
                'quick-actions'
            ];

            const shouldSkipHeader = (header) => {
                if (!header) return true;
                if (processedHeaders.has(header)) return true;
                if (header.closest('#luminaBanner')) return true;
                if (header.closest('.modal')) return true;
                if (header.hasAttribute('data-banner-ignore')) return true;
                return false;
            };

            const isActionCandidate = (element) => {
                if (!element || element.closest('.modal')) return false;
                if (processedButtons.has(element)) return false;
                if (!(element instanceof HTMLElement)) return false;
                if (element.dataset && element.dataset.bannerAction === 'false') return false;

                if (element.matches('a[data-banner-action], button[data-banner-action]')) {
                    return true;
                }

                const classList = Array.from(element.classList || []);
                const parentClassList = Array.from((element.parentElement && element.parentElement.classList) || []);

                const hasButtonClass = classList.some(cls => cls.startsWith('btn')) || parentClassList.some(cls => cls.startsWith('btn'));
                const insideActionContainer = actionContainerClassHints.some(hint => element.closest(`[class*="${hint}"]`));

                return hasButtonClass || insideActionContainer;
            };

            const cleanupButton = (button, variant) => {
                REMOVABLE_BANNER_BUTTON_CLASSES.forEach(cls => button.classList.remove(cls));
                button.classList.add('lumina-banner__action', `lumina-banner__action--${variant}`);
                button.classList.remove('active');
                ['color', 'background', 'background-color', 'border', 'border-color', 'box-shadow'].forEach(prop => {
                    try {
                        button.style.removeProperty(prop);
                    } catch (styleErr) {
                        // Ignore cleanup issues for unsupported properties
                    }
                });
                ensureBannerActionContrast(button);
            };

            const extractActionsFrom = (root) => {
                if (!root || !(root instanceof Element)) return;

                const candidates = Array.from(root.querySelectorAll('a, button'))
                    .filter(isActionCandidate);

                candidates.forEach(button => {
                    processedButtons.add(button);

                    const isLink = button.tagName.toLowerCase() === 'a';
                    const iconEl = button.querySelector('i');
                    const storedIcon = button.getAttribute('data-banner-icon');
                    const action = {
                        element: button,
                        label: (button.getAttribute('data-banner-label') || button.textContent || '').trim(),
                        icon: storedIcon || (iconEl ? iconEl.className : ''),
                        variant: button.getAttribute('data-banner-variant') ||
                            (button.classList.contains('btn-primary') ||
                             button.classList.contains('btn-success') ||
                             (button.classList.contains('btn-modern') && !button.classList.contains('btn-outline-primary'))
                                ? 'primary'
                                : 'secondary')
                    };

                    if (button.id) {
                        action.id = button.id;
                    }

                    if (isLink) {
                        const href = button.getAttribute('href');
                        if (href) {
                            action.href = href;
                        }
                        const target = button.getAttribute('target');
                        const rel = button.getAttribute('rel');
                        if (target) action.target = target;
                        if (rel) action.rel = rel;
                    }

                    if (!action.label && button.getAttribute('aria-label')) {
                        action.label = button.getAttribute('aria-label');
                    }

                    if (!action.label) {
                        action.label = 'Action';
                    }

                    if (iconEl) {
                        iconEl.remove();
                    }

                    button.remove();
                    cleanupButton(button, action.variant);
                    bannerData.actions.push(action);
                });
            };

            const isEmptyElement = (element) => {
                if (!element) return true;
                if (!(element instanceof Element)) return false;
                if (element.childNodes.length === 0) return true;
                if (element.childNodes.length === 1) {
                    const child = element.childNodes[0];
                    if (child.nodeType === Node.TEXT_NODE) {
                        return !child.textContent.trim();
                    }
                }
                return false;
            };

            const harvestHeader = (header) => {
                if (shouldSkipHeader(header)) return;

                const hasBannerSignals = (
                    header.matches('[data-banner-source], [data-banner-title], [data-banner-description]') ||
                    header.hasAttribute('data-banner-title') ||
                    header.hasAttribute('data-banner-description') ||
                    header.querySelector('[data-banner-title], h1, h2, h3, h4, h5, h6') ||
                    header.querySelector('button, a')
                );

                processedHeaders.add(header);

                if (!hasBannerSignals) {
                    return;
                }

                const campaignAttr = header.getAttribute('data-banner-campaign') || header.getAttribute('data-banner-meta-campaign');
                if (campaignAttr && !bannerData.campaignName) {
                    bannerData.campaignName = campaignAttr.trim();
                }

                const clientAttr = header.getAttribute('data-banner-client') || header.getAttribute('data-banner-meta-client');
                if (clientAttr && !bannerData.clientName) {
                    bannerData.clientName = clientAttr.trim();
                }

                const campaignMetaEl = header.querySelector('[data-banner-campaign], [data-banner-meta="campaign"], .banner-campaign');
                if (campaignMetaEl) {
                    if (!bannerData.campaignName) {
                        bannerData.campaignName = campaignMetaEl.textContent.trim();
                    }
                    campaignMetaEl.remove();
                }

                const clientMetaEl = header.querySelector('[data-banner-client], [data-banner-meta="client"], .banner-client');
                if (clientMetaEl) {
                    if (!bannerData.clientName) {
                        bannerData.clientName = clientMetaEl.textContent.trim();
                    }
                    clientMetaEl.remove();
                }

                const eyebrowAttr = header.getAttribute('data-banner-eyebrow');
                if (eyebrowAttr && !bannerData.eyebrowText) {
                    bannerData.eyebrowText = eyebrowAttr.trim();
                }

                const eyebrowEl = header.querySelector('[data-banner-eyebrow]');
                if (eyebrowEl && !bannerData.eyebrowText) {
                    bannerData.eyebrowText = eyebrowEl.textContent.trim();
                }

                const titleEl = header.querySelector('[data-banner-title], h1, h2, h3, h4');
                if (titleEl) {
                    const titleText = titleEl.textContent.trim();
                    if (titleText && !bannerData.titleText) {
                        bannerData.titleText = titleText;
                    }

                    if (!bannerData.titleFragments.length) {
                        const fragments = [];
                        while (titleEl.firstChild) {
                            const node = titleEl.firstChild;
                            if (!node) {
                                break;
                            }

                            fragments.push(node);
                            titleEl.removeChild(node);
                        }
                        bannerData.titleFragments = fragments;
                    }

                    titleEl.remove();
                }

                const descriptionAttr = header.getAttribute('data-banner-description');
                if (descriptionAttr && !bannerData.descriptionText) {
                    bannerData.descriptionText = descriptionAttr.trim();
                }

                extractActionsFrom(header);

                const wrapper = document.createElement('div');
                wrapper.classList.add('lumina-banner__rich-block');

                Array.from(header.childNodes).forEach(node => {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        const element = node;
                        if (element.matches('script, style')) {
                            element.remove();
                            return;
                        }

                        extractActionsFrom(element);

                        if (isEmptyElement(element)) {
                            element.remove();
                            return;
                        }

                        if (!bannerData.descriptionText) {
                            const snippet = element.textContent ? element.textContent.trim() : '';
                            if (snippet) {
                                bannerData.descriptionText = snippet;
                            }
                        }

                        wrapper.appendChild(element);
                        return;
                    }

                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent.trim();
                        node.remove();
                        if (text) {
                            const span = document.createElement('span');
                            span.classList.add('lumina-banner__description-text');
                            span.textContent = text;
                            wrapper.appendChild(span);

                            if (!bannerData.descriptionText) {
                                bannerData.descriptionText = text;
                            }
                        }
                        return;
                    }

                    wrapper.appendChild(node);
                });

                if (wrapper.childNodes.length) {
                    bannerData.descriptionElements.push(wrapper);
                }

                header.remove();
            };

            selectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(harvestHeader);
            });

            return bannerData;
        }

        function initializeGlobalBanner(config = {}) {
            const banner = document.getElementById('luminaBanner');
            if (!banner) {
                return;
            }

            const stored = window.__absorbedBannerData || {};
            const finalConfig = Object.assign({}, stored, config || {});

            finalConfig.titleFragments = (config && config.titleFragments) || stored.titleFragments || [];
            finalConfig.descriptionElements = (config && config.descriptionElements) || stored.descriptionElements || [];

            const includeAbsorbedActions = config && config.includeAbsorbedActions === false ? false : true;
            const providedActions = (config && Array.isArray(config.actions)) ? config.actions.filter(Boolean) : null;
            const baseActions = includeAbsorbedActions ? (Array.isArray(stored.actions) ? stored.actions.slice() : []) : [];

            if (providedActions) {
                const combined = baseActions.concat(providedActions);
                const seen = new Set();
                finalConfig.actions = combined.filter(action => {
                    if (!action) return false;
                    const key = action.id ? `id:${action.id}` : `${action.label || ''}|${action.href || ''}`;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });
            } else {
                finalConfig.actions = baseActions;
            }

            const titleEl = document.getElementById('luminaBannerTitle');
            const descEl = document.getElementById('luminaBannerDescription');
            const eyebrowEl = document.getElementById('luminaBannerEyebrow');
            const eyebrowText = document.getElementById('luminaBannerEyebrowText');
            const dateEl = document.getElementById('luminaBannerDate');
            const dstEl = document.getElementById('luminaBannerDst');
            const campaignMetaEl = document.getElementById('luminaBannerMetaCampaign');
            const campaignValueEl = document.getElementById('luminaBannerCampaign');
            const clientMetaEl = document.getElementById('luminaBannerMetaClient');
            const clientValueEl = document.getElementById('luminaBannerClient');
            const actionsEl = document.getElementById('luminaBannerActions');

            const assignMetaValue = (container, valueElement, value) => {
                if (!valueElement) {
                    return;
                }

                const text = String(value || '').trim();
                if (text) {
                    valueElement.textContent = text;
                    if (container) {
                        container.dataset.empty = 'false';
                        container.style.display = '';
                    }
                } else {
                    valueElement.textContent = '—';
                    if (container) {
                        container.dataset.empty = 'true';
                        container.style.display = 'none';
                    }
                }
            };

            const normalizeMetaValue = (value) => {
                if (value === null || typeof value === 'undefined') {
                    return '';
                }

                return String(value).trim();
            };

            finalConfig.campaignName = normalizeMetaValue(
                (config && config.campaignName !== undefined) ? config.campaignName : stored.campaignName
            );

            finalConfig.clientName = normalizeMetaValue(
                (config && config.clientName !== undefined) ? config.clientName : stored.clientName
            );

            if (!finalConfig.campaignName && __LAYOUT_CAMPAIGN_NAME) {
                finalConfig.campaignName = __LAYOUT_CAMPAIGN_NAME;
            }

            if (!finalConfig.clientName && __LAYOUT_CLIENT_NAME) {
                finalConfig.clientName = __LAYOUT_CLIENT_NAME;
            }

            const resolvedTitle = finalConfig.title || stored.titleText || stored.title || document.title || 'LuminaHQ';
            if (titleEl) {
                if (Array.isArray(finalConfig.titleFragments) && finalConfig.titleFragments.length) {
                    titleEl.innerHTML = '';
                    finalConfig.titleFragments.forEach(fragment => {
                        if (!fragment) return;
                        if (fragment instanceof Node) {
                            titleEl.appendChild(fragment);
                            return;
                        }
                        titleEl.appendChild(document.createTextNode(String(fragment)));
                    });
                } else {
                    titleEl.textContent = String(resolvedTitle || 'LuminaHQ').trim() || 'LuminaHQ';
                }
            }

            if (descEl) {
                const description = finalConfig.description !== undefined
                    ? String(finalConfig.description || '').trim()
                    : String(stored.descriptionText || '').trim();

                let resolvedDescription = description;
                if (!resolvedDescription && (finalConfig.clientName || finalConfig.campaignName)) {
                    const summary = [];
                    if (finalConfig.clientName) {
                        summary.push(finalConfig.clientName);
                    }
                    if (finalConfig.campaignName && finalConfig.campaignName !== finalConfig.clientName) {
                        summary.push(finalConfig.campaignName);
                    }
                    resolvedDescription = summary.join(' • ');
                }

                const fragments = Array.isArray(finalConfig.descriptionElements)
                    ? finalConfig.descriptionElements
                    : [];

                descEl.innerHTML = '';

                let hasContent = false;

                if (resolvedDescription) {
                    const textSpan = document.createElement('span');
                    textSpan.classList.add('lumina-banner__description-text');
                    textSpan.textContent = resolvedDescription;
                    descEl.appendChild(textSpan);
                    hasContent = true;
                }

                fragments.forEach(node => {
                    if (!node) return;
                    if (node instanceof Node) {
                        descEl.appendChild(node);
                        hasContent = true;
                    }
                });

                if (hasContent) {
                    descEl.style.display = '';
                    descEl.dataset.empty = 'false';
                } else {
                    descEl.style.display = 'none';
                    descEl.dataset.empty = 'true';
                }
            }

            if (eyebrowEl && eyebrowText) {
                const eyebrowValue = finalConfig.eyebrow || finalConfig.clientName || finalConfig.campaignName ||
                    stored.clientName || stored.campaignName || stored.eyebrowText || '';
                const fallback = 'Lumina Sheets';
                const text = String(eyebrowValue || fallback).trim();
                eyebrowText.textContent = text;
                eyebrowEl.style.display = text ? 'inline-flex' : 'none';
            }

            assignMetaValue(
                campaignMetaEl,
                campaignValueEl,
                finalConfig.campaignName || stored.campaignName || __LAYOUT_CAMPAIGN_NAME
            );

            assignMetaValue(
                clientMetaEl,
                clientValueEl,
                finalConfig.clientName || stored.clientName || __LAYOUT_CLIENT_NAME
            );

            const refreshMeta = () => {
                const now = new Date();
                if (dateEl) {
                    dateEl.textContent = formatBannerDateTime(now);
                }
                if (dstEl) {
                    const dstInfo = computeBannerDst(now);
                    dstEl.textContent = dstInfo.message;
                    dstEl.setAttribute('data-dst-active', String(dstInfo.isDst));
                }
            };

            refreshMeta();
            if (typeof window !== 'undefined') {
                if (window.__luminaBannerInterval) {
                    clearInterval(window.__luminaBannerInterval);
                }
                window.__luminaBannerInterval = setInterval(refreshMeta, 60000);
            }

            if (actionsEl) {
                actionsEl.innerHTML = '';
                const actions = Array.isArray(finalConfig.actions) ? finalConfig.actions.filter(Boolean) : [];
                const variants = ['primary', 'secondary'];

                actions.forEach((action, index) => {
                    let element = null;
                    let isLink = false;

                    if (action && action.element && action.element instanceof HTMLElement) {
                        element = action.element;
                        isLink = element.tagName.toLowerCase() === 'a';

                        const variant = action.variant || element.getAttribute('data-banner-variant') || variants[Math.min(index, variants.length - 1)] || 'primary';
                        REMOVABLE_BANNER_BUTTON_CLASSES.forEach(cls => element.classList.remove(cls));
                        element.classList.add('lumina-banner__action', `lumina-banner__action--${variant}`);

                        if (!element.hasAttribute('data-banner-action-prepared')) {
                            const labelText = action.label || element.getAttribute('data-banner-label') || element.textContent.trim() || 'Action';
                            const iconClasses = action.icon || element.getAttribute('data-banner-icon') || '';

                            element.innerHTML = '';
                            if (iconClasses) {
                                const iconEl = document.createElement('i');
                                String(iconClasses)
                                    .split(/\s+/)
                                    .filter(Boolean)
                                    .forEach(cls => iconEl.classList.add(cls));
                                element.appendChild(iconEl);
                            }

                            const label = document.createElement('span');
                            label.textContent = labelText;
                            element.appendChild(label);

                            element.setAttribute('data-banner-action-prepared', 'true');
                        }

                        if (!isLink) {
                            element.type = 'button';
                        }

                        if (action && action.id) {
                            element.id = action.id;
                        }

                        if (isLink && action) {
                            if (action.href) element.href = action.href;
                            if (action.target) element.target = action.target;
                            if (action.rel) element.rel = action.rel;
                        }
                    } else {
                        isLink = Boolean(action && action.href);
                        element = document.createElement(isLink ? 'a' : 'button');
                        element.classList.add('lumina-banner__action');

                        const variant = (action && action.variant) || variants[Math.min(index, variants.length - 1)] || 'primary';
                        element.classList.add(`lumina-banner__action--${variant}`);

                        if (!isLink) {
                            element.type = 'button';
                        }

                        if (action && action.id) {
                            element.id = action.id;
                        }

                        if (isLink) {
                            element.href = action.href;
                            if (action.target) {
                                element.target = action.target;
                            }
                            if (action.rel) {
                                element.rel = action.rel;
                            }
                        }

                        if (action && action.className) {
                            element.classList.add(...String(action.className).split(/\s+/).filter(Boolean));
                        }

                        if (action && action.icon) {
                            const iconEl = document.createElement('i');
                            String(action.icon)
                                .split(/\s+/)
                                .filter(Boolean)
                                .forEach(cls => iconEl.classList.add(cls));
                            element.appendChild(iconEl);
                        }

                        const label = document.createElement('span');
                        label.textContent = action && action.label ? String(action.label) : 'Action';
                        element.appendChild(label);
                    }

                    if (action && typeof action.onClick === 'function') {
                        if (!element.hasAttribute('data-banner-action-handler')) {
                            element.addEventListener('click', (event) => {
                                action.onClick.call(element, event);
                            });
                            element.setAttribute('data-banner-action-handler', 'true');
                        }
                    }

                    actionsEl.appendChild(element);
                    ensureBannerActionContrast(element);
                });

                if (actions.length) {
                    banner.setAttribute('data-has-actions', 'true');
                } else {
                    banner.removeAttribute('data-has-actions');
                }
            }
        }

        // ──────────────────────────────────────────────────────────────────────────────
        // SIMPLIFIED HYDRATION SYSTEM
        // ──────────────────────────────────────────────────────────────────────────────
        // SIMPLIFIED HYDRATION SYSTEM
        // ──────────────────────────────────────────────────────────────────────────────
        window.__userHydrated = false;

        function nonEmpty(s) {
            return s != null && String(s).trim().length > 0;
        }

        function isBetterUser(incoming) {
            // Completely reject any data with "lumina" user or email
            if (incoming?.FullName === 'lumina' || 
                incoming?.UserName === 'lumina' || 
                incoming?.Email === 'lumina@vlbpo.com') {
                console.log('🚫 REJECTED: Incoming data contains lumina defaults, completely blocking');
                return false;
            }
            
            // Better user data has meaningful name AND role information
            const hasName = nonEmpty(incoming?.FullName) || nonEmpty(incoming?.UserName);
            const hasRoles = Array.isArray(incoming?.roleNames) && incoming.roleNames.length > 0;
            const hasRoleIds = nonEmpty(incoming?.Roles);
            const isAdmin = incoming?.IsAdmin === true || String(incoming?.IsAdmin).toUpperCase() === 'TRUE';
            
            // Better if it has a proper name AND (roles OR admin status)
            return hasName && (hasRoles || hasRoleIds || isAdmin);
        }

        function formatEmployment(status) {
            const s = (status || '').toLowerCase();
            const map = {
                'active': { cls: 'status-active', icon: 'fas fa-check-circle' },
                'full time': { cls: 'status-active', icon: 'fas fa-check-circle' },
                'full-time': { cls: 'status-active', icon: 'fas fa-check-circle' },
                'inactive': { cls: 'status-inactive', icon: 'fas fa-times-circle' },
                'terminated': { cls: 'status-inactive', icon: 'fas fa-times-circle' },
                'contract': { cls: 'status-contract', icon: 'fas fa-file-contract' },
                'probation': { cls: 'status-probation', icon: 'fas fa-hourglass-half' },
                'on leave': { cls: 'status-leave', icon: 'fas fa-pause-circle' },
                'part time': { cls: 'status-part-time', icon: 'fas fa-clock' },
                'part-time': { cls: 'status-part-time', icon: 'fas fa-clock' },
                'suspended': { cls: 'status-suspended', icon: 'fas fa-ban' }
            };
            return map[s] || { cls: '', icon: 'fas fa-briefcase' };
        }

        function updateUserDisplaySafely(user) {
            if (!user) return;
            
            // 🚫 COMPLETE REJECTION: Block any "lumina" user data entirely
            if (user.FullName === 'lumina' || 
                user.UserName === 'lumina' || 
                user.Email === 'lumina@vlbpo.com') {
                console.log('🚫 COMPLETELY BLOCKED: Incoming user data contains lumina - rejecting entirely');
                return; // Exit immediately - no processing at all
            }
            
            console.log('Attempting to update user display with:', user);
            
            // CRITICAL: Check if user panel was server-rendered with good data
            const userPanel = document.getElementById('userPanel');
            const wasServerRendered = userPanel && userPanel.getAttribute('data-initialized') === 'true';
            const serverName = userPanel ? userPanel.getAttribute('data-name') : '';
            const serverRoles = userPanel ? userPanel.getAttribute('data-roles') : '';
            
            // If server rendered with real data (not defaults), NEVER allow client updates
            if (wasServerRendered && nonEmpty(serverName) && serverName !== 'Unknown User') {
                console.log('🛡️ PROTECTED: Server-rendered user panel has good data, blocking all client updates');
                console.log('Server name:', serverName, 'Server roles:', serverRoles);
                window.__userHydrated = true; // Mark as hydrated to prevent further attempts
                return;
            }
            
            // Additional protection: If current displayed name is real, don't override
            const nameEl = document.getElementById('sidebarUserName') || document.getElementById('userName');
            const currentName = nameEl ? nameEl.textContent : '';
            if (nonEmpty(currentName) && currentName !== 'Unknown User') {
                console.log('🛡️ PROTECTED: Current displayed name is real, blocking override');
                console.log('Current name:', currentName, 'Incoming name:', user.FullName || user.UserName);
                window.__userHydrated = true;
                return;
            }

            // Only update if this is better data or first time AND no good data exists
            if (window.__userHydrated && !isBetterUser(user)) {
                console.log('Rejecting user update - not better than current data');
                return;
            }

            const roleEl = document.getElementById('userRole');
            const empEl = document.getElementById('userEmp');
            const avatar = document.getElementById('userAvatar');

            // Name: only set if provided and not empty AND not any default value
            const bestName = user.FullName || user.UserName;
            if (nonEmpty(bestName) && bestName !== 'Unknown User') {
                if (nameEl) nameEl.textContent = bestName;
                if (avatar) avatar.textContent = bestName.charAt(0).toUpperCase();
                console.log('Updated name to:', bestName);
            } else {
                console.log('Skipping name update - invalid or default value:', bestName);
            }

            // Roles: prefer incoming roleNames; else keep existing
            let roleText = null;
            if (Array.isArray(user.roleNames) && user.roleNames.length) {
                roleText = user.roleNames.join(', ');
                console.log('Using roleNames:', roleText);
            } else if (user.IsAdmin === true || String(user.IsAdmin).toUpperCase() === 'TRUE' || user.isAdminBool === true) {
                roleText = 'System Administrator';
                console.log('Using admin status for role');
            }
            
            if (nonEmpty(roleText) && roleEl) {
                roleEl.textContent = roleText;
                console.log('Updated role to:', roleText);
            }

            // Employment
            if (empEl && (nonEmpty(user.EmploymentStatus) || nonEmpty(user.Country))) {
                const fmt = formatEmployment(user.EmploymentStatus || '');
                const pieces = [];
                if (nonEmpty(user.EmploymentStatus)) {
                    pieces.push(`<i class="${fmt.icon} ${fmt.cls}"></i><span class="${fmt.cls}">${user.EmploymentStatus}</span>`);
                }
                if (nonEmpty(user.Country)) {
                    pieces.push(`<span>• ${user.Country}</span>`);
                }
                if (pieces.length) {
                    empEl.innerHTML = pieces.join(' ');
                    console.log('Updated employment status');
                }
            }

            window.__userHydrated = true;
            console.log('User display updated successfully');
        }

        // ──────────────────────────────────────────────────────────────────────────────
        // SIMPLIFIED LOGOUT FUNCTION
        // ──────────────────────────────────────────────────────────────────────────────
        let logoutFinalizeTimerId = null;
        let logoutFinalizeCompleted = false;

        function stopSessionHeartbeat(reason) {
            try {
                if (window.LuminaSessionHeartbeat && typeof window.LuminaSessionHeartbeat.stop === 'function') {
                    window.LuminaSessionHeartbeat.stop({ clearAuth: true, reason: reason || 'logout' });
                } else if (window.CookieHandler && typeof CookieHandler.clearAuthToken === 'function') {
                    CookieHandler.clearAuthToken();
                }
            } catch (heartbeatError) {
                console.warn('stopSessionHeartbeat: unable to stop session heartbeat', heartbeatError);
            }

            try {
                if (window.localStorage) {
                    localStorage.removeItem('lumina.auth.sessionToken');
                    localStorage.removeItem('lumina.session.token');
                    localStorage.removeItem('lumina.auth.fallbackToken');
                }
            } catch (storageError) {
                console.warn('stopSessionHeartbeat: unable to clear fallback storage', storageError);
            }
        }

        function finalizeLogout(source) {
            if (logoutFinalizeCompleted) {
                console.log('🔁 Logout already finalized, ignoring duplicate finalize from:', source || 'unknown');
                return;
            }

            logoutFinalizeCompleted = true;

            try {
                if (logoutFinalizeTimerId) {
                    clearTimeout(logoutFinalizeTimerId);
                    logoutFinalizeTimerId = null;
                }
            } catch (timerError) {
                console.warn('finalizeLogout: unable to clear pending timer', timerError);
            }

            console.log('🔚 Finalizing logout via:', source || 'unspecified');
            performLogout();
        }

        function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) return;

            const btn = document.querySelector('.logout-btn-topbar');
            if (btn) {
                btn.disabled = true;
                const icon = btn.querySelector('i');
                if (icon) icon.className = 'fas fa-spinner loading-spinner-head';
            }

            console.log('🚪 Initiating logout...');

            logoutFinalizeCompleted = false;
            if (logoutFinalizeTimerId) {
                try {
                    clearTimeout(logoutFinalizeTimerId);
                } catch (clearErr) {
                    console.warn('handleLogout: unable to clear previous logout timer', clearErr);
                }
                logoutFinalizeTimerId = null;
            }

            let sessionToken = '';
            try {
                if (typeof readAuthTokenForGuard === 'function') {
                    sessionToken = readAuthTokenForGuard() || '';
                } else if (window.CookieHandler && typeof window.CookieHandler.readAuthToken === 'function') {
                    sessionToken = window.CookieHandler.readAuthToken() || '';
                }
            } catch (tokenError) {
                console.warn('handleLogout: unable to read session token', tokenError);
            }

            try {
                setLogoutReason('manual');
            } catch (reasonError) {
                console.warn('handleLogout: unable to persist manual logout reason', reasonError);
            }

            if (typeof window !== 'undefined' && typeof window.setTimeout === 'function') {
                try {
                    logoutFinalizeTimerId = window.setTimeout(function handleLogoutTimeout() {
                        console.warn('⌛ Logout request timed out; forcing client-side logout.');
                        finalizeLogout('timeout');
                    }, 7000);
                } catch (timerError) {
                    console.warn('handleLogout: unable to create logout timeout', timerError);
                    logoutFinalizeTimerId = null;
                }
            }

            if (typeof window === 'undefined' || !(window.google && window.google.script && window.google.script.run)) {
                console.warn('handleLogout: google.script.run unavailable, performing client-only logout.');
                finalizeLogout('client-only');
                return;
            }

            // Call server logout
            window.google.script.run
                .withSuccessHandler(function(result) {
                    console.log('✅ Server logout completed:', result);
                    finalizeLogout('server-success');
                })
                .withFailureHandler(function(err) {
                    console.warn('⚠️ Server logout failed, proceeding with client logout:', err);
                    finalizeLogout('server-failure');
                })
                .logout(sessionToken || '');
        }

        function performLogout() {
            console.log('Performing logout...');

            try {
                clearClientAuthState('manual');
            } catch (stateError) {
                console.warn('performLogout: unable to clear client auth state', stateError);
                try {
                    stopSessionHeartbeat('logout-finalize');
                } catch (heartbeatError) {
                    console.warn('performLogout: unable to stop session heartbeat', heartbeatError);
                }
            }

            // Ensure browser storage is cleared even if the auth state reset fails
            try {
                localStorage.clear();
                sessionStorage.clear();
                console.log('Browser storage cleared');
            } catch (e) {
                console.warn('Could not clear storage:', e);
            }

            // Persist the logout reason for downstream messaging
            try {
                setLogoutReason('manual');
            } catch (reasonError) {
                console.warn('performLogout: unable to persist manual logout reason', reasonError);
            }

            // Show logout message and redirect immediately to the login screen
            showLogoutMessage();

            const target = buildLoginUrl({ includeReturn: false, reason: 'manual' }) || BASE_URL || '/';
            try {
                if (window.location && typeof window.location.replace === 'function') {
                    window.location.replace(target);
                } else {
                    window.location.href = target;
                }
            } catch (redirectError) {
                console.warn('performLogout: unable to redirect using replace', redirectError);
                window.location.href = target;
            }
        }

        function showLogoutMessage() {
            if (typeof window.showLuminaToast === 'function') {
                window.showLuminaToast('Logged out successfully', {
                    type: 'success',
                    title: 'Lumina'
                });
                return;
            }

            alert('Logged out successfully');
        }

        // ──────────────────────────────────────────────────────────────────────────────
        // AUTHENTICATION GUARD – PREVENT ACCESS AFTER LOGOUT
        // ──────────────────────────────────────────────────────────────────────────────
        const AUTH_FALLBACK_STORAGE_KEYS = SESSION_TOKEN_STORAGE_KEYS;

        function shouldEnforceAuthGuard() {
            if (window.__LUMINA_DISABLE_AUTH_GUARD === true || window.disableLuminaAuthGuard === true) {
                return false;
            }

            const body = document.body;
            if (body) {
                const publicPageAttr = body.getAttribute('data-public-page');
                if ((body.dataset && body.dataset.publicPage === 'true') || publicPageAttr === 'true') {
                    return false;
                }
            }

            return true;
        }

        function readAuthTokenForGuard() {
            let token = '';

            try {
                if (window.CookieHandler && typeof window.CookieHandler.readAuthToken === 'function') {
                    token = window.CookieHandler.readAuthToken();
                }
            } catch (cookieError) {
                console.warn('AuthGuard: unable to read auth cookie', cookieError);
            }

            if (token) {
                return token;
            }

            try {
                if (window.localStorage) {
                    for (let i = 0; i < AUTH_FALLBACK_STORAGE_KEYS.length; i++) {
                        const key = AUTH_FALLBACK_STORAGE_KEYS[i];
                        const value = window.localStorage.getItem(key);
                        if (value) {
                            token = value;
                            break;
                        }
                    }
                }
            } catch (storageError) {
                console.warn('AuthGuard: unable to read localStorage token', storageError);
            }

            if (token) {
                return token;
            }

            try {
                if (window.sessionStorage) {
                    for (let i = 0; i < AUTH_FALLBACK_STORAGE_KEYS.length; i++) {
                        const key = AUTH_FALLBACK_STORAGE_KEYS[i];
                        const value = window.sessionStorage.getItem(key);
                        if (value) {
                            token = value;
                            break;
                        }
                    }
                }
            } catch (sessionError) {
                console.warn('AuthGuard: unable to read sessionStorage token', sessionError);
            }

            return token;
        }

        function clearClientAuthState(reason) {
            try {
                if (typeof stopSessionHeartbeat === 'function') {
                    stopSessionHeartbeat(reason || 'auth-guard');
                } else if (window.LuminaSessionHeartbeat && typeof window.LuminaSessionHeartbeat.stop === 'function') {
                    window.LuminaSessionHeartbeat.stop({ clearAuth: true, reason: reason || 'auth-guard' });
                }
            } catch (heartbeatError) {
                console.warn('AuthGuard: unable to stop session heartbeat', heartbeatError);
            }

            try {
                if (window.CookieHandler && typeof window.CookieHandler.clearAuthToken === 'function') {
                    window.CookieHandler.clearAuthToken();
                }
            } catch (cookieError) {
                console.warn('AuthGuard: unable to clear auth cookie', cookieError);
            }

            try {
                if (window.localStorage) {
                    AUTH_FALLBACK_STORAGE_KEYS.forEach(key => window.localStorage.removeItem(key));
                }
            } catch (localStorageError) {
                console.warn('AuthGuard: unable to clear localStorage tokens', localStorageError);
            }

            try {
                if (window.sessionStorage) {
                    AUTH_FALLBACK_STORAGE_KEYS.forEach(key => window.sessionStorage.removeItem(key));
                }
            } catch (sessionStorageError) {
                console.warn('AuthGuard: unable to clear sessionStorage tokens', sessionStorageError);
            }

            broadcastSessionTokenChange('');

            try {
                const existingReason = getLogoutReason();
                if (existingReason && existingReason.toLowerCase() === 'manual' && reason !== 'manual') {
                    return;
                }
                setLogoutReason(reason === 'manual' ? 'manual' : 'auto');
            } catch (reasonError) {
                console.warn('AuthGuard: unable to persist logout reason', reasonError);
            }
        }

        function redirectToLogin(options) {
            const opts = options || {};
            if (opts.reason) {
                try {
                    const existingReason = getLogoutReason();
                    if (!(existingReason && existingReason.toLowerCase() === 'manual' && opts.reason !== 'manual')) {
                        setLogoutReason(opts.reason);
                    }
                } catch (reasonError) {
                    console.warn('redirectToLogin: unable to persist logout reason', reasonError);
                }
            }

            const target = buildLoginUrl({
                includeReturn: opts.includeReturn === true,
                returnUrl: opts.returnUrl,
                reason: opts.reason
            }) || '/';
            try {
                if (window.location && typeof window.location.replace === 'function') {
                    window.location.replace(target);
                } else {
                    window.location.href = target;
                }
            } catch (redirectError) {
                console.warn('AuthGuard: redirect failed, attempting fallback', redirectError);
                window.location.href = target;
            }
        }

        function enforceAuthenticatedView(context) {
            if (!shouldEnforceAuthGuard()) {
                return true;
            }

            const token = readAuthTokenForGuard();
            if (token) {
                return true;
            }

            console.log('🔒 AuthGuard: missing auth token, enforcing logout redirect', context);
            clearClientAuthState(context || 'auth-guard');
            const currentLocation = (typeof window !== 'undefined' && window.location && window.location.href)
                ? window.location.href
                : '';
            redirectToLogin({ includeReturn: true, reason: 'auto', returnUrl: currentLocation });
            return false;
        }

        function scheduleAuthGuardCheck(context) {
            if (!shouldEnforceAuthGuard()) {
                return;
            }
            window.setTimeout(function () {
                enforceAuthenticatedView(context);
            }, 0);
        }

        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible') {
                scheduleAuthGuardCheck('visibilitychange');
            }
        });

        window.addEventListener('focus', function () {
            scheduleAuthGuardCheck('window-focus');
        });

        window.addEventListener('pageshow', function (event) {
            if (event && event.persisted) {
                scheduleAuthGuardCheck('history-return');
            } else {
                scheduleAuthGuardCheck('pageshow');
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            scheduleAuthGuardCheck('dom-ready');
        });

        // ──────────────────────────────────────────────────────────────────────────────
        // DOCUMENT READY INITIALIZATION
        // ──────────────────────────────────────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 VLBPO Dashboard initializing...');

            const absorbed = absorbLocalBanners();

            const defaultTitle = <?!= JSON.stringify(__layoutPageTitleText || __layoutCurrentPageName || '') ?>;
            const defaultDescription = <?!= JSON.stringify(__layoutPageDescriptionText || '') ?>;
            const fallbackBannerTitle = <?!= JSON.stringify((__layoutCampaignName || 'LuminaHQ')) ?>;

            const identityPieces = [];
            if (__LAYOUT_CLIENT_NAME) {
                identityPieces.push(__LAYOUT_CLIENT_NAME);
            }
            if (__LAYOUT_CAMPAIGN_NAME && __LAYOUT_CAMPAIGN_NAME !== __LAYOUT_CLIENT_NAME) {
                identityPieces.push(__LAYOUT_CAMPAIGN_NAME);
            }
            const identitySummary = identityPieces.join(' • ');

            const combinedDescription = [defaultDescription, absorbed.descriptionText, identitySummary]
                .map(part => String(part || '').trim())
                .filter(Boolean)
                .join(' • ');

            const initialConfig = {
                title: absorbed.titleText || defaultTitle || fallbackBannerTitle,
                titleFragments: absorbed.titleFragments,
                description: combinedDescription,
                descriptionElements: absorbed.descriptionElements,
                eyebrow: absorbed.eyebrowText,
                campaignName: absorbed.campaignName || <?!= JSON.stringify(__layoutCampaignName || '') ?>,
                clientName: absorbed.clientName || <?!= JSON.stringify(__layoutClientName || '') ?>,
                actions: absorbed.actions
            };

            window.__absorbedBannerData = Object.assign({}, absorbed, {
                titleText: initialConfig.title,
                titleFragments: initialConfig.titleFragments,
                descriptionText: combinedDescription,
                descriptionElements: absorbed.descriptionElements,
                actions: absorbed.actions,
                eyebrowText: initialConfig.eyebrow || absorbed.eyebrowText,
                campaignName: initialConfig.campaignName || absorbed.campaignName || '',
                clientName: initialConfig.clientName || absorbed.clientName || ''
            });

            initializeGlobalBanner(initialConfig);

            const resolvedDocumentTitle = initialConfig.title || document.title || '';
            if (resolvedDocumentTitle) {
                document.title = resolvedDocumentTitle;
            } else if (__LAYOUT_CAMPAIGN_NAME) {
                document.title = __LAYOUT_CAMPAIGN_NAME;
            }

            // Initialize tooltips
            [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(function(tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleButton = document.getElementById('sidebarToggle');
            const mobileToggle = document.getElementById('mobileToggle');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const bodyElement = document.body;
            const mobileBreakpoint = window.matchMedia('(max-width: 1024px)');

            const isMobileSidebar = () => mobileBreakpoint.matches;

            const openMobileSidebar = () => {
                if (!sidebar) return;
                sidebar.classList.add('mobile-open');
                mobileOverlay?.classList.add('active');
                bodyElement.classList.add('sidebar-open');
            };

            const closeMobileSidebar = () => {
                if (!sidebar) return;
                sidebar.classList.remove('mobile-open');
                mobileOverlay?.classList.remove('active');
                bodyElement.classList.remove('sidebar-open');
            };

            const toggleMobileSidebar = () => {
                if (!sidebar) return;
                if (sidebar.classList.contains('mobile-open')) {
                    closeMobileSidebar();
                } else {
                    openMobileSidebar();
                }
            };

            // Sidebar toggle
            if (sidebarToggleButton) {
                sidebarToggleButton.addEventListener('click', function(event) {
                    if (isMobileSidebar()) {
                        event.preventDefault();
                        toggleMobileSidebar();
                        return;
                    }

                    if (!sidebar) {
                        return;
                    }

                    sidebar.classList.toggle('collapsed');
                    localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
                });
            }

            // Mobile toggle
            if (mobileToggle) {
                mobileToggle.addEventListener('click', function(event) {
                    event.preventDefault();
                    toggleMobileSidebar();
                });
            }

            // Mobile overlay close
            mobileOverlay?.addEventListener('click', closeMobileSidebar);

            // Close sidebar when a navigation link is chosen on mobile
            sidebar?.addEventListener('click', function(event) {
                if (!isMobileSidebar()) {
                    return;
                }

                const interactive = event.target && event.target.closest ? event.target.closest('a, button') : null;
                if (!interactive) {
                    return;
                }

                if (interactive.id === 'sidebarToggle') {
                    return;
                }

                closeMobileSidebar();
            });

            // Keyboard accessibility
            window.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeMobileSidebar();
                }
            });

            const handleBreakpointChange = () => {
                if (!isMobileSidebar()) {
                    closeMobileSidebar();
                }
            };

            if (typeof mobileBreakpoint.addEventListener === 'function') {
                mobileBreakpoint.addEventListener('change', handleBreakpointChange);
            } else if (typeof mobileBreakpoint.addListener === 'function') {
                mobileBreakpoint.addListener(handleBreakpointChange);
            }

            handleBreakpointChange();

            // Restore sidebar state for desktop users
            if (sidebar && localStorage.getItem('sidebarCollapsed') === 'true') {
                sidebar.classList.add('collapsed');
            }

            console.log('✅ Lumina Dashboard initialized');

            const setupUserMenu = () => {
                const panel = document.getElementById('userPanel');
                const trigger = document.getElementById('userProfileTrigger');
                const menu = document.getElementById('userPanelMenu');
                if (!panel || !trigger || !menu) {
                    return;
                }

                const closeMenu = () => {
                    if (menu.hidden) {
                        return;
                    }
                    menu.hidden = true;
                    panel.classList.remove('menu-open');
                    trigger.setAttribute('aria-expanded', 'false');
                };

                const openMenu = () => {
                    menu.hidden = false;
                    panel.classList.add('menu-open');
                    trigger.setAttribute('aria-expanded', 'true');
                };

                const toggleMenu = () => {
                    if (menu.hidden) {
                        openMenu();
                    } else {
                        closeMenu();
                    }
                };

                trigger.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    toggleMenu();
                });

                trigger.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        toggleMenu();
                    } else if (event.key === 'Escape') {
                        event.preventDefault();
                        closeMenu();
                    }
                });

                menu.addEventListener('click', function(event) {
                    const item = event.target && event.target.closest ? event.target.closest('.user-panel-menu__item') : null;
                    if (!item) {
                        return;
                    }
                    const action = item.getAttribute('data-menu-action');
                    closeMenu();
                    if (action === 'profile') {
                        if (typeof navigateToPage === 'function') {
                            const profileSlugAttr = panel.getAttribute('data-profile-slug')
                                || panel.getAttribute('data-profile-id')
                                || '';
                            const params = profileSlugAttr ? { profileId: profileSlugAttr } : {};
                            navigateToPage('userprofile', null, params);
                        }
                    } else if (action === 'logout') {
                        if (typeof handleLogout === 'function') {
                            handleLogout();
                        }
                    }
                });

                document.addEventListener('click', function(event) {
                    if (!menu.hidden && !panel.contains(event.target)) {
                        closeMenu();
                    }
                });

                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        closeMenu();
                    }
                });
            };

            setupUserMenu();

            // Mark as hydrated immediately to prevent any client updates
            window.__userHydrated = true;

            // Check if user panel was properly rendered by server
            const userPanel = document.getElementById('userPanel');
            if (userPanel && userPanel.getAttribute('data-initialized') === 'true') {
                const serverName = userPanel.getAttribute('data-name');
                const serverRoles = userPanel.getAttribute('data-roles');
                console.log('✅ Server-rendered user panel detected:', { 
                    name: serverName, 
                    roles: serverRoles 
                });
            } else {
                console.warn('⚠️ User panel not properly initialized by server');
            }
        });

        // ──────────────────────────────────────────────────────────────────────────────
        // GLOBAL FUNCTION AVAILABILITY
        // ──────────────────────────────────────────────────────────────────────────────

        // Make functions available globally
        window.handleLogout = handleLogout;
        window.updateUserDisplaySafely = updateUserDisplaySafely;
        window.initializeGlobalBanner = initializeGlobalBanner;
        window.absorbLocalBanners = absorbLocalBanners;

        document.addEventListener('lumina:banner-update', function(event) {
            if (!event || !event.detail) {
                return;
            }

            initializeGlobalBanner(event.detail || {});
        });

        console.log('✨ Simplified header system loaded successfully');
    </script>
    <script>
        (function initializeLuminaSessionHeartbeat(global) {
            if (!global) {
                return;
            }
            if (global.LuminaSessionHeartbeat) {
                return;
            }

            const MIN_INTERVAL_MS = 60 * 1000;
            const MAX_INTERVAL_MS = 5 * 60 * 1000;
            const DEFAULT_IDLE_MINUTES = 30;
            const FALLBACK_STORAGE_KEY = 'lumina.session.token';

            const state = {
                token: '',
                remember: false,
                idleMinutes: DEFAULT_IDLE_MINUTES,
                ttlSeconds: null,
                expiresAt: null,
                timer: null,
                intervalMs: null,
                nextRunAt: null,
                inFlight: false,
                consecutiveFailures: 0,
                started: false,
                lastResult: null
            };

            function dispatchStatus(status, detail) {
                const payload = Object.assign({
                    status: status,
                    timestamp: new Date().toISOString()
                }, detail || {});

                try {
                    const event = new CustomEvent('lumina:session-status', { detail: payload });
                    global.dispatchEvent(event);
                } catch (err) {
                    try {
                        if (typeof document !== 'undefined' && typeof document.createEvent === 'function') {
                            const fallbackEvent = document.createEvent('CustomEvent');
                            fallbackEvent.initCustomEvent('lumina:session-status', true, true, payload);
                            global.dispatchEvent(fallbackEvent);
                        }
                    } catch (fallbackError) {
                        if (global.console && typeof global.console.warn === 'function') {
                            console.warn('LuminaSessionHeartbeat: unable to dispatch session-status event', fallbackError);
                        }
                    }
                }
            }

            function readTokenFromStorage() {
                let token = '';

                try {
                    if (global.CookieHandler && typeof global.CookieHandler.readAuthToken === 'function') {
                        token = global.CookieHandler.readAuthToken();
                    }
                } catch (err) {
                    if (global.console && typeof global.console.warn === 'function') {
                        console.warn('LuminaSessionHeartbeat: unable to read auth cookie', err);
                    }
                }

                if (!token) {
                    try {
                        if (global.localStorage) {
                            token = global.localStorage.getItem(FALLBACK_STORAGE_KEY) || '';
                        }
                    } catch (storageError) {
                        if (global.console && typeof global.console.warn === 'function') {
                            console.warn('LuminaSessionHeartbeat: unable to read fallback token', storageError);
                        }
                    }
                }

                return token || '';
            }

            function persistToken(token, options) {
                if (!token) {
                    clearToken(options);
                    return '';
                }

                try {
                    if (global.CookieHandler && typeof global.CookieHandler.persistAuthToken === 'function') {
                        global.CookieHandler.persistAuthToken(token, options || {});
                    }
                } catch (err) {
                    if (global.console && typeof global.console.warn === 'function') {
                        console.warn('LuminaSessionHeartbeat: unable to persist auth cookie', err);
                    }
                }

                try {
                    if (global.localStorage) {
                        global.localStorage.setItem(FALLBACK_STORAGE_KEY, token);
                    }
                } catch (storageError) {
                    if (global.console && typeof global.console.warn === 'function') {
                        console.warn('LuminaSessionHeartbeat: unable to persist fallback token', storageError);
                    }
                }

                state.token = token;
                try {
                    broadcastSessionTokenChange(token);
                } catch (broadcastError) {
                    if (global.console && typeof global.console.warn === 'function') {
                        console.warn('LuminaSessionHeartbeat: unable to broadcast persisted token', broadcastError);
                    }
                }
                return token;
            }

            function clearToken(options) {
                try {
                    if (global.CookieHandler && typeof global.CookieHandler.clearAuthToken === 'function') {
                        global.CookieHandler.clearAuthToken(options || {});
                    }
                } catch (err) {
                    if (global.console && typeof global.console.warn === 'function') {
                        console.warn('LuminaSessionHeartbeat: unable to clear auth cookie', err);
                    }
                }

                try {
                    if (global.localStorage) {
                        global.localStorage.removeItem(FALLBACK_STORAGE_KEY);
                    }
                } catch (storageError) {
                    if (global.console && typeof global.console.warn === 'function') {
                        console.warn('LuminaSessionHeartbeat: unable to clear fallback token', storageError);
                    }
                }

                state.token = '';
                try {
                    broadcastSessionTokenChange('');
                } catch (broadcastError) {
                    if (global.console && typeof global.console.warn === 'function') {
                        console.warn('LuminaSessionHeartbeat: unable to broadcast cleared token', broadcastError);
                    }
                }
            }

            function clearTimer() {
                if (state.timer) {
                    global.clearTimeout(state.timer);
                    state.timer = null;
                }
            }

            function computeIdleMs() {
                const minutes = (typeof state.idleMinutes === 'number' && state.idleMinutes > 0)
                    ? state.idleMinutes
                    : DEFAULT_IDLE_MINUTES;
                return Math.max(1, minutes) * 60 * 1000;
            }

            function computeNextInterval() {
                const idleMs = computeIdleMs();
                let interval = Math.max(MIN_INTERVAL_MS, Math.floor(idleMs / 2));
                let ttlMs = null;

                if (typeof state.ttlSeconds === 'number' && state.ttlSeconds > 0) {
                    ttlMs = state.ttlSeconds * 1000;
                } else if (state.expiresAt) {
                    const expiry = Date.parse(state.expiresAt);
                    if (!isNaN(expiry)) {
                        ttlMs = Math.max(0, expiry - Date.now());
                    }
                }

                if (ttlMs !== null && ttlMs > 0) {
                    interval = Math.min(interval, Math.max(MIN_INTERVAL_MS, Math.floor(ttlMs / 2)));
                }

                const safetyWindow = Math.max(MIN_INTERVAL_MS, Math.floor(idleMs * 0.2));
                interval = Math.min(interval, Math.max(MIN_INTERVAL_MS, idleMs - safetyWindow));
                interval = Math.min(Math.max(interval, MIN_INTERVAL_MS), MAX_INTERVAL_MS);
                return interval;
            }

            function schedule(nextMs) {
                const delay = Math.min(Math.max(MIN_INTERVAL_MS, Math.floor(nextMs || MIN_INTERVAL_MS)), MAX_INTERVAL_MS);
                clearTimer();
                state.intervalMs = delay;
                state.nextRunAt = Date.now() + delay;
                state.timer = global.setTimeout(runHeartbeat, delay);
                return delay;
            }

            function notifyExpired(message) {
                const text = message || 'Your session has expired after 30 minutes of inactivity. Please sign in again to continue.';

                try {
                    if (typeof global.showLuminaToast === 'function') {
                        global.showLuminaToast(text, {
                            type: 'info',
                            title: 'Session Expired'
                        });
                        return;
                    }
                } catch (err) {
                    if (global.console && typeof global.console.warn === 'function') {
                        console.warn('LuminaSessionHeartbeat: toast notification failed', err);
                    }
                }

                try {
                    if (typeof global.alert === 'function') {
                        global.alert(text);
                    }
                } catch (alertError) {
                    if (global.console && typeof global.console.warn === 'function') {
                        console.warn('LuminaSessionHeartbeat: unable to display alert', alertError);
                    }
                }
            }

            function redirectToLogin() {
                const current = (global.location && global.location.href) ? global.location.href : '';
                if (global && typeof global.redirectToLogin === 'function') {
                    try {
                        global.redirectToLogin({ includeReturn: true, reason: 'auto', returnUrl: current });
                        return;
                    } catch (delegationError) {
                        if (global.console && typeof global.console.warn === 'function') {
                            console.warn('LuminaSessionHeartbeat: global redirectToLogin failed', delegationError);
                        }
                    }
                }

                const target = (typeof global.buildLoginUrl === 'function')
                    ? global.buildLoginUrl({ includeReturn: true, reason: 'auto', returnUrl: current })
                    : (global.__LUMINA_LOGIN_URL || global.LOGIN_URL || global.BASE_URL || (global.location ? global.location.href : '/'));

                global.setTimeout(function () {
                    try {
                        global.location.href = target;
                    } catch (err) {
                        if (global.console && typeof global.console.warn === 'function') {
                            console.warn('LuminaSessionHeartbeat: redirect failed', err);
                        }
                    }
                }, 500);
            }

            function stop(options) {
                const opts = options || {};
                clearTimer();
                state.started = false;
                state.inFlight = false;
                state.intervalMs = null;
                state.nextRunAt = null;

                if (opts.clearAuth) {
                    clearToken(opts);
                }

                if (!opts.silent) {
                    dispatchStatus('stopped', {
                        reason: opts.reason || 'manual'
                    });
                }

                return true;
            }

            function handleExpired(result) {
                const reason = result && result.reason ? String(result.reason) : 'EXPIRED';
                dispatchStatus('expired', {
                    result: result,
                    reason: reason
                });
                stop({ clearAuth: true, reason: reason, silent: true });
                notifyExpired(result && result.message ? result.message : 'Your session has expired. Please sign in again.');
                redirectToLogin({ includeReturn: true, reason: 'auto', returnUrl: (global.location && global.location.href) || '' });
            }

            function handleSuccess(result) {
                state.inFlight = false;

                if (!result || result.success !== true) {
                    if (result && result.expired) {
                        handleExpired(result);
                        return;
                    }
                    handleFailure(result || new Error('Unexpected keep-alive response'));
                    return;
                }

                state.lastResult = result;
                state.consecutiveFailures = 0;

                const resolvedIdle = (typeof result.idleTimeoutMinutes === 'number' && result.idleTimeoutMinutes > 0)
                    ? result.idleTimeoutMinutes
                    : (typeof result.sessionIdleTimeoutMinutes === 'number' && result.sessionIdleTimeoutMinutes > 0
                        ? result.sessionIdleTimeoutMinutes
                        : state.idleMinutes);
                state.idleMinutes = Math.max(1, Math.round(resolvedIdle));

                if (typeof result.rememberMe === 'boolean') {
                    state.remember = result.rememberMe;
                }

                if (typeof result.sessionTtlSeconds === 'number' && result.sessionTtlSeconds > 0) {
                    state.ttlSeconds = result.sessionTtlSeconds;
                }
                if (result.sessionExpiresAt) {
                    state.expiresAt = result.sessionExpiresAt;
                }

                const token = result.sessionToken || state.token || readTokenFromStorage();
                if (token) {
                    persistToken(token, {
                        rememberMe: state.remember,
                        ttlSeconds: state.ttlSeconds,
                        expiresAt: state.expiresAt
                    });
                }

                const nextDelay = computeNextInterval();
                schedule(nextDelay);

                dispatchStatus('active', {
                    result: result,
                    nextRunInMs: nextDelay,
                    idleTimeoutMinutes: state.idleMinutes
                });
            }

            function handleFailure(error) {
                state.inFlight = false;
                state.consecutiveFailures += 1;

                const base = state.intervalMs || computeNextInterval();
                const multiplier = Math.min(5, 1 + state.consecutiveFailures * 0.5);
                const nextDelay = Math.min(MAX_INTERVAL_MS, Math.max(MIN_INTERVAL_MS, Math.floor(base * multiplier)));

                schedule(nextDelay);

                dispatchStatus('error', {
                    error: error && error.message ? error.message : error,
                    consecutiveFailures: state.consecutiveFailures,
                    nextRunInMs: nextDelay
                });
            }

            function runHeartbeat() {
                if (!state.started) {
                    return;
                }

                if (state.inFlight) {
                    return;
                }

                const token = state.token || readTokenFromStorage();
                if (!token) {
                    dispatchStatus('missing-token', { message: 'No session token available' });
                    stop({ clearAuth: true, reason: 'missing-token', silent: true });
                    notifyExpired('Your session has ended. Please sign in again.');
                    redirectToLogin({ includeReturn: true, reason: 'auto', returnUrl: (global.location && global.location.href) || '' });
                    return;
                }

                state.token = token;

                if (!global.google || !global.google.script || !global.google.script.run) {
                    dispatchStatus('unavailable', { message: 'google.script.run not ready' });
                    schedule(MAX_INTERVAL_MS);
                    return;
                }

                state.inFlight = true;
                try {
                    global.google.script.run
                        .withSuccessHandler(handleSuccess)
                        .withFailureHandler(handleFailure)
                        .keepAlive(token);
                } catch (err) {
                    state.inFlight = false;
                    handleFailure(err);
                }
            }

            function start(options) {
                const opts = options || {};
                const token = opts.token || state.token || readTokenFromStorage();
                if (!token) {
                    dispatchStatus('missing-token', { message: 'No session token available' });
                    return false;
                }

                state.token = token;
                state.started = true;

                if (typeof opts.rememberMe === 'boolean') {
                    state.remember = opts.rememberMe;
                }
                if (typeof opts.idleTimeoutMinutes === 'number' && opts.idleTimeoutMinutes > 0) {
                    state.idleMinutes = Math.max(1, Math.round(opts.idleTimeoutMinutes));
                }
                if (typeof opts.sessionTtlSeconds === 'number' && opts.sessionTtlSeconds > 0) {
                    state.ttlSeconds = opts.sessionTtlSeconds;
                }
                if (opts.sessionExpiresAt) {
                    state.expiresAt = opts.sessionExpiresAt;
                }

                const initialDelay = computeNextInterval();
                const scheduled = schedule(opts.immediate === true ? MIN_INTERVAL_MS : initialDelay);

                if (opts.immediate === true) {
                    global.setTimeout(runHeartbeat, 100);
                }

                dispatchStatus('started', {
                    idleTimeoutMinutes: state.idleMinutes,
                    nextRunInMs: scheduled,
                    rememberMe: state.remember
                });

                return true;
            }

            function refreshFromResult(result) {
                if (!result) {
                    return;
                }

                if (typeof result.idleTimeoutMinutes === 'number' && result.idleTimeoutMinutes > 0) {
                    state.idleMinutes = Math.max(1, Math.round(result.idleTimeoutMinutes));
                } else if (typeof result.sessionIdleTimeoutMinutes === 'number' && result.sessionIdleTimeoutMinutes > 0) {
                    state.idleMinutes = Math.max(1, Math.round(result.sessionIdleTimeoutMinutes));
                }

                if (typeof result.rememberMe === 'boolean') {
                    state.remember = result.rememberMe;
                }

                if (typeof result.sessionTtlSeconds === 'number' && result.sessionTtlSeconds > 0) {
                    state.ttlSeconds = result.sessionTtlSeconds;
                }
                if (result.sessionExpiresAt) {
                    state.expiresAt = result.sessionExpiresAt;
                }

                if (result.sessionToken) {
                    persistToken(result.sessionToken, {
                        rememberMe: state.remember,
                        ttlSeconds: state.ttlSeconds,
                        expiresAt: state.expiresAt
                    });
                }

                if (!state.started) {
                    start({
                        token: state.token,
                        rememberMe: state.remember,
                        idleTimeoutMinutes: state.idleMinutes,
                        sessionTtlSeconds: state.ttlSeconds,
                        sessionExpiresAt: state.expiresAt,
                        immediate: true
                    });
                    return;
                }

                const nextDelay = computeNextInterval();
                schedule(nextDelay);

                dispatchStatus('refreshed', {
                    result: result,
                    nextRunInMs: nextDelay
                });
            }

            function runNow() {
                clearTimer();
                if (!state.started) {
                    const token = state.token || readTokenFromStorage();
                    if (!token) {
                        dispatchStatus('missing-token', { message: 'No session token available' });
                        return false;
                    }
                    state.started = true;
                    state.token = token;
                }
                runHeartbeat();
                return true;
            }

            function getState() {
                return Object.assign({}, state);
            }

            global.LuminaSessionHeartbeat = {
                start: start,
                stop: stop,
                refreshFromResult: refreshFromResult,
                runNow: runNow,
                persistToken: persistToken,
                getState: getState
            };

            const initialToken = readTokenFromStorage();
            if (initialToken) {
                state.token = initialToken;
                start({ token: initialToken });
            } else {
                dispatchStatus('missing-token', { message: 'No session token found at initialization' });
            }

            global.addEventListener('lumina:session-refresh', function (event) {
                try {
                    refreshFromResult(event && event.detail ? event.detail : null);
                } catch (err) {
                    if (global.console && typeof global.console.warn === 'function') {
                        console.warn('LuminaSessionHeartbeat: session-refresh handler failed', err);
                    }
                }
            });

            global.addEventListener('lumina:session-start', function (event) {
                try {
                    start(event && event.detail ? event.detail : {});
                } catch (err) {
                    if (global.console && typeof global.console.warn === 'function') {
                        console.warn('LuminaSessionHeartbeat: session-start handler failed', err);
                    }
                }
            });

            global.addEventListener('lumina:session-stop', function (event) {
                try {
                    stop(event && event.detail ? event.detail : {});
                } catch (err) {
                    if (global.console && typeof global.console.warn === 'function') {
                        console.warn('LuminaSessionHeartbeat: session-stop handler failed', err);
                    }
                }
            });

            global.addEventListener('lumina:session-force-heartbeat', function () {
                runNow();
            });
        })(typeof window !== 'undefined' ? window : this);
    </script>
    <script>
        (function registerGlobalChannelClosedHandler() {
            var CHANNEL_CLOSED_REGEX = /message channel closed/i;
            var ASYNC_RESPONSE_REGEX = /listener indicated an asynchronous response/i;

            function isGoogleChannelClosure(message) {
                if (!message) {
                    return false;
                }
                var normalized = String(message);
                return CHANNEL_CLOSED_REGEX.test(normalized) || ASYNC_RESPONSE_REGEX.test(normalized);
            }

            window.addEventListener('unhandledrejection', function (event) {
                if (!event || typeof event.preventDefault !== 'function') {
                    return;
                }

                var reason = event.reason;
                var message = (reason && reason.message) ? reason.message : String(reason || '');

                if (isGoogleChannelClosure(message)) {
                    if (window.console && typeof console.debug === 'function') {
                        console.debug('Suppressed benign google.script.run channel closure:', message);
                    }
                    event.preventDefault();
                }
            });
        })();
    </script>
