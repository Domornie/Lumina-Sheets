<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base target="_top">

  <!-- jQuery (single include) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Modern CSS Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Notify.js (jQuery plugin) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.min.js"></script>

  <?
    function __layoutSlugify(value) {
      if (!value) {
        return '';
      }

      var source = String(value);
      source = source.replace(/["'`]+/g, '');

      try {
        if (source.normalize) {
          source = source.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
        }
      } catch (slugErr) {
        // Ignore normalization issues and continue with original value
      }

      return source
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/-{2,}/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(0, 80);
    }

    var __layoutPageSlugInput = (typeof pageSlug !== 'undefined' && pageSlug) ? pageSlug : '';
    var __layoutCurrentPageName = (typeof currentPage !== 'undefined' && currentPage) ? currentPage : '';
    var __layoutPageTitleText = (typeof pageTitle !== 'undefined' && pageTitle) ? pageTitle : '';
    var __layoutPageDescriptionText = (typeof pageDescription !== 'undefined' && pageDescription) ? pageDescription : '';

    var __layoutSlugCandidate = __layoutSlugify(__layoutPageSlugInput) ||
      __layoutSlugify(__layoutCurrentPageName) ||
      __layoutSlugify(__layoutPageTitleText);

    var __layoutSlugSources = [
      __layoutPageSlugInput,
      __layoutCurrentPageName,
      __layoutPageTitleText,
      __layoutSlugCandidate
    ];

    var __layoutRawReturnUrl = (typeof returnUrl !== 'undefined' && returnUrl) ? returnUrl : '';

    var __layoutInvalidPanelPattern = /usercodeapppanel/i;

    function __layoutNormalizeUrlValue(value) {
      if (value === null || typeof value === 'undefined') {
        return '';
      }

      var trimmed = String(value).trim();
      if (!trimmed || trimmed.toLowerCase() === 'undefined') {
        return '';
      }

      return trimmed;
    }

    function __layoutFixPanelUrl(value) {
      var normalized = __layoutNormalizeUrlValue(value);
      if (!normalized) {
        return '';
      }

      if (!__layoutInvalidPanelPattern.test(normalized)) {
        return normalized;
      }

      return normalized.replace(/\/userCodeAppPanel.*$/i, '/exec');
    }

    function __layoutSanitizeNavigationUrl(url, fallback) {
      var primary = __layoutFixPanelUrl(url);
      if (primary) {
        return primary;
      }

      return __layoutFixPanelUrl(fallback);
    }

    var __layoutRawBaseUrl = (typeof baseUrl !== 'undefined') ? baseUrl : '';
    var __layoutRawScriptUrl = (typeof scriptUrl !== 'undefined') ? scriptUrl : __layoutRawBaseUrl;

    var __layoutSanitizedBaseUrl = __layoutSanitizeNavigationUrl(__layoutRawBaseUrl, __layoutRawScriptUrl);
    var __layoutSanitizedScriptUrl = __layoutSanitizeNavigationUrl(__layoutRawScriptUrl, __layoutRawBaseUrl);

    baseUrl = __layoutSanitizedBaseUrl || __layoutSanitizedScriptUrl || baseUrl;

    if (typeof scriptUrl !== 'undefined') {
      scriptUrl = __layoutSanitizedScriptUrl || __layoutSanitizedBaseUrl || scriptUrl;
    }
  ?>

  <style>
    /* Make sure notifications float above modals/menus */
    .notifyjs-corner {
      z-index: 99999 !important;
    }

    :root {
      --lumina-primary: #0052cc;
      --lumina-primary-dark: #003d99;
      --lumina-primary-light: rgba(0, 82, 204, 0.12);
      --lumina-success: #00875a;
      --lumina-warning: #ffab00;
      --lumina-danger: #de350b;
      --lumina-info: #0747a6;
      --lumina-surface: #ffffff;
      --lumina-border-radius: 12px;
      --lumina-shadow: 0 4px 12px rgba(15, 23, 42, 0.12);

      /* Shared alert + spacing tokens */
      --border-radius-sm: 12px;
      --spacing-sm: 0.75rem;
      --spacing-md: 1.25rem;
      --spacing-lg: 1.75rem;
      --success: var(--lumina-success);
      --warning: var(--lumina-warning);
      --danger: var(--lumina-danger);
      --info: var(--lumina-info);
    }

    /* Unified inline alert appearance */
    .alert,
    .alert-modern {
      border: none;
      border-radius: var(--border-radius-sm);
      padding: var(--spacing-md);
      border-left: 4px solid var(--info);
      margin-bottom: var(--spacing-md);
      background: rgba(7, 71, 166, 0.08);
      color: var(--info);
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-sm);
    }

    .alert.alert-success,
    .alert-success,
    .alert-modern.alert-success,
    .alert-success-modern {
      background: rgba(0, 135, 90, 0.1);
      border-left-color: var(--success);
      color: var(--success);
    }

    .alert.alert-warning,
    .alert-warning,
    .alert-modern.alert-warning,
    .alert-warning-modern {
      background: rgba(255, 171, 0, 0.1);
      border-left-color: var(--warning);
      color: var(--warning);
    }

    .alert.alert-danger,
    .alert-danger,
    .alert-modern.alert-danger,
    .alert-danger-modern {
      background: rgba(222, 53, 11, 0.1);
      border-left-color: var(--danger);
      color: var(--danger);
    }

    .alert.alert-info,
    .alert-info,
    .alert-modern.alert-info,
    .alert-info-modern {
      background: rgba(7, 71, 166, 0.1);
      border-left-color: var(--info);
      color: var(--info);
    }

    .alert .alert-close,
    .alert-modern .alert-close {
      position: absolute;
      top: 0.5rem;
      right: 0.75rem;
      border: none;
      background: transparent;
      font-size: 1.25rem;
      line-height: 1;
      color: currentColor;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }

    .alert .alert-close:hover,
    .alert .alert-close:focus,
    .alert-modern .alert-close:hover,
    .alert-modern .alert-close:focus {
      opacity: 1;
    }

    .lumina-toast-container {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 1100;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: stretch;
      max-width: calc(100vw - 2rem);
      pointer-events: none;
    }

    .lumina-toast-container .toast {
      pointer-events: auto;
      border: none;
      border-radius: var(--lumina-border-radius);
      min-width: 320px;
      max-width: 420px;
      overflow: hidden;
      box-shadow: var(--lumina-shadow);
      background: var(--lumina-surface);
    }

    .lumina-toast-container .toast-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 600;
      border-bottom: none;
      padding: 0.85rem 1rem;
    }

    .lumina-toast-container .toast-header i {
      font-size: 1.1rem;
    }

    .lumina-toast-container .toast-body {
      color: #1f2937;
      font-size: 0.95rem;
      padding: 1rem 1.05rem 1.15rem;
      background: linear-gradient(180deg, rgba(248, 250, 252, 0.8) 0%, rgba(226, 232, 240, 0.35) 100%);
    }

    .lumina-toast-container .btn-close {
      filter: brightness(0) invert(1);
      opacity: 0.9;
    }

    .lumina-toast-container .btn-close:hover {
      opacity: 1;
    }

    @media (max-width: 575.98px) {
      .lumina-toast-container {
        top: 1rem;
        right: 0.75rem;
        left: 0.75rem;
        max-width: none;
      }

      .lumina-toast-container .toast {
        width: 100%;
        min-width: 0;
      }
    }

  </style>

  <script>
    // Base URLs for navigation
    let BASE_URL = '<?= baseUrl ?>';
    let SCRIPT_URL = '<?= scriptUrl || baseUrl ?>';

    const __PAGE_SLUG_SOURCES = <?!= JSON.stringify(__layoutSlugSources) ?>;
    const __RAW_RETURN_URL = <?!= JSON.stringify(__layoutRawReturnUrl) ?>;

    const __invalidPanelPattern = /usercodeapppanel/i;

    function sanitizeNavigationUrl(url, fallback) {
      const normalize = value => {
        if (value === null || typeof value === 'undefined') return '';
        const trimmed = String(value).trim();
        if (!trimmed || trimmed.toLowerCase() === 'undefined') return '';
        return trimmed;
      };

      const fixPanel = value => {
        if (!value) return '';
        if (!__invalidPanelPattern.test(value)) {
          return value;
        }
        return value.replace(/\/userCodeAppPanel.*$/i, '/exec');
      };

      const primary = fixPanel(normalize(url));
      if (primary) {
        return primary;
      }

      return fixPanel(normalize(fallback));
    }

    const __BASE_URL = sanitizeNavigationUrl(BASE_URL, SCRIPT_URL);
    const __SCRIPT_URL = sanitizeNavigationUrl(SCRIPT_URL, BASE_URL);

    BASE_URL = __BASE_URL || __SCRIPT_URL || BASE_URL;
    SCRIPT_URL = __SCRIPT_URL || __BASE_URL || SCRIPT_URL;

    function createSlug(value, fallback) {
      const queue = [];

      const enqueue = (input) => {
        if (typeof input === 'undefined' || input === null) {
          return;
        }

        if (Array.isArray(input)) {
          input.forEach(enqueue);
          return;
        }

        queue.push(String(input));
      };

      enqueue(value);
      enqueue(fallback);

      while (queue.length) {
        let candidate = queue.shift().trim();
        if (!candidate) {
          continue;
        }

        try {
          if (candidate.normalize) {
            candidate = candidate.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
          }
        } catch (err) {
          console.warn('Slug normalization failed:', err);
        }

        const slug = candidate
          .replace(/["'`]+/g, '')
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/-{2,}/g, '-')
          .replace(/^-+|-+$/g, '')
          .slice(0, 80);

        if (slug) {
          return slug;
        }
      }

      return '';
    }

    const PAGE_SLUG = createSlug(__PAGE_SLUG_SOURCES);

    /**
     * Generate URLs for navigation
     */
    function generateUrl(page, _campaign = null, additionalParams = {}) {
      // _campaign is kept for backward compatibility but intentionally unused to avoid exposing it in URLs
      let url = BASE_URL || SCRIPT_URL;
      const params = new URLSearchParams();

      if (page) {
        params.set('page', page);
      }

      // Add any additional parameters
      Object.entries(additionalParams).forEach(([key, value]) => {
        if (value !== null && value !== undefined) {
          params.set(key, value);
        }
      });
      
      const queryString = params.toString();
      return queryString ? `${url}?${queryString}` : url;
    }

    /**
     * Navigate to a page
     */
    function navigateToPage(page, _campaign = null, additionalParams = {}) {
      const url = generateUrl(page, _campaign, additionalParams);
      window.location.href = url;
    }

    function deriveReturnUrl(rawUrl, slug) {
      const sanitizedRaw = sanitizeNavigationUrl(rawUrl, '');
      if (sanitizedRaw) {
        return sanitizedRaw;
      }

      if (slug) {
        return generateUrl(slug);
      }

      return BASE_URL || SCRIPT_URL || '';
    }

    const RETURN_URL = deriveReturnUrl(__RAW_RETURN_URL, PAGE_SLUG);

    function buildReturnUrl(extraParams = {}, rawUrl = RETURN_URL) {
      const base = deriveReturnUrl(rawUrl, PAGE_SLUG);
      if (!extraParams || typeof extraParams !== 'object' || Array.isArray(extraParams)) {
        return base;
      }

      try {
        const url = new URL(base, window.location.origin);
        const params = new URLSearchParams(url.search);

        Object.entries(extraParams).forEach(([key, value]) => {
          if (value === null || typeof value === 'undefined') {
            params.delete(key);
            return;
          }

          params.set(key, value);
        });

        url.search = params.toString();
        return url.toString();
      } catch (err) {
        console.warn('Failed to build return URL, falling back to base value:', err);
        return base;
      }
    }

    const __applySlugMetadata = () => {
      if (typeof document === 'undefined' || !document.body) {
        return;
      }

      try {
        document.body.dataset.pageSlug = PAGE_SLUG || '';
        if (RETURN_URL) {
          document.body.dataset.returnUrl = RETURN_URL;
        } else {
          delete document.body.dataset.returnUrl;
        }
      } catch (err) {
        console.warn('Unable to apply slug/return data attributes:', err);
      }
    };

    if (typeof document !== 'undefined') {
      if (document.body) {
        __applySlugMetadata();
      } else {
        try {
          document.addEventListener('DOMContentLoaded', __applySlugMetadata, { once: true });
        } catch (err) {
          document.addEventListener('DOMContentLoaded', __applySlugMetadata, false);
        }
      }
    }

    // Make utilities available globally
    window.generateUrl = generateUrl;
    window.navigateToPage = navigateToPage;
    window.createSlug = createSlug;
    window.pageSlug = PAGE_SLUG;
    window.returnUrl = RETURN_URL;
    window.deriveReturnUrl = (rawUrl, slug = PAGE_SLUG) => deriveReturnUrl(rawUrl, slug);
    window.buildReturnUrl = buildReturnUrl;
    window.getReturnUrl = buildReturnUrl;
  </script>

  <script>
    (function() {
      const toneMap = {
        success: {
          icon: 'check-circle',
          headerClass: 'bg-success text-white',
          title: 'Success'
        },
        danger: {
          icon: 'exclamation-circle',
          headerClass: 'bg-danger text-white',
          title: 'Attention needed'
        },
        warning: {
          icon: 'exclamation-triangle',
          headerClass: 'bg-warning text-dark',
          title: 'Heads up'
        },
        info: {
          icon: 'info-circle',
          headerClass: 'bg-info text-white',
          title: 'FYI'
        }
      };

      const pendingQueue = [];

      function coerceMessage(message) {
        if (message === null || typeof message === 'undefined') {
          return '';
        }

        if (message instanceof Error) {
          return message.message;
        }

        if (typeof message === 'object') {
          try {
            return JSON.stringify(message);
          } catch (err) {
            console.warn('Unable to stringify toast message object', err);
            return String(message);
          }
        }

        return String(message);
      }

      function normalizeType(type) {
        if (!type) return 'info';
        const normalized = String(type).trim().toLowerCase();
        if (normalized === 'error') {
          return 'danger';
        }
        if (toneMap[normalized]) {
          return normalized;
        }
        return 'info';
      }

      function ensureToastContainer() {
        if (typeof document === 'undefined') {
          return null;
        }

        let container = document.getElementById('luminaToastContainer');
        if (container) {
          return container;
        }

        if (!document.body) {
          return null;
        }

        container = document.createElement('div');
        container.id = 'luminaToastContainer';
        container.className = 'lumina-toast-container';
        container.setAttribute('aria-live', 'polite');
        container.setAttribute('aria-atomic', 'true');
        document.body.appendChild(container);
        return container;
      }

      function buildToastMarkup(message, options) {
        const id = `lumina-toast-${Date.now()}-${Math.random().toString(16).slice(2, 8)}`;
        const tone = toneMap[options.type] || toneMap.info;
        const title = options.title || tone.title;
        const icon = options.icon || tone.icon;
        const headerClass = options.headerClass || tone.headerClass;

        return {
          id,
          html: `
            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" id="${id}">
              <div class="toast-header ${headerClass}">
                <i class="fas fa-${icon}"></i>
                <span class="me-auto">${title}</span>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
              <div class="toast-body">${message}</div>
            </div>
          `
        };
      }

      function mountToast(container, markup, options) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = markup.html.trim();
        const toastElement = wrapper.firstElementChild;
        if (!toastElement) {
          return;
        }

        container.prepend(toastElement);

        const delay = Number.isFinite(options.delay) ? Number(options.delay) : 4500;
        const autohide = options.autohide !== false;

        const closeButton = toastElement.querySelector('[data-bs-dismiss="toast"]');
        if (closeButton) {
          closeButton.addEventListener('click', () => {
            toastElement.classList.remove('show');
            setTimeout(() => toastElement.remove(), 150);
          });
        }

        if (window.bootstrap && typeof window.bootstrap.Toast === 'function') {
          const toast = new window.bootstrap.Toast(toastElement, { autohide, delay });
          toast.show();
          toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
          });
        } else {
          toastElement.classList.add('show');
          if (autohide) {
            setTimeout(() => {
              toastElement.classList.remove('show');
              setTimeout(() => toastElement.remove(), 300);
            }, delay);
          }
        }
      }

      function processQueue() {
        const container = ensureToastContainer();
        if (!container || !pendingQueue.length) {
          return;
        }

        const items = pendingQueue.splice(0, pendingQueue.length);
        items.forEach(({ message, options }) => {
          const markup = buildToastMarkup(message, options);
          mountToast(container, markup, options);
        });
      }

      function showLuminaToast(message, typeOrOptions, maybeOptions) {
        const text = coerceMessage(message);
        if (!text) {
          return;
        }

        let options = {};
        if (typeof typeOrOptions === 'string') {
          options = Object.assign({}, maybeOptions || {}, { type: typeOrOptions });
        } else if (typeOrOptions && typeof typeOrOptions === 'object') {
          options = Object.assign({}, typeOrOptions);
        } else if (maybeOptions && typeof maybeOptions === 'object') {
          options = Object.assign({}, maybeOptions);
        }

        options.type = normalizeType(options.type);
        if (typeof options.title === 'string') {
          options.title = options.title.trim();
        }
        if (!options.title) {
          options.title = 'Lumina';
        }

        const container = ensureToastContainer();
        if (!container) {
          pendingQueue.push({ message: text, options });
          return;
        }

        const markup = buildToastMarkup(text, options);
        mountToast(container, markup, options);
      }

      window.showLuminaToast = showLuminaToast;
      window.showLuminaNotification = showLuminaToast;
      window.luminaNotify = function(message, type = 'info', opts = {}) {
        const options = Object.assign({}, opts, { type });
        showLuminaToast(message, options);
      };

      if (typeof document !== 'undefined') {
        try {
          document.addEventListener('DOMContentLoaded', processQueue);
        } catch (err) {
          document.addEventListener('DOMContentLoaded', processQueue, false);
        }
      }
    })();
  </script>

  <style>
    :root {
      /* Enhanced Modern Color Palette */
      --sidebar-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      --sidebar-text: #f8fafc;
      --sidebar-text-muted: #cbd5e1;
      --sidebar-hover: rgba(255, 255, 255, 0.1);
      --sidebar-active: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      --primary: #0ea5e9;
      --primary-dark: #0284c7;
      --primary-light: #38bdf8;
      --accent: #22d3ee;
      --warning: #f59e0b;
      --danger: #ef4444;
      --success: #10b981;
      --info: #3b82f6;
      --light: #f8fafc;
      --dark: #0f172a;
      --surface: #ffffff;
      --surface-variant: #f1f5f9;
      --outline: #e2e8f0;
      --shadow: rgba(15, 23, 42, 0.1);
      --shadow-hover: rgba(15, 23, 42, 0.2);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);

      --sidebar-width: 320px;
      --sidebar-collapsed: 80px;
      --topbar-height: 72px;
      --border-radius: 20px;
      --border-radius-sm: 12px;
      --border-radius-xs: 8px;
      --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', "Google Sans", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, var(--surface-variant) 0%, #ffffff 100%);
      color: #1e293b;
      overflow-x: hidden;
      font-size: 14px;
      line-height: 1.6;
      font-weight: 400;
    }

    /* Enhanced Sidebar with Glassmorphism */
    #sidebar {
      width: var(--sidebar-width);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background: var(--sidebar-bg);
      backdrop-filter: blur(20px);
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      transition: var(--transition-smooth);
      box-shadow: 8px 0 32px rgba(15, 23, 42, 0.2);
      overflow: hidden;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    #sidebar::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="0.5" fill="rgba(255,255,255,0.02)"/><circle cx="25" cy="25" r="0.3" fill="rgba(255,255,255,0.01)"/><circle cx="75" cy="75" r="0.4" fill="rgba(255,255,255,0.015)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      pointer-events: none;
      opacity: 0.6;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
      opacity: 0.3;
    }

    .header .container {
      position: relative;
      z-index: 1;
    }

    #sidebar.collapsed {
      width: var(--sidebar-collapsed);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
      position: relative;
      z-index: 2;
    }

    #sidebar .sidebar-content {
      overflow-y: auto !important;
    }

    .sidebar-content::-webkit-scrollbar {
      width: 8px;
    }

    .sidebar-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.4));
      border-radius: 4px;
      transition: var(--transition-fast);
    }

    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.5));
    }

    #sidebar.collapsed .sidebar-content::-webkit-scrollbar {
      width: 0px;
    }

    #sidebar.collapsed .sidebar-content {
      scrollbar-width: none;
    }

    /* Enhanced Logo Section */
    .sidebar-logo {
      display: flex;
      align-items: center;
      padding: 1.5rem 1.25rem;
      cursor: pointer;
      position: relative;
      transition: var(--transition-smooth);
      min-height: 80px;
      z-index: 3;
      backdrop-filter: blur(10px);
    }

    .sidebar-logo::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.05), transparent);
      opacity: 0;
      transition: var(--transition-smooth);
    }

    .sidebar-logo:hover::before {
      opacity: 1;
    }

    .sidebar-logo:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-1px);
    }

    .logo-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--border-radius-xs);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      object-fit: contain;
      padding: 6px;
      transition: var(--transition-smooth);
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
    }

    .sidebar-logo:hover .logo-icon {
      transform: scale(1.05) rotate(2deg);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }

    .logo-text-container {
      margin-left: 1rem;
      overflow: hidden;
      transition: var(--transition-smooth);
      flex: 1;
      display: flex;
      align-items: center;
    }

    .logo-text {
      height: 42px;
      width: auto;
      max-width: 220px;
      object-fit: contain;
      transition: var(--transition-smooth);
      font-weight: 800;
      filter: brightness(1.1);
    }

    .logo-text-fallback {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--sidebar-text);
      letter-spacing: -0.5px;
      line-height: 1.2;
      display: none;
      background: linear-gradient(135deg, #ffffff, #e2e8f0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .logo-text-fallback .brand-accent {
      color: var(--primary-light);
      font-weight: 900;
      text-shadow: 0 0 20px rgba(56, 189, 248, 0.5);
    }

    #sidebar.collapsed .logo-text-container {
      opacity: 0;
      visibility: hidden;
      width: 0;
      margin-left: 0;
      overflow: hidden;
    }

    #sidebar.collapsed .sidebar-logo {
      justify-content: center;
      padding: 1rem;
    }

    #sidebar.collapsed .logo-icon {
      margin: 0;
    }

    /* Enhanced Campaign Header */
    .campaign-header-sidebar {
      transition: var(--transition-smooth);
      position: relative;
      z-index: 3;
    }

    .campaign-badge-sidebar {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1.5rem 1rem 1.25rem;
      border-radius: 0;
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-align: center;
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.3);
      transition: var(--transition-smooth);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      height: 4.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 1.5rem;
    }

    .campaign-badge-sidebar::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
      transform: translateX(-100%);
      transition: transform 0.6s ease;
    }

    .campaign-badge-sidebar:hover::before {
      transform: translateX(100%);
    }

    .campaign-badge-sidebar i {
      margin-right: 0.75rem;
      font-size: 1rem;
      opacity: 0.9;
    }

    #sidebar.collapsed .campaign-header-sidebar {
      opacity: 0;
      visibility: hidden;
      height: 0;
      padding: 0;
      margin: 0;
      overflow: hidden;
    }

    /* Enhanced Category Sections */
    .sidebar-category {
      margin-bottom: 2rem;
      position: relative;
      z-index: 2;
    }

    .category-header {
      padding: 1rem 1.5rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--sidebar-text-muted);
      letter-spacing: 1px;
      position: relative;
      transition: var(--transition-smooth);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: rgba(255, 255, 255, 0.02);
      margin-bottom: 0.25rem;
    }

    .category-header i {
      font-size: 1rem;
      opacity: 0.8;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .category-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 1rem;
      right: 1rem;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: var(--transition-smooth);
    }

    #sidebar.collapsed .category-header {
      opacity: 0;
      visibility: hidden;
      height: 0;
      padding: 0;
      margin: 0;
      overflow: hidden;
    }

    #sidebar.collapsed .category-header::after {
      display: none;
    }

    .sidebar-group {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
      padding: 0 1rem;
      transition: var(--transition-smooth);
    }

    #sidebar.collapsed .sidebar-group {
      padding: 0 0.75rem;
    }

    .sidebar-group a {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.25rem;
      color: var(--sidebar-text);
      border-radius: var(--border-radius-sm);
      transition: var(--transition-smooth);
      text-decoration: none;
      white-space: nowrap;
      position: relative;
      font-weight: 500;
      font-size: 0.875rem;
      overflow: hidden;
      border: 1px solid transparent;
    }

    .sidebar-group a::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      transform: scaleY(0);
      transition: transform 0.3s ease;
      border-radius: 0 2px 2px 0;
    }

    .sidebar-group a::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), transparent);
      opacity: 0;
      transition: var(--transition-smooth);
    }

    .sidebar-group a:hover {
      background: var(--sidebar-hover);
      color: var(--sidebar-text);
      transform: translateX(6px);
      border-color: rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .sidebar-group a:hover::after {
      opacity: 1;
    }

    .sidebar-group a:hover::before {
      transform: scaleY(1);
    }

    .sidebar-group a.active {
      background: var(--sidebar-active);
      color: white;
      box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
      transform: translateX(6px);
      border-color: rgba(255, 255, 255, 0.2);
      font-weight: 600;
    }

    .sidebar-group a.active::before {
      transform: scaleY(1);
      background: rgba(255, 255, 255, 0.8);
    }

    .sidebar-group a i {
      width: 1.75rem;
      text-align: center;
      margin-right: 1rem;
      font-size: 1.125rem;
      transition: var(--transition-smooth);
      flex-shrink: 0;
      opacity: 0.9;
    }

    .sidebar-group a:hover i {
      transform: scale(1.1);
      opacity: 1;
    }

    .sidebar-group a.active i {
      opacity: 1;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .sidebar-group a span {
      transition: var(--transition-smooth);
      overflow: hidden;
      font-weight: 500;
    }

    #sidebar.collapsed .sidebar-group a {
      justify-content: center;
      padding: 1rem;
      margin: 0.25rem 0;
      transform: none;
    }

    #sidebar.collapsed .sidebar-group a:hover {
      transform: none;
    }

    #sidebar.collapsed .sidebar-group a.active {
      transform: none;
    }

    #sidebar.collapsed .sidebar-group a span {
      opacity: 0;
      visibility: hidden;
      width: 0;
      margin: 0;
      padding: 0;
    }

    #sidebar.collapsed .sidebar-group a i {
      margin-right: 0;
      font-size: 1.25rem;
    }

    /* Enhanced Global Pages Section */
    .global-section {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: auto;
      padding-top: 1.5rem;
      position: relative;
      z-index: 2;
    }

    .global-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 1rem;
      right: 1rem;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    }

    /* Enhanced User Panel with Employment Info and Role Display */
    .user-panel {
      margin-top: auto;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(15px);
      transition: var(--transition-smooth);
      position: relative;
      z-index: 3;
    }

    .user-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 1rem;
      right: 1rem;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    }

    .user-avatar-side {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--sidebar-active);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 1.25rem;
      box-shadow: 0 4px 16px rgba(14, 165, 233, 0.4);
      flex-shrink: 0;
      border: 2px solid rgba(255, 255, 255, 0.2);
      transition: var(--transition-smooth);
    }

    .user-panel:hover .user-avatar-side {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(14, 165, 233, 0.5);
    }

    .user-info {
      margin-left: 1rem;
      line-height: 1.4;
      overflow: hidden;
      flex: 1;
      transition: var(--transition-smooth);
    }

    .user-info .names {
      font-size: 1rem;
      color: var(--sidebar-text);
      font-weight: 700;
      margin-bottom: 0.25rem;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }

    .user-info .role {
      font-size: 0.8rem;
      color: var(--sidebar-text-muted);
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      margin-bottom: 0.375rem;
      font-weight: 500;
    }

    .user-info .employment-status {
      font-size: 0.75rem;
      color: var(--sidebar-text-muted);
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-weight: 500;
    }

    .user-info .employment-status i {
      font-size: 0.7rem;
      opacity: 0.9;
      margin-right: 0.25rem;
    }

    /* Enhanced Employment Status Colors */
    .user-info .employment-status .status-active {
      color: #4ade80;
      text-shadow: 0 0 8px rgba(74, 222, 128, 0.3);
    }

    .user-info .employment-status .status-inactive {
      color: #f87171;
      text-shadow: 0 0 8px rgba(248, 113, 113, 0.3);
    }

    .user-info .employment-status .status-contract {
      color: #60a5fa;
      text-shadow: 0 0 8px rgba(96, 165, 250, 0.3);
    }

    .user-info .employment-status .status-probation {
      color: #fbbf24;
      text-shadow: 0 0 8px rgba(251, 191, 36, 0.3);
    }

    .user-info .employment-status .status-leave {
      color: #a78bfa;
      text-shadow: 0 0 8px rgba(167, 139, 250, 0.3);
    }

    .user-info .employment-status .status-terminated {
      color: #ef4444;
      text-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
    }

    .user-info .employment-status .status-suspended {
      color: #6b7280;
      text-shadow: 0 0 8px rgba(107, 114, 128, 0.3);
    }

    .user-info .employment-status .status-part-time {
      color: #34d399;
      text-shadow: 0 0 8px rgba(52, 211, 153, 0.3);
    }

    .user-info .employment-status .status-full-time {
      color: #10b981;
      text-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
    }

    #sidebar.collapsed .user-info {
      opacity: 0;
      visibility: hidden;
      width: 0;
      margin: 0;
    }

    /* Enhanced Topbar */
    #topbar {
      position: fixed;
      top: 0;
      left: var(--sidebar-width);
      right: 0;
      height: var(--topbar-height);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--outline);
      z-index: 999;
      display: flex;
      align-items: center;
      padding: 0 2rem;
      transition: var(--transition-smooth);
      box-shadow: 0 1px 3px var(--shadow);
    }

    #sidebar.collapsed~#topbar {
      left: var(--sidebar-collapsed);
    }

    .topbar-toggle {
      background: none;
      border: none;
      font-size: 1.25rem;
      color: #64748b;
      padding: 0.75rem;
      border-radius: 50%;
      transition: var(--transition-smooth);
      margin-right: 1.5rem;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .topbar-toggle:hover {
      background: rgba(100, 116, 139, 0.1);
      color: var(--primary);
      transform: scale(1.05);
    }

    .breadcrumb-nav {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: #64748b;
      font-size: 0.95rem;
      font-weight: 500;
    }

    .breadcrumb-nav .current-page {
      color: #1e293b;
      font-weight: 700;
      font-size: 1.125rem;
    }

    .breadcrumb-nav i {
      opacity: 0.6;
      font-size: 0.875rem;
    }

    .top-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .notification-btn {
      position: relative;
      background: none;
      border: none;
      font-size: 1.25rem;
      color: #64748b;
      padding: 0.75rem;
      border-radius: 50%;
      transition: var(--transition-smooth);
      text-decoration: none;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(248, 250, 252, 0.8);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(226, 232, 240, 0.5);
    }

    .notification-btn:hover {
      background: rgba(14, 165, 233, 0.1);
      color: var(--primary);
      text-decoration: none;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
      border-color: rgba(14, 165, 233, 0.3);
    }

    .notification-badge {
      position: absolute;
      top: 0.375rem;
      right: 0.375rem;
      width: 10px;
      height: 10px;
      background: linear-gradient(135deg, var(--danger), #dc2626);
      border-radius: 50%;
      border: 2px solid var(--surface);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

    /* Enhanced Topbar Logout Button */
    .logout-btn-topbar {
      position: relative;
      background: rgba(248, 250, 252, 0.8);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(226, 232, 240, 0.5);
      font-size: 1.25rem;
      color: #64748b;
      padding: 0.75rem;
      border-radius: 50%;
      transition: var(--transition-smooth);
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .logout-btn-topbar:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.3);
    }

    .logout-btn-topbar:active {
      transform: translateY(-1px);
    }

    .logout-btn-topbar:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .logout-btn-topbar .loading-spinner-head {
      animation: spin 1s linear infinite;
    }

    /* Mobile responsiveness for top actions */
    @media (max-width: 768px) {
      .top-actions {
        gap: 0.5rem;
      }

      .notification-btn,
      .logout-btn-topbar {
        width: 44px;
        height: 44px;
        font-size: 1.125rem;
      }

      #topbar {
        padding: 0 1rem;
      }
    }

    @media (max-width: 480px) {
      .top-actions .notification-btn:not(.logout-btn-topbar):first-child {
        display: none;
      }
    }

    #maincontent {
      margin-left: calc(var(--sidebar-width) + 2rem);
      margin-top: calc(var(--topbar-height) + 2rem);
      margin-right: 2rem;
      margin-bottom: 2rem;
      transition: var(--transition-smooth);
      min-height: calc(100vh - var(--topbar-height) - 4rem);
    }

    #sidebar.collapsed~#maincontent {
      margin-left: calc(var(--sidebar-collapsed) + 2rem);
    }

    /* Unified global page banner */
    .lumina-banner {
      position: relative;
      background: radial-gradient(140% 120% at 0% 0%, rgba(99, 102, 241, 0.45) 0%, rgba(14, 116, 144, 0) 55%),
        radial-gradient(120% 140% at 100% 0%, rgba(45, 212, 191, 0.35) 0%, rgba(15, 23, 42, 0) 60%),
        linear-gradient(135deg, rgba(2, 6, 23, 0.92) 0%, rgba(15, 23, 42, 0.92) 100%);
      border: 1px solid rgba(148, 163, 184, 0.28);
      border-radius: 32px;
      padding: clamp(1.75rem, 3vw, 2.85rem);
      margin-bottom: 2.5rem;
      box-shadow: 0 30px 60px -40px rgba(15, 23, 42, 0.85);
      color: #e2e8f0;
      overflow: hidden;
      backdrop-filter: blur(8px);
    }

    .lumina-banner::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(148, 163, 184, 0.18) 0%, rgba(59, 130, 246, 0.1) 45%, transparent 100%);
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .lumina-banner::after {
      content: '';
      position: absolute;
      inset: 1px;
      border-radius: 30px;
      border: 1px solid rgba(226, 232, 240, 0.18);
      pointer-events: none;
    }

    .lumina-banner__content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: clamp(1.5rem, 3vw, 3.25rem);
    }

    .lumina-banner__main {
      flex: 1 1 360px;
      min-width: 260px;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .lumina-banner__eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      font-weight: 700;
      color: rgba(226, 232, 240, 0.78);
      background: rgba(15, 23, 42, 0.45);
      padding: 0.45rem 0.95rem;
      border-radius: 999px;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.35);
    }

    .lumina-banner__eyebrow i {
      color: #38bdf8;
    }

    .lumina-banner__title-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .lumina-banner__title {
      font-size: clamp(2rem, 4vw, 2.85rem);
      font-weight: 700;
      margin: 0;
      color: #f8fafc;
      letter-spacing: -0.01em;
    }

    .lumina-banner__description {
      margin: 0;
      font-size: 1.05rem;
      line-height: 1.65;
      color: rgba(226, 232, 240, 0.82);
      max-width: 70ch;
    }

    .lumina-banner__actions {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .lumina-banner__actions:empty {
      display: none;
    }

    .lumina-banner__action {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      border-radius: 999px;
      padding: 0.65rem 1.5rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      text-decoration: none;
      border: 1px solid transparent;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, border 0.2s ease;
      box-shadow: 0 14px 30px -22px rgba(99, 102, 241, 0.9);
    }

    .lumina-banner__action i {
      font-size: 0.95rem;
    }

    .lumina-banner__action--primary {
      background: linear-gradient(120deg, #6366f1 0%, #22d3ee 100%);
      color: #0f172a;
      border-color: rgba(125, 211, 252, 0.55);
      box-shadow: 0 18px 40px -22px rgba(34, 211, 238, 0.9);
    }

    .lumina-banner__action--primary:hover,
    .lumina-banner__action--primary:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 22px 50px -20px rgba(34, 211, 238, 0.95);
    }

    .lumina-banner__action--secondary {
      background: rgba(148, 163, 184, 0.14);
      border-color: rgba(148, 163, 184, 0.4);
      color: #e2e8f0;
    }

    .lumina-banner__action--secondary:hover,
    .lumina-banner__action--secondary:focus-visible {
      background: rgba(148, 163, 184, 0.22);
      transform: translateY(-1px);
    }

    .lumina-banner__action:focus-visible {
      outline: 2px solid rgba(148, 163, 184, 0.55);
      outline-offset: 2px;
    }

    .lumina-banner__meta {
      flex: 0 0 280px;
      min-width: 240px;
      display: grid;
      gap: 1.1rem;
      background: rgba(15, 23, 42, 0.55);
      border-radius: 26px;
      padding: 1.4rem 1.6rem;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.25);
      backdrop-filter: blur(10px);
    }

    .lumina-banner__meta-item {
      display: grid;
      gap: 0.45rem;
    }

    .lumina-banner__meta-label {
      font-size: 0.72rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.78);
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .lumina-banner__meta-value {
      font-size: 1.05rem;
      font-weight: 600;
      color: #f8fafc;
      line-height: 1.55;
    }

    .lumina-banner__meta-value[data-dst-active="true"] {
      color: #34d399;
    }

    .lumina-banner__meta-value[data-dst-active="false"] {
      color: #facc15;
    }

    @media (max-width: 1200px) {
      .lumina-banner__meta {
        flex: 1 1 100%;
        width: 100%;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
    }

    @media (max-width: 900px) {
      .lumina-banner {
        padding: 1.75rem;
        border-radius: 26px;
      }

      .lumina-banner__title-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .lumina-banner__actions {
        width: 100%;
      }

      .lumina-banner__actions .lumina-banner__action {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 640px) {
      .lumina-banner__meta {
        padding: 1.1rem 1.25rem;
      }

      .lumina-banner__title {
        font-size: clamp(1.75rem, 6vw, 2.35rem);
      }
    }

    @media (max-width: 520px) {
      .lumina-banner__meta-label {
        font-size: 0.68rem;
      }

      .lumina-banner__meta-value {
        font-size: 0.95rem;
      }
    }

    /* Loading spinner */
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }
  </style>
  <?!= include('layoutLoader') ?>
  <?!= include('EntityLoader') ?>
</head>

<body
  data-page-slug="<?!= __layoutSlugCandidate ?>"
  data-return-url="<?!= __layoutRawReturnUrl ?>"
>
  <?
    // Shared layout context so navigation components can stay in sync
    var __layoutUser = (typeof safeUser !== 'undefined' && safeUser) ? safeUser : (typeof user !== 'undefined' ? user : {});

    if (__layoutUser && __layoutUser.ID && typeof createSafeUserObject === 'function') {
      try {
        __layoutUser = createSafeUserObject(__layoutUser);
      } catch (err) {
        console.error('Error creating safe user object:', err);
        if (!__layoutUser.roleNames || !__layoutUser.roleNames.length) {
          try {
            if (typeof getUserRolesSafe === 'function') {
              var __layoutResolvedRoles = getUserRolesSafe(__layoutUser.ID);
              __layoutUser.roleNames = (__layoutResolvedRoles || []).map(function(role) {
                return role && role.name ? role.name : '';
              }).filter(function(name) { return Boolean(name); });
            }
          } catch (innerErr) {
            console.error('Manual role resolution failed:', innerErr);
            __layoutUser.roleNames = [];
          }
        }
      }
    }

    var __layoutIsAdmin = (
      __layoutUser && (
        __layoutUser.IsAdmin === true ||
        String(__layoutUser.IsAdmin).toUpperCase() === 'TRUE' ||
        __layoutUser.isAdminBool === true
      )
    );

    var __layoutCampaignId = (__layoutUser && __layoutUser.CampaignID) ? __layoutUser.CampaignID : '';
    var __layoutCampaignName = (__layoutUser && (__layoutUser.campaignName || __layoutUser.CampaignName)) ?
      (__layoutUser.campaignName || __layoutUser.CampaignName) : '';

    var __layoutRoleNames = [];
    if (Array.isArray(__layoutUser && __layoutUser.roleNames) && __layoutUser.roleNames.length) {
      __layoutRoleNames = __layoutUser.roleNames;
    } else if (__layoutUser && __layoutUser.ID && typeof getUserRolesSafe === 'function') {
      try {
        var __layoutResolvedRoles = getUserRolesSafe(__layoutUser.ID) || [];
        __layoutRoleNames = __layoutResolvedRoles
          .map(function (role) { return role && role.name ? role.name : ''; })
          .filter(function (name) { return Boolean(name); });
      } catch (resolveRolesErr) {
        console.error('layout: failed to resolve roles from database', resolveRolesErr);
        __layoutRoleNames = [];
      }
    } else if (__layoutIsAdmin) {
      __layoutRoleNames = ['System Administrator'];
    }

    function __layoutFormatEmployment(status) {
      if (!status) {
        return { status: '', cls: '', icon: 'fas fa-briefcase' };
      }
      var normalized = String(status).toLowerCase();
      var mapping = {
        'active': ['status-active', 'fas fa-check-circle'],
        'full time': ['status-active', 'fas fa-check-circle'],
        'full-time': ['status-active', 'fas fa-check-circle'],
        'inactive': ['status-inactive', 'fas fa-times-circle'],
        'terminated': ['status-inactive', 'fas fa-times-circle'],
        'contract': ['status-contract', 'fas fa-file-contract'],
        'probation': ['status-probation', 'fas fa-hourglass-half'],
        'on leave': ['status-leave', 'fas fa-pause-circle'],
        'part time': ['status-part-time', 'fas fa-clock'],
        'part-time': ['status-part-time', 'fas fa-clock'],
        'suspended': ['status-suspended', 'fas fa-ban']
      };
      var resolved = mapping[normalized] || null;
      return {
        status: status,
        cls: resolved ? resolved[0] : '',
        icon: resolved ? resolved[1] : 'fas fa-briefcase'
      };
    }

    var __layoutEmploymentMeta = __layoutFormatEmployment(__layoutUser ? __layoutUser.EmploymentStatus : '');

    var __layoutNavigation = { categories: [], uncategorizedPages: [] };
    if (__layoutCampaignId) {
      try {
        if (typeof clientGetCampaignNavigation === 'function') {
          __layoutNavigation = clientGetCampaignNavigation(__layoutCampaignId) || __layoutNavigation;
        } else if (__layoutUser && __layoutUser.campaignNavigation) {
          __layoutNavigation = __layoutUser.campaignNavigation;
        }
      } catch (navErr) {
        console.error('Error getting campaign navigation:', navErr);
      }
    }
  ?>

  <div class="mobile-overlay" id="mobileOverlay"></div>

  <?!= include('navigationSidebar', {
        baseUrl: (typeof baseUrl !== 'undefined') ? baseUrl : '',
        scriptUrl: (typeof scriptUrl !== 'undefined') ? scriptUrl : ((typeof baseUrl !== 'undefined') ? baseUrl : ''),
        currentPage: typeof currentPage !== 'undefined' ? currentPage : '',
        user: __layoutUser || {},
        isAdmin: __layoutIsAdmin,
        campaignId: __layoutCampaignId,
        campaignName: __layoutCampaignName,
        roleNames: __layoutRoleNames,
        navigation: __layoutNavigation,
        employmentMeta: __layoutEmploymentMeta
      }) ?>

  <?!= include('navigationTopbar', {
        baseUrl: (typeof baseUrl !== 'undefined') ? baseUrl : '',
        scriptUrl: (typeof scriptUrl !== 'undefined') ? scriptUrl : ((typeof baseUrl !== 'undefined') ? baseUrl : ''),
        currentPage: typeof currentPage !== 'undefined' ? currentPage : '',
        campaignName: __layoutCampaignName,
        isAdmin: __layoutIsAdmin
      }) ?>

  
  <div id="maincontent" class="animate-in main-content">

    <section class="lumina-banner" id="luminaBanner" aria-label="Page overview">
      <div class="lumina-banner__content">
        <div class="lumina-banner__main">
          <div class="lumina-banner__eyebrow" id="luminaBannerEyebrow">
            <i class="fa-solid fa-sun"></i>
            <span id="luminaBannerEyebrowText">Lumina Sheets</span>
          </div>
          <div class="lumina-banner__title-row">
            <h1 class="lumina-banner__title" id="luminaBannerTitle">LuminaHQ</h1>
            <div class="lumina-banner__actions" id="luminaBannerActions" aria-label="Banner actions"></div>
          </div>
          <p class="lumina-banner__description" id="luminaBannerDescription"></p>
        </div>
        <div class="lumina-banner__meta">
          <div class="lumina-banner__meta-item">
            <div class="lumina-banner__meta-label"><i class="fa-regular fa-calendar"></i> Today</div>
            <div class="lumina-banner__meta-value" id="luminaBannerDate" aria-live="polite">—</div>
          </div>
          <div class="lumina-banner__meta-item">
            <div class="lumina-banner__meta-label"><i class="fa-regular fa-clock"></i> Daylight Saving</div>
            <div class="lumina-banner__meta-value" id="luminaBannerDst" aria-live="polite" data-dst-active="false">—</div>
          </div>
        </div>
      </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function formatBannerDateTime(date) {
            try {
                const dateFormatter = new Intl.DateTimeFormat(undefined, {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric'
                });
                const timeFormatter = new Intl.DateTimeFormat(undefined, {
                    hour: 'numeric',
                    minute: '2-digit'
                });
                const tzFormatter = new Intl.DateTimeFormat(undefined, { timeZoneName: 'short' });
                const tzPart = tzFormatter.formatToParts(date).find(part => part.type === 'timeZoneName');
                const tzLabel = tzPart ? ` (${tzPart.value})` : '';
                return `${dateFormatter.format(date)} • ${timeFormatter.format(date)}${tzLabel}`;
            } catch (err) {
                console.warn('Unable to format banner date/time', err);
                return date.toLocaleString();
            }
        }

        function computeBannerDst(date) {
            try {
                const options = Intl.DateTimeFormat().resolvedOptions();
                const january = new Date(date.getFullYear(), 0, 1);
                const july = new Date(date.getFullYear(), 6, 1);
                const standardOffset = Math.max(january.getTimezoneOffset(), july.getTimezoneOffset());
                const isDst = date.getTimezoneOffset() < standardOffset;
                const timeZone = options.timeZone || '';
                const statusText = isDst ? 'Daylight Saving Time is active' : 'Daylight Saving Time is not active';
                return {
                    isDst,
                    timeZone,
                    message: `${statusText}${timeZone ? ` (${timeZone})` : ''}`
                };
            } catch (err) {
                console.warn('Unable to compute DST status', err);
                return {
                    isDst: false,
                    timeZone: '',
                    message: 'Daylight Saving Time status unavailable'
                };
            }
        }

        function initializeGlobalBanner(config = {}) {
            const banner = document.getElementById('luminaBanner');
            if (!banner) {
                return;
            }

            const titleEl = document.getElementById('luminaBannerTitle');
            const descEl = document.getElementById('luminaBannerDescription');
            const eyebrowEl = document.getElementById('luminaBannerEyebrow');
            const eyebrowText = document.getElementById('luminaBannerEyebrowText');
            const dateEl = document.getElementById('luminaBannerDate');
            const dstEl = document.getElementById('luminaBannerDst');
            const actionsEl = document.getElementById('luminaBannerActions');
            const resolvedTitle = config.title || document.title || 'LuminaHQ';
            if (titleEl) {
                titleEl.textContent = resolvedTitle.trim() || 'LuminaHQ';
            }

            if (descEl) {
                const description = config.description ? String(config.description).trim() : '';
                if (description) {
                    descEl.textContent = description;
                    descEl.style.display = '';
                } else {
                    descEl.textContent = '';
                    descEl.style.display = 'none';
                }
            }

            if (eyebrowEl && eyebrowText) {
                const eyebrowValue = config.eyebrow || config.campaignName || '';
                const fallback = 'Lumina Sheets';
                const text = String(eyebrowValue || fallback).trim();
                eyebrowText.textContent = text;
                eyebrowEl.style.display = text ? 'inline-flex' : 'none';
            }

            const refreshMeta = () => {
                const now = new Date();
                if (dateEl) {
                    dateEl.textContent = formatBannerDateTime(now);
                }
                if (dstEl) {
                    const dstInfo = computeBannerDst(now);
                    dstEl.textContent = dstInfo.message;
                    dstEl.setAttribute('data-dst-active', String(dstInfo.isDst));
                }
            };

            refreshMeta();
            if (typeof window !== 'undefined') {
                if (window.__luminaBannerInterval) {
                    clearInterval(window.__luminaBannerInterval);
                }
                window.__luminaBannerInterval = setInterval(refreshMeta, 60000);
            }

            if (actionsEl) {
                actionsEl.innerHTML = '';
                const actions = Array.isArray(config.actions) ? config.actions.filter(Boolean) : [];
                const variants = ['primary', 'secondary'];

                actions.forEach((action, index) => {
                    const isLink = Boolean(action && action.href);
                    const element = document.createElement(isLink ? 'a' : 'button');
                    element.classList.add('lumina-banner__action');

                    const variant = (action && action.variant) || variants[Math.min(index, variants.length - 1)] || 'primary';
                    element.classList.add(`lumina-banner__action--${variant}`);

                    if (!isLink) {
                        element.type = 'button';
                    }

                    if (action && action.id) {
                        element.id = action.id;
                    }

                    if (isLink) {
                        element.href = action.href;
                        if (action.target) {
                            element.target = action.target;
                        }
                        if (action.rel) {
                            element.rel = action.rel;
                        }
                    }

                    if (action && action.className) {
                        element.classList.add(...String(action.className).split(/\s+/).filter(Boolean));
                    }

                    if (action && action.icon) {
                        const iconEl = document.createElement('i');
                        String(action.icon)
                            .split(/\s+/)
                            .filter(Boolean)
                            .forEach(cls => iconEl.classList.add(cls));
                        element.appendChild(iconEl);
                    }

                    const label = document.createElement('span');
                    label.textContent = action && action.label ? String(action.label) : 'Action';
                    element.appendChild(label);

                    actionsEl.appendChild(element);
                });

                if (actions.length) {
                    banner.setAttribute('data-has-actions', 'true');
                } else {
                    banner.removeAttribute('data-has-actions');
                }
            }
        }

        // ──────────────────────────────────────────────────────────────────────────────
        // SIMPLIFIED HYDRATION SYSTEM
        // ──────────────────────────────────────────────────────────────────────────────
        // SIMPLIFIED HYDRATION SYSTEM
        // ──────────────────────────────────────────────────────────────────────────────
        window.__userHydrated = false;

        function nonEmpty(s) {
            return s != null && String(s).trim().length > 0;
        }

        function isBetterUser(incoming) {
            // Completely reject any data with "lumina" user or email
            if (incoming?.FullName === 'lumina' || 
                incoming?.UserName === 'lumina' || 
                incoming?.Email === 'lumina@vlbpo.com') {
                console.log('🚫 REJECTED: Incoming data contains lumina defaults, completely blocking');
                return false;
            }
            
            // Better user data has meaningful name AND role information
            const hasName = nonEmpty(incoming?.FullName) || nonEmpty(incoming?.UserName);
            const hasRoles = Array.isArray(incoming?.roleNames) && incoming.roleNames.length > 0;
            const hasRoleIds = nonEmpty(incoming?.Roles);
            const isAdmin = incoming?.IsAdmin === true || String(incoming?.IsAdmin).toUpperCase() === 'TRUE';
            
            // Better if it has a proper name AND (roles OR admin status)
            return hasName && (hasRoles || hasRoleIds || isAdmin);
        }

        function formatEmployment(status) {
            const s = (status || '').toLowerCase();
            const map = {
                'active': { cls: 'status-active', icon: 'fas fa-check-circle' },
                'full time': { cls: 'status-active', icon: 'fas fa-check-circle' },
                'full-time': { cls: 'status-active', icon: 'fas fa-check-circle' },
                'inactive': { cls: 'status-inactive', icon: 'fas fa-times-circle' },
                'terminated': { cls: 'status-inactive', icon: 'fas fa-times-circle' },
                'contract': { cls: 'status-contract', icon: 'fas fa-file-contract' },
                'probation': { cls: 'status-probation', icon: 'fas fa-hourglass-half' },
                'on leave': { cls: 'status-leave', icon: 'fas fa-pause-circle' },
                'part time': { cls: 'status-part-time', icon: 'fas fa-clock' },
                'part-time': { cls: 'status-part-time', icon: 'fas fa-clock' },
                'suspended': { cls: 'status-suspended', icon: 'fas fa-ban' }
            };
            return map[s] || { cls: '', icon: 'fas fa-briefcase' };
        }

        function updateUserDisplaySafely(user) {
            if (!user) return;
            
            // 🚫 COMPLETE REJECTION: Block any "lumina" user data entirely
            if (user.FullName === 'lumina' || 
                user.UserName === 'lumina' || 
                user.Email === 'lumina@vlbpo.com') {
                console.log('🚫 COMPLETELY BLOCKED: Incoming user data contains lumina - rejecting entirely');
                return; // Exit immediately - no processing at all
            }
            
            console.log('Attempting to update user display with:', user);
            
            // CRITICAL: Check if user panel was server-rendered with good data
            const userPanel = document.getElementById('userPanel');
            const wasServerRendered = userPanel && userPanel.getAttribute('data-initialized') === 'true';
            const serverName = userPanel ? userPanel.getAttribute('data-name') : '';
            const serverRoles = userPanel ? userPanel.getAttribute('data-roles') : '';
            
            // If server rendered with real data (not defaults), NEVER allow client updates
            if (wasServerRendered && nonEmpty(serverName) && serverName !== 'Unknown User') {
                console.log('🛡️ PROTECTED: Server-rendered user panel has good data, blocking all client updates');
                console.log('Server name:', serverName, 'Server roles:', serverRoles);
                window.__userHydrated = true; // Mark as hydrated to prevent further attempts
                return;
            }
            
            // Additional protection: If current displayed name is real, don't override
            const nameEl = document.getElementById('sidebarUserName') || document.getElementById('userName');
            const currentName = nameEl ? nameEl.textContent : '';
            if (nonEmpty(currentName) && currentName !== 'Unknown User') {
                console.log('🛡️ PROTECTED: Current displayed name is real, blocking override');
                console.log('Current name:', currentName, 'Incoming name:', user.FullName || user.UserName);
                window.__userHydrated = true;
                return;
            }

            // Only update if this is better data or first time AND no good data exists
            if (window.__userHydrated && !isBetterUser(user)) {
                console.log('Rejecting user update - not better than current data');
                return;
            }

            const roleEl = document.getElementById('userRole');
            const empEl = document.getElementById('userEmp');
            const avatar = document.getElementById('userAvatar');

            // Name: only set if provided and not empty AND not any default value
            const bestName = user.FullName || user.UserName;
            if (nonEmpty(bestName) && bestName !== 'Unknown User') {
                if (nameEl) nameEl.textContent = bestName;
                if (avatar) avatar.textContent = bestName.charAt(0).toUpperCase();
                console.log('Updated name to:', bestName);
            } else {
                console.log('Skipping name update - invalid or default value:', bestName);
            }

            // Roles: prefer incoming roleNames; else keep existing
            let roleText = null;
            if (Array.isArray(user.roleNames) && user.roleNames.length) {
                roleText = user.roleNames.join(', ');
                console.log('Using roleNames:', roleText);
            } else if (user.IsAdmin === true || String(user.IsAdmin).toUpperCase() === 'TRUE' || user.isAdminBool === true) {
                roleText = 'System Administrator';
                console.log('Using admin status for role');
            }
            
            if (nonEmpty(roleText) && roleEl) {
                roleEl.textContent = roleText;
                console.log('Updated role to:', roleText);
            }

            // Employment
            if (empEl && (nonEmpty(user.EmploymentStatus) || nonEmpty(user.Country))) {
                const fmt = formatEmployment(user.EmploymentStatus || '');
                const pieces = [];
                if (nonEmpty(user.EmploymentStatus)) {
                    pieces.push(`<i class="${fmt.icon} ${fmt.cls}"></i><span class="${fmt.cls}">${user.EmploymentStatus}</span>`);
                }
                if (nonEmpty(user.Country)) {
                    pieces.push(`<span>• ${user.Country}</span>`);
                }
                if (pieces.length) {
                    empEl.innerHTML = pieces.join(' ');
                    console.log('Updated employment status');
                }
            }

            window.__userHydrated = true;
            console.log('User display updated successfully');
        }

        // ──────────────────────────────────────────────────────────────────────────────
        // SIMPLIFIED LOGOUT FUNCTION
        // ──────────────────────────────────────────────────────────────────────────────
        function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) return;
            
            const btn = document.querySelector('.logout-btn-topbar');
            btn.disabled = true;
            const icon = btn.querySelector('i');
            if (icon) icon.className = 'fas fa-spinner loading-spinner-head';
            
            console.log('🚪 Initiating logout...');
            
            // Clear browser storage
            try {
                localStorage.clear();
                sessionStorage.clear();
                console.log('🧹 Browser storage cleared');
            } catch (e) {
                console.warn('⚠️ Could not clear storage:', e);
            }
            
            // Call server logout
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('✅ Server logout completed:', result);
                    performLogout();
                })
                .withFailureHandler(function(err) {
                    console.warn('⚠️ Server logout failed, but proceeding with client logout:', err);
                    performLogout();
                })
                .logout('');
        }

        function performLogout() {
            console.log('Performing logout...');
            
            // Clear browser storage again
            try {
                localStorage.clear();
                sessionStorage.clear();
                console.log('Browser storage cleared');
            } catch (e) {
                console.warn('Could not clear storage:', e);
            }
            
            // Show logout message and redirect
            showLogoutMessage();
            
            setTimeout(function() {
                window.location.href = BASE_URL;
            }, 2000);
        }

        function showLogoutMessage() {
            if (typeof window.showLuminaToast === 'function') {
                window.showLuminaToast('Logged out successfully', {
                    type: 'success',
                    title: 'Lumina'
                });
                return;
            }

            alert('Logged out successfully');
        }

        // ──────────────────────────────────────────────────────────────────────────────
        // DOCUMENT READY INITIALIZATION
        // ──────────────────────────────────────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 VLBPO Dashboard initializing...');

            initializeGlobalBanner({
                title: <?!= JSON.stringify(__layoutPageTitleText || __layoutCurrentPageName || '') ?>,
                description: <?!= JSON.stringify(__layoutPageDescriptionText || '') ?>,
                campaignName: <?!= JSON.stringify(__layoutCampaignName || '') ?>
            });

            // Initialize tooltips
            [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(function(tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Sidebar toggle
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('collapsed');
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
            });
            
            // Mobile toggle
            const mobileToggle = document.getElementById('mobileToggle');
            if (mobileToggle) {
                mobileToggle.addEventListener('click', function() {
                    document.getElementById('sidebar').classList.toggle('mobile-open');
                    document.getElementById('mobileOverlay').classList.toggle('active');
                });
            }
            
            // Mobile overlay close
            document.getElementById('mobileOverlay')?.addEventListener('click', function() {
                document.getElementById('sidebar').classList.remove('mobile-open');
                this.classList.remove('active');
            });
            
            // Restore sidebar state
            if (localStorage.getItem('sidebarCollapsed') === 'true') {
                document.getElementById('sidebar').classList.add('collapsed');
            }

            console.log('✅ Lumina Dashboard initialized');
            
            // Mark as hydrated immediately to prevent any client updates
            window.__userHydrated = true;
            
            // Check if user panel was properly rendered by server
            const userPanel = document.getElementById('userPanel');
            if (userPanel && userPanel.getAttribute('data-initialized') === 'true') {
                const serverName = userPanel.getAttribute('data-name');
                const serverRoles = userPanel.getAttribute('data-roles');
                console.log('✅ Server-rendered user panel detected:', { 
                    name: serverName, 
                    roles: serverRoles 
                });
            } else {
                console.warn('⚠️ User panel not properly initialized by server');
            }
        });

        // ──────────────────────────────────────────────────────────────────────────────
        // GLOBAL FUNCTION AVAILABILITY
        // ──────────────────────────────────────────────────────────────────────────────

        // Make functions available globally
        window.handleLogout = handleLogout;
        window.updateUserDisplaySafely = updateUserDisplaySafely;
        window.initializeGlobalBanner = initializeGlobalBanner;

        console.log('✨ Simplified header system loaded successfully');
    </script>
