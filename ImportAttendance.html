<!-- File: ImportAttendance.html -->
<?!= include('layout', {
  baseUrl: baseUrl,
  scriptUrl: scriptUrl,
  user: user,
  currentPage: currentPage || 'importattendance'
}) ?>

<style>
  .manual-shift-container {
    max-width: 1200px;
    margin: 0 auto;
    padding-bottom: 2rem;
  }

  .manual-page-header {
    text-align: center;
    margin-bottom: 2.5rem;
  }

  .manual-page-title {
    font-size: 2.25rem;
    font-weight: 800;
    margin-bottom: 0.75rem;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .manual-page-subtitle {
    font-size: 1.05rem;
    color: var(--gray-600);
    max-width: 640px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .modern-card {
    border-radius: var(--border-radius);
    border: 1px solid var(--outline);
    background: linear-gradient(145deg, #ffffff 0%, var(--surface-variant) 100%);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
  }

  .modern-card-header {
    padding: 1.5rem 1.75rem 1.25rem;
    border-bottom: 1px solid var(--outline);
    background: linear-gradient(135deg, var(--surface) 0%, rgba(14, 165, 233, 0.08) 100%);
  }

  .modern-card-title {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 700;
    display: flex;
    gap: 0.75rem;
    align-items: center;
    color: var(--dark);
  }

  .modern-card-title i {
    width: 2.5rem;
    height: 2.5rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--border-radius-sm);
    background: var(--gradient-primary);
    color: #fff;
    font-size: 1.25rem;
  }

  .modern-card-body {
    padding: 1.75rem;
  }

  .shift-field-group {
    display: grid;
    gap: 1rem 1.5rem;
  }

  .shift-field-group.three-cols {
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }

  .shift-field-group.two-cols {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  .form-label-modern {
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.35rem;
  }

  .form-control-modern,
  .form-select-modern,
  .form-textarea-modern {
    width: 100%;
    border-radius: var(--border-radius);
    border: 1px solid var(--outline);
    padding: 0.65rem 0.85rem;
    background: rgba(255, 255, 255, 0.9);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .form-control-modern:focus,
  .form-select-modern:focus,
  .form-textarea-modern:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(14, 165, 233, 0.15);
  }

  .form-textarea-modern {
    resize: vertical;
    min-height: 100px;
  }

  .user-selection-card {
    display: flex;
    flex-direction: column;
    min-height: 100%;
  }

  .user-search-box {
    position: relative;
    margin-bottom: 1rem;
  }

  .user-search-box i {
    position: absolute;
    top: 50%;
    left: 0.85rem;
    transform: translateY(-50%);
    color: var(--gray-500);
  }

  .user-search-input {
    padding-left: 2.5rem;
  }

  .user-selection-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .user-count-label {
    font-weight: 600;
    color: var(--gray-600);
  }

  .user-list {
    flex: 1;
    border: 1px solid var(--outline);
    border-radius: var(--border-radius);
    background: rgba(255, 255, 255, 0.9);
    max-height: 360px;
    overflow-y: auto;
    padding: 0.75rem;
  }

  .user-list-empty {
    padding: 2.5rem 1rem;
    text-align: center;
    color: var(--gray-500);
    font-size: 0.95rem;
  }

  .user-list-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border-radius: var(--border-radius-sm);
    padding: 0.5rem 0.65rem;
    transition: background-color 0.2s ease;
  }

  .user-list-item:hover {
    background: rgba(14, 165, 233, 0.08);
  }

  .user-list-item + .user-list-item {
    margin-top: 0.35rem;
  }

  .user-name {
    font-weight: 600;
    color: var(--dark);
  }

  .user-meta {
    font-size: 0.8rem;
    color: var(--gray-500);
  }

  .user-loading-state {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 2.25rem 1rem;
    color: var(--gray-600);
  }

  .loading-spinner {
    display: inline-block;
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 50%;
    border: 2px solid rgba(14, 165, 233, 0.25);
    border-top-color: var(--primary);
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .alert-modern {
    border-radius: var(--border-radius);
    padding: 1rem 1.25rem;
    margin-bottom: 1.25rem;
    border: 1px solid transparent;
    display: flex;
    gap: 0.85rem;
    align-items: flex-start;
    position: relative;
  }

  .alert-modern i {
    font-size: 1.15rem;
  }

  .alert-modern p {
    margin: 0;
  }

  .alert-success-modern {
    background: rgba(16, 185, 129, 0.12);
    border-color: rgba(16, 185, 129, 0.35);
    color: #047857;
  }

  .alert-danger-modern {
    background: rgba(239, 68, 68, 0.12);
    border-color: rgba(239, 68, 68, 0.35);
    color: #b91c1c;
  }

  .alert-warning-modern {
    background: rgba(234, 179, 8, 0.15);
    border-color: rgba(234, 179, 8, 0.35);
    color: #92400e;
  }

  .alert-info-modern {
    background: rgba(59, 130, 246, 0.12);
    border-color: rgba(59, 130, 246, 0.35);
    color: #1d4ed8;
  }

  .alert-close {
    position: absolute;
    top: 0.5rem;
    right: 0.75rem;
    background: none;
    border: none;
    font-size: 1.25rem;
    color: inherit;
    cursor: pointer;
  }

  .activity-log {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .activity-entry {
    border-left: 4px solid var(--primary);
    padding-left: 1rem;
    background: rgba(14, 165, 233, 0.06);
    border-radius: 0 var(--border-radius) var(--border-radius) 0;
    padding: 1rem 1.25rem;
  }

  .activity-entry strong {
    display: block;
    font-weight: 700;
    color: var(--dark);
  }

  .activity-meta {
    font-size: 0.85rem;
    color: var(--gray-600);
    margin-top: 0.35rem;
  }

  .form-footer-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    justify-content: space-between;
  }

  .btn-modern {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    border-radius: var(--border-radius);
    padding: 0.6rem 1.1rem;
  }

  .btn-success-modern {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    color: #fff;
    border: none;
  }

  .btn-success-modern:disabled {
    opacity: 0.75;
    cursor: not-allowed;
  }

  .btn-outline-modern {
    background: transparent;
    color: var(--gray-700);
    border: 1px solid var(--outline);
  }

  @media (max-width: 768px) {
    .manual-page-title {
      font-size: 1.85rem;
    }

    .modern-card-body {
      padding: 1.25rem;
    }

    .form-footer-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .btn-modern {
      justify-content: center;
      width: 100%;
    }
  }
</style>

<div class="manual-shift-container">
  <div class="manual-page-header">
    <h1 class="manual-page-title">Manual Shift Slot Assignment</h1>
    <p class="manual-page-subtitle">
      Create and assign shift slots without importing spreadsheets. Select a date, define the shift timing,
      and choose the agents who should receive the assignment. You can also add context from a source month or year
      to track where the schedule originated.
    </p>
  </div>

  <div id="feedbackArea"></div>

  <form id="manualShiftForm" novalidate>
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="modern-card h-100">
          <div class="modern-card-header">
            <h3 class="modern-card-title">
              <i class="fas fa-calendar-plus text-primary"></i>
              Shift Details
            </h3>
          </div>
          <div class="modern-card-body">
            <div class="shift-field-group three-cols">
              <div>
                <label class="form-label-modern" for="assignmentDate">Assignment Date</label>
                <input type="date" class="form-control-modern" id="assignmentDate" min="2023-01-01" required>
                <small class="text-muted">You can schedule back to January 2023.</small>
              </div>
              <div>
                <label class="form-label-modern" for="startTime">Start Time</label>
                <input type="time" class="form-control-modern" id="startTime" required>
              </div>
              <div>
                <label class="form-label-modern" for="endTime">End Time</label>
                <input type="time" class="form-control-modern" id="endTime" required>
              </div>
            </div>

            <div class="shift-field-group two-cols mt-3">
              <div>
                <label class="form-label-modern" for="sourceMonth">Source Month (optional)</label>
                <select class="form-select-modern" id="sourceMonth">
                  <option value="">Select month</option>
                  <option value="1">January</option>
                  <option value="2">February</option>
                  <option value="3">March</option>
                  <option value="4">April</option>
                  <option value="5">May</option>
                  <option value="6">June</option>
                  <option value="7">July</option>
                  <option value="8">August</option>
                  <option value="9">September</option>
                  <option value="10">October</option>
                  <option value="11">November</option>
                  <option value="12">December</option>
                </select>
              </div>
              <div>
                <label class="form-label-modern" for="sourceYear">Source Year (optional)</label>
                <select class="form-select-modern" id="sourceYear">
                  <option value="">Select year</option>
                </select>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label-modern" for="slotLabel">Slot Label (optional)</label>
              <input type="text" class="form-control-modern" id="slotLabel" placeholder="e.g., Manual Morning Shift">
            </div>

            <div class="mt-3">
              <label class="form-label-modern" for="additionalNotes">Additional Notes</label>
              <textarea class="form-textarea-modern" id="additionalNotes" placeholder="Add context for this assignment"></textarea>
            </div>

            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" id="replaceExisting">
              <label class="form-check-label" for="replaceExisting">
                Replace existing shift assignment on the selected date for chosen users
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="modern-card user-selection-card">
          <div class="modern-card-header">
            <h3 class="modern-card-title">
              <i class="fas fa-user-clock text-success"></i>
              Select Users
            </h3>
          </div>
          <div class="modern-card-body d-flex flex-column">
            <div class="user-search-box">
              <i class="fas fa-search"></i>
              <input type="search" class="form-control-modern user-search-input" id="userSearch" placeholder="Search by name or email" autocomplete="off">
            </div>
            <div class="user-selection-controls">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAllUsers">
                <label class="form-check-label" for="selectAllUsers">Select all filtered users</label>
              </div>
              <div class="user-count-label">
                <span id="selectedUserCount">0</span> / <span id="totalUserCount">0</span> selected
              </div>
            </div>
            <div class="user-list" id="userList">
              <div class="user-loading-state" id="userLoadingState">
                <span class="loading-spinner"></span>
                <span>Loading available users...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modern-card mt-4">
      <div class="modern-card-body form-footer-actions">
        <div>
          <strong>Ready to assign?</strong>
          <span class="text-muted">Review your selections and click <em>Add Shift Slots</em> to apply the changes.</span>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <button type="submit" class="btn-modern btn-success-modern" id="submitManualShift">
            <i class="fas fa-plus-circle"></i>
            Add Shift Slots
          </button>
          <button type="button" class="btn-modern btn-outline-modern" id="clearSelection">
            <i class="fas fa-eraser"></i>
            Clear Selection
          </button>
        </div>
      </div>
    </div>
  </form>

  <div class="modern-card mt-4">
    <div class="modern-card-header">
      <h3 class="modern-card-title">
        <i class="fas fa-history text-info"></i>
        Recent Activity
      </h3>
    </div>
    <div class="modern-card-body">
      <div class="activity-log" id="activityLog">
        <p class="text-muted mb-0" id="activityEmptyState">
          Shift slot assignments that you create will appear here for quick reference.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  class ManualShiftSlotManager {
    constructor() {
      this.form = document.getElementById('manualShiftForm');
      this.feedbackArea = document.getElementById('feedbackArea');
      this.activityLog = document.getElementById('activityLog');
      this.activityEmptyState = document.getElementById('activityEmptyState');
      this.dateInput = document.getElementById('assignmentDate');
      this.startTimeInput = document.getElementById('startTime');
      this.endTimeInput = document.getElementById('endTime');
      this.sourceMonthSelect = document.getElementById('sourceMonth');
      this.sourceYearSelect = document.getElementById('sourceYear');
      this.slotLabelInput = document.getElementById('slotLabel');
      this.notesInput = document.getElementById('additionalNotes');
      this.replaceExistingToggle = document.getElementById('replaceExisting');
      this.userSearchInput = document.getElementById('userSearch');
      this.userList = document.getElementById('userList');
      this.userLoadingState = document.getElementById('userLoadingState');
      this.selectAllToggle = document.getElementById('selectAllUsers');
      this.selectedCountLabel = document.getElementById('selectedUserCount');
      this.totalCountLabel = document.getElementById('totalUserCount');
      this.clearSelectionBtn = document.getElementById('clearSelection');
      this.submitButton = document.getElementById('submitManualShift');

      this.users = [];
      this.userMap = new Map();
      this.selectedUserIds = new Set();

      this.form.addEventListener('submit', (event) => this.handleSubmit(event));
      this.userSearchInput.addEventListener('input', () => this.renderUserList());
      this.selectAllToggle.addEventListener('change', () => this.toggleSelectAll());
      this.clearSelectionBtn.addEventListener('click', () => this.clearSelection());

      this.populateSourceYears();
      this.setDefaultDate();
      this.loadUsers();
    }

    populateSourceYears() {
      const currentYear = new Date().getFullYear();
      const earliestYear = 2023;
      const endYear = currentYear + 2;
      for (let year = currentYear; year >= earliestYear; year--) {
        this.appendYearOption(year);
      }
      for (let year = currentYear + 1; year <= endYear; year++) {
        this.appendYearOption(year);
      }
    }

    appendYearOption(year) {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year;
      this.sourceYearSelect.appendChild(option);
    }

    setDefaultDate() {
      if (!this.dateInput) {
        return;
      }
      const today = new Date();
      const iso = today.toISOString().split('T')[0];
      this.dateInput.value = iso;
    }

    async loadUsers() {
      try {
        this.setUserLoading(true);
        const users = await this.callServerFunction('clientGetScheduleUsers', 'system');
        this.users = Array.isArray(users) ? users : [];
        this.users.sort((a, b) => {
          const nameA = (a.FullName || a.UserName || '').toLowerCase();
          const nameB = (b.FullName || b.UserName || '').toLowerCase();
          return nameA.localeCompare(nameB);
        });
        this.userMap.clear();
        this.users.forEach(user => {
          if (user && user.ID) {
            this.userMap.set(String(user.ID), user);
          }
        });
        this.totalCountLabel.textContent = this.users.length;
        this.renderUserList();
      } catch (error) {
        console.error('Failed to load users:', error);
        this.showFeedback('Unable to load users. Please refresh and try again.', 'danger');
        this.userList.innerHTML = '<div class="user-list-empty">Users could not be loaded.</div>';
        this.selectAllToggle.checked = false;
        this.selectAllToggle.disabled = true;
        this.selectedCountLabel.textContent = '0';
        this.totalCountLabel.textContent = '0';
      } finally {
        this.setUserLoading(false);
      }
    }

    setUserLoading(isLoading) {
      if (this.userLoadingState) {
        this.userLoadingState.style.display = isLoading ? 'flex' : 'none';
      }
    }

    getFilteredUsers() {
      const term = this.userSearchInput.value.trim().toLowerCase();
      if (!term) {
        return this.users;
      }
      return this.users.filter(user => {
        const name = (user.FullName || user.UserName || '').toLowerCase();
        const email = (user.Email || '').toLowerCase();
        const campaign = (user.campaignName || '').toLowerCase();
        return name.includes(term) || email.includes(term) || campaign.includes(term);
      });
    }

    renderUserList() {
      if (!this.userList) {
        return;
      }

      const filteredUsers = this.getFilteredUsers();
      this.userList.innerHTML = '';

      if (!filteredUsers.length) {
        const emptyState = document.createElement('div');
        emptyState.className = 'user-list-empty';
        emptyState.textContent = this.users.length
          ? 'No users match your search.'
          : 'No eligible users were found.';
        this.userList.appendChild(emptyState);
        this.updateSelectionCounters();
        this.selectAllToggle.checked = false;
        this.selectAllToggle.disabled = this.users.length === 0;
        return;
      }

      const fragment = document.createDocumentFragment();
      filteredUsers.forEach(user => {
        const userId = String(user.ID || '');
        const isChecked = this.selectedUserIds.has(userId);

        const item = document.createElement('label');
        item.className = 'user-list-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input';
        checkbox.checked = isChecked;
        checkbox.dataset.userId = userId;
        checkbox.dataset.userName = user.UserName || user.FullName || '';
        checkbox.addEventListener('change', (event) => this.toggleUser(event));

        const details = document.createElement('div');
        details.style.flex = '1';

        const name = document.createElement('div');
        name.className = 'user-name';
        name.textContent = user.FullName || user.UserName || 'Unnamed User';

        const meta = document.createElement('div');
        meta.className = 'user-meta';
        const parts = [];
        if (user.UserName && user.FullName && user.UserName !== user.FullName) {
          parts.push(user.UserName);
        }
        if (user.Email) {
          parts.push(user.Email);
        }
        if (user.campaignName) {
          parts.push(user.campaignName);
        }
        meta.textContent = parts.join(' • ');

        details.appendChild(name);
        if (parts.length) {
          details.appendChild(meta);
        }

        item.appendChild(checkbox);
        item.appendChild(details);
        fragment.appendChild(item);
      });

      this.userList.appendChild(fragment);
      this.updateSelectionCounters();
      this.syncSelectAllState(filteredUsers);
      this.selectAllToggle.disabled = false;
    }

    toggleUser(event) {
      const checkbox = event.target;
      const userId = checkbox.dataset.userId;
      if (!userId) {
        return;
      }
      if (checkbox.checked) {
        this.selectedUserIds.add(userId);
      } else {
        this.selectedUserIds.delete(userId);
      }
      this.updateSelectionCounters();
      this.syncSelectAllState();
    }

    toggleSelectAll() {
      const filteredUsers = this.getFilteredUsers();
      const shouldSelectAll = this.selectAllToggle.checked;
      filteredUsers.forEach(user => {
        const userId = String(user.ID || '');
        if (!userId) {
          return;
        }
        if (shouldSelectAll) {
          this.selectedUserIds.add(userId);
        } else {
          this.selectedUserIds.delete(userId);
        }
      });
      this.renderUserList();
    }

    syncSelectAllState(filteredUsers = this.getFilteredUsers()) {
      if (!filteredUsers.length) {
        this.selectAllToggle.checked = false;
        return;
      }
      const allSelected = filteredUsers.every(user => this.selectedUserIds.has(String(user.ID || '')));
      this.selectAllToggle.checked = allSelected && filteredUsers.length > 0;
    }

    clearSelection(options = {}) {
      this.selectedUserIds.clear();
      this.renderUserList();
      if (!options.silent) {
        this.showFeedback('User selection cleared.', 'info');
      }
    }

    updateSelectionCounters() {
      this.selectedCountLabel.textContent = this.selectedUserIds.size;
      this.totalCountLabel.textContent = this.users.length;
    }

    async handleSubmit(event) {
      event.preventDefault();

      const selectedIds = Array.from(this.selectedUserIds);
      if (!selectedIds.length) {
        this.showFeedback('Select at least one user before adding shift slots.', 'warning');
        return;
      }

      const dateValue = this.dateInput.value;
      const startTimeValue = this.startTimeInput.value;
      const endTimeValue = this.endTimeInput.value;

      if (!dateValue || !startTimeValue || !endTimeValue) {
        this.showFeedback('Date, start time, and end time are required.', 'danger');
        return;
      }

      if (startTimeValue >= endTimeValue) {
        this.showFeedback('End time must be later than start time.', 'warning');
        return;
      }

      const payload = {
        date: dateValue,
        startTime: startTimeValue,
        endTime: endTimeValue,
        sourceMonth: this.sourceMonthSelect.value ? Number(this.sourceMonthSelect.value) : '',
        sourceYear: this.sourceYearSelect.value ? Number(this.sourceYearSelect.value) : '',
        slotName: this.slotLabelInput.value.trim(),
        notes: this.notesInput.value.trim(),
        replaceExisting: this.replaceExistingToggle.checked,
        users: selectedIds.map(id => {
          const user = this.userMap.get(id) || {};
          return {
            id,
            userName: user.UserName || user.FullName || '',
            fullName: user.FullName || '',
            email: user.Email || ''
          };
        })
      };

      const originalButtonContent = this.submitButton.innerHTML;
      this.submitButton.disabled = true;
      this.submitButton.innerHTML = '<span class="loading-spinner"></span> Saving...';

      try {
        const result = await this.callServerFunction('clientAddManualShiftSlots', payload);
        if (result && result.success) {
          const message = result.message || 'Shift slots added successfully.';
          this.showFeedback(message, 'success');
          this.appendActivity(result);
          if (!this.replaceExistingToggle.checked) {
          this.clearSelection({ silent: true });
          }
        } else {
          const errorMessage = (result && result.error) || 'Unable to add shift slots.';
          this.showFeedback(errorMessage, 'danger');
        }

        if (result && Array.isArray(result.failed) && result.failed.length) {
          const skippedNames = result.failed.map(item => item.userName || item.userId || 'Unknown').join(', ');
          this.showFeedback(`Skipped ${result.failed.length} user(s): ${skippedNames}`, 'warning');
        }
      } catch (error) {
        console.error('Manual shift slot assignment failed:', error);
        this.showFeedback(error.message || 'An unexpected error occurred while saving shift slots.', 'danger');
      } finally {
        this.submitButton.disabled = false;
        this.submitButton.innerHTML = originalButtonContent;
      }
    }

    appendActivity(result) {
      if (!result || !Array.isArray(result.details)) {
        return;
      }

      if (this.activityEmptyState) {
        this.activityEmptyState.remove();
        this.activityEmptyState = null;
      }

      const entry = document.createElement('div');
      entry.className = 'activity-entry';

      const userNames = result.details.map(detail => detail.userName || detail.userId || 'Unknown').join(', ');
      const slotName = result.details[0]?.slotName || 'Manual Shift';
      const dateLabel = result.details[0]?.date || this.dateInput.value;
      const timeLabel = `${result.details[0]?.startTime || this.startTimeInput.value} - ${result.details[0]?.endTime || this.endTimeInput.value}`;
      const timestamp = new Date().toLocaleString();

      entry.innerHTML = `
        <strong>${this.escapeHtml(slotName)}</strong>
        <div>${this.escapeHtml(userNames)}</div>
        <div class="activity-meta">
          <i class="far fa-calendar-alt me-1"></i>${this.escapeHtml(dateLabel)}
          &nbsp;•&nbsp;
          <i class="far fa-clock me-1"></i>${this.escapeHtml(timeLabel)}
          &nbsp;•&nbsp;
          Recorded ${this.escapeHtml(timestamp)}
        </div>
      `;

      this.activityLog.prepend(entry);

      const maxEntries = 8;
      while (this.activityLog.children.length > maxEntries) {
        this.activityLog.removeChild(this.activityLog.lastElementChild);
      }
    }

    showFeedback(message, type) {
      if (!this.feedbackArea) {
        return;
      }

      const icons = {
        success: 'fas fa-check-circle',
        danger: 'fas fa-exclamation-triangle',
        warning: 'fas fa-exclamation-circle',
        info: 'fas fa-info-circle'
      };

      const alert = document.createElement('div');
      alert.className = `alert-modern alert-${type}-modern`;
      alert.innerHTML = `
        <i class="${icons[type] || icons.info}"></i>
        <div>
          <p>${this.escapeHtml(message)}</p>
        </div>
        <button type="button" class="alert-close" aria-label="Dismiss" title="Dismiss alert">&times;</button>
      `;

      alert.querySelector('.alert-close').addEventListener('click', () => alert.remove());

      this.feedbackArea.prepend(alert);

      setTimeout(() => {
        alert.style.opacity = '0';
        alert.style.transform = 'translateY(-6px)';
        setTimeout(() => alert.remove(), 250);
      }, type === 'info' ? 3500 : 6000);
    }

    escapeHtml(value) {
      const div = document.createElement('div');
      div.textContent = value || '';
      return div.innerHTML;
    }

    callServerFunction(functionName, ...args) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [functionName](...args);
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    window.manualShiftSlotManager = new ManualShiftSlotManager();
  });
</script>

</body>
</html>
