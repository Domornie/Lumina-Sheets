    <?!= includeOnce('ResponsiveStyles') ?>
<!-- CoachingView.html -->
<?!= include("layout", {
  baseUrl: baseUrl,
  scriptUrl: scriptUrl,
  user: user,
  currentPage: currentPage || 'coachingview',
  pageTitle: 'Coaching Session Details',
  pageDescription: 'Review coaching insights, topics covered, and send acknowledgement links to agents.'
}) ?>

<!-- Injected by doGet as stringified JSON -->
<script>
  const recordId = '<?= recordId ?>';
  const record   = recordId
    ? JSON.parse('<?= record ?>')
    : {};

  // helpers for formatting
  function formatDate(iso) {
    try {
      return new Date(iso).toLocaleDateString([], {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    } catch (_) {
      return iso;
    }
  }
  function formatDateTime(iso) {
    try {
      return new Date(iso).toLocaleString([], {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch (_) {
      return iso;
    }
  }
</script>

<style>
  :root {
    --primary: #4285f4;
    --primary-dark: #1a73e8;
    --accent: #34a853;
    --warning: #fbbc04;
    --danger: #ea4335;
    --surface: #ffffff;
    --surface-variant: #f8f9fa;
    --surface-elevated: #ffffff;
    --outline: #dadce0;
    --outline-variant: #e8eaed;
    --shadow: rgba(0,0,0,0.1);
    --shadow-hover: rgba(0,0,0,0.15);
    --shadow-elevated: 0 4px 24px rgba(0,0,0,0.12);
    --text-primary: #202124;
    --text-secondary: #5f6368;
    --text-tertiary: #80868b;
    --border-radius: 12px;
    --border-radius-lg: 16px;
    --spacing: 1.5rem;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    --gradient-accent: linear-gradient(135deg, var(--accent) 0%, #2e7d32 100%);
  }

  * { 
    box-sizing: border-box; 
  }

  /* Modern Navigation */
  .coaching-nav {
    background: var(--surface-elevated);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-elevated);
    margin-bottom: var(--spacing);
    overflow: hidden;
    backdrop-filter: blur(10px);
    border: 1px solid var(--outline-variant);
  }

  .coaching-nav .nav {
    padding: 0.5rem;
    gap: 0.25rem;
  }

  .coaching-nav .nav-link {
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: 500;
    padding: 0.875rem 1.5rem;
    border-radius: var(--border-radius);
    transition: var(--transition);
    position: relative;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.925rem;
    letter-spacing: -0.01em;
  }

  .coaching-nav .nav-link::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%) scaleX(0);
    width: 24px;
    height: 2px;
    background: var(--gradient-primary);
    border-radius: 1px;
    transition: transform 0.3s ease;
  }

  .coaching-nav .nav-link:hover {
    background: rgba(66, 133, 244, 0.08);
    color: var(--primary);
    transform: translateY(-1px);
  }

  .coaching-nav .nav-link:hover::before {
    transform: translateX(-50%) scaleX(1);
  }

  .coaching-nav .nav-link.active {
    background: var(--gradient-primary);
    color: white;
    box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
  }

  .coaching-nav .nav-link.active::before {
    display: none;
  }

  /* Modern Cards */
  .coaching-card {
    background: var(--surface-elevated);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-elevated);
    margin-bottom: var(--spacing);
    overflow: hidden;
    border: 1px solid var(--outline-variant);
    backdrop-filter: blur(10px);
    transition: var(--transition);
  }

  .coaching-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  }

  .coaching-card-header {
    background: var(--gradient-primary);
    color: white;
    padding: 1.25rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
    overflow: hidden;
  }

  .coaching-card-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1));
    transform: translateX(100px);
    transition: transform 0.6s ease;
  }

  .coaching-card:hover .coaching-card-header::before {
    transform: translateX(-100px);
  }

  .coaching-card-header i {
    font-size: 1.25rem;
    opacity: 0.9;
  }

  .coaching-card-header h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    letter-spacing: -0.02em;
  }

  .coaching-card-body {
    padding: 1.5rem;
  }

  /* Details Grid */
  .details-grid {
    display: grid;
    gap: 1.25rem;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .detail-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .detail-label i {
    font-size: 0.75rem;
    opacity: 0.7;
  }

  .detail-value {
    font-size: 0.95rem;
    color: var(--text-primary);
    font-weight: 500;
    line-height: 1.6;
    padding: 0.5rem 0;
  }

  .detail-value.empty {
    color: var(--text-tertiary);
    font-style: italic;
  }

  /* Rich text formatting for HTML content */
  .detail-value p {
    margin-bottom: 0.75rem;
    line-height: 1.6;
  }

  .detail-value p:last-child {
    margin-bottom: 0;
  }

  .detail-value strong, 
  .detail-value b {
    font-weight: 700;
    color: var(--text-primary);
  }

  .detail-value em, 
  .detail-value i {
    font-style: italic;
    color: var(--text-secondary);
  }

  .detail-value ul, 
  .detail-value ol {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
  }

  .detail-value li {
    margin-bottom: 0.25rem;
    line-height: 1.5;
  }

  .detail-value h1, 
  .detail-value h2, 
  .detail-value h3, 
  .detail-value h4, 
  .detail-value h5, 
  .detail-value h6 {
    margin: 0.75rem 0 0.5rem 0;
    font-weight: 600;
    color: var(--primary);
  }

  .detail-value h3 {
    font-size: 1.1rem;
  }

  .detail-value h4 {
    font-size: 1rem;
  }

  .detail-value code {
    background: var(--surface-variant);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    color: var(--primary);
  }

  .detail-value pre {
    background: var(--surface-variant);
    padding: 1rem;
    border-radius: var(--border-radius);
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    line-height: 1.4;
    margin: 0.5rem 0;
  }

  .detail-value blockquote {
    border-left: 3px solid var(--primary);
    padding-left: 1rem;
    margin: 0.75rem 0;
    font-style: italic;
    color: var(--text-secondary);
  }

  .detail-value a {
    color: var(--primary);
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: var(--transition);
  }

  .detail-value a:hover {
    border-bottom-color: var(--primary);
  }

  /* Topics Section */
  .topics-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  .topic-pill {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1565c0;
    padding: 0.5rem 1rem;
    border-radius: 24px;
    font-size: 0.85rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    transition: var(--transition);
    border: 1px solid rgba(21, 101, 192, 0.1);
    letter-spacing: -0.01em;
  }

  .topic-pill:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(21, 101, 192, 0.2);
  }

  .topic-pill.covered {
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
    color: #2e7d32;
    border-color: rgba(46, 125, 50, 0.1);
  }

  .covered-topics-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  .topic-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    border-radius: 24px;
    background: var(--surface);
    border: 2px solid var(--outline-variant);
    transition: var(--transition);
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    letter-spacing: -0.01em;
  }

  .topic-checkbox:hover {
    border-color: var(--primary);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
  }

  .topic-checkbox input[type="checkbox"] {
    width: 1.125rem;
    height: 1.125rem;
    border-radius: 4px;
    border: 2px solid var(--outline);
    background: var(--surface);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
  }

  .topic-checkbox input[type="checkbox"]:checked {
    background: var(--gradient-primary);
    border-color: var(--primary);
  }

  .topic-checkbox input[type="checkbox"]:checked + label {
    color: var(--primary);
    font-weight: 600;
  }

  .topic-checkbox.checked {
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* Completion Section */
  .completion-section {
    background: var(--surface-elevated);
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    margin-top: var(--spacing);
    box-shadow: var(--shadow-elevated);
    border: 1px solid var(--outline-variant);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .completion-checkbox {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    transition: var(--transition);
    padding: 0.5rem 1rem;
    border-radius: var(--border-radius);
  }

  .completion-checkbox:hover {
    background: rgba(52, 168, 83, 0.05);
    color: var(--accent);
  }

  .completion-checkbox input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 6px;
    border: 2px solid var(--outline);
    background: var(--surface);
    cursor: pointer;
    transition: var(--transition);
  }

  .completion-checkbox input[type="checkbox"]:checked {
    background: var(--gradient-accent);
    border-color: var(--accent);
  }

  .complete-button {
    background: var(--gradient-accent);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    padding: 0.875rem 1.75rem;
    font-size: 0.925rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 2px 8px rgba(52, 168, 83, 0.2);
    letter-spacing: -0.01em;
  }

  .complete-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(52, 168, 83, 0.3);
  }

  .complete-button:disabled {
    background: var(--outline-variant);
    color: var(--text-tertiary);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .complete-button i {
    font-size: 1rem;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .empty-state i {
    font-size: 2rem;
    opacity: 0.5;
    margin-bottom: 1rem;
    display: block;
  }

  /* Responsive Design */
  @media (min-width: 768px) {
    .details-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .coaching-nav .nav {
      justify-content: center;
    }
  }

  @media (min-width: 1024px) {
    .details-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 767px) {
    .completion-section {
      flex-direction: column;
      align-items: stretch;
      text-align: center;
    }
    
    .complete-button {
      justify-content: center;
    }
    
    .coaching-nav .nav {
      flex-direction: column;
    }
    
    .coaching-nav .nav-link {
      text-align: center;
    }
  }

  /* Animations */
  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .coaching-card {
    animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  .coaching-card:nth-child(2) { animation-delay: 0.1s; }
  .coaching-card:nth-child(3) { animation-delay: 0.2s; }
  .coaching-card:nth-child(4) { animation-delay: 0.3s; }

  .topic-pill, .topic-checkbox {
    animation: fadeIn 0.4s ease forwards;
  }

  /* Loading States */
  .loading-spinner {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Focus States */
  .coaching-nav .nav-link:focus,
  .ack-button:focus,
  .complete-button:focus {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }

  input[type="checkbox"]:focus {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }
</style>

<!-- Modern Navigation -->
<nav class="coaching-nav">
  <div class="nav d-flex">
    <a href="<?= baseUrl ?>&page=coachinglist"
       class="nav-link <?= currentPage==='Coaching Sessions'?'active':'' ?>">
      <i class="fas fa-list"></i>
      <span>List Sessions</span>
    </a>
    <a href="<?= baseUrl ?>&page=coachingsheet"
       class="nav-link <?= currentPage==='Coaching Sheet'?'active':'' ?>">
      <i class="fas fa-plus-circle"></i>
      <span>New Session</span>
    </a>
    <a href="<?= baseUrl ?>&page=coachingdashboard"
       class="nav-link <?= currentPage==='Coaching Dashboard'?'active':'' ?>">
      <i class="fas fa-chart-line"></i>
      <span>Dashboard</span>
    </a>
  </div>
</nav>

<!-- Coaching Details Card -->
<div class="coaching-card">
  <div class="coaching-card-header">
    <i class="fas fa-user-tie"></i>
    <h3>Coaching Session Details</h3>
  </div>
  <div class="coaching-card-body">
    <div class="details-grid">
      <div class="detail-item">
        <div class="detail-label">
          <i class="fas fa-calendar"></i>
          Session Date
        </div>
        <div class="detail-value" id="dSessionDate"></div>
      </div>

      <div class="detail-item">
        <div class="detail-label">
          <i class="fas fa-user-graduate"></i>
          Coach
        </div>
        <div class="detail-value" id="dAgentName"></div>
      </div>

      <div class="detail-item">
        <div class="detail-label">
          <i class="fas fa-user"></i>
          Coachee
        </div>
        <div class="detail-value" id="dCoacheeName"></div>
      </div>

      <div class="detail-item">
        <div class="detail-label">
          <i class="fas fa-envelope"></i>
          Coachee Email
        </div>
        <div class="detail-value" id="dCoacheeEmail"></div>
      </div>

      <div class="detail-item">
        <div class="detail-label">
          <i class="fas fa-tasks"></i>
          Action Plan
        </div>
        <div class="detail-value" id="dActionPlan"></div>
      </div>

      <div class="detail-item">
        <div class="detail-label">
          <i class="fas fa-clock"></i>
          Follow-Up Date
        </div>
        <div class="detail-value" id="dFollowUpDate"></div>
      </div>

      <div class="detail-item" style="grid-column: 1 / -1;">
        <div class="detail-label">
          <i class="fas fa-sticky-note"></i>
          Notes
        </div>
        <div class="detail-value" id="dNotes"></div>
      </div>

      <div class="detail-item">
        <div class="detail-label">
          <i class="fas fa-plus-circle"></i>
          Created At
        </div>
        <div class="detail-value" id="dCreatedAt"></div>
      </div>

      <div class="detail-item">
        <div class="detail-label">
          <i class="fas fa-edit"></i>
          Updated At
        </div>
        <div class="detail-value" id="dUpdatedAt"></div>
      </div>
    </div>
  </div>
</div>

<!-- Topics Planned Card -->
<div class="coaching-card">
  <div class="coaching-card-header">
    <i class="fas fa-lightbulb"></i>
    <h3>Planned Topics</h3>
  </div>
  <div class="coaching-card-body">
    <div class="topics-container" id="plannedPill">
      <div class="empty-state">
        <i class="fas fa-clipboard-list"></i>
        No topics planned yet
      </div>
    </div>
  </div>
</div>

<!-- Mark Covered Topics Card -->
<div class="coaching-card">
  <div class="coaching-card-header">
    <i class="fas fa-check-circle"></i>
    <h3>Mark Covered Topics</h3>
  </div>
  <div class="coaching-card-body">
    <div class="covered-topics-container" id="coveredPill">
      <div class="empty-state">
        <i class="fas fa-tasks"></i>
        No topics to mark as covered
      </div>
    </div>
  </div>
</div>

<!-- Completion Section -->
<div class="completion-section">
  <label class="completion-checkbox">
    <input type="checkbox" id="completeCb" />
    <span>Mark coaching session as completed</span>
  </label>
  <button id="btnComplete" class="complete-button" disabled>
    <i class="fas fa-check"></i>
    Complete & Notify
  </button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const ackUrl = recordId ? "<?= baseUrl ?>&page=ackform&id=<?= recordId ?>" : '';
    initializeGlobalBanner({
      title: 'Coaching Session Details',
      description: 'Review coaching insights, topics covered, and send acknowledgement links to agents.',
      actions: ackUrl ? [
        {
          id: 'coachingBannerAck',
          label: 'Send Acknowledgement Link',
          icon: 'fas fa-external-link-alt',
          variant: 'primary',
          href: ackUrl,
          target: '_blank',
          rel: 'noopener'
        }
      ] : []
    });

    if (!recordId) {
      alert('No coaching record loaded.');
      return;
    }
    
    const get = key => record[key] || '';

    // Populate detail fields with proper text/HTML rendering
    const textFields = {
      'dSessionDate': { value: formatDate(get('SessionDate')), isHtml: false },
      'dAgentName': { value: get('AgentName'), isHtml: false },
      'dCoacheeName': { value: get('CoacheeName'), isHtml: false },
      'dCoacheeEmail': { value: get('CoacheeEmail'), isHtml: false },
      'dActionPlan': { value: get('ActionPlan'), isHtml: true }, // Render as HTML for formatting
      'dFollowUpDate': { value: formatDate(get('FollowUpDate')), isHtml: false },
      'dNotes': { value: get('Notes'), isHtml: true }, // Render as HTML for formatting
      'dCreatedAt': { value: formatDateTime(get('CreatedAt')), isHtml: false },
      'dUpdatedAt': { value: formatDateTime(get('UpdatedAt')), isHtml: false }
    };

    Object.entries(textFields).forEach(([id, { value, isHtml }]) => {
      const element = document.getElementById(id);
      if (element) {
        if (value && value !== 'Invalid Date' && value.trim() !== '') {
          if (isHtml) {
            element.innerHTML = value; // Preserve HTML formatting for rich text fields
          } else {
            element.textContent = value; // Use textContent for plain text fields to prevent XSS
          }
          element.classList.remove('empty');
        } else {
          element.textContent = 'Not specified';
          element.classList.add('empty');
        }
      }
    });

    const plannedArr = JSON.parse(get('TopicsPlanned') || '[]');
    const coveredArr = JSON.parse(get('CoveredTopics') || '[]');
    const plannedPill = document.getElementById('plannedPill');
    const coveredPill = document.getElementById('coveredPill');

    // 1) Display planned topics as pills
    if (plannedArr.length > 0) {
      plannedPill.innerHTML = plannedArr
        .map(t => `
          <div class="topic-pill ${coveredArr.includes(t.name) ? 'covered' : ''}">
            <i class="fas fa-${coveredArr.includes(t.name) ? 'check-circle' : 'circle'}"></i>
            <strong>${t.name}</strong>: ${t.detail}
          </div>
        `).join('');
    }

    // 2) Display covered topics as checkboxes
    if (plannedArr.length > 0) {
      coveredPill.innerHTML = plannedArr
        .map(t => {
          const checked = coveredArr.includes(t.name) ? 'checked' : '';
          const checkedClass = coveredArr.includes(t.name) ? 'checked' : '';
          const id = 'cov_' + t.name.replace(/\W+/g,'_');
          return `
            <div class="topic-checkbox ${checkedClass}">
              <input type="checkbox" id="${id}" value="${t.name}" ${checked}>
              <label for="${id}">${t.name}</label>
            </div>
          `;
        }).join('');
    }

    // 3) Attach change handlers
    coveredPill.querySelectorAll('input[type=checkbox]').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const parent = e.target.closest('.topic-checkbox');
        const label = parent.querySelector('label');
        
        if (e.target.checked) {
          parent.classList.add('checked');
          // Add loading state
          const originalText = label.textContent;
          label.innerHTML = '<i class="fas fa-spinner loading-spinner"></i> ' + originalText;
        } else {
          parent.classList.remove('checked');
        }

        const now = Array.from(
          coveredPill.querySelectorAll('input:checked')
        ).map(i => i.value);

        google.script.run
          .withSuccessHandler(() => {
            // Remove loading state
            label.textContent = label.textContent.replace(/^[\s]*/, '');
            // Update planned topics display
            updatePlannedTopics();
          })
          .withFailureHandler((error) => {
            console.error('Error updating covered topics:', error);
            // Revert state on error
            if (e.target.checked) {
              parent.classList.remove('checked');
              e.target.checked = false;
            } else {
              parent.classList.add('checked');
              e.target.checked = true;
            }
            label.textContent = label.textContent.replace(/^[\s]*/, '');
          })
          .updateCoveredTopics(recordId, now);
      });
    });

    function updatePlannedTopics() {
      const currentCovered = Array.from(
        coveredPill.querySelectorAll('input:checked')
      ).map(i => i.value);
      
      const updatedPills = plannedArr.map(t => `
        <div class="topic-pill ${currentCovered.includes(t.name) ? 'covered' : ''}">
          <i class="fas fa-${currentCovered.includes(t.name) ? 'check-circle' : 'circle'}"></i>
          <strong>${t.name}</strong>: ${t.detail}
        </div>
      `).join('');
      
      plannedPill.innerHTML = updatedPills;
    }

    // 4) Enable "Complete & Notify" when all covered
    const cb = document.getElementById('completeCb');
    const btn = document.getElementById('btnComplete');
    
    function updateCompletionState() {
      const currentCovered = Array.from(
        coveredPill.querySelectorAll('input:checked')
      ).length;
      
      if (plannedArr.length > 0 && currentCovered === plannedArr.length) {
        cb.checked = true;
        btn.disabled = false;
      } else {
        cb.checked = false;
        btn.disabled = true;
      }
    }

    updateCompletionState();

    cb.addEventListener('change', () => {
      btn.disabled = !cb.checked;
    });

    btn.addEventListener('click', () => {
      btn.disabled = true;
      const originalIcon = btn.querySelector('i').className;
      const originalText = btn.querySelector('span') ? btn.querySelector('span').textContent : 'Complete & Notify';
      
      btn.querySelector('i').className = 'fas fa-spinner loading-spinner';
      btn.innerHTML = '<i class="fas fa-spinner loading-spinner"></i> Processing...';

      google.script.run
        .withSuccessHandler(() => {
          btn.innerHTML = '<i class="fas fa-check-circle"></i> Completed!';
          btn.style.background = 'var(--gradient-accent)';
          setTimeout(() => {
            alert('Agent notified successfully.');
          }, 500);
        })
        .withFailureHandler(err => {
          alert('Error: ' + err.message);
          btn.disabled = false;
          btn.querySelector('i').className = originalIcon;
          btn.innerHTML = `<i class="${originalIcon}"></i> ${originalText}`;
        })
        .completeCoachingAndNotify(recordId);
    });

    // Update completion state when checkboxes change
    coveredPill.addEventListener('change', updateCompletionState);

    // Add smooth scroll for better UX
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });

    // Add tooltips for better UX
    const tooltips = [
      { selector: '.ack-button', title: 'Send acknowledgement link to coachee' },
      { selector: '.complete-button', title: 'Mark session as complete and notify all parties' },
      { selector: '.topic-checkbox', title: 'Click to mark this topic as covered' }
    ];

    tooltips.forEach(({ selector, title }) => {
      document.querySelectorAll(selector).forEach(el => {
        el.setAttribute('title', title);
      });
    });

    console.log('Modern Coaching View loaded successfully');
  });
</script>

</body>
</html>