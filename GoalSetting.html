<!-- OKR Goal Setting & Target Management Interface -->
<?!= include('layout', { baseUrl: baseUrl, user: user, currentPage: currentPage }) ?>

<style>
  .goal-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    color: white;
  }
  
  .goal-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
  }
  
  .goal-card:hover {
    transform: translateY(-2px);
  }
  
  .goal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #f0f0f0;
  }
  
  .goal-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
  }
  
  .goal-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
  }
  
  .goal-status.on-track { background: #e8f5e8; color: #2e7d32; }
  .goal-status.at-risk { background: #fff3e0; color: #f57c00; }
  .goal-status.off-track { background: #ffebee; color: #d32f2f; }
  
  .goal-progress {
    margin: 1rem 0;
  }
  
  .progress-bar-container {
    background: #f5f5f5;
    border-radius: 10px;
    height: 12px;
    overflow: hidden;
    margin: 0.5rem 0;
  }
  
  .progress-bar {
    height: 100%;
    border-radius: 10px;
    transition: width 0.6s ease;
  }
  
  .progress-bar.on-track { background: #4CAF50; }
  .progress-bar.at-risk { background: #FF9800; }
  .progress-bar.off-track { background: #F44336; }
  
  .key-result {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin: 0.5rem 0;
    border-left: 4px solid #e0e0e0;
  }
  
  .key-result.completed {
    border-left-color: #4CAF50;
    background: #f1f8e9;
  }
  
  .key-result.in-progress {
    border-left-color: #FF9800;
    background: #fff8e1;
  }
  
  .key-result.not-started {
    border-left-color: #9E9E9E;
    background: #fafafa;
  }
  
  .metric-input-group {
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    gap: 0.5rem;
    align-items: center;
    margin: 0.5rem 0;
  }
  
  .metric-label {
    font-weight: 500;
    color: #555;
  }
  
  .metric-input {
    width: 80px;
    text-align: center;
  }
  
  .quick-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .quarter-selector {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .template-card {
    border: 2px dashed #ccc;
    border-radius: 10px;
    padding: 2rem;
    text-align: center;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .template-card:hover {
    border-color: #667eea;
    background: #f8f9ff;
  }
  
  .alignment-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0.5rem 0;
  }
  
  .alignment-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }
  
  .alignment-dot.aligned { background: #4CAF50; }
  .alignment-dot.misaligned { background: #F44336; }
  .alignment-dot.partial { background: #FF9800; }
  
  .goal-analytics {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
  }
  
  .modal-lg {
    max-width: 900px;
  }
  
  .confidence-slider {
    width: 100%;
    margin: 1rem 0;
  }
  
  .timeline-view {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1rem;
  }
  
  .timeline-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .timeline-item:last-child {
    border-bottom: none;
  }
  
  .timeline-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 1rem;
    flex-shrink: 0;
  }
  
  .timeline-dot.future { background: #e0e0e0; }
  .timeline-dot.current { background: #2196F3; }
  .timeline-dot.completed { background: #4CAF50; }
  .timeline-dot.overdue { background: #F44336; }
  
  @media (max-width: 768px) {
    .goal-container {
      padding: 1rem;
    }
    
    .metric-input-group {
      grid-template-columns: 1fr;
      gap: 0.25rem;
    }
    
    .quick-actions {
      flex-direction: column;
    }
  }
</style>

<div class="container-fluid">
  <!-- Goal Management Header -->
  <div class="goal-container">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h2 class="mb-2">OKR Goal Management</h2>
        <p class="mb-0 opacity-75">Set objectives, define key results, and track progress toward organizational goals</p>
      </div>
      <div class="col-md-4 text-md-end">
        <button class="btn btn-light me-2" onclick="showGoalTemplates()">
          <i class="fas fa-templates me-1"></i>Templates
        </button>
        <button class="btn btn-warning" onclick="showCreateGoalModal()">
          <i class="fas fa-plus me-1"></i>New Goal
        </button>
      </div>
    </div>
  </div>
  
  <!-- Quarter Selector -->
  <div class="quarter-selector">
    <div class="row align-items-center">
      <div class="col-md-3">
        <label class="form-label fw-bold">Period</label>
        <select id="quarterSelect" class="form-select">
          <option value="Q1-2025">Q1 2025</option>
          <option value="Q2-2025" selected>Q2 2025</option>
          <option value="Q3-2025">Q3 2025</option>
          <option value="Q4-2025">Q4 2025</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">Department</label>
        <select id="departmentFilter" class="form-select">
          <option value="">All Departments</option>
          <option value="support">Support</option>
          <option value="sales">Sales</option>
          <option value="technical">Technical</option>
          <option value="management">Management</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">Status</label>
        <select id="statusFilter" class="form-select">
          <option value="">All Status</option>
          <option value="on-track">On Track</option>
          <option value="at-risk">At Risk</option>
          <option value="off-track">Off Track</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">Actions</label>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="exportGoals()">
            <i class="fas fa-download me-1"></i>Export
          </button>
          <button class="btn btn-outline-info btn-sm" onclick="showGoalAnalytics()">
            <i class="fas fa-chart-line me-1"></i>Analytics
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Goal Cards -->
  <div id="goalContainer">
    <!-- Goals will be loaded here -->
  </div>
  
  <!-- Timeline View -->
  <div class="timeline-view">
    <h5 class="mb-3">
      <i class="fas fa-calendar-alt me-2"></i>Timeline View
    </h5>
    <div id="timelineContainer">
      <!-- Timeline items will be loaded here -->
    </div>
  </div>
</div>

<!-- Create/Edit Goal Modal -->
<div class="modal fade" id="goalModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="goalModalTitle">Create New Goal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="goalForm">
          <input type="hidden" id="goalId">
          
          <!-- Objective Section -->
          <div class="mb-4">
            <h6 class="text-primary mb-3">Objective</h6>
            <div class="mb-3">
              <label class="form-label">Objective Title *</label>
              <input type="text" class="form-control" id="objectiveTitle" 
                     placeholder="e.g., Improve Customer Satisfaction" required>
            </div>
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Department</label>
                <select class="form-select" id="objectiveDepartment" required>
                  <option value="">Select Department</option>
                  <option value="support">Support</option>
                  <option value="sales">Sales</option>
                  <option value="technical">Technical</option>
                  <option value="management">Management</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Owner</label>
                <select class="form-select" id="objectiveOwner" required>
                  <option value="">Select Owner</option>
                  <!-- Will be populated by JavaScript -->
                </select>
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="objectiveDescription" rows="3"
                        placeholder="Describe what you want to achieve and why it matters"></textarea>
            </div>
          </div>
          
          <!-- Key Results Section -->
          <div class="mb-4">
            <h6 class="text-primary mb-3">Key Results</h6>
            <div id="keyResultsContainer">
              <!-- Key results will be added here -->
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addKeyResult()">
              <i class="fas fa-plus me-1"></i>Add Key Result
            </button>
          </div>
          
          <!-- Timeline Section -->
          <div class="mb-4">
            <h6 class="text-primary mb-3">Timeline</h6>
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" id="startDate" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Target Date</label>
                <input type="date" class="form-control" id="targetDate" required>
              </div>
            </div>
          </div>
          
          <!-- Alignment Section -->
          <div class="mb-4">
            <h6 class="text-primary mb-3">Strategic Alignment</h6>
            <div class="mb-3">
              <label class="form-label">Company Goal Alignment</label>
              <select class="form-select" id="companyAlignment">
                <option value="">Select Company Goal</option>
                <option value="growth">Revenue Growth</option>
                <option value="customer">Customer Success</option>
                <option value="innovation">Innovation</option>
                <option value="efficiency">Operational Efficiency</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Success Criteria</label>
              <textarea class="form-control" id="successCriteria" rows="2"
                        placeholder="Define what success looks like for this objective"></textarea>
            </div>
          </div>
          
          <!-- Confidence & Risk -->
          <div class="mb-4">
            <h6 class="text-primary mb-3">Assessment</h6>
            <div class="mb-3">
              <label class="form-label">Confidence Level: <span id="confidenceValue">70%</span></label>
              <input type="range" class="confidence-slider" id="confidenceLevel" 
                     min="0" max="100" value="70" oninput="updateConfidenceValue(this.value)">
              <small class="text-muted">How confident are you in achieving this goal?</small>
            </div>
            <div class="mb-3">
              <label class="form-label">Risk Assessment</label>
              <select class="form-select" id="riskLevel">
                <option value="low">Low Risk</option>
                <option value="medium">Medium Risk</option>
                <option value="high">High Risk</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveGoal()">Save Goal</button>
      </div>
    </div>
  </div>
</div>

<!-- Goal Templates Modal -->
<div class="modal fade" id="templatesModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Goal Templates</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <div class="template-card" onclick="useTemplate('customer-satisfaction')">
              <i class="fas fa-heart fa-2x text-primary mb-2"></i>
              <h6>Customer Satisfaction</h6>
              <p class="text-muted small">Improve CSAT scores and customer retention</p>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="template-card" onclick="useTemplate('team-productivity')">
              <i class="fas fa-users fa-2x text-success mb-2"></i>
              <h6>Team Productivity</h6>
              <p class="text-muted small">Increase team efficiency and output quality</p>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="template-card" onclick="useTemplate('quality-improvement')">
              <i class="fas fa-star fa-2x text-warning mb-2"></i>
              <h6>Quality Improvement</h6>
              <p class="text-muted small">Enhance service quality and reduce errors</p>
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <div class="template-card" onclick="useTemplate('efficiency-gains')">
              <i class="fas fa-rocket fa-2x text-info mb-2"></i>
              <h6>Efficiency Gains</h6>
              <p class="text-muted small">Streamline processes and reduce waste</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Goal Analytics Modal -->
<div class="modal fade" id="analyticsModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Goal Analytics</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <canvas id="goalProgressChart" height="200"></canvas>
          </div>
          <div class="col-md-6">
            <canvas id="departmentGoalsChart" height="200"></canvas>
          </div>
        </div>
        <div class="row mt-4">
          <div class="col-md-12">
            <h6>Goal Performance Summary</h6>
            <div id="goalAnalyticsSummary">
              <!-- Analytics summary will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<script>
(function() {
  let currentGoals = [];
  let users = [];
  let keyResultCounter = 0;
  
  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    initializeGoalManagement();
  });
  
  function initializeGoalManagement() {
    loadUsers();
    loadGoals();
    setupEventListeners();
    setDefaultDates();
  }
  
  function setupEventListeners() {
    document.getElementById('quarterSelect').addEventListener('change', loadGoals);
    document.getElementById('departmentFilter').addEventListener('change', filterGoals);
    document.getElementById('statusFilter').addEventListener('change', filterGoals);
  }
  
  function loadUsers() {
    google.script.run
      .withSuccessHandler(function(result) {
        users = result || [];
        updateOwnerSelect();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load users:', error);
      })
      .getAllUsersForOKR();
  }
  
  function updateOwnerSelect() {
    const select = document.getElementById('objectiveOwner');
    select.innerHTML = '<option value="">Select Owner</option>';
    
    users.forEach(user => {
      const option = document.createElement('option');
      option.value = user.email;
      option.textContent = user.name;
      select.appendChild(option);
    });
  }
  
  function loadGoals() {
    const quarter = document.getElementById('quarterSelect').value;
    
    // Mock goals data - replace with actual server call
    currentGoals = getMockGoals(quarter);
    renderGoals(currentGoals);
    renderTimeline(currentGoals);
  }
  
  function getMockGoals(quarter) {
    return [
      {
        id: 'goal-1',
        title: 'Improve Customer Satisfaction',
        department: 'support',
        owner: 'john.doe@company.com',
        status: 'on-track',
        progress: 75,
        startDate: '2025-04-01',
        targetDate: '2025-06-30',
        keyResults: [
          { id: 'kr-1', description: 'Achieve 95% CSAT score', current: 88, target: 95, unit: '%' },
          { id: 'kr-2', description: 'Reduce response time to under 2 hours', current: 3.5, target: 2, unit: 'hours' },
          { id: 'kr-3', description: 'Complete 100% of coaching sessions', current: 85, target: 100, unit: '%' }
        ],
        confidence: 80,
        riskLevel: 'medium'
      },
      {
        id: 'goal-2',
        title: 'Increase Team Productivity',
        department: 'technical',
        owner: 'jane.smith@company.com',
        status: 'at-risk',
        progress: 45,
        startDate: '2025-04-01',
        targetDate: '2025-06-30',
        keyResults: [
          { id: 'kr-4', description: 'Achieve 85% task completion rate', current: 72, target: 85, unit: '%' },
          { id: 'kr-5', description: 'Reduce overtime hours by 20%', current: 15, target: 20, unit: '%' },
          { id: 'kr-6', description: 'Complete automation project', current: 30, target: 100, unit: '%' }
        ],
        confidence: 60,
        riskLevel: 'high'
      }
    ];
  }
  
  function renderGoals(goals) {
    const container = document.getElementById('goalContainer');
    container.innerHTML = '';
    
    goals.forEach(goal => {
      const goalCard = createGoalCard(goal);
      container.appendChild(goalCard);
    });
  }
  
  function createGoalCard(goal) {
    const card = document.createElement('div');
    card.className = 'goal-card';
    
    const ownerName = users.find(u => u.email === goal.owner)?.name || goal.owner;
    
    card.innerHTML = `
      <div class="goal-header">
        <div>
          <div class="goal-title">${goal.title}</div>
          <div class="text-muted small">
            <i class="fas fa-user me-1"></i>${ownerName} • 
            <i class="fas fa-building me-1"></i>${goal.department} • 
            <i class="fas fa-calendar me-1"></i>${formatDate(goal.targetDate)}
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="goal-status ${goal.status}">${formatStatus(goal.status)}</span>
          <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="editGoal('${goal.id}')">
                <i class="fas fa-edit me-2"></i>Edit
              </a></li>
              <li><a class="dropdown-item" href="#" onclick="duplicateGoal('${goal.id}')">
                <i class="fas fa-copy me-2"></i>Duplicate
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="deleteGoal('${goal.id}')">
                <i class="fas fa-trash me-2"></i>Delete
              </a></li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class="goal-progress">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="fw-bold">Overall Progress</span>
          <span class="text-primary fw-bold">${goal.progress}%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar ${goal.status}" style="width: ${goal.progress}%"></div>
        </div>
      </div>
      
      <div class="key-results-section">
        <h6 class="mb-3">Key Results</h6>
        ${goal.keyResults.map(kr => createKeyResultHtml(kr)).join('')}
      </div>
      
      <div class="goal-analytics">
        <div class="row">
          <div class="col-md-4 text-center">
            <div class="h6 mb-1">${goal.confidence}%</div>
            <div class="small text-muted">Confidence</div>
          </div>
          <div class="col-md-4 text-center">
            <div class="h6 mb-1">${formatRiskLevel(goal.riskLevel)}</div>
            <div class="small text-muted">Risk Level</div>
          </div>
          <div class="col-md-4 text-center">
            <div class="h6 mb-1">${calculateDaysRemaining(goal.targetDate)}</div>
            <div class="small text-muted">Days Left</div>
          </div>
        </div>
      </div>
      
      <div class="quick-actions">
        <button class="btn btn-outline-primary btn-sm" onclick="updateProgress('${goal.id}')">
          <i class="fas fa-chart-line me-1"></i>Update Progress
        </button>
        <button class="btn btn-outline-success btn-sm" onclick="addCheckIn('${goal.id}')">
          <i class="fas fa-comment me-1"></i>Check-in
        </button>
        <button class="btn btn-outline-info btn-sm" onclick="viewDetails('${goal.id}')">
          <i class="fas fa-eye me-1"></i>Details
        </button>
      </div>
    `;
    
    return card;
  }
  
  function createKeyResultHtml(kr) {
    const progress = kr.target > 0 ? (kr.current / kr.target) * 100 : 0;
    const status = progress >= 100 ? 'completed' : progress >= 50 ? 'in-progress' : 'not-started';
    
    return `
      <div class="key-result ${status}">
        <div class="d-flex justify-content-between align-items-center">
          <div class="flex-grow-1">
            <div class="fw-bold mb-1">${kr.description}</div>
            <div class="small text-muted">
              ${kr.current} / ${kr.target} ${kr.unit} (${Math.round(progress)}%)
            </div>
          </div>
          <div class="text-end">
            <div class="progress-bar-container" style="width: 80px;">
              <div class="progress-bar ${getKeyResultStatus(progress)}" style="width: ${Math.min(progress, 100)}%"></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  
  function renderTimeline(goals) {
    const container = document.getElementById('timelineContainer');
    container.innerHTML = '';
    
    const timelineItems = [];
    const today = new Date();
    
    goals.forEach(goal => {
      const targetDate = new Date(goal.targetDate);
      const isOverdue = targetDate < today && goal.progress < 100;
      const isCompleted = goal.progress >= 100;
      const isCurrent = !isCompleted && !isOverdue;
      
      timelineItems.push({
        date: goal.targetDate,
        title: goal.title,
        department: goal.department,
        progress: goal.progress,
        status: isCompleted ? 'completed' : isOverdue ? 'overdue' : 'current'
      });
    });
    
    // Sort by date
    timelineItems.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    timelineItems.forEach(item => {
      const timelineItem = document.createElement('div');
      timelineItem.className = 'timeline-item';
      
      timelineItem.innerHTML = `
        <div class="timeline-dot ${item.status}"></div>
        <div class="flex-grow-1">
          <div class="fw-bold">${item.title}</div>
          <div class="small text-muted">
            ${item.department} • Due: ${formatDate(item.date)} • Progress: ${item.progress}%
          </div>
        </div>
        <div class="text-end">
          <span class="badge bg-${getStatusBadgeColor(item.status)}">${formatStatus(item.status)}</span>
        </div>
      `;
      
      container.appendChild(timelineItem);
    });
  }
  
  function filterGoals() {
    const department = document.getElementById('departmentFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    let filteredGoals = currentGoals;
    
    if (department) {
      filteredGoals = filteredGoals.filter(g => g.department === department);
    }
    
    if (status) {
      filteredGoals = filteredGoals.filter(g => g.status === status);
    }
    
    renderGoals(filteredGoals);
  }
  
  function showCreateGoalModal() {
    document.getElementById('goalModalTitle').textContent = 'Create New Goal';
    document.getElementById('goalForm').reset();
    document.getElementById('goalId').value = '';
    document.getElementById('keyResultsContainer').innerHTML = '';
    keyResultCounter = 0;
    
    // Add default key result
    addKeyResult();
    
    new bootstrap.Modal(document.getElementById('goalModal')).show();
  }
  
  function addKeyResult() {
    keyResultCounter++;
    const container = document.getElementById('keyResultsContainer');
    
    const keyResultDiv = document.createElement('div');
    keyResultDiv.className = 'key-result-input mb-3';
    keyResultDiv.innerHTML = `
      <div class="border rounded p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Key Result ${keyResultCounter}</h6>
          <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeKeyResult(this)">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div class="mb-2">
          <input type="text" class="form-control kr-description" 
                 placeholder="Describe the measurable outcome" required>
        </div>
        <div class="row">
          <div class="col-md-4">
            <label class="form-label small">Current Value</label>
            <input type="number" class="form-control kr-current" step="0.1" required>
          </div>
          <div class="col-md-4">
            <label class="form-label small">Target Value</label>
            <input type="number" class="form-control kr-target" step="0.1" required>
          </div>
          <div class="col-md-4">
            <label class="form-label small">Unit</label>
            <select class="form-select kr-unit">
              <option value="%">Percentage (%)</option>
              <option value="hours">Hours</option>
              <option value="days">Days</option>
              <option value="count">Count</option>
              <option value="score">Score</option>
              <option value="rating">Rating</option>
            </select>
          </div>
        </div>
      </div>
    `;
    
    container.appendChild(keyResultDiv);
  }
  
  function removeKeyResult(button) {
    button.closest('.key-result-input').remove();
  }
  
  function saveGoal() {
    const form = document.getElementById('goalForm');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    
    const goalData = collectGoalData();
    
    // Mock save - replace with actual server call
    console.log('Saving goal:', goalData);
    
    // Close modal and refresh
    bootstrap.Modal.getInstance(document.getElementById('goalModal')).hide();
    loadGoals();
    
    showSuccess('Goal saved successfully!');
  }
  
  function collectGoalData() {
    const keyResults = [];
    document.querySelectorAll('.key-result-input').forEach((kr, index) => {
      keyResults.push({
        id: `kr-${Date.now()}-${index}`,
        description: kr.querySelector('.kr-description').value,
        current: parseFloat(kr.querySelector('.kr-current').value),
        target: parseFloat(kr.querySelector('.kr-target').value),
        unit: kr.querySelector('.kr-unit').value
      });
    });
    
    return {
      id: document.getElementById('goalId').value || `goal-${Date.now()}`,
      title: document.getElementById('objectiveTitle').value,
      department: document.getElementById('objectiveDepartment').value,
      owner: document.getElementById('objectiveOwner').value,
      description: document.getElementById('objectiveDescription').value,
      startDate: document.getElementById('startDate').value,
      targetDate: document.getElementById('targetDate').value,
      keyResults: keyResults,
      companyAlignment: document.getElementById('companyAlignment').value,
      successCriteria: document.getElementById('successCriteria').value,
      confidence: document.getElementById('confidenceLevel').value,
      riskLevel: document.getElementById('riskLevel').value
    };
  }
  
  function showGoalTemplates() {
    new bootstrap.Modal(document.getElementById('templatesModal')).show();
  }
  
  function useTemplate(templateType) {
    const templates = {
      'customer-satisfaction': {
        title: 'Improve Customer Satisfaction',
        department: 'support',
        description: 'Enhance customer experience and satisfaction across all touchpoints',
        keyResults: [
          { description: 'Achieve 95% CSAT score', current: 0, target: 95, unit: '%' },
          { description: 'Reduce response time to under 2 hours', current: 0, target: 2, unit: 'hours' },
          { description: 'Complete 100% of customer follow-ups', current: 0, target: 100, unit: '%' }
        ]
      },
      'team-productivity': {
        title: 'Increase Team Productivity',
        department: 'management',
        description: 'Improve team efficiency and output quality through better processes and tools',
        keyResults: [
          { description: 'Achieve 90% task completion rate', current: 0, target: 90, unit: '%' },
          { description: 'Reduce project delivery time by 20%', current: 0, target: 20, unit: '%' },
          { description: 'Increase team utilization to 85%', current: 0, target: 85, unit: '%' }
        ]
      }
      // Add more templates as needed
    };
    
    const template = templates[templateType];
    if (template) {
      // Close templates modal
      bootstrap.Modal.getInstance(document.getElementById('templatesModal')).hide();
      
      // Open goal modal with template data
      showCreateGoalModal();
      
      // Fill in template data
      document.getElementById('objectiveTitle').value = template.title;
      document.getElementById('objectiveDepartment').value = template.department;
      document.getElementById('objectiveDescription').value = template.description;
      
      // Clear and add template key results
      document.getElementById('keyResultsContainer').innerHTML = '';
      keyResultCounter = 0;
      
      template.keyResults.forEach(kr => {
        addKeyResult();
        const lastKR = document.querySelector('.key-result-input:last-child');
        lastKR.querySelector('.kr-description').value = kr.description;
        lastKR.querySelector('.kr-current').value = kr.current;
        lastKR.querySelector('.kr-target').value = kr.target;
        lastKR.querySelector('.kr-unit').value = kr.unit;
      });
    }
  }
  
  function showGoalAnalytics() {
    new bootstrap.Modal(document.getElementById('analyticsModal')).show();
    
    // Mock analytics data - replace with actual calculations
    setTimeout(() => {
      createGoalProgressChart();
      createDepartmentGoalsChart();
      updateAnalyticsSummary();
    }, 100);
  }
  
  function createGoalProgressChart() {
    const ctx = document.getElementById('goalProgressChart');
    if (!ctx) return;
    
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['On Track', 'At Risk', 'Off Track'],
        datasets: [{
          data: [60, 30, 10],
          backgroundColor: ['#4CAF50', '#FF9800', '#F44336']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Goal Status Distribution'
          },
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
  
  function createDepartmentGoalsChart() {
    const ctx = document.getElementById('departmentGoalsChart');
    if (!ctx) return;
    
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Support', 'Sales', 'Technical', 'Management'],
        datasets: [{
          label: 'Average Progress',
          data: [75, 60, 80, 70],
          backgroundColor: '#667eea'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Progress by Department'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100
          }
        }
      }
    });
  }
  
  function updateAnalyticsSummary() {
    const summary = document.getElementById('goalAnalyticsSummary');
    summary.innerHTML = `
      <div class="row">
        <div class="col-md-3 text-center">
          <div class="h4 text-primary">12</div>
          <div class="small text-muted">Total Goals</div>
        </div>
        <div class="col-md-3 text-center">
          <div class="h4 text-success">8</div>
          <div class="small text-muted">On Track</div>
        </div>
        <div class="col-md-3 text-center">
          <div class="h4 text-warning">3</div>
          <div class="small text-muted">At Risk</div>
        </div>
        <div class="col-md-3 text-center">
          <div class="h4 text-danger">1</div>
          <div class="small text-muted">Off Track</div>
        </div>
      </div>
    `;
  }
  
  function setDefaultDates() {
    const today = new Date();
    const quarterEnd = new Date(today.getFullYear(), today.getMonth() + 3, 0);
    
    document.getElementById('startDate').value = today.toISOString().split('T')[0];
    document.getElementById('targetDate').value = quarterEnd.toISOString().split('T')[0];
  }
  
  function updateConfidenceValue(value) {
    document.getElementById('confidenceValue').textContent = value + '%';
  }
  
  // Action functions (implement as needed)
  function editGoal(goalId) {
    console.log('Edit goal:', goalId);
    // Implement goal editing
  }
  
  function duplicateGoal(goalId) {
    console.log('Duplicate goal:', goalId);
    // Implement goal duplication
  }
  
  function deleteGoal(goalId) {
    if (confirm('Are you sure you want to delete this goal?')) {
      console.log('Delete goal:', goalId);
      // Implement goal deletion
      loadGoals();
    }
  }
  
  function updateProgress(goalId) {
    console.log('Update progress for goal:', goalId);
    // Implement progress update
  }
  
  function addCheckIn(goalId) {
    console.log('Add check-in for goal:', goalId);
    // Implement check-in functionality
  }
  
  function viewDetails(goalId) {
    console.log('View details for goal:', goalId);
    // Implement detailed view
  }
  
  function exportGoals() {
    console.log('Export goals');
    // Implement export functionality
  }
  
  // Utility functions
  function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
  }
  
  function formatStatus(status) {
    return status.split('-').map(word => 
      word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
  }
  
  function formatRiskLevel(level) {
    return level.charAt(0).toUpperCase() + level.slice(1);
  }
  
  function calculateDaysRemaining(targetDate) {
    const today = new Date();
    const target = new Date(targetDate);
    const diffTime = target - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays > 0 ? `${diffDays} days` : 'Overdue';
  }
  
  function getKeyResultStatus(progress) {
    if (progress >= 100) return 'on-track';
    if (progress >= 75) return 'on-track';
    if (progress >= 50) return 'at-risk';
    return 'off-track';
  }
  
  function getStatusBadgeColor(status) {
    switch (status) {
      case 'completed': return 'success';
      case 'current': return 'primary';
      case 'overdue': return 'danger';
      default: return 'secondary';
    }
  }
  
  function showSuccess(message) {
    // Implement success notification
    alert(message);
  }
  
})();
</script>