<!-- UserProfile.html -->
<?
  var safeBaseUrl = (typeof baseUrl !== 'undefined' && baseUrl) ? baseUrl : (typeof scriptUrl !== 'undefined' && scriptUrl ? scriptUrl : '');
  var initialBootstrap = (typeof profileBootstrap !== 'undefined' && profileBootstrap) ? profileBootstrap : '{}';
?>
<?!= include('layout', {
  baseUrl: safeBaseUrl,
  scriptUrl: scriptUrl,
  user: user || {},
  currentPage: currentPage || 'User Profile',
  pageSlug: 'userprofile',
  pageTitle: 'My Profile',
  pageDescription: 'Review your personal details, access, and equipment in LuminaHQ.'
}) ?>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-b7H3c5ZLfuD3yF5uxoFODdgNpTiFqouBZfyqCkCmZJLdnOjFkWDXLI4YAlnXrhIRbkIuAeGHGZMRYPdP4h4lrw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --profile-navy: #0b1f33;
    --profile-cyan: #0ea5e9;
    --profile-mint: #22c55e;
    --profile-lavender: #6366f1;
    --profile-surface: #ffffff;
    --profile-soft: #f3f5fb;
    --profile-border: #d7deed;
    --profile-text: #0f172a;
    --profile-text-secondary: #475569;
    --profile-shadow: 0 22px 45px rgba(11, 31, 51, 0.12);
    --profile-radius-lg: 20px;
    --profile-radius-md: 18px;
    --profile-radius-sm: 12px;
    --profile-transition: all 0.2s ease;
    --chip-bg: rgba(14, 165, 233, 0.1);
  }

  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(180deg, #f5f7fb 0%, #ffffff 60%);
    color: var(--profile-text);
  }

  .profile-wrapper {
    padding: clamp(1.5rem, 3vw, 3rem);
    max-width: 1200px;
    margin: 0 auto 3.5rem auto;
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }

  .profile-hero {
    background: linear-gradient(135deg, rgba(2, 43, 91, 0.95) 0%, rgba(17, 94, 185, 0.82) 45%, rgba(0, 188, 212, 0.75) 100%);
    border-radius: var(--profile-radius-lg);
    padding: clamp(1.75rem, 3vw, 3rem);
    margin-bottom: 2.5rem;
    position: relative;
    overflow: hidden;
    box-shadow: var(--profile-shadow);
    color: #fff;
  }

  .profile-hero::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.35), transparent 55%);
    opacity: 0.9;
  }

  .profile-hero-content {
    position: relative;
    display: flex;
    gap: clamp(1.5rem, 3vw, 3rem);
    align-items: center;
    flex-wrap: wrap;
  }

  .profile-summary-card {
    background: var(--profile-surface);
    border-radius: var(--profile-radius-lg);
    padding: clamp(1.5rem, 2.5vw, 2.25rem);
    box-shadow: var(--profile-shadow);
    border: 1px solid rgba(11, 31, 51, 0.05);
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }

  .profile-summary-main {
    display: flex;
    align-items: center;
    gap: clamp(1.25rem, 3vw, 2.5rem);
    flex-wrap: wrap;
  }

  .profile-summary-details {
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    min-width: 240px;
  }

  .profile-summary-details h1 {
    font-size: clamp(2rem, 3vw, 2.6rem);
    font-weight: 700;
    margin: 0;
    color: var(--profile-navy);
  }

  .profile-summary-details p {
    margin: 0;
    font-size: 1.05rem;
    color: var(--profile-text-secondary);
  }

  .profile-summary-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .profile-summary-action {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.7rem 1.15rem;
    border-radius: 999px;
    font-weight: 600;
    text-decoration: none;
    transition: var(--profile-transition);
    border: 1px solid transparent;
  }

  .profile-summary-action.primary {
    background: linear-gradient(135deg, #0ea5e9, #2563eb);
    color: #fff;
    border-color: rgba(14, 165, 233, 0.35);
    box-shadow: 0 12px 24px rgba(14, 165, 233, 0.25);
  }

  .profile-summary-action.secondary {
    background: rgba(14, 165, 233, 0.08);
    color: var(--profile-navy);
    border-color: rgba(14, 165, 233, 0.2);
  }

  .profile-summary-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 16px 32px rgba(15, 23, 42, 0.12);
  }

  .profile-avatar {
    width: clamp(88px, 9vw, 112px);
    height: clamp(88px, 9vw, 112px);
    border-radius: 28px;
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.25), rgba(99, 102, 241, 0.3));
    border: 1px solid rgba(14, 165, 233, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(2.25rem, 3.5vw, 3rem);
    font-weight: 700;
    color: var(--profile-navy);
    box-shadow: inset 0 12px 24px rgba(14, 165, 233, 0.08);
  }

  .profile-identity h1 {
    font-size: clamp(2rem, 3.2vw, 2.8rem);
    margin-bottom: 0.35rem;
    font-weight: 700;
  }

  .profile-identity p {
    margin: 0;
    font-size: clamp(1rem, 1.4vw, 1.2rem);
    color: rgba(255, 255, 255, 0.85);
  }

  .profile-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
  }

  .profile-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: rgba(14, 165, 233, 0.12);
    padding: 0.45rem 0.75rem;
    border-radius: 999px;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--profile-navy);
  }

  .profile-action {
    position: relative;
    margin-left: auto;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: flex-end;
  }

  .profile-action a {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.65rem 1.2rem;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    font-weight: 600;
    text-decoration: none;
    transition: var(--profile-transition);
    border: 1px solid rgba(255, 255, 255, 0.32);
    backdrop-filter: blur(6px);
  }

  .profile-action a.secondary {
    background: rgba(2, 43, 91, 0.15);
    border-color: rgba(255, 255, 255, 0.28);
  }

  .profile-action a:hover {
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.26);
  }

  .profile-action a.secondary:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .profile-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.75rem;
  }

  .profile-card {
    background: var(--profile-surface);
    border-radius: var(--profile-radius-md);
    padding: 1.75rem;
    box-shadow: 0 12px 28px rgba(15, 23, 42, 0.06);
    border: 1px solid rgba(15, 23, 42, 0.05);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .profile-card h2 {
    font-size: 1.35rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.65rem;
    color: var(--profile-text);
  }

  .profile-card h2 i {
    color: var(--profile-navy);
  }

  .profile-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .profile-card-body {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .collapsible-card .profile-card-body[hidden] {
    display: none;
  }

  .collapsible-toggle {
    border: none;
    background: rgba(14, 165, 233, 0.08);
    color: var(--profile-navy);
    border-radius: 999px;
    padding: 0.45rem 0.9rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    cursor: pointer;
    transition: var(--profile-transition);
  }

  .collapsible-toggle:hover {
    background: rgba(14, 165, 233, 0.16);
  }

  .collapsible-toggle i {
    transition: transform 0.2s ease;
  }

  .collapsible-toggle[aria-expanded="true"] i {
    transform: rotate(180deg);
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.1rem 1.35rem;
  }

  .info-item {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    background: var(--profile-soft);
    border-radius: var(--profile-radius-sm);
    padding: 0.95rem 1rem;
    border: 1px solid rgba(15, 23, 42, 0.04);
  }

  .info-label {
    font-size: 0.78rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: var(--profile-text-secondary);
    font-weight: 600;
  }

  .info-value {
    font-size: 1rem;
    font-weight: 600;
    color: var(--profile-text);
    word-break: break-word;
  }

  .info-value a {
    color: inherit;
    text-decoration: none;
  }

  .info-value a:hover {
    text-decoration: underline;
  }

  .chip-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    margin-bottom: 1.1rem;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.4rem 0.85rem;
    border-radius: 999px;
    background: var(--chip-bg);
    color: var(--profile-navy);
    font-weight: 600;
    font-size: 0.9rem;
  }

  .chip i {
    font-size: 0.9rem;
  }

  .empty-state {
    font-size: 0.95rem;
    color: var(--profile-text-secondary);
    background: var(--profile-soft);
    border: 1px dashed rgba(14, 165, 233, 0.25);
    border-radius: var(--profile-radius-sm);
    padding: 1rem;
    text-align: center;
  }

  .equipment-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 0.85rem;
  }

  .equipment-item {
    padding: 0.9rem 1rem;
    border-radius: var(--profile-radius-sm);
    background: var(--profile-soft);
    border: 1px solid rgba(14, 165, 233, 0.18);
    display: grid;
    gap: 0.25rem;
  }

  .equipment-item strong {
    font-size: 1rem;
    color: var(--profile-text);
  }

  .equipment-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.45rem 0.8rem;
    font-size: 0.85rem;
    color: var(--profile-text-secondary);
  }

  .hidden {
    display: none !important;
  }

  .manager-card {
    grid-column: 1 / -1;
  }

  .manager-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .manager-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.45rem 0.9rem;
    border-radius: 999px;
    background: rgba(14, 165, 233, 0.12);
    color: var(--profile-navy);
    font-weight: 600;
    font-size: 0.85rem;
  }

  .manager-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
    margin-bottom: 1.25rem;
  }

  .manager-stat {
    background: var(--profile-soft);
    border-radius: var(--profile-radius-sm);
    border: 1px solid rgba(14, 165, 233, 0.18);
    padding: 0.9rem 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .manager-stat .label {
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--profile-text-secondary);
  }

  .manager-stat .value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--profile-navy);
  }

  .manager-list {
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
  }

  .manager-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 1rem 1.15rem;
    border-radius: var(--profile-radius-sm);
    border: 1px solid rgba(14, 165, 233, 0.18);
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.05), rgba(99, 102, 241, 0.05));
  }

  .manager-row .info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .manager-row .info strong {
    font-size: 1rem;
    color: var(--profile-text);
  }

  .manager-row .info span {
    font-size: 0.85rem;
    color: var(--profile-text-secondary);
  }

  .manager-row .metrics {
    display: flex;
    align-items: center;
    gap: 1.35rem;
    flex-wrap: wrap;
  }

  .manager-row .metric {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }

  .manager-row .metric .label {
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--profile-text-secondary);
  }

  .manager-row .metric .value {
    font-weight: 700;
    font-size: 1.05rem;
    color: var(--profile-navy);
  }

  .manager-row .metric small {
    font-size: 0.75rem;
    color: var(--profile-text-secondary);
  }

  .manager-summary-empty {
    margin-top: 0.5rem;
  }

  .manager-pagination {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .manager-pagination.hidden {
    display: none !important;
  }

  .manager-pagination__range {
    font-size: 0.9rem;
    color: var(--profile-text-secondary);
  }

  .manager-pagination__controls {
    display: inline-flex;
    gap: 0.5rem;
  }

  .manager-pagination__button {
    border: 1px solid rgba(14, 165, 233, 0.35);
    background: rgba(14, 165, 233, 0.12);
    color: var(--profile-navy);
    border-radius: 999px;
    padding: 0.4rem 0.9rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    transition: var(--profile-transition);
  }

  .manager-pagination__button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .manager-pagination__button:not(:disabled):hover {
    background: rgba(14, 165, 233, 0.18);
  }

  .loader {
    display: none;
    align-items: center;
    gap: 0.65rem;
    font-size: 0.95rem;
    color: var(--profile-text-secondary);
    margin-top: 1rem;
  }

  .loader.show {
    display: inline-flex;
  }

  .loader .spinner {
    width: 18px;
    height: 18px;
    border: 3px solid rgba(14, 165, 233, 0.18);
    border-top-color: var(--profile-cyan);
    border-radius: 50%;
    animation: spin 0.75s linear infinite;
  }

  .banner-chip-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .banner-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: rgba(14, 165, 233, 0.12);
    border-radius: 999px;
    padding: 0.35rem 0.7rem;
    font-size: 0.85rem;
    color: var(--profile-navy);
    font-weight: 600;
  }

  .banner-chip i {
    font-size: 0.8rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @media (max-width: 768px) {
    .profile-summary-card {
      padding: 1.5rem;
    }

    .profile-summary-main {
      text-align: center;
      justify-content: center;
    }

    .profile-summary-actions {
      flex-direction: column;
    }

    .profile-summary-action {
      width: 100%;
      justify-content: center;
    }

    .profile-card {
      padding: 1.5rem;
    }

    .info-grid {
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .manager-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 1.25rem;
    }

    .manager-row .metrics {
      width: 100%;
      justify-content: space-between;
    }
  }
</style>

<div class="profile-wrapper">
  <div class="profile-summary-card">
    <div class="profile-summary-main">
      <div class="profile-avatar" id="profileAvatar">U</div>
      <div class="profile-summary-details">
        <h1 id="profileName">User</h1>
        <p id="profileRole">Loading role…</p>
        <div class="profile-chips" id="profileChips"></div>
      </div>
    </div>
    <div class="profile-summary-actions">
      <a id="agentExperienceLink" class="profile-summary-action primary" href="#" target="_top">
        <i class="fa-solid fa-user-gear"></i>
        Agent Experience
      </a>
      <a id="agentScheduleLink" class="profile-summary-action secondary" href="#" target="_top">
        <i class="fa-solid fa-calendar-days"></i>
        View Schedule
      </a>
    </div>
  </div>

  <div class="profile-grid">
    <section class="profile-card">
      <h2><i class="fa-solid fa-id-card"></i> Personal Information</h2>
      <div class="info-grid" id="personalDetails"></div>
    </section>

    <section class="profile-card">
      <h2><i class="fa-solid fa-briefcase"></i> Employment</h2>
      <div class="info-grid" id="employmentDetails"></div>
    </section>

    <section class="profile-card collapsible-card">
      <div class="profile-card-header">
        <h2><i class="fa-solid fa-user-shield"></i> Access &amp; Permissions</h2>
        <button class="collapsible-toggle" type="button" data-target="accessPermissionsPanel"
          data-collapsed-text="Show access" data-expanded-text="Hide access" aria-expanded="false">
          <span class="collapsible-toggle__label">Show access</span>
          <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
        </button>
      </div>
      <div class="profile-card-body" id="accessPermissionsPanel" hidden>
        <div class="chip-row" id="roleChips"></div>
        <div class="chip-row" id="pageChips"></div>
        <div class="info-grid" id="accessDetails"></div>
      </div>
    </section>

    <section class="profile-card">
      <h2><i class="fa-solid fa-lock"></i> Security</h2>
      <div class="info-grid" id="securityDetails"></div>
    </section>

    <section class="profile-card">
      <h2><i class="fa-solid fa-laptop"></i> Equipment &amp; Resources</h2>
      <ul class="equipment-list" id="equipmentList"></ul>
      <div class="loader" id="equipmentLoader">
        <div class="spinner"></div>
        Fetching equipment…
      </div>
    </section>

    <section class="profile-card manager-card hidden" id="managerSummaryCard">
      <div class="manager-card-header">
        <h2><i class="fa-solid fa-people-group"></i> Managed Team Overview</h2>
        <span class="manager-chip" id="managerSummaryManagedCount">
          <i class="fa-solid fa-user-group"></i>
          0 Managed
        </span>
      </div>
      <div class="manager-stats" id="managerSummaryStats"></div>
      <div class="manager-list" id="managerSummaryList"></div>
      <div class="manager-pagination hidden" id="managerSummaryPagination"></div>
      <div class="empty-state manager-summary-empty hidden" id="managerSummaryEmpty">
        No managed team members are assigned to you yet.
      </div>
      <div class="loader" id="managerSummaryLoader">
        <div class="spinner"></div>
        Compiling team performance…
      </div>
    </section>
  </div>
</div>

<script>
  const CURRENT_USER = <?!= currentUserJson || '{}' ?>;
  const PROFILE_BOOTSTRAP = <?!= initialBootstrap || '{}' ?> || {};

  const state = {
    user: (PROFILE_BOOTSTRAP.user && Object.keys(PROFILE_BOOTSTRAP.user).length ? PROFILE_BOOTSTRAP.user : CURRENT_USER) || {},
    detail: PROFILE_BOOTSTRAP.detail || null,
    pages: PROFILE_BOOTSTRAP.pages || [],
    equipment: PROFILE_BOOTSTRAP.equipment || [],
    permissions: PROFILE_BOOTSTRAP.permissions || null,
    campaignId: PROFILE_BOOTSTRAP.campaignId || (CURRENT_USER ? CURRENT_USER.CampaignID || CURRENT_USER.campaignId || '' : ''),
    managerSummary: PROFILE_BOOTSTRAP.managerSummary || null,
    loadingEquipment: false,
    loadingManagerSummary: false,
    managerPagination: { page: 1, pageSize: 6 }
  };

  function setText(id, value, fallback = '') {
    const el = document.getElementById(id);
    if (!el) return;
    const text = value === null || typeof value === 'undefined' ? fallback : String(value);
    el.textContent = text || fallback;
  }

  function safeString(value) {
    if (value === null || typeof value === 'undefined') return '';
    const text = String(value).trim();
    if (!text || text.toLowerCase() === 'undefined' || text.toLowerCase() === 'null') return '';
    return text;
  }

  function resolveBaseUrl() {
    if (typeof safeBaseUrl !== 'undefined' && safeBaseUrl) return safeBaseUrl;
    if (typeof BASE_URL !== 'undefined' && BASE_URL) return BASE_URL;
    if (typeof scriptUrl !== 'undefined' && scriptUrl) return scriptUrl;
    if (typeof SCRIPT_URL !== 'undefined' && SCRIPT_URL) return SCRIPT_URL;
    return '';
  }

  function buildPageLink(slug, extraParams = {}) {
    const params = Object.assign({ page: slug }, extraParams || {});
    const query = Object.keys(params)
      .filter(key => params[key] !== undefined && params[key] !== null && params[key] !== '')
      .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
      .join('&');
    const base = resolveBaseUrl();
    if (!base) {
      return `?${query}`;
    }
    const joiner = base.includes('?') ? '&' : '?';
    return `${base}${joiner}${query}`;
  }

  function caseInsensitiveLookup(source, key) {
    if (!source || typeof source !== 'object') return undefined;
    if (Object.prototype.hasOwnProperty.call(source, key)) {
      return source[key];
    }
    const lower = String(key).toLowerCase();
    const keys = Object.keys(source);
    for (let i = 0; i < keys.length; i++) {
      const candidate = keys[i];
      if (String(candidate).toLowerCase() === lower) {
        return source[candidate];
      }
    }
    return undefined;
  }

  function getField(record, keys) {
    if (!record || typeof record !== 'object') return '';
    const list = Array.isArray(keys) ? keys : [keys];
    for (let i = 0; i < list.length; i++) {
      const key = list[i];
      if (!key) continue;
      let value = caseInsensitiveLookup(record, key);
      if (value !== undefined && value !== null && safeString(value) !== '') {
        return value;
      }
      if (record.sheetFieldMap) {
        value = caseInsensitiveLookup(record.sheetFieldMap, key);
        if (value !== undefined && value !== null && safeString(value) !== '') {
          return value;
        }
      }
      if (Array.isArray(record.sheetFields)) {
        for (let f = 0; f < record.sheetFields.length; f++) {
          const field = record.sheetFields[f];
          if (!field || typeof field !== 'object') continue;
          const normalizedKey = safeString(field.key);
          if (normalizedKey && normalizedKey.toLowerCase() === String(key).toLowerCase()) {
            const candidate = field.value;
            if (candidate !== undefined && candidate !== null && safeString(candidate) !== '') {
              return candidate;
            }
          }
        }
      }
    }
    return '';
  }

  function normalizeList(input) {
    if (!input) return [];
    if (Array.isArray(input)) {
      return input
        .map(value => safeString(value))
        .filter(Boolean);
    }
    const text = safeString(input);
    if (!text) return [];
    if (text.startsWith('[') && text.endsWith(']')) {
      try {
        const parsed = JSON.parse(text);
        if (Array.isArray(parsed)) {
          return parsed.map(value => safeString(value)).filter(Boolean);
        }
      } catch (_) { /* ignore */ }
    }
    return text.split(/[,;|]+/).map(part => safeString(part)).filter(Boolean);
  }

  function formatDate(value) {
    if (!value) return '';
    try {
      const date = value instanceof Date ? value : new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    } catch (_) {
      return '';
    }
  }

  function formatTenure(value) {
    if (!value) return '';
    try {
      const start = value instanceof Date ? value : new Date(value);
      if (Number.isNaN(start.getTime())) return '';

      const now = new Date();
      let years = now.getFullYear() - start.getFullYear();
      let months = now.getMonth() - start.getMonth();
      let days = now.getDate() - start.getDate();

      if (days < 0) {
        months -= 1;
        const priorMonth = new Date(now.getFullYear(), now.getMonth(), 0).getDate();
        days += priorMonth;
      }

      if (months < 0) {
        years -= 1;
        months += 12;
      }

      const parts = [];
      if (years > 0) {
        parts.push(`${years} yr${years > 1 ? 's' : ''}`);
      }
      if (months > 0) {
        parts.push(`${months} mo${months > 1 ? 's' : ''}`);
      }
      if (!parts.length && days > 0) {
        parts.push(`${days} day${days > 1 ? 's' : ''}`);
      }
      if (!parts.length) {
        parts.push('Less than a day');
      }

      return parts.join(' ');
    } catch (_) {
      return '';
    }
  }

  function formatBoolean(value, { positive = 'Yes', negative = 'No' } = {}) {
    const truthy = value === true || String(value).toLowerCase() === 'true' || String(value) === '1' || String(value).toLowerCase() === 'yes';
    const falsy = value === false || String(value).toLowerCase() === 'false' || String(value) === '0' || String(value).toLowerCase() === 'no';
    if (truthy) return positive;
    if (falsy) return negative;
    return '';
  }

  function formatRelativeTime(value) {
    if (!value) return '';
    try {
      const date = value instanceof Date ? value : new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      const now = Date.now();
      const diff = now - date.getTime();
      const abs = Math.abs(diff);
      const minute = 60 * 1000;
      const hour = 60 * minute;
      const day = 24 * hour;
      const week = 7 * day;

      let amount;
      let unit;
      if (abs < hour) {
        amount = Math.max(1, Math.round(abs / minute));
        unit = 'min';
      } else if (abs < day) {
        amount = Math.max(1, Math.round(abs / hour));
        unit = 'hr';
      } else if (abs < week) {
        amount = Math.max(1, Math.round(abs / day));
        unit = 'day';
      } else {
        amount = Math.max(1, Math.round(abs / week));
        unit = 'wk';
      }

      const plural = amount === 1 ? '' : 's';
      const suffix = diff >= 0 ? 'ago' : 'from now';
      return `${amount} ${unit}${plural} ${suffix}`;
    } catch (_) {
      return '';
    }
  }

  function formatScore(value, { decimals = 1 } = {}) {
    const num = Number(value);
    if (!Number.isFinite(num)) return '—';
    const factor = Math.pow(10, decimals);
    const rounded = Math.round(num * factor) / factor;
    const text = decimals === 0 ? String(Math.round(rounded)) : rounded.toFixed(decimals).replace(/\.0+$/, '');
    return `${text}%`;
  }

  function createInfoItem(label, value, options = {}) {
    const container = document.createElement('div');
    container.className = 'info-item';

    const labelEl = document.createElement('div');
    labelEl.className = 'info-label';
    labelEl.textContent = label;
    container.appendChild(labelEl);

    const valueEl = document.createElement('div');
    valueEl.className = 'info-value';
    if (options.isLink) {
      const link = document.createElement('a');
      link.href = options.href || `mailto:${value}`;
      link.textContent = value;
      link.target = options.target || '_blank';
      valueEl.appendChild(link);
    } else {
      valueEl.textContent = value;
    }
    container.appendChild(valueEl);

    return container;
  }

  function renderInfoGrid(containerId, fields, record) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    const nodes = [];
    fields.forEach(def => {
      const raw = getField(record, def.keys);
      let value = safeString(raw);

      if (def.transform) {
        value = def.transform(raw, record, state.user);
      }

      if (!value) return;
      nodes.push(createInfoItem(def.label, value, def));
    });

    if (!nodes.length) {
      const empty = document.createElement('div');
      empty.className = 'empty-state';
      empty.textContent = 'No details available yet.';
      container.appendChild(empty);
      return;
    }

    nodes.forEach(node => container.appendChild(node));
  }

  function renderChips(containerId, values, icon) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    const list = normalizeList(values);
    if (!list.length) {
      container.classList.add('empty');
      return;
    }
    container.classList.remove('empty');

    list.forEach(value => {
      const chip = document.createElement('span');
      chip.className = 'chip';
      if (icon) {
        const iconEl = document.createElement('i');
        iconEl.className = icon;
        chip.appendChild(iconEl);
      }
      const text = document.createElement('span');
      text.textContent = value;
      chip.appendChild(text);
      container.appendChild(chip);
    });
  }

  function renderEquipment(items) {
    const listEl = document.getElementById('equipmentList');
    const loader = document.getElementById('equipmentLoader');
    if (loader) loader.classList.remove('show');
    if (!listEl) return;
    listEl.innerHTML = '';

    if (state.loadingEquipment) {
      return;
    }

    if (!Array.isArray(items) || !items.length) {
      const empty = document.createElement('li');
      empty.className = 'empty-state';
      empty.textContent = 'No assigned equipment on record.';
      listEl.appendChild(empty);
      return;
    }

    items.forEach(item => {
      const li = document.createElement('li');
      li.className = 'equipment-item';
      const name = safeString(item.ItemName || item.itemName || item.DisplayName || item.displayName || 'Equipment');
      const type = safeString(item.ItemType || item.itemType);
      const serial = safeString(item.SerialNumber || item.serialNumber);
      const status = safeString(item.Status || item.status || item.Condition || item.condition);
      const issued = formatDate(item.IssuedDate || item.issuedDate || item.CreatedAt || item.createdAt);
      const returned = formatDate(item.ReturnedDate || item.returnedDate);

      const heading = document.createElement('strong');
      heading.textContent = name;
      li.appendChild(heading);

      const meta = document.createElement('div');
      meta.className = 'equipment-meta';
      if (type) meta.appendChild(document.createTextNode(type));
      if (serial) meta.appendChild(document.createTextNode(`SN: ${serial}`));
      if (status) meta.appendChild(document.createTextNode(`Status: ${status}`));
      if (issued) meta.appendChild(document.createTextNode(`Issued ${issued}`));
      if (returned) meta.appendChild(document.createTextNode(`Returned ${returned}`));
      li.appendChild(meta);

      if (safeString(item.Notes || item.notes)) {
        const notes = document.createElement('div');
        notes.textContent = safeString(item.Notes || item.notes);
        notes.style.fontSize = '0.85rem';
        notes.style.color = 'var(--profile-text-secondary)';
        li.appendChild(notes);
      }

      listEl.appendChild(li);
    });
  }

  function createManagerMetric(label, value, secondary) {
    const metric = document.createElement('div');
    metric.className = 'metric';

    const labelEl = document.createElement('span');
    labelEl.className = 'label';
    labelEl.textContent = label;
    metric.appendChild(labelEl);

    const valueEl = document.createElement('span');
    valueEl.className = 'value';
    valueEl.textContent = value;
    metric.appendChild(valueEl);

    if (secondary) {
      const secondaryEl = document.createElement('small');
      secondaryEl.textContent = secondary;
      metric.appendChild(secondaryEl);
    }

    return metric;
  }

  function renderManagerSummary(summary) {
    const card = document.getElementById('managerSummaryCard');
    if (!card) return;

    const loader = document.getElementById('managerSummaryLoader');
    if (loader) {
      if (state.loadingManagerSummary) {
        loader.classList.add('show');
      } else {
        loader.classList.remove('show');
      }
    }

    const shouldShow = isLikelyManager(summary);
    if (!shouldShow) {
      card.classList.add('hidden');
      return;
    }
    card.classList.remove('hidden');

    const statsEl = document.getElementById('managerSummaryStats');
    const listEl = document.getElementById('managerSummaryList');
    const emptyEl = document.getElementById('managerSummaryEmpty');
    const countEl = document.getElementById('managerSummaryManagedCount');
    const paginationEl = document.getElementById('managerSummaryPagination');

    if (emptyEl && state.loadingManagerSummary) {
      emptyEl.classList.add('hidden');
    }

    if (countEl) {
      countEl.innerHTML = '<i class="fa-solid fa-user-group"></i> 0 Managed';
    }
    if (statsEl) statsEl.innerHTML = '';
    if (listEl) listEl.innerHTML = '';
    if (paginationEl) {
      paginationEl.innerHTML = '';
      paginationEl.classList.add('hidden');
    }

    if (!summary) {
      if (emptyEl && !state.loadingManagerSummary) {
        emptyEl.textContent = 'Managed team insights will appear here once available.';
        emptyEl.classList.remove('hidden');
      }
      return;
    }

    if (summary.success === false) {
      if (emptyEl && !state.loadingManagerSummary) {
        const message = summary && summary.error ? summary.error : 'We could not load your team summary right now.';
        emptyEl.textContent = message;
        emptyEl.classList.remove('hidden');
      }
      return;
    }

    const users = Array.isArray(summary.users) ? summary.users.slice() : [];
    const totals = summary.totals || {};

    const managedCount = typeof totals.managedCount === 'number' ? totals.managedCount : users.length;
    const totalEvaluations = typeof totals.totalEvaluations === 'number'
      ? totals.totalEvaluations
      : users.reduce((sum, user) => sum + (Number(user && user.evaluations) || 0), 0);
    const lastEvaluationDate = totals.lastEvaluation || (function () {
      let latest = null;
      users.forEach(user => {
        if (!user || !user.lastEvaluation) return;
        const date = new Date(user.lastEvaluation);
        if (Number.isNaN(date.getTime())) return;
        if (!latest || date > latest) latest = date;
      });
      return latest ? latest.toISOString() : '';
    })();

    if (countEl) {
      countEl.innerHTML = `<i class="fa-solid fa-user-group"></i> ${managedCount} Managed`;
    }

    if (statsEl) {
      const stats = [
        { label: 'Managed Agents', value: managedCount },
        { label: 'Team Avg Score', value: formatScore(totals.scoreAverage) },
        { label: 'Total Evaluations', value: totalEvaluations },
        { label: 'Last Evaluation', value: lastEvaluationDate ? (formatDate(lastEvaluationDate) || '—') : '—', secondary: lastEvaluationDate ? formatRelativeTime(lastEvaluationDate) : '' }
      ];

      stats.forEach(stat => {
        const statEl = document.createElement('div');
        statEl.className = 'manager-stat';

        const labelEl = document.createElement('span');
        labelEl.className = 'label';
        labelEl.textContent = stat.label;
        statEl.appendChild(labelEl);

        const valueEl = document.createElement('span');
        valueEl.className = 'value';
        valueEl.textContent = stat.value;
        statEl.appendChild(valueEl);

        if (stat.secondary) {
          const secondaryEl = document.createElement('small');
          secondaryEl.textContent = stat.secondary;
          statEl.appendChild(secondaryEl);
        }

        statsEl.appendChild(statEl);
      });
    }

    if (!users.length) {
      if (emptyEl) {
        emptyEl.textContent = 'No managed team members are assigned to you yet.';
        emptyEl.classList.remove('hidden');
      }
      if (paginationEl) {
        paginationEl.classList.add('hidden');
      }
      state.managerPagination.page = 1;
      return;
    }

    if (emptyEl) {
      emptyEl.classList.add('hidden');
    }

    users.sort((a, b) => {
      const aScore = Number(a && a.averageScore);
      const bScore = Number(b && b.averageScore);
      if (Number.isFinite(bScore) && Number.isFinite(aScore)) {
        return bScore - aScore;
      }
      if (Number.isFinite(bScore)) return 1;
      if (Number.isFinite(aScore)) return -1;
      const aName = safeString(a && (a.name || a.FullName || a.fullName || a.UserName || a.userName));
      const bName = safeString(b && (b.name || b.FullName || b.fullName || b.UserName || b.userName));
      return aName.localeCompare(bName);
    });

    const pageSize = state.managerPagination.pageSize || 6;
    let currentPage = state.managerPagination.page || 1;
    const totalPages = Math.max(1, Math.ceil(users.length / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;
    state.managerPagination.page = currentPage;

    const startIndex = (currentPage - 1) * pageSize;
    const pagedUsers = users.slice(startIndex, startIndex + pageSize);

    if (paginationEl) {
      paginationEl.innerHTML = '';
      if (users.length) {
        const range = document.createElement('span');
        range.className = 'manager-pagination__range';
        const start = startIndex + 1;
        const end = Math.min(startIndex + pageSize, users.length);
        range.textContent = `Showing ${start}–${end} of ${users.length}`;
        paginationEl.appendChild(range);

        if (totalPages > 1) {
          const controls = document.createElement('div');
          controls.className = 'manager-pagination__controls';

          const createButton = (action, label, icon, disabled) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'manager-pagination__button';
            button.dataset.pageAction = action;
            button.disabled = disabled;
            button.innerHTML = `<i class="${icon}"></i><span>${label}</span>`;
            controls.appendChild(button);
          };

          createButton('prev', 'Previous', 'fa-solid fa-arrow-left', currentPage === 1);
          createButton('next', 'Next', 'fa-solid fa-arrow-right', currentPage === totalPages);
          paginationEl.appendChild(controls);
        }

        paginationEl.classList.remove('hidden');
      }
    }

    pagedUsers.forEach(user => {
      const row = document.createElement('div');
      row.className = 'manager-row';

      const info = document.createElement('div');
      info.className = 'info';

      const nameEl = document.createElement('strong');
      nameEl.textContent = safeString(user && (user.name || user.FullName || user.fullName || user.UserName || user.userName || 'Team Member')) || 'Team Member';
      info.appendChild(nameEl);

      const detailParts = [];
      const campaignName = safeString(user && (user.campaignName || user.CampaignName));
      if (campaignName) detailParts.push(campaignName);
      const roles = normalizeList(user && (user.roles || user.roleNames || user.RoleNames));
      if (roles.length) detailParts.push(roles.join(', '));

      if (detailParts.length) {
        const detailsEl = document.createElement('span');
        detailsEl.textContent = detailParts.join(' • ');
        info.appendChild(detailsEl);
      }

      row.appendChild(info);

      const metrics = document.createElement('div');
      metrics.className = 'metrics';

      metrics.appendChild(createManagerMetric('Avg Score', formatScore(user && user.averageScore)));

      const evaluationCount = Number(user && user.evaluations) || 0;
      metrics.appendChild(createManagerMetric('Evaluations', evaluationCount.toString()));

      const lastEvalDate = user && user.lastEvaluation ? formatDate(user.lastEvaluation) : '';
      const lastEvalRelative = user && user.lastEvaluation ? formatRelativeTime(user.lastEvaluation) : '';
      metrics.appendChild(createManagerMetric('Last Eval', lastEvalDate || '—', lastEvalRelative));

      row.appendChild(metrics);

      if (listEl) {
        listEl.appendChild(row);
      }
    });
  }

  function handleManagerPaginationClick(event) {
    const button = event.target && event.target.closest ? event.target.closest('[data-page-action]') : null;
    if (!button || button.disabled) {
      return;
    }

    const action = button.getAttribute('data-page-action');
    const currentPage = state.managerPagination.page || 1;
    if (action === 'prev') {
      state.managerPagination.page = Math.max(1, currentPage - 1);
    } else if (action === 'next') {
      state.managerPagination.page = currentPage + 1;
    }

    renderManagerSummary(state.managerSummary);
  }

  function setupCollapsibleCards() {
    const toggles = document.querySelectorAll('.collapsible-toggle');
    toggles.forEach(toggle => {
      const targetId = toggle.getAttribute('data-target');
      const panel = targetId ? document.getElementById(targetId) : null;
      if (!panel) {
        return;
      }

      const label = toggle.querySelector('.collapsible-toggle__label');
      const collapsedText = toggle.getAttribute('data-collapsed-text') || 'Show';
      const expandedText = toggle.getAttribute('data-expanded-text') || 'Hide';

      const setState = expanded => {
        toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        panel.hidden = !expanded;
        if (label) {
          label.textContent = expanded ? expandedText : collapsedText;
        }
      };

      setState(false);

      toggle.addEventListener('click', () => {
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        setState(!isExpanded);
      });
    });
  }

  function resolveDisplayName(userRecord) {
    if (!userRecord || typeof userRecord !== 'object') {
      return '';
    }

    const direct = safeString(userRecord.FullName || userRecord.fullName) ||
      safeString(userRecord.DisplayName || userRecord.displayName);
    if (direct) {
      return direct;
    }

    const first = safeString(userRecord.FirstName || userRecord.firstName || userRecord.GivenName || userRecord.givenName);
    const last = safeString(userRecord.LastName || userRecord.lastName || userRecord.Surname || userRecord.surname);
    const combined = [first, last].filter(Boolean).join(' ');
    if (combined) {
      return combined;
    }

    return safeString(userRecord.UserName || userRecord.userName || userRecord.username || userRecord.Email || userRecord.email);
  }

  function resolvePrimaryRole(userRecord, detailRecord) {
    const roleList = normalizeList(userRecord.roleNames || userRecord.RoleNames || (detailRecord && detailRecord.roleNames));
    if (roleList.length) return roleList[0];
    return safeString(userRecord.PrimaryRole || userRecord.primaryRole || userRecord.Role || userRecord.role || (detailRecord ? detailRecord.PrimaryRole || detailRecord.Role : ''));
  }

  function isLikelyManager(summary = state.managerSummary) {
    const roles = normalizeList(
      (state.user && (state.user.roleNames || state.user.RoleNames)) ||
      (summary && summary.roles) ||
      (state.detail && state.detail.roleNames)
    );
    const roleMatch = roles.some(role => /manager|lead|supervisor|director|executive/i.test(role));
    const permissions = state.permissions || {};
    const permissionLevel = safeString(permissions.permissionLevel);
    const permissionMatch = /manager|lead|supervisor/i.test(permissionLevel.toLowerCase ? permissionLevel.toLowerCase() : permissionLevel);
    const canManageUsers = permissions && (permissions.canManageUsers === true || String(permissions.canManageUsers).toLowerCase() === 'true');
    if (roleMatch || permissionMatch || canManageUsers) return true;
    if (summary && summary.users && summary.users.length) return true;
    return false;
  }

  function updateGlobalBannerFromProfile({ name, primaryRole, campaign, status, startDate }) {
    if (typeof initializeGlobalBanner !== 'function') {
      return;
    }

    const descriptionParts = [];
    if (primaryRole) descriptionParts.push(primaryRole);
    const description = descriptionParts.join(' • ');

    const chipRow = document.createElement('div');
    chipRow.className = 'banner-chip-row';

    const appendChip = (icon, label) => {
      if (!label) return;
      const chip = document.createElement('span');
      chip.className = 'banner-chip';
      if (icon) {
        const iconEl = document.createElement('i');
        iconEl.className = icon;
        chip.appendChild(iconEl);
      }
      const text = document.createElement('span');
      text.textContent = label;
      chip.appendChild(text);
      chipRow.appendChild(chip);
    };

    appendChip('fa-solid fa-circle-check', status);
    appendChip('fa-solid fa-calendar', startDate ? `Joined ${startDate}` : '');

    const actions = [];
    const addAction = (href, label, icon, variant) => {
      if (!href) return;
      const action = document.createElement('a');
      action.href = href;
      action.textContent = label;
      action.setAttribute('data-banner-icon', icon);
      action.setAttribute('data-banner-variant', variant);
      actions.push(action);
    };

    try {
      addAction(buildPageLink('agent-experience'), 'Agent Experience', 'fa-solid fa-user-gear', 'primary');
      addAction(buildPageLink('agentschedule'), 'View Schedule', 'fa-solid fa-calendar-days', 'secondary');
    } catch (err) {
      console.warn('Unable to build banner actions', err);
    }

    const descriptionElements = chipRow.childNodes.length ? [chipRow] : [];

    initializeGlobalBanner({
      title: name || 'My Profile',
      description,
      descriptionElements,
      campaignName: campaign,
      actions
    });
  }

  function hydrateHero(userRecord, detailRecord) {
    const record = detailRecord && detailRecord.record ? detailRecord.record : detailRecord || {};
    const name = resolveDisplayName(userRecord) || resolveDisplayName(record) || 'Your profile';
    const primaryRole = resolvePrimaryRole(userRecord, record) || 'Team Member';
    const campaign = safeString(userRecord.campaignName || userRecord.CampaignName || record.CampaignName || record.campaignName || state.campaignId);
    const status = safeString(record.EmploymentStatus || record.Status || userRecord.Status || userRecord.status);
    const startDate = formatDate(record.StartDate || record.HireDate || record.DateHired || record.OnboardDate || record.CreatedAt || record.createdAt);

    const chips = document.getElementById('profileChips');
    if (chips) {
      chips.innerHTML = '';
      if (status) {
        const statusChip = document.createElement('span');
        statusChip.className = 'profile-chip';
        statusChip.innerHTML = '<i class="fa-solid fa-circle-check"></i>' + status;
        chips.appendChild(statusChip);
      }
      if (startDate) {
        const startChip = document.createElement('span');
        startChip.className = 'profile-chip';
        startChip.innerHTML = '<i class="fa-solid fa-calendar"></i> Joined ' + startDate;
        chips.appendChild(startChip);
      }
      if (campaign) {
        const campaignChip = document.createElement('span');
        campaignChip.className = 'profile-chip';
        campaignChip.innerHTML = '<i class="fa-solid fa-diagram-project"></i> ' + campaign;
        chips.appendChild(campaignChip);
      }
    }

    setText('profileName', name, 'Your profile');
    setText('profileRole', primaryRole || 'Team Member');

    const avatar = document.getElementById('profileAvatar');
    if (avatar) {
      const initial = safeString(name).charAt(0).toUpperCase() || 'U';
      avatar.textContent = initial;
    }

    const agentLink = document.getElementById('agentExperienceLink');
    if (agentLink) {
      agentLink.href = buildPageLink('agent-experience');
    }

    const scheduleLink = document.getElementById('agentScheduleLink');
    if (scheduleLink) {
      scheduleLink.href = buildPageLink('agentschedule');
    }

    updateGlobalBannerFromProfile({ name, primaryRole, campaign, status, startDate });
  }

  function refreshSections() {
    const detailRecord = state.detail && state.detail.record ? state.detail.record : state.detail || {};

    hydrateHero(state.user, state.detail);

    renderInfoGrid('personalDetails', [
      { label: 'Full Name', keys: ['FullName', 'fullName', 'DisplayName', 'displayName'] },
      { label: 'Preferred Name', keys: ['PreferredName', 'preferredName'] },
      { label: 'Work Email', keys: ['Email', 'email'], isLink: true },
      { label: 'Phone', keys: ['Phone', 'phone', 'Mobile', 'mobile'] },
      { label: 'Username', keys: ['UserName', 'userName', 'username', 'Email'] },
      { label: 'Location', keys: ['Location', 'location', 'City', 'city', 'Country', 'country'] }
    ], detailRecord);

    renderInfoGrid('employmentDetails', [
      { label: 'Employee ID', keys: ['EmployeeID', 'employeeId', 'ID', 'id'] },
      { label: 'Department', keys: ['Department', 'department', 'Team', 'team'] },
      { label: 'Campaign', keys: ['CampaignName', 'campaignName', 'CampaignID', 'campaignId'] },
      { label: 'Manager', keys: ['Manager', 'manager', 'ManagerName', 'managerName', 'Supervisor', 'supervisor'] },
      { label: 'Employment Status', keys: ['EmploymentStatus', 'Status', 'status'] },
      {
        label: 'Start Date',
        keys: ['StartDate', 'HireDate', 'DateHired', 'OnboardDate'],
        transform: (value) => formatDate(value)
      },
      {
        label: 'Tenure',
        keys: ['StartDate', 'HireDate', 'DateHired', 'AnniversaryDate'],
        transform: (value) => formatTenure(value)
      }
    ], detailRecord);

    const roles = normalizeList(state.user.roleNames || detailRecord.roleNames || detailRecord.RoleNames || detailRecord.Roles || detailRecord.Role);
    renderChips('roleChips', roles, 'fa-solid fa-badge-check');

    renderChips('pageChips', state.pages, 'fa-solid fa-layer-group');

    renderInfoGrid('accessDetails', [
      { label: 'Permission Level', keys: ['permissionLevel'], transform: (value, record) => {
        const source = state.permissions || record.permissions || {};
        const level = source.permissionLevel || value;
        return level ? level.toString().replace(/_/g, ' ').toUpperCase() : '';
      } },
      { label: 'Manage Users', keys: ['canManageUsers'], transform: () => formatBoolean(state.permissions && state.permissions.canManageUsers) },
      { label: 'Manage Pages', keys: ['canManagePages'], transform: () => formatBoolean(state.permissions && state.permissions.canManagePages) },
      {
        label: 'Assigned Campaign',
        keys: ['CampaignName', 'campaignName', 'CampaignID', 'campaignId'],
        transform: (value, record, userData) => {
          const name = safeString(record && (record.CampaignName || record.campaignName)) ||
            safeString(userData && (userData.CampaignName || userData.campaignName));
          const id = safeString(record && (record.CampaignID || record.campaignId)) || safeString(state.campaignId);
          return name || id;
        }
      }
    ], Object.assign({}, detailRecord, { permissions: state.permissions }));

    renderInfoGrid('securityDetails', [
      { label: 'Email Confirmed', keys: ['EmailConfirmed', 'emailConfirmed'], transform: (value) => formatBoolean(value) },
      { label: 'MFA Enabled', keys: ['MFAEnabled', 'mfaEnabled'], transform: (value) => formatBoolean(value) },
      { label: 'Last Login', keys: ['LastLoginAt', 'LastLogin', 'lastLoginAt', 'lastLogin'], transform: (value) => formatDate(value) },
      { label: 'Last Activity', keys: ['LastActivityAt', 'lastActivityAt'], transform: (value) => formatDate(value) },
      { label: 'Password Reset Required', keys: ['ResetRequired', 'resetRequired'], transform: (value) => formatBoolean(value, { positive: 'Required', negative: 'Not Required' }) }
    ], Object.assign({}, state.user, detailRecord));

    renderEquipment(state.equipment);
    renderManagerSummary(state.managerSummary);
  }

  function fetchUserDetail() {
    const userId = safeString(state.user && state.user.ID);
    if (!userId || (typeof google === 'undefined' || !google.script || !google.script.run)) {
      refreshSections();
      return;
    }

    google.script.run
      .withFailureHandler(err => {
        console.warn('Failed to load user detail', err);
        refreshSections();
      })
      .withSuccessHandler(detail => {
        state.detail = detail || state.detail;
        refreshSections();
      })
      .clientGetUserDetail(userId, { requestingUserId: userId });
  }

  function fetchUserPages() {
    const userId = safeString(state.user && state.user.ID);
    if (!userId || (typeof google === 'undefined' || !google.script || !google.script.run)) {
      refreshSections();
      return;
    }

    google.script.run
      .withFailureHandler(err => {
        console.warn('Failed to load user pages', err);
      })
      .withSuccessHandler(pages => {
        if (Array.isArray(pages)) {
          state.pages = pages;
          refreshSections();
        }
      })
      .clientGetUserPages(userId);
  }

  function fetchUserEquipment() {
    const userId = safeString(state.user && state.user.ID);
    const loader = document.getElementById('equipmentLoader');
    if (loader) loader.classList.add('show');
    if (!userId || (typeof google === 'undefined' || !google.script || !google.script.run)) {
      if (loader) loader.classList.remove('show');
      refreshSections();
      return;
    }

    state.loadingEquipment = true;
    google.script.run
      .withFailureHandler(err => {
        console.warn('Failed to load equipment', err);
        state.loadingEquipment = false;
        if (loader) loader.classList.remove('show');
        renderEquipment(state.equipment);
      })
      .withSuccessHandler(result => {
        state.loadingEquipment = false;
        if (loader) loader.classList.remove('show');
        if (result && result.success && Array.isArray(result.items)) {
          state.equipment = result.items;
          renderEquipment(state.equipment);
        } else {
          renderEquipment(state.equipment);
        }
      })
      .clientGetUserEquipment(userId);
  }

  function fetchManagerSummary(force = false) {
    const userId = safeString(state.user && state.user.ID);
    if (!userId || (typeof google === 'undefined' || !google.script || !google.script.run)) {
      renderManagerSummary(state.managerSummary);
      return;
    }

    if (!force && !isLikelyManager() && (!state.managerSummary || !state.managerSummary.users || !state.managerSummary.users.length)) {
      renderManagerSummary(state.managerSummary);
      return;
    }

    state.loadingManagerSummary = true;
    renderManagerSummary(state.managerSummary);

    google.script.run
      .withFailureHandler(err => {
        console.warn('Failed to load manager summary', err);
        state.loadingManagerSummary = false;
        state.managerSummary = { success: false, error: 'Unable to load team summary right now.' };
        renderManagerSummary(state.managerSummary);
      })
      .withSuccessHandler(result => {
        state.loadingManagerSummary = false;
        if (result && result.success) {
          state.managerSummary = result;
          state.managerPagination.page = 1;
        } else if (result) {
          state.managerSummary = Object.assign({ success: false }, result);
          state.managerPagination.page = 1;
        } else {
          state.managerSummary = { success: false, error: 'Unable to load team summary right now.' };
          state.managerPagination.page = 1;
        }
        renderManagerSummary(state.managerSummary);
      })
      .clientGetManagerTeamSummary(userId);
  }

  function fetchPermissions() {
    const userId = safeString(state.user && state.user.ID);
    const campaignId = safeString(state.campaignId);
    if (!userId || !campaignId || (typeof google === 'undefined' || !google.script || !google.script.run)) {
      refreshSections();
      return;
    }

    google.script.run
      .withFailureHandler(err => {
        console.warn('Failed to load permissions', err);
      })
      .withSuccessHandler(perms => {
        if (perms && typeof perms === 'object') {
          state.permissions = perms;
          refreshSections();
          if (!state.loadingManagerSummary && isLikelyManager() && (!state.managerSummary || state.managerSummary.success === false)) {
            fetchManagerSummary(true);
          }
        }
      })
      .clientGetUserPermissions(userId, campaignId);
  }

  document.addEventListener('DOMContentLoaded', () => {
    setupCollapsibleCards();
    const paginationEl = document.getElementById('managerSummaryPagination');
    if (paginationEl) {
      paginationEl.addEventListener('click', handleManagerPaginationClick);
    }

    refreshSections();
    fetchUserDetail();
    fetchUserPages();
    fetchUserEquipment();
    fetchManagerSummary();
    fetchPermissions();
  });
</script>
