<!-- UserProfile.html -->
<?
  var safeBaseUrl = (typeof baseUrl !== 'undefined' && baseUrl) ? baseUrl : (typeof scriptUrl !== 'undefined' && scriptUrl ? scriptUrl : '');
  var initialBootstrap = (typeof profileBootstrap !== 'undefined' && profileBootstrap) ? profileBootstrap : '{}';
?>
<?!= include('layout', {
  baseUrl: safeBaseUrl,
  scriptUrl: scriptUrl,
  user: user || {},
  currentPage: currentPage || 'User Profile',
  pageSlug: 'userprofile',
  pageTitle: 'My Profile',
  pageDescription: 'Review your personal details, access, and equipment in LuminaHQ.'
}) ?>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-b7H3c5ZLfuD3yF5uxoFODdgNpTiFqouBZfyqCkCmZJLdnOjFkWDXLI4YAlnXrhIRbkIuAeGHGZMRYPdP4h4lrw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --profile-navy: #0b1f33;
    --profile-cyan: #0ea5e9;
    --profile-mint: #22c55e;
    --profile-lavender: #6366f1;
    --profile-surface: #ffffff;
    --profile-soft: #f3f5fb;
    --profile-border: #d7deed;
    --profile-text: #0f172a;
    --profile-text-secondary: #475569;
    --profile-shadow: 0 22px 45px rgba(11, 31, 51, 0.12);
    --profile-radius-lg: 20px;
    --profile-radius-md: 18px;
    --profile-radius-sm: 12px;
    --profile-transition: all 0.2s ease;
    --chip-bg: rgba(14, 165, 233, 0.1);
  }

  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(180deg, #f5f7fb 0%, #ffffff 60%);
    color: var(--profile-text);
  }

  .profile-page {
    padding: clamp(1.5rem, 4vw, 3.5rem) 0 4rem;
  }

  .profile-wrapper {
    width: min(1280px, 100% - clamp(2rem, 7vw, 7.5rem));
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: clamp(1.75rem, 2.5vw, 3rem);
  }

  .profile-essentials[hidden] {
    display: none !important;
  }

  .profile-essentials {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.2rem;
    background: var(--profile-surface);
    border-radius: var(--profile-radius-lg);
    padding: clamp(1.35rem, 2.2vw, 2rem) clamp(1.5rem, 3vw, 2.4rem);
    box-shadow: var(--profile-shadow);
    border: 1px solid rgba(11, 31, 51, 0.05);
    position: relative;
    overflow: hidden;
  }

  .profile-essentials::after {
    content: '';
    position: absolute;
    inset: 0;
    pointer-events: none;
    background: radial-gradient(circle at top right, rgba(14, 165, 233, 0.12), transparent 60%);
    opacity: 0.7;
  }

  .profile-essential {
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    padding: 0.25rem 0;
  }

  .profile-essential__label {
    font-size: 0.78rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    font-weight: 700;
    color: var(--profile-text-secondary);
  }

  .profile-essential__value {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--profile-text);
    word-break: break-word;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .profile-essential__value--code {
    font-family: 'JetBrains Mono', 'Fira Code', 'Source Code Pro', monospace;
    letter-spacing: 0.05em;
  }

  .profile-essential__value a {
    color: inherit;
    text-decoration: none;
  }

  .profile-essential__value a:hover,
  .profile-essential__value a:focus {
    text-decoration: underline;
  }

  .profile-essential__meta {
    font-size: 0.85rem;
    color: var(--profile-text-secondary);
  }

  .profile-content {
    display: grid;
    grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.2fr);
    gap: clamp(1.75rem, 3vw, 2.75rem);
    align-items: start;
  }

  .profile-content__column {
    display: flex;
    flex-direction: column;
    gap: clamp(1.4rem, 2.4vw, 2.2rem);
  }

  .profile-content__column--secondary {
    position: relative;
  }

  .profile-banner__headline {
    display: flex;
    align-items: center;
    gap: clamp(1rem, 2.5vw, 2rem);
    flex-wrap: wrap;
  }

  .profile-banner__avatar {
    width: clamp(72px, 8vw, 104px);
    height: clamp(72px, 8vw, 104px);
    border-radius: 28px;
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.35), rgba(99, 102, 241, 0.4));
    border: 1px solid rgba(14, 165, 233, 0.28);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(2rem, 3vw, 2.8rem);
    font-weight: 700;
    color: var(--profile-navy);
    box-shadow: inset 0 18px 32px rgba(14, 165, 233, 0.12);
  }

  .profile-banner__text {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .profile-banner__name {
    font-size: clamp(2rem, 3vw, 2.8rem);
    font-weight: 700;
    color: var(--profile-navy);
  }

  .profile-banner__role {
    font-size: clamp(1rem, 1.5vw, 1.25rem);
    color: var(--profile-text-secondary);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .profile-banner__role i {
    color: var(--profile-cyan);
  }

  .profile-banner__username {
    font-size: 0.95rem;
    font-weight: 600;
    color: rgba(15, 23, 42, 0.65);
  }

  .profile-banner__chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    margin-top: 0.25rem;
  }

  .profile-banner__chip {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    border-radius: 999px;
    padding: 0.45rem 0.85rem;
    background: rgba(14, 165, 233, 0.15);
    color: var(--profile-navy);
    font-weight: 600;
    font-size: 0.9rem;
  }

  .profile-banner__chip i {
    font-size: 0.85rem;
  }

  .profile-banner__meta-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1.1rem;
    padding-top: 0.6rem;
  }

  .profile-banner__meta-item {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    min-width: 150px;
  }

  .profile-banner__meta-label {
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-weight: 700;
    color: var(--profile-text-secondary);
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }

  .profile-banner__meta-label i {
    color: var(--profile-cyan);
    font-size: 0.85rem;
  }

  .profile-banner__meta-value {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--profile-text);
    word-break: break-word;
  }

  .profile-banner__meta-value--code {
    font-family: 'JetBrains Mono', 'Fira Code', 'Source Code Pro', monospace;
    letter-spacing: 0.04em;
  }

  .profile-banner__contacts {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    padding-top: 0.75rem;
  }

  .profile-banner__contact {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.6rem 0.95rem;
    border-radius: 14px;
    background: rgba(14, 165, 233, 0.1);
    color: var(--profile-navy);
    font-weight: 600;
    font-size: 0.95rem;
  }

  .profile-banner__contact i {
    color: var(--profile-cyan);
  }

  .profile-banner__contact a {
    color: inherit;
    text-decoration: none;
  }

  .profile-banner__contact a:hover,
  .profile-banner__contact a:focus-visible {
    text-decoration: underline;
  }

  .profile-hero {
    background: linear-gradient(135deg, rgba(2, 43, 91, 0.95) 0%, rgba(17, 94, 185, 0.82) 45%, rgba(0, 188, 212, 0.75) 100%);
    border-radius: var(--profile-radius-lg);
    padding: clamp(1.75rem, 3vw, 3rem);
    margin-bottom: 2.5rem;
    position: relative;
    overflow: hidden;
    box-shadow: var(--profile-shadow);
    color: #fff;
  }

  .profile-hero::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.35), transparent 55%);
    opacity: 0.9;
  }

  .profile-hero-content {
    position: relative;
    display: grid;
    gap: clamp(1.5rem, 3vw, 3rem);
    grid-template-columns: minmax(0, 1.35fr) minmax(0, 1fr);
    align-items: stretch;
    z-index: 1;
  }

  .profile-hero__summary {
    display: flex;
    flex-direction: column;
    gap: clamp(1.1rem, 2vw, 1.6rem);
  }

  .profile-hero__identity {
    display: flex;
    align-items: center;
    gap: clamp(1rem, 2vw, 1.75rem);
    flex-wrap: wrap;
  }

  .profile-hero__avatar {
    width: clamp(74px, 8vw, 108px);
    height: clamp(74px, 8vw, 108px);
    border-radius: 28px;
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.35), rgba(99, 102, 241, 0.4));
    border: 1px solid rgba(14, 165, 233, 0.28);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(2.1rem, 3.1vw, 3rem);
    font-weight: 700;
    color: #03213e;
    box-shadow: inset 0 18px 32px rgba(14, 165, 233, 0.12);
  }

  .profile-hero__identity-text {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .profile-hero__name {
    font-size: clamp(2rem, 3vw, 2.8rem);
    font-weight: 700;
    color: #fff;
  }

  .profile-hero__role {
    font-size: clamp(1rem, 1.5vw, 1.25rem);
    font-weight: 600;
    color: rgba(255, 255, 255, 0.85);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .profile-hero__role i {
    color: rgba(255, 255, 255, 0.75);
  }

  .profile-hero__username {
    font-size: 0.95rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.6);
  }

  .profile-hero__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
  }

  .profile-hero__chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: rgba(255, 255, 255, 0.12);
    border-radius: 999px;
    padding: 0.45rem 0.85rem;
    color: #fff;
    font-weight: 600;
    font-size: 0.9rem;
    backdrop-filter: blur(6px);
  }

  .profile-hero__chip i {
    font-size: 0.8rem;
  }

  .profile-hero__meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 0.75rem 1.15rem;
  }

  .profile-hero__meta-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .profile-hero__meta-label {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-weight: 700;
    font-size: 0.78rem;
    color: rgba(255, 255, 255, 0.65);
  }

  .profile-hero__meta-label i {
    font-size: 0.82rem;
  }

  .profile-hero__meta-value {
    font-weight: 600;
    font-size: 1.05rem;
    color: #fff;
    word-break: break-word;
  }

  .profile-hero__contacts {
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
  }

  .profile-hero__contact {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.55rem 0.9rem;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.14);
    color: #0f172a;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .profile-hero__contact i {
    color: var(--profile-cyan);
  }

  .profile-hero__contact a {
    color: inherit;
    text-decoration: none;
  }

  .profile-hero__contact a:hover,
  .profile-hero__contact a:focus-visible {
    text-decoration: underline;
  }

  .profile-hero__actions {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .profile-hero__action {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    border-radius: 999px;
    padding: 0.6rem 1.2rem;
    font-weight: 600;
    font-size: 0.95rem;
    text-decoration: none;
    transition: var(--profile-transition);
  }

  .profile-hero__action--primary {
    background: #fff;
    color: var(--profile-navy);
    box-shadow: 0 12px 28px rgba(15, 23, 42, 0.18);
  }

  .profile-hero__action--primary:hover,
  .profile-hero__action--primary:focus-visible {
    transform: translateY(-1px);
  }

  .profile-hero__action--secondary {
    background: rgba(255, 255, 255, 0.16);
    color: #fff;
  }

  .profile-hero__action--secondary:hover,
  .profile-hero__action--secondary:focus-visible {
    background: rgba(255, 255, 255, 0.28);
  }

  .profile-hero__insights {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .profile-hero__metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
  }

  .profile-metric {
    background: rgba(255, 255, 255, 0.85);
    border-radius: 16px;
    padding: 1rem 1.2rem;
    display: flex;
    flex-direction: column;
    gap: 0.55rem;
    box-shadow: 0 18px 36px rgba(15, 23, 42, 0.12);
    border: 1px solid rgba(15, 23, 42, 0.08);
    min-height: 140px;
  }

  .profile-metric__icon {
    width: 38px;
    height: 38px;
    border-radius: 12px;
    background: rgba(14, 165, 233, 0.16);
    color: var(--profile-cyan);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
  }

  .profile-metric__label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--profile-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .profile-metric__value {
    font-size: 1.7rem;
    font-weight: 700;
    color: var(--profile-navy);
  }

  .profile-metric__trend {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--profile-mint);
  }

  .profile-metric[data-negative="true"] .profile-metric__trend {
    color: #ef4444;
  }

  .profile-metric__trend[data-variant="neutral"] {
    color: var(--profile-text-secondary);
  }

  .profile-hero__chart {
    background: rgba(255, 255, 255, 0.92);
    border-radius: 18px;
    padding: 1.2rem 1.4rem;
    box-shadow: 0 18px 36px rgba(15, 23, 42, 0.12);
    border: 1px solid rgba(15, 23, 42, 0.08);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .profile-hero__chart header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 700;
    color: var(--profile-navy);
  }

  .profile-hero__chart header span {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--profile-text-secondary);
  }

  .profile-hero__chart canvas {
    width: 100%;
    height: 200px;
  }

  .profile-hero__chart-empty {
    font-size: 0.9rem;
    color: var(--profile-text-secondary);
    font-weight: 500;
  }

  .profile-card {
    background: var(--profile-surface);
    border-radius: var(--profile-radius-lg);
    padding: clamp(1.6rem, 2.2vw, 2.1rem);
    box-shadow: 0 20px 38px rgba(11, 31, 51, 0.12);
    border: 1px solid rgba(11, 31, 51, 0.08);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 1.4rem;
    isolation: isolate;
    transition: var(--profile-transition);
  }

  .profile-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.08), rgba(99, 102, 241, 0.08));
    opacity: 0;
    transition: var(--profile-transition);
    pointer-events: none;
    z-index: 0;
  }

  .profile-card:hover::before,
  .profile-card:focus-within::before {
    opacity: 1;
  }

  .profile-card:hover,
  .profile-card:focus-within {
    box-shadow: 0 28px 48px rgba(11, 31, 51, 0.16);
    border-color: rgba(11, 31, 51, 0.14);
  }

  .profile-card-header {
    position: relative;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1.5rem;
    flex-wrap: wrap;
    z-index: 1;
  }

  .profile-card-header__text {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    min-width: 0;
  }

  .profile-card-eyebrow {
    font-size: 0.75rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-weight: 700;
    color: rgba(15, 23, 42, 0.55);
  }

  .profile-card-title {
    font-size: 1.35rem;
    font-weight: 700;
    margin: 0;
    display: inline-flex;
    align-items: center;
    gap: 0.65rem;
    color: var(--profile-text);
    flex-wrap: wrap;
  }

  .profile-card-title i {
    color: var(--profile-cyan);
    font-size: 1.15rem;
  }

  .profile-card-description {
    margin: 0;
    font-size: 0.95rem;
    color: var(--profile-text-secondary);
    max-width: 560px;
  }

  .profile-card-header__actions {
    display: inline-flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.75rem;
    flex-shrink: 0;
  }

  .profile-card-body {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 1.35rem;
    z-index: 1;
  }

  .collapsible-card .profile-card-body[hidden] {
    display: none;
  }

  .collapsible-toggle {
    border: none;
    background: rgba(14, 165, 233, 0.08);
    color: var(--profile-navy);
    border-radius: 999px;
    padding: 0.45rem 0.9rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    cursor: pointer;
    transition: var(--profile-transition);
    justify-content: center;
  }

  .collapsible-toggle:hover {
    background: rgba(14, 165, 233, 0.16);
  }

  .collapsible-toggle i {
    transition: transform 0.2s ease;
  }

  .collapsible-toggle[aria-expanded="true"] i {
    transform: rotate(180deg);
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.1rem 1.4rem;
  }

  .info-item {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.45rem;
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.12), rgba(99, 102, 241, 0.1));
    border-radius: var(--profile-radius-sm);
    padding: 1rem 1.15rem;
    border: 1px solid rgba(14, 165, 233, 0.18);
    box-shadow: 0 16px 30px rgba(11, 31, 51, 0.1);
    backdrop-filter: blur(2px);
  }

  .info-item::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    border: 1px solid rgba(255, 255, 255, 0.55);
    opacity: 0.35;
    pointer-events: none;
  }

  .info-label {
    font-size: 0.78rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: rgba(15, 23, 42, 0.65);
    font-weight: 700;
  }

  .info-value {
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--profile-text);
    word-break: break-word;
  }

  .info-value a {
    color: inherit;
    text-decoration: none;
  }

  .info-value a:hover {
    text-decoration: underline;
  }

  .chip-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    margin-bottom: 1.1rem;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.45rem 0.95rem;
    border-radius: 999px;
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.22), rgba(99, 102, 241, 0.2));
    color: var(--profile-navy);
    font-weight: 700;
    font-size: 0.9rem;
    border: 1px solid rgba(14, 165, 233, 0.28);
    box-shadow: 0 10px 18px rgba(11, 31, 51, 0.12);
  }

  .chip i {
    font-size: 0.9rem;
  }

  .empty-state {
    font-size: 0.95rem;
    color: var(--profile-text-secondary);
    background: var(--profile-soft);
    border: 1px dashed rgba(14, 165, 233, 0.25);
    border-radius: var(--profile-radius-sm);
    padding: 1rem;
    text-align: center;
  }

  .equipment-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 1rem;
  }

  .equipment-item {
    padding: 1rem 1.15rem;
    border-radius: var(--profile-radius-sm);
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.14), rgba(14, 165, 233, 0.05));
    border: 1px solid rgba(14, 165, 233, 0.2);
    display: grid;
    gap: 0.35rem;
    box-shadow: 0 16px 28px rgba(11, 31, 51, 0.1);
  }

  .equipment-item strong {
    font-size: 1.05rem;
    color: var(--profile-text);
  }

  .equipment-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.45rem 0.8rem;
    font-size: 0.85rem;
    color: rgba(15, 23, 42, 0.65);
  }

  .hidden {
    display: none !important;
  }

  .manager-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1.5rem;
  }

  .manager-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.45rem 0.9rem;
    border-radius: 999px;
    background: rgba(14, 165, 233, 0.16);
    color: var(--profile-navy);
    font-weight: 700;
    font-size: 0.85rem;
    border: 1px solid rgba(14, 165, 233, 0.22);
  }

  .manager-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
    margin-bottom: 1.25rem;
  }

  .manager-stat {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(14, 165, 233, 0.12));
    border-radius: var(--profile-radius-sm);
    border: 1px solid rgba(99, 102, 241, 0.2);
    padding: 0.95rem 1.05rem;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    box-shadow: 0 16px 28px rgba(11, 31, 51, 0.1);
  }

  .manager-stat .label {
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--profile-text-secondary);
  }

  .manager-stat .value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--profile-navy);
  }

  .manager-list {
    display: flex;
    flex-direction: column;
    gap: 0.85rem;
  }

  .manager-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 1rem 1.15rem;
    border-radius: var(--profile-radius-sm);
    border: 1px solid rgba(14, 165, 233, 0.18);
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.05), rgba(99, 102, 241, 0.05));
  }

  .manager-row .info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .manager-row .info strong {
    font-size: 1rem;
    color: var(--profile-text);
  }

  .manager-row .info span {
    font-size: 0.85rem;
    color: var(--profile-text-secondary);
  }

  .manager-row .metrics {
    display: flex;
    align-items: center;
    gap: 1.35rem;
    flex-wrap: wrap;
  }

  .manager-row .metric {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }

  .manager-row .metric .label {
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--profile-text-secondary);
  }

  .manager-row .metric .value {
    font-weight: 700;
    font-size: 1.05rem;
    color: var(--profile-navy);
  }

  .manager-row .metric small {
    font-size: 0.75rem;
    color: var(--profile-text-secondary);
  }

  .manager-summary-empty {
    margin-top: 0.5rem;
  }

  .manager-pagination {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .manager-pagination.hidden {
    display: none !important;
  }

  .manager-pagination__range {
    font-size: 0.9rem;
    color: var(--profile-text-secondary);
  }

  .manager-pagination__controls {
    display: inline-flex;
    gap: 0.5rem;
  }

  .manager-pagination__button {
    border: 1px solid rgba(14, 165, 233, 0.35);
    background: rgba(14, 165, 233, 0.12);
    color: var(--profile-navy);
    border-radius: 999px;
    padding: 0.4rem 0.9rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    transition: var(--profile-transition);
  }

  .manager-pagination__button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .manager-pagination__button:not(:disabled):hover {
    background: rgba(14, 165, 233, 0.18);
  }

  .loader {
    display: none;
    align-items: center;
    gap: 0.65rem;
    font-size: 0.95rem;
    color: var(--profile-text-secondary);
    margin-top: 1rem;
  }

  .loader.show {
    display: inline-flex;
  }

  .loader .spinner {
    width: 18px;
    height: 18px;
    border: 3px solid rgba(14, 165, 233, 0.18);
    border-top-color: var(--profile-cyan);
    border-radius: 50%;
    animation: spin 0.75s linear infinite;
  }

  .banner-chip-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .banner-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: rgba(14, 165, 233, 0.12);
    border-radius: 999px;
    padding: 0.35rem 0.7rem;
    font-size: 0.85rem;
    color: var(--profile-navy);
    font-weight: 600;
  }

  .banner-chip i {
    font-size: 0.8rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @media (max-width: 1200px) {
    .profile-wrapper {
      width: min(1200px, 100% - clamp(1.5rem, 6vw, 6rem));
    }

    .profile-content {
      grid-template-columns: 1fr;
    }

    .profile-hero-content {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 900px) {
    .profile-essentials {
      padding: 1.25rem 1.5rem;
    }

    .profile-banner__headline {
      flex-direction: column;
      align-items: flex-start;
    }

    .profile-hero__identity {
      flex-direction: column;
      align-items: flex-start;
    }

    .profile-hero__actions {
      width: 100%;
    }

    .profile-card-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .profile-card-header__actions {
      width: 100%;
      justify-content: flex-start;
      margin-top: 0.5rem;
    }

    .collapsible-toggle {
      width: 100%;
      justify-content: space-between;
    }
  }

  @media (max-width: 768px) {
    .profile-wrapper {
      width: min(100%, 100% - 2rem);
    }

    .profile-card {
      padding: 1.5rem;
    }

    .info-grid {
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .profile-banner__contacts {
      flex-direction: column;
      align-items: stretch;
    }

    .profile-banner__contact {
      justify-content: center;
    }

    .profile-hero__contacts {
      flex-direction: column;
      align-items: stretch;
    }

    .profile-hero__contact {
      justify-content: center;
    }

    .profile-hero__metrics {
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }
  }
</style>

<main class="profile-page">
  <div class="profile-wrapper">
    <section class="profile-hero" id="profileHero" aria-label="Profile overview" hidden>
      <div class="profile-hero-content" id="profileHeroContent"></div>
    </section>

    <section class="profile-essentials" id="profileEssentials" aria-label="Profile essentials" hidden></section>

    <div class="profile-content">
      <div class="profile-content__column profile-content__column--primary">
        <section class="profile-card" aria-labelledby="personalInfoTitle">
          <header class="profile-card-header">
            <div class="profile-card-header__text">
              <span class="profile-card-eyebrow">Identity</span>
              <h2 class="profile-card-title" id="personalInfoTitle">
                <i class="fa-solid fa-id-card"></i>
                Personal Information
              </h2>
            </div>
          </header>
          <div class="profile-card-body">
            <div class="info-grid" id="personalDetails"></div>
          </div>
        </section>

        <section class="profile-card" aria-labelledby="employmentTitle">
          <header class="profile-card-header">
            <div class="profile-card-header__text">
              <span class="profile-card-eyebrow">Work Snapshot</span>
              <h2 class="profile-card-title" id="employmentTitle">
                <i class="fa-solid fa-briefcase"></i>
                Employment
              </h2>
            </div>
            <p class="profile-card-description">Key details about your current assignment, reporting chain, and tenure.</p>
          </header>
          <div class="profile-card-body">
            <div class="info-grid" id="employmentDetails"></div>
          </div>
        </section>

        <section class="profile-card collapsible-card" aria-labelledby="accessTitle">
          <header class="profile-card-header">
            <div class="profile-card-header__text">
              <span class="profile-card-eyebrow">System Access</span>
              <h2 class="profile-card-title" id="accessTitle">
                <i class="fa-solid fa-user-shield"></i>
                Access &amp; Permissions
              </h2>
            </div>
            <div class="profile-card-header__actions">
              <button class="collapsible-toggle" type="button" data-target="accessPermissionsPanel"
                data-collapsed-text="Show access" data-expanded-text="Hide access" aria-expanded="false">
                <span class="collapsible-toggle__label">Show access</span>
                <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
              </button>
            </div>
          </header>
          <div class="profile-card-body" id="accessPermissionsPanel" hidden>
            <div class="chip-row" id="roleChips"></div>
            <div class="chip-row" id="pageChips"></div>
            <div class="info-grid" id="accessDetails"></div>
          </div>
        </section>
      </div>

      <div class="profile-content__column profile-content__column--secondary">
        <section class="profile-card" aria-labelledby="securityTitle">
          <header class="profile-card-header">
            <div class="profile-card-header__text">
              <span class="profile-card-eyebrow">Account Safety</span>
              <h2 class="profile-card-title" id="securityTitle">
                <i class="fa-solid fa-lock"></i>
                Security
              </h2>
            </div>
          </header>
          <div class="profile-card-body">
            <div class="info-grid" id="securityDetails"></div>
          </div>
        </section>

        <section class="profile-card" aria-labelledby="equipmentTitle">
          <header class="profile-card-header">
            <div class="profile-card-header__text">
              <span class="profile-card-eyebrow">Workstation</span>
              <h2 class="profile-card-title" id="equipmentTitle">
                <i class="fa-solid fa-laptop"></i>
                Equipment &amp; Resources
              </h2>
            </div>
            <p class="profile-card-description">Track the hardware and accessorial resources assigned to you.</p>
          </header>
          <div class="profile-card-body">
            <ul class="equipment-list" id="equipmentList"></ul>
            <div class="loader" id="equipmentLoader">
              <div class="spinner"></div>
              Fetching equipment…
            </div>
          </div>
        </section>

        <section class="profile-card manager-card hidden" id="managerSummaryCard" aria-labelledby="managerSummaryTitle">
          <header class="profile-card-header manager-card-header">
            <div class="profile-card-header__text">
              <span class="profile-card-eyebrow">Team Leadership</span>
              <h2 class="profile-card-title" id="managerSummaryTitle">
                <i class="fa-solid fa-people-group"></i>
                Managed Team Overview
              </h2>
            </div>
            <span class="manager-chip" id="managerSummaryManagedCount">
              <i class="fa-solid fa-user-group"></i>
              0 Managed
            </span>
          </header>
          <div class="profile-card-body">
            <div class="manager-stats" id="managerSummaryStats"></div>
            <div class="manager-list" id="managerSummaryList"></div>
            <div class="manager-pagination hidden" id="managerSummaryPagination"></div>
            <div class="empty-state manager-summary-empty hidden" id="managerSummaryEmpty">
              No managed team members are assigned to you yet.
            </div>
            <div class="loader" id="managerSummaryLoader">
              <div class="spinner"></div>
              Compiling team performance…
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</main>

<script>
  const CURRENT_USER = <?!= currentUserJson || '{}' ?>;
  const PROFILE_BOOTSTRAP = <?!= initialBootstrap || '{}' ?> || {};

  const state = {
    user: (PROFILE_BOOTSTRAP.user && Object.keys(PROFILE_BOOTSTRAP.user).length ? PROFILE_BOOTSTRAP.user : CURRENT_USER) || {},
    detail: PROFILE_BOOTSTRAP.detail || null,
    pages: PROFILE_BOOTSTRAP.pages || [],
    equipment: PROFILE_BOOTSTRAP.equipment || [],
    permissions: PROFILE_BOOTSTRAP.permissions || null,
    campaignId: PROFILE_BOOTSTRAP.campaignId || (CURRENT_USER ? CURRENT_USER.CampaignID || CURRENT_USER.campaignId || '' : ''),
    managerSummary: PROFILE_BOOTSTRAP.managerSummary || null,
    loadingEquipment: false,
    loadingManagerSummary: false,
    managerPagination: { page: 1, pageSize: 6 },
    profileSlug: safeString(PROFILE_BOOTSTRAP.profileSlug || PROFILE_BOOTSTRAP.profileId) || '',
    profileIdentifier: safeString(
      (PROFILE_BOOTSTRAP && PROFILE_BOOTSTRAP.profileId) ||
      (CURRENT_USER && (CURRENT_USER.ID || CURRENT_USER.Id || CURRENT_USER.id))
    ) || '',
    profileSummary: null,
    profileMetrics: []
  };

  let profileHeroChartInstance = null;

  function safeString(value) {
    if (value === null || typeof value === 'undefined') return '';
    const text = String(value).trim();
    if (!text || text.toLowerCase() === 'undefined' || text.toLowerCase() === 'null') return '';
    return text;
  }

  function resolveBaseUrl() {
    if (typeof safeBaseUrl !== 'undefined' && safeBaseUrl) return safeBaseUrl;
    if (typeof BASE_URL !== 'undefined' && BASE_URL) return BASE_URL;
    if (typeof scriptUrl !== 'undefined' && scriptUrl) return scriptUrl;
    if (typeof SCRIPT_URL !== 'undefined' && SCRIPT_URL) return SCRIPT_URL;
    return '';
  }

  function buildPageLink(slug, extraParams = {}) {
    const params = Object.assign({ page: slug }, extraParams || {});
    const query = Object.keys(params)
      .filter(key => params[key] !== undefined && params[key] !== null && params[key] !== '')
      .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
      .join('&');
    const base = resolveBaseUrl();
    if (!base) {
      return `?${query}`;
    }
    const joiner = base.includes('?') ? '&' : '?';
    return `${base}${joiner}${query}`;
  }

  function caseInsensitiveLookup(source, key) {
    if (!source || typeof source !== 'object') return undefined;
    if (Object.prototype.hasOwnProperty.call(source, key)) {
      return source[key];
    }
    const lower = String(key).toLowerCase();
    const keys = Object.keys(source);
    for (let i = 0; i < keys.length; i++) {
      const candidate = keys[i];
      if (String(candidate).toLowerCase() === lower) {
        return source[candidate];
      }
    }
    return undefined;
  }

  function getField(record, keys) {
    if (!record || typeof record !== 'object') return '';
    const list = Array.isArray(keys) ? keys : [keys];
    for (let i = 0; i < list.length; i++) {
      const key = list[i];
      if (!key) continue;
      let value = caseInsensitiveLookup(record, key);
      if (value !== undefined && value !== null && safeString(value) !== '') {
        return value;
      }
      if (record.sheetFieldMap) {
        value = caseInsensitiveLookup(record.sheetFieldMap, key);
        if (value !== undefined && value !== null && safeString(value) !== '') {
          return value;
        }
      }
      if (Array.isArray(record.sheetFields)) {
        for (let f = 0; f < record.sheetFields.length; f++) {
          const field = record.sheetFields[f];
          if (!field || typeof field !== 'object') continue;
          const normalizedKey = safeString(field.key);
          if (normalizedKey && normalizedKey.toLowerCase() === String(key).toLowerCase()) {
            const candidate = field.value;
            if (candidate !== undefined && candidate !== null && safeString(candidate) !== '') {
              return candidate;
            }
          }
        }
      }
    }
    return '';
  }

  function normalizeList(input) {
    if (!input) return [];
    if (Array.isArray(input)) {
      return input
        .map(value => safeString(value))
        .filter(Boolean);
    }
    const text = safeString(input);
    if (!text) return [];
    if (text.startsWith('[') && text.endsWith(']')) {
      try {
        const parsed = JSON.parse(text);
        if (Array.isArray(parsed)) {
          return parsed.map(value => safeString(value)).filter(Boolean);
        }
      } catch (_) { /* ignore */ }
    }
    return text.split(/[,;|]+/).map(part => safeString(part)).filter(Boolean);
  }

  function slugifyProfileBase(value) {
    const base = safeString(value).toLowerCase();
    if (!base) {
      return '';
    }
    return base.replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
  }

  function computeProfileSlug(userRecord, detailRecord) {
    const record = detailRecord && detailRecord.record ? detailRecord.record : detailRecord || {};
    const candidates = [];

    candidates.push(
      getField(userRecord, ['UserName', 'userName', 'username']) ||
      getField(record, ['UserName', 'userName', 'username'])
    );

    candidates.push(
      getField(userRecord, ['DisplayName', 'displayName', 'FullName', 'fullName']) ||
      getField(record, ['DisplayName', 'displayName', 'FullName', 'fullName'])
    );

    candidates.push([
      getField(userRecord, ['FirstName', 'firstName', 'GivenName', 'givenName']),
      getField(userRecord, ['LastName', 'lastName', 'Surname', 'surname', 'FamilyName', 'familyName'])
    ].filter(Boolean).join(' '));

    candidates.push([
      getField(record, ['FirstName', 'firstName', 'GivenName', 'givenName']),
      getField(record, ['LastName', 'lastName', 'Surname', 'surname', 'FamilyName', 'familyName'])
    ].filter(Boolean).join(' '));

    candidates.push(
      getField(userRecord, ['Email', 'email']) ||
      getField(record, ['Email', 'email'])
    );

    for (let i = 0; i < candidates.length; i++) {
      const slug = slugifyProfileBase(candidates[i]);
      if (slug) {
        return slug;
      }
    }

    return 'user';
  }

  function resolveProfileIdentifier(userRecord, detailRecord) {
    const record = detailRecord && detailRecord.record ? detailRecord.record : detailRecord || {};
    const identifier =
      getField(userRecord, ['ID', 'Id', 'id', 'EmployeeID', 'employeeId', 'ProfileID', 'profileId']) ||
      getField(record, ['ID', 'Id', 'id', 'EmployeeID', 'employeeId', 'ProfileID', 'profileId']) ||
      '';
    return safeString(identifier);
  }

  function ensureProfileSlugInUrl(profileSlug) {
    if (!profileSlug || typeof window === 'undefined' || !window.location || !window.history) {
      return;
    }

    try {
      const url = new URL(window.location.href);
      if (url.searchParams.get('profileId') === profileSlug) {
        return;
      }
      url.searchParams.set('profileId', profileSlug);
      window.history.replaceState({}, document.title, url.toString());
    } catch (err) {
      const href = String(window.location.href || '');
      if (!href) {
        return;
      }
      const hasParam = /([?&])profileId=/i.test(href);
      if (hasParam) {
        const updated = href.replace(/([?&]profileId=)[^&#]*/i, `$1${encodeURIComponent(profileSlug)}`);
        window.history.replaceState({}, document.title, updated);
      } else {
        const separator = href.indexOf('?') === -1 ? '?' : '&';
        window.history.replaceState({}, document.title, `${href}${separator}profileId=${encodeURIComponent(profileSlug)}`);
      }
    }
  }

  function formatDate(value) {
    if (!value) return '';
    try {
      const date = value instanceof Date ? value : new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    } catch (_) {
      return '';
    }
  }

  function formatTenure(value) {
    if (!value) return '';
    try {
      const start = value instanceof Date ? value : new Date(value);
      if (Number.isNaN(start.getTime())) return '';

      const now = new Date();
      let years = now.getFullYear() - start.getFullYear();
      let months = now.getMonth() - start.getMonth();
      let days = now.getDate() - start.getDate();

      if (days < 0) {
        months -= 1;
        const priorMonth = new Date(now.getFullYear(), now.getMonth(), 0).getDate();
        days += priorMonth;
      }

      if (months < 0) {
        years -= 1;
        months += 12;
      }

      const parts = [];
      if (years > 0) {
        parts.push(`${years} yr${years > 1 ? 's' : ''}`);
      }
      if (months > 0) {
        parts.push(`${months} mo${months > 1 ? 's' : ''}`);
      }
      if (!parts.length && days > 0) {
        parts.push(`${days} day${days > 1 ? 's' : ''}`);
      }
      if (!parts.length) {
        parts.push('Less than a day');
      }

      return parts.join(' ');
    } catch (_) {
      return '';
    }
  }

  function formatBoolean(value, { positive = 'Yes', negative = 'No' } = {}) {
    const truthy = value === true || String(value).toLowerCase() === 'true' || String(value) === '1' || String(value).toLowerCase() === 'yes';
    const falsy = value === false || String(value).toLowerCase() === 'false' || String(value) === '0' || String(value).toLowerCase() === 'no';
    if (truthy) return positive;
    if (falsy) return negative;
    return '';
  }

  function formatRelativeTime(value) {
    if (!value) return '';
    try {
      const date = value instanceof Date ? value : new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      const now = Date.now();
      const diff = now - date.getTime();
      const abs = Math.abs(diff);
      const minute = 60 * 1000;
      const hour = 60 * minute;
      const day = 24 * hour;
      const week = 7 * day;

      let amount;
      let unit;
      if (abs < hour) {
        amount = Math.max(1, Math.round(abs / minute));
        unit = 'min';
      } else if (abs < day) {
        amount = Math.max(1, Math.round(abs / hour));
        unit = 'hr';
      } else if (abs < week) {
        amount = Math.max(1, Math.round(abs / day));
        unit = 'day';
      } else {
        amount = Math.max(1, Math.round(abs / week));
        unit = 'wk';
      }

      const plural = amount === 1 ? '' : 's';
      const suffix = diff >= 0 ? 'ago' : 'from now';
      return `${amount} ${unit}${plural} ${suffix}`;
    } catch (_) {
      return '';
    }
  }

  function formatScore(value, { decimals = 1 } = {}) {
    const num = Number(value);
    if (!Number.isFinite(num)) return '—';
    const factor = Math.pow(10, decimals);
    const rounded = Math.round(num * factor) / factor;
    const text = decimals === 0 ? String(Math.round(rounded)) : rounded.toFixed(decimals).replace(/\.0+$/, '');
    return `${text}%`;
  }

  function parseNumeric(value) {
    if (value === null || typeof value === 'undefined') {
      return NaN;
    }

    if (typeof value === 'number') {
      return Number.isFinite(value) ? value : NaN;
    }

    const text = safeString(value);
    if (!text) {
      return NaN;
    }

    const normalized = text
      .replace(/[^0-9.,\-+kKmMbB%]/g, '')
      .replace(/,(?=\d{3}(?:\D|$))/g, '')
      .replace(/(\d)[,](\d)/g, '$1$2');

    const multiplierMatch = normalized.match(/(-?\d+(?:\.\d+)?)([kmb%])?$/i);
    if (!multiplierMatch) {
      const direct = Number(normalized.replace(/[^0-9.+-]/g, ''));
      return Number.isFinite(direct) ? direct : NaN;
    }

    const base = Number(multiplierMatch[1]);
    if (!Number.isFinite(base)) {
      return NaN;
    }

    const suffix = (multiplierMatch[2] || '').toLowerCase();
    switch (suffix) {
      case 'k':
        return base * 1_000;
      case 'm':
        return base * 1_000_000;
      case 'b':
        return base * 1_000_000_000;
      case '%':
        return base;
      default:
        return base;
    }
  }

  function formatCount(value) {
    if (!Number.isFinite(value)) {
      return '';
    }
    try {
      return new Intl.NumberFormat(undefined, {
        maximumFractionDigits: value % 1 === 0 ? 0 : 1
      }).format(value);
    } catch (err) {
      return String(Math.round(value));
    }
  }

  function createInfoItem(label, value, options = {}) {
    const container = document.createElement('div');
    container.className = 'info-item';

    const labelEl = document.createElement('div');
    labelEl.className = 'info-label';
    labelEl.textContent = label;
    container.appendChild(labelEl);

    const valueEl = document.createElement('div');
    valueEl.className = 'info-value';
    if (options.isLink) {
      const link = document.createElement('a');
      link.href = options.href || `mailto:${value}`;
      link.textContent = value;
      link.target = options.target || '_blank';
      valueEl.appendChild(link);
    } else {
      valueEl.textContent = value;
    }
    container.appendChild(valueEl);

    return container;
  }

  function renderInfoGrid(containerId, fields, record) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    const nodes = [];
    fields.forEach(def => {
      const raw = getField(record, def.keys);
      let value = safeString(raw);

      if (def.transform) {
        value = def.transform(raw, record, state.user);
      }

      if (!value) return;
      nodes.push(createInfoItem(def.label, value, def));
    });

    if (!nodes.length) {
      const empty = document.createElement('div');
      empty.className = 'empty-state';
      empty.textContent = 'No details available yet.';
      container.appendChild(empty);
      return;
    }

    nodes.forEach(node => container.appendChild(node));
  }

  function renderProfileEssentials(summary) {
    const container = document.getElementById('profileEssentials');
    if (!container) {
      return;
    }

    const items = [];
    const pushItem = (label, value, options = {}) => {
      const text = safeString(value);
      if (!text) {
        return;
      }
      items.push(Object.assign({ label, value: text }, options));
    };

    summary = summary || {};

    const profileReference = summary.profileSlug || summary.profileId;
    pushItem('Profile Slug', profileReference, { code: true });
    pushItem('Work Email', summary.email, { isLink: true, href: summary.email ? `mailto:${summary.email}` : '' });
    pushItem('Campaign', summary.campaign);
    pushItem('Manager', summary.manager);
    pushItem('Location', summary.location);
    pushItem('Employment Status', summary.status);
    pushItem('Username', summary.username, { code: true });
    pushItem('Tenure', summary.tenure, {
      meta: summary.startDate ? `Started ${summary.startDate}` : ''
    });

    if (!items.length) {
      container.hidden = true;
      container.innerHTML = '';
      return;
    }

    container.hidden = false;
    container.innerHTML = '';

    items.forEach(item => {
      const card = document.createElement('div');
      card.className = 'profile-essential';

      const labelEl = document.createElement('span');
      labelEl.className = 'profile-essential__label';
      labelEl.textContent = item.label;
      card.appendChild(labelEl);

      const valueEl = document.createElement('div');
      valueEl.className = 'profile-essential__value';
      if (item.code) {
        valueEl.classList.add('profile-essential__value--code');
      }

      if (item.isLink && item.value) {
        const link = document.createElement('a');
        link.href = item.href || item.value;
        link.target = '_top';
        link.rel = 'noopener';
        link.textContent = item.value;
        valueEl.appendChild(link);
      } else {
        valueEl.textContent = item.value;
      }

      card.appendChild(valueEl);

      if (item.meta) {
        const metaEl = document.createElement('div');
        metaEl.className = 'profile-essential__meta';
        metaEl.textContent = item.meta;
        card.appendChild(metaEl);
      }

      container.appendChild(card);
    });
  }

  function gatherProfileMetrics(record, summary) {
    const combined = Object.assign({}, state.user, record || {});
    summary = summary || state.profileSummary || {};

    const metrics = [];

    const activitiesRaw =
      getField(combined, ['ActivitiesCompleted', 'CompletedActivities', 'ActivityCount', 'TotalActivities', 'Activities']) ||
      summary.activitiesCompleted ||
      summary.totalActivities ||
      null;
    const activitiesValue = parseNumeric(activitiesRaw);
    const activitiesWindow =
      safeString(
        getField(combined, [
          'ActivitiesPeriod',
          'ActivityPeriod',
          'ActivityWindow',
          'PerformanceWindow',
          'ReportingPeriod'
        ])
      ) || '';
    metrics.push({
      key: 'activities',
      label: 'Activities Completed',
      icon: 'fa-solid fa-list-check',
      value: Number.isFinite(activitiesValue) ? formatCount(activitiesValue) : '—',
      numericValue: Number.isFinite(activitiesValue) ? activitiesValue : null,
      trend: activitiesWindow || 'Current period'
    });

    const qualityRaw =
      getField(combined, ['QualityScore', 'Quality', 'QAScore', 'AverageScore', 'ScoreAverage', 'Score']) ||
      summary.qualityScore ||
      summary.qaScore ||
      summary.scoreAverage ||
      null;
    const qualityValue = parseNumeric(qualityRaw);
    const qualityTargetRaw =
      getField(combined, ['QualityTarget', 'TargetScore', 'QualityGoal', 'QATarget']) ||
      summary.qualityTarget ||
      null;
    const qualityTarget = parseNumeric(qualityTargetRaw);
    metrics.push({
      key: 'quality',
      label: 'Quality Score',
      icon: 'fa-solid fa-gauge-high',
      value: Number.isFinite(qualityValue) ? formatScore(qualityValue, { decimals: 1 }) : '—',
      numericValue: Number.isFinite(qualityValue) ? qualityValue : null,
      trend: Number.isFinite(qualityTarget)
        ? `Target ${formatScore(qualityTarget, { decimals: 0 })}`
        : 'QA rolling average'
    });

    const adherenceRaw =
      getField(combined, ['Attendance', 'AttendanceRate', 'ScheduleAdherence', 'Adherence', 'Compliance']) ||
      summary.scheduleAdherence ||
      summary.attendance ||
      null;
    const adherenceValue = parseNumeric(adherenceRaw);
    const adherenceTargetRaw =
      getField(combined, ['AttendanceTarget', 'AdherenceTarget', 'ScheduleGoal', 'AttendanceGoal']) ||
      summary.attendanceTarget ||
      null;
    const adherenceTarget = parseNumeric(adherenceTargetRaw);
    metrics.push({
      key: 'adherence',
      label: 'Schedule Adherence',
      icon: 'fa-solid fa-calendar-check',
      value: Number.isFinite(adherenceValue) ? formatScore(adherenceValue, { decimals: 0 }) : '—',
      numericValue: Number.isFinite(adherenceValue) ? adherenceValue : null,
      trend: Number.isFinite(adherenceTarget)
        ? `Goal ${formatScore(adherenceTarget, { decimals: 0 })}`
        : 'Last 30 days'
    });

    const startDateRaw =
      getField(combined, ['StartDate', 'HireDate', 'DateHired', 'OnboardDate', 'CreatedAt']) ||
      summary.startDate ||
      null;
    const tenureText = summary.tenure || formatTenure(startDateRaw);
    metrics.push({
      key: 'tenure',
      label: 'Tenure',
      icon: 'fa-solid fa-user-clock',
      value: tenureText || '—',
      numericValue: null,
      trend: safeString(summary.startDate || formatDate(startDateRaw))
        ? `Started ${summary.startDate || formatDate(startDateRaw)}`
        : '',
      trendVariant: 'neutral'
    });

    return metrics;
  }

  function parseHeroTrendDataset(source) {
    if (!source) {
      return null;
    }

    let data = source;
    if (typeof source === 'string') {
      const text = safeString(source);
      if (!text) {
        return null;
      }
      try {
        data = JSON.parse(text);
      } catch (_) {
        data = text.split(/[|,\n]+/).map(part => part.trim()).filter(Boolean);
      }
    }

    if (!Array.isArray(data)) {
      return null;
    }

    const labels = [];
    const values = [];

    data.forEach((entry, index) => {
      if (entry === null || typeof entry === 'undefined') {
        return;
      }
      if (typeof entry === 'number') {
        values.push(entry);
        labels.push(`P${index + 1}`);
        return;
      }
      if (typeof entry === 'string') {
        const numeric = parseNumeric(entry);
        if (Number.isFinite(numeric)) {
          values.push(numeric);
          labels.push(`P${index + 1}`);
        }
        return;
      }
      if (entry && typeof entry === 'object') {
        const numeric = parseNumeric(
          entry.value ||
          entry.score ||
          entry.count ||
          entry.total ||
          entry.amount ||
          entry.metric
        );
        if (!Number.isFinite(numeric)) {
          return;
        }
        const label = safeString(
          entry.label || entry.period || entry.week || entry.month || entry.date || entry.name
        );
        values.push(numeric);
        labels.push(label || `P${index + 1}`);
      }
    });

    if (values.length < 2) {
      return null;
    }

    return {
      labels,
      values,
      subtitle: labels.length ? `${labels[0]} – ${labels[labels.length - 1]}` : ''
    };
  }

  function generateHeroTrend(record, summary, metrics) {
    const combined = Object.assign({}, state.user, record || {});
    summary = summary || {};

    const candidates = [
      combined.performanceTrend,
      combined.PerformanceTrend,
      combined.performanceHistory,
      combined.PerformanceHistory,
      combined.activityTrend,
      combined.ActivityTrend,
      combined.activityHistory,
      combined.ActivityHistory,
      summary.performanceTrend,
      summary.performanceHistory
    ];

    let dataset = null;
    for (let i = 0; i < candidates.length; i++) {
      dataset = parseHeroTrendDataset(candidates[i]);
      if (dataset) {
        break;
      }
    }

    if (!dataset) {
      const activityMetric = Array.isArray(metrics)
        ? metrics.find(metric => metric && metric.key === 'activities' && Number.isFinite(metric.numericValue))
        : null;
      const base = activityMetric ? Math.max(activityMetric.numericValue, 24) : 72;
      const multipliers = [0.55, 0.62, 0.68, 0.72, 0.78, 0.86];
      const values = multipliers.map((multiplier, index) => {
        if (index === multipliers.length - 1) {
          return Math.round(base);
        }
        return Math.max(12, Math.round(base * multiplier));
      });
      dataset = {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
        values,
        subtitle: 'Last 6 weeks',
        generated: true
      };
    } else if (!dataset.subtitle) {
      dataset.subtitle = dataset.labels.length
        ? `${dataset.labels[0]} – ${dataset.labels[dataset.labels.length - 1]}`
        : '';
    }

    return dataset;
  }

  function renderProfileHeroChart(trend) {
    const container = document.getElementById('profileHeroChartContainer');
    if (!container) {
      return;
    }

    const canvas = container.querySelector('canvas');
    const emptyState = container.querySelector('.profile-hero__chart-empty');

    if (!trend || !Array.isArray(trend.values) || trend.values.length < 2 || typeof Chart === 'undefined') {
      if (profileHeroChartInstance) {
        profileHeroChartInstance.destroy();
        profileHeroChartInstance = null;
      }
      if (canvas) {
        canvas.style.display = 'none';
      }
      if (emptyState) {
        emptyState.textContent = 'Performance insights will appear once data is available.';
        emptyState.style.display = 'block';
      }
      return;
    }

    if (emptyState) {
      emptyState.style.display = 'none';
    }
    if (canvas) {
      canvas.style.display = '';
    }

    const context = canvas ? canvas.getContext('2d') : null;
    if (!context) {
      return;
    }

    if (profileHeroChartInstance) {
      profileHeroChartInstance.destroy();
      profileHeroChartInstance = null;
    }

    profileHeroChartInstance = new Chart(context, {
      type: 'line',
      data: {
        labels: trend.labels,
        datasets: [
          {
            label: 'Performance',
            data: trend.values,
            fill: true,
            tension: 0.35,
            borderColor: 'rgba(14, 165, 233, 0.9)',
            backgroundColor: 'rgba(14, 165, 233, 0.18)',
            pointBackgroundColor: '#0ea5e9',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 5,
            borderWidth: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: context => {
                const value = context.parsed.y;
                if (Number.isFinite(value)) {
                  return ` ${formatCount(value)}`;
                }
                return context.parsed.y;
              }
            },
            backgroundColor: 'rgba(15, 23, 42, 0.92)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: 'rgba(255, 255, 255, 0.35)',
            borderWidth: 1,
            displayColors: false
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              color: 'rgba(15, 23, 42, 0.6)',
              font: { family: 'Inter' }
            }
          },
          y: {
            grid: { color: 'rgba(15, 23, 42, 0.08)' },
            ticks: {
              color: 'rgba(15, 23, 42, 0.6)',
              font: { family: 'Inter' },
              callback: value => formatCount(value)
            }
          }
        }
      }
    });
  }

  function renderProfileHero(summary) {
    const heroSection = document.getElementById('profileHero');
    const container = document.getElementById('profileHeroContent');
    if (!heroSection || !container) {
      return;
    }

    if (!summary) {
      heroSection.hidden = true;
      container.innerHTML = '';
      return;
    }

    const detailRecord = state.detail && state.detail.record ? state.detail.record : state.detail || {};
    const metrics = gatherProfileMetrics(detailRecord, summary);
    state.profileMetrics = metrics;

    const trend = generateHeroTrend(detailRecord, summary, metrics);

    if (trend && Array.isArray(trend.values) && trend.values.length >= 2) {
      const diff = trend.values[trend.values.length - 1] - trend.values[trend.values.length - 2];
      const activitiesMetric = metrics.find(metric => metric.key === 'activities');
      if (activitiesMetric && (!activitiesMetric.trend || activitiesMetric.trend === '')) {
        const symbol = diff >= 0 ? '▲' : '▼';
        const magnitude = formatCount(Math.abs(diff));
        activitiesMetric.trend = `${symbol} ${magnitude} vs prior period`;
        activitiesMetric.negative = diff < 0;
        if (activitiesMetric.trendVariant) {
          delete activitiesMetric.trendVariant;
        }
      }
    }

    heroSection.hidden = false;
    container.innerHTML = '';

    const summaryCard = document.createElement('div');
    summaryCard.className = 'profile-hero__summary';

    const identity = document.createElement('div');
    identity.className = 'profile-hero__identity';

    const avatar = document.createElement('div');
    avatar.className = 'profile-hero__avatar';
    avatar.textContent = safeString(summary.name).charAt(0).toUpperCase() || 'U';
    identity.appendChild(avatar);

    const identityText = document.createElement('div');
    identityText.className = 'profile-hero__identity-text';

    const nameEl = document.createElement('div');
    nameEl.className = 'profile-hero__name';
    nameEl.textContent = summary.name || 'My Profile';
    identityText.appendChild(nameEl);

    if (summary.primaryRole) {
      const roleEl = document.createElement('div');
      roleEl.className = 'profile-hero__role';
      const icon = document.createElement('i');
      icon.className = 'fa-solid fa-shield-halved';
      roleEl.appendChild(icon);
      const text = document.createElement('span');
      text.textContent = summary.primaryRole;
      roleEl.appendChild(text);
      identityText.appendChild(roleEl);
    }

    if (summary.username) {
      const usernameEl = document.createElement('div');
      usernameEl.className = 'profile-hero__username';
      usernameEl.textContent = summary.username.indexOf('@') === -1 ? `@${summary.username}` : summary.username;
      identityText.appendChild(usernameEl);
    }

    identity.appendChild(identityText);
    summaryCard.appendChild(identity);

    const chipRow = document.createElement('div');
    chipRow.className = 'profile-hero__meta';
    const addChip = (iconClass, label) => {
      const text = safeString(label);
      if (!text) {
        return;
      }
      const chip = document.createElement('span');
      chip.className = 'profile-hero__chip';
      if (iconClass) {
        const iconEl = document.createElement('i');
        iconEl.className = iconClass;
        chip.appendChild(iconEl);
      }
      const labelEl = document.createElement('span');
      labelEl.textContent = text;
      chip.appendChild(labelEl);
      chipRow.appendChild(chip);
    };

    addChip('fa-solid fa-circle-check', summary.status);
    addChip('fa-solid fa-calendar-day', summary.startDate ? `Joined ${summary.startDate}` : '');
    addChip('fa-solid fa-hourglass-half', summary.tenure);
    addChip('fa-solid fa-diagram-project', summary.campaign);

    if (chipRow.childNodes.length) {
      summaryCard.appendChild(chipRow);
    }

    const metaGrid = document.createElement('div');
    metaGrid.className = 'profile-hero__meta-grid';

    const appendMeta = (iconClass, label, value) => {
      const text = safeString(value);
      if (!text) {
        return;
      }
      const item = document.createElement('div');
      item.className = 'profile-hero__meta-item';

      const labelEl = document.createElement('div');
      labelEl.className = 'profile-hero__meta-label';
      if (iconClass) {
        const iconEl = document.createElement('i');
        iconEl.className = iconClass;
        labelEl.appendChild(iconEl);
      }
      const labelText = document.createElement('span');
      labelText.textContent = label;
      labelEl.appendChild(labelText);
      item.appendChild(labelEl);

      const valueEl = document.createElement('div');
      valueEl.className = 'profile-hero__meta-value';
      valueEl.textContent = text;
      item.appendChild(valueEl);

      metaGrid.appendChild(item);
    };

    appendMeta('fa-solid fa-id-badge', 'Profile Slug', summary.profileSlug || summary.profileId);
    appendMeta('fa-solid fa-user-tie', 'Manager', summary.manager);
    appendMeta('fa-solid fa-location-dot', 'Location', summary.location);

    if (metaGrid.childNodes.length) {
      summaryCard.appendChild(metaGrid);
    }

    const contacts = document.createElement('div');
    contacts.className = 'profile-hero__contacts';

    const appendContact = (iconClass, label, value, hrefPrefix) => {
      const text = safeString(value);
      if (!text) {
        return;
      }
      const contact = document.createElement('div');
      contact.className = 'profile-hero__contact';
      if (iconClass) {
        const iconEl = document.createElement('i');
        iconEl.className = iconClass;
        contact.appendChild(iconEl);
      }
      if (hrefPrefix) {
        const link = document.createElement('a');
        link.href = `${hrefPrefix}${text}`;
        link.target = '_top';
        link.rel = 'noopener';
        link.textContent = text;
        contact.appendChild(link);
      } else {
        const span = document.createElement('span');
        span.textContent = text;
        contact.appendChild(span);
      }
      contacts.appendChild(contact);
    };

    appendContact('fa-solid fa-envelope', 'Email', summary.email, 'mailto:');
    if (summary.phone) {
      const tel = summary.phone.replace(/[^0-9+]/g, '');
      appendContact('fa-solid fa-phone', 'Phone', summary.phone, tel ? 'tel:' : '');
    }

    if (contacts.childNodes.length) {
      summaryCard.appendChild(contacts);
    }

    const actions = document.createElement('div');
    actions.className = 'profile-hero__actions';

    const createAction = (href, label, iconClass, variant) => {
      const safeHref = safeString(href);
      if (!safeHref) {
        return;
      }
      const action = document.createElement('a');
      action.className = `profile-hero__action profile-hero__action--${variant}`;
      action.href = safeHref;
      action.target = '_top';
      action.rel = 'noopener';
      const iconEl = document.createElement('i');
      iconEl.className = iconClass;
      const text = document.createElement('span');
      text.textContent = label;
      action.appendChild(iconEl);
      action.appendChild(text);
      actions.appendChild(action);
    };

    try {
      createAction(buildPageLink('agent-experience'), 'Agent Experience', 'fa-solid fa-user-gear', 'primary');
    } catch (err) {
      console.warn('Unable to build Agent Experience link', err);
    }

    try {
      createAction(buildPageLink('agentschedule'), 'Agent Schedule', 'fa-solid fa-calendar-days', 'secondary');
    } catch (err) {
      console.warn('Unable to build Agent Schedule link', err);
    }

    if (actions.childNodes.length) {
      summaryCard.appendChild(actions);
    }

    container.appendChild(summaryCard);

    const insights = document.createElement('div');
    insights.className = 'profile-hero__insights';

    const metricsContainer = document.createElement('div');
    metricsContainer.className = 'profile-hero__metrics';

    if (Array.isArray(metrics) && metrics.length) {
      metrics.forEach(metric => {
        const metricCard = document.createElement('div');
        metricCard.className = 'profile-metric';
        if (metric && metric.negative) {
          metricCard.setAttribute('data-negative', 'true');
        }

        const iconWrap = document.createElement('span');
        iconWrap.className = 'profile-metric__icon';
        const iconEl = document.createElement('i');
        iconEl.className = metric.icon || 'fa-solid fa-chart-line';
        iconWrap.appendChild(iconEl);
        metricCard.appendChild(iconWrap);

        const labelEl = document.createElement('span');
        labelEl.className = 'profile-metric__label';
        labelEl.textContent = metric.label || '';
        metricCard.appendChild(labelEl);

        const valueEl = document.createElement('strong');
        valueEl.className = 'profile-metric__value';
        valueEl.textContent = metric.value || '—';
        metricCard.appendChild(valueEl);

        const detail = safeString(metric.trend);
        if (detail) {
          const detailEl = document.createElement('div');
          detailEl.className = 'profile-metric__trend';
          if (metric.trendVariant) {
            detailEl.setAttribute('data-variant', metric.trendVariant);
          }
          detailEl.textContent = detail;
          metricCard.appendChild(detailEl);
        }

        metricsContainer.appendChild(metricCard);
      });
    } else {
      const emptyMetric = document.createElement('div');
      emptyMetric.className = 'profile-hero__chart-empty';
      emptyMetric.textContent = 'Metrics will appear once activity data is available.';
      metricsContainer.appendChild(emptyMetric);
    }

    insights.appendChild(metricsContainer);

    const chartCard = document.createElement('div');
    chartCard.className = 'profile-hero__chart';
    chartCard.id = 'profileHeroChartContainer';

    const chartHeader = document.createElement('header');
    const chartTitle = document.createElement('div');
    chartTitle.textContent = 'Performance Trend';
    chartHeader.appendChild(chartTitle);
    const chartSubtitle = document.createElement('span');
    chartSubtitle.textContent = trend && trend.subtitle ? trend.subtitle : 'Recent periods';
    chartHeader.appendChild(chartSubtitle);
    chartCard.appendChild(chartHeader);

    const canvas = document.createElement('canvas');
    canvas.id = 'profilePerformanceChart';
    chartCard.appendChild(canvas);

    const emptyState = document.createElement('div');
    emptyState.className = 'profile-hero__chart-empty';
    emptyState.textContent = 'Performance insights will appear once data is available.';
    chartCard.appendChild(emptyState);

    insights.appendChild(chartCard);

    container.appendChild(insights);

    renderProfileHeroChart(trend);
  }

  function renderChips(containerId, values, icon) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    const list = normalizeList(values);
    if (!list.length) {
      container.classList.add('empty');
      return;
    }
    container.classList.remove('empty');

    list.forEach(value => {
      const chip = document.createElement('span');
      chip.className = 'chip';
      if (icon) {
        const iconEl = document.createElement('i');
        iconEl.className = icon;
        chip.appendChild(iconEl);
      }
      const text = document.createElement('span');
      text.textContent = value;
      chip.appendChild(text);
      container.appendChild(chip);
    });
  }

  function renderEquipment(items) {
    const listEl = document.getElementById('equipmentList');
    const loader = document.getElementById('equipmentLoader');
    if (loader) loader.classList.remove('show');
    if (!listEl) return;
    listEl.innerHTML = '';

    if (state.loadingEquipment) {
      return;
    }

    if (!Array.isArray(items) || !items.length) {
      const empty = document.createElement('li');
      empty.className = 'empty-state';
      empty.textContent = 'No assigned equipment on record.';
      listEl.appendChild(empty);
      return;
    }

    items.forEach(item => {
      const li = document.createElement('li');
      li.className = 'equipment-item';
      const name = safeString(item.ItemName || item.itemName || item.DisplayName || item.displayName || 'Equipment');
      const type = safeString(item.ItemType || item.itemType);
      const serial = safeString(item.SerialNumber || item.serialNumber);
      const status = safeString(item.Status || item.status || item.Condition || item.condition);
      const issued = formatDate(item.IssuedDate || item.issuedDate || item.CreatedAt || item.createdAt);
      const returned = formatDate(item.ReturnedDate || item.returnedDate);

      const heading = document.createElement('strong');
      heading.textContent = name;
      li.appendChild(heading);

      const meta = document.createElement('div');
      meta.className = 'equipment-meta';
      if (type) meta.appendChild(document.createTextNode(type));
      if (serial) meta.appendChild(document.createTextNode(`SN: ${serial}`));
      if (status) meta.appendChild(document.createTextNode(`Status: ${status}`));
      if (issued) meta.appendChild(document.createTextNode(`Issued ${issued}`));
      if (returned) meta.appendChild(document.createTextNode(`Returned ${returned}`));
      li.appendChild(meta);

      if (safeString(item.Notes || item.notes)) {
        const notes = document.createElement('div');
        notes.textContent = safeString(item.Notes || item.notes);
        notes.style.fontSize = '0.85rem';
        notes.style.color = 'var(--profile-text-secondary)';
        li.appendChild(notes);
      }

      listEl.appendChild(li);
    });
  }

  function createManagerMetric(label, value, secondary) {
    const metric = document.createElement('div');
    metric.className = 'metric';

    const labelEl = document.createElement('span');
    labelEl.className = 'label';
    labelEl.textContent = label;
    metric.appendChild(labelEl);

    const valueEl = document.createElement('span');
    valueEl.className = 'value';
    valueEl.textContent = value;
    metric.appendChild(valueEl);

    if (secondary) {
      const secondaryEl = document.createElement('small');
      secondaryEl.textContent = secondary;
      metric.appendChild(secondaryEl);
    }

    return metric;
  }

  function renderManagerSummary(summary) {
    const card = document.getElementById('managerSummaryCard');
    if (!card) return;

    const loader = document.getElementById('managerSummaryLoader');
    if (loader) {
      if (state.loadingManagerSummary) {
        loader.classList.add('show');
      } else {
        loader.classList.remove('show');
      }
    }

    const shouldShow = isLikelyManager(summary);
    if (!shouldShow) {
      card.classList.add('hidden');
      return;
    }
    card.classList.remove('hidden');

    const statsEl = document.getElementById('managerSummaryStats');
    const listEl = document.getElementById('managerSummaryList');
    const emptyEl = document.getElementById('managerSummaryEmpty');
    const countEl = document.getElementById('managerSummaryManagedCount');
    const paginationEl = document.getElementById('managerSummaryPagination');

    if (emptyEl && state.loadingManagerSummary) {
      emptyEl.classList.add('hidden');
    }

    if (countEl) {
      countEl.innerHTML = '<i class="fa-solid fa-user-group"></i> 0 Managed';
    }
    if (statsEl) statsEl.innerHTML = '';
    if (listEl) listEl.innerHTML = '';
    if (paginationEl) {
      paginationEl.innerHTML = '';
      paginationEl.classList.add('hidden');
    }

    if (!summary) {
      if (emptyEl && !state.loadingManagerSummary) {
        emptyEl.textContent = 'Managed team insights will appear here once available.';
        emptyEl.classList.remove('hidden');
      }
      return;
    }

    if (summary.success === false) {
      if (emptyEl && !state.loadingManagerSummary) {
        const message = summary && summary.error ? summary.error : 'We could not load your team summary right now.';
        emptyEl.textContent = message;
        emptyEl.classList.remove('hidden');
      }
      return;
    }

    const users = Array.isArray(summary.users) ? summary.users.slice() : [];
    const totals = summary.totals || {};

    const managedCount = typeof totals.managedCount === 'number' ? totals.managedCount : users.length;
    const totalEvaluations = typeof totals.totalEvaluations === 'number'
      ? totals.totalEvaluations
      : users.reduce((sum, user) => sum + (Number(user && user.evaluations) || 0), 0);
    const lastEvaluationDate = totals.lastEvaluation || (function () {
      let latest = null;
      users.forEach(user => {
        if (!user || !user.lastEvaluation) return;
        const date = new Date(user.lastEvaluation);
        if (Number.isNaN(date.getTime())) return;
        if (!latest || date > latest) latest = date;
      });
      return latest ? latest.toISOString() : '';
    })();

    if (countEl) {
      countEl.innerHTML = `<i class="fa-solid fa-user-group"></i> ${managedCount} Managed`;
    }

    if (statsEl) {
      const stats = [
        { label: 'Managed Agents', value: managedCount },
        { label: 'Team Avg Score', value: formatScore(totals.scoreAverage) },
        { label: 'Total Evaluations', value: totalEvaluations },
        { label: 'Last Evaluation', value: lastEvaluationDate ? (formatDate(lastEvaluationDate) || '—') : '—', secondary: lastEvaluationDate ? formatRelativeTime(lastEvaluationDate) : '' }
      ];

      stats.forEach(stat => {
        const statEl = document.createElement('div');
        statEl.className = 'manager-stat';

        const labelEl = document.createElement('span');
        labelEl.className = 'label';
        labelEl.textContent = stat.label;
        statEl.appendChild(labelEl);

        const valueEl = document.createElement('span');
        valueEl.className = 'value';
        valueEl.textContent = stat.value;
        statEl.appendChild(valueEl);

        if (stat.secondary) {
          const secondaryEl = document.createElement('small');
          secondaryEl.textContent = stat.secondary;
          statEl.appendChild(secondaryEl);
        }

        statsEl.appendChild(statEl);
      });
    }

    if (!users.length) {
      if (emptyEl) {
        emptyEl.textContent = 'No managed team members are assigned to you yet.';
        emptyEl.classList.remove('hidden');
      }
      if (paginationEl) {
        paginationEl.classList.add('hidden');
      }
      state.managerPagination.page = 1;
      return;
    }

    if (emptyEl) {
      emptyEl.classList.add('hidden');
    }

    users.sort((a, b) => {
      const aScore = Number(a && a.averageScore);
      const bScore = Number(b && b.averageScore);
      if (Number.isFinite(bScore) && Number.isFinite(aScore)) {
        return bScore - aScore;
      }
      if (Number.isFinite(bScore)) return 1;
      if (Number.isFinite(aScore)) return -1;
      const aName = safeString(a && (a.name || a.FullName || a.fullName || a.UserName || a.userName));
      const bName = safeString(b && (b.name || b.FullName || b.fullName || b.UserName || b.userName));
      return aName.localeCompare(bName);
    });

    const pageSize = state.managerPagination.pageSize || 6;
    let currentPage = state.managerPagination.page || 1;
    const totalPages = Math.max(1, Math.ceil(users.length / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;
    state.managerPagination.page = currentPage;

    const startIndex = (currentPage - 1) * pageSize;
    const pagedUsers = users.slice(startIndex, startIndex + pageSize);

    if (paginationEl) {
      paginationEl.innerHTML = '';
      if (users.length) {
        const range = document.createElement('span');
        range.className = 'manager-pagination__range';
        const start = startIndex + 1;
        const end = Math.min(startIndex + pageSize, users.length);
        range.textContent = `Showing ${start}–${end} of ${users.length}`;
        paginationEl.appendChild(range);

        if (totalPages > 1) {
          const controls = document.createElement('div');
          controls.className = 'manager-pagination__controls';

          const createButton = (action, label, icon, disabled) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'manager-pagination__button';
            button.dataset.pageAction = action;
            button.disabled = disabled;
            button.innerHTML = `<i class="${icon}"></i><span>${label}</span>`;
            controls.appendChild(button);
          };

          createButton('prev', 'Previous', 'fa-solid fa-arrow-left', currentPage === 1);
          createButton('next', 'Next', 'fa-solid fa-arrow-right', currentPage === totalPages);
          paginationEl.appendChild(controls);
        }

        paginationEl.classList.remove('hidden');
      }
    }

    pagedUsers.forEach(user => {
      const row = document.createElement('div');
      row.className = 'manager-row';

      const info = document.createElement('div');
      info.className = 'info';

      const nameEl = document.createElement('strong');
      nameEl.textContent = safeString(user && (user.name || user.FullName || user.fullName || user.UserName || user.userName || 'Team Member')) || 'Team Member';
      info.appendChild(nameEl);

      const detailParts = [];
      const campaignName = safeString(user && (user.campaignName || user.CampaignName));
      if (campaignName) detailParts.push(campaignName);
      const roles = normalizeList(user && (user.roles || user.roleNames || user.RoleNames));
      if (roles.length) detailParts.push(roles.join(', '));

      if (detailParts.length) {
        const detailsEl = document.createElement('span');
        detailsEl.textContent = detailParts.join(' • ');
        info.appendChild(detailsEl);
      }

      row.appendChild(info);

      const metrics = document.createElement('div');
      metrics.className = 'metrics';

      metrics.appendChild(createManagerMetric('Avg Score', formatScore(user && user.averageScore)));

      const evaluationCount = Number(user && user.evaluations) || 0;
      metrics.appendChild(createManagerMetric('Evaluations', evaluationCount.toString()));

      const lastEvalDate = user && user.lastEvaluation ? formatDate(user.lastEvaluation) : '';
      const lastEvalRelative = user && user.lastEvaluation ? formatRelativeTime(user.lastEvaluation) : '';
      metrics.appendChild(createManagerMetric('Last Eval', lastEvalDate || '—', lastEvalRelative));

      row.appendChild(metrics);

      if (listEl) {
        listEl.appendChild(row);
      }
    });
  }

  function handleManagerPaginationClick(event) {
    const button = event.target && event.target.closest ? event.target.closest('[data-page-action]') : null;
    if (!button || button.disabled) {
      return;
    }

    const action = button.getAttribute('data-page-action');
    const currentPage = state.managerPagination.page || 1;
    if (action === 'prev') {
      state.managerPagination.page = Math.max(1, currentPage - 1);
    } else if (action === 'next') {
      state.managerPagination.page = currentPage + 1;
    }

    renderManagerSummary(state.managerSummary);
  }

  function setupCollapsibleCards() {
    const toggles = document.querySelectorAll('.collapsible-toggle');
    toggles.forEach(toggle => {
      const targetId = toggle.getAttribute('data-target');
      const panel = targetId ? document.getElementById(targetId) : null;
      if (!panel) {
        return;
      }

      const label = toggle.querySelector('.collapsible-toggle__label');
      const collapsedText = toggle.getAttribute('data-collapsed-text') || 'Show';
      const expandedText = toggle.getAttribute('data-expanded-text') || 'Hide';

      const setState = expanded => {
        toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        panel.hidden = !expanded;
        if (label) {
          label.textContent = expanded ? expandedText : collapsedText;
        }
      };

      setState(false);

      toggle.addEventListener('click', () => {
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        setState(!isExpanded);
      });
    });
  }

  function resolveDisplayName(userRecord) {
    if (!userRecord || typeof userRecord !== 'object') {
      return '';
    }

    const direct = safeString(userRecord.FullName || userRecord.fullName) ||
      safeString(userRecord.DisplayName || userRecord.displayName);
    if (direct) {
      return direct;
    }

    const first = safeString(userRecord.FirstName || userRecord.firstName || userRecord.GivenName || userRecord.givenName);
    const last = safeString(userRecord.LastName || userRecord.lastName || userRecord.Surname || userRecord.surname);
    const combined = [first, last].filter(Boolean).join(' ');
    if (combined) {
      return combined;
    }

    return safeString(userRecord.UserName || userRecord.userName || userRecord.username || userRecord.Email || userRecord.email);
  }

  function resolvePrimaryRole(userRecord, detailRecord) {
    const roleList = normalizeList(userRecord.roleNames || userRecord.RoleNames || (detailRecord && detailRecord.roleNames));
    if (roleList.length) return roleList[0];
    return safeString(userRecord.PrimaryRole || userRecord.primaryRole || userRecord.Role || userRecord.role || (detailRecord ? detailRecord.PrimaryRole || detailRecord.Role : ''));
  }

  function isLikelyManager(summary = state.managerSummary) {
    const roles = normalizeList(
      (state.user && (state.user.roleNames || state.user.RoleNames)) ||
      (summary && summary.roles) ||
      (state.detail && state.detail.roleNames)
    );
    const roleMatch = roles.some(role => /manager|lead|supervisor|director|executive/i.test(role));
    const permissions = state.permissions || {};
    const permissionLevel = safeString(permissions.permissionLevel);
    const permissionMatch = /manager|lead|supervisor/i.test(permissionLevel.toLowerCase ? permissionLevel.toLowerCase() : permissionLevel);
    const canManageUsers = permissions && (permissions.canManageUsers === true || String(permissions.canManageUsers).toLowerCase() === 'true');
    if (roleMatch || permissionMatch || canManageUsers) return true;
    if (summary && summary.users && summary.users.length) return true;
    return false;
  }

  function updateGlobalBannerFromProfile(summary) {
    if (typeof initializeGlobalBanner !== 'function') {
      return;
    }

    summary = summary || {};

    const name = summary.name || 'My Profile';
    const primaryRole = summary.primaryRole || 'Team Member';
    const campaign = summary.campaign || '';
    const status = summary.status || '';
    const startDate = summary.startDate || '';
    const tenure = summary.tenure || '';
    const profileSlug = summary.profileSlug || summary.profileId || '';
    const username = safeString(summary.username);
    const location = summary.location || '';
    const manager = summary.manager || '';
    const email = summary.email || '';
    const phone = summary.phone || '';

    const headline = document.createElement('div');
    headline.className = 'profile-banner__headline';

    const avatar = document.createElement('div');
    avatar.className = 'profile-banner__avatar';
    avatar.textContent = safeString(name).charAt(0).toUpperCase() || 'U';
    headline.appendChild(avatar);

    const textWrap = document.createElement('div');
    textWrap.className = 'profile-banner__text';

    const nameEl = document.createElement('div');
    nameEl.className = 'profile-banner__name';
    nameEl.textContent = name;
    textWrap.appendChild(nameEl);

    if (primaryRole) {
      const roleEl = document.createElement('div');
      roleEl.className = 'profile-banner__role';
      const icon = document.createElement('i');
      icon.className = 'fa-solid fa-shield-halved';
      roleEl.appendChild(icon);
      const roleText = document.createElement('span');
      roleText.textContent = primaryRole;
      roleEl.appendChild(roleText);
      textWrap.appendChild(roleEl);
    }

    if (username) {
      const usernameEl = document.createElement('div');
      usernameEl.className = 'profile-banner__username';
      usernameEl.textContent = username.indexOf('@') === -1 ? `@${username}` : username;
      textWrap.appendChild(usernameEl);
    }

    headline.appendChild(textWrap);

    const chipsRow = document.createElement('div');
    chipsRow.className = 'profile-banner__chips';

    const appendChip = (icon, label) => {
      if (!label) {
        return;
      }
      const chip = document.createElement('span');
      chip.className = 'profile-banner__chip';
      if (icon) {
        const iconEl = document.createElement('i');
        iconEl.className = icon;
        chip.appendChild(iconEl);
      }
      const text = document.createElement('span');
      text.textContent = label;
      chip.appendChild(text);
      chipsRow.appendChild(chip);
    };

    appendChip('fa-solid fa-circle-check', status);
    appendChip('fa-solid fa-calendar-day', startDate ? `Joined ${startDate}` : '');
    appendChip('fa-solid fa-hourglass-half', tenure);
    appendChip('fa-solid fa-diagram-project', campaign);

    const metaRow = document.createElement('div');
    metaRow.className = 'profile-banner__meta-row';

    const appendMeta = (icon, label, value, options = {}) => {
      const textValue = safeString(value);
      if (!textValue) {
        return;
      }
      const item = document.createElement('div');
      item.className = 'profile-banner__meta-item';

      const labelEl = document.createElement('div');
      labelEl.className = 'profile-banner__meta-label';
      if (icon) {
        const iconEl = document.createElement('i');
        iconEl.className = icon;
        labelEl.appendChild(iconEl);
      }
      const labelText = document.createElement('span');
      labelText.textContent = label;
      labelEl.appendChild(labelText);
      item.appendChild(labelEl);

      const valueEl = document.createElement('div');
      valueEl.className = 'profile-banner__meta-value';
      if (options.code) {
        valueEl.classList.add('profile-banner__meta-value--code');
      }
      valueEl.textContent = textValue;
      item.appendChild(valueEl);

      metaRow.appendChild(item);
    };

    appendMeta('fa-solid fa-id-badge', 'Profile Slug', profileSlug, { code: true });
    appendMeta('fa-solid fa-user-tie', 'Manager', manager);
    appendMeta('fa-solid fa-location-dot', 'Location', location);

    const contactsRow = document.createElement('div');
    contactsRow.className = 'profile-banner__contacts';

    const appendContact = (icon, label, value, href) => {
      const textValue = safeString(value);
      if (!textValue) {
        return;
      }
      const contact = document.createElement('div');
      contact.className = 'profile-banner__contact';
      if (icon) {
        const iconEl = document.createElement('i');
        iconEl.className = icon;
        contact.appendChild(iconEl);
      }
      const content = document.createElement(href ? 'a' : 'span');
      if (href) {
        content.href = href;
        content.target = '_top';
        content.rel = 'noopener';
      }
      content.textContent = textValue;
      if (label) {
        content.setAttribute('aria-label', `${label}: ${textValue}`);
      }
      contact.appendChild(content);
      contactsRow.appendChild(contact);
    };

    appendContact('fa-solid fa-envelope', 'Email', email, email ? `mailto:${email}` : '');
    if (phone) {
      const tel = phone.replace(/[^0-9+]/g, '');
      appendContact('fa-solid fa-phone', 'Phone', phone, tel ? `tel:${tel}` : '');
    }

    const descriptionElements = [];
    const bannerBlock = document.createElement('div');
    bannerBlock.className = 'lumina-banner__rich-block';
    if (chipsRow.childNodes.length) bannerBlock.appendChild(chipsRow);
    if (metaRow.childNodes.length) bannerBlock.appendChild(metaRow);
    if (contactsRow.childNodes.length) bannerBlock.appendChild(contactsRow);
    if (bannerBlock.childNodes.length) {
      descriptionElements.push(bannerBlock);
    }

    const actions = [];
    const addAction = (href, label, icon, variant) => {
      const safeHref = safeString(href);
      const safeLabel = safeString(label);
      if (!safeHref || !safeLabel) {
        return;
      }
      actions.push({
        href: safeHref,
        label: safeLabel,
        icon,
        variant: variant || 'primary',
        target: '_top',
        rel: 'noopener'
      });
    };

    try {
      addAction(buildPageLink('agent-experience'), 'Agent Experience', 'fa-solid fa-user-gear', 'primary');
      addAction(buildPageLink('agentschedule'), 'View Schedule', 'fa-solid fa-calendar-days', 'secondary');
    } catch (err) {
      console.warn('Unable to build banner actions', err);
    }

    initializeGlobalBanner({
      eyebrow: 'Profile Overview',
      titleFragments: [headline],
      description: '',
      descriptionElements,
      campaignName: campaign,
      actions
    });
  }

  function hydrateProfileSummary(userRecord, detailRecord) {
    const record = detailRecord && detailRecord.record ? detailRecord.record : detailRecord || {};
    const name = resolveDisplayName(userRecord) || resolveDisplayName(record) || 'Your profile';
    const primaryRole = resolvePrimaryRole(userRecord, record) || 'Team Member';
    const campaign = safeString(userRecord.campaignName || userRecord.CampaignName || record.CampaignName || record.campaignName || state.campaignId);
    const status = safeString(record.EmploymentStatus || record.Status || userRecord.Status || userRecord.status);
    const startDateRaw = record.StartDate || record.HireDate || record.DateHired || record.OnboardDate || record.CreatedAt || record.createdAt;
    const startDate = formatDate(startDateRaw);
    const tenure = formatTenure(startDateRaw);
    const username = safeString(
      getField(userRecord, ['UserName', 'userName', 'username']) ||
      getField(record, ['UserName', 'userName', 'username'])
    );
    const manager = safeString(
      getField(record, ['Manager', 'manager', 'ManagerName', 'managerName', 'Supervisor', 'supervisor'])
    );
    const location = safeString(
      getField(record, ['Location', 'location', 'City', 'city', 'Country', 'country']) ||
      getField(userRecord, ['Location', 'location', 'City', 'city', 'Country', 'country'])
    );
    const email = safeString(
      getField(record, ['WorkEmail', 'Email', 'email']) ||
      getField(userRecord, ['WorkEmail', 'Email', 'email'])
    );
    const phone = safeString(
      getField(record, ['Phone', 'phone', 'Mobile', 'mobile', 'WorkPhone', 'workPhone']) ||
      getField(userRecord, ['Phone', 'phone', 'Mobile', 'mobile'])
    );

    const computedProfileIdentifier = resolveProfileIdentifier(userRecord, detailRecord);
    if (computedProfileIdentifier && computedProfileIdentifier !== state.profileIdentifier) {
      state.profileIdentifier = computedProfileIdentifier;
    }

    const computedProfileSlug = computeProfileSlug(userRecord, detailRecord);
    if (computedProfileSlug && computedProfileSlug !== state.profileSlug) {
      state.profileSlug = computedProfileSlug;
    }
    ensureProfileSlugInUrl(state.profileSlug);

    const sidebarPanel = document.getElementById('userPanel');
    if (sidebarPanel) {
      if (state.profileSlug) {
        sidebarPanel.setAttribute('data-profile-slug', state.profileSlug);
        sidebarPanel.setAttribute('data-profile-id', state.profileSlug);
      }
      if (state.profileIdentifier) {
        sidebarPanel.setAttribute('data-profile-identifier', state.profileIdentifier);
      }
    }

    const summary = {
      name,
      primaryRole,
      campaign,
      status,
      startDate,
      tenure,
      username,
      profileSlug: state.profileSlug,
      profileId: state.profileSlug,
      profileIdentifier: state.profileIdentifier,
      manager,
      location,
      email,
      phone
    };

    state.profileSummary = summary;

    updateGlobalBannerFromProfile(summary);
    renderProfileHero(summary);
    renderProfileEssentials(summary);
  }

  function refreshSections() {
    const detailRecord = state.detail && state.detail.record ? state.detail.record : state.detail || {};
    const combinedRecord = Object.assign({}, state.user, detailRecord);

    hydrateProfileSummary(state.user, state.detail);

    renderInfoGrid('personalDetails', [
      { label: 'Full Name', keys: ['FullName', 'fullName', 'DisplayName', 'displayName'] },
      { label: 'Preferred Name', keys: ['PreferredName', 'preferredName'] },
      { label: 'Work Email', keys: ['Email', 'email'], isLink: true },
      { label: 'Phone', keys: ['Phone', 'phone', 'Mobile', 'mobile'] },
      { label: 'Username', keys: ['UserName', 'userName', 'username', 'Email'] },
      { label: 'Location', keys: ['Location', 'location', 'City', 'city', 'Country', 'country'] }
    ], combinedRecord);

    renderInfoGrid('employmentDetails', [
      { label: 'Employee ID', keys: ['EmployeeID', 'employeeId', 'ID', 'id'] },
      { label: 'Department', keys: ['Department', 'department', 'Team', 'team'] },
      { label: 'Campaign', keys: ['CampaignName', 'campaignName', 'CampaignID', 'campaignId'] },
      { label: 'Manager', keys: ['Manager', 'manager', 'ManagerName', 'managerName', 'Supervisor', 'supervisor'] },
      { label: 'Employment Status', keys: ['EmploymentStatus', 'Status', 'status'] },
      {
        label: 'Start Date',
        keys: ['StartDate', 'HireDate', 'DateHired', 'OnboardDate'],
        transform: (value) => formatDate(value)
      },
      {
        label: 'Tenure',
        keys: ['StartDate', 'HireDate', 'DateHired', 'AnniversaryDate'],
        transform: (value) => formatTenure(value)
      }
    ], combinedRecord);

    const roles = normalizeList(state.user.roleNames || combinedRecord.roleNames || combinedRecord.RoleNames || combinedRecord.Roles || combinedRecord.Role);
    renderChips('roleChips', roles, 'fa-solid fa-badge-check');

    renderChips('pageChips', state.pages, 'fa-solid fa-layer-group');

    renderInfoGrid('accessDetails', [
      { label: 'Permission Level', keys: ['permissionLevel'], transform: (value, record) => {
        const source = state.permissions || record.permissions || {};
        const level = source.permissionLevel || value;
        return level ? level.toString().replace(/_/g, ' ').toUpperCase() : '';
      } },
      { label: 'Manage Users', keys: ['canManageUsers'], transform: () => formatBoolean(state.permissions && state.permissions.canManageUsers) },
      { label: 'Manage Pages', keys: ['canManagePages'], transform: () => formatBoolean(state.permissions && state.permissions.canManagePages) },
      {
        label: 'Assigned Campaign',
        keys: ['CampaignName', 'campaignName', 'CampaignID', 'campaignId'],
        transform: (value, record, userData) => {
          const name = safeString(record && (record.CampaignName || record.campaignName)) ||
            safeString(userData && (userData.CampaignName || userData.campaignName));
          const id = safeString(record && (record.CampaignID || record.campaignId)) || safeString(state.campaignId);
          return name || id;
        }
      }
    ], Object.assign({}, state.user, detailRecord, { permissions: state.permissions }));

    renderInfoGrid('securityDetails', [
      { label: 'Email Confirmed', keys: ['EmailConfirmed', 'emailConfirmed'], transform: (value) => formatBoolean(value) },
      { label: 'MFA Enabled', keys: ['MFAEnabled', 'mfaEnabled'], transform: (value) => formatBoolean(value) },
      { label: 'Last Login', keys: ['LastLoginAt', 'LastLogin', 'lastLoginAt', 'lastLogin'], transform: (value) => formatDate(value) },
      { label: 'Last Activity', keys: ['LastActivityAt', 'lastActivityAt'], transform: (value) => formatDate(value) },
      { label: 'Password Reset Required', keys: ['ResetRequired', 'resetRequired'], transform: (value) => formatBoolean(value, { positive: 'Required', negative: 'Not Required' }) }
    ], combinedRecord);

    renderEquipment(state.equipment);
    renderManagerSummary(state.managerSummary);
  }

  function fetchUserDetail() {
    const userId = safeString(state.user && state.user.ID);
    if (!userId || (typeof google === 'undefined' || !google.script || !google.script.run)) {
      refreshSections();
      return;
    }

    google.script.run
      .withFailureHandler(err => {
        console.warn('Failed to load user detail', err);
        refreshSections();
      })
      .withSuccessHandler(detail => {
        state.detail = detail || state.detail;
        refreshSections();
      })
      .clientGetUserDetail(userId, { requestingUserId: userId });
  }

  function fetchUserPages() {
    const userId = safeString(state.user && state.user.ID);
    if (!userId || (typeof google === 'undefined' || !google.script || !google.script.run)) {
      refreshSections();
      return;
    }

    google.script.run
      .withFailureHandler(err => {
        console.warn('Failed to load user pages', err);
      })
      .withSuccessHandler(pages => {
        if (Array.isArray(pages)) {
          state.pages = pages;
          refreshSections();
        }
      })
      .clientGetUserPages(userId);
  }

  function fetchUserEquipment() {
    const userId = safeString(state.user && state.user.ID);
    const loader = document.getElementById('equipmentLoader');
    if (loader) loader.classList.add('show');
    if (!userId || (typeof google === 'undefined' || !google.script || !google.script.run)) {
      if (loader) loader.classList.remove('show');
      refreshSections();
      return;
    }

    state.loadingEquipment = true;
    google.script.run
      .withFailureHandler(err => {
        console.warn('Failed to load equipment', err);
        state.loadingEquipment = false;
        if (loader) loader.classList.remove('show');
        renderEquipment(state.equipment);
      })
      .withSuccessHandler(result => {
        state.loadingEquipment = false;
        if (loader) loader.classList.remove('show');
        if (result && result.success && Array.isArray(result.items)) {
          state.equipment = result.items;
          renderEquipment(state.equipment);
        } else {
          renderEquipment(state.equipment);
        }
      })
      .clientGetUserEquipment(userId);
  }

  function fetchManagerSummary(force = false) {
    const userId = safeString(state.user && state.user.ID);
    if (!userId || (typeof google === 'undefined' || !google.script || !google.script.run)) {
      renderManagerSummary(state.managerSummary);
      return;
    }

    if (!force && !isLikelyManager() && (!state.managerSummary || !state.managerSummary.users || !state.managerSummary.users.length)) {
      renderManagerSummary(state.managerSummary);
      return;
    }

    state.loadingManagerSummary = true;
    renderManagerSummary(state.managerSummary);

    google.script.run
      .withFailureHandler(err => {
        console.warn('Failed to load manager summary', err);
        state.loadingManagerSummary = false;
        state.managerSummary = { success: false, error: 'Unable to load team summary right now.' };
        renderManagerSummary(state.managerSummary);
      })
      .withSuccessHandler(result => {
        state.loadingManagerSummary = false;
        if (result && result.success) {
          state.managerSummary = result;
          state.managerPagination.page = 1;
        } else if (result) {
          state.managerSummary = Object.assign({ success: false }, result);
          state.managerPagination.page = 1;
        } else {
          state.managerSummary = { success: false, error: 'Unable to load team summary right now.' };
          state.managerPagination.page = 1;
        }
        renderManagerSummary(state.managerSummary);
      })
      .clientGetManagerTeamSummary(userId);
  }

  function fetchPermissions() {
    const userId = safeString(state.user && state.user.ID);
    const campaignId = safeString(state.campaignId);
    if (!userId || !campaignId || (typeof google === 'undefined' || !google.script || !google.script.run)) {
      refreshSections();
      return;
    }

    google.script.run
      .withFailureHandler(err => {
        console.warn('Failed to load permissions', err);
      })
      .withSuccessHandler(perms => {
        if (perms && typeof perms === 'object') {
          state.permissions = perms;
          refreshSections();
          if (!state.loadingManagerSummary && isLikelyManager() && (!state.managerSummary || state.managerSummary.success === false)) {
            fetchManagerSummary(true);
          }
        }
      })
      .clientGetUserPermissions(userId, campaignId);
  }

  document.addEventListener('DOMContentLoaded', () => {
    setupCollapsibleCards();
    const paginationEl = document.getElementById('managerSummaryPagination');
    if (paginationEl) {
      paginationEl.addEventListener('click', handleManagerPaginationClick);
    }

    refreshSections();
    fetchUserDetail();
    fetchUserPages();
    fetchUserEquipment();
    fetchManagerSummary();
    fetchPermissions();
  });
</script>
