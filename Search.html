<!-- Enhanced Search.html with Proxy Integration -->
<?!= include('layout', {rawToken: rawToken, baseUrl: baseUrl, user: user, currentPage: currentPage }) ?>

<!-- Google Font -->
<link
  href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap"
  rel="stylesheet"
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>

<style>
  /* â”€â”€ Logo â”€â”€ */
  .logo2 {
    font-size: 2.5rem;
    font-weight: 500;
    margin-bottom: 1.5rem;
  }
  .logo2 .c1 { color: #4a90e2; }
  .logo2 .c2 { color: #7b61ff; }
  .logo2 .c3 { color: #50e3c2; }
  .logo2 .c4 { color: #f5a623; }
  .logo2 .c5 { color: #d0021b; }
  .logo2 .c6 { color: #bd10e0; }

  /* â”€â”€ Main Layout â”€â”€ */
  .search-container {
    display: flex;
    max-width: 1400px;
    margin: 0 auto;
    gap: 1rem;
    height: calc(100vh - 100px);
  }

  .sidebar {
    width: 300px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: .5rem;
    height: 100%;
    overflow-y: auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    flex-shrink: 0;
  }

  .main-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  /* â”€â”€ Tab Bar â”€â”€ */
  #tabBar {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0 0 1rem 0;
    border-bottom: 2px solid #e0e6ed;
    overflow-x: auto;
    background: white;
    border-radius: 8px 8px 0 0;
    flex-shrink: 0;
  }

  #tabBar li {
    margin-right: 0.5rem;
    padding: 0.6rem 1rem;
    background: #f7f9fc;
    border: 1px solid #e0e6ed;
    border-bottom: none;
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
    position: relative;
    font-weight: 500;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex-shrink: 0;
  }

  #tabBar li:hover {
    background: #eef2f7;
  }

  #tabBar li.active {
    background: #fff;
    color: #4a90e2;
    border-color: #d0d7de;
  }

  #tabBar li .close {
    position: absolute;
    top: 4px; right: 6px;
    font-size: 0.8rem;
    color: #888;
    cursor: pointer;
    z-index: 10;
  }

  #tabBar li .close:hover {
    color: #333;
  }

  /* â”€â”€ Search Area â”€â”€ */
  #searchArea {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
    flex-shrink: 0;
  }

  #searchArea input[type="text"] {
    width: 100%;
    max-width: 500px;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    border: 1px solid #c0c6cc;
    border-radius: 4px;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    transition: border-color 0.2s;
  }

  #searchArea input[type="text"]:focus {
    outline: none;
    border-color: #4a90e2;
  }

  #searchArea button {
    margin-left: 0.5rem;
    padding: 0.8rem 1.2rem;
    font-size: 1rem;
    background: #4a90e2;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
  }

  #searchArea button:hover {
    background: #357ABD;
  }

  /* â”€â”€ Results Container â”€â”€ */
  .results-scroll-container {
    flex: 1;
    overflow-y: auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  ul.results {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  ul.results li {
    background: #fdfdfd;
    border-bottom: 1px solid #e6ebf1;
    padding: 1.2rem;
    transition: background 0.2s;
    position: relative;
  }

  ul.results li:hover {
    background: #f8f9fa;
  }

  ul.results li:last-child {
    border-bottom: none;
  }

  ul.results .result-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }

  ul.results a {
    font-size: 1.1rem;
    color: #4a90e2;
    text-decoration: none;
    font-weight: 500;
  }

  ul.results a:hover {
    text-decoration: underline;
  }

  ul.results .result-actions {
    display: flex;
    gap: 0.5rem;
  }

  ul.results .result-actions button {
    padding: 0.3rem 0.6rem;
    font-size: 0.8rem;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  ul.results .result-actions button:hover {
    background: #f0f4f8;
  }

  ul.results .result-actions .bookmark-btn.bookmarked {
    background: #4a90e2;
    color: white;
    border-color: #4a90e2;
  }

  ul.results .snippet {
    font-size: 0.9rem;
    color: #666;
    margin-top: 0.4rem;
    line-height: 1.4;
  }

  ul.results .result-url {
    font-size: 0.8rem;
    color: #999;
    margin-top: 0.3rem;
  }

  /* â”€â”€ Pagination â”€â”€ */
  nav.pagination {
    text-align: center;
    padding: 1.5rem;
    background: white;
    border-top: 1px solid #e0e6ed;
    flex-shrink: 0;
  }

  nav.pagination button {
    margin: 0 0.5rem;
    padding: 0.5rem 1rem;
    background: #fff;
    border: 1px solid #c0c6cc;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
  }

  nav.pagination button:hover:not([disabled]) {
    background: #f0f4f8;
  }

  nav.pagination span {
    font-weight: 500;
    margin: 0 1rem;
  }

  nav.pagination button[disabled] {
    color: #aaa;
    cursor: default;
    background: #fafbfc;
  }

  /* â”€â”€ Browser Container â”€â”€ */
  #browser {
    flex: 1;
    background: white;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    display: none;
    overflow: hidden;
    position: relative;
  }

  #browser iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: none;
  }

  /* â”€â”€ Loading Indicator â”€â”€ */
  .loading-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #666;
    display: none;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #4a90e2;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* â”€â”€ Error Display â”€â”€ */
  .error-display {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #e74a3b;
    background: #fff;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: none;
    max-width: 400px;
  }

  /* â”€â”€ Bookmark Sidebar â”€â”€ */
  .sidebar h3 {
    margin: 0 0 1rem 0;
    color: #333;
    font-size: 1.1rem;
    border-bottom: 2px solid #4a90e2;
    padding-bottom: 0.5rem;
  }

  .bookmark-section {
    margin-bottom: 1.5rem;
  }

  .bookmark-folder {
    margin-bottom: 1rem;
  }

  .bookmark-folder h4 {
    margin: 0 0 0.5rem 0;
    color: #555;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    cursor: pointer;
  }

  .bookmark-folder h4 i {
    margin-right: 0.5rem;
    transition: transform 0.2s;
  }

  .bookmark-folder.collapsed h4 i {
    transform: rotate(-90deg);
  }

  .bookmark-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .bookmark-item {
    padding: 0.4rem 0.6rem;
    margin-bottom: 0.3rem;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .bookmark-item:hover {
    background: #e8f3ff;
  }

  .bookmark-item .bookmark-title {
    font-size: 0.8rem;
    color: #333;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }

  .bookmark-item .bookmark-actions {
    display: flex;
    gap: 0.3rem;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .bookmark-item:hover .bookmark-actions {
    opacity: 1;
  }

  .bookmark-item .bookmark-actions button {
    padding: 0.2rem;
    font-size: 0.7rem;
    border: none;
    background: none;
    cursor: pointer;
    color: #666;
  }

  .bookmark-item .bookmark-actions button:hover {
    color: #333;
  }

  .search-bookmarks {
    width: 100%;
    padding: 0.5rem;
    margin-bottom: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
  }

  .recent-bookmarks {
    max-height: 200px;
    overflow-y: auto;
  }

  /* â”€â”€ Add Bookmark Modal â”€â”€ */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }

  .modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 2rem;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .modal-header h2 {
    margin: 0;
    color: #333;
  }

  .close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }

  .close:hover {
    color: #333;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.3rem;
    font-weight: 500;
    color: #333;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
  }

  .form-group textarea {
    resize: vertical;
    height: 60px;
  }

  .modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
  }

  .modal-actions button {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .btn-primary {
    background: #4a90e2;
    color: white;
  }

  .btn-secondary {
    background: #ddd;
    color: #333;
  }

  .btn-primary:hover {
    background: #357ABD;
  }

  .btn-secondary:hover {
    background: #ccc;
  }

  /* Responsive design */
  @media (max-width: 1024px) {
    .search-container {
      flex-direction: column;
      height: auto;
    }
    
    .sidebar {
      width: 100%;
      height: auto;
      margin-bottom: 1rem;
    }
    
    .main-content {
      height: 70vh;
    }
  }
</style>

<div class="logo2" style="text-align:center;">
  <span class="c1">S</span><span class="c2">E</span><span class="c3">A</span>
  <span class="c4">R</span><span class="c5">C</span><span class="c6">H</span>
</div>

  <!-- Sidebar with bookmarks -->
  <div class="sidebar">
    <h3><i class="fas fa-bookmark"></i> Bookmarks</h3>
    
    <input type="text" class="search-bookmarks" placeholder="Search bookmarks..." 
           id="bookmarkSearch" onkeyup="filterBookmarks()">
    
    <div class="bookmark-section">
      <div class="bookmark-folder">
        <h4 onclick="toggleFolder('recent')">
          <i class="fas fa-chevron-down"></i> Recent
        </h4>
        <ul class="bookmark-list recent-bookmarks" id="recentBookmarks">
          <!-- Recent bookmarks will be loaded here -->
        </ul>
      </div>
      
      <div class="bookmark-folder">
        <h4 onclick="toggleFolder('folders')">
          <i class="fas fa-chevron-down"></i> All Folders
        </h4>
        <div id="bookmarkFolders">
          <!-- Bookmark folders will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Main content area -->
  <div class="main-content">
    <!-- TAB BAR -->
    <ul id="tabBar">
      <li id="searchTab" class="active" onclick="activateSearchTab()">
        <i class="fas fa-search"></i> Search
      </li>
      <li id="newTabBtn" onclick="activateSearchTab()" title="New search">
        <i class="fas fa-plus"></i>
      </li>
    </ul>

    <!-- SEARCH AREA -->
    <div id="searchArea">
      <form id="searchForm" onsubmit="doSearch(event,this)" style="text-align:center;">
        <input
          type="text"
          id="searchInput"
          placeholder="Enter search term or URL"
          value="<?= query ?>"
          required
        />
        <button type="submit">
          <i class="fas fa-search"></i> Search
        </button>
      </form>

      <? if (error) { ?>
        <div style="color:#e74a3b; text-align:center; margin:1rem 0;">
          Error: <?= error ?>
        </div>
      <? } ?>

      <? if (query) { ?>
        <div style="margin-top: 1.5rem;">
          <div style="margin-bottom: 1rem; color: #666;">
            <strong><?= totalResults ?></strong> results for <strong>"<?= query ?>"</strong>
          </div>
        </div>
      <? } ?>
    </div>

    <!-- RESULTS OR BROWSER -->
    <? if (query) { ?>
      <div class="results-scroll-container">
        <ul class="results">
          <?!= results.map(r => `
            <li data-url="${r.link}" data-title="${r.htmlTitle.replace(/"/g, '&quot;')}">
              <div class="result-header">
                <a href="#" onclick="openResultTab('${r.link}','${r.htmlTitle.replace(/'/g,"\\'")}'); return false;">
                  ${r.htmlTitle}
                </a>
                <div class="result-actions">
                  <button class="bookmark-btn" onclick="toggleBookmark('${r.link}', '${r.htmlTitle.replace(/'/g,"\\'")}', this)" title="Bookmark this page">
                    <i class="far fa-bookmark"></i>
                  </button>
                  <button onclick="openResultTab('${r.link}','${r.htmlTitle.replace(/'/g,"\\'")}')">
                    <i class="fas fa-external-link-alt"></i> Open
                  </button>
                </div>
              </div>
              <div class="snippet">${r.htmlSnippet}</div>
              <div class="result-url">${r.displayLink}</div>
            </li>
          `).join('') ?>
        </ul>

        <!-- pagination -->
        <? 
          const totalPages = Math.ceil(totalResults / 10);
          const prevPage = pageIndex > 1 ? pageIndex - 1 : null;
          const nextPage = pageIndex < totalPages ? pageIndex + 1 : null;
        ?>
        <nav class="pagination" aria-label="Search pagination">
          <button <?= prevPage ? '' : 'disabled' ?>
                  onclick="navigate(<?= prevPage || 1 ?>)">
            <i class="fas fa-chevron-left"></i> Prev
          </button>
          <span>Page <?= pageIndex ?> of <?= totalPages ?></span>
          <button <?= nextPage ? '' : 'disabled' ?>
                  onclick="navigate(<?= nextPage || totalPages ?>)">
            Next <i class="fas fa-chevron-right"></i>
          </button>
        </nav>
      </div>
    <? } else { ?>
      <!-- BROWSER AREA -->
      <div id="browser">
        <div class="loading-indicator" id="loadingIndicator">
          <div class="loading-spinner"></div>
          <div>Loading page...</div>
        </div>
        <div class="error-display" id="errorDisplay">
          <h3>ðŸš« Page Load Error</h3>
          <p id="errorMessage">Unable to load this page.</p>
          <button onclick="retryCurrentTab()" class="btn-primary">Retry</button>
        </div>
      </div>
    <? } ?>
  </div>
</div>

<!-- Add Bookmark Modal -->
<div id="bookmarkModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add Bookmark</h2>
      <span class="close" onclick="closeBookmarkModal()">&times;</span>
    </div>
    <form id="bookmarkForm" onsubmit="saveBookmark(event)">
      <div class="form-group">
        <label for="bookmarkTitle">Title</label>
        <input type="text" id="bookmarkTitle" required>
      </div>
      <div class="form-group">
        <label for="bookmarkUrl">URL</label>
        <input type="url" id="bookmarkUrl" required readonly>
      </div>
      <div class="form-group">
        <label for="bookmarkDescription">Description</label>
        <textarea id="bookmarkDescription"></textarea>
      </div>
      <div class="form-group">
        <label for="bookmarkTags">Tags (comma separated)</label>
        <input type="text" id="bookmarkTags" placeholder="work, reference, tutorial">
      </div>
      <div class="form-group">
        <label for="bookmarkFolder">Folder</label>
        <select id="bookmarkFolder">
          <option value="General">General</option>
          <option value="Work">Work</option>
          <option value="Reference">Reference</option>
          <option value="Tools">Tools</option>
        </select>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" onclick="closeBookmarkModal()">Cancel</button>
        <button type="submit" class="btn-primary">Save Bookmark</button>
      </div>
    </form>
  </div>
</div>

<script>
  const scriptUrl = '<?= scriptUrl ?>';
  const baseUrl = '<?= baseUrl ?>';

  let tabCounter = 0;
  const tabs = {};
  let userBookmarks = [];
  let bookmarkFolders = [];

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    loadUserBookmarks();
    updateBookmarkButtons();
    setupMessageListener();
  });

  // Setup message listener for tab communication
  function setupMessageListener() {
    window.addEventListener('message', function(event) {
      if (event.data && event.data.action === 'closeTab') {
        const activeTab = Object.keys(tabs).find(id => 
          tabs[id].btnElem.classList.contains('active')
        );
        if (activeTab) {
          closeTab(activeTab, { stopPropagation: () => {} });
        }
      }
    });
  }

  // â”€â”€ Enhanced Tab Management â”€â”€
  function activateSearchTab() {
    document.querySelectorAll('#tabBar li').forEach(li => {
      li.classList.toggle('active', li.id === 'searchTab');
    });
    document.getElementById('searchArea').style.display = '';
    document.querySelector('.results-scroll-container')?.style.setProperty('display', 'flex');
    document.getElementById('browser').style.display = 'none';
    hideLoadingIndicator();
    hideErrorDisplay();
  }

  function openResultTab(url, title) {
    // Update bookmark access if this URL is bookmarked
    const bookmark = userBookmarks.find(b => b.URL === url);
    if (bookmark) {
      google.script.run.clientUpdateBookmarkAccess(bookmark.ID);
    }
    
    openTab(url, title);
  }

  function openTab(url, title) {
    tabCounter++;
    const tabId = 'tab' + tabCounter;

    // Create the tab button
    const li = document.createElement('li');
    li.id = tabId + '_btn';
    li.innerHTML = `
      <span title="${title}">${title.length > 20 ? title.substring(0, 20) + '...' : title}</span>
      <span class="close" onclick="closeTab('${tabId}', event)">Ã—</span>
    `;
    li.onclick = (e) => {
      if (!e.target.classList.contains('close')) {
        switchTab(tabId);
      }
    };
    
    // Insert before the "+" button
    const newTabBtn = document.getElementById('newTabBtn');
    newTabBtn.parentNode.insertBefore(li, newTabBtn);

    // Create the iframe with enhanced proxy URL
    const iframe = document.createElement('iframe');
    iframe.src = scriptUrl + '?page=proxy&url=' + encodeURIComponent(url);
    iframe.id = tabId + '_frame';
    iframe.onload = () => hideLoadingIndicator();
    iframe.onerror = () => showErrorDisplay('Failed to load page');

    document.getElementById('browser').appendChild(iframe);
    tabs[tabId] = { 
      btnElem: li, 
      frameElem: iframe, 
      url: url, 
      title: title 
    };
    
    switchTab(tabId);
  }

  function switchTab(tabId) {
    showLoadingIndicator();
    hideErrorDisplay();
    
    Object.keys(tabs).forEach(id => {
      const { btnElem, frameElem } = tabs[id];
      btnElem.classList.toggle('active', id === tabId);
      frameElem.style.display = id === tabId ? '' : 'none';
    });
    
    // Update search tab state
    document.getElementById('searchTab').classList.remove('active');
    document.getElementById('searchArea').style.display = 'none';
    const resultsContainer = document.querySelector('.results-scroll-container');
    if (resultsContainer) resultsContainer.style.display = 'none';
    document.getElementById('browser').style.display = 'flex';
    
    // Check if iframe is already loaded
    const activeFrame = tabs[tabId].frameElem;
    if (activeFrame.contentDocument && activeFrame.contentDocument.readyState === 'complete') {
      hideLoadingIndicator();
    }
  }

  function closeTab(tabId, evt) {
    evt.stopPropagation();
    const { btnElem, frameElem } = tabs[tabId];
    btnElem.remove();
    frameElem.remove();
    delete tabs[tabId];
    
    // If this was the active tab, switch to search
    if (btnElem.classList.contains('active')) {
      activateSearchTab();
    }
  }

  function retryCurrentTab() {
    const activeTab = Object.keys(tabs).find(id => 
      tabs[id].btnElem.classList.contains('active')
    );
    if (activeTab) {
      const tab = tabs[activeTab];
      showLoadingIndicator();
      hideErrorDisplay();
      tab.frameElem.src = tab.frameElem.src; // Reload iframe
    }
  }

  // â”€â”€ Loading and Error Management â”€â”€
  function showLoadingIndicator() {
    document.getElementById('loadingIndicator').style.display = 'block';
  }

  function hideLoadingIndicator() {
    document.getElementById('loadingIndicator').style.display = 'none';
  }

  function showErrorDisplay(message) {
    hideLoadingIndicator();
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorDisplay').style.display = 'block';
  }

  function hideErrorDisplay() {
    document.getElementById('errorDisplay').style.display = 'none';
  }

  // â”€â”€ Search Functions â”€â”€
  function doSearch(evt, form) {
    evt.preventDefault();
    const query = form.querySelector('input').value.trim();
    if (!query) return;
    
    // Check if it's a direct URL
    if (isValidUrl(query)) {
      openTab(query, getDomainFromUrl(query));
    } else {
      window.location.href = `${baseUrl}&page=search&query=${encodeURIComponent(query)}`;
    }
  }

  function navigate(page) {
    const q = '<?= query ?>';
    window.location.href = `${baseUrl}&page=search&query=${encodeURIComponent(q)}&pageIndex=${page}`;
  }

  function isValidUrl(string) {
    try {
      new URL(string);
      return true;
    } catch (_) {
      try {
        new URL('http://' + string);
        return string.includes('.');
      } catch (_) {
        return false;
      }
    }
  }

  function getDomainFromUrl(url) {
    try {
      return new URL(url).hostname;
    } catch (_) {
      return url;
    }
  }

  // â”€â”€ Bookmark Management â”€â”€
  function loadUserBookmarks() {
    google.script.run
      .withSuccessHandler(onBookmarksLoaded)
      .withFailureHandler(onBookmarksError)
      .clientGetUserBookmarks();
  }

  function onBookmarksLoaded(bookmarks) {
    userBookmarks = bookmarks;
    loadBookmarkFolders();
    displayRecentBookmarks();
    displayBookmarkFolders();
    updateBookmarkButtons();
  }

  function onBookmarksError(error) {
    console.error('Error loading bookmarks:', error);
  }

  function loadBookmarkFolders() {
    google.script.run
      .withSuccessHandler(onFoldersLoaded)
      .clientGetUserBookmarkFolders();
  }

  function onFoldersLoaded(folders) {
    bookmarkFolders = folders;
    updateFolderSelect();
    displayBookmarkFolders();
  }

  function displayRecentBookmarks() {
    const recentContainer = document.getElementById('recentBookmarks');
    const recent = userBookmarks
      .sort((a, b) => new Date(b.Created) - new Date(a.Created))
      .slice(0, 10);

    recentContainer.innerHTML = recent.map(bookmark => `
      <li class="bookmark-item" onclick="openBookmarkTab('${bookmark.URL}', '${bookmark.Title}', '${bookmark.ID}')">
        <span class="bookmark-title" title="${bookmark.Title}">${bookmark.Title}</span>
        <div class="bookmark-actions">
          <button onclick="editBookmark('${bookmark.ID}', event)" title="Edit">
            <i class="fas fa-edit"></i>
          </button>
          <button onclick="deleteBookmark('${bookmark.ID}', event)" title="Delete">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </li>
    `).join('');
  }

  function displayBookmarkFolders() {
    const foldersContainer = document.getElementById('bookmarkFolders');
    const grouped = {};
    
    userBookmarks.forEach(bookmark => {
      const folder = bookmark.Folder || 'General';
      if (!grouped[folder]) grouped[folder] = [];
      grouped[folder].push(bookmark);
    });

    foldersContainer.innerHTML = Object.keys(grouped).sort().map(folder => `
      <div class="bookmark-folder">
        <h4 onclick="toggleFolder('folder-${folder}')">
          <i class="fas fa-chevron-down"></i> ${folder} (${grouped[folder].length})
        </h4>
        <ul class="bookmark-list" id="folder-${folder}">
          ${grouped[folder].map(bookmark => `
            <li class="bookmark-item" onclick="openBookmarkTab('${bookmark.URL}', '${bookmark.Title}', '${bookmark.ID}')">
              <span class="bookmark-title" title="${bookmark.Title}">${bookmark.Title}</span>
              <div class="bookmark-actions">
                <button onclick="editBookmark('${bookmark.ID}', event)" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteBookmark('${bookmark.ID}', event)" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </li>
          `).join('')}
        </ul>
      </div>
    `).join('');
  }

  function openBookmarkTab(url, title, bookmarkId) {
    if (bookmarkId) {
      google.script.run.clientUpdateBookmarkAccess(bookmarkId);
    }
    openTab(url, title);
  }

  function toggleFolder(folderId) {
    const folder = document.getElementById(folderId) || 
                   document.querySelector(`#bookmarkFolders [id="${folderId}"]`);
    
    if (folder) {
      const isHidden = folder.style.display === 'none';
      folder.style.display = isHidden ? '' : 'none';
      
      // Update chevron icon
      const chevron = folder.previousElementSibling?.querySelector('i');
      if (chevron) {
        chevron.className = isHidden ? 'fas fa-chevron-down' : 'fas fa-chevron-right';
      }
    }
  }

  function filterBookmarks() {
    const searchTerm = document.getElementById('bookmarkSearch').value.toLowerCase();
    const bookmarkItems = document.querySelectorAll('.bookmark-item');
    
    bookmarkItems.forEach(item => {
      const title = item.querySelector('.bookmark-title').textContent.toLowerCase();
      const match = title.includes(searchTerm);
      item.style.display = match ? '' : 'none';
    });
  }

  function updateBookmarkButtons() {
    const buttons = document.querySelectorAll('.bookmark-btn');
    buttons.forEach(btn => {
      const resultItem = btn.closest('li');
      const url = resultItem.dataset.url;
      const isBookmarked = userBookmarks.some(b => b.URL === url);
      
      if (isBookmarked) {
        btn.classList.add('bookmarked');
        btn.innerHTML = '<i class="fas fa-bookmark"></i>';
        btn.title = 'Remove bookmark';
      } else {
        btn.classList.remove('bookmarked');
        btn.innerHTML = '<i class="far fa-bookmark"></i>';
        btn.title = 'Add bookmark';
      }
    });
  }

  function toggleBookmark(url, title, btn) {
    const isBookmarked = btn.classList.contains('bookmarked');
    
    if (isBookmarked) {
      removeBookmark(url);
    } else {
      showBookmarkModal(url, title);
    }
  }

  function showBookmarkModal(url, title) {
    document.getElementById('bookmarkTitle').value = title;
    document.getElementById('bookmarkUrl').value = url;
    document.getElementById('bookmarkDescription').value = '';
    document.getElementById('bookmarkTags').value = '';
    document.getElementById('bookmarkFolder').value = 'General';
    document.getElementById('bookmarkModal').style.display = 'block';
  }

  function closeBookmarkModal() {
    document.getElementById('bookmarkModal').style.display = 'none';
  }

  function saveBookmark(evt) {
    evt.preventDefault();
    
    const title = document.getElementById('bookmarkTitle').value;
    const url = document.getElementById('bookmarkUrl').value;
    const description = document.getElementById('bookmarkDescription').value;
    const tags = document.getElementById('bookmarkTags').value;
    const folder = document.getElementById('bookmarkFolder').value;
    
    google.script.run
      .withSuccessHandler(onBookmarkSaved)
      .withFailureHandler(onBookmarkError)
      .clientAddBookmark(title, url, description, tags, folder);
  }

  function onBookmarkSaved(result) {
    if (result.success) {
      closeBookmarkModal();
      loadUserBookmarks(); // Refresh bookmarks
    } else {
      alert('Error saving bookmark: ' + result.error);
    }
  }

  function onBookmarkError(error) {
    alert('Error saving bookmark: ' + error);
  }

  function removeBookmark(url) {
    const bookmark = userBookmarks.find(b => b.URL === url);
    if (bookmark) {
      google.script.run
        .withSuccessHandler(onBookmarkDeleted)
        .clientDeleteBookmark(bookmark.ID);
    }
  }

  function deleteBookmark(bookmarkId, evt) {
    evt.stopPropagation();
    if (confirm('Are you sure you want to delete this bookmark?')) {
      google.script.run
        .withSuccessHandler(onBookmarkDeleted)
        .clientDeleteBookmark(bookmarkId);
    }
  }

  function onBookmarkDeleted(success) {
    if (success) {
      loadUserBookmarks(); // Refresh bookmarks
    } else {
      alert('Error deleting bookmark');
    }
  }

  function editBookmark(bookmarkId, evt) {
    evt.stopPropagation();
    // TODO: Implement edit functionality
    alert('Edit functionality coming soon!');
  }

  function updateFolderSelect() {
    const select = document.getElementById('bookmarkFolder');
    select.innerHTML = bookmarkFolders.map(folder => 
      `<option value="${folder}">${folder}</option>`
    ).join('');
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('bookmarkModal');
    if (event.target === modal) {
      closeBookmarkModal();
    }
  }
</script>
</body>
</html>