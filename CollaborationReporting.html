<!-- CollaborationReporting.html -->
<?!= include('layout', {
  baseUrl: baseUrl || '',
  user: user || {},
  currentPage: currentPage || 'Collaboration Reporting',
  pageTitle: 'Collaboration & Reporting Hub',
  pageDescription: 'Unify quality, attendance, executive intelligence, and collaboration workflows in one command center.'
}) ?>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIpp0hKBR6hO2l4QmF0k0s1Xv1JQnF6YJ7N2drF6wW5w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
  body {
    background: linear-gradient(180deg, #f6f8fc 0%, #eef2ff 100%);
  }

  .collab-wrapper {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2.5rem 2rem 4rem;
  }

  .section-card {
    border-radius: 22px;
    border: none;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
    overflow: hidden;
    background: #ffffff;
  }

  .section-card .card-header {
    background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
    color: #ffffff;
    padding: 1.75rem 2rem 1.5rem;
  }

  .section-card .card-header h2 {
    font-weight: 700;
    margin-bottom: 0.35rem;
  }

  .section-card .card-body {
    padding: 2rem 2rem 2.5rem;
  }

  .muted-label {
    font-size: 0.9rem;
    color: #6b7280;
  }

  .insight-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: rgba(14, 165, 233, 0.12);
    color: #0369a1;
    border-radius: 999px;
    padding: 0.35rem 0.9rem;
    font-weight: 600;
    font-size: 0.8rem;
  }

  .qa-grid {
    display: grid;
    grid-template-columns: minmax(320px, 1.2fr) minmax(320px, 1fr);
    gap: 2rem;
  }

  @media (max-width: 1200px) {
    .qa-grid {
      grid-template-columns: 1fr;
    }
  }

  .qa-form label {
    font-weight: 600;
    color: #1f2937;
  }

  .qa-form .form-control,
  .qa-form .form-select {
    border-radius: 14px;
    border: 1px solid #d8dee9;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
  }

  .qa-form textarea.form-control {
    min-height: 110px;
  }

  .qa-form .btn-primary {
    border-radius: 999px;
    padding: 0.8rem 1.6rem;
    background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    border: none;
    font-weight: 600;
  }

  .qa-metric-card {
    background: linear-gradient(135deg, rgba(14, 165, 233, 0.12) 0%, rgba(59, 130, 246, 0.1) 100%);
    border-radius: 18px;
    padding: 1.4rem 1.6rem;
    margin-bottom: 1.2rem;
  }

  .qa-metric-card .value {
    font-size: 2.2rem;
    font-weight: 700;
    color: #1d4ed8;
  }

  .qa-metric-card .label {
    font-size: 0.9rem;
    color: #1f2937;
    opacity: 0.8;
  }

  .qa-table thead {
    background: #f1f5f9;
  }

  .qa-table tbody tr td {
    vertical-align: middle;
  }

  .qa-table .collaborator {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.2rem 0.55rem;
    border-radius: 999px;
    font-size: 0.75rem;
    background: rgba(59, 130, 246, 0.12);
    color: #1d4ed8;
    margin-right: 0.25rem;
  }

  .qa-table .status-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    border-radius: 999px;
    padding: 0.35rem 0.8rem;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .status-published {
    background: rgba(16, 185, 129, 0.15);
    color: #047857;
  }

  .status-draft {
    background: rgba(249, 115, 22, 0.18);
    color: #c2410c;
  }

  .status-followup {
    background: rgba(239, 68, 68, 0.15);
    color: #b91c1c;
  }

  .attendance-grid {
    display: grid;
    grid-template-columns: minmax(380px, 1.3fr) minmax(280px, 1fr);
    gap: 2rem;
  }

  @media (max-width: 1200px) {
    .attendance-grid {
      grid-template-columns: 1fr;
    }
  }

  .attendance-table tbody tr td {
    vertical-align: middle;
  }

  .progress-bar {
    border-radius: 999px;
  }

  .exec-kpi-card {
    background: #ffffff;
    border-radius: 18px;
    padding: 1.4rem 1.6rem;
    border: 1px solid rgba(15, 23, 42, 0.08);
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.05);
    height: 100%;
  }

  .exec-kpi-card h3 {
    font-size: 1.15rem;
    font-weight: 700;
    margin-bottom: 0.6rem;
  }

  .exec-kpi-card .headline {
    font-size: 2rem;
    font-weight: 700;
    color: #0f172a;
  }

  .exec-kpi-card small {
    color: #64748b;
  }

  .persona-chip {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-radius: 999px;
    padding: 0.6rem 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid transparent;
    color: #0f172a;
    background: rgba(14, 165, 233, 0.08);
  }

  .persona-chip.active {
    background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
    color: #ffffff;
    border-color: rgba(255, 255, 255, 0.35);
    box-shadow: 0 10px 24px rgba(37, 99, 235, 0.22);
  }

  .persona-chip i {
    font-size: 1.1rem;
  }

  .thread-card {
    border-radius: 18px;
    padding: 1rem 1.1rem;
    border: 1px solid rgba(148, 163, 184, 0.3);
    background: rgba(255, 255, 255, 0.9);
    margin-bottom: 0.85rem;
    cursor: pointer;
    transition: transform 0.18s ease, box-shadow 0.18s ease;
  }

  .thread-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 14px 30px rgba(15, 23, 42, 0.12);
  }

  .thread-card.active {
    border-color: rgba(37, 99, 235, 0.6);
    box-shadow: 0 20px 40px rgba(37, 99, 235, 0.18);
  }

  .thread-card .title {
    font-weight: 600;
    color: #0f172a;
  }

  .thread-meta {
    font-size: 0.75rem;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }

  .chat-stream {
    background: rgba(248, 250, 252, 0.8);
    border-radius: 18px;
    padding: 1.2rem 1.4rem;
    height: 100%;
    overflow-y: auto;
    min-height: 420px;
    max-height: 520px;
  }

  .chat-message {
    margin-bottom: 1rem;
    display: flex;
    gap: 0.9rem;
  }

  .chat-message .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #1d4ed8 0%, #3b82f6 100%);
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
  }

  .chat-message .bubble {
    background: #ffffff;
    border-radius: 14px;
    padding: 0.85rem 1rem;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    flex: 1;
  }

  .chat-message .bubble .author {
    font-weight: 600;
    color: #0f172a;
  }

  .chat-message .bubble .timestamp {
    font-size: 0.75rem;
    color: #94a3b8;
  }

  .chat-message .bubble .tags {
    margin-top: 0.5rem;
  }

  .chat-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    font-size: 0.7rem;
    background: rgba(37, 99, 235, 0.12);
    color: #1d4ed8;
    margin-right: 0.4rem;
  }

  .chat-composer .form-control {
    border-radius: 14px;
    padding: 0.85rem 1rem;
    border: 1px solid rgba(148, 163, 184, 0.5);
  }

  .chat-composer .btn-primary {
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    border: none;
  }

  .kpi-trend-card {
    border-radius: 18px;
    background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.95));
    color: #e2e8f0;
    padding: 1.5rem;
  }

  .kpi-trend-card h3 {
    color: #ffffff;
  }

  .kpi-bullet {
    display: flex;
    align-items: center;
    gap: 0.7rem;
    margin-bottom: 0.45rem;
    font-size: 0.9rem;
  }

  .kpi-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }
</style>

<div class="collab-wrapper">
  <div id="collabAlerts" class="mb-3"></div>
  <div class="row g-4 align-items-stretch">
    <div class="col-xxl-8">
      <div class="card section-card h-100">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-3">
          <div>
            <div class="insight-pill"><i class="fas fa-star"></i> QA Collaboration Studio</div>
            <h2 class="mt-3 mb-1">Audit Capture & Multi-role Review</h2>
            <p class="mb-0">Co-author quality reviews, track action items, and visualize cross-team QA performance in real time.</p>
          </div>
            <div class="text-end">
              <div class="muted-label">Rolling 30-day coverage</div>
              <div class="display-6 fw-bold" id="qaCoverageRate">â€”</div>
            </div>
        </div>
        <div class="card-body">
          <div class="qa-grid">
            <form class="qa-form" id="qaCollaborationForm">
              <div class="row g-3">
                <div class="col-sm-6">
                  <label for="qaAgent" class="form-label">Agent</label>
                  <select class="form-select" id="qaAgent" name="qaAgent" required>
                    <option value="">Select an agent</option>
                  </select>
                </div>
                <div class="col-sm-6">
                  <label for="qaCampaign" class="form-label">Campaign</label>
                  <select class="form-select" id="qaCampaign" name="qaCampaign" required>
                    <option value="">Choose campaign</option>
                  </select>
                </div>
                <div class="col-sm-6">
                  <label for="qaReviewer" class="form-label">Reviewer</label>
                  <select class="form-select" id="qaReviewer" name="qaReviewer" required>
                    <option value="">Assign reviewer</option>
                  </select>
                </div>
                <div class="col-sm-6">
                  <label for="qaCollaborators" class="form-label">Collaborators</label>
                  <select class="form-select" id="qaCollaborators" name="qaCollaborators" multiple>
                  </select>
                  <div class="form-text">Loop in managers, QA leads, or executives who need visibility.</div>
                </div>
                <div class="col-sm-4">
                  <label for="qaScore" class="form-label">Score</label>
                  <input type="number" class="form-control" id="qaScore" name="qaScore" min="0" max="100" step="0.5" value="92" required>
                </div>
                <div class="col-sm-4">
                  <label for="qaFocusArea" class="form-label">Focus Area</label>
                  <select class="form-select" id="qaFocusArea" name="qaFocusArea" required>
                    <option value="">Select focus</option>
                    <option>Call Control</option>
                    <option>Compliance</option>
                    <option>Rapport &amp; Empathy</option>
                    <option>Product Knowledge</option>
                    <option>Objection Handling</option>
                  </select>
                </div>
                <div class="col-sm-4">
                  <label for="qaStatus" class="form-label">Status</label>
                  <select class="form-select" id="qaStatus" name="qaStatus" required>
                    <option value="Published">Published</option>
                    <option value="Draft">Draft</option>
                    <option value="Follow-up">Follow-up Scheduled</option>
                  </select>
                </div>
                <div class="col-12">
                  <label for="qaHighlights" class="form-label">Highlights &amp; Coaching Actions</label>
                  <textarea class="form-control" id="qaHighlights" name="qaHighlights" placeholder="Document key wins, risks, and next steps" required></textarea>
                </div>
                <div class="col-md-6">
                  <label for="qaNextTouch" class="form-label">Next touchpoint</label>
                  <input type="date" class="form-control" id="qaNextTouch" name="qaNextTouch">
                </div>
                <div class="col-md-6">
                  <label for="qaChannel" class="form-label">Channel</label>
                  <select class="form-select" id="qaChannel" name="qaChannel" required>
                    <option>Voice</option>
                    <option>Email</option>
                    <option>Chat</option>
                    <option>Social</option>
                  </select>
                </div>
                <div class="col-12 d-flex gap-3 mt-2">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane me-2"></i>Log QA Collaboration
                  </button>
                  <button type="reset" class="btn btn-outline-secondary" id="qaResetBtn">
                    <i class="fas fa-rotate-left me-1"></i>Reset
                  </button>
                </div>
              </div>
            </form>
            <div>
              <div class="qa-metric-card">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <div class="label text-uppercase">Average QA Score</div>
                    <div class="value" id="qaAverageScore">â€”</div>
                  </div>
                  <div class="text-end">
                    <div class="muted-label">vs target 92%</div>
                    <div class="badge bg-success rounded-pill" id="qaScoreTrend">â€”</div>
                  </div>
                </div>
                <div class="mt-3">
                  <canvas id="qaTrendChart" height="160"></canvas>
                </div>
              </div>
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="qa-metric-card">
                    <div class="label text-uppercase">Actionable Items</div>
                    <div class="value" id="qaFollowUps">â€”</div>

                    <div class="muted-label">Follow-ups scheduled this week</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="qa-metric-card">
                    <div class="label text-uppercase">Collaboration Threads</div>
                    <div class="value" id="qaThreads">â€”</div>
                    <div class="muted-label">Audits with multi-role feedback</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="table-responsive mt-4">
            <table class="table table-hover align-middle qa-table" id="qaReviewTable">
              <thead>
                <tr>
                  <th>Audit ID</th>
                  <th>Agent</th>
                  <th>Campaign</th>
                  <th>Score</th>
                  <th>Focus</th>
                  <th>Collaborators</th>
                  <th>Status</th>
                  <th>Updated</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xxl-4">
      <div class="card section-card h-100">
        <div class="card-header">
          <div class="insight-pill"><i class="fas fa-chart-line"></i> Executive KPI Pulse</div>
          <h2 class="mt-3">Multi-campaign Leadership Summary</h2>
          <p class="mb-0">Blended KPIs across every managed campaign, with proactive signals for strategic decision making.</p>
        </div>
        <div class="card-body d-flex flex-column gap-3">
          <div class="row g-3">
            <div class="col-sm-6">
              <div class="exec-kpi-card text-center">
                <small>Average QA score</small>
                <div class="headline" id="kpiQualityAverage">â€”</div>
                <div class="text-success fw-semibold" id="kpiQualityTrend">Awaiting data</div>
              </div>
            </div>
            <div class="col-sm-6">
              <div class="exec-kpi-card text-center">
                <small>Attendance rate</small>
                <div class="headline" id="kpiAttendanceRate">â€”</div>
                <div class="text-success fw-semibold" id="kpiAttendanceTrend">Awaiting data</div>

              </div>
            </div>
          </div>
          <div class="kpi-trend-card">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h3 class="h5 mb-1">Campaign Health Mix</h3>
                <p class="mb-0 text-secondary">Distribution of KPI attainment vs executive targets.</p>
              </div>
              <div class="text-end">
                <span class="badge bg-primary-subtle text-primary" id="execTimeframe">â€”</span>
              </div>
            </div>
            <canvas id="execBlendChart" height="180"></canvas>
            <div class="mt-3" id="execCampaignBullets"></div>
          </div>
          <div class="exec-kpi-card">
            <h3>Executive Brief</h3>
            <ul class="list-unstyled mb-0" id="executiveBrief">
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-2 align-items-stretch">
    <div class="col-xl-7">
      <div class="card section-card h-100">
        <div class="card-header">
          <div class="insight-pill"><i class="fas fa-user-check"></i> Attendance &amp; Adherence</div>
          <h2 class="mt-3">Shift coverage &amp; schedule fidelity</h2>
          <p class="mb-0">Track live adherence, shrinkage trends, and campaign-level coverage gaps.</p>
        </div>
        <div class="card-body">
          <div class="attendance-grid">
            <div>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h3 class="h5 mb-0">Adherence trend</h3>
                  <small class="text-secondary">Rolling six weeks</small>
                </div>
                <select class="form-select form-select-sm" style="width:auto" id="attendanceCampaignFilter"></select>
              </div>
              <canvas id="attendanceTrendChart" height="220"></canvas>
            </div>
            <div>
              <div class="qa-metric-card">
                <div class="label text-uppercase">Average adherence</div>
                <div class="value" id="attendanceAverage">â€”</div>
                <div class="muted-label">Across all campaigns this month</div>
              </div>
              <table class="table table-sm align-middle attendance-table">
                <thead>
                  <tr>
                    <th>Week</th>
                    <th>Adherence</th>
                    <th>Absenteeism</th>
                  </tr>
                </thead>
                <tbody id="attendanceTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-5">
      <div class="card section-card h-100">
        <div class="card-header">
          <div class="insight-pill"><i class="fas fa-headset"></i> Targeted Collaboration Threads</div>
          <h2 class="mt-3">Precision chat for leadership huddles</h2>
          <p class="mb-0">Spin up focused conversations for managers, agents, and executives to address outcomes faster.</p>
        </div>
        <div class="card-body">
          <div class="row g-3 align-items-stretch">
            <div class="col-lg-4">
              <div class="d-flex flex-column gap-2" id="chatPersonaFilters"></div>
            </div>
            <div class="col-lg-4">
              <div id="chatThreadList" class="overflow-auto" style="max-height:460px;"></div>
            </div>
            <div class="col-lg-4 d-flex flex-column">
              <div class="chat-stream mb-3" id="chatMessageStream"></div>
              <form id="chatComposer" class="chat-composer">
                <div class="input-group">
                  <input type="text" id="chatMessageInput" class="form-control" placeholder="Share an update" required>
                  <button class="btn btn-primary" type="submit"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div class="form-text mt-1">Visible to <span id="chatAudienceLabel" class="fw-semibold">all participants</span></div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const currentUser = <?!= JSON.stringify(user || {}) ?>;
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const state = {
      qa: {
        records: [],
        directory: { agents: [], reviewers: [], collaborators: [], campaigns: [] },
        metrics: {},
        trend: { labels: [], values: [] }
      },
      attendance: { campaigns: [], history: {}, summary: {} },
      executive: { summary: null, campaigns: [], brief: [], timeframeLabel: '' },
      chat: { personas: [], threads: {} },
      charts: { qaTrend: null, attendance: null, executive: null },
      activePersona: null,
      activeThreadId: null,
      isLoading: false
    };

    const qaTableBody = document.querySelector('#qaReviewTable tbody');
    const qaAgentSelect = document.getElementById('qaAgent');
    const qaCampaignSelect = document.getElementById('qaCampaign');
    const qaReviewerSelect = document.getElementById('qaReviewer');
    const qaCollaboratorSelect = document.getElementById('qaCollaborators');
    const qaScoreInput = document.getElementById('qaScore');
    const qaFocusAreaSelect = document.getElementById('qaFocusArea');
    const qaStatusSelect = document.getElementById('qaStatus');
    const qaHighlightsField = document.getElementById('qaHighlights');
    const qaNextTouchInput = document.getElementById('qaNextTouch');
    const qaChannelSelect = document.getElementById('qaChannel');
    const qaForm = document.getElementById('qaCollaborationForm');
    const qaSubmitButton = qaForm.querySelector('button[type="submit"]');
    const qaResetButton = document.getElementById('qaResetBtn');
    const qaTrendChartCanvas = document.getElementById('qaTrendChart');

    const attendanceCampaignSelect = document.getElementById('attendanceCampaignFilter');
    const attendanceTableBody = document.getElementById('attendanceTableBody');
    const attendanceChartCanvas = document.getElementById('attendanceTrendChart');

    const execBlendChartCanvas = document.getElementById('execBlendChart');
    const execCampaignBullets = document.getElementById('execCampaignBullets');
    const execBriefList = document.getElementById('executiveBrief');
    const execTimeframeEl = document.getElementById('execTimeframe');

    const kpiQualityAverage = document.getElementById('kpiQualityAverage');
    const kpiQualityTrend = document.getElementById('kpiQualityTrend');
    const kpiAttendanceRate = document.getElementById('kpiAttendanceRate');
    const kpiAttendanceTrend = document.getElementById('kpiAttendanceTrend');
    const qaAverageEl = document.getElementById('qaAverageScore');
    const qaFollowUpsEl = document.getElementById('qaFollowUps');
    const qaThreadsEl = document.getElementById('qaThreads');
    const qaCoverageEl = document.getElementById('qaCoverageRate');
    const qaScoreTrendEl = document.getElementById('qaScoreTrend');
    const attendanceAverageEl = document.getElementById('attendanceAverage');

    const personaFiltersContainer = document.getElementById('chatPersonaFilters');
    const chatThreadList = document.getElementById('chatThreadList');
    const chatStream = document.getElementById('chatMessageStream');
    const chatComposer = document.getElementById('chatComposer');
    const chatMessageInput = document.getElementById('chatMessageInput');
    const chatAudienceLabel = document.getElementById('chatAudienceLabel');
    const chatSubmitButton = chatComposer.querySelector('button[type="submit"]');

    const alertsContainer = document.getElementById('collabAlerts');
    const loadingMessage = '<div class="text-secondary py-4 text-center small">Loadingâ€¦</div>';
    const chartColors = ['#38bdf8', '#34d399', '#facc15', '#f97316', '#8b5cf6', '#f472b6'];

    function clearAlerts() {
      alertsContainer.innerHTML = '';
    }

    function showAlert(message, type) {
      const alert = document.createElement('div');
      const tone = type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'danger' ? 'danger' : 'info';
      alert.className = 'alert alert-' + tone + ' alert-dismissible fade show';
      alert.role = 'alert';
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      alertsContainer.appendChild(alert);
    }

    function formatPercent(value, decimals) {
      if (value === null || value === undefined || value === '') return 'â€”';
      const num = Number(value);
      if (isNaN(num)) return 'â€”';
      const fixed = num.toFixed(decimals != null ? decimals : 1);
      return fixed + '%';
    }

    function formatNumber(value, decimals) {
      if (value === null || value === undefined || value === '') return 'â€”';
      const num = Number(value);
      if (isNaN(num)) return 'â€”';
      return num.toFixed(decimals != null ? decimals : 0);
    }

    function formatDateTime(isoString) {
      if (!isoString) return 'â€”';
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return 'â€”';
      return date.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function formatRelativeTime(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return '';
      const diffMs = Date.now() - date.getTime();
      const diffMinutes = Math.round(diffMs / 60000);
      if (diffMinutes < 1) return 'just now';
      if (diffMinutes < 60) return diffMinutes + 'm ago';
      const diffHours = Math.round(diffMinutes / 60);
      if (diffHours < 24) return diffHours + 'h ago';
      const diffDays = Math.round(diffHours / 24);
      if (diffDays < 7) return diffDays + 'd ago';
      return date.toLocaleDateString();
    }

    function statusClass(status) {
      const normalized = (status || '').toLowerCase();
      if (normalized.indexOf('follow') >= 0) return 'status-pill status-followup';
      if (normalized.indexOf('publish') >= 0) return 'status-pill status-published';
      return 'status-pill status-draft';
    }

    function populateSelectOptions(select, items, placeholder, isMultiple) {
      select.innerHTML = '';
      if (!isMultiple) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = placeholder || 'Select';
        select.appendChild(opt);
      }
      (items || []).forEach(function (item) {
        const option = document.createElement('option');
        const id = item && typeof item === 'object' ? (item.id || item.value || item.name) : item;
        const name = item && typeof item === 'object' ? (item.name || item.label || item.id) : item;
        option.value = id || '';
        option.textContent = name || id || '';
        select.appendChild(option);
      });
    }

    function ensureEmptyState(container, message) {
      let placeholder = container.querySelector('.chart-empty');
      if (!message) {
        if (placeholder) placeholder.remove();
        return;
      }
      if (!placeholder) {
        placeholder = document.createElement('div');
        placeholder.className = 'chart-empty text-secondary small text-center py-4';
        container.appendChild(placeholder);
      }
      placeholder.textContent = message;
    }

    function setFormSubmitting(submitting) {
      qaSubmitButton.disabled = submitting;
      qaResetButton.disabled = submitting;
    }

    function setChatComposerEnabled(enabled) {
      chatMessageInput.disabled = !enabled;
      chatSubmitButton.disabled = !enabled;
    }

    function renderQADirectory() {
      populateSelectOptions(qaAgentSelect, state.qa.directory.agents, 'Select an agent');
      populateSelectOptions(qaCampaignSelect, state.qa.directory.campaigns, 'Choose campaign');
      populateSelectOptions(qaReviewerSelect, state.qa.directory.reviewers, 'Assign reviewer');
      populateSelectOptions(qaCollaboratorSelect, state.qa.directory.collaborators, '', true);
    }

    function renderQATable() {
      const records = state.qa.records || [];
      if (!records.length) {
        qaTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-secondary py-4">No QA collaboration records found.</td></tr>';
        return;
      }
      qaTableBody.innerHTML = '';
      records.forEach(function (record) {
        const tr = document.createElement('tr');
        const collaborators = (record.collaborators || []).map(function (name) {
          return `<span class="collaborator"><i class="fas fa-user-circle"></i>${name}</span>`;
        }).join('');
        tr.innerHTML = `
          <td class="fw-semibold">${record.id || 'â€”'}</td>
          <td>
            <div class="fw-semibold">${record.agent || 'â€”'}</div>
            <small class="text-secondary">${record.reviewer || ''}</small>
          </td>
          <td>${record.campaignName || 'â€”'}</td>
          <td><span class="fw-bold">${record.score != null ? formatNumber(record.score, 1) : 'â€”'}</span></td>
          <td>${record.focus || 'â€”'}</td>
          <td>${collaborators}</td>
          <td><span class="${statusClass(record.status)}">${record.status || 'Draft'}</span></td>
          <td>${formatDateTime(record.updated)}</td>
        `;
        qaTableBody.appendChild(tr);
      });
    }

    function renderQAMetrics() {
      const metrics = state.qa.metrics || {};
      qaAverageEl.textContent = metrics.averageScore != null ? formatNumber(metrics.averageScore, 1) : 'â€”';
      qaFollowUpsEl.textContent = metrics.followUps != null ? metrics.followUps : '0';
      qaThreadsEl.textContent = metrics.collaborativeThreads != null ? metrics.collaborativeThreads : '0';
      qaCoverageEl.textContent = metrics.coverageRate != null ? formatPercent(metrics.coverageRate, 1) : 'â€”';
      const delta = metrics.deltaVsTarget;
      if (delta != null && !Number.isNaN(delta)) {
        qaScoreTrendEl.textContent = (delta >= 0 ? '+' : '') + delta.toFixed(1) + ' pts';
        qaScoreTrendEl.classList.toggle('bg-success', delta >= 0);
        qaScoreTrendEl.classList.toggle('bg-danger', delta < 0);
      } else {
        qaScoreTrendEl.textContent = 'â€”';
        qaScoreTrendEl.classList.remove('bg-success', 'bg-danger');
      }
    }

    function renderQaTrendChart() {
      const labels = state.qa.trend.labels || [];
      const values = (state.qa.trend.values || []).map(function (value) {
        return value == null ? null : Number(value);
      });
      const container = qaTrendChartCanvas.parentElement;
      const hasData = labels.length && values.some(function (v) { return v != null; });
      if (!hasData) {
        if (state.charts.qaTrend) {
          state.charts.qaTrend.destroy();
          state.charts.qaTrend = null;
        }
        qaTrendChartCanvas.classList.add('d-none');
        ensureEmptyState(container, 'No QA trend data available yet.');
        return;
      }
      ensureEmptyState(container, '');
      qaTrendChartCanvas.classList.remove('d-none');
      const dataset = values.map(function (value) {
        return value == null ? null : Number(value.toFixed(1));
      });
      if (state.charts.qaTrend) {
        state.charts.qaTrend.data.labels = labels;
        state.charts.qaTrend.data.datasets[0].data = dataset;
        state.charts.qaTrend.update();
      } else {
        state.charts.qaTrend = new Chart(qaTrendChartCanvas.getContext('2d'), {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'QA Score',
                data: dataset,
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.12)',
                tension: 0.35,
                borderWidth: 3,
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                ticks: {
                  callback: function (value) { return value + '%'; }
                }
              }
            }
          }
        });
      }
    }

    function renderExecutiveSection() {
      const summary = state.executive.summary || {};
      kpiQualityAverage.textContent = summary.qaAverage != null ? formatPercent(summary.qaAverage, 1) : 'â€”';
      const qualityDelta = state.qa.metrics && state.qa.metrics.deltaVsTarget != null ? state.qa.metrics.deltaVsTarget : null;
      if (qualityDelta != null && !Number.isNaN(qualityDelta)) {
        kpiQualityTrend.textContent = (qualityDelta >= 0 ? '+' : '') + qualityDelta.toFixed(1) + ' pts vs target';
        kpiQualityTrend.classList.toggle('text-success', qualityDelta >= 0);
        kpiQualityTrend.classList.toggle('text-danger', qualityDelta < 0);
      } else {
        kpiQualityTrend.textContent = 'Target comparison unavailable';
        kpiQualityTrend.classList.remove('text-success', 'text-danger');
      }

      const attendanceRate = summary.attendanceAverage != null ? summary.attendanceAverage : state.attendance.summary.attendanceRate;
      kpiAttendanceRate.textContent = attendanceRate != null ? formatPercent(attendanceRate, 1) : 'â€”';
      if (state.attendance.summary.absenceRate != null) {
        const absence = state.attendance.summary.absenceRate;
        kpiAttendanceTrend.textContent = 'Absence ' + formatPercent(absence, 1);
        kpiAttendanceTrend.classList.toggle('text-success', absence <= 5);
        kpiAttendanceTrend.classList.toggle('text-danger', absence > 5);
      } else {
        kpiAttendanceTrend.textContent = 'Attendance variance unavailable';
        kpiAttendanceTrend.classList.remove('text-success', 'text-danger');
      }

      execTimeframeEl.textContent = state.executive.timeframeLabel || 'â€”';

      execCampaignBullets.innerHTML = '';
      const campaigns = state.executive.campaigns || [];
      if (!campaigns.length) {
        execCampaignBullets.innerHTML = '<div class="text-secondary small">No campaign mix data available.</div>';
      } else {
        campaigns.forEach(function (campaign, index) {
          const color = chartColors[index % chartColors.length];
          const qaText = campaign.qa != null ? 'QA ' + campaign.qa + '%' : 'QA n/a';
          const attText = campaign.attendance != null ? 'Attendance ' + campaign.attendance + '%' : 'Attendance n/a';
          const wrapper = document.createElement('div');
          wrapper.className = 'kpi-bullet';
          wrapper.innerHTML = `<span class="kpi-dot" style="background:${color}"></span> ${campaign.title || 'Campaign'} â€“ ${qaText}, ${attText}`;
          execCampaignBullets.appendChild(wrapper);
        });
      }

      execBriefList.innerHTML = '';
      if (!state.executive.brief || !state.executive.brief.length) {
        execBriefList.innerHTML = '<li class="text-secondary">No executive brief notes available.</li>';
      } else {
        state.executive.brief.forEach(function (item) {
          const li = document.createElement('li');
          li.className = 'mb-3';
          li.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-bold">${item.title || 'Campaign'}</div>
                <div class="text-secondary">${item.metrics || ''}</div>
              </div>
            </div>
            ${item.note ? `<div class="small text-secondary mt-1">${item.note}</div>` : ''}
          `;
          execBriefList.appendChild(li);
        });
      }

      const labels = campaigns.map(function (campaign) { return campaign.title || 'Campaign'; });
      const values = campaigns.map(function (campaign) {
        const qa = campaign.qa != null ? campaign.qa : null;
        const att = campaign.attendance != null ? campaign.attendance : null;
        if (qa == null && att == null) return 0;
        if (qa != null && att != null) return Number(((qa + att) / 2).toFixed(1));
        return qa != null ? Number(qa.toFixed(1)) : Number(att.toFixed(1));
      });
      if (!labels.length) {
        if (state.charts.executive) {
          state.charts.executive.destroy();
          state.charts.executive = null;
        }
        ensureEmptyState(execBlendChartCanvas.parentElement, 'No executive campaign blend data available.');
      } else {
        ensureEmptyState(execBlendChartCanvas.parentElement, '');
        if (state.charts.executive) {
          state.charts.executive.data.labels = labels;
          state.charts.executive.data.datasets[0].data = values;
          state.charts.executive.data.datasets[0].backgroundColor = labels.map(function (_, index) {
            return chartColors[index % chartColors.length];
          });
          state.charts.executive.update();
        } else {
          state.charts.executive = new Chart(execBlendChartCanvas, {
            type: 'doughnut',
            data: {
              labels: labels,
              datasets: [
                {
                  data: values,
                  backgroundColor: labels.map(function (_, index) {
                    return chartColors[index % chartColors.length];
                  }),
                  borderWidth: 0,
                  hoverOffset: 8
                }
              ]
            },
            options: {
              cutout: '68%',
              plugins: { legend: { display: false } }
            }
          });
        }
      }
    }

    function renderAttendanceOptions() {
      populateSelectOptions(attendanceCampaignSelect, state.attendance.campaigns, 'Select campaign');
      if (state.attendance.campaigns.length) {
        attendanceCampaignSelect.value = state.attendance.campaigns[0].id || state.attendance.campaigns[0].name;
      }
    }

    function renderAttendanceAverage() {
      if (state.attendance.summary.averageAdherence != null) {
        attendanceAverageEl.textContent = formatPercent(state.attendance.summary.averageAdherence, 1);
      } else if (state.attendance.summary.attendanceRate != null) {
        attendanceAverageEl.textContent = formatPercent(state.attendance.summary.attendanceRate, 1);
      } else {
        attendanceAverageEl.textContent = 'â€”';
      }
    }

    function renderAttendanceTable(campaignId) {
      const history = state.attendance.history[campaignId] || [];
      if (!history.length) {
        attendanceTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-secondary py-3">No attendance records for this campaign.</td></tr>';
        return;
      }
      const recent = history.slice(-6);
      attendanceTableBody.innerHTML = '';
      recent.forEach(function (entry) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="fw-semibold">${entry.week}</td>
          <td>
            <div class="fw-semibold">${entry.adherence != null ? entry.adherence.toFixed(1) + '%' : 'â€”'}</div>
            <div class="progress" style="height:6px;">
              <div class="progress-bar bg-primary" style="width:${entry.adherence != null ? entry.adherence : 0}%"></div>
            </div>
          </td>
          <td class="text-danger">${entry.absenteeism != null ? entry.absenteeism.toFixed(1) + '%' : 'â€”'}</td>
        `;
        attendanceTableBody.appendChild(tr);
      });
    }

    function renderAttendanceChart(campaignId) {
      const history = state.attendance.history[campaignId] || [];
      const labels = history.slice(-6).map(function (entry) { return entry.week; });
      const adherence = history.slice(-6).map(function (entry) { return entry.adherence != null ? Number(entry.adherence.toFixed(1)) : null; });
      const absenteeism = history.slice(-6).map(function (entry) { return entry.absenteeism != null ? Number(entry.absenteeism.toFixed(1)) : null; });
      const hasData = labels.length && adherence.some(function (v) { return v != null; });
      const container = attendanceChartCanvas.parentElement;
      if (!hasData) {
        if (state.charts.attendance) {
          state.charts.attendance.destroy();
          state.charts.attendance = null;
        }
        ensureEmptyState(container, 'No adherence trend data available for this campaign.');
        return;
      }
      ensureEmptyState(container, '');
      const adherenceData = adherence.map(function (value) { return value == null ? null : value; });
      const absenteeismData = absenteeism.map(function (value) { return value == null ? null : value; });
      if (state.charts.attendance) {
        state.charts.attendance.data.labels = labels;
        state.charts.attendance.data.datasets[0].data = adherenceData;
        state.charts.attendance.data.datasets[1].data = absenteeismData;
        state.charts.attendance.update();
      } else {
        state.charts.attendance = new Chart(attendanceChartCanvas.getContext('2d'), {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Adherence %',
                data: adherenceData,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.12)',
                tension: 0.35,
                borderWidth: 3,
                fill: true
              },
              {
                label: 'Absenteeism %',
                data: absenteeismData,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.35,
                borderWidth: 2,
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'bottom'
              }
            },
            scales: {
              y: {
                ticks: {
                  callback: function (value) { return value + '%'; }
                }
              }
            }
          }
        });
      }
    }

    function renderAttendanceSection() {
      renderAttendanceOptions();
      renderAttendanceAverage();
      const selected = attendanceCampaignSelect.value || (state.attendance.campaigns[0] && (state.attendance.campaigns[0].id || state.attendance.campaigns[0].name));
      if (selected) {
        renderAttendanceTable(selected);
        renderAttendanceChart(selected);
      } else {
        attendanceTableBody.innerHTML = '<tr><td colspan="3" class="text-center text-secondary py-3">No attendance data available.</td></tr>';
        if (state.charts.attendance) {
          state.charts.attendance.destroy();
          state.charts.attendance = null;
        }
        ensureEmptyState(attendanceChartCanvas.parentElement, 'No adherence trend data available.');
      }
    }

    function renderChatPersonaFilters() {
      personaFiltersContainer.innerHTML = '';
      const personas = state.chat.personas || [];
      if (!personas.length) {
        personaFiltersContainer.innerHTML = '<div class="text-secondary small">No collaboration personas available.</div>';
        return;
      }
      personas.forEach(function (persona) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'persona-chip btn btn-link text-start ' + (state.activePersona === persona.key ? 'active' : '');
        button.innerHTML = `<i class="fas ${persona.icon || 'fa-comments'}"></i> ${persona.label || persona.key}`;
        button.addEventListener('click', function () {
          state.activePersona = persona.key;
          const threads = state.chat.threads[state.activePersona] || [];
          state.activeThreadId = threads.length ? threads[0].id : null;
          renderChatPersonaFilters();
          renderChatThreads();
          renderActiveThread();
        });
        personaFiltersContainer.appendChild(button);
      });
    }

    function renderChatThreads() {
      chatThreadList.innerHTML = '';
      const threads = state.chat.threads[state.activePersona] || [];
      if (!threads.length) {
        chatThreadList.innerHTML = '<div class="text-secondary small">No threads available for this audience.</div>';
        return;
      }
      threads.forEach(function (thread) {
        const card = document.createElement('div');
        card.className = 'thread-card ' + (thread.id === state.activeThreadId ? 'active' : '');
        card.innerHTML = `
          <div class="title">${thread.title || 'Thread'}</div>
          <div class="thread-meta mt-2">
            <span><i class="fas fa-users"></i> ${thread.audience || 'Team'}</span>
            <span><i class="fas fa-clock"></i> ${formatRelativeTime(thread.updated)}</span>
          </div>
        `;
        card.addEventListener('click', function () {
          state.activeThreadId = thread.id;
          renderChatThreads();
          renderActiveThread();
        });
        chatThreadList.appendChild(card);
      });
    }

    function renderActiveThread() {
      chatStream.innerHTML = '';
      const threads = state.chat.threads[state.activePersona] || [];
      const thread = threads.find(function (entry) { return entry.id === state.activeThreadId; });
      if (!thread) {
        chatAudienceLabel.textContent = 'selected participants';
        chatStream.innerHTML = '<div class="text-secondary small text-center py-4">Select a thread to view messages.</div>';
        setChatComposerEnabled(false);
        return;
      }
      chatAudienceLabel.textContent = thread.audience || 'participants';
      if (!thread.messages || !thread.messages.length) {
        chatStream.innerHTML = '<div class="text-secondary small text-center py-4">No messages yet.</div>';
      } else {
        thread.messages.forEach(function (message) {
          const wrapper = document.createElement('div');
          wrapper.className = 'chat-message';
          wrapper.innerHTML = `
            <div class="avatar">${(message.author || 'U').charAt(0)}</div>
            <div class="bubble">
              <div class="d-flex justify-content-between align-items-center">
                <div class="author">${message.author || 'Team'}</div>
                <div class="timestamp">${formatRelativeTime(message.time)}</div>
              </div>
              <div class="mt-1">${message.text || ''}</div>
              <div class="tags">${(message.tags || []).map(function (tag) {
                return `<span class="chat-tag"><i class="fas fa-tag"></i> ${tag}</span>`;
              }).join('')}</div>
            </div>
          `;
          chatStream.appendChild(wrapper);
        });
        chatStream.scrollTop = chatStream.scrollHeight;
      }
      setChatComposerEnabled(!!thread.channelId);
    }

    function refreshChatUI() {
      const personas = state.chat.personas || [];
      if (!state.activePersona && personas.length) {
        state.activePersona = personas[0].key;
      }
      const threads = state.chat.threads[state.activePersona] || [];
      if (!state.activeThreadId && threads.length) {
        state.activeThreadId = threads[0].id;
      }
      renderChatPersonaFilters();
      renderChatThreads();
      renderActiveThread();
    }

    function applyQaData(data) {
      state.qa.records = (data.records || []).slice();
      state.qa.directory = data.directory || state.qa.directory;
      state.qa.metrics = data.metrics || {};
      state.qa.trend = data.trend || { labels: [], values: [] };
      renderQADirectory();
      renderQATable();
      renderQAMetrics();
      renderQaTrendChart();
    }

    function applyAttendanceData(data) {
      state.attendance.campaigns = data.campaigns || [];
      state.attendance.history = data.history || {};
      state.attendance.summary = data.summary || {};
      renderAttendanceSection();
    }

    function applyExecutiveData(data) {
      state.executive.summary = data.summary || null;
      state.executive.campaigns = data.campaigns || [];
      state.executive.brief = data.brief || [];
      state.executive.timeframeLabel = data.timeframeLabel || '';
      renderExecutiveSection();
    }

    function applyChatData(data) {
      state.chat.personas = data.personas || [];
      state.chat.threads = data.threads || {};
      state.activePersona = null;
      state.activeThreadId = null;
      refreshChatUI();
    }

    function loadCollaborationData(force) {
      if (state.isLoading && !force) return;
      state.isLoading = true;
      clearAlerts();
      qaTableBody.innerHTML = '<tr><td colspan="8">' + loadingMessage + '</td></tr>';
      attendanceTableBody.innerHTML = '<tr><td colspan="3">' + loadingMessage + '</td></tr>';
      chatThreadList.innerHTML = loadingMessage;
      chatStream.innerHTML = loadingMessage;
      setChatComposerEnabled(false);

      google.script.run
        .withSuccessHandler(function (response) {
          state.isLoading = false;
          response = response || {};
          if (response.qa) applyQaData(response.qa);
          if (response.attendance) applyAttendanceData(response.attendance);
          if (response.executive) applyExecutiveData(response.executive);
          if (response.chat) applyChatData(response.chat);
        })
        .withFailureHandler(function (err) {
          state.isLoading = false;
          console.error(err);
          showAlert(err && err.message ? err.message : 'Unable to load collaboration reporting data.', 'danger');
        })
        .clientGetCollaborationReportingData({});
    }

    attendanceCampaignSelect.addEventListener('change', function (event) {
      const campaignId = event.target.value;
      renderAttendanceTable(campaignId);
      renderAttendanceChart(campaignId);
    });

    qaForm.addEventListener('submit', function (event) {
      event.preventDefault();
      if (!qaForm.checkValidity()) {
        qaForm.classList.add('was-validated');
        return;
      }
      qaForm.classList.remove('was-validated');
      setFormSubmitting(true);
      const collaborators = Array.from(qaCollaboratorSelect.selectedOptions).map(function (opt) { return opt.value; }).filter(Boolean);
      const campaignOption = qaCampaignSelect.selectedOptions[0];
      const payload = {
        agent: qaAgentSelect.value,
        campaignId: qaCampaignSelect.value,
        campaignName: campaignOption ? campaignOption.textContent : qaCampaignSelect.value,
        reviewer: qaReviewerSelect.value,
        collaborators: collaborators,
        score: qaScoreInput.value ? Number(qaScoreInput.value) : '',
        focusArea: qaFocusAreaSelect.value,
        status: qaStatusSelect.value,
        highlights: qaHighlightsField.value,
        nextTouch: qaNextTouchInput.value,
        channel: qaChannelSelect.value
      };
      google.script.run
        .withSuccessHandler(function () {
          setFormSubmitting(false);
          qaForm.reset();
          showAlert('Collaboration note shared with the QA channel.', 'success');
        })
        .withFailureHandler(function (err) {
          setFormSubmitting(false);
          console.error(err);
          showAlert(err && err.message ? err.message : 'Unable to log the collaboration note.', 'danger');
        })
        .clientSubmitCollaborationNote(payload);
    });

    qaResetButton.addEventListener('click', function () {
      qaForm.classList.remove('was-validated');
      qaHighlightsField.value = '';
    });

    chatComposer.addEventListener('submit', function (event) {
      event.preventDefault();
      const threads = state.chat.threads[state.activePersona] || [];
      const thread = threads.find(function (entry) { return entry.id === state.activeThreadId; });
      const message = chatMessageInput.value.trim();
      if (!thread || !thread.channelId || !message) {
        return;
      }
      setChatComposerEnabled(false);
      google.script.run
        .withSuccessHandler(function () {
          setChatComposerEnabled(true);
          chatMessageInput.value = '';
          const nowIso = new Date().toISOString();
          thread.messages = thread.messages || [];
          thread.messages.push({
            author: (currentUser && currentUser.FullName) || 'You',
            time: nowIso,
            text: message,
            tags: ['Update']
          });
          thread.updated = nowIso;
          renderChatThreads();
          renderActiveThread();
          setTimeout(function () { loadCollaborationData(true); }, 500);
        })
        .withFailureHandler(function (err) {
          setChatComposerEnabled(true);
          console.error(err);
          showAlert(err && err.message ? err.message : 'Unable to post collaboration message.', 'danger');
        })
        .clientPostCollaborationThreadMessage({
          channelId: thread.channelId,
          campaignId: thread.campaignId || '',
          message: message
        });
    });

    loadCollaborationData(false);
  });
</script>


