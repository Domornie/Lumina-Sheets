<!-- OKR Campaign Detail View -->

<?!= include('layout', {
        baseUrl: baseUrl || '',
        scriptUrl: scriptUrl,
        user: user || {},
        currentPage: currentPage || 'dashboard-detail',
        pageTitle: 'Campaign Performance Detail',
        pageDescription: 'Deep dive into a single campaign\'s OKR performance.'
      }) ?>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --navy-primary: #003177;
            --cyan-accent: #00bfff;
            --surface: #f1f5f9;
            --surface-elevated: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-subtle: #e2e8f0;
            --border-strong: #cbd5f5;
            --radius-lg: 1rem;
            --radius-md: 0.75rem;
            --shadow-lg: 0 20px 35px -20px rgba(15, 23, 42, 0.45);
            --shadow-md: 0 10px 25px -15px rgba(15, 23, 42, 0.25);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top, rgba(0, 49, 119, 0.12), transparent 55%), var(--surface);
            color: var(--text-primary);
            margin: 0;
        }

        .detail-shell {
            max-width: 1180px;
            margin: 0 auto;
            padding: 2.5rem 2rem 3.5rem;
        }

        .detail-header {
            background: linear-gradient(135deg, rgba(0, 49, 119, 0.92), rgba(0, 152, 199, 0.92));
            color: #fff;
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            position: relative;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .detail-header::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.25), transparent 40%);
            pointer-events: none;
        }

        .detail-header-content {
            position: relative;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 2rem;
            align-items: flex-start;
        }

        .header-title-group {
            max-width: 680px;
        }

        .header-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 0 0.5rem;
        }

        .header-subtitle {
            margin: 0;
            font-size: 1.05rem;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .btn-outline-light {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .btn-outline-light:hover {
            background: rgba(255, 255, 255, 0.18);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            padding: 0.4rem 0.85rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.18);
            color: #fff;
        }

        .status-chip i {
            font-size: 0.85rem;
        }

        .detail-stats-grid {
            margin-top: 2.25rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            backdrop-filter: blur(4px);
            background: rgba(255, 255, 255, 0.12);
            border-radius: var(--radius-md);
            padding: 1rem 1.25rem;
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .stat-card-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.08rem;
            opacity: 0.75;
        }

        .stat-card-value {
            margin-top: 0.4rem;
            font-size: 1.7rem;
            font-weight: 700;
        }

        .detail-content {
            margin-top: 2.75rem;
            display: grid;
            grid-template-columns: 3fr 1.2fr;
            gap: 2rem;
        }

        .primary-column,
        .secondary-column {
            display: flex;
            flex-direction: column;
            gap: 1.75rem;
        }

        .panel {
            background: var(--surface-elevated);
            border-radius: var(--radius-lg);
            padding: 1.75rem;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-md);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .filter-control {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            min-width: 160px;
        }

        .filter-control label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.05rem;
        }

        .filter-control select,
        .filter-control input {
            border-radius: 0.65rem;
            border: 1px solid var(--border-subtle);
            padding: 0.6rem 0.9rem;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-primary);
            background: #fff;
        }

        .metrics-grid {
            display: grid;
            gap: 1.25rem;
        }

        .category-card {
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 1.25rem 1.5rem;
            background: #fff;
            box-shadow: inset 0 1px 0 rgba(148, 163, 184, 0.18);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .category-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .status-badge {
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05rem;
        }

        .status-excellent { background: rgba(22, 163, 74, 0.12); color: #15803d; }
        .status-good { background: rgba(59, 130, 246, 0.12); color: #1d4ed8; }
        .status-needs_improvement { background: rgba(239, 68, 68, 0.12); color: #b91c1c; }

        .metric-rows {
            display: grid;
            gap: 0.85rem;
        }

        .metric-row {
            display: grid;
            grid-template-columns: minmax(180px, 1fr) minmax(160px, 1fr) 1fr;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.85rem;
            border: 1px solid rgba(15, 23, 42, 0.06);
            background: rgba(241, 245, 249, 0.6);
        }

        .metric-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-targets {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            position: relative;
            height: 10px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.08);
            overflow: hidden;
        }

        .progress-bar span {
            display: block;
            height: 100%;
            border-radius: 999px;
            transition: width 0.4s ease;
        }

        .progress-excellent { background: linear-gradient(90deg, #16a34a, #22c55e); }
        .progress-good { background: linear-gradient(90deg, #2563eb, #3b82f6); }
        .progress-needs_improvement { background: linear-gradient(90deg, #dc2626, #f97316); }

        .agent-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 0.6rem;
        }

        .agent-list li {
            padding: 0.7rem 0.9rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(15, 23, 42, 0.08);
            background: rgba(248, 250, 252, 0.8);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .agent-list i {
            color: #2563eb;
        }

        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary);
            border: 1px dashed var(--border-subtle);
            border-radius: var(--radius-lg);
            background: rgba(148, 163, 184, 0.08);
        }

        .alerts-list {
            display: grid;
            gap: 0.85rem;
        }

        .alert-item {
            border-radius: 0.85rem;
            border: 1px solid rgba(15, 23, 42, 0.08);
            padding: 0.85rem 1rem;
            background: rgba(254, 243, 199, 0.55);
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .alert-item strong {
            font-size: 0.95rem;
        }

        .refresh-meta {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
        }

        @media (max-width: 1024px) {
            .detail-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .detail-shell {
                padding: 1.5rem;
            }

            .detail-header-content {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-direction: row;
                justify-content: space-between;
                width: 100%;
            }

            .detail-stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }

            .metric-row {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        const selectedCampaign = <?!= JSON.stringify(selectedCampaign || '') ?>;
        const granularity = <?!= JSON.stringify(granularity || '') ?>;
        const period = <?!= JSON.stringify(period || '') ?>;
    </script>

    <div class="detail-shell">
        <header class="detail-header">
            <div class="detail-header-content">
                <div class="header-title-group">
                    <div class="status-chip" id="campaignStatus">
                        <i class="fas fa-circle-notch fa-spin"></i>
                        <span>Loading status…</span>
                    </div>
                    <h1 class="header-title" id="campaignTitle">Campaign Overview</h1>
                    <p class="header-subtitle" id="campaignSubtitle">Consolidated OKR insights for the selected campaign.</p>
                </div>
                <div class="header-actions">
                    <button class="btn-outline-light" id="backToOverview">
                        <i class="fas fa-arrow-left"></i> Back to overview
                    </button>
                    <button class="btn-outline-light" id="refreshCampaign">
                        <i class="fas fa-rotate"></i> Refresh data
                    </button>
                    <div class="refresh-meta" id="lastUpdatedLabel">Last refreshed —</div>
                </div>
            </div>
            <div class="detail-stats-grid">
                <div class="stat-card">
                    <span class="stat-card-label">Overall Score</span>
                    <div class="stat-card-value" id="statScore">--</div>
                </div>
                <div class="stat-card">
                    <span class="stat-card-label">Grade</span>
                    <div class="stat-card-value" id="statGrade">--</div>
                </div>
                <div class="stat-card">
                    <span class="stat-card-label">Active Agents</span>
                    <div class="stat-card-value" id="statAgents">--</div>
                </div>
                <div class="stat-card">
                    <span class="stat-card-label">Call Volume</span>
                    <div class="stat-card-value" id="statCalls">--</div>
                </div>
            </div>
        </header>

        <section class="panel">
            <div class="panel-header">
                <h2>Performance Filters</h2>
            </div>
            <div class="filter-bar">
                <div class="filter-control">
                    <label for="granularitySelect">Granularity</label>
                    <select id="granularitySelect">
                        <option value="Week">Week</option>
                        <option value="Bi-Week">Bi-Week</option>
                        <option value="Month">Month</option>
                        <option value="Quarter">Quarter</option>
                        <option value="Year">Year</option>
                    </select>
                </div>
                <div class="filter-control">
                    <label for="periodInput">Period</label>
                    <input id="periodInput" type="text" placeholder="YYYY-W##" />
                </div>
                <div class="filter-control">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" id="applyFilters">
                        <i class="fas fa-filter"></i> Apply
                    </button>
                </div>
            </div>
        </section>

        <div class="detail-content">
            <div class="primary-column">
                <section class="panel">
                    <div class="panel-header">
                        <h2>OKR Category Performance</h2>
                    </div>
                    <div id="categoryContainer" class="metrics-grid">
                        <div class="empty-state">No metrics available yet.</div>
                    </div>
                </section>

                <section class="panel">
                    <div class="panel-header">
                        <h2>Campaign Narrative</h2>
                    </div>
                    <div id="campaignNarrative" class="campaign-narrative">
                        Additional context will appear here once data loads.
                    </div>
                </section>
            </div>

            <aside class="secondary-column">
                <section class="panel">
                    <div class="panel-header">
                        <h2>Agent Roster</h2>
                        <span id="agentCount" class="status-badge status-good">--</span>
                    </div>
                    <ul id="agentList" class="agent-list">
                        <li class="empty-state">No agents available.</li>
                    </ul>
                </section>

                <section class="panel">
                    <div class="panel-header">
                        <h2>Alerts &amp; Calls to Action</h2>
                    </div>
                    <div id="alertsList" class="alerts-list">
                        <div class="empty-state">No alerts for this campaign.</div>
                    </div>
                </section>
            </aside>
        </div>
    </div>

    <script>
        class CampaignDetailController {
            constructor() {
                this.campaignName = this.resolveCampaignName();
                const initialGranularity = this.getInitialGranularity();
                const initialPeriod = this.getInitialPeriod(initialGranularity);
                this.filters = {
                    granularity: initialGranularity,
                    period: initialPeriod,
                    campaign: this.campaignName,
                    agent: ''
                };
                this.currentData = null;

                this.init();
            }

            resolveCampaignName() {
                const params = new URLSearchParams(window.location.search);
                const fromQuery = params.get('campaign') || '';
                if (fromQuery) {
                    return decodeURIComponent(fromQuery);
                }
                const injected = typeof selectedCampaign === 'string' ? selectedCampaign : '';
                return injected || '';
            }

            getInitialGranularity() {
                const params = new URLSearchParams(window.location.search);
                return params.get('granularity') || (typeof granularity === 'string' ? granularity : 'Week');
            }

            getInitialPeriod(granularityHint) {
                const params = new URLSearchParams(window.location.search);
                const candidate = params.get('period') || (typeof period === 'string' ? period : '');
                return candidate || this.getCurrentPeriod(granularityHint || 'Week');
            }

            init() {
                this.cacheElements();
                this.registerEvents();
                this.bootstrapUI();
                if (this.campaignName) {
                    this.loadData(true);
                } else {
                    this.showError('No campaign specified. Return to the overview to choose a campaign.');
                }
            }

            cacheElements() {
                this.dom = {
                    title: document.getElementById('campaignTitle'),
                    subtitle: document.getElementById('campaignSubtitle'),
                    status: document.getElementById('campaignStatus'),
                    score: document.getElementById('statScore'),
                    grade: document.getElementById('statGrade'),
                    agents: document.getElementById('statAgents'),
                    calls: document.getElementById('statCalls'),
                    lastUpdated: document.getElementById('lastUpdatedLabel'),
                    granularity: document.getElementById('granularitySelect'),
                    period: document.getElementById('periodInput'),
                    apply: document.getElementById('applyFilters'),
                    refresh: document.getElementById('refreshCampaign'),
                    back: document.getElementById('backToOverview'),
                    categoryContainer: document.getElementById('categoryContainer'),
                    narrative: document.getElementById('campaignNarrative'),
                    agentList: document.getElementById('agentList'),
                    agentCount: document.getElementById('agentCount'),
                    alertsList: document.getElementById('alertsList')
                };
            }

            registerEvents() {
                this.dom.apply?.addEventListener('click', () => {
                    this.filters.granularity = this.dom.granularity?.value || 'Week';
                    this.filters.period = (this.dom.period?.value || '').trim() || this.getCurrentPeriod(this.filters.granularity);
                    this.loadData(true);
                });

                this.dom.refresh?.addEventListener('click', () => this.loadData(true));

                this.dom.back?.addEventListener('click', () => {
                    const params = new URLSearchParams();
                    params.set('page', 'dashboard');
                    if (this.filters.granularity) params.set('granularity', this.filters.granularity);
                    if (this.filters.period) params.set('period', this.filters.period);
                    window.location.href = `?${params.toString()}`;
                });
            }

            bootstrapUI() {
                if (this.dom.title) this.dom.title.textContent = this.campaignName || 'Campaign Overview';
                if (this.dom.subtitle) this.dom.subtitle.textContent = 'Review the OKR performance, roster, and alerts for this campaign.';
                if (this.dom.granularity) this.dom.granularity.value = this.filters.granularity;
                if (this.dom.period) this.dom.period.value = this.filters.period;
                if (this.dom.status) {
                    this.dom.status.classList.remove('status-good', 'status-excellent', 'status-needs_improvement');
                    this.dom.status.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i><span>Loading status…</span>';
                }
            }

            loadData(showLoader = false) {
                if (!this.campaignName) {
                    this.showError('Missing campaign name.');
                    return;
                }

                if (showLoader) this.toggleLoader(true);

                if (typeof google === 'undefined' || !google.script || !google.script.run) {
                    if (showLoader) this.toggleLoader(false);
                    this.showError('Google Apps Script connection unavailable.');
                    return;
                }

                google.script.run
                    .withSuccessHandler((response) => {
                        if (showLoader) this.toggleLoader(false);
                        this.handleDataSuccess(response);
                    })
                    .withFailureHandler((error) => {
                        if (showLoader) this.toggleLoader(false);
                        this.handleDataError(error);
                    })
                    .clientGetOKRDataEnhanced(
                        this.filters.granularity,
                        this.filters.period,
                        this.filters.agent,
                        this.campaignName,
                        ''
                    );
            }

            handleDataSuccess(response) {
                try {
                    if (!response || !response.success) {
                        throw new Error(response?.error || 'Failed to load campaign data');
                    }

                    const data = response.data || {};
                    const campaign = this.findCampaign(data);
                    if (!campaign) {
                        this.showEmptyState();
                        return;
                    }

                    this.currentData = { data, campaign };
                    this.updateHeader(campaign);
                    this.renderCategories(campaign, data);
                    this.renderNarrative(campaign);
                    this.renderAgents(campaign);
                    this.renderAlerts(campaign, data.alerts);

                } catch (error) {
                    this.handleDataError(error);
                }
            }

            handleDataError(error) {
                console.error('Campaign detail error:', error);
                this.showError(error?.message || 'Unable to load campaign data.');
            }

            findCampaign(data) {
                if (!data || !Array.isArray(data.campaigns)) return null;
                const target = (this.campaignName || '').toLowerCase();
                const exact = data.campaigns.find(c => String(c.name || '').toLowerCase() === target);
                return exact || data.campaigns[0] || null;
            }

            updateHeader(campaign) {
                const overall = campaign.overall || {};
                const status = overall.status || 'needs_improvement';
                const scoreValue = this.formatScore(overall.score);
                const gradeValue = overall.grade || '--';

                if (this.dom.title) this.dom.title.textContent = campaign.name || this.campaignName;
                if (this.dom.subtitle) this.dom.subtitle.textContent = campaign.description || 'Operational OKR performance overview.';

                if (this.dom.status) {
                    this.dom.status.classList.remove('status-good', 'status-excellent', 'status-needs_improvement');
                    this.dom.status.classList.add(`status-${status}`);
                    this.dom.status.innerHTML = `<i class="fas fa-chart-line"></i><span>${this.titleCase(status.replace('_', ' '))}</span>`;
                }

                if (this.dom.score) this.dom.score.textContent = scoreValue;
                if (this.dom.grade) this.dom.grade.textContent = gradeValue;
                if (this.dom.agents) this.dom.agents.textContent = this.safeNumber(campaign.agents);
                if (this.dom.calls) this.dom.calls.textContent = this.safeNumber(campaign.calls);

                if (this.dom.lastUpdated) {
                    const now = new Date();
                    this.dom.lastUpdated.textContent = `Last refreshed ${now.toLocaleString()}`;
                }
            }

            renderCategories(campaign, data) {
                const container = this.dom.categoryContainer;
                if (!container) return;

                const categories = ['productivity', 'quality', 'efficiency', 'engagement', 'growth'];
                container.innerHTML = '';

                categories.forEach((key) => {
                    const detail = campaign.categoryMetrics?.[key] || data[key] || null;
                    container.appendChild(this.buildCategoryCard(key, detail));
                });
            }

            buildCategoryCard(key, detail) {
                const card = document.createElement('div');
                card.className = 'category-card';

                const header = document.createElement('div');
                header.className = 'category-header';

                const title = document.createElement('h3');
                title.textContent = detail?.title || this.titleCase(key);
                header.appendChild(title);

                const statusBadge = document.createElement('span');
                const status = this.resolveCategoryStatus(detail);
                statusBadge.className = `status-badge status-${status}`;
                statusBadge.textContent = this.titleCase(status.replace('_', ' '));
                header.appendChild(statusBadge);

                card.appendChild(header);

                const metricsContainer = document.createElement('div');
                metricsContainer.className = 'metric-rows';

                const metrics = detail?.metrics || {};
                const entries = Object.entries(metrics);

                if (!entries.length) {
                    const empty = document.createElement('div');
                    empty.className = 'empty-state';
                    empty.textContent = 'No metrics available for this category.';
                    metricsContainer.appendChild(empty);
                } else {
                    entries.forEach(([name, metric]) => {
                        metricsContainer.appendChild(this.buildMetricRow(name, metric));
                    });
                }

                card.appendChild(metricsContainer);
                return card;
            }

            buildMetricRow(name, metric) {
                const row = document.createElement('div');
                row.className = 'metric-row';

                const nameEl = document.createElement('div');
                nameEl.className = 'metric-name';
                nameEl.textContent = name;
                row.appendChild(nameEl);

                const targets = document.createElement('div');
                targets.className = 'metric-targets';
                const current = document.createElement('span');
                current.textContent = `Current: ${this.formatMetricValue(metric?.current)}`;
                const target = document.createElement('span');
                target.textContent = `Target: ${this.formatMetricValue(metric?.target)}`;
                targets.appendChild(current);
                targets.appendChild(target);
                row.appendChild(targets);

                const progress = document.createElement('div');
                progress.className = 'progress-bar';
                const progressInner = document.createElement('span');
                const status = metric?.status || 'needs_improvement';
                progressInner.className = `progress-${status}`;
                const pct = Math.max(0, Math.min(100, Number(metric?.percentage) || 0));
                progressInner.style.width = pct + '%';
                progress.appendChild(progressInner);

                row.appendChild(progress);
                return row;
            }

            renderNarrative(campaign) {
                if (!this.dom.narrative) return;

                const lines = [];
                if (campaign.department) {
                    lines.push(`Department: <strong>${this.escapeHtml(campaign.department)}</strong>`);
                }
                if (campaign.calls !== undefined) {
                    lines.push(`Total calls analysed: <strong>${this.safeNumber(campaign.calls)}</strong>`);
                }
                if (campaign.agents !== undefined) {
                    lines.push(`Active agents contributing to OKRs: <strong>${this.safeNumber(campaign.agents)}</strong>`);
                }

                if (!lines.length) {
                    this.dom.narrative.innerHTML = 'No narrative data available for this campaign yet.';
                } else {
                    this.dom.narrative.innerHTML = lines.join('<br>');
                }
            }

            renderAgents(campaign) {
                if (!this.dom.agentList) return;
                const agents = Array.isArray(campaign.agentList) ? campaign.agentList : [];

                this.dom.agentList.innerHTML = '';
                if (!agents.length) {
                    const empty = document.createElement('li');
                    empty.className = 'empty-state';
                    empty.textContent = 'No active agents were found for this campaign.';
                    this.dom.agentList.appendChild(empty);
                } else {
                    agents.forEach(agent => {
                        const li = document.createElement('li');
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-user-circle';
                        li.appendChild(icon);
                        const name = document.createElement('span');
                        name.textContent = agent;
                        li.appendChild(name);
                        this.dom.agentList.appendChild(li);
                    });
                }

                if (this.dom.agentCount) {
                    this.dom.agentCount.classList.remove('status-excellent', 'status-good', 'status-needs_improvement');
                    this.dom.agentCount.classList.add(agents.length ? 'status-good' : 'status-needs_improvement');
                    this.dom.agentCount.textContent = `${agents.length || 0}`;
                }
            }

            renderAlerts(campaign, alerts) {
                if (!this.dom.alertsList) return;
                const relevant = Array.isArray(alerts)
                    ? alerts.filter(alert => String(alert.campaign || '').toLowerCase() === String(campaign.name || '').toLowerCase())
                    : [];

                this.dom.alertsList.innerHTML = '';
                if (!relevant.length) {
                    const empty = document.createElement('div');
                    empty.className = 'empty-state';
                    empty.textContent = 'No alerts for this campaign.';
                    this.dom.alertsList.appendChild(empty);
                    return;
                }

                relevant.forEach(alert => {
                    const card = document.createElement('div');
                    card.className = 'alert-item';
                    const title = document.createElement('strong');
                    title.textContent = alert.category || 'Alert';
                    card.appendChild(title);
                    const message = document.createElement('span');
                    message.textContent = alert.message || 'Review required.';
                    card.appendChild(message);
                    const timestamp = document.createElement('span');
                    timestamp.style.fontSize = '0.8rem';
                    timestamp.style.color = '#92400e';
                    timestamp.textContent = alert.timestamp ? new Date(alert.timestamp).toLocaleString() : '';
                    card.appendChild(timestamp);
                    this.dom.alertsList.appendChild(card);
                });
            }

            showEmptyState() {
                if (this.dom.categoryContainer) {
                    this.dom.categoryContainer.innerHTML = '<div class="empty-state">No data returned for this campaign.</div>';
                }
                this.renderNarrative({});
                this.renderAgents({ agentList: [] });
                this.renderAlerts({}, []);
            }

            toggleLoader(show) {
                const loader = window.LuminaLoader;
                if (!loader) return;
                if (show) {
                    loader.show({ title: 'Refreshing campaign detail', detail: 'Fetching the most recent OKR metrics…' });
                } else {
                    loader.hide();
                }
            }

            showError(message) {
                alert(message);
            }

            formatScore(value) {
                const num = Number(value);
                if (!isFinite(num)) return '--';
                return `${Math.round(num)}%`;
            }

            formatMetricValue(value) {
                if (value === null || typeof value === 'undefined' || value === '') {
                    return '--';
                }
                const num = Number(value);
                if (!isFinite(num)) return String(value);
                if (Math.abs(num) >= 1000) {
                    return `${Math.round(num).toLocaleString()}`;
                }
                return `${Math.round(num * 100) / 100}`;
            }

            safeNumber(value) {
                const num = Number(value);
                if (!isFinite(num)) return '--';
                return num.toLocaleString();
            }

            resolveCategoryStatus(detail) {
                if (detail && typeof detail === 'object') {
                    const metrics = Object.values(detail.metrics || {});
                    if (metrics.length) {
                        const average = metrics.reduce((sum, metric) => sum + (Number(metric.percentage) || 0), 0) / metrics.length;
                        if (average >= 80) return 'excellent';
                        if (average >= 60) return 'good';
                    }
                }
                return 'needs_improvement';
            }

            titleCase(value) {
                return String(value || '')
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            }

            escapeHtml(value) {
                return String(value || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            getCurrentPeriod(granularity, date = null) {
                const target = date ? new Date(date) : new Date();
                switch (granularity) {
                    case 'Day':
                        return target.toISOString().split('T')[0];
                    case 'Week': {
                        const tmp = new Date(target);
                        tmp.setHours(0, 0, 0, 0);
                        tmp.setDate(tmp.getDate() + 4 - (tmp.getDay() || 7));
                        const yearStart = new Date(tmp.getFullYear(), 0, 1);
                        const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
                        return `${tmp.getFullYear()}-W${String(weekNo).padStart(2, '0')}`;
                    }
                    case 'Bi-Week': {
                        const weekKey = this.getCurrentPeriod('Week', target);
                        const [year, rest] = weekKey.split('-W');
                        const biWeek = Math.ceil((Number(rest) || 1) / 2);
                        return `${year}-BW${String(biWeek).padStart(2, '0')}`;
                    }
                    case 'Month':
                        return `${target.getFullYear()}-${String(target.getMonth() + 1).padStart(2, '0')}`;
                    case 'Quarter':
                        return `Q${Math.floor(target.getMonth() / 3) + 1}-${target.getFullYear()}`;
                    case 'Year':
                        return `${target.getFullYear()}`;
                    default:
                        return `${target.getFullYear()}-W01`;
                }
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            window.campaignDetail = new CampaignDetailController();
        });
    </script>
