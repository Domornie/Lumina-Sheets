<?!= include('layout', {
  baseUrl: baseUrl,
  scriptUrl: scriptUrl,
  user: user,
  currentPage: currentPage || 'callreports'
}) ?>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<style>
    /* Enhanced Design System */
    :root {
        /* Modern Brand Colors */
        --primary: #2563eb;
        --primary-light: #3b82f6;
        --primary-dark: #1d4ed8;
        --secondary: #64748b;
        --accent: #06b6d4;
        --accent-light: #22d3ee;
        
        /* Semantic Colors */
        --success: #059669;
        --success-light: #10b981;
        --warning: #d97706;
        --warning-light: #f59e0b;
        --danger: #dc2626;
        --danger-light: #ef4444;
        --info: #0891b2;
        --info-light: #06b6d4;
        
        /* Neutral Palette */
        --gray-50: #f8fafc;
        --gray-100: #f1f5f9;
        --gray-200: #e2e8f0;
        --gray-300: #cbd5e1;
        --gray-400: #94a3b8;
        --gray-500: #64748b;
        --gray-600: #475569;
        --gray-700: #334155;
        --gray-800: #1e293b;
        --gray-900: #0f172a;
        
        /* Enhanced Gradients */
        --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 50%, var(--accent) 100%);
        --gradient-success: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
        --gradient-warning: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);
        --gradient-danger: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
        --gradient-info: linear-gradient(135deg, var(--info) 0%, var(--info-light) 100%);
        --gradient-surface: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        --gradient-glass: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.1) 100%);
        
        /* Enhanced Shadows */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        
        /* Glass Effects */
        --glass-bg: rgba(255, 255, 255, 0.2);
        --glass-border: rgba(255, 255, 255, 0.3);
        --backdrop-blur: blur(20px);
        
        /* Border Radius */
        --radius-sm: 6px;
        --radius: 12px;
        --radius-md: 16px;
        --radius-lg: 20px;
        --radius-xl: 24px;
        --radius-2xl: 32px;
        --radius-full: 9999px;
        
        /* Transitions */
        --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-normal: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-bounce: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        
        /* Typography */
        --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
    }

    /* Reset and Base Styles */
    * {
        box-sizing: border-box;
    }

    body {
        font-family: var(--font-primary);
        background: linear-gradient(135deg, var(--gray-50) 0%, #ffffff 100%);
        color: var(--gray-800);
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .peak-window-list,
    .schedule-planner-container,
    .peak-summary-list {
        margin: 0;
        padding: 0;
        list-style: none;
    }

    .peak-window-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0;
        border-bottom: 1px dashed var(--gray-200);
    }

    .peak-window-list li:last-child {
        border-bottom: none;
    }

    .peak-window-time {
        font-weight: 600;
        color: var(--gray-800);
    }

    .peak-window-load {
        font-size: 0.85rem;
        color: var(--gray-500);
    }

    .schedule-planner-container .schedule-plan-card {
        background: rgba(255, 255, 255, 0.65);
        border-radius: var(--radius);
        border: 1px solid rgba(148, 163, 184, 0.2);
        padding: 1rem 1.1rem;
        box-shadow: var(--shadow-sm);
        margin-bottom: 0.9rem;
    }

    .schedule-plan-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .schedule-plan-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-800);
    }

    .schedule-plan-times {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--primary);
    }

    .schedule-plan-meta {
        font-size: 0.8rem;
        color: var(--gray-500);
        text-align: right;
    }

    .schedule-plan-card dl {
        margin: 0;
    }

    .schedule-plan-card dt {
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--gray-600);
    }

    .schedule-plan-card dd {
        margin: 0 0 0.5rem 0;
        font-size: 0.9rem;
        color: var(--gray-700);
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
    }

    .schedule-plan-note {
        font-size: 0.78rem;
        color: var(--gray-500);
        margin-top: 0.5rem;
    }

    .load-chip {
        display: inline-flex;
        align-items: center;
        padding: 0.2rem 0.55rem;
        border-radius: var(--radius-full);
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.01em;
    }

    .load-chip.load-low {
        background: rgba(16, 185, 129, 0.12);
        color: #047857;
    }

    .load-chip.load-moderate {
        background: rgba(234, 179, 8, 0.18);
        color: #b45309;
    }

    .load-chip.load-high {
        background: rgba(239, 68, 68, 0.18);
        color: #b91c1c;
    }

    .peak-summary-list li {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.55rem 0;
        border-bottom: 1px dashed var(--gray-200);
    }

    .peak-summary-list li:last-child {
        border-bottom: none;
    }

    .peak-summary-list i {
        margin-top: 0.15rem;
    }

    /* Enhanced Typography */
    h1, h2, h3, h4, h5, h6 {
        font-weight: 700;
        line-height: 1.2;
        letter-spacing: -0.025em;
        margin-bottom: 1rem;
    }

    h1 { font-size: clamp(2rem, 4vw, 3rem); }
    h2 { font-size: clamp(1.5rem, 3vw, 2.25rem); }
    h3 { font-size: clamp(1.25rem, 2.5vw, 1.875rem); }
    h4 { font-size: clamp(1.125rem, 2vw, 1.5rem); }
    h5 { font-size: clamp(1rem, 1.5vw, 1.25rem); }

    /* Enhanced Page Header */
    .modern-page-header {
        background: var(--gradient-primary);
        border-radius: var(--radius-2xl);
        padding: 3rem 2rem;
        margin-bottom: 3rem;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow-2xl);
    }

    .modern-page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
    }

    .modern-page-header::after {
        content: '';
        position: absolute;
        bottom: -30%;
        left: -5%;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 50%;
        animation: float 8s ease-in-out infinite reverse;
    }

    @keyframes float {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        33% { transform: translate(30px, -30px) rotate(120deg); }
        66% { transform: translate(-20px, 20px) rotate(240deg); }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(12px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modern-page-header h1 {
        margin: 0 0 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 1rem;
        position: relative;
        z-index: 2;
    }

    .modern-page-header h1 i {
        font-size: 0.8em;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.2);
        border-radius: var(--radius);
        backdrop-filter: var(--backdrop-blur);
    }

    .modern-page-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 1.1rem;
        font-weight: 400;
        position: relative;
        z-index: 2;
    }

    .modern-page-header .d-flex {
        position: relative;
        z-index: 2;
    }

    /* Enhanced Controls Bar */
    .align-items-center.px-4.py-3 {
        background: var(--glass-bg);
        backdrop-filter: var(--backdrop-blur);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-xl);
        padding: 1.5rem 2rem !important;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-lg);
        position: sticky;
        top: 1rem;
        z-index: 100;
    }

    .form-select,
    .form-control {
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: var(--backdrop-blur);
        border-radius: var(--radius);
        font-size: 0.875rem;
        font-weight: 500;
        transition: var(--transition-normal);
        box-shadow: var(--shadow-sm);
    }

    .form-select:focus,
    .form-control:focus {
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        outline: none;
        background: white;
    }

    /* Enhanced KPI Cards */
    .kpi-card {
        background: var(--gradient-surface);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-xl);
        padding: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: var(--transition-normal);
        box-shadow: var(--shadow-md);
        cursor: pointer;
        margin-bottom: 2rem;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
        transform: scaleX(0);
        transition: var(--transition-normal);
        transform-origin: left;
    }

    .kpi-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: var(--shadow-2xl);
        border-color: var(--primary-light);
    }

    .kpi-card:hover::before {
        transform: scaleX(1);
    }

    .kpi-card .value {
        font-size: clamp(2rem, 4vw, 3rem);
        font-weight: 800;
        background: linear-gradient(135deg, var(--gray-800), var(--primary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 1rem 0 0.5rem;
        line-height: 1;
    }

    .kpi-card .label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    /* Enhanced Card Styles */
    .card {
        background: var(--gradient-surface);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-xl);
        overflow: hidden;
        transition: var(--transition-normal);
        box-shadow: var(--shadow-md);
        position: relative;
        margin-bottom: 3rem;
    }

    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--gradient-info);
        transform: scaleX(0);
        transition: var(--transition-normal);
        transform-origin: left;
    }

    .card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
        border-color: var(--gray-300);
    }

    .card:hover::before {
        transform: scaleX(1);
    }

    .card-header {
        padding: 1.5rem 2rem 1rem;
        border-bottom: 1px solid var(--gray-200);
        background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(248,250,252,0.8) 100%);
    }

    .card-header h5 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--gray-800);
        letter-spacing: -0.025em;
        line-height: 1.4;
    }

    .card-header h5 i {
        width: 2rem;
        height: 2rem;
        background: var(--gradient-primary);
        color: white;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        flex-shrink: 0;
    }

    .card-header h5 small {
        display: block;
        font-size: 0.75rem;
        color: var(--gray-500);
        font-weight: 500;
        margin-top: 0.25rem;
    }

    .card-body {
        padding: 2rem;
    }

    /* Enhanced Chart Containers */
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        background: var(--gradient-surface);
        border-radius: var(--radius);
        padding: 1rem;
        margin: 0.5rem 0;
    }

    .call-load-chart-container {
        height: clamp(280px, 45vh, 360px);
        margin: 0;
    }

    /* Enhanced Buttons */
    .btn {
        border-radius: var(--radius);
        font-weight: 600;
        letter-spacing: -0.025em;
        transition: var(--transition-normal);
        border: none;
        position: relative;
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.6s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn-primary {
        background: var(--gradient-primary);
        box-shadow: var(--shadow-md);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        color: white;
        background: var(--gradient-primary);
    }

    .btn-secondary {
        background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
        box-shadow: var(--shadow-md);
        color: white;
    }

    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        color: white;
        background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
    }

    /* Enhanced Table Styles */
    .table-responsive {
        background: white;
        border-radius: var(--radius-lg);
        border: 1px solid var(--gray-200);
        scrollbar-width: thin;
        scrollbar-color: var(--gray-300) transparent;
        max-height: 400px;
        overflow-y: auto;
    }

    .table-responsive::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: transparent;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: var(--gray-300);
        border-radius: 3px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: var(--gray-400);
    }

    .table {
        margin-bottom: 0;
        font-size: 0.875rem;
    }

    .table th {
        background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
        border-bottom: 2px solid var(--gray-200);
        font-weight: 700;
        color: var(--gray-800);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        padding: 1rem 1.5rem;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--gray-100);
        vertical-align: middle;
        color: var(--gray-700);
        transition: var(--transition-fast);
    }

    .table-hover tbody tr:hover {
        background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
        transform: scale(1.01);
    }

    .table-hover tbody tr:hover td {
        color: var(--gray-900);
    }

    /* Enhanced Badges */
    .badge {
        font-weight: 600;
        letter-spacing: 0.025em;
        border-radius: var(--radius-full);
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
    }

    .badge.bg-primary {
        background: var(--gradient-primary) !important;
    }

    .badge.bg-success {
        background: var(--gradient-success) !important;
    }

    .badge.bg-info {
        background: var(--gradient-info) !important;
    }

    /* Enhanced Status Colors */
    .text-success { color: var(--success) !important; }
    .text-danger { color: var(--danger) !important; }
    .text-warning { color: var(--warning) !important; }
    .text-primary { color: var(--primary) !important; }
    .text-info { color: var(--info) !important; }

    /* Enhanced Empty States */
    .text-center.py-3.text-muted {
        color: var(--gray-500) !important;
        font-style: italic;
        padding: 3rem 1rem !important;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .text-center.py-3.text-muted::before {
        content: '📋';
        font-size: 3rem;
        opacity: 0.5;
    }

    /* Enhanced Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes scaleIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .animate-slide-in-right {
        animation: slideInRight 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .animate-slide-in-left {
        animation: slideInLeft 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .animate-scale-in {
        animation: scaleIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    /* Staggered animations */
    .kpi-card:nth-child(1) { animation-delay: 0.1s; }
    .kpi-card:nth-child(2) { animation-delay: 0.2s; }
    .kpi-card:nth-child(3) { animation-delay: 0.3s; }
    .card:nth-child(1) { animation-delay: 0.2s; }
    .card:nth-child(2) { animation-delay: 0.3s; }
    .card:nth-child(3) { animation-delay: 0.4s; }

    /* Enhanced Mobile Responsiveness */
    @media (max-width: 768px) {
        .modern-page-header {
            padding: 2rem 1.5rem;
            margin-bottom: 2rem;
        }

        .modern-page-header h1 {
            font-size: 2rem;
            flex-direction: column;
            text-align: center;
            gap: 0.5rem;
        }

        .align-items-center.px-4.py-3 {
            padding: 1rem 1.5rem !important;
            margin-bottom: 1.5rem;
        }

        .align-items-center.px-4.py-3 .d-flex {
            flex-direction: column;
            gap: 1rem;
        }

        .align-items-center.px-4.py-3 .ms-3,
        .align-items-center.px-4.py-3 .ms-4 {
            margin-left: 0 !important;
        }

        .kpi-card {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card {
            margin-bottom: 2rem;
        }

        .card-header {
            padding: 1rem 1.5rem 0.75rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .chart-container {
            height: 250px;
            padding: 0.5rem;
        }

        .table-responsive {
            max-height: 300px;
        }

        .table th,
        .table td {
            padding: 0.75rem 1rem;
            font-size: 0.8rem;
        }
    }

    @media (max-width: 480px) {
        .modern-page-header {
            padding: 1.5rem 1rem;
        }

        .align-items-center.px-4.py-3 {
            padding: 1rem !important;
        }

        .kpi-card {
            padding: 1.25rem;
        }

        .card-body {
            padding: 1rem;
        }

        .chart-container {
            height: 200px;
        }
    }

    /* Action Buttons */
    .btn-ai {
        background: var(--gradient-info);
        color: #ffffff;
        border: none;
        border-radius: var(--radius-full);
        padding-inline: 1.2rem;
        font-weight: 600;
        box-shadow: var(--shadow-md);
        transition: var(--transition-bounce);
    }

    .btn-ai:hover,
    .btn-ai:focus {
        color: #ffffff;
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
    }

    .btn-outline-glass {
        border-radius: var(--radius-full);
        border: 1px solid rgba(255, 255, 255, 0.6);
        background: rgba(255, 255, 255, 0.45);
        color: var(--gray-700);
        font-weight: 600;
        box-shadow: var(--shadow-md);
        backdrop-filter: blur(12px);
        transition: var(--transition-fast);
    }

    .btn-outline-glass:hover,
    .btn-outline-glass:focus {
        color: var(--gray-800);
        background: rgba(255, 255, 255, 0.85);
        border-color: rgba(37, 99, 235, 0.35);
        transform: translateY(-1px);
    }

    .filter-toolbar .form-select,
    .filter-toolbar .form-control {
        min-width: 160px;
    }

    /* AI Analyzer Panel */
    .ai-analytics-panel {
        background: var(--gradient-surface);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: var(--radius-2xl);
        padding: 2.5rem 2rem;
        margin-bottom: 2.5rem;
        box-shadow: var(--shadow-xl);
        position: relative;
        overflow: hidden;
        animation: fadeIn 0.5s ease;
    }

    .ai-analytics-panel::before {
        content: '';
        position: absolute;
        inset: -40% 60% auto -30%;
        height: 320px;
        background: radial-gradient(circle at center, rgba(37, 99, 235, 0.15), transparent 70%);
        z-index: 0;
    }

    .ai-analytics-panel.active {
        border-color: rgba(37, 99, 235, 0.35);
        box-shadow: var(--shadow-2xl);
    }

    .ai-panel-header {
        position: relative;
        z-index: 1;
    }

    .ai-panel-header h2 {
        font-size: clamp(1.5rem, 3vw, 2.25rem);
        font-weight: 700;
        color: var(--gray-900);
    }

    .ai-confidence-chip {
        background: rgba(14, 165, 233, 0.15);
        border: 1px solid rgba(14, 165, 233, 0.4);
        border-radius: var(--radius-full);
        padding: 0.5rem 1.25rem;
        font-weight: 600;
        color: var(--info);
        box-shadow: var(--shadow-md);
    }

    .ai-metric-card {
        position: relative;
        z-index: 1;
        background: #ffffff;
        border-radius: var(--radius-xl);
        padding: 1.75rem;
        box-shadow: var(--shadow-lg);
        border: 1px solid rgba(148, 163, 184, 0.2);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        min-height: 140px;
        transition: var(--transition-normal);
    }

    .ai-metric-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-xl);
    }

    .ai-metric-card .metric-label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--gray-500);
        font-weight: 600;
    }

    .ai-metric-card .metric-value {
        font-size: clamp(1.5rem, 2.5vw, 2.5rem);
        font-weight: 700;
        color: var(--gray-900);
    }

    .ai-metric-card .metric-subtext {
        font-size: 0.9rem;
        color: var(--gray-600);
    }

    .ai-insight-card {
        position: relative;
        z-index: 1;
        background: rgba(255, 255, 255, 0.92);
        border-radius: var(--radius-xl);
        border: 1px solid rgba(148, 163, 184, 0.2);
        box-shadow: var(--shadow-lg);
        padding: 1.75rem;
        height: 100%;
        backdrop-filter: blur(8px);
    }

    .ai-section-title {
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--gray-700);
    }

    .ai-insight-list {
        margin: 0;
        padding-left: 1.25rem;
        list-style: none;
    }

    .ai-insight-list li {
        position: relative;
        padding-left: 1.75rem;
        margin-bottom: 0.9rem;
        font-weight: 500;
        color: var(--gray-700);
    }

    .ai-insight-list li i {
        position: absolute;
        left: 0;
        top: 0.15rem;
    }

    .ai-insight-list li:last-child {
        margin-bottom: 0;
    }

    .ai-metric-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        background: rgba(37, 99, 235, 0.12);
        color: var(--primary);
        padding: 0.35rem 0.75rem;
        border-radius: var(--radius-full);
        font-size: 0.8rem;
        font-weight: 600;
    }

    @media (max-width: 992px) {
        .filter-toolbar {
            width: 100%;
        }

        .filter-toolbar .form-select,
        .filter-toolbar .form-control {
            width: 100%;
        }

        .ai-analytics-panel {
            padding: 2rem 1.5rem;
        }
    }

    @media (max-width: 576px) {
        .btn-ai,
        .btn-outline-glass,
        #exportCallCsvBtn {
            width: 100%;
            justify-content: center;
        }

        .ai-panel-header h2 {
            font-size: 1.5rem;
        }
    }

    /* Enhanced Focus Styles for Accessibility */
    .btn:focus,
    .form-select:focus,
    .form-control:focus,
    .kpi-card:focus {
        outline: 2px solid var(--primary);
        outline-offset: 2px;
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
        .card,
        .kpi-card {
            border-width: 2px;
        }
    }

</style>

<? const __importCallReportUrl = (function(base) {
      if (!base) {
        return '?page=ImportCsv';
      }

      var hasQuery = base.indexOf('?') !== -1;
      var separator = hasQuery ? (/[?&]$/.test(base) ? '' : '&') : '?';
      return base + separator + 'page=ImportCsv';
    })(typeof baseUrl !== 'undefined' ? baseUrl : '');
?>

<div class="align-items-center px-4 py-3 pb-3 mb-3">
    <div class="d-flex flex-wrap align-items-center gap-3 w-100">
        <!-- Report-Type Switcher -->
        <div class="ms-4" hidden>
            <select id="reportTypeSelect" class="form-select form-select-sm ms-4">
                <option value="Dashboard" <?= currentPage==="Dashboard" ? "selected":"" ?>>📊 Dashboard</option>
                <option value="CallReports" <?= currentPage==="CallReports" ? "selected":"" ?>>📞 Call Reports</option>
                <option value="AttendanceReports" <?= currentPage==="AttendanceReports" ? "selected":"" ?>>⏰ Attendance Reports</option>
                <option value="QualityReports" <?= currentPage==="QualityReports" ? "selected":"" ?>>⭐ Quality Report</option>
                <option value="Incentives" <?= currentPage==="Incentives" ? "selected":"" ?>>🎯 Incentives</option>
            </select>
        </div>

        <div class="d-flex flex-wrap gap-2" role="group" aria-label="Call report actions" data-banner-source>
            <button type="button" class="btn btn-ai btn-sm" id="aiAnalyzerBtn" aria-expanded="false">
                <i class="fas fa-robot me-2"></i><span class="btn-label">AI Analyzer</span>
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="exportCallCsvBtn">
                <i class="fas fa-file-export me-2"></i>Export CSV
            </button>
            <a class="btn btn-outline-glass btn-sm" id="importCallReportsLink" href="<?= __importCallReportUrl ?>">
                <i class="fas fa-file-import me-2"></i>Import Call Reports
            </a>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2 ms-auto filter-toolbar">
            <div>
                <select class="form-select form-select-sm" id="granularitySelect">
                    <option value="Week" selected>📅 Weekly</option>
                    <option value="BiWeekly">📅 Bi-Weekly</option>
                    <option value="Month">📆 Monthly</option>
                    <option value="Quarter">📋 Quarterly</option>
                    <option value="Year">📊 Yearly</option>
                </select>
            </div>

            <!-- AGENT FILTER -->
            <div class="ms-0 ms-sm-2">
                <select class="form-select form-select-sm" id="agentSelect">
                    <option value="">👥 All Agents</option>
                    <? userList.forEach(function(u) { ?>
                        <option value="<?= u ?>" <?= u === selectedAgent ? "selected" : "" ?>>
                            <?= u ?>
                        </option>
                    <? }); ?>
                </select>
            </div>

            <!-- PERIOD PICKERS -->
            <div class="ms-0 ms-sm-2" id="weekPicker" style="display: none;">
                <input type="week" class="form-control form-control-sm" id="weekInput" />
            </div>
            <div class="ms-0 ms-sm-2" id="biWeekPicker" style="display: none;">
                <select class="form-select form-select-sm" id="biWeekSelect"></select>
            </div>
            <div class="ms-0 ms-sm-2" id="monthPicker" style="display: none;">
                <input type="month" class="form-control form-control-sm" id="monthInput" />
            </div>
            <div class="ms-0 ms-sm-2" id="quarterPicker" style="display: none;">
                <div class="d-flex">
                    <select class="form-select form-select-sm" id="quarterSelect">
                        <option value="Q1">Q1</option>
                        <option value="Q2">Q2</option>
                        <option value="Q3">Q3</option>
                        <option value="Q4">Q4</option>
                    </select>
                    <input
                        type="number"
                        class="form-control form-control-sm ms-2"
                        id="quarterYearInput"
                        placeholder="YYYY"
                        min="2000"
                        max="2100"
                        style="width: 80px;"
                    />
                </div>
            </div>
            <div class="ms-0 ms-sm-2" id="yearPicker" style="display: none;">
                <input type="number"
                    class="form-control form-control-sm"
                    id="yearInput"
                    placeholder="YYYY"
                    min="2000"
                    max="2100"/>
            </div>
        </div>
    </div>
</div>

<div id="aiInsightPanel" class="ai-analytics-panel d-none" aria-hidden="true">
    <div class="ai-panel-header d-flex flex-wrap justify-content-between align-items-start gap-3">
        <div>
            <h2 class="mb-1"><i class="fas fa-robot me-2"></i>AI Call Performance Analyzer</h2>
            <p class="mb-0">Autonomous insights synthesised from your imported call reports and live metrics.</p>
        </div>
        <div class="ai-confidence-chip" id="aiConfidenceChip">Confidence: Collecting data…</div>
    </div>
    <div class="row g-3 mt-2" id="aiSummaryStats">
        <!-- Dynamically populated -->
    </div>
    <div class="row g-3 mt-1">
        <div class="col-lg-6">
            <div class="ai-insight-card">
                <h6 class="ai-section-title"><i class="fas fa-lightbulb me-2 text-warning"></i>Key Insights</h6>
                <ul class="ai-insight-list" id="aiInsightList">
                    <li class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Insights will appear once data loads.</li>
                </ul>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="ai-insight-card">
                <h6 class="ai-section-title"><i class="fas fa-magic me-2 text-primary"></i>AI Recommendations</h6>
                <ul class="ai-insight-list" id="aiRecommendationList">
                    <li class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Recommendations will appear once data loads.</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="row g-3 mt-1">
        <div class="col-lg-6">
            <div class="ai-insight-card">
                <h6 class="ai-section-title"><i class="fas fa-clock me-2 text-info"></i>Peak Call Windows</h6>
                <ul class="peak-window-list" id="peakWindowList">
                    <li class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading peak windows…</li>
                </ul>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="ai-insight-card">
                <h6 class="ai-section-title"><i class="fas fa-utensils me-2 text-success"></i>Break & Lunch Planner</h6>
                <div id="schedulePlannerContainer" class="schedule-planner-container text-muted">Recommendations will appear once data loads.</div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced KPI Cards -->
<div class="row gx-4 mb-4 animate-fade-in-up">
    <div class="col-lg-3 col-md-6">
        <div class="kpi-card" tabindex="0" role="button" aria-label="Total calls metric">
            <div class="label">Total Calls</div>
            <div class="value" id="kpiTotalCalls">0</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="kpi-card" tabindex="0" role="button" aria-label="Customer satisfaction metric">
            <div class="label">Average CSAT (% Yes)</div>
            <div class="value" id="kpiAvgCsat">0%</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="kpi-card" tabindex="0" role="button" aria-label="Average talk time metric">
            <div class="label">Average Talk Time</div>
            <div class="value" id="kpiAvgTalkTime">0 min</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="kpi-card" tabindex="0" role="button" aria-label="Weekly peak call window metric">
            <div class="label">Weekly Peak Call Window</div>
            <div class="value" id="kpiWeeklyPeakWindow">—</div>
        </div>
    </div>
</div>

<!-- Enhanced Distribution Charts Row -->
<div class="row gx-4 mb-5 animate-fade-in-up" style="animation-delay: 0.1s;">
    <!-- Call Distribution (Policy) -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-stream"></i>
                    Call Distribution<br/>
                    <small>By Policy</small>
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="policyDistChart" role="img" aria-label="Policy distribution chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Distribution (Wrapup) -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-tags"></i>
                    Call Distribution<br/>
                    <small>By Wrapup</small>
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="wrapupDistChart" role="img" aria-label="Wrapup distribution chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- CSAT Distribution -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="fas fa-smile"></i>
                    CSAT Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="csatDistChart" role="img" aria-label="CSAT distribution chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Time-of-Day Analyzer -->
<div class="row gx-4 mb-5 animate-fade-in-up" style="animation-delay: 0.2s;">
    <div class="col-xl-7">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-1"><i class="fas fa-chart-bar me-2 text-primary"></i>Call Load by Time of Day</h5>
                <p class="mb-0 text-muted">Historic call volume aggregated by hour to highlight demand spikes and quiet windows.</p>
            </div>
            <div class="card-body">
                <div class="chart-container call-load-chart-container">
                    <canvas id="callLoadByHourChart" role="img" aria-label="Call load by hour chart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-5">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-1"><i class="fas fa-calendar-check me-2 text-success"></i>Peak Coverage Summary</h5>
                <p class="mb-0 text-muted">Key scheduling notes derived from the latest call history.</p>
            </div>
            <div class="card-body">
                <ul class="peak-summary-list" id="peakSummaryList">
                    <li class="text-muted"><i class="fas fa-info-circle me-2"></i>Summary will appear once data loads.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Trend Charts Row -->
<div class="row gx-4 mb-5 animate-slide-in-right" style="animation-delay: 0.3s;">
    <!-- Call Trend -->
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i>Call Trend</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="callTrendChart" role="img" aria-label="Call volume trend chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Talk Time Trend -->
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-hourglass-half"></i>Talk Time Trend</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="talkTrendChart" role="img" aria-label="Talk time trend chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Rep Metrics Table -->
<div class="row gx-4 animate-fade-in-left" style="animation-delay: 0.5s;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-users"></i>Rep Metrics</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle" id="repMetricsTable" role="table" aria-label="Agent performance metrics">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Agent</th>
                                <th scope="col">Total Calls</th>
                                <th scope="col">Total Talk</th>
                                <th scope="col">Avg Talk</th>
                                <th scope="col">Avg Answer</th>
                                <th scope="col">≤30s %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Keep all existing server-side variables exactly as they were
  const baseUrl = '<?= baseUrl ?>';
  const callVolumeLast7 = <?= callVolumeLast7 ?>;
  const hourlyHeatmapLast7 = <?= hourlyHeatmapLast7 ?>;
  const avgIntervalByAgentLast7= <?= avgIntervalByAgentLast7 ?>;
  const talkTimeByAgentLast7 = <?= talkTimeByAgentLast7 ?>;
  const wrapupCountsLast7 = <?= wrapupCountsLast7 ?>;
  const csatDistLast7 = <?= csatDistLast7 ?>;
  const policyCountsLast7 = <?= policyCountsLast7 ?>;
  const agentLeaderboardLast7 = <?= agentLeaderboardLast7 ?>;

  // Chart.js instances
  let policyDistChart = null;
  let wrapupDistChart = null;
  let callTrendChart = null;
  let talkTrendChart = null;
  let csatChart = null;
  let callLoadByHourChart = null;

  // Current filters - keep exactly as before
  let currentGran = "Week";
  let currentPeriod = "<?= selectedPeriod ?>"; // initial ISO week, e.g. "2025-W23"
  let currentAgent = "<?= selectedAgent ?>";  // initial agent filter (probably "")

  // Enhanced Chart.js defaults
  function setupChartDefaults() {
    Chart.defaults.font.family = 'Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
    Chart.defaults.color = '#64748b';
    Chart.defaults.borderColor = '#e2e8f0';
    Chart.defaults.backgroundColor = 'rgba(37, 99, 235, 0.1)';
    
    Chart.defaults.plugins.legend.labels.usePointStyle = true;
    Chart.defaults.plugins.legend.labels.pointStyle = 'rect';
    Chart.defaults.plugins.legend.labels.boxWidth = 12;
    Chart.defaults.plugins.legend.labels.boxHeight = 12;
    Chart.defaults.plugins.legend.labels.padding = 15;
    
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15, 23, 42, 0.95)';
    Chart.defaults.plugins.tooltip.titleColor = '#ffffff';
    Chart.defaults.plugins.tooltip.bodyColor = '#ffffff';
    Chart.defaults.plugins.tooltip.borderColor = '#334155';
    Chart.defaults.plugins.tooltip.borderWidth = 1;
    Chart.defaults.plugins.tooltip.cornerRadius = 12;
    Chart.defaults.plugins.tooltip.padding = 16;
    Chart.defaults.plugins.tooltip.displayColors = true;
    Chart.defaults.plugins.tooltip.titleFont = { size: 14, weight: 'bold' };
    Chart.defaults.plugins.tooltip.bodyFont = { size: 13 };
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Setup enhanced chart defaults
    setupChartDefaults();

    // Keep all existing event listeners exactly as they were
    document.getElementById("reportTypeSelect")
      .addEventListener("change", e => {
        const rpt = e.target.value;
        window.location.href = "<?= baseUrl ?>&page=" + rpt;
      });

    const granularitySelect = document.getElementById("granularitySelect");
    granularitySelect.addEventListener("change", onGranChange);
    currentGran = granularitySelect.value || currentGran;

    document.getElementById("agentSelect")
      .addEventListener("change", e => {
        currentAgent = e.target.value;
        triggerLoadAnalytics();
      });

    // Keep all existing period picker event listeners
    const wk = document.getElementById("weekInput");
    wk.addEventListener("change", () => {
      currentPeriod = wk.value;
      triggerLoadAnalytics();
    });

    const bi = document.getElementById("biWeekSelect");
    bi.addEventListener("change", () => {
      currentPeriod = bi.value;
      triggerLoadAnalytics();
    });

    const m = document.getElementById("monthInput");
    m.addEventListener("change", () => {
      currentPeriod = m.value;
      triggerLoadAnalytics();
    });

    const qs = document.getElementById("quarterSelect");
    const qy = document.getElementById("quarterYearInput");
    qs.addEventListener("change", () => {
      if (qy.value) {
        currentPeriod = `${qs.value}-${qy.value}`;
        triggerLoadAnalytics();
      }
    });
    qy.addEventListener("change", () => {
      if (qs.value) {
        currentPeriod = `${qs.value}-${qy.value}`;
        triggerLoadAnalytics();
      }
    });

    const yr = document.getElementById("yearInput");
    yr.addEventListener("change", () => {
      currentPeriod = yr.value;
      triggerLoadAnalytics();
    });

    // Keep existing picker initialization
    document.getElementById("weekPicker").style.display = "none";
    document.getElementById("biWeekPicker").style.display = "none";
    document.getElementById("monthPicker").style.display = "none";
    document.getElementById("quarterPicker").style.display = "none";
    document.getElementById("yearPicker").style.display = "none";

    populateBiWeeklyOptions();

    const today = new Date();
    const weekPattern = /^\d{4}-W\d{2}$/i;
    if (currentPeriod && weekPattern.test(currentPeriod)) {
      wk.value = currentPeriod;
    } else {
      const isoWeek = weekStringFromDate(today);
      wk.value = isoWeek;
      if (!currentPeriod || !currentPeriod.length) {
        currentPeriod = isoWeek;
      }
    }
    document.getElementById("weekPicker").style.display = "block";

    document
      .getElementById("exportCallCsvBtn")
      .addEventListener("click", () => {
        const url = baseUrl
          + "&page=CallReports"
          + "&action=exportCallCsv"
          + "&granularity=" + encodeURIComponent(currentGran)
          + "&period=" + encodeURIComponent(currentPeriod)
          + "&agent=" + encodeURIComponent(currentAgent);
        window.open(url, "_blank");
      });

    const aiAnalyzerBtn = document.getElementById("aiAnalyzerBtn");
    const aiInsightPanel = document.getElementById("aiInsightPanel");
    if (aiAnalyzerBtn && aiInsightPanel) {
      aiInsightPanel.setAttribute("aria-hidden", "true");
      aiAnalyzerBtn.addEventListener("click", () => {
        const isHidden = aiInsightPanel.classList.toggle("d-none");
        const expanded = !isHidden;
        aiAnalyzerBtn.setAttribute("aria-expanded", expanded.toString());
        aiInsightPanel.setAttribute("aria-hidden", (!expanded).toString());
        aiInsightPanel.classList.toggle("active", expanded);

        const label = aiAnalyzerBtn.querySelector('.btn-label');
        if (label) {
          label.textContent = expanded ? 'Hide AI Analyzer' : 'AI Analyzer';
        }

        if (expanded) {
          aiInsightPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });
    }

    // Add enhanced keyboard navigation
    document.querySelectorAll('.kpi-card').forEach(card => {
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          // Add visual feedback
          card.style.transform = 'scale(0.98)';
          setTimeout(() => {
            card.style.transform = '';
          }, 150);
          showToast('KPI details view would open here', 'info');
        }
      });
    });

    // Load initial analytics - keep existing function call
    loadAnalytics(currentGran, currentPeriod, currentAgent);
  });

  // Keep all existing functions exactly as they were, just enhance the rendering
  function onGranChange() {
    ["weekPicker", "biWeekPicker", "monthPicker", "quarterPicker", "yearPicker"].forEach(id => {
      document.getElementById(id).style.display = "none";
    });

    currentGran = document.getElementById("granularitySelect").value;

    if (currentGran === "Week") {
      document.getElementById("weekPicker").style.display = "block";
      const wk = document.getElementById("weekInput");
      currentPeriod = wk.value;
    } else if (currentGran === "BiWeekly") {
      document.getElementById("biWeekPicker").style.display = "block";
      const bi = document.getElementById("biWeekSelect");
      if (!bi.options.length) {
        populateBiWeeklyOptions();
      }
      currentPeriod = bi.value;
    } else if (currentGran === "Month") {
      document.getElementById("monthPicker").style.display = "block";
      const m = document.getElementById("monthInput");
      currentPeriod = m.value;
    } else if (currentGran === "Quarter") {
      document.getElementById("quarterPicker").style.display = "block";
      const qs = document.getElementById("quarterSelect");
      const qy = document.getElementById("quarterYearInput");
      if (qs.value && qy.value) {
        currentPeriod = `${qs.value}-${qy.value}`;
      } else {
        currentPeriod = "";
      }
    } else if (currentGran === "Year") {
      document.getElementById("yearPicker").style.display = "block";
      const yr = document.getElementById("yearInput");
      currentPeriod = yr.value;
    }

    triggerLoadAnalytics();
  }

  function triggerLoadAnalytics() {
    loadAnalytics(currentGran, currentPeriod, currentAgent);
  }

  function renderEverything(analytics) {
    renderAiInsights(analytics);
    renderKpiCards(analytics);
    renderPolicyDistChart(analytics.policyDist);
    renderWrapupDistChart(analytics.wrapDist);
    renderCsatChart(analytics.csatDist);
    renderCallTrendChart(analytics.callTrend);
    renderTalkTrendChart(analytics.talkTrend);
    renderTimeOfDayInsights(analytics);
    renderRepMetricsTable(analytics.repMetrics);
  }

  function renderAiInsights(analytics = {}) {
    const summaryContainer = document.getElementById("aiSummaryStats");
    const insightList = document.getElementById("aiInsightList");
    const recommendationList = document.getElementById("aiRecommendationList");
    const confidenceChip = document.getElementById("aiConfidenceChip");

    if (!summaryContainer || !insightList || !recommendationList) {
      return;
    }

    const repMetrics = Array.isArray(analytics.repMetrics) ? analytics.repMetrics : [];
    const callTrend = Array.isArray(analytics.callTrend) ? analytics.callTrend : [];
    const talkTrend = Array.isArray(analytics.talkTrend) ? analytics.talkTrend : [];
    const wrapDist = Array.isArray(analytics.wrapDist) ? analytics.wrapDist : [];
    const policyDist = Array.isArray(analytics.policyDist) ? analytics.policyDist : [];
    const csatDist = Array.isArray(analytics.csatDist) ? analytics.csatDist : [];
    const hourlyVolume = Array.isArray(analytics.hourlyVolume) ? analytics.hourlyVolume : [];
    const peakTimeWindows = Array.isArray(analytics.peakTimeWindows) ? analytics.peakTimeWindows : [];
    const scheduleRecommendations = Array.isArray(analytics.scheduleRecommendations) ? analytics.scheduleRecommendations : [];
    const callActivityWindow = analytics.callActivityWindow || null;
    const totalCalls = repMetrics.reduce((sum, r) => sum + (Number(r.totalCalls) || 0), 0);
    const totalTalkMinutes = talkTrend.reduce((sum, entry) => sum + (Number(entry.totalTalk) || 0), 0);
    const avgTalkMinutes = totalCalls > 0 ? totalTalkMinutes / totalCalls : 0;

    const yesCount = csatDist.reduce((sum, entry) => {
      const label = String(entry.csat ?? '').toLowerCase();
      return label === 'yes' || label === 'y' || label === 'positive'
        ? sum + (Number(entry.count) || 0)
        : sum;
    }, 0);
    const totalCsatResponses = csatDist.reduce((sum, entry) => sum + (Number(entry.count) || 0), 0);
    const noCount = Math.max(totalCsatResponses - yesCount, 0);
    const yesRate = totalCsatResponses > 0 ? (yesCount / totalCsatResponses) * 100 : 0;

    const topAgent = repMetrics.reduce((best, item) =>
      (Number(item.totalCalls) || 0) > (Number(best?.totalCalls) || 0) ? item : best
    , null);

    const longestTalkAgent = repMetrics.reduce((best, item) =>
      (Number(item.totalTalk) || 0) > (Number(best?.totalTalk) || 0) ? item : best
    , null);

    const wrapTotal = wrapDist.reduce((sum, entry) => sum + (Number(entry.count) || 0), 0);
    const topWrap = wrapDist.reduce((best, item) =>
      (Number(item.count) || 0) > (Number(best?.count) || 0) ? item : best
    , null);

    const policyTotal = policyDist.reduce((sum, entry) => sum + (Number(entry.count) || 0), 0);
    const topPolicy = policyDist.reduce((best, item) =>
      (Number(item.count) || 0) > (Number(best?.count) || 0) ? item : best
    , null);

    const normalizedHours = normalizeHourlyVolume(hourlyVolume);
    const workConfig = getWorkWindowConfig();
    const staffingHours = normalizedHours.filter(entry => entry.hour >= workConfig.startHour && entry.hour < workConfig.endHour);
    const hourEvaluationSet = staffingHours.length ? staffingHours : normalizedHours;
    const peakHourlyEntry = hourEvaluationSet.reduce((best, entry) => {
      if (!best) return entry;
      const value = Number(entry.callCount) || 0;
      const bestValue = Number(best.callCount) || 0;
      if (value > bestValue) return entry;
      if (value === bestValue && entry.hour < best.hour) return entry;
      return best;
    }, null);
    const peakHourlyLabel = peakHourlyEntry?.windowLabel || '—';
    const peakHourlyCount = Number(peakHourlyEntry?.callCount) || 0;
    const staffingLabel = `${minutesToTimeLabel(workConfig.startHour * 60)} – ${minutesToTimeLabel(workConfig.endHour * 60)}`;
    const observedWindowLabel = callActivityWindow
      ? `${callActivityWindow.startLabel} – ${callActivityWindow.endLabel}`
      : (peakHourlyCount > 0 ? peakHourlyLabel : '—');
    const coverageDuration = callActivityWindow ? Number(callActivityWindow.durationMinutes || 0) : 0;
    const observedWindowSubtextParts = [];
    if (callActivityWindow && coverageDuration > 0) {
      observedWindowSubtextParts.push(`Coverage ${formatMinutesToReadable(coverageDuration)}`);
    }
    if (peakHourlyCount > 0) {
      observedWindowSubtextParts.push(`Peak ${peakHourlyLabel} (${peakHourlyCount.toLocaleString()} calls)`);
    }
    observedWindowSubtextParts.push(`Staffing ${staffingLabel}`);
    const observedWindowSubtext = observedWindowSubtextParts.join(' • ');

    const busiestPeriod = callTrend.reduce((best, item) =>
      (Number(item.callCount) || 0) > (Number(best?.callCount) || 0) ? item : best
    , null);

    const firstTrend = callTrend.length ? callTrend[0] : null;
    const lastTrend = callTrend.length ? callTrend[callTrend.length - 1] : null;
    const firstCount = Number(firstTrend?.callCount) || 0;
    const lastCount = Number(lastTrend?.callCount) || 0;
    const callDelta = lastCount - firstCount;
    const callDeltaPct = firstCount ? (callDelta / firstCount) * 100 : (lastCount ? 100 : 0);

    const volumeTrendDescriptor = callTrend.length > 1
      ? `${callDelta > 0 ? '▲' : callDelta < 0 ? '▼' : '■'} ${Math.abs(callDelta).toLocaleString()} calls (${Math.abs(callDeltaPct).toFixed(1)}%)`
      : 'Stable range';
    const peakPeriodLabel = busiestPeriod?.periodLabel || 'N/A';
    const peakPeriodCount = Number(busiestPeriod?.callCount) || 0;

    const talkLeader = topAgent
      ? `Top: ${topAgent.agent} (${Number(topAgent.totalCalls || 0).toLocaleString()} calls)`
      : 'No leader yet';
    const talkSummary = totalTalkMinutes
      ? `Total: ${formatMinutesToReadable(totalTalkMinutes)}`
      : 'Awaiting talk data';

    summaryContainer.innerHTML = `
      <div class="col-lg-3 col-md-6">
        <div class="ai-metric-card">
          <div class="metric-label">Total Calls Analyzed</div>
          <div class="metric-value">${totalCalls.toLocaleString()}</div>
          <div class="metric-subtext">Trend: ${volumeTrendDescriptor} • Peak: ${peakPeriodLabel}</div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="ai-metric-card">
          <div class="metric-label">Yes Conversion</div>
          <div class="metric-value">${yesRate.toFixed(1)}%</div>
          <div class="metric-subtext">Yes: ${yesCount.toLocaleString()} • No: ${noCount.toLocaleString()}</div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="ai-metric-card">
          <div class="metric-label">Observed Call Window</div>
          <div class="metric-value">${observedWindowLabel}</div>
          <div class="metric-subtext">${observedWindowSubtext}</div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="ai-metric-card">
          <div class="metric-label">Engagement Highlights</div>
          <div class="metric-value">${formatMinutesToReadable(avgTalkMinutes)}</div>
          <div class="metric-subtext">${talkLeader} • ${talkSummary}</div>
        </div>
      </div>
    `;

    if (confidenceChip) {
      if (totalCalls > 0) {
        const confidenceScore = Math.min(98, Math.round(60 + Math.min(totalCalls, 1500) / 15));
        confidenceChip.textContent = `Confidence: ${confidenceScore}%`;
      } else {
        confidenceChip.textContent = 'Confidence: Collecting data…';
      }
    }

    const busiestHourEntry = peakHourlyEntry;

    const quietHourEntry = hourEvaluationSet.reduce((best, entry) => {
      if (!best) return entry;
      const value = Number(entry.callCount) || 0;
      const bestValue = Number(best.callCount) || 0;
      if (value < bestValue) return entry;
      if (value === bestValue && entry.hour < best.hour) return entry;
      return best;
    }, null) || null;

    const insights = [];

    if (totalCsatResponses > 0) {
      insights.push(`Yes conversion is <strong>${yesRate.toFixed(1)}%</strong> (${yesCount.toLocaleString()} yes vs ${noCount.toLocaleString()} no).`);
    } else if (totalCalls > 0) {
      insights.push(`Analyzed <strong>${totalCalls.toLocaleString()}</strong> calls with no CSAT responses recorded.`);
    }

    if (callTrend.length > 1) {
      const direction = callDelta > 0 ? 'increased' : callDelta < 0 ? 'decreased' : 'remained stable';
      const deltaText = callDelta === 0
        ? 'remained stable across the selected period'
        : `${direction} by <strong>${Math.abs(callDelta).toLocaleString()}</strong> calls (<strong>${Math.abs(callDeltaPct).toFixed(1)}%</strong>)`;
      insights.push(`Call volume ${deltaText}.`);
    }

    if (busiestPeriod && peakPeriodCount > 0) {
      insights.push(`Busiest period: <strong>${peakPeriodLabel}</strong> with <strong>${peakPeriodCount.toLocaleString()}</strong> calls.`);
    }

    if (callActivityWindow) {
      insights.push(`Call activity spans <strong>${callActivityWindow.startLabel}</strong> to <strong>${callActivityWindow.endLabel}</strong> (${formatMinutesToReadable(coverageDuration)} window).`);
    }

    if (peakHourlyCount > 0 && busiestHourEntry) {
      insights.push(`Peak hourly load lands in <strong>${peakHourlyLabel}</strong> (${peakHourlyCount.toLocaleString()} calls).`);
    }

    if (quietHourEntry && Number.isFinite(Number(quietHourEntry.callCount))) {
      insights.push(`Quietest hour: <strong>${quietHourEntry.windowLabel}</strong> (${Number(quietHourEntry.callCount || 0).toLocaleString()} calls).`);
    }

    if (topAgent && Number(topAgent.totalCalls || 0) > 0) {
      insights.push(`Top performer <strong>${topAgent.agent}</strong> handled ${Number(topAgent.totalCalls || 0).toLocaleString()} calls with ${formatMinutesToReadable(Number(topAgent.totalTalk || 0))} of talk time.`);
    }

    if (topWrap && Number(topWrap.count || 0) > 0) {
      const wrapShare = wrapTotal > 0 ? ((Number(topWrap.count) || 0) / wrapTotal) * 100 : 0;
      insights.push(`Most common wrap-up: <strong>${topWrap.wrapup}</strong> (${Number(topWrap.count || 0).toLocaleString()} calls • ${wrapShare.toFixed(1)}%).`);
    }

    if (topPolicy && Number(topPolicy.count || 0) > 0) {
      const policyShare = policyTotal > 0 ? ((Number(topPolicy.count) || 0) / policyTotal) * 100 : 0;
      insights.push(`Policy focus: <strong>${topPolicy.policy}</strong> drives ${policyShare.toFixed(1)}% of calls.`);
    }

    const recommendations = [];

    if (totalCsatResponses === 0) {
      recommendations.push('Capture more CSAT responses to unlock sentiment-driven coaching insights.');
    } else if (yesRate < 80) {
      recommendations.push('Launch targeted objection-handling coaching to lift the yes conversion above 80%.');
    } else if (yesRate < 90) {
      recommendations.push(`Replicate the winning moments from ${topAgent ? topAgent.agent : 'top performers'} to push conversions closer to 90%.`);
    } else {
      recommendations.push('Celebrate and document high-performing call flows to preserve this conversion streak.');
    }

    if (callActivityWindow) {
      recommendations.push(`Anchor staffing to cover <strong>${callActivityWindow.startLabel} – ${callActivityWindow.endLabel}</strong> before layering breaks.`);
      if (callActivityWindow.startSlot < workConfig.startSlot || callActivityWindow.endSlot > workConfig.endSlot) {
        recommendations.push(`Observed call window extends beyond the default staffing window (${staffingLabel}); adjust schedules to match demand.`);
      }
    }

    if (peakHourlyCount > 0 && busiestHourEntry) {
      recommendations.push(`Align staffing coverage with <strong>${peakHourlyLabel}</strong> to absorb the ~${peakHourlyCount.toLocaleString()} calls expected during the busiest hour.`);
    }

    if (quietHourEntry && busiestHourEntry && quietHourEntry.windowLabel !== busiestHourEntry.windowLabel) {
      recommendations.push(`Use <strong>${quietHourEntry.windowLabel}</strong> for coaching or admin work while call volume dips.`);
    }

    if (callTrend.length > 1) {
      if (callDelta > 0 && busiestPeriod) {
        recommendations.push(`Plan staffing around <strong>${peakPeriodLabel}</strong> to absorb the +${Math.abs(callDelta).toLocaleString()} call surge.`);
      } else if (callDelta < 0) {
        recommendations.push('Re-engage dormant campaigns or cross-sell initiatives to stabilise declining call volume.');
      }
    }

    if (peakTimeWindows.length) {
      recommendations.push(`Protect coverage during <strong>${peakTimeWindows[0].windowLabel}</strong>; it holds ${Number(peakTimeWindows[0].shareOfDay || 0).toFixed(1)}% of the day's calls.`);
    }

    const midShiftPlan = scheduleRecommendations.find(plan => plan.id === 'mid') || scheduleRecommendations[0];
    if (midShiftPlan && midShiftPlan.lunch?.rangeLabel) {
      recommendations.push(`Schedule mid-morning shift lunch around <strong>${midShiftPlan.lunch.rangeLabel}</strong> to dodge peak call pressure.`);
    }

    if (topWrap && Number(topWrap.count || 0) > 0) {
      recommendations.push(`Audit workflows tagged “${topWrap.wrapup}” to uncover quick wins for converting more calls to yes outcomes.`);
    }

    if (avgTalkMinutes > 8) {
      recommendations.push(`Coach teams on concise storytelling to reduce average talk time from ${formatMinutesToReadable(avgTalkMinutes)} toward a 6 minute target.`);
    } else if (avgTalkMinutes > 0 && avgTalkMinutes < 4 && yesRate < 85) {
      recommendations.push('Encourage deeper discovery questions—short calls with sub-85% yes rates signal missed opportunities.');
    }

    if (longestTalkAgent && Number(longestTalkAgent.totalTalk || 0) > 0 && (!topAgent || longestTalkAgent.agent !== topAgent.agent)) {
      recommendations.push(`Pair ${longestTalkAgent.agent} with ${topAgent ? topAgent.agent : 'a peer'} to balance efficiency with effectiveness.`);
    }

    recommendations.push('Keep importing the latest call reports to continuously refine these AI-driven insights.');

    renderInsightList(
      insightList,
      insights,
      'fas fa-chart-line text-primary',
      'Insights will appear once data loads.'
    );

    renderInsightList(
      recommendationList,
      recommendations,
      'fas fa-bullseye text-success',
      'Recommendations will appear once data loads.'
    );
  }

  function renderInsightList(target, items, iconClass, emptyMessage) {
    if (!target) return;

    if (!items.length) {
      target.innerHTML = `<li class="text-muted"><i class="fas fa-info-circle"></i>${emptyMessage || 'No insights available for the selected filters yet.'}</li>`;
      return;
    }

    target.innerHTML = items
      .map(item => `<li><i class="${iconClass}"></i>${item}</li>`)
      .join('');
  }

  function formatMinutesToReadable(minutes) {
    const value = Number(minutes) || 0;
    const absValue = Math.abs(value);
    const hours = Math.floor(absValue / 60);
    const remainingMinutes = Math.floor(absValue % 60);
    const sign = value < 0 ? '-' : '';

    if (hours > 0) {
      return `${sign}${hours}h ${remainingMinutes}m`;
    }

    if (absValue >= 1) {
      const rounded = Math.round(absValue * 10) / 10;
      return `${sign}${rounded.toLocaleString()} min`;
    }

    const seconds = Math.round(absValue * 60);
    if (seconds === 0) {
      return '0 min';
    }
    return `${sign}${seconds} sec`;
  }

  function formatSecondsToReadable(seconds) {
    const value = Number(seconds) || 0;
    const absValue = Math.abs(value);
    if (absValue >= 3600) {
      const hours = Math.floor(absValue / 3600);
      const minutes = Math.floor((absValue % 3600) / 60);
      return `${value < 0 ? '-' : ''}${hours}h ${minutes}m`;
    }
    if (absValue >= 60) {
      const mins = Math.floor(absValue / 60);
      const secs = Math.round(absValue % 60);
      return `${value < 0 ? '-' : ''}${mins}m ${secs}s`;
    }
    const rounded = Math.round(absValue);
    return `${value < 0 ? '-' : ''}${rounded} sec`;
  }

  function minutesToTimeLabel(totalMinutes) {
    const normalized = ((totalMinutes % 1440) + 1440) % 1440;
    const hour = Math.floor(normalized / 60);
    const minute = normalized % 60;
    const hour12 = ((hour + 11) % 12) + 1;
    const ampm = hour < 12 ? 'AM' : 'PM';
    return `${hour12}:${String(minute).padStart(2, '0')} ${ampm}`;
  }

  function formatSlotRangeLabel(slotIndex, length = 1) {
    if (!Number.isFinite(slotIndex)) return '';
    const startMinutes = slotIndex * 15;
    const endMinutes = (slotIndex + Math.max(length, 1)) * 15;
    return `${minutesToTimeLabel(startMinutes)} – ${minutesToTimeLabel(endMinutes)}`;
  }

  function normalizeHourlyVolume(hourlyVolume = []) {
    if (!Array.isArray(hourlyVolume)) return [];

    return hourlyVolume
      .map(entry => {
        const hour = Number(entry.hour);
        if (!Number.isFinite(hour)) return null;
        const callCount = Number(entry.callCount) || 0;
        const windowLabel = entry.windowLabel || entry.label || formatSlotRangeLabel(hour * 4, 4);
        return {
          hour,
          callCount,
          windowLabel,
          intensity: entry.intensity || null,
          intensityLabel: entry.intensityLabel || null
        };
      })
      .filter(Boolean)
      .sort((a, b) => a.hour - b.hour);
  }

  function getWorkWindowConfig() {
    const now = new Date();
    const january = new Date(now.getFullYear(), 0, 1);
    const july = new Date(now.getFullYear(), 6, 1);
    const standardOffset = Math.max(january.getTimezoneOffset(), july.getTimezoneOffset());
    const isDst = now.getTimezoneOffset() < standardOffset;
    const startHour = isDst ? 9 : 8;
    const endHour = isDst ? 19 : 18;
    return {
      isDst,
      startHour,
      endHour,
      startSlot: startHour * 4,
      endSlot: endHour * 4
    };
  }

  function determinePeakWorkWindow(intervalVolume = [], hourlyVolume = []) {
    const workConfig = getWorkWindowConfig();
    const normalizedIntervals = Array.isArray(intervalVolume)
      ? intervalVolume
      .map(entry => ({
        slotIndex: Number(entry.slotIndex),
        callCount: Number(entry.callCount) || 0,
        windowLabel: entry.windowLabel || '',
        slotSpan: 1
      }))
      .filter(entry => Number.isFinite(entry.slotIndex))
      : [];

    const normalizedHourly = normalizeHourlyVolume(hourlyVolume).map(entry => ({
      slotIndex: entry.hour * 4,
      slotSpan: 4,
      callCount: Number(entry.callCount) || 0,
      windowLabel: entry.windowLabel || ''
    }));

    const normalized = normalizedIntervals.length ? normalizedIntervals : normalizedHourly;

    if (!normalized.length) {
      return {
        label: '—',
        callCount: 0,
        rawLabel: '',
        workConfig,
        withinWorkWindow: false
      };
    }

    const withinWindow = normalized.filter(entry => {
      const start = Number(entry.slotIndex);
      if (!Number.isFinite(start)) return false;
      const span = Number(entry.slotSpan) || 1;
      const end = start + span;
      return start >= workConfig.startSlot && end <= workConfig.endSlot;
    });
    const candidates = withinWindow.length ? withinWindow : normalized;

    const topEntry = candidates.reduce((best, entry) => {
      if (!best) return entry;
      if (entry.callCount > best.callCount) return entry;
      if (entry.callCount === best.callCount && entry.slotIndex < best.slotIndex) return entry;
      return best;
    }, null);

    if (!topEntry) {
      return {
        label: '—',
        callCount: 0,
        rawLabel: '',
        workConfig,
        withinWorkWindow: false
      };
    }

    const slotSpan = Number(topEntry.slotSpan) || 1;
    const rawLabel = topEntry.windowLabel || formatSlotRangeLabel(topEntry.slotIndex, slotSpan);
    const label = topEntry.callCount > 0 ? rawLabel : '—';
    const endSlot = topEntry.slotIndex + slotSpan;

    return {
      label,
      callCount: topEntry.callCount,
      rawLabel,
      workConfig,
      withinWorkWindow: topEntry.slotIndex >= workConfig.startSlot && endSlot <= workConfig.endSlot
    };
  }

  function renderKpiCards(analytics) {
    const totalCalls = analytics.repMetrics.reduce((sum, r) => sum + r.totalCalls, 0);
    document.getElementById("kpiTotalCalls").textContent = totalCalls.toLocaleString();

    const csatYes = analytics.csatDist.find(o => o.csat === "Yes")?.count || 0;
    const csatTotal = analytics.csatDist.reduce((sum, o) => sum + o.count, 0);
    const avgCsat = csatTotal > 0 ? ((csatYes / csatTotal) * 100).toFixed(1) : 0;
    document.getElementById("kpiAvgCsat").textContent = `${avgCsat}%`;

    const totalTalk = analytics.talkTrend.reduce((sum, o) => sum + o.totalTalk, 0);
    const totalCallCount = analytics.callTrend.reduce((sum, o) => sum + o.callCount, 0);
    const avgTalkTime = totalCallCount > 0 ? (totalTalk / totalCallCount).toFixed(2) : 0;
    document.getElementById("kpiAvgTalkTime").textContent = `${avgTalkTime} min`;

    const intervalVolume = Array.isArray(analytics.intervalVolume) ? analytics.intervalVolume : [];
    const hourlyVolume = Array.isArray(analytics.hourlyVolume) ? analytics.hourlyVolume : [];
    const peakWindow = determinePeakWorkWindow(intervalVolume, hourlyVolume);
    const peakEl = document.getElementById("kpiWeeklyPeakWindow");
    if (peakEl) {
      peakEl.textContent = peakWindow.label;
      const tooltip = peakWindow.callCount > 0
        ? `${peakWindow.callCount.toLocaleString()} calls • ${peakWindow.rawLabel}${peakWindow.withinWorkWindow ? '' : ' (outside staffing window)'}`
        : 'No call activity within the staffing window';
      peakEl.setAttribute('title', tooltip);
      peakEl.dataset.windowLabel = peakWindow.rawLabel;
      peakEl.dataset.callCount = String(peakWindow.callCount || 0);
      const startHourLabel = String(peakWindow.workConfig.startHour).padStart(2, '0');
      const endHourLabel = String(peakWindow.workConfig.endHour).padStart(2, '0');
      peakEl.dataset.workStart = `${startHourLabel}:00`;
      peakEl.dataset.workEnd = `${endHourLabel}:00`;
      peakEl.dataset.withinWorkWindow = String(peakWindow.withinWorkWindow);
    }

    // Add enhanced animation to value changes
    [document.getElementById('kpiTotalCalls'),
     document.getElementById('kpiAvgCsat'),
     document.getElementById('kpiAvgTalkTime'),
     document.getElementById('kpiWeeklyPeakWindow')].forEach(el => {
      el.style.transform = 'scale(1.05)';
      setTimeout(() => {
        el.style.transform = 'scale(1)';
      }, 200);
    });
  }

  // Enhanced chart options function
  function getEnhancedChartOptions(type, title) {
    const baseOptions = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: type === 'doughnut' ? 'bottom' : 'top',
          labels: {
            padding: 20,
            font: { size: 12, weight: '500' },
            generateLabels: (chart) => {
              const data = chart.data;
              if (data.labels.length && data.datasets.length) {
                return data.labels.map((label, i) => {
                  const dataset = data.datasets[0];
                  const value = dataset.data[i];
                  const total = dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  
                  const truncatedLabel = label.length > 25 
                    ? label.substring(0, 22) + '...' 
                    : label;
                  
                  return {
                    text: `${truncatedLabel} (${percentage}%)`,
                    fillStyle: dataset.backgroundColor[i],
                    strokeStyle: dataset.backgroundColor[i],
                    lineWidth: 0,
                    pointStyle: 'rect',
                    index: i,
                    fullLabel: label
                  };
                });
              }
              return [];
            }
          }
        },
        tooltip: {
          callbacks: {
            title: (context) => {
              return context[0].label || title;
            },
            label: (context) => {
              const label = context.label || '';
              const value = context.parsed || context.parsed.y || context.raw;
              if (type === 'doughnut') {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label}: ${value.toLocaleString()} (${percentage}%)`;
              }
              return `${label}: ${value.toLocaleString()}`;
            }
          }
        }
      },
      animation: {
        animateRotate: type === 'doughnut',
        animateScale: true,
        duration: 1000,
        easing: 'easeOutQuart'
      }
    };

    if (type === 'line') {
      baseOptions.scales = {
        x: {
          grid: { display: false },
          ticks: { maxTicksLimit: 7, font: { size: 11 } }
        },
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(226, 232, 240, 0.5)' },
          ticks: { font: { size: 11 } }
        }
      };
      baseOptions.elements = {
        point: { hoverRadius: 8, radius: 4 },
        line: { tension: 0.4 }
      };
    }

    return baseOptions;
  }

  // Enhanced chart rendering functions with improved styling
  function renderPolicyDistChart(policyDist) {
    const ctx = document.getElementById("policyDistChart").getContext("2d");
    const labels = policyDist.map(o => o.policy);
    const dataPts = policyDist.map(o => o.count);
    const bgColors = labels.map((_, i) => {
      const palette = [
        "#2563eb", "#059669", "#d97706", "#dc2626", "#7c3aed", "#0891b2",
        "#be123c", "#9333ea", "#c2410c", "#166534", "#1e40af", "#7c2d12"
      ];
      return palette[i % palette.length];
    });

    if (policyDistChart) policyDistChart.destroy();
    policyDistChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: labels,
        datasets: [{ 
          data: dataPts, 
          backgroundColor: bgColors, 
          borderWidth: 2,
          borderColor: '#ffffff',
          hoverBorderWidth: 3
        }]
      },
      options: getEnhancedChartOptions('doughnut', 'Policy Distribution')
    });
  }

  function renderWrapupDistChart(wrapDist) {
    const ctx = document.getElementById("wrapupDistChart").getContext("2d");
    const labels = wrapDist.map(o => o.wrapupLabel);
    const dataPts = wrapDist.map(o => o.count);
    const bgColors = labels.map((_, i) => {
      const palette = ["#059669", "#d97706", "#dc2626", "#2563eb", "#7c3aed", "#0891b2"];
      return palette[i % palette.length];
    });

    if (wrapupDistChart) wrapupDistChart.destroy();
    wrapupDistChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: labels,
        datasets: [{ 
          data: dataPts, 
          backgroundColor: bgColors, 
          borderWidth: 2,
          borderColor: '#ffffff',
          hoverBorderWidth: 3
        }]
      },
      options: getEnhancedChartOptions('doughnut', 'Wrapup Distribution')
    });
  }

  function renderCsatChart(csatDist) {
    const ctx = document.getElementById("csatDistChart").getContext("2d");
    const labels = csatDist.map(o => o.csat);
    const dataPts = csatDist.map(o => o.count);
    const bgColors = ["#059669", "#dc2626"]; // Yes=green, No=red

    if (csatChart) csatChart.destroy();
    csatChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: labels,
        datasets: [{ 
          data: dataPts, 
          backgroundColor: bgColors, 
          borderWidth: 2,
          borderColor: '#ffffff',
          hoverBorderWidth: 3
        }]
      },
      options: getEnhancedChartOptions('doughnut', 'CSAT Distribution')
    });
  }

  function renderCallTrendChart(callTrend) {
    const ctx = document.getElementById("callTrendChart").getContext("2d");
    const filtered = callTrend.filter(o => {
      const day = o.periodLabel.toLowerCase();
      return day !== "saturday" && day !== "sunday";
    });

    const labels = filtered.map(o => o.periodLabel);
    const dataPts = filtered.map(o => o.callCount);

    if (callTrendChart) callTrendChart.destroy();
    callTrendChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Total Calls",
          data: dataPts,
          borderColor: "#2563eb",
          backgroundColor: "rgba(37, 99, 235, 0.1)",
          tension: 0.4,
          fill: true,
          pointBackgroundColor: "#2563eb",
          pointBorderColor: "#ffffff",
          pointBorderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: getEnhancedChartOptions('line', 'Call Trend')
    });
  }

  function renderTalkTrendChart(talkTrend) {
    const ctx = document.getElementById("talkTrendChart").getContext("2d");
    const filtered = talkTrend.filter(o => {
      const day = o.periodLabel.toLowerCase();
      return day !== "saturday" && day !== "sunday";
    });

    const labels = filtered.map(o => o.periodLabel);
    const dataPts = filtered.map(o => o.totalTalk);

    if (talkTrendChart) talkTrendChart.destroy();
    talkTrendChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "Total Talk Time (min)",
          data: dataPts,
          backgroundColor: "rgba(5, 150, 105, 0.8)",
          borderColor: "#059669",
          borderWidth: 1,
          borderRadius: 4,
          borderSkipped: false,
        }]
      },
      options: {
        ...getEnhancedChartOptions('bar', 'Talk Time Trend'),
        scales: {
          y: { 
            beginAtZero: true, 
            title: { display: true, text: "Talk Time (minutes)" },
            grid: { color: 'rgba(226, 232, 240, 0.5)' }
          },
          x: { 
            title: { display: true, text: "Period" },
            grid: { display: false }
          }
        },
        plugins: { 
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (context) => {
                const value = context.parsed.y;
                const hours = Math.floor(value / 60);
                const mins = Math.round(value % 60);
                return `Talk Time: ${hours}h ${mins}m (${value.toFixed(1)} min)`;
              }
            }
          }
        }
      }
    });
  }

  function renderTimeOfDayInsights(analytics = {}) {
    const hourlyVolume = Array.isArray(analytics.hourlyVolume) ? analytics.hourlyVolume : [];
    const peakWindows = Array.isArray(analytics.peakTimeWindows) ? analytics.peakTimeWindows : [];
    const schedulePlans = Array.isArray(analytics.scheduleRecommendations) ? analytics.scheduleRecommendations : [];
    const callWindow = analytics.callActivityWindow || null;

    renderCallLoadByHourChart(hourlyVolume);
    renderPeakWindowList(peakWindows);
    renderSchedulePlanner(schedulePlans, callWindow);
    renderPeakSummaryList(hourlyVolume, peakWindows, schedulePlans, callWindow);
  }

  function renderCallLoadByHourChart(hourlyVolume = []) {
    const canvas = document.getElementById('callLoadByHourChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    const normalizedHours = normalizeHourlyVolume(hourlyVolume);
    const workConfig = getWorkWindowConfig();
    const staffingHours = normalizedHours.filter(entry => entry.hour >= workConfig.startHour && entry.hour < workConfig.endHour);
    const dataset = staffingHours.length ? staffingHours : normalizedHours;

    if (!dataset.length) {
      if (callLoadByHourChart) {
        callLoadByHourChart.destroy();
        callLoadByHourChart = null;
      }
      return;
    }

    const labels = dataset.map(entry => minutesToTimeLabel(entry.hour * 60));
    const values = dataset.map(entry => Number(entry.callCount) || 0);
    const intensities = dataset.map(entry => entry.intensity);
    const windowLabels = dataset.map(entry => entry.windowLabel);
    const maxValue = values.length ? Math.max(...values) : 0;
    const colors = values.map(value => {
      const factor = maxValue > 0 ? value / maxValue : 0;
      const alpha = Math.min(0.25 + factor * 0.55, 0.85);
      return `rgba(37, 99, 235, ${alpha.toFixed(2)})`;
    });

    if (callLoadByHourChart) callLoadByHourChart.destroy();

    callLoadByHourChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Calls',
          data: values,
          backgroundColor: colors,
          borderRadius: 8,
          borderSkipped: false,
          intensities,
          windowLabels
        }]
      },
      options: {
        ...getEnhancedChartOptions('bar', 'Call Load by Hour'),
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: context => {
                const value = Number(context.parsed.y) || 0;
                const datasetMeta = context.chart?.data?.datasets?.[context.datasetIndex] || {};
                const load = Array.isArray(datasetMeta.intensities) ? datasetMeta.intensities[context.dataIndex] : null;
                const rangeLabels = Array.isArray(datasetMeta.windowLabels) ? datasetMeta.windowLabels : [];
                const range = rangeLabels[context.dataIndex] || context.label || '';
                const loadLabel = getLoadLabel(load);
                return `${range}: ${value.toLocaleString()} calls • ${loadLabel}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Calls per hour' },
            ticks: { precision: 0 }
          },
          x: {
            grid: { display: false },
            ticks: {
              maxRotation: 45,
              minRotation: 45,
              autoSkip: true,
              font: { size: 11 }
            }
          }
        }
      }
    });
  }

  function renderPeakWindowList(peaks = []) {
    const listEl = document.getElementById('peakWindowList');
    if (!listEl) return;

    if (!peaks.length) {
      listEl.innerHTML = `<li class="text-muted"><i class="fas fa-info-circle me-2"></i>No peak windows detected for this selection.</li>`;
      return;
    }

    listEl.innerHTML = peaks
      .map((item, index) => {
        const share = Number(item.shareOfDay || 0).toFixed(1);
        return `
          <li>
            <div>
              <div class="peak-window-time">#${index + 1} ${item.windowLabel}</div>
              <div class="peak-window-load">${Number(item.callCount || 0).toLocaleString()} calls • ${share}% of day</div>
            </div>
            ${renderLoadChip(item.intensity)}
          </li>
        `;
      })
      .join('');
  }

  function renderSchedulePlanner(plans = [], callWindow = null) {
    const container = document.getElementById('schedulePlannerContainer');
    if (!container) return;

    if (!plans.length) {
      container.classList.add('text-muted');
      container.innerHTML = 'No schedule recommendations available for the selected filters yet.';
      return;
    }

    container.classList.remove('text-muted');
    container.innerHTML = plans
      .map(plan => {
        const [firstBreak = {}, secondBreak = {}] = Array.isArray(plan.breaks) ? plan.breaks : [{}, {}];
        const avgHour = Number(plan.averageHourlyLoad || 0).toFixed(1);
        const overlap = Number(plan.overlapPercent || 0).toFixed(0);
        const lunchShare = Number(plan.lunch?.shareOfShift || 0).toFixed(1);
        const breakOneCalls = Number(firstBreak.callCount || 0).toLocaleString();
        const breakTwoCalls = Number(secondBreak.callCount || 0).toLocaleString();
        const planWindow = plan.operatingWindow || callWindow;
        const noteParts = [];
        if (plan.coverageNote) noteParts.push(plan.coverageNote);
        if (planWindow) {
          const hasWindowText = typeof plan.coverageNote === 'string'
            && plan.coverageNote.includes(planWindow.startLabel)
            && plan.coverageNote.includes(planWindow.endLabel);
          if (!hasWindowText) {
            noteParts.push(`Observed call window ${planWindow.startLabel} – ${planWindow.endLabel}.`);
          }
        }
        const planNote = noteParts.join(' ').trim();

        return `
          <div class="schedule-plan-card">
            <div class="schedule-plan-header">
              <div>
                <div class="schedule-plan-title">${plan.name}</div>
                <div class="schedule-plan-times">${plan.shiftRangeLabel}</div>
              </div>
              <div class="schedule-plan-meta">
                <div>${avgHour} avg calls/hr</div>
                <div>${overlap}% of peak windows covered</div>
              </div>
            </div>
            <dl>
              <div>
                <dt>Lunch</dt>
                <dd>
                  ${plan.lunch?.rangeLabel || '—'}
                  ${renderLoadChip(plan.lunch?.intensity)}
                  <span class="text-muted small">(${Number(plan.lunch?.callCount || 0).toLocaleString()} calls • ${lunchShare}% of shift)</span>
                </dd>
              </div>
              <div>
                <dt>Break 1</dt>
                <dd>
                  ${firstBreak.rangeLabel || '—'}
                  ${renderLoadChip(firstBreak.intensity)}
                  <span class="text-muted small">(${breakOneCalls} calls)</span>
                </dd>
              </div>
              <div>
                <dt>Break 2</dt>
                <dd>
                  ${secondBreak.rangeLabel || '—'}
                  ${renderLoadChip(secondBreak.intensity)}
                  <span class="text-muted small">(${breakTwoCalls} calls)</span>
                </dd>
              </div>
              <div>
                <dt>Watch</dt>
                <dd>
                  ${plan.peakGuard?.rangeLabel || '—'}
                  ${renderLoadChip(plan.peakGuard?.intensity)}
                  <span class="text-muted small">(${Number(plan.peakGuard?.callCount || 0).toLocaleString()} calls peak)</span>
                </dd>
              </div>
            </dl>
            <div class="schedule-plan-note">${planNote}</div>
          </div>
        `;
      })
      .join('');
  }

  function renderPeakSummaryList(hourlyVolume = [], peaks = [], plans = [], callWindow = null) {
    const listEl = document.getElementById('peakSummaryList');
    if (!listEl) return;

    const normalizedHours = normalizeHourlyVolume(hourlyVolume);
    const workConfig = getWorkWindowConfig();
    const staffingHours = normalizedHours.filter(entry => entry.hour >= workConfig.startHour && entry.hour < workConfig.endHour);
    const scopedHours = staffingHours.length ? staffingHours : normalizedHours;

    if (!scopedHours.length && !peaks.length) {
      listEl.innerHTML = `<li class="text-muted"><i class="fas fa-info-circle me-2"></i>No call traffic recorded for this selection.</li>`;
      return;
    }

    const meaningfulHours = scopedHours.filter(entry => entry.callCount > 0);
    const evaluationSet = meaningfulHours.length ? meaningfulHours : scopedHours;

    const busiestHour = evaluationSet.length
      ? evaluationSet.reduce((best, entry) => {
          if (!best) return entry;
          const value = Number(entry.callCount) || 0;
          const bestValue = Number(best.callCount) || 0;
          if (value > bestValue) return entry;
          if (value === bestValue && entry.hour < best.hour) return entry;
          return best;
        }, null)
      : null;

    const quietHour = evaluationSet.length
      ? evaluationSet.reduce((best, entry) => {
          if (!best) return entry;
          const value = Number(entry.callCount) || 0;
          const bestValue = Number(best.callCount) || 0;
          if (value < bestValue) return entry;
          if (value === bestValue && entry.hour < best.hour) return entry;
          return best;
        }, null)
      : null;

    const priorityPlan = plans.find(plan => plan.id === 'mid') || plans[0] || null;
    const items = [];

    if (callWindow) {
      const duration = Number(callWindow.durationMinutes || 0);
      items.push(`
        <li>
          <i class="fas fa-clock mt-1 text-primary"></i>
          <div>Observed call window: <strong>${callWindow.startLabel} – ${callWindow.endLabel}</strong>${duration > 0 ? ` (${formatMinutesToReadable(duration)})` : ''}.</div>
        </li>
      `);
    }

    if (busiestHour) {
      items.push(`
        <li>
          <i class="fas fa-bolt mt-1 text-danger"></i>
          <div><strong>${busiestHour.windowLabel}</strong> is the busiest hour (${Number(busiestHour.callCount || 0).toLocaleString()} calls).</div>
        </li>
      `);
    }

    if (peaks.length) {
      const top = peaks[0];
      items.push(`
        <li>
          <i class="fas fa-chart-line mt-1 text-primary"></i>
          <div>Top spike: <strong>${top.windowLabel}</strong> (${Number(top.callCount || 0).toLocaleString()} calls • ${Number(top.shareOfDay || 0).toFixed(1)}% of day).</div>
        </li>
      `);
    }

    if (quietHour) {
      items.push(`
        <li>
          <i class="fas fa-leaf mt-1 text-success"></i>
          <div>Quietest hour: <strong>${quietHour.windowLabel}</strong> (${Number(quietHour.callCount || 0).toLocaleString()} calls).</div>
        </li>
      `);
    }

    if (priorityPlan && priorityPlan.lunch?.rangeLabel) {
      items.push(`
        <li>
          <i class="fas fa-utensils mt-1 text-warning"></i>
          <div>${priorityPlan.name} lunch sweet spot: <strong>${priorityPlan.lunch.rangeLabel}</strong>.</div>
        </li>
      `);
    }

    listEl.innerHTML = items.join('');
  }

  function getLoadLabel(intensity) {
    if (intensity === 'high') return 'High load';
    if (intensity === 'moderate') return 'Moderate load';
    return 'Low load';
  }

  function renderLoadChip(intensity) {
    const key = intensity === 'high' ? 'high' : intensity === 'moderate' ? 'moderate' : 'low';
    const label = getLoadLabel(key);
    return `<span class="load-chip load-${key}">${label}</span>`;
  }

  // Keep existing table rendering function but enhance styling
  function formatDuration(totalSeconds) {
    const hrs = Math.floor(totalSeconds / 3600);
    const mins = Math.floor((totalSeconds % 3600) / 60);
    const secs = Math.floor(totalSeconds % 60);
    return [hrs, mins, secs]
      .map(unit => unit < 10 ? "0" + unit : unit)
      .join(":");
  }

  function renderRepMetricsTable(repMetrics) {
    const tbody = document.querySelector("#repMetricsTable tbody");
    tbody.innerHTML = "";

    if (!repMetrics.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center py-3 text-muted">No data available for the selected period</td>
        </tr>`;
      return;
    }

    repMetrics.forEach(item => {
      const totalSeconds = Math.round((item.totalTalk || 0) * 60);
      const avgSeconds = item.totalCalls > 0 ? totalSeconds / item.totalCalls : 0;
      const hasAnswerData = Number(item.answeredCount || 0) > 0 && Number.isFinite(Number(item.averageAnswerSeconds));
      const avgAnswerSeconds = Number(item.averageAnswerSeconds);
      const fastRate = Number(item.fastAnswerRate);

      const answerCell = hasAnswerData
        ? `<span class="text-warning fw-semibold">${formatSecondsToReadable(avgAnswerSeconds)}</span>`
        : '<span class="text-muted">—</span>';

      const fastCell = hasAnswerData && Number.isFinite(fastRate)
        ? `<span class="badge bg-info text-dark">${fastRate.toFixed(1)}%</span>`
        : '<span class="text-muted">—</span>';

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><strong>${item.agent}</strong></td>
        <td><span class="badge bg-primary rounded-pill">${item.totalCalls.toLocaleString()}</span></td>
        <td><span class="text-success fw-semibold">${formatDuration(totalSeconds)}</span></td>
        <td><span class="text-info fw-semibold">${formatDuration(avgSeconds)}</span></td>
        <td>${answerCell}</td>
        <td>${fastCell}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function populateBiWeeklyOptions() {
    const select = document.getElementById("biWeekSelect");
    if (!select) return;

    const currentYear = new Date().getFullYear();
    const existingYear = Number(select.dataset.generatedYear || 0);

    if (select.options.length && existingYear === currentYear) {
      if (currentPeriod && Array.from(select.options).some(opt => opt.value === currentPeriod)) {
        select.value = currentPeriod;
      }
      return;
    }

    select.innerHTML = "";
    const years = [currentYear, currentYear - 1];

    years.forEach(year => {
      for (let i = 1; i <= 26; i++) {
        const idx = i.toString().padStart(2, '0');
        const option = document.createElement('option');
        option.value = `${year}-BW${idx}`;
        option.textContent = `Bi-Week ${idx} • ${year}`;
        select.appendChild(option);
      }
    });

    select.dataset.generatedYear = String(currentYear);

    if (currentPeriod && Array.from(select.options).some(opt => opt.value === currentPeriod)) {
      select.value = currentPeriod;
    } else if (select.options.length) {
      select.selectedIndex = 0;
    }
  }

  // Enhanced showToast function
  function showToast(message, type = 'info') {
    if (window.showLuminaToast) {
      window.showLuminaToast(message, type);
      return;
    }

    const tone = String(type || 'info').toUpperCase();
    window.alert(`[${tone}] ${message}`);
  }

  // Keep all existing utility functions exactly as they were
  function weekStringFromDate(d) {
    const target = new Date(d.valueOf());
    const dayNr = (d.getDay() + 6) % 7;
    target.setDate(target.getDate() - dayNr + 3);
    const firstThursday = new Date(target.getFullYear(), 0, 4);
    const diff = target - firstThursday;
    const weekNum = 1 + Math.round(diff / (7 * 86400000));
    const year = target.getFullYear();
    const w = weekNum < 10 ? `0${weekNum}` : `${weekNum}`;
    return `${year}-W${w}`;
  }
  
  // Keep the existing loadAnalytics function EXACTLY as it was - this is the server integration
  function loadAnalytics(gran, periodIdentifier, agent) {
    const loaderApi = window.LuminaLoader;
    loaderApi?.show({
      title: 'Loading Call Analytics',
      detail: 'Pulling call metrics and trends…',
      tip: `Filters: ${gran} • ${agent || 'All agents'}`,
      progress: 35
    });

    google.script
      .run
      .withFailureHandler(err => {
        loaderApi?.hide();
        console.error("Error fetching analytics:", err);
        showToast("Error loading analytics: " + err.message, "danger");
      })
      .withSuccessHandler(result => {
        loaderApi?.update({ detail: 'Analytics loaded successfully', progress: 100, tip: 'Refreshing dashboards…' });
        const agentSelect = document.getElementById("agentSelect");
        agentSelect.innerHTML = `<option value="">👥 All Agents</option>`;
        const liveAgents = result.activeAgents;

        liveAgents.forEach(agent => {
          const opt = document.createElement("option");
          opt.value = agent;
          opt.textContent = agent;
          if (agent === currentAgent) opt.selected = true;
          agentSelect.appendChild(opt);
        });

        populateBiWeeklyOptions();

        renderEverything(result);
        showToast("Dashboard updated successfully", "success");
        loaderApi?.hide(250);
      })
      .getAnalyticsByPeriod(gran, periodIdentifier, agent);
  }

  // Chart.js responsiveness handles resizing without manual listeners

  // Add accessibility enhancements
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && window.LuminaLoader?.isVisible()) {
      window.LuminaLoader.hide();
    }
  });
</script>

</body>
</html>