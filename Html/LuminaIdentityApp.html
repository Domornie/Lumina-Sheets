<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lumina Identity Workspace</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: 'Inter', sans-serif; background: #060811; color: #e9ecff; }
    header { padding: 1.2rem 2.2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.08); position: sticky; top: 0; backdrop-filter: blur(8px); background: rgba(6,8,17,0.85); }
    .workspace { display: grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 72px); }
    nav { border-right: 1px solid rgba(255,255,255,0.05); padding: 1.5rem; background: rgba(7,11,28,0.85); }
    nav button { display: block; width: 100%; text-align: left; background: transparent; border: 0; color: inherit; padding: 0.7rem 1rem; border-radius: 10px; margin-bottom: 0.4rem; cursor: pointer; }
    nav button.active { background: linear-gradient(135deg,#5f2ded,#8a62ff); }
    main { padding: 2rem 2.5rem; overflow-y: auto; }
    h2 { margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; background: rgba(255,255,255,0.04); border-radius: 12px; overflow: hidden; }
    th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.06); }
    th { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: #9aa2e6; }
    tr:last-child td { border-bottom: 0; }
    .tag { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.25rem 0.6rem; border-radius: 999px; font-size: 0.75rem; background: rgba(95,45,237,0.25); color: #cbbdff; }
    .hint { margin-top: 1rem; padding: 1rem 1.2rem; border-radius: 12px; background: rgba(36,226,158,0.16); color: #59f2b6; }
    .panel { margin-top: 2rem; padding: 1.6rem; border-radius: 14px; background: rgba(255,255,255,0.04); }
    .panel h3 { margin-top: 0; }
    .audit-log { max-height: 220px; overflow-y: auto; }
    .audit-log li { list-style: none; padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
  </style>
</head>
<body>
  <? var loginHref = (function() {
    var base = scriptUrl || baseUrl || '';
    if (base) {
      return String(base).replace(/[?#].*$/, '') + '?page=login';
    }
    return '?page=login';
  })(); ?>
  <header>
    <div>
      <strong>Lumina Identity</strong>
      <span style="color:#7f89c9; margin-left:0.6rem;">Campaign: <span id="campaign-name">Loading...</span></span>
    </div>
    <button id="logout" style="background: rgba(255,255,255,0.08); border:0; color:#f2f5ff; padding:0.55rem 1.2rem; border-radius:10px;">Logout</button>
  </header>
  <div class="workspace">
    <nav>
      <button data-view="directory" class="active">User directory</button>
      <button data-view="equipment">Equipment</button>
      <button data-view="policies">Policies & Flags</button>
      <button data-view="audit">Audit</button>
    </nav>
    <main>
      <section id="view-directory">
        <h2>Campaign directory</h2>
        <table id="user-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Role</th>
              <th>Status</th>
              <th>Watch</th>
              <th>Eligibility</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
      <section id="view-equipment" style="display:none;">
        <h2>Equipment assignments</h2>
        <div id="equipment-list" class="panel">No equipment records yet.</div>
      </section>
      <section id="view-policies" style="display:none;">
        <h2>Policies</h2>
        <div id="policy-list" class="panel">Loading policies...</div>
      </section>
      <section id="view-audit" style="display:none;">
        <h2>Recent audit log</h2>
        <ul id="audit-log" class="audit-log"></ul>
      </section>
    </main>
  </div>
  <script>
    const state = { sessionId: null, csrf: null, campaignId: null };
    const views = document.querySelectorAll('nav button');
    views.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));

    async function api(action, payload) {
      const response = await fetch('', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(Object.assign({ action, sessionId: state.sessionId, csrf: state.csrf }, payload || {}))
      });
      return response.json();
    }

    function switchView(view) {
      views.forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
      document.querySelectorAll('main section').forEach(section => {
        section.style.display = section.id === 'view-' + view ? 'block' : 'none';
      });
      if (view === 'directory') loadDirectory();
      if (view === 'equipment') loadEquipment();
      if (view === 'policies') loadPolicies();
      if (view === 'audit') loadAudit();
    }

    async function bootstrap() {
      const sessionData = window.__IDENTITY_SESSION__ || {};
      state.sessionId = sessionData.sessionId;
      state.csrf = sessionData.csrf;
      state.campaignId = sessionData.campaignId;
      document.getElementById('campaign-name').textContent = sessionData.campaignName || 'Unknown';
      await loadDirectory();
    }

    async function loadDirectory() {
      const result = await api('users/list', { campaignId: state.campaignId });
      if (!result.ok) return;
      const tbody = document.querySelector('#user-table tbody');
      tbody.innerHTML = '';
      (result.result || []).forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.Email}</td>
          <td>${user.Role}</td>
          <td><span class="tag">${user.Status}</span></td>
          <td>${user.Watchlist === 'Y' ? '⚠️' : ''}</td>
          <td>${(user.Eligibility || []).map(e => e.status).join(', ') || '—'}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function loadEquipment() {
      const container = document.getElementById('equipment-list');
      const result = await api('equipment/list', { campaignId: state.campaignId });
      if (!result.ok) return container.textContent = result.error || 'Unable to load equipment.';
      const items = result.result || [];
      if (!items.length) {
        container.textContent = 'No equipment assigned.';
        return;
      }
      container.innerHTML = items.map(item => `<div class="hint">${item.Type} – ${item.Serial} (${item.Status})</div>`).join('');
    }

    async function loadPolicies() {
      const container = document.getElementById('policy-list');
      const result = await api('policies/list', { scope: state.campaignId });
      if (!result.ok) return container.textContent = result.error || 'Unable to load policies.';
      container.innerHTML = result.result.map(item => `<div class="hint">${item.Name}: <strong>${item.Value}</strong></div>`).join('');
    }

    async function loadAudit() {
      const list = document.getElementById('audit-log');
      const result = await api('audit/list', { campaignId: state.campaignId });
      if (!result.ok) return;
      list.innerHTML = '';
      (result.result || []).slice(-15).reverse().forEach(event => {
        const li = document.createElement('li');
        li.textContent = `${event.Timestamp} — ${event.Action} (${event.ActorRole || 'n/a'})`;
        list.appendChild(li);
      });
    }

    const LOGIN_URL = '<?= loginHref ?>';

    document.getElementById('logout').addEventListener('click', async () => {
      await api('auth/logout', {});
      window.location.href = LOGIN_URL;
    });

    bootstrap();
  </script>
</body>
</html>
