<!DOCTYPE html>
<html lang="en">

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sign in • Lumina Identity</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <?!= includeOnce('ResponsiveStyles') ?>
  <?!= includeOnce('CookieHandler') ?>
  <style>
    :root {
      --lumina-primary: #2563eb;
      --lumina-primary-dark: #1d4ed8;
      --lumina-ink: #0f172a;
      --lumina-muted: #64748b;
      --lumina-surface: #ffffff;
      --lumina-bg: #f8fafc;
    }

    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      margin: 0;
      background: var(--lumina-bg);
      color: var(--lumina-ink);
    }

    a {
      color: var(--lumina-primary);
      text-decoration: none;
    }

    a:hover,
    a:focus {
      text-decoration: underline;
    }

    .visually-hidden {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .login-layout {
      display: flex;
      min-height: 100vh;
      background: var(--lumina-bg);
      align-items: stretch;
      padding: 0;
      column-gap: 0;
    }

    .login-hero {
      flex: 0 0 35%;
      max-width: 35%;
      background: linear-gradient(145deg, #051b3f 0%, #0f3c8f 48%, #0a2c6c 100%);
      color: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2.75rem 3.5rem;
      position: relative;
      overflow: hidden;
      border-radius: 0 32px 32px 0;
      min-height: 100vh;
      height: 100vh;
    }

    .login-hero::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 18% 22%, rgba(59, 130, 246, 0.35), transparent 58%),
        radial-gradient(circle at 82% 78%, rgba(37, 99, 235, 0.28), transparent 62%);
      opacity: 0.9;
      pointer-events: none;
    }

    .hero-inner {
      max-width: 470px;
      width: 100%;
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 1.3rem;
    }

    .hero-eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.45rem 0.95rem;
      background: rgba(15, 23, 42, 0.32);
      border: 1px solid rgba(148, 163, 184, 0.24);
      color: #dbeafe;
      border-radius: 999px;
      font-size: 0.76rem;
      letter-spacing: 0.11em;
      text-transform: uppercase;
    }

    .hero-eyebrow i {
      color: #60a5fa;
    }

    .hero-title {
      font-size: clamp(2.25rem, 2.7vw + 1.6rem, 2.95rem);
      line-height: 1.12;
      font-weight: 600;
      color: #f8fafc;
      margin: 0;
    }

    .hero-subtitle {
      font-size: 1.05rem;
      line-height: 1.72;
      color: rgba(219, 234, 254, 0.94);
      margin: 0 0 0.25rem;
    }

    .hero-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 1.05rem;
    }

    .hero-list li {
      display: flex;
      align-items: flex-start;
      gap: 0.85rem;
      font-size: 0.99rem;
      line-height: 1.58;
      color: #e9f2ff;
    }

    .hero-icon {
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: rgba(59, 130, 246, 0.18);
      border: 1px solid rgba(125, 211, 252, 0.18);
      color: #60a5fa;
      margin-top: 0.1rem;
      font-size: 0.95rem;
    }

    .hero-meta {
      font-size: 0.86rem;
      line-height: 1.6;
      color: rgba(191, 219, 254, 0.92);
      margin-top: 0.4rem;
      max-width: 420px;
    }

    .hero-illustration {
      margin-top: 1.8rem;
      display: flex;
      justify-content: flex-start;
    }

    .hero-illustration img {
      width: 260px;
      max-width: 100%;
      height: auto;
      filter: drop-shadow(0 24px 36px rgba(15, 23, 42, 0.35));
    }

    .login-content {
      flex: 1 1 65%;
      max-width: 65%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4rem 5rem;
      background: linear-gradient(180deg, rgba(241, 245, 249, 0.4) 0%, rgba(248, 250, 252, 0.9) 100%);
    }

    .login-panel {
      width: min(420px, 100%);
      margin: 0 auto;
    }

    .login-header {
      position: relative;
      z-index: 1;
      text-align: left;
      margin-bottom: 1.85rem;
    }

    .login-brand {
      width: 158px;
      height: auto;
      display: block;
      margin-bottom: 1.65rem;
    }

    .login-title {
      font-size: 1.95rem;
      font-weight: 600;
      margin: 0 0 0.45rem;
      color: var(--lumina-ink);
    }

    .login-subtitle {
      font-size: 1rem;
      color: var(--lumina-muted);
      margin: 0;
    }

    .login-alert {
      position: relative;
      z-index: 1;
      font-size: 0.9rem;
      margin-bottom: 1.05rem;
    }

    .login-alert:last-child {
      margin-bottom: 1.55rem;
    }

    .form-label {
      font-weight: 600;
      color: var(--lumina-ink);
      margin-bottom: 0.4rem;
    }

    .form-control {
      border-radius: 14px;
      padding: 0.9rem 1rem;
      border: 1px solid rgba(148, 163, 184, 0.32);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.65);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background-color: rgba(255, 255, 255, 0.98);
      font-size: 0.97rem;
      color: var(--lumina-ink);
    }

    .form-control::placeholder {
      color: rgba(100, 116, 139, 0.8);
    }

    .form-control:focus {
      border-color: rgba(37, 99, 235, 0.7);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.18);
    }

    .input-group-text {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.32);
      border-left: 0;
      border-radius: 0 14px 14px 0;
      cursor: pointer;
      transition: color 0.2s ease;
      color: var(--lumina-muted);
      padding: 0 0.9rem;
    }

    .input-group-text:hover,
    .input-group-text:focus {
      color: var(--lumina-primary);
    }

    .remember-row {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      margin-bottom: 1.85rem;
      font-size: 0.9rem;
    }

    .form-check-input {
      width: 1rem;
      height: 1rem;
      border-radius: 4px;
      border-color: rgba(148, 163, 184, 0.5);
    }

    .form-check-input:checked {
      background-color: var(--lumina-primary);
      border-color: var(--lumina-primary);
      box-shadow: none;
    }

    .remember-row label {
      margin-bottom: 0;
      color: var(--lumina-muted);
    }

    .forgot-wrap {
      margin-top: 1.25rem;
      text-align: left;
    }

    .forgot-link {
      color: var(--lumina-primary);
      font-weight: 600;
    }

    .auth-meta {
      color: var(--lumina-muted);
      font-size: 0.85rem;
    }

    .auth-meta i {
      color: var(--lumina-primary);
      margin-right: 0.35rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      border: none;
      border-radius: 14px;
      padding: 0.95rem 1rem;
      font-weight: 600;
      letter-spacing: 0.18px;
      box-shadow: 0 24px 42px rgba(37, 99, 235, 0.32);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-primary:hover,
    .btn-primary:focus {
      transform: translateY(-1px);
      box-shadow: 0 28px 48px rgba(37, 99, 235, 0.35);
    }

    .login-footer {
      position: relative;
      z-index: 1;
      margin-top: 2.4rem;
      text-align: center;
      color: var(--lumina-muted);
      font-size: 0.85rem;
    }

    .login-footer strong {
      color: var(--lumina-primary);
    }

    @media (max-width: 1100px) {
      .login-layout {
        flex-direction: column;
        padding: 2.5rem 0;
      }

      .login-hero,
      .login-content {
        flex: none;
        width: 100%;
        max-width: 100%;
      }

      .login-hero {
        margin: 0 1.8rem 2.4rem;
        padding: 2.6rem 2.4rem 2.2rem;
        border-radius: 24px;
        min-height: auto;
        height: auto;
      }

      .hero-illustration {
        justify-content: center;
      }

      .login-content {
        padding: 0 1.8rem 2.8rem;
      }
    }

    @media (max-width: 640px) {
      .login-hero {
        margin: 0 1.2rem 2rem;
        padding: 2.4rem 1.7rem 2rem;
        text-align: center;
      }

      .hero-inner {
        align-items: center;
        text-align: center;
      }

      .hero-list li {
        justify-content: center;
        text-align: left;
      }

      .hero-illustration {
        justify-content: center;
      }

      .login-content {
        padding: 0 1.3rem 2.6rem;
      }

      .forgot-wrap {
        text-align: center;
      }
    }
  </style>
</head>

<body>
  <div class="login-layout">
    <section class="login-hero">
      <div class="hero-inner">
        <span class="hero-eyebrow"><i class="fa-solid fa-sun"></i> LuminaHQ Platform</span>
        <h1 class="hero-title">Clarity for every customer conversation</h1>
        <p class="hero-subtitle">Monitor performance, coach your teams, and orchestrate quality programs in one collaborative workspace.</p>
        <ul class="hero-list">
          <li>
            <span class="hero-icon"><i class="fa-solid fa-check"></i></span>
            <span>Real-time insight into quality, productivity, and coaching impact.</span>
          </li>
          <li>
            <span class="hero-icon"><i class="fa-solid fa-check"></i></span>
            <span>Streamlined workflows that keep support, QA, and operations aligned.</span>
          </li>
          <li>
            <span class="hero-icon"><i class="fa-solid fa-check"></i></span>
            <span>Enterprise-grade controls to protect sensitive customer data.</span>
          </li>
        </ul>
        <p class="hero-meta">Lumina Identity keeps every session secure with single sign-on, adaptive policies, and device-aware trust signals.</p>
        <div class="hero-illustration">
          <img src="https://res.cloudinary.com/dr8qd3xfc/image/upload/v1743438226/vlbpo/huowvct9gus48rwy8sfy.svg" alt="Lumina collaborative dashboard illustration">
        </div>
      </div>
    </section>

    <main class="login-content">
      <div class="login-panel">
        <div class="login-header">
          <img src="https://res.cloudinary.com/dr8qd3xfc/image/upload/v1754763514/vlbpo/lumina/2_eb1h4a.png" alt="Lumina logo" class="login-brand">
          <h1 class="login-title">Welcome back</h1>
          <p class="login-subtitle">Log in to access your LuminaHQ operations hub.</p>
        </div>

        <? if (message) { ?>
          <div id="loginMessage" class="alert alert-info login-alert"><?= message ?></div>
        <? } else { ?>
          <div id="loginMessage" class="alert alert-info login-alert d-none"></div>
        <? } ?>

        <? if (error) { ?>
          <div id="loginError" class="alert alert-danger login-alert"><?= error ?></div>
        <? } else { ?>
          <div id="loginError" class="alert alert-danger login-alert d-none"></div>
        <? } ?>

        <form id="loginForm" class="needs-validation" novalidate>
          <div class="mb-3">
            <label for="loginIdentifier" class="form-label visually-hidden">Email address</label>
            <input type="text" class="form-control" id="loginIdentifier" name="identifier" value="<?= prefillIdentifier || '' ?>" required autocomplete="username" placeholder="Email address">
          </div>

          <div class="mb-3">
            <label for="loginPassword" class="form-label visually-hidden">Password</label>
            <div class="input-group">
              <input type="password" class="form-control" id="loginPassword" name="password" required autocomplete="current-password" placeholder="Password">
              <span class="input-group-text" id="togglePassword" title="Show password"><i class="far fa-eye"></i></span>
            </div>
          </div>

          <div class="remember-row">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="1" id="rememberMe">
              <label class="form-check-label" for="rememberMe">Remember me for 24 hours</label>
            </div>
          </div>

          <input type="hidden" id="returnUrl" value="<?= returnUrl || '' ?>">

          <button type="submit" class="btn btn-primary w-100" id="loginSubmit">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="loginSpinner" role="status" aria-hidden="true"></span>
            Log in
          </button>

          <div class="forgot-wrap">
            <a class="forgot-link" href="mailto:identity@lumina.com?subject=LuminaHQ%20Password%20Reset">Forgot your password?</a>
          </div>
        </form>

        <div class="auth-meta mt-4">
          <i class="fas fa-lock"></i>Need help? Contact your Lumina administrator.
        </div>

        <div class="login-footer">
          <span>Secure access powered by <strong>Lumina Identity</strong>.</span>
        </div>
      </div>
    </main>
  </div>

  <script>
    (function () {
      const form = document.getElementById('loginForm');
      const submitButton = document.getElementById('loginSubmit');
      const spinner = document.getElementById('loginSpinner');
      const messageEl = document.getElementById('loginMessage');
      const errorEl = document.getElementById('loginError');
      const identifierEl = document.getElementById('loginIdentifier');
      const passwordEl = document.getElementById('loginPassword');
      const rememberEl = document.getElementById('rememberMe');
      const returnUrlEl = document.getElementById('returnUrl');
      const togglePasswordEl = document.getElementById('togglePassword');
      const openModeEnabled = <?!= JSON.stringify(typeof openModeEnabled !== 'undefined' ? openModeEnabled : false) ?>;
      let openModeRedirectScheduled = false;

      function isGoogleScriptAvailable() {
        return typeof google !== 'undefined'
          && !!google.script
          && !!google.script.run;
      }

      const scriptUrl = <?!= JSON.stringify(scriptUrl || baseUrl || '') ?>;
      const baseUrl = <?!= JSON.stringify(baseUrl || '') ?>;
      const sessionTokenParam = <?!= JSON.stringify(sessionTokenParam || 'token') ?>;
      const sessionTokenStorageKeys = <?!= JSON.stringify(sessionTokenStorageKeys || ['lumina.session.token', 'lumina.auth.sessionToken', 'lumina.auth.fallbackToken']) ?>;

      function getStorageKeys() {
        return Array.isArray(sessionTokenStorageKeys) && sessionTokenStorageKeys.length
          ? sessionTokenStorageKeys
          : ['lumina.session.token', 'lumina.auth.sessionToken', 'lumina.auth.fallbackToken'];
      }

      function showAlert(element, text, type) {
        if (!element) return;
        if (!text) {
          element.classList.add('d-none');
          element.textContent = '';
          return;
        }
        element.textContent = text;
        element.classList.remove('d-none');
        element.classList.remove('alert-info', 'alert-danger', 'alert-success');
        element.classList.add('alert-' + (type || 'info'));
      }

      function setLoading(isLoading) {
        if (isLoading) {
          submitButton.setAttribute('disabled', 'disabled');
          spinner.classList.remove('d-none');
        } else {
          submitButton.removeAttribute('disabled');
          spinner.classList.add('d-none');
        }
      }

      function clearStoredSession() {
        const keys = getStorageKeys();
        keys.forEach(function (key) {
          try { window.localStorage && window.localStorage.removeItem(key); } catch (_) { }
          try { window.sessionStorage && window.sessionStorage.removeItem(key); } catch (_) { }
        });
        try {
          if (window.CookieHandler && typeof window.CookieHandler.clearAuthToken === 'function') {
            window.CookieHandler.clearAuthToken();
          }
        } catch (err) {
          console.warn('clearStoredSession: unable to clear auth cookie', err);
        }
        try { window.__LUMINA_SESSION_TOKEN__ = ''; } catch (_) { }
      }

      function persistClientSession(token, options) {
        const keys = getStorageKeys();
        if (!token) {
          clearStoredSession();
          return;
        }
        keys.forEach(function (key) {
          try { window.localStorage && window.localStorage.setItem(key, token); } catch (_) { }
          try { window.sessionStorage && window.sessionStorage.setItem(key, token); } catch (_) { }
        });
        try {
          if (window.CookieHandler && typeof window.CookieHandler.persistAuthToken === 'function') {
            window.CookieHandler.persistAuthToken(token, options || {});
          }
        } catch (err) {
          console.warn('persistClientSession: unable to persist auth cookie', err);
        }
        try { window.__LUMINA_SESSION_TOKEN__ = token; } catch (_) { }
      }

      function persistIdentitySnapshot(result) {
        if (!result) {
          try { window.localStorage && window.localStorage.removeItem('lumina.identity.snapshot'); } catch (_) { }
          try { window.sessionStorage && window.sessionStorage.removeItem('lumina.identity.snapshot'); } catch (_) { }
          try {
            window.__LUMINA_IDENTITY_SNAPSHOT__ = null;
            window.__LUMINA_IDENTITY__ = null;
          } catch (_) { }
          return;
        }

        const warnings = Array.isArray(result.warnings)
          ? result.warnings.slice()
          : (Array.isArray(result.identityWarnings) ? result.identityWarnings.slice() : []);
        const identityFields = result.identityFields
          || (result.identity && (result.identity.identityFields || result.identity.fields))
          || (result.user && result.user.IdentityFields)
          || null;
        const identityHeaders = result.identityHeaders
          || (result.identity && result.identity.identityHeaders)
          || (result.user && result.user.IdentityHeaders)
          || null;

        const snapshot = {
          identity: result.identity || null,
          identitySummary: result.identitySummary || result.summary || null,
          identityEvaluation: result.identityEvaluation || result.evaluation || null,
          identityWarnings: warnings,
          identityFields: identityFields,
          identityHeaders: identityHeaders,
          userId: result.user && result.user.ID ? result.user.ID : null,
          email: result.user && result.user.Email ? result.user.Email : null,
          storedAt: new Date().toISOString()
        };

        const serialized = JSON.stringify(snapshot);
        try { window.localStorage && window.localStorage.setItem('lumina.identity.snapshot', serialized); } catch (_) { }
        try { window.sessionStorage && window.sessionStorage.setItem('lumina.identity.snapshot', serialized); } catch (_) { }
        try {
          window.__LUMINA_IDENTITY_SNAPSHOT__ = snapshot;
          window.__LUMINA_IDENTITY__ = snapshot.identity || null;
        } catch (_) { }
      }

      function persistIdentitySnapshotFromContext(state) {
        if (!state) {
          persistIdentitySnapshot(null);
          return;
        }
        const identityContext = state.identity || {};
        persistIdentitySnapshot({
          identity: identityContext.identity || identityContext,
          identitySummary: identityContext.identitySummary || identityContext.summary || null,
          identityEvaluation: identityContext.identityEvaluation || identityContext.evaluation || null,
          identityFields: identityContext.identityFields || identityContext.fields || null,
          identityHeaders: identityContext.identityHeaders || null,
          warnings: identityContext.warnings || identityContext.identityWarnings || [],
          user: state.user || null
        });
      }

      function persistLastIdentifier(identifier) {
        const value = (identifier || '').trim();
        try {
          if (value) {
            window.sessionStorage && window.sessionStorage.setItem('lumina.login.lastIdentifier', value);
            window.localStorage && window.localStorage.setItem('lumina.login.lastIdentifier', value);
          } else {
            window.sessionStorage && window.sessionStorage.removeItem('lumina.login.lastIdentifier');
            window.localStorage && window.localStorage.removeItem('lumina.login.lastIdentifier');
          }
        } catch (_) { }
      }

      function loadLastIdentifier() {
        try {
          if (window.sessionStorage) {
            const sessionValue = window.sessionStorage.getItem('lumina.login.lastIdentifier');
            if (sessionValue) {
              return sessionValue;
            }
          }
        } catch (_) { }
        try {
          if (window.localStorage) {
            const localValue = window.localStorage.getItem('lumina.login.lastIdentifier');
            if (localValue) {
              return localValue;
            }
          }
        } catch (_) { }
        return '';
      }

      function applyStoredIdentifier() {
        if (!identifierEl) {
          return;
        }
        const current = identifierEl.value ? identifierEl.value.trim() : '';
        if (current) {
          return;
        }
        const stored = loadLastIdentifier();
        if (stored) {
          identifierEl.value = stored;
        }
      }

      function persistRememberPreference(value) {
        try {
          window.localStorage && window.localStorage.setItem('lumina.login.remember', value ? '1' : '0');
        } catch (_) { }
      }

      function loadRememberPreference() {
        try {
          if (window.localStorage) {
            const stored = window.localStorage.getItem('lumina.login.remember');
            if (stored === null || typeof stored === 'undefined') {
              return null;
            }
            return stored === '1' || stored === 'true';
          }
        } catch (_) { }
        return null;
      }

      function computeBaseRedirect() {
        const requested = returnUrlEl && returnUrlEl.value ? returnUrlEl.value.trim() : '';
        if (requested) {
          return requested;
        }
        if (scriptUrl) {
          return scriptUrl;
        }
        if (baseUrl) {
          return baseUrl;
        }
        if (typeof window !== 'undefined' && window.location && window.location.href) {
          return window.location.href;
        }
        return '';
      }

      function resolveOpenModeRedirect() {
        const currentHref = (typeof window !== 'undefined' && window.location && window.location.href)
          ? window.location.href
          : '';
        const candidates = [
          returnUrlEl && returnUrlEl.value ? returnUrlEl.value.trim() : '',
          scriptUrl,
          baseUrl,
          'Landing.html',
          'Dashboard.html',
          '/'
        ];

        for (let index = 0; index < candidates.length; index += 1) {
          const candidate = candidates[index];
          if (!candidate) {
            continue;
          }

          let resolved = candidate;
          if (currentHref) {
            try {
              resolved = new URL(candidate, currentHref).toString();
            } catch (err) {
              if (candidate && candidate.charAt(0) !== '/' && !/^https?:/i.test(candidate)) {
                try {
                  const base = new URL(currentHref);
                  base.pathname = candidate;
                  base.search = '';
                  base.hash = '';
                  resolved = base.toString();
                } catch (_) { }
              }
            }
          }

          if (currentHref && resolved === currentHref) {
            continue;
          }

          return resolved;
        }

        return currentHref || 'Landing.html';
      }

      function attachTokenToUrl(url, token) {
        const param = sessionTokenParam || 'token';
        if (!token) {
          return url || computeBaseRedirect();
        }
        const target = url || computeBaseRedirect();
        try {
          const parsed = new URL(target, baseUrl || scriptUrl || window.location.href);
          parsed.searchParams.set(param, token);
          return parsed.toString();
        } catch (err) {
          const separator = target.indexOf('?') === -1 ? '?' : '&';
          return target + separator + encodeURIComponent(param) + '=' + encodeURIComponent(token);
        }
      }

      function handleSuccess(result) {
        setLoading(false);
        persistLastIdentifier(identifierEl.value);
        persistRememberPreference(rememberEl.checked);

        if (!result || result.success !== true) {
          clearStoredSession();
          persistIdentitySnapshot(null);
          const errorText = result && result.error ? result.error : 'Unable to sign in. Please try again.';
          showAlert(errorEl, errorText, 'danger');
          return;
        }

        showAlert(errorEl, '', 'danger');
        showAlert(messageEl, result.message || 'Authenticated successfully.', 'success');

        persistClientSession(result.token, {
          rememberMe: rememberEl.checked,
          expiresAt: result.expiresAt,
          ttlSeconds: result.ttlSeconds
        });
        persistIdentitySnapshot(result);

        const redirectTarget = result.redirectUrlWithToken
          || attachTokenToUrl(result.redirectUrl, result.token);
        setTimeout(function () {
          window.location.href = redirectTarget;
        }, 350);
      }

      function handleFailure(error) {
        setLoading(false);
        clearStoredSession();
        persistIdentitySnapshot(null);
        const text = (error && error.message) ? error.message : 'A network error occurred. Please try again.';
        showAlert(errorEl, text, 'danger');
      }

      function handleOpenModeAccess() {
        if (openModeRedirectScheduled) {
          return;
        }
        openModeRedirectScheduled = true;

        const identifier = identifierEl && identifierEl.value ? identifierEl.value.trim() : '';
        if (identifier) {
          persistLastIdentifier(identifier);
        }
        if (rememberEl) {
          persistRememberPreference(!!rememberEl.checked);
        }

        clearStoredSession();
        persistIdentitySnapshot(null);
        showAlert(errorEl, '', 'danger');
        showAlert(messageEl, 'Lumina Identity is disabled in this open-source build. Redirecting to the workspace…', 'info');
        setLoading(true);

        const target = resolveOpenModeRedirect();
        setTimeout(function () {
          window.location.href = target;
        }, 300);
      }

      function bootstrapFromExistingSession() {
        if (typeof google === 'undefined'
          || !google.script
          || !google.script.run
          || typeof google.script.run.getCurrentAuthContext !== 'function') {
          return;
        }

        google.script.run
          .withSuccessHandler(function (state) {
            if (!state || !state.user || !state.token) {
              clearStoredSession();
              persistIdentitySnapshot(null);
              return;
            }

            persistLastIdentifier(state.user.Email || state.user.UserName || '');

            const ttlSeconds = state.idleTimeoutMinutes
              ? Math.floor(state.idleTimeoutMinutes * 60)
              : undefined;

            persistClientSession(state.token, {
              rememberMe: !!(state.rememberMe || (state.session && state.session.rememberMe)),
              expiresAt: state.expiresAt || (state.session && state.session.expiresAt) || '',
              ttlSeconds: ttlSeconds
            });

            persistIdentitySnapshotFromContext(state);

            const friendlyName = (state.user && (state.user.FullName || state.user.UserName || state.user.Email)) || '';
            if (friendlyName) {
              showAlert(messageEl, 'Welcome back, ' + friendlyName + '. Redirecting…', 'info');
            } else {
              showAlert(messageEl, 'Welcome back. Redirecting…', 'info');
            }
            setLoading(true);
            const redirectTarget = attachTokenToUrl(computeBaseRedirect(), state.token);
            setTimeout(function () {
              window.location.href = redirectTarget;
            }, 300);
          })
          .withFailureHandler(function (err) {
            console.warn('bootstrapFromExistingSession: unable to resolve auth context', err);
          })
          .getCurrentAuthContext();
      }

      form.addEventListener('submit', function (evt) {
        evt.preventDefault();
        evt.stopPropagation();
        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          return;
        }

        if (!isGoogleScriptAvailable()) {
          handleOpenModeAccess();
          return;
        }

        showAlert(errorEl, '', 'danger');
        showAlert(messageEl, 'Signing you in…', 'info');
        setLoading(true);

        const payload = {
          identifier: identifierEl.value.trim(),
          password: passwordEl.value,
          rememberMe: rememberEl.checked,
          returnUrl: returnUrlEl.value,
          userAgent: navigator.userAgent || '',
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || '',
          locale: navigator.language || ''
        };

        persistLastIdentifier(payload.identifier);
        persistRememberPreference(rememberEl.checked);

        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleFailure)
          .clientLogin(payload);
      });

      togglePasswordEl.addEventListener('click', function () {
        const isText = passwordEl.getAttribute('type') === 'text';
        passwordEl.setAttribute('type', isText ? 'password' : 'text');
        const icon = togglePasswordEl.querySelector('i');
        if (icon) {
          icon.classList.toggle('fa-eye');
          icon.classList.toggle('fa-eye-slash');
        }
      });

      rememberEl.addEventListener('change', function () {
        persistRememberPreference(rememberEl.checked);
      });

      applyStoredIdentifier();
      const storedRemember = loadRememberPreference();
      if (storedRemember !== null) {
        rememberEl.checked = storedRemember;
      }

      if (identifierEl && identifierEl.value) {
        setTimeout(function () { passwordEl && passwordEl.focus(); }, 0);
      } else {
        setTimeout(function () { identifierEl && identifierEl.focus(); }, 0);
      }

      bootstrapFromExistingSession();

      if (!isGoogleScriptAvailable()) {
        const existing = messageEl && messageEl.textContent ? messageEl.textContent.trim() : '';
        const notice = openModeEnabled
          ? 'Lumina Identity is disabled in this open-source build. Redirecting to the workspace…'
          : 'Lumina Identity is disabled in this open-source build. Select “Log in” to continue directly to the workspace.';
        const combined = existing ? existing + ' ' + notice : notice;
        showAlert(messageEl, combined.trim(), 'info');
      }

      if (openModeEnabled && !isGoogleScriptAvailable()) {
        setTimeout(function () { handleOpenModeAccess(); }, 120);
      }
    })();
  </script>
</body>

</html>
