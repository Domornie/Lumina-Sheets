<!-- QA Dashboard -->

<?!= includeOnce('ResponsiveStyles') ?>

<?!= include('layout', {
      baseUrl: baseUrl,
      scriptUrl: scriptUrl,
      currentPage: currentPage || 'qadashboard',
      userList: userList,
      granularity: granularity,
      periodValue: periodValue,
      selectedAgent: selectedAgent,
      user: user,
      campaignId: campaignId,
      campaignName: campaignName
    }) ?>

<?
  function __qaBuildPageUrl(page) {
    var base = (typeof baseUrl !== 'undefined' && baseUrl) ? String(baseUrl) : '';
    if (!page) {
      return base || '#';
    }

    if (!base) {
      return '?page=' + page;
    }

    var sanitized = base.replace(/\s+/g, '');
    var hasQuery = sanitized.indexOf('?') !== -1;
    if (hasQuery && /([?&]page=)/i.test(sanitized)) {
      return sanitized.replace(/([?&]page=)[^&#]*/i, '$1' + page);
    }

    var separator = hasQuery ? (/[?&]$/.test(sanitized) ? '' : '&') : '?';
    return sanitized + separator + 'page=' + page;
  }

  var __qaFormUrl = __qaBuildPageUrl('qualityform');
  var __qaListUrl = __qaBuildPageUrl('qalist');
  var __coachingFormUrl = __qaBuildPageUrl('coachingsheet');
  var __collabFormUrl = __qaBuildPageUrl('qualitycollabform');
?>

<style>
  :root {
    --qa-bg: linear-gradient(135deg, #eef2ff 0%, #f8fafc 45%, #f1f5f9 100%);
    --qa-card-bg: rgba(255, 255, 255, 0.94);
    --qa-border: rgba(148, 163, 184, 0.3);
    --qa-primary: #1d4ed8;
    --qa-accent: #38bdf8;
    --qa-success: #16a34a;
    --qa-warning: #f59e0b;
    --qa-danger: #ef4444;
    --qa-muted: #64748b;
    --qa-radius-lg: 20px;
    --qa-radius-md: 14px;
    --qa-shadow: 0 24px 55px rgba(15, 23, 42, 0.12);
    --qa-shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.08);
    --qa-glow: 0 28px 60px rgba(37, 99, 235, 0.12);
  }

  body {
    background: var(--qa-bg);
    min-height: 100vh;
  }

  .qa-shell {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 2rem clamp(1.5rem, 3vw, 3rem) 3.5rem;
  }

  .qa-dashboard {
    font-family: 'Inter', sans-serif;
    color: #0f172a;
  }

  .qa-page-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 1.9rem;
    margin-bottom: 1.75rem;
    align-items: flex-start;
    padding: 1.75rem 1.9rem;
    border-radius: calc(var(--qa-radius-lg) + 6px);
    background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.14), transparent 55%),
      radial-gradient(circle at top right, rgba(14, 165, 233, 0.12), transparent 60%),
      rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(148, 163, 184, 0.18);
    box-shadow: var(--qa-glow);
  }

  .qa-page-header__text {
    max-width: 640px;
  }

  .qa-page-header__eyebrow {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--qa-primary);
    font-weight: 600;
  }

  .qa-page-header__title {
    margin-top: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: clamp(1.6rem, 2.6vw, 2.15rem);
    font-weight: 700;
  }

  .qa-page-header__summary {
    color: #475569;
    font-size: 0.98rem;
  }

  .qa-ai-banner {
    display: inline-flex;
    align-items: center;
    gap: 0.6rem;
    margin-top: 1rem;
    padding: 0.55rem 1.1rem;
    border-radius: 999px;
    background: rgba(37, 99, 235, 0.1);
    color: var(--qa-primary);
    font-weight: 600;
    font-size: 0.9rem;
    box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.18);
  }

  .qa-ai-banner i {
    font-size: 1rem;
  }

  .qa-page-header__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .qa-page-header__actions [data-banner-action] {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border-radius: 999px;
    padding: 0.6rem 1.25rem;
    font-weight: 600;
    border: none;
    text-decoration: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .qa-page-header__actions [data-banner-action]:hover,
  .qa-page-header__actions [data-banner-action]:focus-visible {
    transform: translateY(-1px);
  }

  .qa-dashboard .card {
    border: none;
    border-radius: var(--qa-radius-lg);
    box-shadow: var(--qa-shadow-soft);
    background: var(--qa-card-bg);
    backdrop-filter: blur(6px);
  }

  .qa-dashboard .card-header {
    background: transparent;
    border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    padding: 1.35rem 1.9rem 0.85rem;
    font-weight: 600;
    color: #0f172a;
  }

  .qa-dashboard .card-body {
    padding: 1.9rem;
  }

  .qa-filters {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: nowrap;
    justify-content: flex-start;
    padding: 0.85rem 1.25rem;
    border-radius: var(--qa-radius-lg);
    border: 1px solid rgba(148, 163, 184, 0.22);
    background: rgba(255, 255, 255, 0.96);
    box-shadow: var(--qa-shadow-soft);
    overflow: visible;
  }

  .qa-filters .form-select,
  .qa-filters .form-control {
    border-radius: var(--qa-radius-md);
    border-color: var(--qa-border);
    padding: 0.45rem 2.25rem 0.45rem 0.85rem;
    box-shadow: none;
    flex: 1 1 160px;
    min-width: 140px;
    max-width: 210px;
  }

  .qa-filters .btn-primary {
    background: linear-gradient(135deg, var(--qa-primary), var(--qa-accent));
    border: none;
    border-radius: 999px;
    padding: 0.55rem 1.45rem;
    font-weight: 600;
    box-shadow: 0 12px 28px rgba(37, 99, 235, 0.22);
    flex: 0 0 auto;
  }

  @media (max-width: 768px) {
    .qa-filters {
      flex-wrap: wrap;
    }

    .qa-filters .btn-primary {
      width: 100%;
    }
  }

  .qa-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
    margin-bottom: 1.75rem;
  }

  .qa-summary-card {
    background: var(--qa-card-bg);
    border-radius: var(--qa-radius-lg);
    padding: 1.75rem;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(148, 163, 184, 0.18);
    box-shadow: var(--qa-shadow-soft);
  }

  .qa-summary-card::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), transparent 60%);
    opacity: 0;
    transition: opacity 0.35s ease;
  }

  .qa-summary-card:hover::after {
    opacity: 1;
  }

  .qa-summary-card__label {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--qa-muted);
    margin-bottom: 0.9rem;
  }

  .qa-summary-card__value {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 0.4rem;
  }

  .qa-summary-card__delta {
    font-size: 0.95rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .qa-summary-card__delta.positive {
    color: var(--qa-success);
  }

  .qa-summary-card__delta.negative {
    color: var(--qa-danger);
  }

  .qa-summary-card__delta.neutral {
    color: var(--qa-muted);
  }

  .qa-spotlight-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    align-items: stretch;
  }

  .qa-spotlight-body {
    display: flex;
    flex-direction: column;
    gap: 1.35rem;
  }

  .qa-spotlight-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
  }

  .qa-spotlight-metric {
    background: rgba(255, 255, 255, 0.85);
    border-radius: var(--qa-radius-md);
    border: 1px solid rgba(148, 163, 184, 0.22);
    padding: 1rem 1.15rem;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
  }

  .qa-spotlight-metric__label {
    display: block;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--qa-muted);
    margin-bottom: 0.35rem;
  }

  .qa-spotlight-metric__value {
    display: block;
    font-weight: 700;
    font-size: 1.85rem;
    color: #0f172a;
  }

  .qa-spotlight-metric__delta {
    display: block;
    font-size: 0.85rem;
    font-weight: 500;
    margin-top: 0.35rem;
    color: var(--qa-muted);
  }

  .qa-spotlight-metric__delta.positive {
    color: var(--qa-success);
  }

  .qa-spotlight-metric__delta.negative {
    color: var(--qa-danger);
  }

  .qa-spotlight-chart {
    position: relative;
    height: 160px;
  }

  .qa-spotlight-chart canvas {
    width: 100% !important;
    height: 100% !important;
  }

  .qa-spotlight-note {
    color: #475569;
    font-size: 0.92rem;
  }

  .qa-hero-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
  }

  .qa-hero-grid__item {
    min-width: 0;
  }

  .qa-ai-band {
    width: 100%;
  }

  .qa-section-title {
    font-size: 1.15rem;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 0.75rem;
  }

  .qa-insight-list,
  .qa-action-list {
    display: grid;
    gap: 0.85rem;
  }

  .qa-insight-item,
  .qa-action-item {
    border-radius: var(--qa-radius-md);
    border: 1px solid rgba(148, 163, 184, 0.24);
    background: rgba(255, 255, 255, 0.9);
    padding: 1rem 1.25rem;
    display: grid;
    grid-template-columns: 44px 1fr;
    gap: 1rem;
    align-items: flex-start;
  }

  .qa-insight-icon,
  .qa-action-icon {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    display: grid;
    place-items: center;
    background: rgba(37, 99, 235, 0.12);
    color: var(--qa-primary);
    font-size: 1.2rem;
  }

  .qa-insight-item[data-tone="positive"] .qa-insight-icon {
    background: rgba(16, 185, 129, 0.12);
    color: var(--qa-success);
  }

  .qa-insight-item[data-tone="negative"] .qa-insight-icon,
  .qa-action-item[data-tone="urgent"] .qa-action-icon {
    background: rgba(239, 68, 68, 0.12);
    color: var(--qa-danger);
  }

  .qa-insight-text strong,
  .qa-action-text strong {
    display: block;
    font-weight: 600;
    margin-bottom: 0.3rem;
  }

  .qa-trend-chart-container {
    position: relative;
    height: 440px;
    width: 100%;
  }

  .qa-analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
    gap: 1.75rem;
  }

  .qa-chart-wrapper {
    position: relative;
    height: 360px;
  }

  .qa-chart-wrapper--compact {
    height: 300px;
  }

  .qa-chart-wrapper--bubble {
    height: 340px;
  }

  .qa-chart-wrapper canvas {
    width: 100% !important;
    height: 100% !important;
  }

  .qa-chart-empty {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    text-align: center;
    font-size: 0.9rem;
    color: #64748b;
    padding: 1.5rem;
  }

  .qa-gauge-wrapper {
    position: relative;
    height: 280px;
  }

  .qa-gauge-center {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    font-weight: 700;
    font-size: 1.85rem;
    color: #1e3a8a;
  }

  .qa-gauge-subtext {
    text-align: center;
    margin-top: -0.75rem;
    font-size: 0.85rem;
    color: #475569;
  }

  .qa-intelligence-card {
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.16), rgba(14, 165, 233, 0.08));
    border-radius: var(--qa-radius-lg);
    border: 1px solid rgba(37, 99, 235, 0.24);
    padding: 1.75rem;
    box-shadow: var(--qa-glow);
    display: flex;
    flex-direction: column;
    gap: 1.1rem;
    color: #0f172a;
  }

  .qa-intelligence-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .qa-intelligence-card__eyebrow {
    font-size: 0.82rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: rgba(15, 23, 42, 0.7);
    font-weight: 600;
  }

  .qa-ai-metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.75rem;
    margin-top: 1.25rem;
  }

  .qa-ai-metric {
    background: rgba(255, 255, 255, 0.75);
    border-radius: var(--qa-radius-md);
    padding: 0.75rem 1rem;
    border: 1px solid rgba(148, 163, 184, 0.25);
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
  }

  .qa-ai-metric__label {
    display: block;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--qa-muted);
    margin-bottom: 0.35rem;
  }

  .qa-ai-metric__value {
    font-weight: 700;
    font-size: 1.15rem;
    color: #0f172a;
  }

  .qa-intelligence-card__summary {
    color: #1e293b;
    font-size: 0.95rem;
  }

  .qa-intelligence-card__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .qa-intelligence-card__actions .btn {
    border-radius: 999px;
    padding: 0.55rem 1.2rem;
    font-weight: 600;
  }

  .qa-recognition-list {
    display: flex;
    gap: 0.85rem;
    align-items: stretch;
    flex-wrap: wrap;
  }

  .qa-recognition-note {
    color: #475569;
    font-size: 0.9rem;
    margin-bottom: 1.1rem;
  }

  .qa-coverage-summary {
    color: #475569;
    font-size: 0.92rem;
  }

  .qa-recognition-item {
    display: flex;
    align-items: center;
    gap: 0.85rem;
    padding: 0.75rem 1rem;
    border-radius: var(--qa-radius-lg);
    border: 1px solid rgba(148, 163, 184, 0.25);
    background: #f8fafc;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s ease;
    height: 100%;
    flex: 1 1 220px;
    min-width: 220px;
  }

  .qa-ai-insight-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.1rem;
  }

  .qa-ai-insight-card {
    position: relative;
    border-radius: var(--qa-radius-lg);
    padding: 1.35rem 1.4rem 1.4rem;
    background: linear-gradient(160deg, rgba(37, 99, 235, 0.12), rgba(14, 165, 233, 0.08));
    border: 1px solid rgba(37, 99, 235, 0.22);
    box-shadow: var(--qa-shadow-soft);
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    overflow: hidden;
  }

  .qa-ai-insight-card[data-tone="positive"] {
    border-color: rgba(16, 185, 129, 0.35);
    background: linear-gradient(160deg, rgba(16, 185, 129, 0.14), rgba(37, 99, 235, 0.08));
  }

  .qa-ai-insight-card[data-tone="negative"] {
    border-color: rgba(239, 68, 68, 0.35);
    background: linear-gradient(160deg, rgba(239, 68, 68, 0.12), rgba(37, 99, 235, 0.08));
  }

  .qa-ai-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
    background: rgba(255, 255, 255, 0.75);
    color: var(--qa-primary);
    box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.18);
    width: fit-content;
  }

  .qa-ai-chip i {
    font-size: 0.9rem;
  }

  .qa-ai-insight-card strong {
    font-size: 1.05rem;
  }

  .qa-ai-insight-card p {
    margin-bottom: 0;
    color: #1e293b;
  }

  .qa-ai-insight-empty {
    margin-top: 0.5rem;
    padding: 1.1rem 1.25rem;
    text-align: center;
    border-radius: var(--qa-radius-md);
    border: 1px dashed rgba(148, 163, 184, 0.45);
    background: rgba(255, 255, 255, 0.65);
    color: #64748b;
    font-size: 0.9rem;
  }

  .qa-recognition-item:hover {
    transform: translateY(-2px);
  }

  .qa-recognition-item--first {
    border-color: rgba(245, 158, 11, 0.45);
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.18), rgba(245, 158, 11, 0.05));
  }

  .qa-recognition-item--second {
    border-color: rgba(148, 163, 184, 0.45);
    background: linear-gradient(135deg, rgba(148, 163, 184, 0.18), rgba(226, 232, 240, 0.05));
  }

  .qa-recognition-item--third {
    border-color: rgba(249, 115, 22, 0.35);
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(253, 186, 116, 0.08));
  }

  .qa-recognition-rank {
    width: 3rem;
    height: 3rem;
    border-radius: 999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.05rem;
    color: #0f172a;
    background: rgba(255, 255, 255, 0.9);
    flex-shrink: 0;
  }

  .qa-recognition-item--first .qa-recognition-rank {
    background: #f59e0b;
    color: #fff;
  }

  .qa-recognition-item--second .qa-recognition-rank {
    background: #64748b;
    color: #fff;
  }

  .qa-recognition-item--third .qa-recognition-rank {
    background: #f97316;
    color: #fff;
  }

  .qa-recognition-rank sup {
    font-size: 0.55em;
    margin-left: 2px;
    font-weight: 600;
    top: -0.35em;
    position: relative;
  }

  .qa-recognition-icon {
    font-size: 1.5rem;
    color: var(--qa-primary);
    flex-shrink: 0;
  }

  .qa-recognition-item--first .qa-recognition-icon {
    color: var(--qa-warning);
  }

  .qa-recognition-item--second .qa-recognition-icon {
    color: #64748b;
  }

  .qa-recognition-item--third .qa-recognition-icon {
    color: #f97316;
  }

  .qa-recognition-details {
    flex: 1;
    min-width: 0;
  }

  .qa-recognition-name {
    font-weight: 600;
    color: #0f172a;
  }

  .qa-recognition-score {
    font-weight: 700;
    color: #0f172a;
    font-size: 1.05rem;
  }

  .qa-recognition-meta {
    font-size: 0.85rem;
    color: #64748b;
    margin-top: 0.25rem;
  }

  @media (max-width: 767.98px) {
    .qa-recognition-list {
      flex-direction: column;
    }

    .qa-recognition-item {
      flex: 1 1 auto;
      min-width: 0;
    }
  }

  .qa-recognition-empty {
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
  }

  .qa-signal-list {
    display: grid;
    gap: 1rem;
  }

  .qa-signal-item {
    border-radius: var(--qa-radius-md);
    border: 1px solid rgba(148, 163, 184, 0.22);
    padding: 1rem 1.2rem;
    background: rgba(255, 255, 255, 0.96);
    display: grid;
    gap: 0.35rem;
  }

  .qa-signal-item[data-tone="negative"] {
    border-color: rgba(239, 68, 68, 0.28);
    box-shadow: inset 0 0 0 1px rgba(239, 68, 68, 0.08);
  }

  .qa-signal-item[data-tone="warning"] {
    border-color: rgba(245, 158, 11, 0.28);
    box-shadow: inset 0 0 0 1px rgba(245, 158, 11, 0.08);
  }

  .qa-signal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
  }

  .qa-signal-title {
    font-weight: 600;
    color: #0f172a;
  }

  .qa-signal-badge {
    border-radius: 999px;
    padding: 0.25rem 0.65rem;
    font-size: 0.75rem;
    font-weight: 600;
    background: rgba(37, 99, 235, 0.1);
    color: var(--qa-primary);
  }

  .qa-signal-badge.negative {
    background: rgba(239, 68, 68, 0.12);
    color: var(--qa-danger);
  }

  .qa-signal-badge.warning {
    background: rgba(245, 158, 11, 0.16);
    color: var(--qa-warning);
  }

  .qa-signal-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.85rem;
    color: #475569;
  }

  .qa-signal-note {
    font-size: 0.85rem;
    color: #475569;
  }

  .qa-signal-empty {
    text-align: center;
    font-size: 0.9rem;
    color: #64748b;
  }

  .qa-insight-count {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: var(--qa-primary);
  }

  .qa-trend-chart-container canvas {
    width: 100% !important;
    height: 100% !important;
    display: block;
  }

  .qa-trend-summary {
    margin-top: 1.5rem;
    padding: 1.1rem 1.3rem;
    border-radius: var(--qa-radius-md);
    background: rgba(37, 99, 235, 0.08);
    color: #1e3a8a;
    font-weight: 500;
    line-height: 1.5;
  }

  .qa-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .qa-table thead th {
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    color: var(--qa-muted);
    border: none;
    padding: 0.75rem 0.6rem;
    background: transparent;
  }

  .qa-table tbody tr {
    border-radius: var(--qa-radius-md);
    background: rgba(255, 255, 255, 0.9);
    box-shadow: 0 1px 0 rgba(15, 23, 42, 0.04);
  }

  .qa-table tbody td {
    padding: 0.9rem 0.6rem;
    vertical-align: middle;
    border-top: 1px solid rgba(148, 163, 184, 0.18);
  }

  .qa-delta-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.65rem;
  }

  .qa-delta-badge.positive {
    background: rgba(16, 185, 129, 0.12);
    color: var(--qa-success);
  }

  .qa-delta-badge.negative {
    background: rgba(239, 68, 68, 0.12);
    color: var(--qa-danger);
  }

  .qa-delta-badge.neutral {
    background: rgba(148, 163, 184, 0.2);
    color: #475569;
  }

  .qa-empty-state {
    text-align: center;
    padding: 4rem 1rem;
    border-radius: var(--qa-radius-lg);
    border: 2px dashed rgba(148, 163, 184, 0.3);
    background: rgba(255, 255, 255, 0.7);
    color: #475569;
  }

  .qa-empty-state i {
    font-size: 2rem;
    color: var(--qa-primary);
    margin-bottom: 0.75rem;
  }

  .qa-loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(247, 249, 252, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
    border-radius: var(--qa-radius-lg);
  }

  .qa-dashboard.is-loading .qa-loading-overlay {
    display: flex;
  }

  .qa-spinner {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 4px solid rgba(37, 99, 235, 0.15);
    border-top-color: var(--qa-primary);
    animation: qa-spin 0.9s linear infinite;
  }

  @keyframes qa-spin {
    to {
      transform: rotate(360deg);
    }
  }

  .qa-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    border-radius: 999px;
    padding: 0.35rem 0.75rem;
    background: rgba(37, 99, 235, 0.08);
    color: var(--qa-primary);
    font-weight: 600;
    font-size: 0.85rem;
  }

  .qa-next-best {
    border-radius: var(--qa-radius-lg);
    border: 1px solid rgba(37, 99, 235, 0.18);
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(14, 165, 233, 0.08));
    padding: 1.25rem 1.5rem;
    display: flex;
    gap: 0.85rem;
    align-items: flex-start;
    margin-top: 1.25rem;
  }

  .qa-next-best i {
    color: var(--qa-primary);
    font-size: 1.5rem;
  }

  .qa-next-best strong {
    display: block;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 0.2rem;
  }

  .qa-dashboard-alert {
    margin-top: 1rem;
  }

  @media (max-width: 992px) {
    .qa-filters {
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    .qa-insight-item,
    .qa-action-item {
      grid-template-columns: 36px 1fr;
    }

    .qa-trend-chart-container {
      height: 360px;
    }

    .qa-spotlight-grid,
    .qa-hero-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .qa-page-header__actions {
      width: 100%;
    }

    .qa-page-header {
      padding: 1.35rem 1.4rem;
    }
  }
</style>

<div class="qa-shell position-relative qa-dashboard" id="qa-dashboard">
  <div class="qa-loading-overlay">
    <div class="qa-spinner"></div>
  </div>

  <header class="qa-page-header" data-banner-source>
    <div class="qa-page-header__text">
      <span class="qa-page-header__eyebrow" data-banner-eyebrow>
        <i class="fa-solid fa-shield-check"></i>
        Quality Assurance
      </span>
      <h1 class="qa-page-header__title" data-banner-title>QA Performance Command Center</h1>
      <p class="qa-page-header__summary mb-0" id="qa-context-summary" data-banner-description>
        Monitor live quality health, trending scores, and AI-powered recommendations across your teams.
      </p>
      <div class="qa-ai-banner" id="qa-ai-signal">
        <i class="fa-solid fa-robot"></i>
        AI is synthesizing your quality telemetry in real time.
      </div>
    </div>
    <div class="qa-page-header__actions" data-banner-source>
      <a class="btn btn-primary" href="<?= __qaFormUrl ?>" data-banner-action data-banner-icon="fa-solid fa-clipboard-check" data-banner-variant="primary">
        <i class="fa-solid fa-clipboard-check"></i>
        <span>QA Form</span>
      </a>
      <a class="btn btn-outline-info" href="<?= __qaListUrl ?>" data-banner-action data-banner-icon="fa-solid fa-list-check" data-banner-variant="secondary">
        <i class="fa-solid fa-list-check"></i>
        <span>QA List</span>
      </a>
      <a class="btn btn-outline-primary" href="<?= __coachingFormUrl ?>" data-banner-action data-banner-icon="fa-solid fa-file-signature" data-banner-variant="secondary">
        <i class="fa-solid fa-file-signature"></i>
        <span>Coaching Form</span>
      </a>
      <a class="btn btn-outline-secondary" href="<?= __collabFormUrl ?>" data-banner-action data-banner-icon="fa-solid fa-people-arrows" data-banner-variant="secondary">
        <i class="fa-solid fa-people-arrows"></i>
        <span>Collaboration Form</span>
      </a>
    </div>
  </header>

  <div class="qa-filters" role="group" aria-label="QA filters">
    <select id="qa-granularity" class="form-select" aria-label="Select time grouping">
      <option value="Week">Week</option>
      <option value="Month">Month</option>
      <option value="Quarter">Quarter</option>
      <option value="Year">Year</option>
    </select>
    <select id="qa-period" class="form-select" aria-label="Select reporting period">
      <option value="">Latest Period</option>
    </select>
    <select id="qa-agent" class="form-select" aria-label="Select agent">
      <option value="">All Agents</option>
    </select>
    <button type="button" class="btn btn-primary" id="qa-refresh">
      <i class="fa-solid fa-rotate"></i>
      <span class="ms-1">Refresh</span>
    </button>
  </div>

  <div class="qa-summary-grid mt-4" id="qa-summary-cards">
      <div class="qa-summary-card" data-metric="avg">
        <div class="qa-summary-card__label">Team Average QA Score</div>
        <div class="qa-summary-card__value" data-role="value">--</div>
        <div class="qa-summary-card__delta neutral" data-role="delta">Awaiting data</div>
      </div>
      <div class="qa-summary-card" data-metric="pass">
        <div class="qa-summary-card__label">Team Pass Rate</div>
        <div class="qa-summary-card__value" data-role="value">--</div>
        <div class="qa-summary-card__delta neutral" data-role="delta">Awaiting data</div>
      </div>
      <div class="qa-summary-card" data-metric="coverage">
        <div class="qa-summary-card__label">Agent Coverage</div>
        <div class="qa-summary-card__value" data-role="value">--</div>
        <div class="qa-summary-card__delta neutral" data-role="delta">Awaiting data</div>
      </div>
      <div class="qa-summary-card" data-metric="evaluations">
        <div class="qa-summary-card__label">Evaluations Logged</div>
        <div class="qa-summary-card__value" data-role="value">--</div>
        <div class="qa-summary-card__delta neutral" data-role="delta">Awaiting data</div>
      </div>
    </div>

  <div class="alert alert-danger d-none qa-dashboard-alert" id="qa-dashboard-error"></div>

  <div class="qa-empty-state d-none" id="qa-empty-state">
    <i class="fa-solid fa-chart-line"></i>
    <h4 class="fw-semibold mb-2">No evaluations found for the selected filters</h4>
    <p class="mb-0">Adjust your filters or capture new QA reviews to populate this dashboard.</p>
  </div>

  <div class="qa-spotlight-grid mt-4" id="qa-spotlight-grid">
    <div class="qa-spotlight-grid__item">
      <div class="card qa-health-card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Quality Health Overview</span>
          <span class="badge bg-light text-primary" id="qa-health-period">Live</span>
        </div>
        <div class="card-body">
          <div class="qa-gauge-wrapper mb-3">
            <canvas id="qa-gauge-chart"></canvas>
            <div class="qa-gauge-center" id="qa-gauge-value">--</div>
          </div>
          <div class="qa-gauge-subtext">Average QA Score</div>
          <div class="qa-ai-metric-grid">
            <div class="qa-ai-metric">
              <span class="qa-ai-metric__label">AI Confidence</span>
              <span class="qa-ai-metric__value" id="qa-ai-confidence">--</span>
            </div>
            <div class="qa-ai-metric">
              <span class="qa-ai-metric__label">Projected Trend</span>
              <span class="qa-ai-metric__value" id="qa-ai-projection">--</span>
            </div>
          </div>
          <div class="qa-chart-wrapper qa-chart-wrapper--compact mt-4">
            <canvas id="qa-outcome-chart"></canvas>
            <div class="qa-chart-empty d-none" id="qa-outcome-empty">Awaiting evaluation data.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="qa-spotlight-grid__item">
      <div class="card qa-spotlight-card h-100" id="qa-spotlight-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Agent Spotlight</span>
          <span class="badge bg-light text-primary" id="qa-spotlight-context">All Agents</span>
        </div>
        <div class="card-body">
          <div class="qa-spotlight-body">
            <div class="qa-spotlight-metrics">
              <div class="qa-spotlight-metric">
                <span class="qa-spotlight-metric__label">QA Score</span>
                <span class="qa-spotlight-metric__value" id="qa-spotlight-score">--</span>
                <span class="qa-spotlight-metric__delta neutral" id="qa-spotlight-score-delta">Awaiting data</span>
              </div>
              <div class="qa-spotlight-metric">
                <span class="qa-spotlight-metric__label">Pass Rate</span>
                <span class="qa-spotlight-metric__value" id="qa-spotlight-pass">--</span>
                <span class="qa-spotlight-metric__delta neutral" id="qa-spotlight-pass-delta">Awaiting data</span>
              </div>
              <div class="qa-spotlight-metric">
                <span class="qa-spotlight-metric__label">Evaluations</span>
                <span class="qa-spotlight-metric__value" id="qa-spotlight-evaluations">--</span>
                <span class="qa-spotlight-metric__delta neutral" id="qa-spotlight-share">Awaiting data</span>
              </div>
            </div>
            <div class="qa-spotlight-chart">
              <canvas id="qa-spotlight-spark"></canvas>
              <div class="qa-chart-empty d-none" id="qa-spotlight-empty">More evaluations needed to chart agent momentum.</div>
            </div>
          </div>
          <p class="qa-spotlight-note mb-0" id="qa-spotlight-note">Select an agent to see individual quality momentum.</p>
        </div>
      </div>
    </div>
    <div class="qa-spotlight-grid__item">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="fa-solid fa-trophy text-warning" aria-hidden="true"></i>
          <span>Quality Recognition</span>
        </div>
        <div class="card-body">
          <p class="qa-recognition-note" id="qa-recognition-note">
            The top three agents each period will be highlighted here once evaluations are available.
          </p>
          <div class="qa-recognition-empty" id="qa-quality-recognition-empty">
            <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
            <span>Quality champions will appear here once evaluations are available.</span>
          </div>
          <div class="qa-recognition-list d-none" id="qa-quality-recognition" aria-live="polite" role="list"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="qa-ai-band mt-4" id="qa-ai-band">
    <div class="qa-intelligence-card h-100">
      <div class="qa-intelligence-card__header">
        <div class="qa-insight-count">
          <i class="fa-solid fa-robot"></i>
          <span id="qa-insight-count">0 AI insights</span>
        </div>
        <span class="qa-intelligence-card__eyebrow">AI Recommendations &amp; Insights</span>
      </div>
      <p class="qa-intelligence-card__summary mb-0" id="qa-intel-summary">
        AI-generated recommendations will populate once fresh QA data is available.
      </p>
      <div id="qa-next-best" class="qa-next-best d-none"></div>
      <div class="qa-intelligence-card__actions">
        <button type="button" class="btn btn-outline-primary" id="qa-open-insights" data-bs-toggle="modal" data-bs-target="#qaInsightsModal">
          <i class="fa-solid fa-lightbulb me-2"></i>View AI Insights
        </button>
        <button type="button" class="btn btn-primary" id="qa-open-actions" data-bs-toggle="modal" data-bs-target="#qaActionsModal">
          <i class="fa-solid fa-list-check me-2"></i>View Recommendations
        </button>
      </div>
    </div>
  </div>

  <div class="qa-hero-grid mt-4" id="qa-dashboard-content">
    <div class="qa-hero-grid__item">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Score Trajectory</span>
          <span class="badge bg-light text-primary" id="qa-trend-granularity">Weekly</span>
        </div>
        <div class="card-body">
          <div class="qa-trend-chart-container">
            <canvas id="qa-trend-chart"></canvas>
          </div>
          <div class="qa-trend-summary mt-3" id="qa-trend-summary">
            Trend analysis will appear once data is loaded.
          </div>
        </div>
      </div>
    </div>
    <div class="qa-hero-grid__item">
      <div class="card h-100">
        <div class="card-header">Coverage &amp; Volume</div>
        <div class="card-body">
          <div class="qa-chart-wrapper">
            <canvas id="qa-coverage-chart"></canvas>
            <div class="qa-chart-empty d-none" id="qa-coverage-empty">Historical coverage data required.</div>
          </div>
          <div class="qa-coverage-summary mt-3" id="qa-coverage-summary">Coverage analytics will appear once multiple periods are available.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1" id="qa-intelligence-row">
    <div class="col-12">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="fa-solid fa-brain-circuit text-primary" aria-hidden="true"></i>
          <span>AI Highlights</span>
        </div>
        <div class="card-body">
          <div class="qa-ai-insight-grid" id="qa-insight-highlights" aria-live="polite"></div>
          <div class="qa-ai-insight-empty" id="qa-insight-highlights-empty">
            <i class="fa-solid fa-robot me-2" aria-hidden="true"></i>
            <span>Real-time AI narratives will appear once fresh QA data is processed.</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1" id="qa-analytics-row">
    <div class="col-12 col-xl-6 col-xxl-4">
      <div class="card h-100">
        <div class="card-header">Category Score Breakdown</div>
        <div class="card-body">
          <div class="qa-chart-wrapper">
            <canvas id="qa-category-chart"></canvas>
            <div class="qa-chart-empty d-none" id="qa-category-empty">Category performance will appear here.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-6 col-xxl-4">
      <div class="card h-100">
        <div class="card-header">Agent Evaluation Volume</div>
        <div class="card-body">
          <div class="qa-chart-wrapper">
            <canvas id="qa-agent-chart"></canvas>
            <div class="qa-chart-empty d-none" id="qa-agent-empty">Agent evaluation data will appear once loaded.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-6 col-xxl-4">
      <div class="card h-100">
        <div class="card-header">Score Distribution</div>
        <div class="card-body">
          <div class="qa-chart-wrapper">
            <canvas id="qa-distribution-chart"></canvas>
            <div class="qa-chart-empty d-none" id="qa-distribution-empty">Distribution requires agent scoring data.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-6 col-xxl-4">
      <div class="card h-100">
        <div class="card-header">Agent Quality Composition</div>
        <div class="card-body">
          <div class="qa-chart-wrapper">
            <canvas id="qa-agent-stacked"></canvas>
            <div class="qa-chart-empty d-none" id="qa-agent-stacked-empty">Top agent quality mix will appear with evaluation data.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row g-4 mt-1" id="qa-advanced-analytics-row">
    <div class="col-12 col-xl-6 col-xxl-4">
      <div class="card h-100">
        <div class="card-header">Category Performance Radar</div>
        <div class="card-body">
          <div class="qa-chart-wrapper qa-chart-wrapper--compact">
            <canvas id="qa-category-radar"></canvas>
            <div class="qa-chart-empty d-none" id="qa-category-radar-empty">Radar insights activate once category metrics load.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-6 col-xxl-4">
      <div class="card h-100">
        <div class="card-header">Program Mix Polar View</div>
        <div class="card-body">
          <div class="qa-chart-wrapper qa-chart-wrapper--compact">
            <canvas id="qa-program-polar"></canvas>
            <div class="qa-chart-empty d-none" id="qa-program-polar-empty">Program mix will display once evaluation data is captured.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xxl-4">
      <div class="card h-100">
        <div class="card-header">Agent Impact Matrix</div>
        <div class="card-body">
          <div class="qa-chart-wrapper qa-chart-wrapper--bubble">
            <canvas id="qa-agent-impact"></canvas>
            <div class="qa-chart-empty d-none" id="qa-agent-impact-empty">Impact bubbles appear once agent score, pass rate, and evaluation volume are available.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row g-4 mt-1" id="qa-signal-row">
    <div class="col-12 col-xl-5">
      <div class="card h-100">
        <div class="card-header">Critical Question Signals</div>
        <div class="card-body">
          <div id="qa-question-empty" class="qa-signal-empty">Need more evaluations to surface question-level risk.</div>
          <div class="qa-signal-list" id="qa-question-signals"></div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-4">
      <div class="card h-100">
        <div class="card-header">Program Performance</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-borderless align-middle qa-table">
              <thead>
                <tr>
                  <th>Program</th>
                  <th class="text-center">Avg Score</th>
                  <th class="text-center">Pass Rate</th>
                  <th class="text-center">Evals</th>
                </tr>
              </thead>
              <tbody id="qa-program-body">
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">Awaiting data</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-3">
      <div class="card h-100">
        <div class="card-header">Quality Signal Radar</div>
        <div class="card-body">
          <div class="qa-signal-list" id="qa-signal-radar"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1" id="qa-lower-section">
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header">Category Performance</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-borderless align-middle qa-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th class="text-center">Avg Score</th>
                  <th class="text-center">Trend</th>
                </tr>
              </thead>
              <tbody id="qa-categories-body">
                <tr>
                  <td colspan="3" class="text-center text-muted py-4">Awaiting data</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header">Agent Leaderboard</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-borderless align-middle qa-table">
              <thead>
                <tr>
                  <th>Agent</th>
                  <th class="text-center">Score</th>
                  <th class="text-center">Pass Rate</th>
                  <th class="text-center">Evaluations</th>
                </tr>
              </thead>
              <tbody id="qa-agents-body">
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">Awaiting data</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12">
      <div class="card h-100" id="qa-notes-card">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
          <span>Latest Evaluation Notes</span>
          <small class="text-muted" id="qa-notes-meta">Awaiting evaluations</small>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-borderless align-middle qa-table">
              <thead>
                <tr>
                  <th style="width: 45%;">Question</th>
                  <th class="text-center" style="width: 10%;">Weight</th>
                  <th class="text-center" style="width: 15%;">Response</th>
                  <th style="width: 30%;">Notes</th>
                </tr>
              </thead>
              <tbody id="qa-notes-body">
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">Awaiting data</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="qaInsightsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-lightbulb me-2 text-primary"></i>AI Insights</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="qa-insight-list" id="qa-insights"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="qaActionsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-list-check me-2 text-primary"></i>Recommended Actions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="qa-action-list" id="qa-actions"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const dashboardEl = document.getElementById('qa-dashboard');
    if (!dashboardEl) {
      return;
    }

    const state = {
      filters: {
        granularity: 'Week',
        period: '',
        agent: '',
        campaignId: '',
        program: ''
      },
      loading: false,
      data: null,
      agentLookup: {},
      charts: {
        trend: null,
        gauge: null,
        outcomes: null,
        categories: null,
        agents: null,
        distribution: null,
        categoryRadar: null,
        programPolar: null,
        agentImpact: null,
        coverage: null,
        spotlightSpark: null,
        agentStacked: null
      },
      modals: {
        insights: null,
        actions: null
      }
    };

    const dom = {
      granularity: document.getElementById('qa-granularity'),
      period: document.getElementById('qa-period'),
      agent: document.getElementById('qa-agent'),
      refresh: document.getElementById('qa-refresh'),
      summaryCards: dashboardEl.querySelectorAll('[data-metric]'),
      error: document.getElementById('qa-dashboard-error'),
      empty: document.getElementById('qa-empty-state'),
      content: document.getElementById('qa-dashboard-content'),
      lower: document.getElementById('qa-lower-section'),
      trendGranularity: document.getElementById('qa-trend-granularity'),
      trendSummary: document.getElementById('qa-trend-summary'),
      trendCanvas: document.getElementById('qa-trend-chart'),
      insights: document.getElementById('qa-insights'),
      actions: document.getElementById('qa-actions'),
      nextBest: document.getElementById('qa-next-best'),
      healthPeriod: document.getElementById('qa-health-period'),
      spotlightCard: document.getElementById('qa-spotlight-card'),
      spotlightContext: document.getElementById('qa-spotlight-context'),
      spotlightScore: document.getElementById('qa-spotlight-score'),
      spotlightScoreDelta: document.getElementById('qa-spotlight-score-delta'),
      spotlightPass: document.getElementById('qa-spotlight-pass'),
      spotlightPassDelta: document.getElementById('qa-spotlight-pass-delta'),
      spotlightEvaluations: document.getElementById('qa-spotlight-evaluations'),
      spotlightShare: document.getElementById('qa-spotlight-share'),
      spotlightNote: document.getElementById('qa-spotlight-note'),
      spotlightChart: document.getElementById('qa-spotlight-spark'),
      spotlightEmpty: document.getElementById('qa-spotlight-empty'),
      coverageCanvas: document.getElementById('qa-coverage-chart'),
      coverageEmpty: document.getElementById('qa-coverage-empty'),
      coverageSummary: document.getElementById('qa-coverage-summary'),
      categoriesBody: document.getElementById('qa-categories-body'),
      agentsBody: document.getElementById('qa-agents-body'),
      contextSummary: document.getElementById('qa-context-summary'),
      insightCount: document.getElementById('qa-insight-count'),
      intelSummary: document.getElementById('qa-intel-summary'),
      analyticsRow: document.getElementById('qa-analytics-row'),
      gaugeCanvas: document.getElementById('qa-gauge-chart'),
      gaugeValue: document.getElementById('qa-gauge-value'),
      outcomeCanvas: document.getElementById('qa-outcome-chart'),
      categoryCanvas: document.getElementById('qa-category-chart'),
      agentCanvas: document.getElementById('qa-agent-chart'),
      distributionCanvas: document.getElementById('qa-distribution-chart'),
      recognitionList: document.getElementById('qa-quality-recognition'),
      recognitionNotice: document.getElementById('qa-recognition-note'),
      recognitionEmpty: document.getElementById('qa-quality-recognition-empty'),
      agentStackedCanvas: document.getElementById('qa-agent-stacked'),
      agentStackedEmpty: document.getElementById('qa-agent-stacked-empty'),
      outcomeEmpty: document.getElementById('qa-outcome-empty'),
      categoryEmpty: document.getElementById('qa-category-empty'),
      agentEmpty: document.getElementById('qa-agent-empty'),
      distributionEmpty: document.getElementById('qa-distribution-empty'),
      categoryRadarCanvas: document.getElementById('qa-category-radar'),
      categoryRadarEmpty: document.getElementById('qa-category-radar-empty'),
      programPolarCanvas: document.getElementById('qa-program-polar'),
      programPolarEmpty: document.getElementById('qa-program-polar-empty'),
      agentImpactCanvas: document.getElementById('qa-agent-impact'),
      agentImpactEmpty: document.getElementById('qa-agent-impact-empty'),
      aiSignal: document.getElementById('qa-ai-signal'),
      aiConfidence: document.getElementById('qa-ai-confidence'),
      aiProjection: document.getElementById('qa-ai-projection'),
      insightHighlights: document.getElementById('qa-insight-highlights'),
      insightHighlightsEmpty: document.getElementById('qa-insight-highlights-empty'),
      openInsights: document.getElementById('qa-open-insights'),
      openActions: document.getElementById('qa-open-actions'),
      insightsModal: document.getElementById('qaInsightsModal'),
      actionsModal: document.getElementById('qaActionsModal'),
      questionSignals: document.getElementById('qa-question-signals'),
      questionEmpty: document.getElementById('qa-question-empty'),
      programBody: document.getElementById('qa-program-body'),
      signalRadar: document.getElementById('qa-signal-radar'),
      notesBody: document.getElementById('qa-notes-body'),
      notesMeta: document.getElementById('qa-notes-meta'),
      notesCard: document.getElementById('qa-notes-card')
    };

    function tooltipPercentLabel(context) {
      if (!context) {
        return '';
      }

      const datasetLabel = context.dataset && typeof context.dataset.label === 'string'
        ? context.dataset.label
        : '';
      const label = datasetLabel || (typeof context.label === 'string' ? context.label : 'Value');

      let value = 0;
      if (context.parsed && typeof context.parsed === 'object') {
        if (typeof context.parsed.y === 'number') {
          value = context.parsed.y;
        } else if (typeof context.parsed.x === 'number') {
          value = context.parsed.x;
        } else if (typeof context.parsed === 'number') {
          value = context.parsed;
        }
      } else if (typeof context.parsed === 'number') {
        value = context.parsed;
      }

      return `${label}: ${Math.round(value)}%`;
    }

    function tooltipCountLabel(context) {
      if (!context) {
        return '';
      }

      const datasetLabel = context.dataset && typeof context.dataset.label === 'string'
        ? context.dataset.label
        : '';
      const label = datasetLabel || (typeof context.label === 'string' ? context.label : 'Value');

      let value = 0;
      if (context.parsed && typeof context.parsed === 'object') {
        if (typeof context.parsed.y === 'number') {
          value = context.parsed.y;
        } else if (typeof context.parsed.x === 'number') {
          value = context.parsed.x;
        }
      } else if (typeof context.parsed === 'number') {
        value = context.parsed;
      }

      return `${label}: ${Math.round(value)}`;
    }

    function tooltipBubbleLabel(context) {
      if (!context || !context.raw) {
        return '';
      }

      const raw = context.raw;
      const name = raw.name || context.label || (context.dataset && context.dataset.label) || 'Agent';
      const lines = [name];

      if (typeof raw.x === 'number' && !Number.isNaN(raw.x)) {
        lines.push(`Avg Score: ${Math.round(raw.x)}%`);
      }
      if (typeof raw.y === 'number' && !Number.isNaN(raw.y)) {
        lines.push(`Pass Rate: ${Math.round(raw.y)}%`);
      }
      if (typeof raw.count === 'number' && !Number.isNaN(raw.count)) {
        lines.push(`Evaluations: ${formatNumber(raw.count)}`);
      }

      return lines;
    }

    function percentTickFormatter(value) {
      return `${value}%`;
    }

    function setLoading(isLoading) {
      state.loading = isLoading;
      dashboardEl.classList.toggle('is-loading', Boolean(isLoading));
      if (dom.refresh) {
        dom.refresh.disabled = Boolean(isLoading);
      }
    }

    function destroyChart(key) {
      if (!state.charts || !state.charts[key]) {
        return;
      }
      try {
        state.charts[key].destroy();
      } catch (chartError) {
        console.warn('Unable to destroy chart', key, chartError);
      }
      state.charts[key] = null;
    }

    function safePercent(value) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return '--';
      }
      return `${Math.round(value)}%`;
    }

    function formatNumber(value) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return '--';
      }
      return new Intl.NumberFormat().format(value);
    }

    function normalizePercent(value) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return 0;
      }
      return Math.min(100, Math.max(0, Number(value)));
    }

    function formatNameList(values) {
      const names = Array.isArray(values) ? values.filter(Boolean) : [];
      if (!names.length) {
        return '';
      }
      if (names.length === 1) {
        return names[0];
      }
      if (names.length === 2) {
        return `${names[0]} and ${names[1]}`;
      }
      return `${names.slice(0, -1).join(', ')}, and ${names[names.length - 1]}`;
    }

    function updateAiSignal(summary) {
      if (!dom.aiSignal) {
        return;
      }

      let message = 'AI is monitoring your quality telemetry.';

      if (summary && typeof summary.avg === 'number' && !Number.isNaN(summary.avg)) {
        const avgScore = Math.round(summary.avg);
        const avgDelta = summary && summary.delta && typeof summary.delta.avg === 'number'
          ? Math.round(summary.delta.avg * 10) / 10
          : null;

        if (avgScore >= 92) {
          message = `AI projects sustained excellence with an average QA score of ${avgScore}%.`;
        } else if (avgScore >= 85) {
          message = `AI anticipates steady performance with an average QA score of ${avgScore}%.`;
        } else if (avgScore >= 75) {
          message = `AI flags growth opportunities  average QA score is ${avgScore}% and trending for optimization.`;
        } else {
          message = `AI is prioritizing recovery playbooks  average QA score is ${avgScore}% and needs attention.`;
        }

        if (avgDelta !== null && !Number.isNaN(avgDelta) && Math.abs(avgDelta) >= 0.5) {
          const momentum = avgDelta > 0 ? 'upward momentum' : 'downward pressure';
          const indicator = avgDelta > 0 ? '' : '';
          message += ` Current momentum shows ${momentum} ${indicator} ${Math.abs(avgDelta)} pts vs prior.`;
        }
      }

      dom.aiSignal.textContent = message;
    }

    function updateAiHealthMetrics(summary, trend) {
      if (dom.aiConfidence) {
        let confidenceText = '--';
        if (summary && typeof summary.evaluations === 'number' && !Number.isNaN(summary.evaluations)) {
          if (summary.evaluations >= 100) {
            confidenceText = 'High';
          } else if (summary.evaluations >= 40) {
            confidenceText = 'Medium';
          } else if (summary.evaluations > 0) {
            confidenceText = 'Developing';
          } else {
            confidenceText = 'Awaiting data';
          }
        } else {
          confidenceText = 'Awaiting data';
        }
        dom.aiConfidence.textContent = confidenceText;
      }

      if (dom.aiProjection) {
        let projectionText = 'Awaiting history';
        const series = trend && Array.isArray(trend.series) ? trend.series : [];
        if (series.length >= 2) {
          const latest = series[series.length - 1];
          const previous = series[series.length - 2];
          if (latest && previous && typeof latest.avgScore === 'number' && typeof previous.avgScore === 'number') {
            const delta = Math.round((latest.avgScore - previous.avgScore) * 10) / 10;
            if (delta > 1) {
              projectionText = `Accelerating  ${delta} pts`;
            } else if (delta < -1) {
              projectionText = `Cooling  ${Math.abs(delta)} pts`;
            } else {
              projectionText = `Stabilizing at ${Math.round(latest.avgScore)}%`;
            }
          }
        } else if (summary && summary.delta && typeof summary.delta.avg === 'number') {
          const delta = Math.round(summary.delta.avg * 10) / 10;
          if (delta > 0.5) {
            projectionText = `Climbing  ${delta} pts`;
          } else if (delta < -0.5) {
            projectionText = `Softening  ${Math.abs(delta)} pts`;
          } else {
            projectionText = 'Holding steady';
          }
        }

        dom.aiProjection.textContent = projectionText;
      }
    }

    function getOrdinalSuffix(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) {
        return '';
      }
      const abs = Math.abs(num);
      const mod100 = abs % 100;
      if (mod100 >= 11 && mod100 <= 13) {
        return 'th';
      }
      switch (abs % 10) {
        case 1:
          return 'st';
        case 2:
          return 'nd';
        case 3:
          return 'rd';
        default:
          return 'th';
      }
    }

    function getRecognitionTierClass(rank) {
      switch (rank) {
        case 1:
          return 'qa-recognition-item--first';
        case 2:
          return 'qa-recognition-item--second';
        case 3:
          return 'qa-recognition-item--third';
        default:
          return '';
      }
    }

    function formatDelta(value, isPercent) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return { text: 'No prior period', tone: 'neutral' };
      }
      const rounded = Math.round(value * 10) / 10;
      if (rounded === 0) {
        return { text: 'No change', tone: 'neutral' };
      }
      const sign = rounded > 0 ? '+' : '';
      const unit = isPercent ? '%' : '';
      return {
        text: `${sign}${rounded}${unit} vs prior`,
        tone: rounded > 0 ? 'positive' : 'negative'
      };
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) {
        return '';
      }
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function populateSelect(selectEl, options, placeholder) {
      if (!selectEl) return;
      const currentValue = selectEl.value;
      selectEl.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = placeholder;
      selectEl.appendChild(defaultOption);
      (options || []).forEach(option => {
        const opt = document.createElement('option');
        opt.value = option.value;
        opt.textContent = option.label || option.value;
        selectEl.appendChild(opt);
      });
      if (options && options.some(option => option.value === currentValue)) {
        selectEl.value = currentValue;
      }
    }

    function renderSummary(summary) {
      const config = {
        avg: { formatter: safePercent, isPercent: true },
        pass: { formatter: safePercent, isPercent: true },
        coverage: { formatter: safePercent, isPercent: true },
        evaluations: { formatter: formatNumber, isPercent: false }
      };

      dom.summaryCards.forEach(card => {
        const metric = card.getAttribute('data-metric');
        const valueEl = card.querySelector('[data-role="value"]');
        const deltaEl = card.querySelector('[data-role="delta"]');
        const formatter = config[metric] ? config[metric].formatter : formatNumber;
        const isPercent = config[metric] ? config[metric].isPercent : false;
        if (valueEl) {
          const baseValue = summary && metric in summary ? summary[metric] : null;
          valueEl.textContent = formatter(baseValue);
        }
        if (deltaEl) {
          const deltaValue = summary && summary.delta ? summary.delta[metric] : null;
          const delta = formatDelta(deltaValue, isPercent);
          deltaEl.textContent = delta.text;
          deltaEl.className = `qa-summary-card__delta ${delta.tone}`;
        }
      });

      if (summary && dom.contextSummary) {
        const evaluations = formatNumber(summary.evaluations);
        const agents = formatNumber(summary.agents);
        dom.contextSummary.textContent = `Tracking ${evaluations} evaluation${summary.evaluations === 1 ? '' : 's'} across ${agents} agent${summary.agents === 1 ? '' : 's'} this period.`;
      }

      updateAiSignal(summary);
    }

    function renderTrend(trend, granularity) {
      if (!dom.trendCanvas) return;
      const ctx = dom.trendCanvas.getContext('2d');
      if (!ctx) {
        console.warn('Unable to acquire canvas context for QA trend chart.');
        return;
      }
      const labels = (trend && trend.series ? trend.series : []).map(entry => entry.label);
      const avgDataset = (trend && trend.series ? trend.series : []).map(entry => entry.avgScore || 0);
      const passDataset = (trend && trend.series ? trend.series : []).map(entry => entry.passRate || 0);

      destroyChart('trend');

      if (typeof Chart === 'undefined') {
        console.warn('Chart.js is not available; skipping trend rendering.');
        dom.trendSummary.textContent = 'Chart library unavailable. Unable to render trend visualization.';
        return;
      }

      if (!labels.length) {
        ctx.clearRect(0, 0, dom.trendCanvas.width, dom.trendCanvas.height);
        dom.trendSummary.textContent = 'No trend data available for the selected filters yet.';
        return;
      }

      state.charts.trend = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Average Score',
              data: avgDataset,
              borderColor: '#2563eb',
              backgroundColor: 'rgba(37, 99, 235, 0.12)',
              tension: 0.35,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 5
            },
            {
              label: 'Pass Rate',
              data: passDataset,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.12)',
              tension: 0.35,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 16
              }
            },
            tooltip: {
              callbacks: {
                label: tooltipPercentLabel
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: percentTickFormatter
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.25)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });

      if (dom.trendGranularity) {
        dom.trendGranularity.textContent = granularity ? `${granularity}ly` : '';
      }

      if (dom.trendSummary) {
        const summary = trend && trend.analysis && trend.analysis.summary
          ? trend.analysis.summary
          : 'Trend analysis ready once evaluations post across multiple periods.';
        dom.trendSummary.textContent = summary;
      }
    }

    function renderCoverage(trend) {
      if (!dom.coverageCanvas) {
        return;
      }

      const ctx = dom.coverageCanvas.getContext('2d');
      const series = trend && Array.isArray(trend.series) ? trend.series : [];
      const labels = series.map(entry => entry.label);
      const evaluations = series.map(entry => Number(entry.evalCount) || 0);
      const coverage = series.map(entry => normalizePercent(entry.coverage));
      const hasData = labels.length > 0 && (evaluations.some(value => value > 0) || coverage.some(value => value > 0));

      if (dom.coverageEmpty) {
        dom.coverageEmpty.classList.toggle('d-none', hasData);
      }

      if (dom.coverageSummary) {
        if (series.length >= 2) {
          const first = series[0];
          const last = series[series.length - 1];
          const coverageDelta = Math.round((Number(last.coverage || 0) - Number(first.coverage || 0)) * 10) / 10;
          const evalDelta = (Number(last.evalCount) || 0) - (Number(first.evalCount) || 0);
          const coveragePhrase = coverageDelta === 0
            ? 'Coverage steady'
            : `Coverage ${coverageDelta > 0 ? 'up' : 'down'} ${Math.abs(coverageDelta).toFixed(1)} pts`;
          const evalPhrase = evalDelta === 0
            ? 'Evaluations steady'
            : `Evaluations ${evalDelta > 0 ? 'up' : 'down'} ${formatNumber(Math.abs(evalDelta))}`;
          const anchor = first && first.label ? first.label : 'the start of this view';
          dom.coverageSummary.textContent = `${coveragePhrase}; ${evalPhrase} since ${anchor}.`;
        } else if (hasData) {
          dom.coverageSummary.textContent = 'Need additional periods to analyze coverage momentum.';
        } else {
          dom.coverageSummary.textContent = 'Coverage analytics will appear once multiple periods are available.';
        }
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('coverage');
        return;
      }

      destroyChart('coverage');
      state.charts.coverage = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              type: 'bar',
              label: 'Evaluations',
              data: evaluations,
              backgroundColor: 'rgba(59, 130, 246, 0.35)',
              borderRadius: 10,
              maxBarThickness: 38,
              yAxisID: 'y'
            },
            {
              type: 'line',
              label: 'Coverage %',
              data: coverage,
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34, 197, 94, 0.18)',
              fill: true,
              tension: 0.35,
              pointRadius: 3,
              pointHoverRadius: 4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'bottom', labels: { usePointStyle: true } },
            tooltip: {
              callbacks: {
                label(context) {
                  if (context.dataset && context.dataset.label === 'Coverage %') {
                    return tooltipPercentLabel(context);
                  }
                  return tooltipCountLabel(context);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(148, 163, 184, 0.2)' },
              title: { display: true, text: 'Evaluations' }
            },
            y1: {
              beginAtZero: true,
              min: 0,
              max: 100,
              position: 'right',
              ticks: { callback: percentTickFormatter },
              grid: { drawOnChartArea: false }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
    }

    function renderSpotlightSpark(trend) {
      if (!dom.spotlightChart) {
        return;
      }

      const ctx = dom.spotlightChart.getContext('2d');
      const series = trend && Array.isArray(trend.series) ? trend.series : [];
      const labels = series.map(entry => entry.label);
      const scores = series.map(entry => Number(entry.avgScore) || 0);
      const finiteScores = scores.filter(value => Number.isFinite(value));
      const hasData = labels.length > 0 && finiteScores.length > 0;

      if (dom.spotlightEmpty) {
        dom.spotlightEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('spotlightSpark');
        return;
      }

      const minScore = Math.min(...finiteScores);
      const maxScore = Math.max(...finiteScores);

      destroyChart('spotlightSpark');
      state.charts.spotlightSpark = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              data: scores,
              borderColor: '#0ea5e9',
              backgroundColor: 'rgba(14, 165, 233, 0.22)',
              borderWidth: 2,
              fill: true,
              tension: 0.35,
              pointRadius: 0,
              pointHoverRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: tooltipPercentLabel } }
          },
          scales: {
            x: { display: false },
            y: {
              display: false,
              suggestedMin: Math.max(0, minScore - 5),
              suggestedMax: Math.min(100, maxScore + 5)
            }
          }
        }
      });
    }

    function renderAgentSpotlight(summary, agents, trend) {
      if (!dom.spotlightCard) {
        return;
      }

      const selectedAgent = state.filters.agent || '';
      const agentList = Array.isArray(agents) ? agents.slice() : [];
      let spotlight = null;

      if (selectedAgent) {
        spotlight = agentList.find(agent => agent && (agent.id === selectedAgent || agent.name === selectedAgent));
      }

      if (!spotlight && agentList.length) {
        agentList.sort((a, b) => (Number(b.avgScore) || 0) - (Number(a.avgScore) || 0));
        spotlight = agentList[0];
      }

      const contextLabel = selectedAgent
        ? (state.agentLookup && state.agentLookup[selectedAgent]) || (spotlight ? (spotlight.displayName || spotlight.name) : 'Selected Agent')
        : 'All Agents';

      if (dom.spotlightContext) {
        dom.spotlightContext.textContent = contextLabel || 'All Agents';
      }

      const scoreValue = spotlight && typeof spotlight.avgScore === 'number'
        ? spotlight.avgScore
        : (summary && typeof summary.avg === 'number' ? summary.avg : null);
      if (dom.spotlightScore) {
        dom.spotlightScore.textContent = scoreValue === null ? '--' : `${Math.round(scoreValue)}%`;
      }

      const scoreDeltaSource = spotlight && spotlight.deltas ? spotlight.deltas.avgScore : summary && summary.delta ? summary.delta.avg : null;
      const scoreDelta = formatDelta(scoreDeltaSource, true);
      if (dom.spotlightScoreDelta) {
        dom.spotlightScoreDelta.textContent = scoreDelta.text;
        dom.spotlightScoreDelta.className = `qa-spotlight-metric__delta ${scoreDelta.tone}`;
      }

      const passValue = spotlight && typeof spotlight.passRate === 'number'
        ? spotlight.passRate
        : (summary && typeof summary.pass === 'number' ? summary.pass : null);
      if (dom.spotlightPass) {
        dom.spotlightPass.textContent = passValue === null ? '--' : `${Math.round(passValue)}%`;
      }

      const passDeltaSource = spotlight && spotlight.deltas ? spotlight.deltas.passRate : summary && summary.delta ? summary.delta.pass : null;
      const passDelta = formatDelta(passDeltaSource, true);
      if (dom.spotlightPassDelta) {
        dom.spotlightPassDelta.textContent = passDelta.text;
        dom.spotlightPassDelta.className = `qa-spotlight-metric__delta ${passDelta.tone}`;
      }

      const evaluationValue = spotlight && typeof spotlight.evaluations === 'number'
        ? spotlight.evaluations
        : (summary && typeof summary.evaluations === 'number' ? summary.evaluations : null);
      if (dom.spotlightEvaluations) {
        dom.spotlightEvaluations.textContent = evaluationValue === null ? '--' : formatNumber(evaluationValue);
      }

      let shareText = 'Awaiting data';
      if (spotlight && typeof spotlight.evaluationShare === 'number' && !Number.isNaN(spotlight.evaluationShare)) {
        shareText = `${Math.round(spotlight.evaluationShare)}% of reviews`;
      } else if (spotlight && evaluationValue !== null && summary && typeof summary.evaluations === 'number' && summary.evaluations > 0) {
        const share = Math.round((spotlight.evaluations / summary.evaluations) * 100);
        shareText = `${share}% of total reviews`;
      } else if (summary && typeof summary.evaluations === 'number') {
        shareText = `${formatNumber(summary.evaluations)} total reviews`;
      }
      if (dom.spotlightShare) {
        dom.spotlightShare.textContent = shareText;
        dom.spotlightShare.className = 'qa-spotlight-metric__delta neutral';
      }

      if (dom.spotlightNote) {
        let note = 'Select an agent to see individual quality momentum.';
        if (spotlight) {
          const scorePhrase = scoreValue === null ? '--' : `${Math.round(scoreValue)}%`;
          const passPhrase = passValue === null ? '--' : `${Math.round(passValue)}%`;
          const evalPhrase = evaluationValue === null ? 'no' : formatNumber(evaluationValue);
          let trendPhrase = 'Momentum steady.';
          if (scoreDelta.text === 'No change') {
            trendPhrase = 'Momentum holding steady.';
          } else if (scoreDelta.text === 'No prior period') {
            trendPhrase = 'Awaiting prior period comparison.';
          } else if (scoreDelta.text && scoreDelta.text !== 'Awaiting data') {
            trendPhrase = `Momentum ${scoreDelta.text.trim().toLowerCase()}.`;
          }
          note = `${contextLabel} average is ${scorePhrase} with a ${passPhrase} pass rate across ${evalPhrase} evaluation${evaluationValue === 1 ? '' : 's'}. ${trendPhrase}`;
        } else if (summary) {
          const avgText = typeof summary.avg === 'number' ? `${Math.round(summary.avg)}%` : '--';
          const evalsText = formatNumber(summary.evaluations || 0);
          note = `Team quality is averaging ${avgText} across ${evalsText} evaluation${summary.evaluations === 1 ? '' : 's'} this period.`;
        }
        dom.spotlightNote.textContent = note;
      }

      renderSpotlightSpark(trend);
    }

    function renderGauge(summary) {
      if (!dom.gaugeCanvas) return;
      const ctx = dom.gaugeCanvas.getContext('2d');
      const average = summary && typeof summary.avg === 'number'
        ? Math.min(100, Math.max(0, summary.avg))
        : null;

      if (dom.gaugeValue) {
        dom.gaugeValue.textContent = average === null ? '--' : `${Math.round(average)}%`;
      }

      if (!ctx || typeof Chart === 'undefined') {
        if (average === null) {
          destroyChart('gauge');
        }
        return;
      }

      if (average === null) {
        destroyChart('gauge');
        return;
      }

      destroyChart('gauge');
      state.charts.gauge = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Average Score', 'Gap'],
          datasets: [
            {
              data: [average, Math.max(0, 100 - average)],
              backgroundColor: ['#2563eb', 'rgba(148, 163, 184, 0.28)'],
              borderWidth: 0,
              circumference: Math.PI,
              rotation: -Math.PI,
              cutout: '72%'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: tooltipPercentLabel
              }
            }
          }
        }
      });
    }

    function renderOutcomeChart(summary) {
      if (!dom.outcomeCanvas) return;
      const ctx = dom.outcomeCanvas.getContext('2d');
      const passPercent = summary && typeof summary.pass === 'number'
        ? Math.min(100, Math.max(0, summary.pass))
        : null;

      const hasData = passPercent !== null;
      if (dom.outcomeEmpty) {
        dom.outcomeEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('outcomes');
        return;
      }

      destroyChart('outcomes');
      state.charts.outcomes = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Pass', 'Fail'],
          datasets: [
            {
              data: [passPercent, Math.max(0, 100 - passPercent)],
              backgroundColor: ['#22c55e', '#ef4444'],
              borderWidth: 0,
              cutout: '68%'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label: tooltipPercentLabel
              }
            }
          }
        }
      });
    }

    function renderCategoryChart(categories) {
      if (!dom.categoryCanvas) return;
      const ctx = dom.categoryCanvas.getContext('2d');
      const labels = (categories || []).map(category => category.category || 'Category');
      const data = (categories || []).map(category => Number(category.avgScore) || 0);
      const hasData = labels.length > 0;

      if (dom.categoryEmpty) {
        dom.categoryEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('categories');
        return;
      }

      destroyChart('categories');
      state.charts.categories = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Avg Score',
              data,
              backgroundColor: 'rgba(37, 99, 235, 0.65)',
              borderRadius: 8,
              maxBarThickness: 42
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: percentTickFormatter
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.25)'
              }
            },
            x: {
              ticks: {
                autoSkip: false,
                maxRotation: 45,
                minRotation: 0
              },
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: tooltipPercentLabel
              }
            }
          }
        }
      });
    }

    function renderAgentChart(agents) {
      if (!dom.agentCanvas) return;
      const ctx = dom.agentCanvas.getContext('2d');
      const topAgents = (agents || []).slice(0, 8);
      const labels = topAgents.map(agent => agent.displayName || agent.name || 'Agent');
      const data = topAgents.map(agent => Number(agent.evaluations) || 0);
      const hasData = labels.length > 0;

      if (dom.agentEmpty) {
        dom.agentEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('agents');
        return;
      }

      destroyChart('agents');
      state.charts.agents = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Evaluations',
              data,
              backgroundColor: 'rgba(14, 165, 233, 0.7)',
              borderRadius: 8,
              maxBarThickness: 38
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              beginAtZero: true,
              grid: { color: 'rgba(148, 163, 184, 0.25)' }
            },
            y: {
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: tooltipCountLabel
              }
            }
          }
        }
      });
    }

    function renderDistributionChart(agents) {
      if (!dom.distributionCanvas) return;
      const ctx = dom.distributionCanvas.getContext('2d');
      const bins = [
        { label: 'Below 70', min: 0, max: 70 },
        { label: '70-79', min: 70, max: 80 },
        { label: '80-89', min: 80, max: 90 },
        { label: '90-100', min: 90, max: 101 }
      ];

      const counts = bins.map(() => 0);
      (agents || []).forEach(agent => {
        const score = Number(agent.avgScore);
        if (Number.isFinite(score)) {
          const clamped = Math.min(100, Math.max(0, score));
          const binIndex = bins.findIndex(bin => clamped >= bin.min && clamped < bin.max);
          if (binIndex >= 0) {
            counts[binIndex] += 1;
          }
        }
      });

      const hasData = counts.some(count => count > 0);
      if (dom.distributionEmpty) {
        dom.distributionEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('distribution');
        return;
      }

      destroyChart('distribution');
      state.charts.distribution = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: bins.map(bin => bin.label),
          datasets: [
            {
              label: 'Agents',
              data: counts,
              backgroundColor: 'rgba(99, 102, 241, 0.75)',
              borderRadius: 8,
              maxBarThickness: 40
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 },
              grid: { color: 'rgba(148, 163, 184, 0.25)' }
            },
            x: {
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: tooltipCountLabel
              }
            }
          }
        }
      });
    }

    function renderAgentStacked(agents) {
      if (!dom.agentStackedCanvas) {
        return;
      }

      const ctx = dom.agentStackedCanvas.getContext('2d');
      const items = Array.isArray(agents)
        ? agents
            .filter(agent => agent && Number.isFinite(Number(agent.passRate)))
            .sort((a, b) => (Number(b.avgScore) || 0) - (Number(a.avgScore) || 0))
            .slice(0, 5)
        : [];

      const labels = items.map(agent => agent.displayName || agent.name || 'Agent');
      const passData = items.map(agent => normalizePercent(agent.passRate));
      const gapData = items.map(agent => 100 - normalizePercent(agent.passRate));
      const hasData = labels.length > 0 && (passData.some(value => value > 0) || gapData.some(value => value > 0));

      if (dom.agentStackedEmpty) {
        dom.agentStackedEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('agentStacked');
        return;
      }

      destroyChart('agentStacked');
      state.charts.agentStacked = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Pass %',
              data: passData,
              backgroundColor: 'rgba(34, 197, 94, 0.75)',
              stack: 'quality',
              borderRadius: 10,
              maxBarThickness: 38
            },
            {
              label: 'Opportunity %',
              data: gapData,
              backgroundColor: 'rgba(239, 68, 68, 0.55)',
              stack: 'quality',
              borderRadius: 10,
              maxBarThickness: 38
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true,
              beginAtZero: true,
              max: 100,
              ticks: { callback: percentTickFormatter },
              grid: { color: 'rgba(148, 163, 184, 0.2)' }
            },
            y: {
              stacked: true,
              grid: { display: false }
            }
          },
          plugins: {
            legend: { position: 'bottom', labels: { usePointStyle: true } },
            tooltip: {
              callbacks: {
                label: tooltipPercentLabel
              }
            }
          }
        }
      });
    }

    function renderCategoryRadar(categories) {
      if (!dom.categoryRadarCanvas) return;
      const ctx = dom.categoryRadarCanvas.getContext('2d');
      const items = Array.isArray(categories) ? categories.slice(0, 8) : [];
      const labels = items.map(item => item.category || 'Category');
      const avgScores = items.map(item => normalizePercent(item.avgScore));
      const passRates = items.map(item => normalizePercent(item.passPct));
      const hasData = labels.length > 1;

      if (dom.categoryRadarEmpty) {
        dom.categoryRadarEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('categoryRadar');
        return;
      }

      destroyChart('categoryRadar');
      state.charts.categoryRadar = new Chart(ctx, {
        type: 'radar',
        data: {
          labels,
          datasets: [
            {
              label: 'Avg Score',
              data: avgScores,
              backgroundColor: 'rgba(37, 99, 235, 0.18)',
              borderColor: 'rgba(37, 99, 235, 0.6)',
              pointBackgroundColor: '#2563eb'
            },
            {
              label: 'Pass Rate',
              data: passRates,
              backgroundColor: 'rgba(16, 185, 129, 0.18)',
              borderColor: 'rgba(16, 185, 129, 0.6)',
              pointBackgroundColor: '#10b981'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { usePointStyle: true }
            },
            tooltip: {
              callbacks: { label: tooltipPercentLabel }
            }
          },
          scales: {
            r: {
              beginAtZero: true,
              suggestedMax: 100,
              ticks: { display: false },
              angleLines: { color: 'rgba(148, 163, 184, 0.25)' },
              grid: { color: 'rgba(148, 163, 184, 0.18)' }
            }
          }
        }
      });
    }

    function renderProgramPolar(programs) {
      if (!dom.programPolarCanvas) return;
      const ctx = dom.programPolarCanvas.getContext('2d');
      const items = Array.isArray(programs)
        ? programs
            .filter(program => program && (Number.isFinite(program.evaluations) || Number.isFinite(program.share)))
            .sort((a, b) => (Number(b.evaluations) || Number(b.share) || 0) - (Number(a.evaluations) || Number(a.share) || 0))
            .slice(0, 6)
        : [];
      const labels = items.map(item => item.name || 'Program');
      const hasShare = items.some(item => Number.isFinite(Number(item.share)) && Number(item.share) > 0);
      const values = items.map(item => {
        const share = Number(item.share);
        if (hasShare && Number.isFinite(share) && share >= 0) {
          return share;
        }
        const evaluations = Number(item.evaluations);
        return Number.isFinite(evaluations) && evaluations >= 0 ? evaluations : 0;
      });
      const hasData = labels.length > 0 && values.some(value => value > 0);

      if (dom.programPolarEmpty) {
        dom.programPolarEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('programPolar');
        return;
      }

      const tooltipDetails = items.map(item => ({
        share: Number.isFinite(Number(item.share)) ? Number(item.share) : null,
        evaluations: Number.isFinite(Number(item.evaluations)) ? Number(item.evaluations) : null
      }));

      const palette = ['#2563eb', '#0ea5e9', '#10b981', '#f97316', '#a855f7', '#ec4899'];

      destroyChart('programPolar');
      state.charts.programPolar = new Chart(ctx, {
        type: 'polarArea',
        data: {
          labels,
          datasets: [
            {
              label: 'Program Mix',
              data: values,
              backgroundColor: labels.map((_, index) => palette[index % palette.length]),
              borderWidth: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label(context) {
                  const detail = tooltipDetails[context.dataIndex] || {};
                  const parts = [context.label || 'Program'];
                  if (detail.share !== null && !Number.isNaN(detail.share)) {
                    parts.push(`Share: ${Math.round(detail.share)}%`);
                  }
                  if (detail.evaluations !== null && !Number.isNaN(detail.evaluations)) {
                    parts.push(`Evaluations: ${formatNumber(detail.evaluations)}`);
                  }
                  return parts;
                }
              }
            }
          },
          scales: {
            r: {
              ticks: { display: false },
              grid: { color: 'rgba(148, 163, 184, 0.2)' }
            }
          }
        }
      });
    }

    function renderAgentImpact(agents) {
      if (!dom.agentImpactCanvas) return;
      const ctx = dom.agentImpactCanvas.getContext('2d');
      const items = Array.isArray(agents)
        ? agents.filter(agent => Number.isFinite(Number(agent.avgScore)) || Number.isFinite(Number(agent.passRate)))
        : [];
      const sample = items.slice(0, 12);
      const maxEvaluations = sample.reduce((max, agent) => {
        const evals = Number(agent.evaluations);
        return Number.isFinite(evals) && evals > max ? evals : max;
      }, 0);

      const bubbles = sample.map(agent => {
        const score = normalizePercent(agent.avgScore);
        const passRate = normalizePercent(agent.passRate);
        const evaluations = Number(agent.evaluations);
        const baseRadius = maxEvaluations > 0 && Number.isFinite(evaluations)
          ? 6 + (evaluations / maxEvaluations) * 12
          : 8;
        return {
          x: score,
          y: passRate,
          r: Math.max(6, Math.min(22, baseRadius)),
          name: agent.displayName || agent.name || 'Agent',
          count: Number.isFinite(evaluations) ? evaluations : null
        };
      });

      const hasData = bubbles.length > 0 && bubbles.some(point => point.x > 0 || point.y > 0);

      if (dom.agentImpactEmpty) {
        dom.agentImpactEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('agentImpact');
        return;
      }

      destroyChart('agentImpact');
      state.charts.agentImpact = new Chart(ctx, {
        type: 'bubble',
        data: {
          datasets: [
            {
              label: 'Agent Impact',
              data: bubbles,
              backgroundColor: 'rgba(37, 99, 235, 0.3)',
              borderColor: 'rgba(37, 99, 235, 0.6)',
              borderWidth: 1,
              hoverBackgroundColor: 'rgba(37, 99, 235, 0.45)'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: { label: tooltipBubbleLabel }
            }
          },
          scales: {
            x: {
              suggestedMin: 50,
              suggestedMax: 100,
              ticks: { callback: percentTickFormatter },
              title: { display: true, text: 'Average Score' },
              grid: { color: 'rgba(148, 163, 184, 0.2)' }
            },
            y: {
              suggestedMin: 50,
              suggestedMax: 100,
              ticks: { callback: percentTickFormatter },
              title: { display: true, text: 'Pass Rate' },
              grid: { color: 'rgba(148, 163, 184, 0.25)' }
            }
          }
        }
      });
    }

    function renderQualityRecognition(entries) {
      if (!dom.recognitionList) return;

      const champions = Array.isArray(entries)
        ? entries
            .filter(entry => {
              if (!entry) {
                return false;
              }
              const hasAgent = Boolean(entry.agent);
              const hasScore = Number.isFinite(Number(entry.avgScore));
              return hasAgent || hasScore;
            })
            .sort((a, b) => {
              const rankA = Number(a.rank);
              const rankB = Number(b.rank);
              const safeA = Number.isFinite(rankA) ? rankA : Number.MAX_SAFE_INTEGER;
              const safeB = Number.isFinite(rankB) ? rankB : Number.MAX_SAFE_INTEGER;
              return safeA - safeB;
            })
            .slice(0, 3)
        : [];

      dom.recognitionList.innerHTML = '';

      const hasData = champions.length > 0;
      dom.recognitionList.classList.toggle('d-none', !hasData);
      if (dom.recognitionEmpty) {
        dom.recognitionEmpty.classList.toggle('d-none', hasData);
      }

      if (dom.recognitionNotice) {
        if (hasData) {
          const names = champions.map(entry => entry.agent).filter(Boolean);
          if (names.length) {
            dom.recognitionNotice.textContent = `Top performers this period: ${formatNameList(names)}.`;
          } else {
            dom.recognitionNotice.textContent = 'Top performers for the current period are spotlighted below.';
          }
        } else {
          dom.recognitionNotice.textContent = 'The top three agents each period will be highlighted here once evaluations are available.';
        }
      }

      if (!hasData) {
        return;
      }

      champions.forEach(entry => {
        const rank = Number(entry.rank) || 0;
        const suffix = getOrdinalSuffix(rank);
        const tierClass = getRecognitionTierClass(rank);

        const item = document.createElement('div');
        item.className = `qa-recognition-item ${tierClass}`.trim();
        item.setAttribute('role', 'listitem');
        if (rank > 0) {
          item.dataset.rank = String(rank);
        }

        const rankEl = document.createElement('div');
        rankEl.className = 'qa-recognition-rank';
        rankEl.setAttribute('aria-hidden', 'true');

        const rankValue = document.createElement('span');
        rankValue.textContent = rank > 0 ? String(rank) : '#';
        rankEl.appendChild(rankValue);
        if (suffix) {
          const sup = document.createElement('sup');
          sup.textContent = suffix;
          rankEl.appendChild(sup);
        }

        const iconEl = document.createElement('div');
        iconEl.className = 'qa-recognition-icon';
        iconEl.setAttribute('aria-hidden', 'true');
        const icon = document.createElement('i');
        icon.className = `fa-solid ${rank === 1 ? 'fa-trophy' : 'fa-medal'}`;
        iconEl.appendChild(icon);

        const details = document.createElement('div');
        details.className = 'qa-recognition-details';

        const headerRow = document.createElement('div');
        headerRow.className = 'd-flex justify-content-between align-items-baseline flex-wrap gap-2';

        const nameEl = document.createElement('div');
        nameEl.className = 'qa-recognition-name';
        nameEl.textContent = entry.agent || 'Agent';

        const scoreEl = document.createElement('div');
        scoreEl.className = 'qa-recognition-score';
        const avgScore = Number(entry.avgScore);
        if (Number.isFinite(avgScore)) {
          scoreEl.textContent = `${Math.round(avgScore)}%`;
        } else {
          scoreEl.textContent = '--';
        }

        headerRow.appendChild(nameEl);
        headerRow.appendChild(scoreEl);

        const metaEl = document.createElement('div');
        metaEl.className = 'qa-recognition-meta';

        const metaParts = [];
        if (Number.isFinite(Number(entry.evaluations))) {
          const count = Math.round(Number(entry.evaluations));
          metaParts.push(`${formatNumber(count)} evaluation${count === 1 ? '' : 's'}`);
        }
        if (Number.isFinite(Number(entry.passRate))) {
          metaParts.push(`${Math.round(Number(entry.passRate))}% pass`);
        }
        if (entry.lastEvaluation) {
          metaParts.push(`Last eval ${entry.lastEvaluation}`);
        }
        if (Number.isFinite(Number(entry.deltaFromPass))) {
          const delta = Math.round(Number(entry.deltaFromPass));
          const prefix = delta > 0 ? '+' : '';
          metaParts.push(`${prefix}${delta} vs pass mark`);
        }

        if (metaParts.length) {
          metaEl.textContent = metaParts.join('  ');
        } else {
          metaEl.textContent = 'Recognition details pending';
        }

        details.appendChild(headerRow);
        details.appendChild(metaEl);

        if (rank > 0) {
          const accessibleRank = `${rank}${suffix || ''}`;
          const labelParts = [
            `${accessibleRank} place: ${entry.agent || 'Agent'}`,
            Number.isFinite(avgScore)
              ? `${Math.round(avgScore)}% score`
              : null,
            metaEl.textContent || null
          ].filter(Boolean);
          item.setAttribute('aria-label', labelParts.join('. '));
        }

        item.appendChild(rankEl);
        item.appendChild(iconEl);
        item.appendChild(details);

        dom.recognitionList.appendChild(item);
      });
    }

    function renderInsightHighlights(insights) {
      if (!dom.insightHighlights) {
        return;
      }

      const highlights = Array.isArray(insights) ? insights.slice(0, 3) : [];
      dom.insightHighlights.innerHTML = '';
      const hasHighlights = highlights.length > 0;

      if (dom.insightHighlightsEmpty) {
        dom.insightHighlightsEmpty.classList.toggle('d-none', hasHighlights);
      }

      if (!hasHighlights) {
        return;
      }

      highlights.forEach(item => {
        const card = document.createElement('div');
        card.className = 'qa-ai-insight-card';
        if (item.tone) {
          card.dataset.tone = item.tone;
        }

        const chip = document.createElement('span');
        chip.className = 'qa-ai-chip';
        chip.innerHTML = `<i class="fa-solid ${item.icon || 'fa-lightbulb'}"></i><span>${escapeHtml(item.tag || 'AI Insight')}</span>`;

        const title = document.createElement('strong');
        title.textContent = item.title || 'AI Insight';

        const description = document.createElement('p');
        description.innerHTML = item.text || '';

        card.appendChild(chip);
        card.appendChild(title);
        card.appendChild(description);
        dom.insightHighlights.appendChild(card);
      });
    }

    function renderInsights(insights) {
      if (!dom.insights) return;
      const items = Array.isArray(insights) ? insights : [];

      if (dom.insightCount) {
        dom.insightCount.textContent = `${items.length} AI insight${items.length === 1 ? '' : 's'}`;
      }

      renderInsightHighlights(items);

      dom.insights.innerHTML = '';
      if (!items.length) {
        const empty = document.createElement('p');
        empty.className = 'text-muted mb-0';
        empty.textContent = 'No insights available for the selected filters yet.';
        dom.insights.appendChild(empty);
        return;
      }

      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'qa-insight-item';
        if (item.tone) {
          row.dataset.tone = item.tone;
        }

        const icon = document.createElement('div');
        icon.className = 'qa-insight-icon';
        icon.innerHTML = `<i class="fa-solid ${item.icon || 'fa-lightbulb'}"></i>`;

        const text = document.createElement('div');
        text.className = 'qa-insight-text';
        const title = item.title ? `<strong>${item.title}</strong>` : '';
        const body = item.text || '';
        text.innerHTML = `${title}${body}`;

        row.appendChild(icon);
        row.appendChild(text);
        dom.insights.appendChild(row);
      });
    }

    function renderActions(actions, nextBest) {
      if (!dom.actions || !dom.nextBest) return;

      const items = Array.isArray(actions) ? actions : [];

      dom.actions.innerHTML = '';
      dom.nextBest.classList.add('d-none');
      dom.nextBest.innerHTML = '';

      if (nextBest && (nextBest.title || nextBest.text)) {
        dom.nextBest.classList.remove('d-none');
        dom.nextBest.innerHTML = `
          <i class="fa-solid ${nextBest.icon || 'fa-rocket'} mt-1"></i>
          <div>
            <strong>${nextBest.title || 'Next Best Action'}</strong>
            <span class="d-block text-muted">${nextBest.text || ''}</span>
          </div>`;
      }

      if (!items.length) {
        const empty = document.createElement('p');
        empty.className = 'text-muted mb-0';
        empty.textContent = 'AI has no urgent playbook steps at the moment.';
        dom.actions.appendChild(empty);
        return;
      }

      items.forEach(action => {
        const row = document.createElement('div');
        row.className = 'qa-action-item';
        if (action.tone) {
          row.dataset.tone = action.tone;
        }

        const icon = document.createElement('div');
        icon.className = 'qa-action-icon';
        icon.innerHTML = `<i class="fa-solid ${action.icon || 'fa-sparkles'}"></i>`;

        const text = document.createElement('div');
        text.className = 'qa-action-text';
        const title = action.title ? `<strong>${action.title}</strong>` : '';
        const body = action.text || '';
        text.innerHTML = `${title}${body}`;

        row.appendChild(icon);
        row.appendChild(text);
        dom.actions.appendChild(row);
      });
    }

    function renderQuestionSignals(signals) {
      if (!dom.questionSignals) return;

      const items = Array.isArray(signals) ? signals : [];
      dom.questionSignals.innerHTML = '';

      if (dom.questionEmpty) {
        dom.questionEmpty.classList.toggle('d-none', items.length > 0);
      }

      if (!items.length) {
        return;
      }

      items.forEach(signal => {
        const container = document.createElement('div');
        container.className = 'qa-signal-item';

        const tone = signal.severity === 'negative'
          ? 'negative'
          : (signal.severity === 'warning' ? 'warning' : '');
        if (tone) {
          container.dataset.tone = tone;
        }

        const header = document.createElement('div');
        header.className = 'qa-signal-header';

        const title = document.createElement('div');
        title.className = 'qa-signal-title';
        title.textContent = `${signal.shortLabel || ''}  ${signal.question || ''}`;

        const badge = document.createElement('span');
        badge.className = `qa-signal-badge ${tone}`.trim();
        badge.textContent = `${typeof signal.passRate === 'number' ? signal.passRate : '--'}% pass`;

        header.appendChild(title);
        header.appendChild(badge);
        container.appendChild(header);

        const meta = document.createElement('div');
        meta.className = 'qa-signal-meta';
        meta.innerHTML = `
          <span><i class="fa-solid fa-circle-check text-success me-1"></i>${signal.yesCount || 0} yes</span>
          <span><i class="fa-solid fa-circle-xmark text-danger me-1"></i>${signal.noCount || 0} no</span>
          <span><i class="fa-solid fa-circle-minus text-muted me-1"></i>${signal.naCount || 0} n/a</span>`;
        container.appendChild(meta);

        if (signal.primaryNote) {
          const note = document.createElement('div');
          note.className = 'qa-signal-note';
          note.innerHTML = `<i class="fa-solid fa-quote-left me-2 text-primary"></i>${escapeHtml(signal.primaryNote)}`;
          container.appendChild(note);
        }

        dom.questionSignals.appendChild(container);
      });
    }

    function renderProgramMetrics(programs) {
      if (!dom.programBody) return;

      const items = Array.isArray(programs) ? programs : [];
      dom.programBody.innerHTML = '';

      if (!items.length) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" class="text-center text-muted py-4">No program performance metrics yet.</td>';
        dom.programBody.appendChild(row);
        return;
      }

      items.slice(0, 6).forEach(program => {
        const tone = program.severity === 'negative'
          ? 'negative'
          : (program.severity === 'warning' ? 'warning' : '');
        const badgeClass = tone;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="fw-semibold">${escapeHtml(program.name || 'Unassigned')}</div>
            <div class="text-muted small">${program.share ? program.share + '% of volume' : ''}</div>
          </td>
          <td class="text-center fw-semibold">${program.avgScore || 0}%</td>
          <td class="text-center">
            <span class="qa-signal-badge ${badgeClass}">${program.passRate || 0}%</span>
          </td>
          <td class="text-center fw-semibold">${program.evaluations || 0}</td>`;
        dom.programBody.appendChild(row);
      });
    }

    function renderSignalHighlights(signals) {
      if (!dom.signalRadar) return;

      const items = Array.isArray(signals) ? signals : [];
      dom.signalRadar.innerHTML = '';

      if (!items.length) {
        const empty = document.createElement('div');
        empty.className = 'qa-signal-item';
        empty.innerHTML = '<div class="qa-signal-title">AI monitoring</div><div class="qa-signal-note text-muted">No anomalies detected for the selected filters.</div>';
        dom.signalRadar.appendChild(empty);
        return;
      }

      items.forEach(signal => {
        const item = document.createElement('div');
        item.className = 'qa-signal-item';
        if (signal.tone === 'negative' || signal.tone === 'urgent') {
          item.dataset.tone = 'negative';
        } else if (signal.tone === 'warning') {
          item.dataset.tone = 'warning';
        }

        const header = document.createElement('div');
        header.className = 'qa-signal-header';
        const title = document.createElement('div');
        title.className = 'qa-signal-title';
        const icon = signal.icon || 'fa-signal';
        title.innerHTML = `<i class="fa-solid ${icon} me-2"></i>${escapeHtml(signal.title || '')}`;
        header.appendChild(title);
        item.appendChild(header);

        if (signal.text) {
          const note = document.createElement('div');
          note.className = 'qa-signal-note';
          note.textContent = signal.text;
          item.appendChild(note);
        }

        dom.signalRadar.appendChild(item);
      });
    }

    function createDeltaBadge(delta) {
      if (delta === null || delta === undefined || Number.isNaN(delta)) {
        return '<span class="qa-delta-badge neutral">--</span>';
      }
      const tone = delta > 0 ? 'positive' : (delta < 0 ? 'negative' : 'neutral');
      const value = Math.round(delta * 10) / 10;
      const sign = value > 0 ? '+' : '';
      return `<span class="qa-delta-badge ${tone}">${sign}${value}</span>`;
    }

    function renderCategories(categories) {
      if (!dom.categoriesBody) return;
      dom.categoriesBody.innerHTML = '';
      if (!categories || !categories.length) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="3" class="text-center text-muted py-4">No category metrics available.</td>';
        dom.categoriesBody.appendChild(row);
        return;
      }

      categories.forEach(category => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="fw-semibold">${category.category}</div>
            <div class="text-muted small">${category.passPct || 0}% pass</div>
          </td>
          <td class="text-center fw-semibold">${category.avgScore || 0}%</td>
          <td class="text-center">${createDeltaBadge(category.delta)}</td>`;
        dom.categoriesBody.appendChild(row);
      });
    }

    function renderAgents(agents) {
      if (!dom.agentsBody) return;
      dom.agentsBody.innerHTML = '';
      if (!agents || !agents.length) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" class="text-center text-muted py-4">No agent performance captured yet.</td>';
        dom.agentsBody.appendChild(row);
        return;
      }

      agents.forEach(agent => {
        const deltaScore = createDeltaBadge(agent.deltas ? agent.deltas.avgScore : null);
        const deltaPass = createDeltaBadge(agent.deltas ? agent.deltas.passRate : null);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="fw-semibold">${agent.displayName || agent.name}</div>
            <div class="text-muted small">${agent.recentDate || 'No recent date'}</div>
          </td>
          <td class="text-center">
            <div class="fw-semibold">${agent.avgScore || 0}%</div>
            <div class="small">${deltaScore}</div>
          </td>
          <td class="text-center">
            <div class="fw-semibold">${agent.passRate || 0}%</div>
            <div class="small">${deltaPass}</div>
          </td>
          <td class="text-center fw-semibold">${agent.evaluations || 0}</td>`;
        dom.agentsBody.appendChild(row);
      });
    }

    function renderLatestEvaluation(latest) {
      if (!dom.notesBody) {
        return;
      }

      dom.notesBody.innerHTML = '';

      if (!latest || !Array.isArray(latest.questions) || !latest.questions.length) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" class="text-center text-muted py-4">No evaluation notes available.</td>';
        dom.notesBody.appendChild(row);
        if (dom.notesMeta) {
          dom.notesMeta.textContent = 'Awaiting evaluations';
        }
        return;
      }

      if (dom.notesMeta) {
        const metaParts = [];
        if (latest.agent) {
          metaParts.push(latest.agent);
        }
        if (latest.callDate) {
          metaParts.push(latest.callDate);
        }
        if (typeof latest.score === 'number' && !Number.isNaN(latest.score)) {
          metaParts.push(`${latest.score}%`);
        }
        dom.notesMeta.textContent = metaParts.join('  ');
      }

      latest.questions.forEach(question => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="fw-semibold">${escapeHtml(question.number || '')}</div>
            <div class="text-muted small">${escapeHtml(question.question || '')}</div>
          </td>
          <td class="text-center fw-semibold">${question.weight || 0}</td>
          <td class="text-center">${escapeHtml(question.answer || 'N/A')}</td>
          <td>${formatNoteContent(question.note)}</td>`;
        dom.notesBody.appendChild(row);
      });
    }

    function updateFiltersFromResponse(response) {
      const periodOptions = (response && response.periodOptions) || [];
      populateSelect(dom.period, periodOptions, 'Latest Period');
      if (dom.period && response && response.context && response.context.period) {
        dom.period.value = response.context.period;
      }

      const availableAgents = (response && response.availableAgents) || [];
      const lookup = response && response.agentNameLookup ? response.agentNameLookup : {};
      const preferredOptions = Array.isArray(response && response.agentOptions)
        ? response.agentOptions
        : null;
      const agentOptions = preferredOptions && preferredOptions.length
        ? preferredOptions
        : availableAgents.map(name => ({
          value: name,
          label: lookup && lookup[name] ? lookup[name] : name
        }));
      populateSelect(dom.agent, agentOptions, 'All Agents');
      if (dom.agent && state.filters.agent) {
        dom.agent.value = state.filters.agent;
      }

      if (dom.granularity && response && response.context && response.context.granularity) {
        dom.granularity.value = response.context.granularity;
      }
    }

    function showError(message) {
      if (!dom.error) return;
      dom.error.textContent = message || 'Unable to load QA dashboard data.';
      dom.error.classList.remove('d-none');
    }

    function clearError() {
      if (!dom.error) return;
      dom.error.classList.add('d-none');
      dom.error.textContent = '';
    }

    function toggleEmptyState(visible) {
      if (!dom.empty || !dom.content || !dom.lower) return;
      dom.empty.classList.toggle('d-none', !visible);
      dom.content.classList.toggle('d-none', Boolean(visible));
      dom.lower.classList.toggle('d-none', Boolean(visible));
      if (dom.analyticsRow) {
        dom.analyticsRow.classList.toggle('d-none', Boolean(visible));
      }
    }

    function handleResponse(response) {
      setLoading(false);
      if (!response || response.success === false) {
        const errorMessage = response && response.error ? response.error : 'QA dashboard data unavailable.';
        showError(errorMessage);
        toggleEmptyState(true);
        return;
      }

      clearError();
      state.data = response;
      state.agentLookup = response.agentNameLookup || {};

      if (dom.healthPeriod) {
        const context = response.context || {};
        const badgeText = context && context.granularity
          ? `${context.granularity} view`
          : 'Live';
        dom.healthPeriod.textContent = badgeText;
      }

      updateFiltersFromResponse(response);

      const summary = response.summary || null;
      renderSummary(summary);

      const trend = response.trend || null;
      renderTrend(trend, response.context ? response.context.granularity : 'Week');
      renderCoverage(trend);

      renderGauge(summary);
      renderOutcomeChart(summary);
      updateAiHealthMetrics(summary, trend);

      const categories = response.categories || [];
      renderCategoryChart(categories);
      renderCategoryRadar(categories);
      renderCategories(categories);

      const agents = response.agents || [];
      renderAgentSpotlight(summary, agents, trend);
      renderAgentChart(agents);
      renderDistributionChart(agents);
      renderAgentStacked(agents);
      renderAgentImpact(agents);
      renderAgents(agents.slice(0, 8));
      renderQualityRecognition(response.qualityRecognition || []);
      renderLatestEvaluation(response.latestEvaluation || null);

      renderQuestionSignals(response.questionSignals || []);
      const programs = response.programMetrics || [];
      renderProgramMetrics(programs);
      renderProgramPolar(programs);
      renderSignalHighlights(response.qualitySignals || []);

      if (dom.intelSummary) {
        dom.intelSummary.textContent = response.intelligenceSummary
          || 'AI-generated recommendations will populate once fresh QA data is available.';
      }

      renderInsights(response.insights || []);
      renderActions(response.actions || [], response.nextBest || null);

      const hasEvaluations = summary && summary.evaluations > 0;
      toggleEmptyState(!hasEvaluations);
    }

    function handleError(error) {
      console.error('QA dashboard load failed:', error);
      setLoading(false);
      showError('Unable to reach the QA service. Please try again in a moment.');
      toggleEmptyState(true);
    }

    function buildRequest() {
      return {
        granularity: state.filters.granularity,
        period: state.filters.period,
        agent: state.filters.agent,
        campaignId: state.filters.campaignId,
        program: state.filters.program
      };
    }

    function loadData() {
      if (state.loading) {
        return;
      }

      setLoading(true);
      const request = buildRequest();

      if (window.google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(handleResponse)
          .withFailureHandler(handleError)
          .clientGetQADashboardSnapshot(request);
      } else {
        console.warn('google.script.run not available; QA dashboard operating in static mode.');
        setLoading(false);
        showError('Live data unavailable outside Google Workspace context.');
        toggleEmptyState(true);
      }
    }

    function attachEvents() {
      if (dom.refresh) {
        dom.refresh.addEventListener('click', () => {
          loadData();
        });
      }

      if (dom.granularity) {
        dom.granularity.addEventListener('change', event => {
          state.filters.granularity = event.target.value;
          state.filters.period = '';
          loadData();
        });
      }

      if (dom.period) {
        dom.period.addEventListener('change', event => {
          state.filters.period = event.target.value;
          loadData();
        });
      }

      if (dom.agent) {
        dom.agent.addEventListener('change', event => {
          state.filters.agent = event.target.value;
          loadData();
        });
      }

      if (dom.openInsights && dom.insightsModal && !dom.openInsights.hasAttribute('data-bs-toggle')) {
        dom.openInsights.addEventListener('click', () => {
          if (typeof bootstrap === 'undefined') {
            return;
          }
          if (!state.modals.insights) {
            state.modals.insights = new bootstrap.Modal(dom.insightsModal);
          }
          state.modals.insights.show();
        });
      }

      if (dom.openActions && dom.actionsModal && !dom.openActions.hasAttribute('data-bs-toggle')) {
        dom.openActions.addEventListener('click', () => {
          if (typeof bootstrap === 'undefined') {
            return;
          }
          if (!state.modals.actions) {
            state.modals.actions = new bootstrap.Modal(dom.actionsModal);
          }
          state.modals.actions.show();
        });
      }

    }

    function bootstrap() {
      attachEvents();
      loadData();
    }

    bootstrap();
  })();
</script>
