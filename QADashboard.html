<!-- QA Dashboard -->

<?!= includeOnce('ResponsiveStyles') ?>

<?!= include('layout', {
      baseUrl: baseUrl,
      scriptUrl: scriptUrl,
      currentPage: currentPage || 'qadashboard',
      userList: userList,
      granularity: granularity,
      periodValue: periodValue,
      selectedAgent: selectedAgent,
      user: user,
      campaignId: campaignId,
      campaignName: campaignName
    }) ?>

<?
  function __qaBuildPageUrl(page) {
    var base = (typeof baseUrl !== 'undefined' && baseUrl) ? String(baseUrl) : '';
    if (!page) {
      return base || '#';
    }

    if (!base) {
      return '?page=' + page;
    }

    var sanitized = base.replace(/\s+/g, '');
    var hasQuery = sanitized.indexOf('?') !== -1;
    if (hasQuery && /([?&]page=)/i.test(sanitized)) {
      return sanitized.replace(/([?&]page=)[^&#]*/i, '$1' + page);
    }

    var separator = hasQuery ? (/[?&]$/.test(sanitized) ? '' : '&') : '?';
    return sanitized + separator + 'page=' + page;
  }

  var __qaFormUrl = __qaBuildPageUrl('qualityform');
  var __coachingFormUrl = __qaBuildPageUrl('coachingsheet');
  var __collabFormUrl = __qaBuildPageUrl('qualitycollabform');
?>

<style>
  :root {
    --qa-bg: #f7f9fc;
    --qa-card-bg: #ffffff;
    --qa-border: #e5e7eb;
    --qa-primary: #2563eb;
    --qa-accent: #0ea5e9;
    --qa-success: #10b981;
    --qa-warning: #f59e0b;
    --qa-danger: #ef4444;
    --qa-muted: #6b7280;
    --qa-radius-lg: 18px;
    --qa-radius-md: 14px;
    --qa-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
    --qa-shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.06);
  }

  body {
    background: var(--qa-bg);
  }

  .qa-shell {
    max-width: min(1380px, 100%);
    margin: 0 auto;
    padding: 1.5rem 1.5rem 3rem;
  }

  .qa-dashboard {
    font-family: 'Inter', sans-serif;
    color: #0f172a;
  }

  .qa-page-header {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 1.75rem;
    margin-bottom: 1.5rem;
    align-items: flex-start;
  }

  .qa-page-header__text {
    max-width: 640px;
  }

  .qa-page-header__eyebrow {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--qa-primary);
    font-weight: 600;
  }

  .qa-page-header__title {
    margin-top: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: clamp(1.6rem, 2.6vw, 2.15rem);
    font-weight: 700;
  }

  .qa-page-header__summary {
    color: #475569;
    font-size: 0.98rem;
  }

  .qa-page-header__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .qa-page-header__actions [data-banner-action] {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border-radius: 999px;
    padding: 0.6rem 1.25rem;
    font-weight: 600;
    border: none;
    text-decoration: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .qa-page-header__actions [data-banner-action]:hover,
  .qa-page-header__actions [data-banner-action]:focus-visible {
    transform: translateY(-1px);
  }

  .qa-dashboard .card {
    border: none;
    border-radius: var(--qa-radius-lg);
    box-shadow: var(--qa-shadow-soft);
  }

  .qa-dashboard .card-header {
    background: transparent;
    border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    padding: 1.25rem 1.75rem 0.75rem;
    font-weight: 600;
    color: #0f172a;
  }

  .qa-dashboard .card-body {
    padding: 1.75rem;
  }

  .qa-filters {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: nowrap;
    justify-content: flex-start;
    padding: 0.85rem 1.25rem;
    border-radius: var(--qa-radius-lg);
    border: 1px solid rgba(148, 163, 184, 0.22);
    background: rgba(255, 255, 255, 0.96);
    box-shadow: var(--qa-shadow-soft);
    overflow: visible;
  }

  .qa-filters .form-select,
  .qa-filters .form-control {
    border-radius: var(--qa-radius-md);
    border-color: var(--qa-border);
    padding: 0.45rem 2.25rem 0.45rem 0.85rem;
    box-shadow: none;
    flex: 1 1 160px;
    min-width: 140px;
    max-width: 210px;
  }

  .qa-filters .btn-primary {
    background: linear-gradient(135deg, var(--qa-primary), var(--qa-accent));
    border: none;
    border-radius: 999px;
    padding: 0.55rem 1.45rem;
    font-weight: 600;
    box-shadow: 0 12px 28px rgba(37, 99, 235, 0.22);
    flex: 0 0 auto;
  }

  @media (max-width: 768px) {
    .qa-filters {
      flex-wrap: wrap;
    }

    .qa-filters .btn-primary {
      width: 100%;
    }
  }

  .qa-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
    gap: 1.25rem;
    margin-top: 1.25rem;
  }

  .qa-summary-card {
    background: var(--qa-card-bg);
    border-radius: var(--qa-radius-lg);
    padding: 1.75rem;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(148, 163, 184, 0.18);
    box-shadow: var(--qa-shadow-soft);
  }

  .qa-summary-card::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), transparent 60%);
    opacity: 0;
    transition: opacity 0.35s ease;
  }

  .qa-summary-card:hover::after {
    opacity: 1;
  }

  .qa-summary-card__label {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--qa-muted);
    margin-bottom: 0.9rem;
  }

  .qa-summary-card__value {
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 0.4rem;
  }

  .qa-summary-card__delta {
    font-size: 0.95rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .qa-summary-card__delta.positive {
    color: var(--qa-success);
  }

  .qa-summary-card__delta.negative {
    color: var(--qa-danger);
  }

  .qa-summary-card__delta.neutral {
    color: var(--qa-muted);
  }

  .qa-section-title {
    font-size: 1.15rem;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 0.75rem;
  }

  .qa-insight-list,
  .qa-action-list {
    display: grid;
    gap: 0.85rem;
  }

  .qa-insight-item,
  .qa-action-item {
    border-radius: var(--qa-radius-md);
    border: 1px solid rgba(148, 163, 184, 0.24);
    background: rgba(255, 255, 255, 0.9);
    padding: 1rem 1.25rem;
    display: grid;
    grid-template-columns: 44px 1fr;
    gap: 1rem;
    align-items: flex-start;
  }

  .qa-insight-icon,
  .qa-action-icon {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    display: grid;
    place-items: center;
    background: rgba(37, 99, 235, 0.12);
    color: var(--qa-primary);
    font-size: 1.2rem;
  }

  .qa-insight-item[data-tone="positive"] .qa-insight-icon {
    background: rgba(16, 185, 129, 0.12);
    color: var(--qa-success);
  }

  .qa-insight-item[data-tone="negative"] .qa-insight-icon,
  .qa-action-item[data-tone="urgent"] .qa-action-icon {
    background: rgba(239, 68, 68, 0.12);
    color: var(--qa-danger);
  }

  .qa-insight-text strong,
  .qa-action-text strong {
    display: block;
    font-weight: 600;
    margin-bottom: 0.3rem;
  }

  .qa-trend-chart-container {
    position: relative;
    height: 360px;
    width: 100%;
  }

  .qa-analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
  }

  .qa-chart-wrapper {
    position: relative;
    height: 320px;
  }

  .qa-chart-wrapper--compact {
    height: 240px;
  }

  .qa-chart-wrapper canvas {
    width: 100% !important;
    height: 100% !important;
  }

  .qa-chart-empty {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    text-align: center;
    font-size: 0.9rem;
    color: #64748b;
    padding: 1.5rem;
  }

  .qa-gauge-wrapper {
    position: relative;
    height: 220px;
  }

  .qa-gauge-center {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    font-weight: 700;
    font-size: 1.65rem;
    color: #1e3a8a;
  }

  .qa-gauge-subtext {
    text-align: center;
    margin-top: -0.75rem;
    font-size: 0.85rem;
    color: #475569;
  }

  .qa-intelligence-card {
    background: var(--qa-card-bg);
    border-radius: var(--qa-radius-lg);
    border: 1px solid rgba(37, 99, 235, 0.16);
    padding: 1.5rem;
    box-shadow: var(--qa-shadow-soft);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .qa-intelligence-card__summary {
    color: #1e293b;
    font-size: 0.95rem;
  }

  .qa-intelligence-card__actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .qa-intelligence-card__actions .btn {
    border-radius: 999px;
    padding: 0.55rem 1.2rem;
    font-weight: 600;
  }

  .qa-insight-count {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: var(--qa-primary);
  }

  .qa-trend-chart-container canvas {
    width: 100% !important;
    height: 100% !important;
    display: block;
  }

  .qa-trend-summary {
    margin-top: 1.5rem;
    padding: 1.1rem 1.3rem;
    border-radius: var(--qa-radius-md);
    background: rgba(37, 99, 235, 0.08);
    color: #1e3a8a;
    font-weight: 500;
    line-height: 1.5;
  }

  .qa-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .qa-table thead th {
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    color: var(--qa-muted);
    border: none;
    padding: 0.75rem 0.6rem;
    background: transparent;
  }

  .qa-table tbody tr {
    border-radius: var(--qa-radius-md);
    background: rgba(255, 255, 255, 0.9);
    box-shadow: 0 1px 0 rgba(15, 23, 42, 0.04);
  }

  .qa-table tbody td {
    padding: 0.9rem 0.6rem;
    vertical-align: middle;
    border-top: 1px solid rgba(148, 163, 184, 0.18);
  }

  .qa-delta-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.65rem;
  }

  .qa-delta-badge.positive {
    background: rgba(16, 185, 129, 0.12);
    color: var(--qa-success);
  }

  .qa-delta-badge.negative {
    background: rgba(239, 68, 68, 0.12);
    color: var(--qa-danger);
  }

  .qa-delta-badge.neutral {
    background: rgba(148, 163, 184, 0.2);
    color: #475569;
  }

  .qa-empty-state {
    text-align: center;
    padding: 4rem 1rem;
    border-radius: var(--qa-radius-lg);
    border: 2px dashed rgba(148, 163, 184, 0.3);
    background: rgba(255, 255, 255, 0.7);
    color: #475569;
  }

  .qa-empty-state i {
    font-size: 2rem;
    color: var(--qa-primary);
    margin-bottom: 0.75rem;
  }

  .qa-loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(247, 249, 252, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
    border-radius: var(--qa-radius-lg);
  }

  .qa-dashboard.is-loading .qa-loading-overlay {
    display: flex;
  }

  .qa-spinner {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 4px solid rgba(37, 99, 235, 0.15);
    border-top-color: var(--qa-primary);
    animation: qa-spin 0.9s linear infinite;
  }

  @keyframes qa-spin {
    to {
      transform: rotate(360deg);
    }
  }

  .qa-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    border-radius: 999px;
    padding: 0.35rem 0.75rem;
    background: rgba(37, 99, 235, 0.08);
    color: var(--qa-primary);
    font-weight: 600;
    font-size: 0.85rem;
  }

  .qa-next-best {
    border-radius: var(--qa-radius-lg);
    border: 1px solid rgba(37, 99, 235, 0.18);
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(14, 165, 233, 0.08));
    padding: 1.25rem 1.5rem;
    display: flex;
    gap: 0.85rem;
    align-items: flex-start;
    margin-top: 1.25rem;
  }

  .qa-next-best i {
    color: var(--qa-primary);
    font-size: 1.5rem;
  }

  .qa-next-best strong {
    display: block;
    font-weight: 600;
    color: #0f172a;
    margin-bottom: 0.2rem;
  }

  .qa-dashboard-alert {
    margin-top: 1rem;
  }

  @media (max-width: 992px) {
    .qa-filters {
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    .qa-insight-item,
    .qa-action-item {
      grid-template-columns: 36px 1fr;
    }
  }

  @media (max-width: 768px) {
    .qa-page-header__actions {
      width: 100%;
    }
  }
</style>

<div class="qa-shell position-relative qa-dashboard" id="qa-dashboard">
  <div class="qa-loading-overlay">
    <div class="qa-spinner"></div>
  </div>

  <header class="qa-page-header" data-banner-source>
    <div class="qa-page-header__text">
      <span class="qa-page-header__eyebrow" data-banner-eyebrow>
        <i class="fa-solid fa-shield-check"></i>
        Quality Assurance
      </span>
      <h1 class="qa-page-header__title" data-banner-title>QA Performance Command Center</h1>
      <p class="qa-page-header__summary mb-0" id="qa-context-summary" data-banner-description>
        Monitor live quality health, trending scores, and AI-powered recommendations across your teams.
      </p>
    </div>
    <div class="qa-page-header__actions" data-banner-source>
      <a class="btn btn-primary" href="<?= __qaFormUrl ?>" data-banner-action data-banner-icon="fa-solid fa-clipboard-check" data-banner-variant="primary">
        <i class="fa-solid fa-clipboard-check"></i>
        <span>QA Form</span>
      </a>
      <a class="btn btn-outline-primary" href="<?= __coachingFormUrl ?>" data-banner-action data-banner-icon="fa-solid fa-file-signature" data-banner-variant="secondary">
        <i class="fa-solid fa-file-signature"></i>
        <span>Coaching Form</span>
      </a>
      <a class="btn btn-outline-secondary" href="<?= __collabFormUrl ?>" data-banner-action data-banner-icon="fa-solid fa-people-arrows" data-banner-variant="secondary">
        <i class="fa-solid fa-people-arrows"></i>
        <span>Collaboration Form</span>
      </a>
    </div>
  </header>

  <div class="qa-filters" role="group" aria-label="QA filters">
    <select id="qa-granularity" class="form-select" aria-label="Select time grouping">
      <option value="Week">Week</option>
      <option value="Month">Month</option>
      <option value="Quarter">Quarter</option>
      <option value="Year">Year</option>
    </select>
    <select id="qa-period" class="form-select" aria-label="Select reporting period">
      <option value="">Latest Period</option>
    </select>
    <select id="qa-agent" class="form-select" aria-label="Select agent">
      <option value="">All Agents</option>
    </select>
    <button type="button" class="btn btn-primary" id="qa-refresh">
      <i class="fa-solid fa-rotate"></i>
      <span class="ms-1">Refresh</span>
    </button>
  </div>

  <div class="qa-summary-grid mt-4" id="qa-summary-cards">
      <div class="qa-summary-card" data-metric="avg">
        <div class="qa-summary-card__label">Average QA Score</div>
        <div class="qa-summary-card__value" data-role="value">--</div>
        <div class="qa-summary-card__delta neutral" data-role="delta">Awaiting data</div>
      </div>
      <div class="qa-summary-card" data-metric="pass">
        <div class="qa-summary-card__label">Pass Rate</div>
        <div class="qa-summary-card__value" data-role="value">--</div>
        <div class="qa-summary-card__delta neutral" data-role="delta">Awaiting data</div>
      </div>
      <div class="qa-summary-card" data-metric="coverage">
        <div class="qa-summary-card__label">Agent Coverage</div>
        <div class="qa-summary-card__value" data-role="value">--</div>
        <div class="qa-summary-card__delta neutral" data-role="delta">Awaiting data</div>
      </div>
      <div class="qa-summary-card" data-metric="evaluations">
        <div class="qa-summary-card__label">Evaluations</div>
        <div class="qa-summary-card__value" data-role="value">--</div>
        <div class="qa-summary-card__delta neutral" data-role="delta">Awaiting data</div>
      </div>
    </div>

  <div class="alert alert-danger d-none qa-dashboard-alert" id="qa-dashboard-error"></div>

  <div class="qa-empty-state d-none" id="qa-empty-state">
    <i class="fa-solid fa-chart-line"></i>
    <h4 class="fw-semibold mb-2">No evaluations found for the selected filters</h4>
    <p class="mb-0">Adjust your filters or capture new QA reviews to populate this dashboard.</p>
  </div>

  <div class="row g-4" id="qa-dashboard-content">
    <div class="col-12 col-xxl-7">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Performance Trend</span>
          <span class="badge bg-light text-primary" id="qa-trend-granularity">Weekly</span>
        </div>
        <div class="card-body">
          <div class="qa-trend-chart-container">
            <canvas id="qa-trend-chart"></canvas>
          </div>
          <div class="qa-trend-summary mt-3" id="qa-trend-summary">
            Trend analysis will appear once data is loaded.
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xxl-5 d-flex flex-column gap-4">
      <div class="card h-100">
        <div class="card-header">Quality Health Overview</div>
        <div class="card-body">
          <div class="qa-gauge-wrapper mb-3">
            <canvas id="qa-gauge-chart"></canvas>
            <div class="qa-gauge-center" id="qa-gauge-value">--</div>
          </div>
          <div class="qa-gauge-subtext">Average QA Score</div>
          <div class="qa-chart-wrapper qa-chart-wrapper--compact mt-4">
            <canvas id="qa-outcome-chart"></canvas>
            <div class="qa-chart-empty d-none" id="qa-outcome-empty">Awaiting evaluation data.</div>
          </div>
        </div>
      </div>
      <div class="qa-intelligence-card h-100">
        <div class="qa-insight-count">
          <i class="fa-solid fa-robot"></i>
          <span id="qa-insight-count">0 AI insights</span>
        </div>
        <p class="qa-intelligence-card__summary mb-0" id="qa-intel-summary">
          AI-generated recommendations will populate once fresh QA data is available.
        </p>
        <div id="qa-next-best" class="qa-next-best d-none"></div>
        <div class="qa-intelligence-card__actions">
          <button type="button" class="btn btn-outline-primary" id="qa-open-insights" data-bs-toggle="modal" data-bs-target="#qaInsightsModal">
            <i class="fa-solid fa-lightbulb me-2"></i>View AI Insights
          </button>
          <button type="button" class="btn btn-primary" id="qa-open-actions" data-bs-toggle="modal" data-bs-target="#qaActionsModal">
            <i class="fa-solid fa-list-check me-2"></i>View Recommendations
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1" id="qa-analytics-row">
    <div class="col-12 col-xl-6 col-xxl-4">
      <div class="card h-100">
        <div class="card-header">Category Score Breakdown</div>
        <div class="card-body">
          <div class="qa-chart-wrapper">
            <canvas id="qa-category-chart"></canvas>
            <div class="qa-chart-empty d-none" id="qa-category-empty">Category performance will appear here.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-6 col-xxl-4">
      <div class="card h-100">
        <div class="card-header">Agent Evaluation Volume</div>
        <div class="card-body">
          <div class="qa-chart-wrapper">
            <canvas id="qa-agent-chart"></canvas>
            <div class="qa-chart-empty d-none" id="qa-agent-empty">Agent evaluation data will appear once loaded.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xl-6 col-xxl-4">
      <div class="card h-100">
        <div class="card-header">Score Distribution</div>
        <div class="card-body">
          <div class="qa-chart-wrapper">
            <canvas id="qa-distribution-chart"></canvas>
            <div class="qa-chart-empty d-none" id="qa-distribution-empty">Distribution requires agent scoring data.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4 mt-1" id="qa-lower-section">
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header">Category Performance</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-borderless align-middle qa-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th class="text-center">Avg Score</th>
                  <th class="text-center">Trend</th>
                </tr>
              </thead>
              <tbody id="qa-categories-body">
                <tr>
                  <td colspan="3" class="text-center text-muted py-4">Awaiting data</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header">Agent Leaderboard</div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-borderless align-middle qa-table">
              <thead>
                <tr>
                  <th>Agent</th>
                  <th class="text-center">Score</th>
                  <th class="text-center">Pass Rate</th>
                  <th class="text-center">Evaluations</th>
                </tr>
              </thead>
              <tbody id="qa-agents-body">
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">Awaiting data</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="qaInsightsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-lightbulb me-2 text-primary"></i>AI Insights</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="qa-insight-list" id="qa-insights"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="qaActionsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-list-check me-2 text-primary"></i>Recommended Actions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="qa-action-list" id="qa-actions"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const dashboardEl = document.getElementById('qa-dashboard');
    if (!dashboardEl) {
      return;
    }

    const state = {
      filters: {
        granularity: 'Week',
        period: '',
        agent: '',
        campaignId: '',
        program: ''
      },
      loading: false,
      data: null,
      charts: {
        trend: null,
        gauge: null,
        outcomes: null,
        categories: null,
        agents: null,
        distribution: null
      },
      modals: {
        insights: null,
        actions: null
      }
    };

    const dom = {
      granularity: document.getElementById('qa-granularity'),
      period: document.getElementById('qa-period'),
      agent: document.getElementById('qa-agent'),
      refresh: document.getElementById('qa-refresh'),
      summaryCards: dashboardEl.querySelectorAll('[data-metric]'),
      error: document.getElementById('qa-dashboard-error'),
      empty: document.getElementById('qa-empty-state'),
      content: document.getElementById('qa-dashboard-content'),
      lower: document.getElementById('qa-lower-section'),
      trendGranularity: document.getElementById('qa-trend-granularity'),
      trendSummary: document.getElementById('qa-trend-summary'),
      trendCanvas: document.getElementById('qa-trend-chart'),
      insights: document.getElementById('qa-insights'),
      actions: document.getElementById('qa-actions'),
      nextBest: document.getElementById('qa-next-best'),
      categoriesBody: document.getElementById('qa-categories-body'),
      agentsBody: document.getElementById('qa-agents-body'),
      contextSummary: document.getElementById('qa-context-summary'),
      insightCount: document.getElementById('qa-insight-count'),
      intelSummary: document.getElementById('qa-intel-summary'),
      analyticsRow: document.getElementById('qa-analytics-row'),
      gaugeCanvas: document.getElementById('qa-gauge-chart'),
      gaugeValue: document.getElementById('qa-gauge-value'),
      outcomeCanvas: document.getElementById('qa-outcome-chart'),
      categoryCanvas: document.getElementById('qa-category-chart'),
      agentCanvas: document.getElementById('qa-agent-chart'),
      distributionCanvas: document.getElementById('qa-distribution-chart'),
      outcomeEmpty: document.getElementById('qa-outcome-empty'),
      categoryEmpty: document.getElementById('qa-category-empty'),
      agentEmpty: document.getElementById('qa-agent-empty'),
      distributionEmpty: document.getElementById('qa-distribution-empty'),
      openInsights: document.getElementById('qa-open-insights'),
      openActions: document.getElementById('qa-open-actions'),
      insightsModal: document.getElementById('qaInsightsModal'),
      actionsModal: document.getElementById('qaActionsModal')
    };

    function setLoading(isLoading) {
      state.loading = isLoading;
      dashboardEl.classList.toggle('is-loading', Boolean(isLoading));
      if (dom.refresh) {
        dom.refresh.disabled = Boolean(isLoading);
      }
    }

    function destroyChart(key) {
      if (!state.charts || !state.charts[key]) {
        return;
      }
      try {
        state.charts[key].destroy();
      } catch (chartError) {
        console.warn('Unable to destroy chart', key, chartError);
      }
      state.charts[key] = null;
    }

    function safePercent(value) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return '--';
      }
      return `${Math.round(value)}%`;
    }

    function formatNumber(value) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return '--';
      }
      return new Intl.NumberFormat().format(value);
    }

    function formatDelta(value, isPercent) {
      if (value === null || value === undefined || Number.isNaN(value)) {
        return { text: 'No prior period', tone: 'neutral' };
      }
      const rounded = Math.round(value * 10) / 10;
      if (rounded === 0) {
        return { text: 'No change', tone: 'neutral' };
      }
      const sign = rounded > 0 ? '+' : '';
      const unit = isPercent ? '%' : '';
      return {
        text: `${sign}${rounded}${unit} vs prior`,
        tone: rounded > 0 ? 'positive' : 'negative'
      };
    }

    function populateSelect(selectEl, options, placeholder) {
      if (!selectEl) return;
      const currentValue = selectEl.value;
      selectEl.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = placeholder;
      selectEl.appendChild(defaultOption);
      (options || []).forEach(option => {
        const opt = document.createElement('option');
        opt.value = option.value;
        opt.textContent = option.label || option.value;
        selectEl.appendChild(opt);
      });
      if (options && options.some(option => option.value === currentValue)) {
        selectEl.value = currentValue;
      }
    }

    function renderSummary(summary) {
      const config = {
        avg: { formatter: safePercent, isPercent: true },
        pass: { formatter: safePercent, isPercent: true },
        coverage: { formatter: safePercent, isPercent: true },
        evaluations: { formatter: formatNumber, isPercent: false }
      };

      dom.summaryCards.forEach(card => {
        const metric = card.getAttribute('data-metric');
        const valueEl = card.querySelector('[data-role="value"]');
        const deltaEl = card.querySelector('[data-role="delta"]');
        const formatter = config[metric] ? config[metric].formatter : formatNumber;
        const isPercent = config[metric] ? config[metric].isPercent : false;
        if (valueEl) {
          const baseValue = summary && metric in summary ? summary[metric] : null;
          valueEl.textContent = formatter(baseValue);
        }
        if (deltaEl) {
          const deltaValue = summary && summary.delta ? summary.delta[metric] : null;
          const delta = formatDelta(deltaValue, isPercent);
          deltaEl.textContent = delta.text;
          deltaEl.className = `qa-summary-card__delta ${delta.tone}`;
        }
      });

      if (summary && dom.contextSummary) {
        const evaluations = formatNumber(summary.evaluations);
        const agents = formatNumber(summary.agents);
        dom.contextSummary.textContent = `Tracking ${evaluations} evaluation${summary.evaluations === 1 ? '' : 's'} across ${agents} agent${summary.agents === 1 ? '' : 's'} this period.`;
      }
    }

    function renderTrend(trend, granularity) {
      if (!dom.trendCanvas) return;
      const ctx = dom.trendCanvas.getContext('2d');
      if (!ctx) {
        console.warn('Unable to acquire canvas context for QA trend chart.');
        return;
      }
      const labels = (trend && trend.series ? trend.series : []).map(entry => entry.label);
      const avgDataset = (trend && trend.series ? trend.series : []).map(entry => entry.avgScore || 0);
      const passDataset = (trend && trend.series ? trend.series : []).map(entry => entry.passRate || 0);

      destroyChart('trend');

      if (typeof Chart === 'undefined') {
        console.warn('Chart.js is not available; skipping trend rendering.');
        dom.trendSummary.textContent = 'Chart library unavailable. Unable to render trend visualization.';
        return;
      }

      if (!labels.length) {
        ctx.clearRect(0, 0, dom.trendCanvas.width, dom.trendCanvas.height);
        dom.trendSummary.textContent = 'No trend data available for the selected filters yet.';
        return;
      }

      state.charts.trend = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Average Score',
              data: avgDataset,
              borderColor: '#2563eb',
              backgroundColor: 'rgba(37, 99, 235, 0.12)',
              tension: 0.35,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 5
            },
            {
              label: 'Pass Rate',
              data: passDataset,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.12)',
              tension: 0.35,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 16
              }
            },
            tooltip: {
              callbacks: {
                label(context) {
                  return `${context.dataset.label}: ${Math.round(context.parsed.y)}%`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback(value) {
                  return `${value}%`;
                }
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.25)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });

      if (dom.trendGranularity) {
        dom.trendGranularity.textContent = granularity ? `${granularity}ly` : '';
      }

      if (dom.trendSummary) {
        const summary = trend && trend.analysis && trend.analysis.summary
          ? trend.analysis.summary
          : 'Trend analysis ready once evaluations post across multiple periods.';
        dom.trendSummary.textContent = summary;
      }
    }

    function renderGauge(summary) {
      if (!dom.gaugeCanvas) return;
      const ctx = dom.gaugeCanvas.getContext('2d');
      const average = summary && typeof summary.avg === 'number'
        ? Math.min(100, Math.max(0, summary.avg))
        : null;

      if (dom.gaugeValue) {
        dom.gaugeValue.textContent = average === null ? '--' : `${Math.round(average)}%`;
      }

      if (!ctx || typeof Chart === 'undefined') {
        if (average === null) {
          destroyChart('gauge');
        }
        return;
      }

      if (average === null) {
        destroyChart('gauge');
        return;
      }

      destroyChart('gauge');
      state.charts.gauge = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Average Score', 'Gap'],
          datasets: [
            {
              data: [average, Math.max(0, 100 - average)],
              backgroundColor: ['#2563eb', 'rgba(148, 163, 184, 0.28)'],
              borderWidth: 0,
              circumference: Math.PI,
              rotation: -Math.PI,
              cutout: '72%'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label(context) {
                  return `${context.label}: ${Math.round(context.parsed)}%`;
                }
              }
            }
          }
        }
      });
    }

    function renderOutcomeChart(summary) {
      if (!dom.outcomeCanvas) return;
      const ctx = dom.outcomeCanvas.getContext('2d');
      const passPercent = summary && typeof summary.pass === 'number'
        ? Math.min(100, Math.max(0, summary.pass))
        : null;

      const hasData = passPercent !== null;
      if (dom.outcomeEmpty) {
        dom.outcomeEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('outcomes');
        return;
      }

      destroyChart('outcomes');
      state.charts.outcomes = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Pass', 'Fail'],
          datasets: [
            {
              data: [passPercent, Math.max(0, 100 - passPercent)],
              backgroundColor: ['#22c55e', '#ef4444'],
              borderWidth: 0,
              cutout: '68%'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true
              }
            },
            tooltip: {
              callbacks: {
                label(context) {
                  return `${context.label}: ${Math.round(context.parsed)}%`;
                }
              }
            }
          }
        }
      });
    }

    function renderCategoryChart(categories) {
      if (!dom.categoryCanvas) return;
      const ctx = dom.categoryCanvas.getContext('2d');
      const labels = (categories || []).map(category => category.category || 'Category');
      const data = (categories || []).map(category => Number(category.avgScore) || 0);
      const hasData = labels.length > 0;

      if (dom.categoryEmpty) {
        dom.categoryEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('categories');
        return;
      }

      destroyChart('categories');
      state.charts.categories = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Avg Score',
              data,
              backgroundColor: 'rgba(37, 99, 235, 0.65)',
              borderRadius: 8,
              maxBarThickness: 42
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback(value) {
                  return `${value}%`;
                }
              },
              grid: {
                color: 'rgba(148, 163, 184, 0.25)'
              }
            },
            x: {
              ticks: {
                autoSkip: false,
                maxRotation: 45,
                minRotation: 0
              },
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label(context) {
                  return `${context.dataset.label}: ${Math.round(context.parsed.y)}%`;
                }
              }
            }
          }
        }
      });
    }

    function renderAgentChart(agents) {
      if (!dom.agentCanvas) return;
      const ctx = dom.agentCanvas.getContext('2d');
      const topAgents = (agents || []).slice(0, 8);
      const labels = topAgents.map(agent => agent.name || 'Agent');
      const data = topAgents.map(agent => Number(agent.evaluations) || 0);
      const hasData = labels.length > 0;

      if (dom.agentEmpty) {
        dom.agentEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('agents');
        return;
      }

      destroyChart('agents');
      state.charts.agents = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Evaluations',
              data,
              backgroundColor: 'rgba(14, 165, 233, 0.7)',
              borderRadius: 8,
              maxBarThickness: 38
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              beginAtZero: true,
              grid: { color: 'rgba(148, 163, 184, 0.25)' }
            },
            y: {
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label(context) {
                  return `${context.dataset.label}: ${context.parsed.x}`;
                }
              }
            }
          }
        }
      });
    }

    function renderDistributionChart(agents) {
      if (!dom.distributionCanvas) return;
      const ctx = dom.distributionCanvas.getContext('2d');
      const bins = [
        { label: 'Below 70', min: 0, max: 70 },
        { label: '70-79', min: 70, max: 80 },
        { label: '80-89', min: 80, max: 90 },
        { label: '90-100', min: 90, max: 101 }
      ];

      const counts = bins.map(() => 0);
      (agents || []).forEach(agent => {
        const score = Number(agent.avgScore);
        if (Number.isFinite(score)) {
          const clamped = Math.min(100, Math.max(0, score));
          const binIndex = bins.findIndex(bin => clamped >= bin.min && clamped < bin.max);
          if (binIndex >= 0) {
            counts[binIndex] += 1;
          }
        }
      });

      const hasData = counts.some(count => count > 0);
      if (dom.distributionEmpty) {
        dom.distributionEmpty.classList.toggle('d-none', hasData);
      }

      if (!ctx || typeof Chart === 'undefined' || !hasData) {
        destroyChart('distribution');
        return;
      }

      destroyChart('distribution');
      state.charts.distribution = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: bins.map(bin => bin.label),
          datasets: [
            {
              label: 'Agents',
              data: counts,
              backgroundColor: 'rgba(99, 102, 241, 0.75)',
              borderRadius: 8,
              maxBarThickness: 40
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 },
              grid: { color: 'rgba(148, 163, 184, 0.25)' }
            },
            x: {
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label(context) {
                  return `${context.dataset.label}: ${context.parsed.y}`;
                }
              }
            }
          }
        }
      });
    }

    function renderInsights(insights) {
      if (!dom.insights) return;
      const items = Array.isArray(insights) ? insights : [];

      if (dom.insightCount) {
        dom.insightCount.textContent = `${items.length} AI insight${items.length === 1 ? '' : 's'}`;
      }

      dom.insights.innerHTML = '';
      if (!items.length) {
        const empty = document.createElement('p');
        empty.className = 'text-muted mb-0';
        empty.textContent = 'No insights available for the selected filters yet.';
        dom.insights.appendChild(empty);
        return;
      }

      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'qa-insight-item';
        if (item.tone) {
          row.dataset.tone = item.tone;
        }

        const icon = document.createElement('div');
        icon.className = 'qa-insight-icon';
        icon.innerHTML = `<i class="fa-solid ${item.icon || 'fa-lightbulb'}"></i>`;

        const text = document.createElement('div');
        text.className = 'qa-insight-text';
        const title = item.title ? `<strong>${item.title}</strong>` : '';
        const body = item.text || '';
        text.innerHTML = `${title}${body}`;

        row.appendChild(icon);
        row.appendChild(text);
        dom.insights.appendChild(row);
      });
    }

    function renderActions(actions, nextBest) {
      if (!dom.actions || !dom.nextBest) return;

      const items = Array.isArray(actions) ? actions : [];

      dom.actions.innerHTML = '';
      dom.nextBest.classList.add('d-none');
      dom.nextBest.innerHTML = '';

      if (nextBest && (nextBest.title || nextBest.text)) {
        dom.nextBest.classList.remove('d-none');
        dom.nextBest.innerHTML = `
          <i class="fa-solid ${nextBest.icon || 'fa-rocket'} mt-1"></i>
          <div>
            <strong>${nextBest.title || 'Next Best Action'}</strong>
            <span class="d-block text-muted">${nextBest.text || ''}</span>
          </div>`;
      }

      if (!items.length) {
        const empty = document.createElement('p');
        empty.className = 'text-muted mb-0';
        empty.textContent = 'AI has no urgent playbook steps at the moment.';
        dom.actions.appendChild(empty);
        return;
      }

      items.forEach(action => {
        const row = document.createElement('div');
        row.className = 'qa-action-item';
        if (action.tone) {
          row.dataset.tone = action.tone;
        }

        const icon = document.createElement('div');
        icon.className = 'qa-action-icon';
        icon.innerHTML = `<i class="fa-solid ${action.icon || 'fa-sparkles'}"></i>`;

        const text = document.createElement('div');
        text.className = 'qa-action-text';
        const title = action.title ? `<strong>${action.title}</strong>` : '';
        const body = action.text || '';
        text.innerHTML = `${title}${body}`;

        row.appendChild(icon);
        row.appendChild(text);
        dom.actions.appendChild(row);
      });
    }

    function createDeltaBadge(delta) {
      if (delta === null || delta === undefined || Number.isNaN(delta)) {
        return '<span class="qa-delta-badge neutral">--</span>';
      }
      const tone = delta > 0 ? 'positive' : (delta < 0 ? 'negative' : 'neutral');
      const value = Math.round(delta * 10) / 10;
      const sign = value > 0 ? '+' : '';
      return `<span class="qa-delta-badge ${tone}">${sign}${value}</span>`;
    }

    function renderCategories(categories) {
      if (!dom.categoriesBody) return;
      dom.categoriesBody.innerHTML = '';
      if (!categories || !categories.length) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="3" class="text-center text-muted py-4">No category metrics available.</td>';
        dom.categoriesBody.appendChild(row);
        return;
      }

      categories.forEach(category => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="fw-semibold">${category.category}</div>
            <div class="text-muted small">${category.passPct || 0}% pass</div>
          </td>
          <td class="text-center fw-semibold">${category.avgScore || 0}%</td>
          <td class="text-center">${createDeltaBadge(category.delta)}</td>`;
        dom.categoriesBody.appendChild(row);
      });
    }

    function renderAgents(agents) {
      if (!dom.agentsBody) return;
      dom.agentsBody.innerHTML = '';
      if (!agents || !agents.length) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" class="text-center text-muted py-4">No agent performance captured yet.</td>';
        dom.agentsBody.appendChild(row);
        return;
      }

      agents.forEach(agent => {
        const deltaScore = createDeltaBadge(agent.deltas ? agent.deltas.avgScore : null);
        const deltaPass = createDeltaBadge(agent.deltas ? agent.deltas.passRate : null);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="fw-semibold">${agent.name}</div>
            <div class="text-muted small">${agent.recentDate || 'No recent date'}</div>
          </td>
          <td class="text-center">
            <div class="fw-semibold">${agent.avgScore || 0}%</div>
            <div class="small">${deltaScore}</div>
          </td>
          <td class="text-center">
            <div class="fw-semibold">${agent.passRate || 0}%</div>
            <div class="small">${deltaPass}</div>
          </td>
          <td class="text-center fw-semibold">${agent.evaluations || 0}</td>`;
        dom.agentsBody.appendChild(row);
      });
    }

    function updateFiltersFromResponse(response) {
      const periodOptions = (response && response.periodOptions) || [];
      populateSelect(dom.period, periodOptions, 'Latest Period');
      if (dom.period && response && response.context && response.context.period) {
        dom.period.value = response.context.period;
      }

      const availableAgents = (response && response.availableAgents) || [];
      const agentOptions = availableAgents.map(name => ({ value: name, label: name }));
      populateSelect(dom.agent, agentOptions, 'All Agents');
      if (dom.agent && state.filters.agent) {
        dom.agent.value = state.filters.agent;
      }

      if (dom.granularity && response && response.context && response.context.granularity) {
        dom.granularity.value = response.context.granularity;
      }
    }

    function showError(message) {
      if (!dom.error) return;
      dom.error.textContent = message || 'Unable to load QA dashboard data.';
      dom.error.classList.remove('d-none');
    }

    function clearError() {
      if (!dom.error) return;
      dom.error.classList.add('d-none');
      dom.error.textContent = '';
    }

    function toggleEmptyState(visible) {
      if (!dom.empty || !dom.content || !dom.lower) return;
      dom.empty.classList.toggle('d-none', !visible);
      dom.content.classList.toggle('d-none', Boolean(visible));
      dom.lower.classList.toggle('d-none', Boolean(visible));
      if (dom.analyticsRow) {
        dom.analyticsRow.classList.toggle('d-none', Boolean(visible));
      }
    }

    function handleResponse(response) {
      setLoading(false);
      if (!response || response.success === false) {
        const errorMessage = response && response.error ? response.error : 'QA dashboard data unavailable.';
        showError(errorMessage);
        toggleEmptyState(true);
        return;
      }

      clearError();
      state.data = response;

      updateFiltersFromResponse(response);

      const summary = response.summary || null;
      renderSummary(summary);

      const trend = response.trend || null;
      renderTrend(trend, response.context ? response.context.granularity : 'Week');

      renderGauge(summary);
      renderOutcomeChart(summary);

      const categories = response.categories || [];
      renderCategoryChart(categories);
      renderCategories(categories);

      const agents = response.agents || [];
      renderAgentChart(agents);
      renderDistributionChart(agents);
      renderAgents(agents.slice(0, 8));

      if (dom.intelSummary) {
        dom.intelSummary.textContent = response.intelligenceSummary
          || 'AI-generated recommendations will populate once fresh QA data is available.';
      }

      renderInsights(response.insights || []);
      renderActions(response.actions || [], response.nextBest || null);

      const hasEvaluations = summary && summary.evaluations > 0;
      toggleEmptyState(!hasEvaluations);
    }

    function handleError(error) {
      console.error('QA dashboard load failed:', error);
      setLoading(false);
      showError('Unable to reach the QA service. Please try again in a moment.');
      toggleEmptyState(true);
    }

    function buildRequest() {
      return {
        granularity: state.filters.granularity,
        period: state.filters.period,
        agent: state.filters.agent,
        campaignId: state.filters.campaignId,
        program: state.filters.program
      };
    }

    function loadData() {
      if (state.loading) {
        return;
      }

      setLoading(true);
      const request = buildRequest();

      if (window.google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(handleResponse)
          .withFailureHandler(handleError)
          .clientGetQADashboardSnapshot(request);
      } else {
        console.warn('google.script.run not available; QA dashboard operating in static mode.');
        setLoading(false);
        showError('Live data unavailable outside Google Workspace context.');
        toggleEmptyState(true);
      }
    }

    function attachEvents() {
      if (dom.refresh) {
        dom.refresh.addEventListener('click', () => {
          loadData();
        });
      }

      if (dom.granularity) {
        dom.granularity.addEventListener('change', event => {
          state.filters.granularity = event.target.value;
          state.filters.period = '';
          loadData();
        });
      }

      if (dom.period) {
        dom.period.addEventListener('change', event => {
          state.filters.period = event.target.value;
          loadData();
        });
      }

      if (dom.agent) {
        dom.agent.addEventListener('change', event => {
          state.filters.agent = event.target.value;
          loadData();
        });
      }

      if (dom.openInsights && dom.insightsModal && !dom.openInsights.hasAttribute('data-bs-toggle')) {
        dom.openInsights.addEventListener('click', () => {
          if (typeof bootstrap === 'undefined') {
            return;
          }
          if (!state.modals.insights) {
            state.modals.insights = new bootstrap.Modal(dom.insightsModal);
          }
          state.modals.insights.show();
        });
      }

      if (dom.openActions && dom.actionsModal && !dom.openActions.hasAttribute('data-bs-toggle')) {
        dom.openActions.addEventListener('click', () => {
          if (typeof bootstrap === 'undefined') {
            return;
          }
          if (!state.modals.actions) {
            state.modals.actions = new bootstrap.Modal(dom.actionsModal);
          }
          state.modals.actions.show();
        });
      }

    }

    function bootstrap() {
      attachEvents();
      loadData();
    }

    bootstrap();
  })();
</script>
