<!-- Shared Lumina alert and notification system -->
<style id="lumina-alert-styles">
  .notifyjs-corner {
    z-index: 99999 !important;
  }

  :root {
    --lumina-primary: #0052cc;
    --lumina-primary-dark: #003d99;
    --lumina-primary-light: rgba(0, 82, 204, 0.12);
    --lumina-success: #00875a;
    --lumina-warning: #ffab00;
    --lumina-danger: #de350b;
    --lumina-info: #0747a6;
    --lumina-surface: #ffffff;
    --lumina-border-radius: 12px;
    --lumina-shadow: 0 4px 12px rgba(15, 23, 42, 0.12);

    --border-radius-sm: 12px;
    --spacing-sm: 0.75rem;
    --spacing-md: 1.25rem;
    --spacing-lg: 1.75rem;
    --success: var(--lumina-success);
    --warning: var(--lumina-warning);
    --danger: var(--lumina-danger);
    --info: var(--lumina-info);
  }

  .alert,
  .alert-modern {
    border: none;
    border-radius: var(--border-radius-sm);
    padding: var(--spacing-md);
    border-left: 4px solid var(--info);
    margin-bottom: var(--spacing-md);
    background: rgba(7, 71, 166, 0.08);
    color: var(--info);
    position: relative;
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-sm);
  }

  .alert.alert-success,
  .alert-success,
  .alert-modern.alert-success,
  .alert-success-modern {
    background: rgba(0, 135, 90, 0.1);
    border-left-color: var(--success);
    color: var(--success);
  }

  .alert.alert-warning,
  .alert-warning,
  .alert-modern.alert-warning,
  .alert-warning-modern {
    background: rgba(255, 171, 0, 0.1);
    border-left-color: var(--warning);
    color: var(--warning);
  }

  .alert.alert-danger,
  .alert-danger,
  .alert-modern.alert-danger,
  .alert-danger-modern {
    background: rgba(222, 53, 11, 0.1);
    border-left-color: var(--danger);
    color: var(--danger);
  }

  .alert.alert-info,
  .alert-info,
  .alert-modern.alert-info,
  .alert-info-modern {
    background: rgba(7, 71, 166, 0.1);
    border-left-color: var(--info);
    color: var(--info);
  }

  .alert .alert-close,
  .alert-modern .alert-close {
    position: absolute;
    top: 0.5rem;
    right: 0.75rem;
    border: none;
    background: transparent;
    font-size: 1.25rem;
    line-height: 1;
    color: currentColor;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s ease;
  }

  .alert .alert-close:hover,
  .alert .alert-close:focus,
  .alert-modern .alert-close:hover,
  .alert-modern .alert-close:focus {
    opacity: 1;
  }

  .lumina-toast-container {
    position: fixed;
    top: 2rem;
    right: 2rem;
    z-index: 1100;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    align-items: stretch;
    max-width: calc(100vw - 2rem);
    pointer-events: none;
  }

  .lumina-toast-container .toast {
    pointer-events: auto;
    border: none;
    border-radius: var(--lumina-border-radius);
    min-width: 320px;
    max-width: 420px;
    overflow: hidden;
    box-shadow: var(--lumina-shadow);
    background: var(--lumina-surface);
  }

  .lumina-toast-container .toast-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 600;
    border-bottom: none;
    padding: 0.85rem 1rem;
  }

  .lumina-toast-container .toast-header i {
    font-size: 1.1rem;
  }

  .lumina-toast-container .toast-body {
    color: #1f2937;
    font-size: 0.95rem;
    padding: 1rem 1.05rem 1.15rem;
    background: linear-gradient(180deg, rgba(248, 250, 252, 0.8) 0%, rgba(226, 232, 240, 0.35) 100%);
  }

  .lumina-toast-container .btn-close {
    filter: brightness(0) invert(1);
    opacity: 0.9;
  }

  .lumina-toast-container .btn-close:hover {
    opacity: 1;
  }

  @media (max-width: 575.98px) {
    .lumina-toast-container {
      top: 1rem;
      right: 0.75rem;
      left: 0.75rem;
      max-width: none;
    }

    .lumina-toast-container .toast {
      width: 100%;
      min-width: 0;
    }
  }
</style>

<script>
  (function() {
    if (window.showLuminaToast) {
      return;
    }

    const toneMap = {
      success: {
        icon: 'check-circle',
        headerClass: 'bg-success text-white',
        title: 'Success'
      },
      danger: {
        icon: 'exclamation-circle',
        headerClass: 'bg-danger text-white',
        title: 'Attention needed'
      },
      warning: {
        icon: 'exclamation-triangle',
        headerClass: 'bg-warning text-dark',
        title: 'Heads up'
      },
      info: {
        icon: 'info-circle',
        headerClass: 'bg-info text-white',
        title: 'FYI'
      }
    };

    const pendingQueue = [];

    function coerceMessage(message) {
      if (message === null || typeof message === 'undefined') {
        return '';
      }

      if (message instanceof Error) {
        return message.message;
      }

      if (typeof message === 'object') {
        try {
          return JSON.stringify(message);
        } catch (err) {
          console.warn('Unable to stringify toast message object', err);
          return String(message);
        }
      }

      return String(message);
    }

    function normalizeType(type) {
      if (!type) return 'info';
      const normalized = String(type).trim().toLowerCase();
      if (normalized === 'error') {
        return 'danger';
      }
      if (toneMap[normalized]) {
        return normalized;
      }
      return 'info';
    }

    function ensureToastContainer() {
      if (typeof document === 'undefined') {
        return null;
      }

      let container = document.getElementById('luminaToastContainer');
      if (container) {
        return container;
      }

      if (!document.body) {
        const fragment = document.createDocumentFragment();
        const placeholder = document.createElement('div');
        placeholder.id = 'luminaToastContainer';
        placeholder.className = 'lumina-toast-container';
        fragment.appendChild(placeholder);

        try {
          document.addEventListener('DOMContentLoaded', () => {
            if (!document.getElementById('luminaToastContainer')) {
              document.body.appendChild(fragment.firstChild);
            }
          }, { once: true });
        } catch (err) {
          document.addEventListener('DOMContentLoaded', () => {
            if (!document.getElementById('luminaToastContainer')) {
              document.body.appendChild(fragment.firstChild);
            }
          }, false);
        }

        return placeholder;
      }

      container = document.createElement('div');
      container.id = 'luminaToastContainer';
      container.className = 'lumina-toast-container';
      document.body.appendChild(container);
      return container;
    }

    function resolveTone(type) {
      const tone = toneMap[type] || toneMap.info;
      return Object.assign({}, tone, { type });
    }

    function buildToastMarkup(message, options = {}) {
      const tone = resolveTone(options.type);
      const title = options.title || tone.title || 'Lumina';
      const icon = options.icon || tone.icon;
      const headerClass = options.headerClass || tone.headerClass;
      const dismissible = options.dismissible !== false;

      const toastClasses = ['toast', 'shadow-lg', 'border-0'];
      if (options.className) {
        toastClasses.push(options.className);
      }

      const headerClasses = ['toast-header', headerClass].filter(Boolean).join(' ');

      const html = `
        <div class="${toastClasses.join(' ')}" role="status" aria-live="polite">
          <div class="${headerClasses}">
            ${icon ? `<i class="fas fa-${icon}"></i>` : ''}
            <strong class="me-auto">${title}</strong>
            ${dismissible ? '<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>' : ''}
          </div>
          <div class="toast-body">
            ${message}
          </div>
        </div>`;

      return { html, tone };
    }

    function mountToast(container, markup, options) {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = markup.html.trim();
      const toastElement = wrapper.firstElementChild;
      if (!toastElement) {
        return;
      }

      container.prepend(toastElement);

      const delay = Number.isFinite(options.delay) ? Number(options.delay) : 4500;
      const autohide = options.autohide !== false;

      const closeButton = toastElement.querySelector('[data-bs-dismiss="toast"]');
      if (closeButton) {
        closeButton.addEventListener('click', () => {
          toastElement.classList.remove('show');
          setTimeout(() => toastElement.remove(), 150);
        });
      }

      if (window.bootstrap && typeof window.bootstrap.Toast === 'function') {
        const toast = new window.bootstrap.Toast(toastElement, { autohide, delay });
        toast.show();
        toastElement.addEventListener('hidden.bs.toast', () => {
          toastElement.remove();
        });
      } else {
        toastElement.classList.add('show');
        if (autohide) {
          setTimeout(() => {
            toastElement.classList.remove('show');
            setTimeout(() => toastElement.remove(), 300);
          }, delay);
        }
      }
    }

    function processQueue() {
      const container = ensureToastContainer();
      if (!container || !pendingQueue.length) {
        return;
      }

      const items = pendingQueue.splice(0, pendingQueue.length);
      items.forEach(({ message, options }) => {
        const markup = buildToastMarkup(message, options);
        mountToast(container, markup, options);
      });
    }

    function showLuminaToast(message, typeOrOptions, maybeOptions) {
      const text = coerceMessage(message);
      if (!text) {
        return;
      }

      let options = {};
      if (typeof typeOrOptions === 'string') {
        options = Object.assign({}, maybeOptions || {}, { type: typeOrOptions });
      } else if (typeOrOptions && typeof typeOrOptions === 'object') {
        options = Object.assign({}, typeOrOptions);
      } else if (maybeOptions && typeof maybeOptions === 'object') {
        options = Object.assign({}, maybeOptions);
      }

      options.type = normalizeType(options.type);
      if (typeof options.title === 'string') {
        options.title = options.title.trim();
      }
      if (!options.title) {
        options.title = 'Lumina';
      }

      const container = ensureToastContainer();
      if (!container) {
        pendingQueue.push({ message: text, options });
        return;
      }

      const markup = buildToastMarkup(text, options);
      mountToast(container, markup, options);
    }

    window.showLuminaToast = showLuminaToast;
    window.showLuminaNotification = showLuminaToast;
    window.showToast = showLuminaToast;
    window.luminaNotify = function(message, type = 'info', opts = {}) {
      const options = Object.assign({}, opts, { type });
      showLuminaToast(message, options);
    };

    if (typeof document !== 'undefined') {
      try {
        document.addEventListener('DOMContentLoaded', processQueue);
      } catch (err) {
        document.addEventListener('DOMContentLoaded', processQueue, false);
      }
    }
  })();
</script>
