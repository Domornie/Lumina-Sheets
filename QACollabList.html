<!-- QAList.html -->
<?!= include('header', { rawToken: rawToken, baseUrl: baseUrl, user: user, currentPage: currentPage' }) ?>

<div class="container my-4">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Quality Audits</h5>
      <a href="<?= baseUrl ?>&page=qualityform" class="btn btn-primary btn-sm">
        <i class="fas fa-clipboard-check me-1"></i> New Audit
      </a>
    </div>

    <div class="card-body">
      <!-- SEARCH -->
      <div class="row mb-3">
        <div class="col-12 col-md-6">
          <input
            type="text"
            id="searchInput"
            class="form-control form-control-sm"
            placeholder="Search by ID, Agent, Case…"
          >
        </div>
      </div>

      <!-- TABLE -->
      <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered table-sm mb-0" id="qaTable">
          <thead class="table-light">
            <tr>
              <th style="width:3rem;text-align:center">#</th>
              <th>Timestamp</th>
              <th>Agent</th>
              <th>Case/Link</th>
              <th>Score</th>
              <th>Feedback</th>
              <th>Agent Feedback</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody><!-- injected --></tbody>
        </table>
      </div>

      <!-- PAGINATION -->
      <nav aria-label="QA pagination" class="mt-3">
        <ul id="pagination" class="pagination justify-content-center mb-0"></ul>
      </nav>
    </div>
  </div>
</div>
</div>
<!-- TOAST -->
<div id="toast" class="toast position-fixed bottom-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true">
  <div class="toast-body"></div>
</div>

<script>
  let allQA = [], currentPage = 1, rowsPerPage = 15;

  function showToast(msg, isError) {
    const el = document.getElementById('toast');
    el.querySelector('.toast-body').textContent = msg;
    el.classList.toggle('bg-danger', isError);
    el.classList.toggle('bg-success', !isError);
    new bootstrap.Toast(el).show();
  }

  function loadQA() {
    google.script.run
      .withSuccessHandler(data => { allQA = data || []; renderTable(); })
      .withFailureHandler(err => showToast(err.message, true))
      .getAllCollabQA();
  }

  function formatTS(ts) {
    return ts ? new Date(ts).toLocaleString() : '';
  }

  function renderPagination(totalPages) {
    const pagUl = document.getElementById('pagination');
    if (totalPages < 2) {
      pagUl.innerHTML = '';
      return;
    }
    let html = `
      <li class="page-item ${currentPage===1?'disabled':''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage-1});return false;">Prev</a>
      </li>`;
    for (let p = 1; p <= totalPages; p++) {
      html += `
      <li class="page-item ${p===currentPage?'active':''}">
        <a class="page-link" href="#" onclick="changePage(${p});return false;">${p}</a>
      </li>`;
    }
    html += `
      <li class="page-item ${currentPage===totalPages?'disabled':''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage+1});return false;">Next</a>
      </li>`;
    pagUl.innerHTML = html;
  }

function renderTable() {
  const term     = (document.getElementById('searchInput').value || '').toLowerCase();
  const filtered = allQA.filter(r =>
    (r.ID||'').toLowerCase().includes(term) ||
    (r.AgentName||'').toLowerCase().includes(term) ||
    (r.CaseNumber||'').toLowerCase().includes(term)
  );

  // 1) pagination math
  const totalPages = Math.max(1, Math.ceil(filtered.length / rowsPerPage));
  currentPage = Math.min(currentPage, totalPages);
  const start = (currentPage - 1) * rowsPerPage;
  const pageItems = filtered.slice(start, start + rowsPerPage);

  // 2) render rows
  const tbody = document.querySelector('#qaTable tbody');
  if (!pageItems.length) {
    tbody.innerHTML = `<tr><td colspan="8" class="text-center">No records found.</td></tr>`;
  } else {
    tbody.innerHTML = pageItems.map((r, idx) => {
      const rowNo  = start + idx + 1;
      const ts     = formatTS(r.Timestamp);
      const view   = /^https?:\/\//i.test(r.CaseNumber)
        ? `<a href="${r.CaseNumber}" target="_blank">View</a>`
        : "—";
      // Build the edit-URL here:
      const editUrl = `${baseUrl}&page=qualityform&id=${encodeURIComponent(r.ID)}`;
      console.log(`Row ${rowNo} → Edit URL:`, editUrl);   // debug

      return `
        <tr>
          <td class="text-center">${rowNo}</td>
          <td>${ts}</td>
          <td>${r.AgentName}</td>
          <td>${view}</td>
          <td>${r.TotalScore}</td>
          <td>${r.FeedbackShared}</td>
          <td>${r.AgentFeedback||""}</td>
          <td>
            <a href="${baseUrl}&page=qacollabview&id=${encodeURIComponent(r.ID)}"
              class="btn btn-sm btn-info me-1">
              <i class="fas fa-eye"></i> View
            </a>
            <a href="${editUrl}" class="btn btn-sm btn-primary me-1">
              <i class="fas fa-edit"></i> Edit
            </a>
            <button class="btn btn-sm btn-danger"
                    onclick="deleteRecord('${r.ID}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
    }).join("");
  }

  // 3) render pagination (always)
  renderPagination(totalPages);

  // 4) hide loader if you have one
  const loader = document.getElementById('pageLoader');
  if (loader) loader.style.display = 'none';
}

  function changePage(p) {
    currentPage = p;
    renderTable();
  }

  function goToForm(id) {
      window.location.href = `${baseUrl}&page=QualityCollabForm&id=${encodeURIComponent(id)}`;
  }

  function deleteRecord(id) {
    if (!confirm('Delete this QA record?')) return;
    google.script.run
      .withSuccessHandler(() => { showToast('Deleted', false); loadQA(); })
      .withFailureHandler(err => showToast(err.message, true))
      .deleteCollabQARecord(id);
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadQA();
    document.getElementById('searchInput')
      .addEventListener('input', () => {
        currentPage = 1;
        renderTable();
      });
  });
</script>

</body>
</html>
