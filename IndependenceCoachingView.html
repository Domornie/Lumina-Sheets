
    <!-- CoachingView.html -->
    <?!= include("layout", { baseUrl: baseUrl, user: user, currentPage: currentPage }) ?>

    <!-- Injected by doGet as stringified JSON -->
    <script>
        const recordId = '<?= recordId ?>';
        const record = recordId ? JSON.parse('<?= record ?>') : {};

        // Helpers
        function formatDate(iso) {
            try {
                const d = new Date(iso);
                if (!isFinite(d)) return iso || '';
                return d.toLocaleDateString([], {year: 'numeric', month: 'short', day: 'numeric'});
            } catch {
                return iso || '';
            }
        }

        function formatDateTime(iso) {
            try {
                const d = new Date(iso);
                if (!isFinite(d)) return iso || '';
                return d.toLocaleString([], {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return iso || '';
            }
        }

        // Lightweight HTML sanitizer (allow very small, safe subset)
        function sanitizeHtml(html) {
            const allowedTags = new Set(['b', 'strong', 'i', 'em', 'u', 'p', 'br', 'ul', 'ol', 'li', 'h3', 'h4', 'code', 'pre', 'blockquote', 'a', 'span']);
            const div = document.createElement('div');
            div.innerHTML = String(html || '');

            const walker = document.createTreeWalker(div, NodeFilter.SHOW_ELEMENT, null, false);
            const toRemove = [];
            while (walker.nextNode()) {
                const el = walker.currentNode;
                if (!allowedTags.has(el.tagName.toLowerCase())) {
                    // unwrap unknown elements
                    while (el.firstChild) el.parentNode.insertBefore(el.firstChild, el);
                    toRemove.push(el);
                } else {
                    // scrub attributes
                    [...el.attributes].forEach(attr => {
                        const name = attr.name.toLowerCase();
                        const val = attr.value || '';
                        if (el.tagName.toLowerCase() === 'a' && name === 'href' && /^(https?:|mailto:)/i.test(val)) {
                            // keep safe hrefs
                        } else if (name === 'style' || name.startsWith('on') || name === 'src' || name === 'href') {
                            if (!(el.tagName.toLowerCase() === 'a' && name === 'href')) el.removeAttribute(attr.name);
                        } else if (!['class'].includes(name)) {
                            el.removeAttribute(attr.name);
                        }
                    });
                }
            }
            toRemove.forEach(n => n.remove());
            return div.innerHTML;
        }
    </script>

    <style>
        :root {
            --primary: #4285f4;
            --primary-dark: #1a73e8;
            --accent: #34a853;
            --warning: #fbbc04;
            --danger: #ea4335;
            --surface: #ffffff;
            --surface-variant: #f8f9fa;
            --surface-elevated: #ffffff;
            --outline: #dadce0;
            --outline-variant: #e8eaed;
            --shadow-elevated: 0 4px 24px rgba(0, 0, 0, .12);
            --text: #202124;
            --muted: #5f6368;
            --muted-2: #80868b;
            --radius: 12px;
            --radius-lg: 16px;
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            --gradient-accent: linear-gradient(135deg, var(--accent) 0%, #2e7d32 100%);
            --transition: all .3s cubic-bezier(.4, 0, .2, 1)
        }

        * {
            box-sizing: border-box
        }

        /* Navigation */
        .coaching-nav {
            background: var(--surface-elevated);
            border-radius: var(--radius);
            box-shadow: var(--shadow-elevated);
            margin-bottom: 1.25rem;
            overflow: hidden;
            border: 1px solid var(--outline-variant)
        }

        .coaching-nav .nav {
            padding: .5rem;
            gap: .25rem
        }

        .coaching-nav .nav-link {
            color: var(--muted);
            text-decoration: none;
            font-weight: 600;
            padding: .85rem 1.25rem;
            border-radius: 10px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: .5rem;
            font-size: .92rem
        }

        .coaching-nav .nav-link:hover {
            background: rgba(66, 133, 244, .08);
            color: var(--primary);
            transform: translateY(-1px)
        }

        .coaching-nav .nav-link.active {
            background: var(--gradient-primary);
            color: #fff;
            box-shadow: 0 2px 8px rgba(66, 133, 244, .3)
        }

        /* Action banner */
        .action-banner {
            display: flex;
            flex-wrap: wrap;
            gap: .5rem;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem
        }

        .btn {
            border: none;
            border-radius: 10px;
            padding: .7rem 1.1rem;
            font-weight: 800;
            letter-spacing: .02em;
            font-size: .85rem;
            display: inline-flex;
            gap: .5rem;
            align-items: center;
            cursor: pointer;
            transition: var(--transition)
        }

        .btn-accent {
            background: var(--gradient-accent);
            color: #fff;
            box-shadow: 0 2px 8px rgba(52, 168, 83, .25)
        }

        .btn-accent:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 168, 83, .3)
        }

        .btn-secondary {
            background: #fff;
            border: 2px solid var(--outline);
            color: var(--text)
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, .06)
        }

        .id-chip {
            background: var(--surface-variant);
            border: 1px solid var(--outline);
            padding: .5rem .75rem;
            border-radius: 999px;
            color: var(--muted);
            font-weight: 700
        }

        /* Cards */
        .coaching-card {
            background: var(--surface-elevated);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-elevated);
            margin-bottom: 1rem;
            overflow: hidden;
            border: 1px solid var(--outline-variant);
            animation: slideInUp .6s cubic-bezier(.4, 0, .2, 1) forwards
        }

        .coaching-card-header {
            background: var(--gradient-primary);
            color: #fff;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: .6rem
        }

        .coaching-card-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 800;
            letter-spacing: -.01em
        }

        .coaching-card-body {
            padding: 1.25rem
        }

        .details-grid {
            display: grid;
            gap: 1rem
        }

        @media (min-width: 768px) {
            .details-grid {
                grid-template-columns:repeat(2, 1fr)
            }
        }

        @media (min-width: 1024px) {
            .details-grid {
                grid-template-columns:repeat(3, 1fr)
            }
        }

        .detail-item {
            display: flex;
            flex-direction: column
        }

        .detail-label {
            font-size: .78rem;
            color: var(--muted);
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: .05em;
            display: flex;
            gap: .4rem;
            align-items: center
        }

        .detail-value {
            font-size: .96rem;
            color: var(--text);
            font-weight: 600;
            line-height: 1.6;
            padding: .25rem 0
        }

        .detail-value.empty {
            color: var(--muted-2);
            font-style: italic
        }

        /* Rich content */
        .detail-value p {
            margin: .5rem 0
        }

        .detail-value ul, .detail-value ol {
            margin: .5rem 0 .5rem 1.25rem
        }

        .detail-value code {
            background: var(--surface-variant);
            padding: .1rem .3rem;
            border-radius: 6px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace
        }

        .detail-value blockquote {
            border-left: 3px solid var(--primary);
            padding-left: .75rem;
            margin: .5rem 0;
            color: var(--muted)
        }

        .detail-value a {
            color: var(--primary);
            text-decoration: none;
            border-bottom: 1px solid transparent
        }

        .detail-value a:hover {
            border-bottom-color: var(--primary)
        }

        /* Topics */
        .topics-container, .covered-topics-container {
            display: flex;
            flex-wrap: wrap;
            gap: .6rem
        }

        .topic-pill {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #1565c0;
            padding: .5rem .9rem;
            border-radius: 22px;
            font-size: .85rem;
            font-weight: 700;
            border: 1px solid rgba(21, 101, 192, .12)
        }

        .topic-pill.covered {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            color: #2e7d32;
            border-color: rgba(46, 125, 50, .12)
        }

        .topic-checkbox {
            display: flex;
            align-items: center;
            gap: .6rem;
            padding: .55rem .9rem;
            border-radius: 22px;
            background: #fff;
            border: 2px solid var(--outline-variant);
            cursor: pointer;
            font-weight: 700
        }

        .topic-checkbox.checked {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-color: var(--accent);
            color: #2e7d32
        }

        .topic-checkbox input {
            width: 1.1rem;
            height: 1.1rem;
            border-radius: 6px;
            border: 2px solid var(--outline)
        }

        .topic-checkbox input:checked {
            background: var(--gradient-primary);
            border-color: var(--primary)
        }

        /* Completion */
        .completion-section {
            background: var(--surface-elevated);
            border-radius: var(--radius-lg);
            padding: 1rem;
            border: 1px solid var(--outline-variant);
            display: flex;
            gap: .75rem;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap
        }

        .complete-button {
            background: var(--gradient-accent);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: .75rem 1.25rem;
            font-weight: 800;
            display: flex;
            gap: .5rem;
            align-items: center;
            box-shadow: 0 2px 8px rgba(52, 168, 83, .25)
        }

        .complete-button:disabled {
            background: var(--outline-variant);
            color: var(--muted-2);
            box-shadow: none
        }

        .inline-actions {
            display: flex;
            gap: .5rem;
            flex-wrap: wrap
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            color: var(--muted);
            padding: 1rem
        }

        .empty-state i {
            display: block;
            font-size: 1.75rem;
            color: #cfd8dc;
            margin-bottom: .5rem
        }

        /* Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(18px)
            }
            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .loading-spinner {
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            from {
                transform: rotate(0)
            }
            to {
                transform: rotate(360deg)
            }
        }
    </style>

    <!-- Navigation -->
    <nav class="coaching-nav">
        <div class="nav d-flex">
            <a href="<?= baseUrl ?>&page=coachinglist"
               class="nav-link <?= currentPage==='Coaching Sessions'?'active':'' ?>">
                <i class="fas fa-list"></i><span>List Sessions</span>
            </a>
            <a href="<?= baseUrl ?>&page=coachingsheet"
               class="nav-link <?= currentPage==='Coaching Sheet'?'active':'' ?>">
                <i class="fas fa-plus-circle"></i><span>New Session</span>
            </a>
            <a href="<?= baseUrl ?>&page=coachingdashboard"
               class="nav-link <?= currentPage==='Coaching Dashboard'?'active':'' ?>">
                <i class="fas fa-chart-line"></i><span>Dashboard</span>
            </a>
        </div>
    </nav>

    <!-- Action Banner -->
    <div class="action-banner">
        <span class="id-chip" title="Coaching Record ID"><i class="fas fa-hashtag"></i> <strong id="ridChip">â€”</strong></span>
        <a href="<?= baseUrl ?>&page=ackform&id=<?= recordId ?>" class="btn btn-accent" id="sendAck" target="_blank"
           title="Open the acknowledgement link for this session">
            <i class="fas fa-external-link-alt"></i> Send Acknowledgement Link
        </a>
        <button class="btn btn-secondary" id="copyAck"><i class="fas fa-link"></i> Copy Ack Link</button>
        <button class="btn btn-secondary" id="printPage"><i class="fas fa-print"></i> Print</button>
    </div>

    <!-- Coaching Details -->
    <div class="coaching-card">
        <div class="coaching-card-header">
            <i class="fas fa-user-tie"></i>
            <h3>Coaching Session Details</h3>
        </div>
        <div class="coaching-card-body">
            <div class="details-grid">
                <div class="detail-item">
                    <div class="detail-label"><i class="fas fa-calendar"></i>Session Date</div>
                    <div class="detail-value" id="dSessionDate"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label"><i class="fas fa-user-graduate"></i>Coach</div>
                    <div class="detail-value" id="dAgentName"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label"><i class="fas fa-user"></i>Coachee</div>
                    <div class="detail-value" id="dCoacheeName"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label"><i class="fas fa-envelope"></i>Coachee Email</div>
                    <div class="detail-value" id="dCoacheeEmail"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label"><i class="fas fa-tasks"></i>Action Plan</div>
                    <div class="detail-value" id="dActionPlan"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label"><i class="fas fa-clock"></i>Follow-Up Date</div>
                    <div class="detail-value" id="dFollowUpDate"></div>
                </div>
                <div class="detail-item" style="grid-column:1/-1">
                    <div class="detail-label"><i class="fas fa-sticky-note"></i>Notes</div>
                    <div class="detail-value" id="dNotes"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label"><i class="fas fa-plus-circle"></i>Created At</div>
                    <div class="detail-value" id="dCreatedAt"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label"><i class="fas fa-edit"></i>Updated At</div>
                    <div class="detail-value" id="dUpdatedAt"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label"><i class="fas fa-link"></i>QA Record ID</div>
                    <div class="detail-value" id="dQAId"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Planned Topics -->
    <div class="coaching-card">
        <div class="coaching-card-header">
            <i class="fas fa-lightbulb"></i>
            <h3>Planned Topics</h3>
        </div>
        <div class="coaching-card-body">
            <div class="topics-container" id="plannedPill">
                <div class="empty-state"><i class="fas fa-clipboard-list"></i>No topics planned yet</div>
            </div>
        </div>
    </div>

    <!-- Mark Covered Topics -->
    <div class="coaching-card">
        <div class="coaching-card-header">
            <i class="fas fa-check-circle"></i>
            <h3>Mark Covered Topics</h3>
        </div>
        <div class="coaching-card-body">
            <div class="inline-actions" id="bulkActions" style="margin-bottom:.75rem;display:none">
                <button class="btn btn-secondary" id="markAll"><i class="fas fa-check-double"></i> Mark All Covered
                </button>
                <button class="btn btn-secondary" id="unmarkAll"><i class="fas fa-rotate-left"></i> Clear All</button>
            </div>
            <div class="covered-topics-container" id="coveredPill">
                <div class="empty-state"><i class="fas fa-tasks"></i>No topics to mark as covered</div>
            </div>
        </div>
    </div>

    <!-- Acknowledgement (if any) -->
    <div class="coaching-card" id="ackCard" style="display:none">
        <div class="coaching-card-header">
            <i class="fas fa-handshake"></i>
            <h3>Agent Acknowledgement</h3>
        </div>
        <div class="coaching-card-body">
            <div class="details-grid">
                <div class="detail-item" style="grid-column:1/-1">
                    <div class="detail-label"><i class="fas fa-align-left"></i>Response</div>
                    <div class="detail-value" id="dAckText"></div>
                </div>
                <div class="detail-item">
                    <div class="detail-label"><i class="fas fa-calendar-check"></i>Acknowledged On</div>
                    <div class="detail-value" id="dAckOn"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Complete -->
    <div class="completion-section">
        <label style="display:flex;align-items:center;gap:.6rem;font-weight:800;color:var(--text)">
            <input type="checkbox" id="completeCb"/> Mark coaching session as completed
        </label>
        <button id="btnComplete" class="complete-button" disabled>
            <i class="fas fa-check"></i> Complete & Notify
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!recordId) {
                alert('No coaching record loaded.');
                return;
            }
            const get = k => record[k] ?? '';

            // ID chip & links
            document.getElementById('ridChip').textContent = recordId || 'â€”';
            const ackHref = '<?= baseUrl ?>&page=ackform&id=<?= recordId ?>';
            document.getElementById('copyAck').addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(ackHref);
                } catch {
                }
                const btn = document.getElementById('copyAck');
                const old = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied';
                setTimeout(() => btn.innerHTML = old, 1200);
            });
            document.getElementById('printPage').addEventListener('click', () => window.print());

            // Populate detail fields (ActionPlan/Notes as sanitized HTML)
            const fields = {
                dSessionDate: {val: formatDate(get('SessionDate'))},
                dAgentName: {val: get('AgentName')},
                dCoacheeName: {val: get('CoacheeName')},
                dCoacheeEmail: {val: get('CoacheeEmail')},
                dActionPlan: {val: sanitizeHtml(get('ActionPlan') || ''), html: true},
                dFollowUpDate: {val: formatDate(get('FollowUpDate'))},
                dNotes: {val: sanitizeHtml(get('Notes') || ''), html: true},
                dCreatedAt: {val: formatDateTime(get('CreatedAt'))},
                dUpdatedAt: {val: formatDateTime(get('UpdatedAt'))},
                dQAId: {val: get('QAId')}
            };
            Object.entries(fields).forEach(([id, cfg]) => {
                const el = document.getElementById(id);
                const val = (cfg.val || '').toString().trim();
                if (!el) return;
                if (val) {
                    if (cfg.html) el.innerHTML = val; else el.textContent = val;
                } else {
                    el.textContent = 'Not specified';
                    el.classList.add('empty');
                }
            });

            // Acknowledgement (optional fields)
            const ackText = get('AcknowledgementText');
            const ackOn = get('AcknowledgedOn');
            if (ackText || ackOn) {
                document.getElementById('ackCard').style.display = '';
                document.getElementById('dAckText').innerHTML = sanitizeHtml(ackText || '<em>No response text</em>');
                document.getElementById('dAckOn').textContent = ackOn ? formatDateTime(ackOn) : 'â€”';
            }

            // Topics (planned / covered)
            const plannedArr = (() => {
                try {
                    return JSON.parse(get('TopicsPlanned') || '[]')
                } catch {
                    return []
                }
            })();
            const coveredArr = (() => {
                try {
                    return JSON.parse(get('CoveredTopics') || '[]')
                } catch {
                    return []
                }
            })();

            const plannedPill = document.getElementById('plannedPill');
            const coveredPill = document.getElementById('coveredPill');
            const bulkActions = document.getElementById('bulkActions');

            function renderPlanned(currentCovered = new Set(coveredArr)) {
                if (!plannedArr.length) {
                    plannedPill.innerHTML = `<div class="empty-state"><i class="fas fa-clipboard-list"></i>No topics planned yet</div>`;
                    bulkActions.style.display = 'none';
                    return;
                }
                bulkActions.style.display = '';
                plannedPill.innerHTML = plannedArr.map(t => {
                    const name = t.name || '';
                    const detail = sanitizeHtml(t.detail || '');
                    const isCovered = currentCovered.has(name);
                    return `
        <div class="topic-pill ${isCovered ? 'covered' : ''}">
          <i class="fas fa-${isCovered ? 'check-circle' : 'circle'}"></i>
          <strong>${name}</strong>${detail ? `: ${detail}` : ''}
        </div>`;
                }).join('');
            }

            function renderCovered() {
                if (!plannedArr.length) {
                    coveredPill.innerHTML = `<div class="empty-state"><i class="fas fa-tasks"></i>No topics to mark as covered</div>`;
                    return;
                }
                coveredPill.innerHTML = plannedArr.map(t => {
                    const name = t.name || '';
                    const checked = coveredArr.includes(name) ? 'checked' : '';
                    const id = 'cov_' + name.replace(/\W+/g, '_');
                    const chkClass = checked ? 'checked' : '';
                    return `
        <label class="topic-checkbox ${chkClass}">
          <input type="checkbox" id="${id}" value="${name}" ${checked}>
          <span data-original="${name}">${name}</span>
        </label>`;
                }).join('');

                // Bind change handlers
                coveredPill.querySelectorAll('input[type=checkbox]').forEach(cb => {
                    cb.addEventListener('change', e => {
                        const wrap = e.target.closest('.topic-checkbox');
                        const span = wrap.querySelector('span');
                        const original = span.dataset.original || span.textContent;
                        if (e.target.checked) {
                            wrap.classList.add('checked');
                            span.innerHTML = `<i class="fas fa-spinner loading-spinner"></i> ${original}`;
                        } else {
                            wrap.classList.remove('checked');
                            span.textContent = original;
                        }

                        const newCovered = Array.from(coveredPill.querySelectorAll('input:checked')).map(i => i.value);

                        google.script.run
                            .withSuccessHandler(() => {
                                span.textContent = original;
                                coveredArr.splice(0, coveredArr.length, ...newCovered); // mutate in place
                                renderPlanned(new Set(coveredArr));
                                updateCompletionState();
                            })
                            .withFailureHandler(err => {
                                console.error('Update failed:', err);
                                // revert
                                if (e.target.checked) {
                                    e.target.checked = false;
                                    wrap.classList.remove('checked');
                                } else {
                                    e.target.checked = true;
                                    wrap.classList.add('checked');
                                }
                                span.textContent = original;
                            })
                            .updateCoveredTopics(recordId, newCovered);
                    });
                });
            }

            // Bulk actions
            document.getElementById('markAll').addEventListener('click', () => {
                const all = plannedArr.map(t => t.name).filter(Boolean);
                if (!all.length) return;
                google.script.run
                    .withSuccessHandler(() => {
                        coveredArr.splice(0, coveredArr.length, ...all);
                        renderCovered();
                        renderPlanned(new Set(coveredArr));
                        updateCompletionState();
                    })
                    .withFailureHandler(err => alert('Error: ' + err.message))
                    .updateCoveredTopics(recordId, all);
            });
            document.getElementById('unmarkAll').addEventListener('click', () => {
                google.script.run
                    .withSuccessHandler(() => {
                        coveredArr.splice(0, coveredArr.length);
                        renderCovered();
                        renderPlanned(new Set());
                        updateCompletionState();
                    })
                    .withFailureHandler(err => alert('Error: ' + err.message))
                    .updateCoveredTopics(recordId, []);
            });

            renderPlanned(new Set(coveredArr));
            renderCovered();

            // Completion control
            const completeCb = document.getElementById('completeCb');
            const completeBtn = document.getElementById('btnComplete');

            function updateCompletionState() {
                const count = coveredArr.length;
                if (plannedArr.length > 0 && count === plannedArr.length) {
                    completeCb.checked = true;
                    completeBtn.disabled = false;
                } else {
                    completeCb.checked = false;
                    completeBtn.disabled = true;
                }
            }

            updateCompletionState();

            completeCb.addEventListener('change', () => {
                completeBtn.disabled = !completeCb.checked;
            });

            completeBtn.addEventListener('click', () => {
                completeBtn.disabled = true;
                const old = completeBtn.innerHTML;
                completeBtn.innerHTML = '<i class="fas fa-spinner loading-spinner"></i> Processingâ€¦';
                google.script.run
                    .withSuccessHandler(() => {
                        completeBtn.innerHTML = '<i class="fas fa-check-circle"></i> Completed!';
                        setTimeout(() => alert('Agent notified successfully.'), 300);
                    })
                    .withFailureHandler(err => {
                        alert('Error: ' + err.message);
                        completeBtn.disabled = false;
                        completeBtn.innerHTML = old;
                    })
                    .completeCoachingAndNotify(recordId);
            });

            // Tooltips (title attributes already set on buttons)
            console.log('ðŸŽ¯ Coaching View loaded');
        });
    </script>

</body>
</html>
