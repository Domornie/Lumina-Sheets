    <?!= includeOnce('ResponsiveStyles') ?>
<?
  var __navInvalidPanelPattern = /usercodeapppanel/i;

  function __navNormalizeUrlValue(value) {
    if (value === null || typeof value === 'undefined') {
      return '';
    }

    var trimmed = String(value).trim();
    if (!trimmed || trimmed.toLowerCase() === 'undefined') {
      return '';
    }

    return trimmed;
  }

  function __navFixPanelUrl(value) {
    var normalized = __navNormalizeUrlValue(value);
    if (!normalized) {
      return '';
    }

    if (!__navInvalidPanelPattern.test(normalized)) {
      return normalized;
    }

    return normalized.replace(/\/userCodeAppPanel.*$/i, '/exec');
  }

  function __navSanitizeNavigationUrl(url, fallback) {
    var primary = __navFixPanelUrl(url);
    if (primary) {
      return primary;
    }

    return __navFixPanelUrl(fallback);
  }

  var __navRawBaseUrl = (typeof baseUrl !== 'undefined' && baseUrl) ? baseUrl : '';
  var __navRawScriptUrl = (typeof scriptUrl !== 'undefined' && scriptUrl) ? scriptUrl : __navRawBaseUrl;

  var __navSanitizedBaseUrl = __navSanitizeNavigationUrl(__navRawBaseUrl, __navRawScriptUrl);
  var __navSanitizedScriptUrl = __navSanitizeNavigationUrl(__navRawScriptUrl, __navRawBaseUrl);

  var baseUrl = __navSanitizedBaseUrl || __navSanitizedScriptUrl || __navRawBaseUrl;
  var __navLinkBase = baseUrl || __navSanitizedScriptUrl || '';
  var currentPage = (typeof currentPage !== 'undefined' && currentPage) ? currentPage : '';
  var sidebarUser = (typeof user !== 'undefined' && user) ? user : {};
  var isAdminUser = Boolean(isAdmin);
  var campaignIdValue = (typeof campaignId !== 'undefined' && campaignId) ? campaignId : '';
  var campaignNameValue = (typeof campaignName !== 'undefined' && campaignName) ? campaignName : '';
  var navigationConfig = navigation && typeof navigation === 'object' ? navigation : { categories: [], uncategorizedPages: [] };
  var employmentMetaValue = employmentMeta && typeof employmentMeta === 'object' ? employmentMeta : { status: '', cls: '', icon: 'fas fa-briefcase' };

  function safeUserString(value) {
    if (value === null || typeof value === 'undefined') {
      return '';
    }

    var text = String(value).trim();
    if (!text || text.toLowerCase() === 'undefined' || text.toLowerCase() === 'null') {
      return '';
    }

    return text;
  }

  function escapeHtml(value) {
    if (value === null || typeof value === 'undefined') {
      return '';
    }

    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function getUserFieldValue(user, keys) {
    if (!user || !keys || !keys.length) {
      return '';
    }

    for (var idx = 0; idx < keys.length; idx++) {
      var key = keys[idx];
      if (!key || !(key in user)) {
        continue;
      }

      var rawValue = user[key];
      var normalized = safeUserString(rawValue);
      if (normalized) {
        return normalized;
      }
    }

    return '';
  }

  var firstNameValue = getUserFieldValue(sidebarUser, ['FirstName', 'firstName', 'GivenName', 'givenName']);
  var lastNameValue = getUserFieldValue(sidebarUser, ['LastName', 'lastName', 'Surname', 'surname', 'FamilyName', 'familyName']);
  var userFullNameValue = getUserFieldValue(sidebarUser, ['FullName', 'fullName', 'DisplayName', 'displayName']);
  var userNameValue = getUserFieldValue(sidebarUser, ['UserName', 'userName', 'username', 'Email', 'email']);

  var firstLastDisplayName = [firstNameValue, lastNameValue]
    .filter(function (value) { return safeUserString(value); })
    .join(' ');

  var displayFullNameValue = userFullNameValue || firstLastDisplayName || userNameValue;
  var displayPrimaryNameValue = firstLastDisplayName || displayFullNameValue || userNameValue || 'Unknown User';

  var primaryRoleNameValue = getUserFieldValue(sidebarUser, [
    'RoleName', 'roleName', 'PrimaryRole', 'primaryRole',
    'Role', 'role', 'Title', 'title',
    'JobTitle', 'jobTitle'
  ]);

  if (!primaryRoleNameValue && userRoleNames && userRoleNames.length) {
    primaryRoleNameValue = userRoleNames[0];
  }

  if (!displayFullNameValue) {
    displayFullNameValue = displayPrimaryNameValue;
  }

  var userInitialValue = (displayPrimaryNameValue || 'U').charAt(0).toUpperCase();

  function isLikelyRoleIdentifier(value) {
    var text = safeUserString(value);
    if (!text) {
      return false;
    }

    if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(text)) {
      return true;
    }

    if (/^[0-9a-f]{24}$/i.test(text)) {
      return true;
    }

    if (/^[0-9]{7,}$/.test(text)) {
      return true;
    }

    return false;
  }

  function extractRoleLabelFromObject(role) {
    if (!role || typeof role !== 'object') {
      return '';
    }

    var labelKeys = [
      'Name', 'name',
      'RoleName', 'roleName',
      'Title', 'title',
      'DisplayName', 'displayName',
      'Label', 'label'
    ];

    for (var idx = 0; idx < labelKeys.length; idx++) {
      var key = labelKeys[idx];
      if (!(key in role)) {
        continue;
      }

      var labelCandidate = safeUserString(role[key]);
      if (labelCandidate && !isLikelyRoleIdentifier(labelCandidate)) {
        return labelCandidate;
      }
    }

    if (role.Role || role.role) {
      return extractRoleLabelFromObject(role.Role || role.role);
    }

    return '';
  }

  function normalizeRoleInput(input) {
    if (!input) {
      return [];
    }

    if (Array.isArray(input)) {
      return input
        .map(function (role) {
          if (!role) {
            return '';
          }
          if (typeof role === 'string') {
            return role;
          }
          if (typeof role === 'object') {
            return extractRoleLabelFromObject(role);
          }
          return String(role);
        })
        .map(function (role) { return String(role || '').trim(); })
        .filter(function (role) {
          return role.length > 0 && !isLikelyRoleIdentifier(role);
        });
    }

    if (typeof input === 'string') {
      return input
        .split(',')
        .map(function (role) { return role.trim(); })
        .filter(function (role) {
          return role.length > 0 && !isLikelyRoleIdentifier(role);
        });
    }

    return [String(input || '').trim()].filter(function (role) {
      return role.length > 0 && !isLikelyRoleIdentifier(role);
    });
  }

  function dedupeRoles(list) {
    var seen = {};
    return list.filter(function (role) {
      var key = role.toLowerCase();
      if (seen[key]) {
        return false;
      }
      seen[key] = true;
      return true;
    });
  }

  function buildRoleBadgeMarkup(roles) {
    if (!roles || !roles.length) {
      return '';
    }

    var html = [];
    for (var idx = 0; idx < roles.length; idx++) {
      var label = safeUserString(roles[idx]);
      if (!label) {
        continue;
      }
      html.push('<span class="badge bg-secondary role-badge">' + escapeHtml(label) + '</span>');
    }

    return html.join('');
  }

  var rawRoleNames = (typeof roleNames !== 'undefined' && roleNames !== null) ? roleNames : '';

  var roleCandidates = [];
  roleCandidates = roleCandidates.concat(normalizeRoleInput(rawRoleNames));
  roleCandidates = roleCandidates.concat(normalizeRoleInput(sidebarUser && sidebarUser.roleNames));
  roleCandidates = roleCandidates.concat(normalizeRoleInput(sidebarUser && sidebarUser.roles));
  roleCandidates = roleCandidates.concat(normalizeRoleInput(sidebarUser && sidebarUser.Roles));
  roleCandidates = roleCandidates.concat(normalizeRoleInput(sidebarUser && sidebarUser.csvRoles));

  if (!roleCandidates.length) {
    var singleRole = sidebarUser && (sidebarUser.RoleName || sidebarUser.PrimaryRole || sidebarUser.Role || sidebarUser.role);
    roleCandidates = roleCandidates.concat(normalizeRoleInput(singleRole));
  }

  var userRoleNames = dedupeRoles(roleCandidates);
  if (!userRoleNames.length && isAdminUser) {
    userRoleNames = ['System Administrator'];
  }

  var userRoleBadgesHtml = buildRoleBadgeMarkup(userRoleNames);

  var currentPageKeyValue = currentPage || '';
  var currentPageAttrValue = String(currentPageKeyValue)
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');

  function generateLink(page) {
    var target = __navLinkBase;
    if (!target) {
      return '?page=' + encodeURIComponent(page);
    }

    var hasQuery = target.indexOf('?') !== -1;
    var separator = hasQuery ? (/[?&]$/.test(target) ? '' : '&') : '?';
    return target + separator + 'page=' + encodeURIComponent(page);
  }
?>

<style>
  #sidebar .user-info .role {
    white-space: normal;
  }

  #sidebar .user-info .role-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    align-items: center;
  }

  #sidebar .user-info .role-badges .badge {
    border-radius: 999px;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.3rem 0.6rem;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }
</style>

<nav id="sidebar" data-current-page='<?= currentPageAttrValue ?>'>
  <!-- Enhanced Logo Section -->
  <div class="sidebar-logo" id="sidebarToggle">
    <img
      src="https://res.cloudinary.com/dr8qd3xfc/image/upload/v1754763514/vlbpo/lumina/3_dgitcx.png"
      alt="LuminaHQ Icon"
      class="logo-icon"
      loading="lazy"
      onerror="this.style.display='none'"
    />

    <div class="logo-text-container">
      <img
        src="https://res.cloudinary.com/dr8qd3xfc/image/upload/v1754763929/vlbpo/lumina/Lumina_aa8rch.png"
        alt="LuminaHQ"
        class="logo-text"
        loading="lazy"
        onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"
      />

      <div class="logo-text-fallback">
        <span class="brand-accent">Lumina</span>HQ
      </div>
    </div>
  </div>

  <div class="sidebar-content">
    <? if (campaignIdValue && campaignNameValue) { ?>
    <div class="campaign-header-sidebar">
      <div class="campaign-badge-sidebar">
        <i class="fas fa-building"></i>
        <?= campaignNameValue ?>
      </div>
    </div>
    <? } else if (isAdminUser) { ?>
    <div class="campaign-header-sidebar">
      <div class="campaign-badge-sidebar">
        <i class="fas fa-user-shield"></i>System Administrator
      </div>
    </div>
    <? } ?>

    <? if (navigationConfig && navigationConfig.categories && navigationConfig.categories.length > 0) { ?>
      <? navigationConfig.categories.forEach(function(category) {
           var categoryPages = (category && (category.pages || category.Pages)) || [];
           if (!Array.isArray(categoryPages) || !categoryPages.length) {
             return;
           }

           var categoryIcon = category.CategoryIcon || category.categoryIcon || 'fas fa-folder';
           var categoryName = category.CategoryName || category.categoryName || 'Unnamed Category';
        ?>
        <div class="sidebar-category">
          <div class="category-header">
            <i class="<?= categoryIcon ?>"></i>
            <span><?= categoryName ?></span>
          </div>
          <div class="sidebar-group">
            <? categoryPages.forEach(function(page) {
                 var pageKey = page && (page.PageKey || page.pageKey);
                 var pageTitle = page && (page.PageTitle || page.pageTitle);
                 if (!page || !pageKey || !pageTitle) { return; }

                 var pageIcon = page.PageIcon || page.pageIcon || 'fas fa-file';
                 var pageDescription = page.PageDescription || page.pageDescription || pageTitle;
            ?>
              <a href="<?= generateLink(pageKey) ?>"
                class="<?= (currentPage === pageTitle || currentPage === pageKey) ? 'active' : '' ?>"
                data-page-key="<?= pageKey ?>"
                data-page-title="<?= pageTitle ?>"
                data-bs-toggle="tooltip" data-bs-placement="right" title="<?= pageDescription ?>">
                <i class="<?= pageIcon ?>"></i>
                <span><?= pageTitle ?></span>
              </a>
            <? }); ?>
          </div>
        </div>
      <? }); ?>
    <? } ?>

    <? if (navigationConfig && navigationConfig.uncategorizedPages && navigationConfig.uncategorizedPages.length > 0) { ?>
    <div class="sidebar-category">
      <div class="category-header">
        <i class="fas fa-list"></i>
        <span>Other</span>
      </div>
      <div class="sidebar-group">
        <? navigationConfig.uncategorizedPages.forEach(function(page) {
             var pageKey = page && (page.PageKey || page.pageKey);
             var pageTitle = page && (page.PageTitle || page.pageTitle);
             if (!page || !pageKey || !pageTitle) { return; }

             var pageIcon = page.PageIcon || page.pageIcon || 'fas fa-file';
             var pageDescription = page.PageDescription || page.pageDescription || pageTitle;
        ?>
          <a href="<?= generateLink(pageKey) ?>"
            class="<?= (currentPage === pageTitle || currentPage === pageKey) ? 'active' : '' ?>"
            data-page-key="<?= pageKey ?>"
            data-page-title="<?= pageTitle ?>"
            data-bs-toggle="tooltip" data-bs-placement="right" title="<?= pageDescription ?>">
            <i class="<?= pageIcon ?>"></i>
            <span><?= pageTitle ?></span>
          </a>
        <? }); ?>
      </div>
    </div>
    <? } ?>

    <div class="global-section">
      <div class="sidebar-category">
        <div class="category-header">
          <i class="fas fa-globe"></i>
          <span>Global</span>
        </div>
        <div class="sidebar-group">
          <a href="<?= generateLink('chat') ?>" class="<?= currentPage==='Chat'?'active':'' ?>" data-bs-toggle="tooltip"
            data-page-key="chat" data-page-title="Chat"
            data-bs-placement="right" title="Team Chat">
            <i class="fas fa-comments"></i><span>Chat</span>
          </a>
          <a href="<?= generateLink('collaboration-reporting') ?>" class="<?= currentPage==='Collaboration Reporting'?'active':'' ?>"
            data-page-key="collaboration-reporting" data-page-title="Collaboration Reporting"
            data-bs-toggle="tooltip" data-bs-placement="right" title="Collaboration &amp; Reporting Hub">
            <i class="fas fa-diagram-project"></i><span>Collab &amp; Reporting</span>
          </a>
          <a href="<?= generateLink('search') ?>" class="<?= currentPage==='Search'?'active':'' ?>"
            data-page-key="search" data-page-title="Search"
            data-bs-toggle="tooltip" data-bs-placement="right" title="Web Search">
            <i class="fas fa-search"></i><span>Search</span>
          </a>
          <a href="<?= generateLink('bookmarks') ?>" class="<?= currentPage==='Bookmarks'?'active':'' ?>"
            data-page-key="bookmarks" data-page-title="Bookmarks"
            data-bs-toggle="tooltip" data-bs-placement="right" title="Bookmarks">
            <i class="fas fa-bookmark"></i><span>Bookmarks</span>
          </a>
        </div>
      </div>

      <? if (isAdminUser) { ?>
      <div class="sidebar-category">
        <div class="category-header">
          <i class="fas fa-shield-alt"></i>
          <span>Administration</span>
        </div>
        <div class="sidebar-group">
          <a href="<?= generateLink('manageuser') ?>" class="<?= currentPage==='Users'?'active':'' ?>"
            data-page-key="manageuser" data-page-title="Users"
            data-bs-toggle="tooltip" data-bs-placement="right" title="User Management">
            <i class="fas fa-users"></i><span>Users</span>
          </a>
          <a href="<?= generateLink('manageroles') ?>" class="<?= currentPage==='Settings'?'active':'' ?>"
            data-page-key="manageroles" data-page-title="Settings"
            data-bs-toggle="tooltip" data-bs-placement="right" title="Role Management">
            <i class="fas fa-user-shield"></i><span>Roles</span>
          </a>
          <a href="<?= generateLink('managecampaign') ?>" class="<?= currentPage==='Campaigns'?'active':'' ?>"
            data-page-key="managecampaign" data-page-title="Campaigns"
            data-bs-toggle="tooltip" data-bs-placement="right" title="Campaign Management">
            <i class="fas fa-bullhorn"></i><span>Campaigns</span>
          </a>
        </div>
      </div>
      <? } ?>
    </div>
  </div>

  <div class="user-panel" id="userPanel" data-initialized="true"
    data-name="<?= displayPrimaryNameValue ?>"
    data-first-name="<?= firstNameValue ?>"
    data-last-name="<?= lastNameValue ?>"
    data-full-name="<?= displayFullNameValue ?>"
    data-roles="<?= (userRoleNames && userRoleNames.length) ? userRoleNames.join(', ') : (isAdminUser ? 'System Administrator' : 'User') ?>"
    data-status="<?= sidebarUser.EmploymentStatus || '' ?>" data-country="<?= sidebarUser.Country || '' ?>">
    <div class="user-avatar-side" id="userAvatar">
      <?= userInitialValue ?>
    </div>
    <div class="user-info">
      <div class="names" id="sidebarUserName">
        <? if (primaryRoleNameValue) { ?>
        <div class="name-line role-name" id="userRoleNameDisplay"><?= primaryRoleNameValue ?></div>
        <? } ?>
        <div class="name-line full-name" id="userFullName"><?= displayFullNameValue ?></div>
      </div>
      <div class="role" id="userRole" title="<?= (userRoleNames && userRoleNames.length) ? userRoleNames.join(', ') : (isAdminUser ? 'System Administrator' : 'User') ?>">
        <div class="role-badges" id="userRoleBadges">
          <? if (userRoleBadgesHtml) { ?>
          <?!= userRoleBadgesHtml ?>
          <? } else if (isAdminUser) { ?>
          <span class="badge bg-secondary role-badge">System Administrator</span>
          <? } else { ?>
          <span class="badge bg-secondary role-badge">User</span>
          <? } ?>
        </div>
      </div>
      <div class="employment-status" id="userEmp">
        <? if (employmentMetaValue.status) { ?>
        <i class="<?= employmentMetaValue.icon ?> <?= employmentMetaValue.cls ?>"></i>
        <span class="<?= employmentMetaValue.cls ?>"><?= employmentMetaValue.status ?></span>
        <? if (sidebarUser.Country) { ?><span>• <?= sidebarUser.Country ?></span><? } ?>
        <? } else if (sidebarUser.Country) { ?>
        <i class="fas fa-globe"></i><span><?= sidebarUser.Country ?></span>
        <? } ?>
      </div>
    </div>
  </div>
</nav>

<script>
  (function () {
    var sidebar = document.getElementById('sidebar');
    if (!sidebar) {
      return;
    }

    var normalize = function (value) {
      if (value === null || typeof value === 'undefined') {
        return '';
      }

      return String(value).trim().toLowerCase();
    };

    var getPageFromQuery = function () {
      try {
        var pageParam = new URL(window.location.href).searchParams.get('page');
        if (pageParam) {
          return pageParam;
        }
      } catch (err) {
        var match = String(window.location.search || '').match(/[?&]page=([^&#]+)/i);
        if (match && match[1]) {
          try {
            return decodeURIComponent(match[1].replace(/\+/g, ' '));
          } catch (decodeErr) {
            return match[1];
          }
        }
      }

      return '';
    };

    var activeKey = normalize(getPageFromQuery());
    if (!activeKey) {
      activeKey = normalize(sidebar.getAttribute('data-current-page'));
    }

    var links = Array.prototype.slice.call(sidebar.querySelectorAll('a[data-page-key]'));
    if (!links.length) {
      return;
    }

    var defaultActive = null;
    var matchedLink = null;

    links.forEach(function (link) {
      if (!defaultActive && link.classList.contains('active')) {
        defaultActive = link;
      }

      if (matchedLink) {
        return;
      }

      if (!activeKey) {
        return;
      }

      var linkKey = normalize(link.getAttribute('data-page-key'));
      var linkTitle = normalize(link.getAttribute('data-page-title') || link.textContent);
      var hrefKey = '';

      try {
        var absolute = new URL(link.getAttribute('href'), window.location.origin);
        hrefKey = normalize(absolute.searchParams.get('page'));
      } catch (hrefErr) {
        var hrefRaw = link.getAttribute('href') || '';
        var hrefMatch = hrefRaw.match(/[?&]page=([^&#]+)/i);
        if (hrefMatch && hrefMatch[1]) {
          try {
            hrefKey = normalize(decodeURIComponent(hrefMatch[1].replace(/\+/g, ' ')));
          } catch (decodeHrefErr) {
            hrefKey = normalize(hrefMatch[1]);
          }
        }
      }

      if (linkKey === activeKey || (linkTitle && linkTitle === activeKey) || (hrefKey && hrefKey === activeKey)) {
        matchedLink = link;
      }
    });

    var finalActive = matchedLink || defaultActive;
    if (matchedLink || (activeKey && finalActive)) {
      links.forEach(function (link) {
        if (link === finalActive) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    }

    if (!finalActive) {
      return;
    }

    links.forEach(function (link) {
      link.addEventListener('click', function () {
        links.forEach(function (item) {
          item.classList.remove('active');
        });
        link.classList.add('active');
      });
    });
  })();
</script>
