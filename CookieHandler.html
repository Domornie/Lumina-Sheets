    <?!= includeOnce('ResponsiveStyles') ?>
<script>
  (function (global) {
    const COOKIE_NAME = 'authToken';
    const IDENTITY_COOKIE_NAME = 'luminaIdentity';
    const MIN_MAX_AGE_SECONDS = 300;
    const DEFAULT_SESSION_SECONDS = 60 * 60; // 1 hour fallback
    const DEFAULT_REMEMBER_SECONDS = 24 * 60 * 60; // 24 hours fallback
    const IDENTITY_MAX_BYTES = 3800;
    const IDENTITY_ROLE_LIMIT = 6;
    const IDENTITY_CATEGORY_LIMIT = 8;
    const IDENTITY_PAGES_PER_CATEGORY_LIMIT = 8;
    const IDENTITY_UNCATEGORIZED_LIMIT = 10;

    function safeParseDate(input) {
      if (!input) return null;
      const value = (typeof input === 'string' || input instanceof String) ? input : String(input);
      const timestamp = Date.parse(value);
      return Number.isNaN(timestamp) ? null : timestamp;
    }

    function resolveMaxAgeSeconds(options = {}) {
      const { ttlSeconds, maxAgeSeconds, expiresAt, rememberMe } = options;
      let resolved = null;

      if (typeof ttlSeconds === 'number' && Number.isFinite(ttlSeconds) && ttlSeconds > 0) {
        resolved = Math.floor(ttlSeconds);
      } else if (typeof maxAgeSeconds === 'number' && Number.isFinite(maxAgeSeconds) && maxAgeSeconds > 0) {
        resolved = Math.floor(maxAgeSeconds);
      } else {
        const expiresAtTimestamp = safeParseDate(expiresAt);
        if (expiresAtTimestamp && expiresAtTimestamp > Date.now()) {
          resolved = Math.floor((expiresAtTimestamp - Date.now()) / 1000);
        }
      }

      if (resolved === null) {
        resolved = rememberMe ? DEFAULT_REMEMBER_SECONDS : DEFAULT_SESSION_SECONDS;
      }

      return Math.max(MIN_MAX_AGE_SECONDS, resolved);
    }

    function readCookieValue(name) {
      try {
        const cookies = typeof document !== 'undefined' && document.cookie ? document.cookie.split(';') : [];
        for (let i = 0; i < cookies.length; i += 1) {
          const part = cookies[i] ? cookies[i].trim() : '';
          if (!part) continue;
          if (part.startsWith(`${name}=`)) {
            return decodeURIComponent(part.substring(name.length + 1));
          }
        }
      } catch (err) {
        console.warn('CookieHandler: unable to read cookie', name, err);
      }
      return '';
    }

    function writeCookie(name, value, options = {}) {
      if (typeof document === 'undefined') return '';

      const maxAgeSeconds = resolveMaxAgeSeconds(options);
      const expiresDate = new Date(Date.now() + maxAgeSeconds * 1000);
      const attributes = {
        path: '/',
        sameSite: 'Lax',
        secure: false,
        ...options.attributes
      };

      const parts = [
        `${name}=${encodeURIComponent(value)}`,
        `path=${attributes.path || '/'}`,
        `max-age=${maxAgeSeconds}`,
        `expires=${expiresDate.toUTCString()}`,
        `SameSite=${attributes.sameSite || 'Lax'}`
      ];

      if (attributes.domain) {
        parts.push(`domain=${attributes.domain}`);
      }
      if (attributes.secure) {
        parts.push('Secure');
      }

      try {
        document.cookie = parts.join('; ');
      } catch (err) {
        console.warn('CookieHandler: unable to write cookie', name, err);
      }

      return value;
    }

    function clearCookie(name, options = {}) {
      if (typeof document === 'undefined') return;

      const attributes = {
        path: '/',
        sameSite: 'Lax',
        secure: false,
        ...options.attributes
      };

      const parts = [
        `${name}=`,
        `path=${attributes.path || '/'}`,
        'max-age=0',
        'expires=Thu, 01 Jan 1970 00:00:00 GMT',
        `SameSite=${attributes.sameSite || 'Lax'}`
      ];

      if (attributes.domain) {
        parts.push(`domain=${attributes.domain}`);
      }
      if (attributes.secure) {
        parts.push('Secure');
      }

      try {
        document.cookie = parts.join('; ');
      } catch (err) {
        console.warn('CookieHandler: unable to clear cookie', name, err);
      }
    }

    function readAuthToken() {
      return readCookieValue(COOKIE_NAME);
    }

    function persistAuthToken(token, options = {}) {
      if (!token) {
        clearCookie(COOKIE_NAME, options);
        return '';
      }
      return writeCookie(COOKIE_NAME, token, options);
    }

    function clearAuthToken(options = {}) {
      clearCookie(COOKIE_NAME, options);
    }

    function safeCookieText(value) {
      if (value === null || typeof value === 'undefined') {
        return '';
      }

      const text = String(value).trim();
      if (!text || text.toLowerCase() === 'undefined' || text.toLowerCase() === 'null') {
        return '';
      }

      return text;
    }

    function normalizeBoolean(value) {
      if (value === true || value === false) {
        return value;
      }

      if (typeof value === 'string') {
        const text = value.trim().toLowerCase();
        if (!text) return false;
        if (text === 'true' || text === '1' || text === 'yes') return true;
        if (text === 'false' || text === '0' || text === 'no') return false;
      }

      if (typeof value === 'number') {
        if (Number.isNaN(value)) return false;
        return value !== 0;
      }

      return false;
    }

    function sanitizeRoleListForCookie(source) {
      const roles = [];

      const pushRole = role => {
        const text = safeCookieText(role);
        if (!text) {
          return;
        }

        const lower = text.toLowerCase();
        if (roles.some(existing => existing.toLowerCase() === lower)) {
          return;
        }

        roles.push(text);
      };

      if (Array.isArray(source)) {
        source.forEach(pushRole);
      } else if (typeof source === 'string') {
        source.split(/[,;|]/).forEach(pushRole);
      } else if (source && typeof source === 'object') {
        Object.keys(source).forEach(key => {
          if (typeof source[key] === 'string') {
            pushRole(source[key]);
          }
        });
      }

      return roles.slice(0, IDENTITY_ROLE_LIMIT);
    }

    function sanitizeNavigationPagesForCookie(pages, limit) {
      if (!Array.isArray(pages) || !pages.length) {
        return [];
      }

      const sanitized = [];
      for (let i = 0; i < pages.length && sanitized.length < limit; i += 1) {
        const page = pages[i] || {};
        const key = safeCookieText(page.PageKey || page.pageKey);
        const title = safeCookieText(page.PageTitle || page.pageTitle);
        if (!key || !title) {
          continue;
        }

        const entry = {
          key,
          title
        };

        const icon = safeCookieText(page.PageIcon || page.pageIcon);
        if (icon) {
          entry.icon = icon;
        }

        const description = safeCookieText(page.PageDescription || page.pageDescription);
        if (description) {
          entry.description = description;
        }

        sanitized.push(entry);
      }

      return sanitized;
    }

    function sanitizeNavigationForCookie(nav) {
      if (!nav || typeof nav !== 'object') {
        return null;
      }

      const sanitized = { categories: [], uncategorized: [] };

      if (Array.isArray(nav.categories)) {
        for (let i = 0; i < nav.categories.length && sanitized.categories.length < IDENTITY_CATEGORY_LIMIT; i += 1) {
          const category = nav.categories[i] || {};
          const pages = sanitizeNavigationPagesForCookie(category.pages || category.Pages, IDENTITY_PAGES_PER_CATEGORY_LIMIT);
          if (!pages.length) {
            continue;
          }

          const catEntry = {
            name: safeCookieText(category.CategoryName || category.categoryName || 'Category'),
            pages
          };

          const icon = safeCookieText(category.CategoryIcon || category.categoryIcon);
          if (icon) {
            catEntry.icon = icon;
          }

          sanitized.categories.push(catEntry);
        }
      }

      if (Array.isArray(nav.uncategorizedPages)) {
        sanitized.uncategorized = sanitizeNavigationPagesForCookie(
          nav.uncategorizedPages,
          IDENTITY_UNCATEGORIZED_LIMIT
        );
      }

      if (!sanitized.categories.length && !sanitized.uncategorized.length) {
        return null;
      }

      return sanitized;
    }

    function sanitizeIdentityCookiePayload(identity) {
      if (!identity || typeof identity !== 'object') {
        return null;
      }

      const sanitized = {
        id: safeCookieText(identity.ID || identity.Id || identity.id),
        userName: safeCookieText(identity.UserName || identity.userName || identity.username),
        fullName: safeCookieText(identity.FullName || identity.fullName),
        email: safeCookieText(identity.Email || identity.email),
        roles: sanitizeRoleListForCookie(identity.roleNames || identity.Roles || identity.roles),
        isAdmin: normalizeBoolean(identity.IsAdmin || identity.isAdminBool),
        campaign: {
          id: safeCookieText(identity.CampaignID || identity.CampaignId || identity.campaignId),
          name: safeCookieText(identity.CampaignName || identity.campaignName)
        },
        persistedAt: new Date().toISOString()
      };

      const employmentStatus = safeCookieText(identity.EmploymentStatus || identity.employmentStatus);
      if (employmentStatus) {
        sanitized.employmentStatus = employmentStatus;
      }

      const country = safeCookieText(identity.Country || identity.country);
      if (country) {
        sanitized.country = country;
      }

      if (!sanitized.roles.length) {
        delete sanitized.roles;
      }

      if (!sanitized.campaign.id) {
        delete sanitized.campaign.id;
      }
      if (!sanitized.campaign.name) {
        delete sanitized.campaign.name;
      }

      const scope = identity.CampaignScope || identity.campaignScope || null;
      if (scope && typeof scope === 'object') {
        const allowedIds = Array.isArray(scope.allowedCampaignIds)
          ? scope.allowedCampaignIds.map(safeCookieText).filter(Boolean)
          : [];
        if (allowedIds.length) {
          sanitized.campaign.allowedCampaignIds = allowedIds.slice(0, 12);
        }

        const activeId = safeCookieText(scope.activeCampaignId);
        if (activeId) {
          sanitized.campaign.activeCampaignId = activeId;
        }

        const defaultId = safeCookieText(scope.defaultCampaignId);
        if (defaultId) {
          sanitized.campaign.defaultCampaignId = defaultId;
        }

        if (scope.needsCampaignAssignment) {
          sanitized.campaign.needsAssignment = true;
        }
      }

      if (Object.keys(sanitized.campaign).length === 0) {
        delete sanitized.campaign;
      }

      const navSource = identity.campaignNavigation || identity.navigation || identity.campaignNav;
      const navigation = sanitizeNavigationForCookie(navSource);
      if (navigation) {
        sanitized.navigation = navigation;
      }

      if (!sanitized.id && !sanitized.userName && !sanitized.email) {
        return null;
      }

      return sanitized;
    }

    function serializeIdentityForCookie(payload) {
      if (!payload || typeof payload !== 'object') {
        return '';
      }

      try {
        let serialized = JSON.stringify(payload);
        if (serialized.length <= IDENTITY_MAX_BYTES) {
          return serialized;
        }

        if (payload.navigation) {
          if (Array.isArray(payload.navigation.categories) && payload.navigation.categories.length) {
            payload.navigation.categories = payload.navigation.categories
              .slice(0, Math.min(3, payload.navigation.categories.length))
              .map(category => {
                const clone = Object.assign({}, category);
                if (Array.isArray(clone.pages)) {
                  clone.pages = clone.pages.slice(0, 4);
                }
                return clone;
              });
          }
          if (Array.isArray(payload.navigation.uncategorized) && payload.navigation.uncategorized.length) {
            payload.navigation.uncategorized = payload.navigation.uncategorized.slice(0, 4);
          }

          serialized = JSON.stringify(payload);
          if (serialized.length <= IDENTITY_MAX_BYTES) {
            return serialized;
          }

          delete payload.navigation;
          serialized = JSON.stringify(payload);
          if (serialized.length <= IDENTITY_MAX_BYTES) {
            return serialized;
          }
        }

        if (Array.isArray(payload.roles) && payload.roles.length) {
          payload.roles = payload.roles.slice(0, 3);
          serialized = JSON.stringify(payload);
          if (serialized.length <= IDENTITY_MAX_BYTES) {
            return serialized;
          }

          delete payload.roles;
          serialized = JSON.stringify(payload);
          if (serialized.length <= IDENTITY_MAX_BYTES) {
            return serialized;
          }
        }

        if (payload.campaign && Array.isArray(payload.campaign.allowedCampaignIds)) {
          payload.campaign.allowedCampaignIds = payload.campaign.allowedCampaignIds.slice(0, 3);
          serialized = JSON.stringify(payload);
          if (serialized.length <= IDENTITY_MAX_BYTES) {
            return serialized;
          }

          delete payload.campaign.allowedCampaignIds;
          serialized = JSON.stringify(payload);
          if (serialized.length <= IDENTITY_MAX_BYTES) {
            return serialized;
          }
        }

        if (serialized.length <= IDENTITY_MAX_BYTES) {
          return serialized;
        }
      } catch (err) {
        console.warn('CookieHandler: unable to serialize identity payload', err);
        return '';
      }

      console.warn('CookieHandler: identity payload too large for cookie, skipping');
      return '';
    }

    function persistIdentityCookie(identity, options = {}) {
      if (!identity) {
        clearCookie(IDENTITY_COOKIE_NAME, options);
        return null;
      }

      const sanitized = sanitizeIdentityCookiePayload(identity);
      if (!sanitized) {
        clearCookie(IDENTITY_COOKIE_NAME, options);
        return null;
      }

      const serialized = serializeIdentityForCookie(sanitized);
      if (!serialized) {
        clearCookie(IDENTITY_COOKIE_NAME, options);
        return sanitized;
      }

      writeCookie(IDENTITY_COOKIE_NAME, serialized, options);
      return sanitized;
    }

    function readIdentityCookie() {
      const raw = readCookieValue(IDENTITY_COOKIE_NAME);
      if (!raw) {
        return null;
      }

      try {
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : null;
      } catch (err) {
        console.warn('CookieHandler: unable to parse identity cookie', err);
        return null;
      }
    }

    function clearIdentityCookie(options = {}) {
      clearCookie(IDENTITY_COOKIE_NAME, options);
    }

    const api = {
      AUTH_COOKIE_NAME: COOKIE_NAME,
      IDENTITY_COOKIE_NAME,
      readCookieValue,
      writeCookie,
      clearCookie,
      readAuthToken,
      persistAuthToken,
      clearAuthToken,
      resolveMaxAgeSeconds,
      sanitizeIdentityCookiePayload,
      persistIdentityCookie,
      readIdentityCookie,
      clearIdentityCookie
    };

    global.CookieHandler = api;
    global.readAuthCookie = readAuthToken;
    global.persistAuthCookie = persistAuthToken;
    global.clearAuthCookie = clearAuthToken;
    global.persistIdentityCookie = persistIdentityCookie;
    global.readIdentityCookie = readIdentityCookie;
    global.clearIdentityCookie = clearIdentityCookie;
  })(typeof window !== 'undefined' ? window : this);
</script>
